{"repo":"apostrophecms/apostrophe","url":"https://github.com/apostrophecms/apostrophe","branch":"main","configs":[{"package":"apostrophe","lang":"js","dir":"test","framework":"mocha","pattern":"**/*.{js,ts}"}],"tests":[{"name":"should allow a group reversing the current order","suites":["Admin bar"],"updatePoint":{"line":10,"column":54,"index":231},"line":10,"code":"  it('should allow a group reversing the current order', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          '@apostrophecms/admin-bar': {\n            options: {\n              addGroups: [{\n                label: 'Media',\n                items: ['@apostrophecms/image', '@apostrophecms/image-tag', '@apostrophecms/file', '@apostrophecms/file-tag']\n              }, {\n                label: 'Content',\n                items: ['@apostrophecms/file', '@apostrophecms/image']\n              }]\n            }\n          }\n        }\n      });\n      assert(apos.modules['@apostrophecms/admin-bar']);\n      assert(apos.adminBar);\n      assert.strictEqual(apos.adminBar.items.length, 6);\n      assert(apos.adminBar.items[2].name === '@apostrophecms/file');\n      assert(apos.adminBar.items[3].name === '@apostrophecms/image');\n    } finally {\n      t.destroy(apos);\n    }\n  });","file":"admin-bar.js","skipped":false,"dir":"test"},{"name":"should allow a group obeying the current order","suites":["Admin bar"],"updatePoint":{"line":38,"column":52,"index":1169},"line":38,"code":"  it('should allow a group obeying the current order', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        modules: {\n          '@apostrophecms/admin-bar': {\n            options: {\n              addGroups: [{\n                label: 'Media',\n                items: ['@apostrophecms/image', '@apostrophecms/file']\n              }, {\n                label: 'Content',\n                items: ['@apostrophecms/file', '@apostrophecms/image']\n              }]\n            }\n          }\n        }\n      });\n      assert(apos.modules['@apostrophecms/admin-bar']);\n      assert(apos.adminBar);\n      assert(apos.adminBar.items.length === 6);\n      assert(apos.adminBar.items[1].name === '@apostrophecms/file');\n      assert(apos.adminBar.items[2].name === '@apostrophecms/image');\n    } finally {\n      t.destroy(apos);\n    }\n  });","file":"admin-bar.js","skipped":false,"dir":"test"},{"name":"should should not have a \"global\" admin menu item by default","suites":["Admin bar"],"updatePoint":{"line":65,"column":66,"index":2035},"line":65,"code":"  it('should should not have a \"global\" admin menu item by default', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module\n      });\n      assert(apos.modules['@apostrophecms/admin-bar']);\n      assert(apos.adminBar);\n      assert(apos.adminBar.items.findIndex(i => i.name === '@apostrophecms/global') === -1);\n    } finally {\n      t.destroy(apos);\n    }\n  });","file":"admin-bar.js","skipped":false,"dir":"test"},{"name":"should *should* have a \"global\" admin menu item with custom schema","suites":["Admin bar"],"updatePoint":{"line":78,"column":72,"index":2444},"line":78,"code":"  it('should *should* have a \"global\" admin menu item with custom schema', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          '@apostrophecms/global': {\n            fields: {\n              add: {\n                someField: {\n                  type: 'string'\n                }\n              }\n            }\n          }\n        }\n      });\n      assert(apos.modules['@apostrophecms/admin-bar']);\n      assert(apos.adminBar);\n      assert(apos.adminBar.items.findIndex(i => i.name === '@apostrophecms/global') > -1);\n    } finally {\n      t.destroy(apos);\n    }\n  });","file":"admin-bar.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Areas"],"updatePoint":{"line":14,"column":23,"index":268},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        article: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'articles',\n            name: 'article',\n            label: 'Article'\n          },\n          fields: {\n            add: {\n              main: {\n                type: 'area',\n                label: 'Main area',\n                options: {\n                  widgets: {\n                    '@apostrophecms/rich-text': {\n                      toolbar: ['bold'],\n                      styles: [{\n                        tag: 'p',\n                        label: 'Paragraph'\n                      }]\n                    },\n                    '@apostrophecms/html': {}\n                  }\n                }\n              },\n              moreAreas: {\n                type: 'array',\n                label: 'Some more areas',\n                fields: {\n                  add: {\n                    someWidgets: {\n                      type: 'area',\n                      label: 'Some widgets in the area',\n                      options: {\n                        widgets: {\n                          '@apostrophecms/html': {}\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n    assert(apos.modules['@apostrophecms/area']);\n    assert(apos.area);\n    // In tests this will be the name of the test file,\n    // so override that in order to get apostrophe to\n    // listen normally and not try to run a task. -Tom\n    apos.argv._ = [];\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"can get widgets from groups","suites":["Areas"],"updatePoint":{"line":72,"column":33,"index":1953},"line":72,"code":"  it('can get widgets from groups', function () {\n    const options = {\n      groups: {\n        content: {\n          widgets: {\n            article: {},\n            'selected-article': {},\n            topic: {},\n            hero: {},\n            '@apostrophecms/rich-text': {},\n            '@apostrophecms/form': {}\n          }\n        },\n        media: {\n          widgets: {\n            '@apostrophecms/image': {},\n            '@apostrophecms/video': {}\n          }\n        },\n        layout: {\n          widgets: {\n            'two-column': {}\n          }\n        }\n      }\n    };\n    const expected = {\n      ...options.groups.content.widgets,\n      ...options.groups.media.widgets,\n      ...options.groups.layout.widgets\n    };\n    const widgets = apos.area.getWidgets(options);\n    assert.strict(expected, widgets);\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"returns the rich text of an area via the richText method","suites":["Areas"],"updatePoint":{"line":106,"column":62,"index":2810},"line":106,"code":"  it('returns the rich text of an area via the richText method', function () {\n    assert(apos.area.richText({\n      metaType: 'area',\n      items: [{\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>So cool</h2>'\n      }, {\n        metaType: 'widget',\n        type: 'something-else',\n        content: '<h3>Do not return me</h3>'\n      }, {\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>Something else cool</h2>'\n      }]\n    }) === '<h2>So cool</h2>\\n<h2>Something else cool</h2>');\n    assert(apos.area.richText({\n      metaType: 'area',\n      items: [{\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>So cool</h2>'\n      }, {\n        metaType: 'widget',\n        type: 'something-else',\n        content: '<h3>Do not return me</h3>'\n      }, {\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>Something else cool</h2>'\n      }]\n    }, {\n      delimiter: ''\n    }) === '<h2>So cool</h2><h2>Something else cool</h2>');\n    assert(apos.area.richText({\n      metaType: 'area',\n      items: [{\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>So cool</h2>'\n      }, {\n        metaType: 'widget',\n        type: 'something-else',\n        content: '<h3>Do not return me</h3>'\n      }, {\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>Something else cool</h2>'\n      }]\n    }, {\n      wrapper: 'div'\n    }) === '<div><h2>So cool</h2></div><div><h2>Something else cool</h2></div>');\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"returns the plaintext of an area via the plaintext method","suites":["Areas"],"updatePoint":{"line":160,"column":63,"index":4455},"line":160,"code":"  it('returns the plaintext of an area via the plaintext method', function () {\n    assert.strictEqual(apos.area.plaintext({\n      metaType: 'area',\n      items: [{\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>So cool</h2>'\n      }, {\n        metaType: 'widget',\n        type: 'something-else',\n        content: '<h3>Do not return me</h3>'\n      }, {\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>Something else cool</h2>'\n      }]\n    }), 'So cool\\nSomething else cool');\n    assert.strictEqual(apos.area.plaintext({\n      metaType: 'area',\n      items: [{\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>So cool</h2>'\n      }, {\n        metaType: 'widget',\n        type: 'something-else',\n        content: '<h3>Do not return me</h3>'\n      }, {\n        metaType: 'widget',\n        type: '@apostrophecms/rich-text',\n        content: '<h2>Something else cool</h2>'\n      }]\n    }, {\n      limit: 15\n    }), 'So cool...');\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"can populate an area object with required properties using the prepForRender method","suites":["Areas"],"updatePoint":{"line":196,"column":89,"index":5546},"line":196,"code":"  it('can populate an area object with required properties using the prepForRender method', async function () {\n    apos.area.prepForRender(rteArea, areaDocs[0], 'main');\n    assert(rteArea._fieldId);\n    assert(rteArea._docId);\n    assert(rteArea._edit !== undefined);\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"renders an area passed to the `renderArea` method","suites":["Areas"],"updatePoint":{"line":204,"column":55,"index":5831},"line":204,"code":"  it('renders an area passed to the `renderArea` method', async function () {\n    const req = apos.task.getReq();\n    firstRendered = await apos.area.renderArea(req, rteArea, areaDocs[0]);\n    assert(firstRendered);\n    assert.equal(firstRendered, `\n<div class=\"apos-area\">\n<div data-rich-text>\n  <p>Perhaps its fate that today is the 4th of July, and you will once again be fighting for our freedom, not from tyranny, oppression, or persecution -- but from annihilation.</p><p>We're fighting for our right to live, to exist.</p>\n</div>\n</div>\n`);\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"returns rendered HTML from the `renderArea` method for a mixed widget area","suites":["Areas"],"updatePoint":{"line":216,"column":80,"index":6410},"line":216,"code":"  it('returns rendered HTML from the `renderArea` method for a mixed widget area', async function () {\n    const req = apos.task.getReq();\n    apos.area.prepForRender(mixedArea, areaDocs[1], 'main');\n    secondRendered = await apos.area.renderArea(req, mixedArea, areaDocs[1]);\n    assert(secondRendered.includes(`<div data-rich-text>\n  <p>Good morning.`));\n    assert(secondRendered.includes('<marquee>The HTML <code>&lt;marquee&gt;</code> element'));\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"populates a document object with rendered HTML areas using the renderDocsAreas method.","suites":["Areas"],"updatePoint":{"line":224,"column":92,"index":6881},"line":224,"code":"  it('populates a document object with rendered HTML areas using the renderDocsAreas method.', async function () {\n    const req = apos.task.getReq();\n    areaDocs.forEach(doc => {\n      // No rendered HTML yet.\n      assert(!doc.main._rendered);\n    });\n    await apos.area.renderDocsAreas(req, areaDocs);\n    areaDocs.forEach(doc => {\n      // Now they're there.\n      assert(doc.main._rendered);\n      assert(!doc.main.items);\n\n      // TODO the approach in this test can't cover array or object area rendering\n      // properly without a further overhaul (not a new problem).\n      // if (doc.moreAreas) {\n      //   doc.moreAreas.forEach(area => {\n      //     assert(area.someWidgets._rendered);\n      //     assert(!area.someWidgets.items);\n      //   });\n      // }\n    });\n\n    assert.equal(areaDocs[0].main._rendered, firstRendered);\n    assert.equal(areaDocs[1].main._rendered, secondRendered);\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"area considered empty when it should be","suites":["Areas"],"updatePoint":{"line":249,"column":45,"index":7746},"line":249,"code":"  it('area considered empty when it should be', function () {\n    const doc = {\n      type: 'test',\n      _id: 'test',\n      body: {\n        metaType: 'area',\n        items: []\n      },\n      emptyText: {\n        metaType: 'area',\n        items: [{\n          metaType: 'widget',\n          _id: 'test2',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }]\n      },\n      insignificantText: {\n        metaType: 'area',\n        items: [{\n          metaType: 'widget',\n          _id: 'test2',\n          type: '@apostrophecms/rich-text',\n          content: '<h4> </h4>'\n        }]\n      }\n    };\n    assert(apos.area.isEmpty({\n      area: doc.body\n    }));\n    assert(apos.area.isEmpty(doc, 'body'));\n    assert(apos.area.isEmpty(doc, 'nonexistent'));\n    assert(apos.area.isEmpty(doc, 'emptyText'));\n    assert(apos.area.isEmpty(doc, 'insignificantText'));\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"area not considered empty when it should not be","suites":["Areas"],"updatePoint":{"line":284,"column":53,"index":8638},"line":284,"code":"  it('area not considered empty when it should not be', function () {\n    const doc = {\n      type: 'test',\n      _id: 'test',\n      body: {\n        metaType: 'area',\n        items: [{\n          metaType: 'widget',\n          _id: 'test2',\n          type: '@apostrophecms/video',\n          url: 'http://somewhere.com'\n        }]\n      },\n      emptyText: {\n        metaType: 'area',\n        items: [{\n          metaType: 'widget',\n          _id: 'test2',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }]\n      },\n      fullText: {\n        metaType: 'area',\n        items: [{\n          metaType: 'widget',\n          _id: 'test2',\n          type: '@apostrophecms/rich-text',\n          content: '<h4>Some text</h4>'\n        }]\n      }\n    };\n    assert(!apos.area.isEmpty({\n      area: doc.body\n    }));\n    assert(!apos.area.isEmpty(doc, 'body'));\n    assert(!apos.area.isEmpty(doc, 'fullText'));\n    assert(!apos.area.isEmpty({\n      area: doc.fullText\n    }));\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"both isEmpty and legacy empty methods work on schema fields","suites":["Areas"],"updatePoint":{"line":325,"column":65,"index":9644},"line":325,"code":"  it('both isEmpty and legacy empty methods work on schema fields', function () {\n    assert(!apos.schema.fieldTypes.boolean.isEmpty({\n      type: 'boolean',\n      name: 'test'\n    }, true));\n    assert(!apos.schema.fieldTypes.boolean.isEmpty({\n      type: 'boolean',\n      name: 'test'\n    }, false));\n    assert(apos.schema.fieldTypes.boolean.isEmpty({\n      type: 'boolean',\n      name: 'test'\n    }, null));\n    assert(apos.schema.fieldTypes.boolean.isEmpty({\n      type: 'boolean',\n      name: 'test'\n    }, undefined));\n    assert(apos.schema.fieldTypes.boolean.isEmpty({\n      type: 'boolean',\n      name: 'test'\n    }, 0));\n    assert(!apos.schema.fieldTypes.boolean.empty({\n      type: 'boolean',\n      name: 'test'\n    }, true));\n    assert(!apos.schema.fieldTypes.boolean.empty({\n      type: 'boolean',\n      name: 'test'\n    }, false));\n    assert(apos.schema.fieldTypes.boolean.empty({\n      type: 'boolean',\n      name: 'test'\n    }, null));\n    assert(apos.schema.fieldTypes.boolean.empty({\n      type: 'boolean',\n      name: 'test'\n    }, undefined));\n    assert(apos.schema.fieldTypes.boolean.empty({\n      type: 'boolean',\n      name: 'test'\n    }, 0));\n  });","file":"areas.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Assets"],"updatePoint":{"line":97,"column":37,"index":2109},"line":97,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules\n    });\n    assert(apos.asset);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should serve static files","suites":["Assets"],"updatePoint":{"line":104,"column":31,"index":2263},"line":104,"code":"  it('should serve static files', async function () {\n    const text = await apos.http.get('/static-test.txt');\n    assert(text.match(/served/));\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should check that webpack configs in modules are well formatted","suites":["Assets"],"updatePoint":{"line":108,"column":69,"index":2453},"line":108,"code":"  it('should check that webpack configs in modules are well formatted', async function () {\n    const translate = apos.task.getReq().t;\n    assert.doesNotThrow(() => checkModulesWebpackConfig(apos.modules, translate));\n    await t.destroy(apos);\n    apos = await t.create({\n      root: module,\n      modules: badModules\n    });\n    assert.throws(() => checkModulesWebpackConfig(apos.modules, translate));\n    await t.destroy(apos);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should get webpack extensions from modules and fill extra bundles","suites":["Assets"],"updatePoint":{"line":119,"column":71,"index":2893},"line":119,"code":"  it('should get webpack extensions from modules and fill extra bundles', async function () {\n    const expectedEntryPointsNames = {\n      js: ['company', 'main', 'another', 'extra', 'extra2'],\n      css: ['company', 'main', 'extra']\n    };\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@company/bundle': {},\n        ...modules\n      }\n    });\n    const {\n      extensions,\n      verifiedBundles\n    } = await getWebpackExtensions({\n      name: 'src',\n      getMetadata: apos.synth.getMetadata,\n      modulesToInstantiate: apos.modulesToBeInstantiated()\n    });\n    assert(Object.keys(extensions).length === 2);\n    assert(!extensions.ext1.resolve.alias.ext1);\n    assert(extensions.ext1.resolve.alias.ext1Overriden);\n    assert(extensions.ext2.resolve.alias.ext2);\n    assert.equal(Object.keys(verifiedBundles).length, Math.max(expectedEntryPointsNames.js.length, expectedEntryPointsNames.css.length));\n    assert(verifiedBundles.main.js.length, 2);\n    assert(verifiedBundles.main.scss.length, 1);\n\n    // The local and the npm module source\n    assert.equal(verifiedBundles.company.js.length, 2);\n    assert.equal(verifiedBundles.company.scss.length, 2);\n    assert.equal(verifiedBundles.extra.js.length, 1);\n    assert.equal(verifiedBundles.extra.scss.length, 1);\n    assert.equal(verifiedBundles.extra2.js.length, 1);\n    assert.equal(verifiedBundles.extra2.scss.length, 0);\n    const filled = fillExtraBundles(verifiedBundles);\n    assert.deepEqual(filled.js, expectedEntryPointsNames.js);\n    assert.deepEqual(filled.css, expectedEntryPointsNames.css);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should build the right bundles in dev and prod modes","suites":["Assets"],"updatePoint":{"line":158,"column":58,"index":4474},"line":158,"code":"  it('should build the right bundles in dev and prod modes', async function () {\n    process.env.NODE_ENV = 'production';\n    await apos.asset.tasks.build.task();\n    const getPath = p => `${publicFolderPath}/apos-frontend/` + p;\n    const [releaseId] = await fs.readdir(getPath('releases'));\n    const checkFileExists = async p => fs.pathExists(getPath(p));\n    const releasePath = `releases/${releaseId}/default/`;\n    await checkBundlesExists(releasePath, expectedBundlesNames);\n    await deleteBuiltFolders(publicFolderPath);\n    process.env.NODE_ENV = 'development';\n    await apos.asset.tasks.build.task();\n    async function checkBundlesExists(folderPath, fileNames) {\n      for (const fileName of fileNames) {\n        const extraBundleExists = await checkFileExists(folderPath + fileName);\n        assert(extraBundleExists);\n      }\n    }\n    return checkBundlesExists('default/', expectedBundlesNames);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should load the right bundles inside the right page","suites":["Assets"],"updatePoint":{"line":177,"column":57,"index":5391},"line":177,"code":"  it('should load the right bundles inside the right page', async function () {\n    const {\n      _id: homeId\n    } = await apos.page.find(apos.task.getAnonReq(), {\n      level: 0\n    }).toObject();\n    const jar = apos.http.jar();\n    await apos.doc.db.insertMany(pagesToInsert(homeId));\n    const bundlePage = await apos.http.get('/bundle', {\n      jar\n    });\n    assert(bundlePage.includes(getStylesheetMarkup('public-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('main-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('extra-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('public-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('main-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('extra-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('extra2-module-bundle')));\n    const childPage = await apos.http.get('/bundle/child', {\n      jar\n    });\n    assert(childPage.includes(getStylesheetMarkup('public-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('main-bundle')));\n    assert(childPage.includes(getStylesheetMarkup('extra-bundle')));\n    assert(childPage.includes(getScriptMarkup('public-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('main-module-bundle')));\n    assert(childPage.includes(getScriptMarkup('extra-module-bundle')));\n    assert(!childPage.includes(getScriptMarkup('extra2-module-bundle')));\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should load all the bundles on all pages when the user is logged in","suites":["Assets"],"updatePoint":{"line":206,"column":73,"index":6859},"line":206,"code":"  it('should load all the bundles on all pages when the user is logged in', async function () {\n    const user = {\n      ...apos.user.newInstance(),\n      title: 'toto',\n      username: 'toto',\n      password: 'tata',\n      email: 'toto@mail.com',\n      role: 'admin'\n    };\n    const jar = apos.http.jar();\n    await apos.user.insert(apos.task.getReq(), user);\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'toto',\n        password: 'tata',\n        session: true\n      },\n      jar\n    });\n    const homePage = await apos.http.get('/', {\n      jar\n    });\n    assert(homePage.match(/logged in/));\n    const bundlePage = await apos.http.get('/bundle', {\n      jar\n    });\n    allBundlesAreIncluded(bundlePage);\n    await t.destroy(apos);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should build with cache and gain performance","suites":["Assets"],"updatePoint":{"line":236,"column":50,"index":7653},"line":236,"code":"  it('should build with cache and gain performance', async function () {\n    await removeCache();\n    await removeCache(cacheFolderPath.replace('/webpack-cache', '/changed'));\n    apos = await t.create({\n      root: module,\n      modules\n    });\n    assert.throws(() => fs.readdirSync(cacheFolderPath), {\n      code: 'ENOENT'\n    });\n    let startTime;\n\n    // Cold run\n    startTime = Date.now();\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const execTime = Date.now() - startTime;\n    const {\n      meta,\n      folders\n    } = getCacheMeta();\n    assert.equal(folders.length, 2);\n    assert.equal(Object.keys(meta).length, 2);\n    assert(meta['default:apos']);\n    assert(meta['default:src']);\n\n    // Cache\n    startTime = Date.now();\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const execTimeCached = Date.now() - startTime;\n    const {\n      meta: meta2,\n      folders: folders2\n    } = getCacheMeta();\n    assert.equal(folders2.length, 2);\n    assert.equal(Object.keys(meta2).length, 2);\n    assert(meta2['default:apos']);\n    assert(meta2['default:src']);\n\n    // Expect at least 40% gain, in reallity it should be 50+\n    const gain = (execTime - execTimeCached) / execTime * 100;\n    assert(gain >= 20, `Expected gain >=20%, got ${gain}%`);\n\n    // Modification times\n    assert(meta['default:apos'].mdate);\n    assert(meta2['default:apos'].mdate);\n    assert(meta['default:src'].mdate);\n    assert(meta2['default:src'].mdate);\n    assert(new Date(meta['default:apos'].mdate) < new Date(meta2['default:apos'].mdate));\n    assert.equal(new Date(meta2['default:apos'].mdate).toISOString(), fs.statSync(meta2['default:apos'].location).mtime.toISOString());\n    assert(new Date(meta['default:src'].mdate) < new Date(meta2['default:src'].mdate));\n    assert.equal(new Date(meta2['default:src'].mdate).toISOString(), fs.statSync(meta2['default:src'].location).mtime.toISOString());\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should invalidate build cache when namespace changes","suites":["Assets"],"updatePoint":{"line":292,"column":58,"index":9632},"line":292,"code":"  it('should invalidate build cache when namespace changes', async function () {\n    process.env.APOS_DEBUG_NAMESPACE = 'test';\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const {\n      meta,\n      folders\n    } = getCacheMeta();\n    assert.equal(folders.length, 4);\n    assert.equal(Object.keys(meta).length, 4);\n    assert(meta['test:apos']);\n    assert(meta['test:src']);\n    assert(meta['default:apos']);\n    assert(meta['default:src']);\n    delete process.env.APOS_DEBUG_NAMESPACE;\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should invalidate build cache when packages change","suites":["Assets"],"updatePoint":{"line":309,"column":56,"index":10163},"line":309,"code":"  it('should invalidate build cache when packages change', async function () {\n    await t.destroy(apos);\n    const lock = require('./package-lock.json');\n    assert.equal(lock.version, 'current');\n    lock.version = 'new';\n    fs.writeFileSync(path.join(process.cwd(), 'test/package-lock.json'), JSON.stringify(lock, null, '  '), 'utf8');\n    apos = await t.create({\n      root: module,\n      modules\n    });\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const {\n      meta,\n      folders\n    } = getCacheMeta();\n    assert.equal(folders.length, 6);\n    assert.equal(Object.keys(meta).length, 6);\n    assert(meta['default:apos_2']);\n    assert(meta['default:src_2']);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should invalidate build cache when configuration changes","suites":["Assets"],"updatePoint":{"line":331,"column":62,"index":10882},"line":331,"code":"  it('should invalidate build cache when configuration changes', async function () {\n    await t.destroy(apos);\n    const customModules = {\n      ...modules,\n      'bundle-page': {\n        webpack: {\n          extensions: {\n            ext1: {\n              resolve: {\n                alias: {\n                  ext1: 'changed'\n                }\n              }\n            }\n          }\n        }\n      }\n    };\n    apos = await t.create({\n      root: module,\n      modules: customModules\n    });\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const {\n      meta,\n      folders\n    } = getCacheMeta();\n    assert.equal(folders.length, 7);\n    assert.equal(Object.keys(meta).length, 7);\n    assert(!meta['default:apos_3']);\n    assert(meta['default:src_3']);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should clear build cache","suites":["Assets"],"updatePoint":{"line":365,"column":30,"index":11652},"line":365,"code":"  it('should clear build cache', async function () {\n    const cacheFolders = fs.readdirSync(cacheFolderPath, 'utf8');\n    assert(cacheFolders.length > 0);\n    await apos.asset.tasks['clear-cache'].task();\n    assert.equal(fs.readdirSync(cacheFolderPath, 'utf8').length, 0);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should be able to override the build cache location via APOS_ASSET_CACHE","suites":["Assets"],"updatePoint":{"line":371,"column":78,"index":11981},"line":371,"code":"  it('should be able to override the build cache location via APOS_ASSET_CACHE', async function () {\n    await t.destroy(apos);\n    await removeCache();\n    const altCacheLoc = cacheFolderPath.replace('/webpack-cache', '/changed');\n    await removeCache(altCacheLoc);\n    process.env.APOS_ASSET_CACHE = altCacheLoc;\n    apos = await t.create({\n      root: module,\n      modules\n    });\n    assert.throws(() => fs.readdirSync(altCacheLoc), {\n      code: 'ENOENT'\n    });\n    await apos.asset.tasks.build.task({\n      'check-apos-build': false\n    });\n    const {\n      meta,\n      folders\n    } = getCacheMeta(altCacheLoc);\n    assert.equal(folders.length, 2);\n    assert.equal(Object.keys(meta).length, 2);\n    assert(meta['default:apos']);\n    assert(meta['default:src']);\n    delete process.env.APOS_ASSET_CACHE;\n    await removeCache(altCacheLoc);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and rebuild assets and reload page in development (bundle src)","suites":["Assets"],"updatePoint":{"line":398,"column":81,"index":12841},"line":398,"code":"  it('should watch and rebuild assets and reload page in development (bundle src)', async function () {\n    await t.destroy(apos);\n    let result = {};\n    const cb = obj => {\n      result = obj;\n    };\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        ...modules,\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(cb);\n              }\n            };\n          }\n        }\n      }\n    });\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n\n    // Modify asset and rebuild\n    const assetPath = path.join(process.cwd(), 'test/modules/bundle-page/ui/src/extra.js');\n    const assetPathPublic = path.join(process.cwd(), 'test/public/apos-frontend/default/extra-module-bundle.js');\n    const assetContent = fs.readFileSync(assetPath, 'utf-8');\n    fs.writeFileSync(assetPath, 'export default () => { \\'bundle-page-watcher-test-src\\'; };\\n', 'utf8');\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublic, 'utf8')).match(/bundle-page-watcher-test-src/), 'Unable to verify public asset was rebuilt by the watcher', 500, 10000);\n    await retryAssertTrue(() => apos.asset.restartId !== restartId, 'Unable to verify restartId has been changed', 500, 10000);\n    await retryAssertTrue(() => result.builds.length === 1 && result.builds.includes('src'), 'Unable to verify build \"src\" has been triggered', 50, 1000);\n    await retryAssertTrue(() => result.changes.length === 1 && result.changes[0].includes('modules/bundle-page/ui/src/extra.js'), 'Unable to verify changes contain the proper file', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPath, assetContent, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and rebuild assets and reload page in development (src)","suites":["Assets"],"updatePoint":{"line":440,"column":74,"index":14784},"line":440,"code":"  it('should watch and rebuild assets and reload page in development (src)', async function () {\n    await t.destroy(apos);\n    let result = {};\n    const setTestResult = obj => {\n      result = obj;\n    };\n    const rootPath = process.cwd();\n    const assetPathJs = path.join(rootPath, 'test/modules/default-page/ui/src/index.js');\n    const assetPathScss = path.join(rootPath, 'test/modules/default-page/ui/src/index.scss');\n    const assetPathPublicJs = path.join(rootPath, 'test/public/apos-frontend/default/public-module-bundle.js');\n    const assetPathPublicCss = path.join(rootPath, 'test/public/apos-frontend/default/public-bundle.css');\n    const assetPathAposJs = path.join(rootPath, 'test/public/apos-frontend/default/apos-module-bundle.js');\n    const assetPathAposCss = path.join(rootPath, 'test/public/apos-frontend/default/apos-bundle.css');\n    const assetContentJs = fs.readFileSync(assetPathJs, 'utf-8');\n    const assetContentScss = fs.readFileSync(assetPathScss, 'utf-8');\n    // Resurrect the default assets content if test has failed\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        'default-page': {},\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(setTestResult);\n              }\n            };\n          }\n        }\n      }\n    });\n    // Assert defaults\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n\n    // * modify assets and rebuild\n    fs.writeFileSync(assetPathJs, 'export default () => { \\'default-page-watcher-test-src\\'; };\\n', 'utf8');\n    fs.writeFileSync(assetPathScss, '.default-page-watcher-test-src{color:red;}\\n', 'utf8');\n\n    // * change is in the public bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublicJs, 'utf8')).match(/default-page-watcher-test-src/), 'Unable to verify public JS asset was rebuilt by the watcher', 500, 10000);\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublicCss, 'utf8')).match(/\\.default-page-watcher-test-src/), 'Unable to verify public CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * change is in the apos bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposJs, 'utf8')).match(/default-page-watcher-test-src/), 'Unable to verify apos JS asset was rebuilt by the watcher', 500, 10000);\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposCss, 'utf8')).match(/\\.default-page-watcher-test-src/), 'Unable to verify apos CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * page has been restarted\n    await retryAssertTrue(() => apos.asset.restartId !== restartId, 'Unable to verify restartId has been changed', 500, 10000);\n\n    // * only src related builds were triggered\n    await retryAssertTrue(() => result.builds.length === 1 && result.builds.includes('src'), 'Unable to verify build \"src\" has been triggered', 50, 1000);\n\n    // * changes detected\n    await retryAssertTrue(() => result.changes.length === 2 && result.changes.filter(f => f.includes('modules/default-page/ui/src/index.js') || f.includes('modules/default-page/ui/src/index.scss')).length === 2, 'Unable to verify changes contain the proper source files', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and rebuild assets and reload page in development (public)","suites":["Assets"],"updatePoint":{"line":507,"column":77,"index":18541},"line":507,"code":"  it('should watch and rebuild assets and reload page in development (public)', async function () {\n    await t.destroy(apos);\n    let result = {};\n    const setTestResult = obj => {\n      result = obj;\n    };\n    const rootPath = process.cwd();\n    const assetPathJs = path.join(rootPath, 'test/modules/default-page/ui/public/index.js');\n    const assetPathCss = path.join(rootPath, 'test/modules/default-page/ui/public/index.css');\n    const assetPathPublicJs = path.join(rootPath, 'test/public/apos-frontend/default/public-module-bundle.js');\n    const assetPathPublicCss = path.join(rootPath, 'test/public/apos-frontend/default/public-bundle.css');\n    const assetPathAposJs = path.join(rootPath, 'test/public/apos-frontend/default/apos-module-bundle.js');\n    const assetPathAposCss = path.join(rootPath, 'test/public/apos-frontend/default/apos-bundle.css');\n    const assetContentJs = fs.readFileSync(assetPathJs, 'utf-8');\n    const assetContentScss = fs.readFileSync(assetPathCss, 'utf-8');\n    // Resurrect the default assets content if test has failed\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathCss, assetContentScss, 'utf8');\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        'default-page': {},\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(setTestResult);\n              }\n            };\n          }\n        }\n      }\n    });\n    // Assert defaults\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n\n    // * modify assets and rebuild\n    fs.writeFileSync(assetPathJs, 'export default () => { \\'default-page-watcher-test-public\\'; };\\n', 'utf8');\n    fs.writeFileSync(assetPathCss, '.default-page-watcher-test-public{color:red;}\\n', 'utf8');\n\n    // * change is in the public bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublicJs, 'utf8')).match(/default-page-watcher-test-public/), 'Unable to verify public JS asset was rebuilt by the watcher', 500, 10000);\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublicCss, 'utf8')).match(/\\.default-page-watcher-test-public/), 'Unable to verify public CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * change is in the apos bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposJs, 'utf8')).match(/default-page-watcher-test-public/), 'Unable to verify apos JS asset was rebuilt by the watcher', 500, 10000);\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposCss, 'utf8')).match(/\\.default-page-watcher-test-public/), 'Unable to verify apos CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * page has been restarted\n    await retryAssertTrue(() => apos.asset.restartId !== restartId, 'Unable to verify restartId has been changed', 500, 10000);\n\n    // * only public build was triggered\n    await retryAssertTrue(() => result.builds.length === 1 && result.builds.includes('public'), 'Unable to verify build \"public\" has been triggered', 50, 1000);\n\n    // * changes detected\n    await retryAssertTrue(() => result.changes.length === 2 && result.changes.filter(f => f.includes('modules/default-page/ui/public/index.js') || f.includes('modules/default-page/ui/public/index.css')).length === 2, 'Unable to verify changes contain the proper source files', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathCss, assetContentScss, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and rebuild assets and reload page in development (apos)","suites":["Assets"],"updatePoint":{"line":574,"column":75,"index":22318},"line":574,"code":"  it('should watch and rebuild assets and reload page in development (apos)', async function () {\n    await t.destroy(apos);\n    let result = {};\n    const setTestResult = obj => {\n      result = obj;\n    };\n    const rootPath = process.cwd();\n    const assetPathJs = path.join(rootPath, 'test/modules/default-page/ui/apos/components/FakeComponent.vue');\n    const assetPathAposJs = path.join(rootPath, 'test/public/apos-frontend/default/apos-module-bundle.js');\n    const assetContentJs = '<template><span /></template>\\n';\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        'default-page': {\n          options: {\n            components: {\n              fake: 'FakeComponent'\n            }\n          }\n        },\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(setTestResult);\n              }\n            };\n          }\n        }\n      }\n    });\n    // Assert defaults\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n\n    // * modify assets and rebuild\n    fs.writeFileSync(assetPathJs, '<template><span>default-page-watcher-test-apos</span></template>\\n', 'utf8');\n\n    // * change is in the apos bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposJs, 'utf8')).includes('default-page-watcher-test-apos'), 'Unable to verify apos JS asset was rebuilt by the watcher', 500, 20000);\n\n    // * page has been restarted\n    await retryAssertTrue(() => apos.asset.restartId !== restartId, 'Unable to verify restartId has been changed', 500, 10000);\n\n    // * only apos build was triggered\n    await retryAssertTrue(() => result.builds.length === 1 && result.builds.includes('apos'), 'Unable to verify build \"apos\" has been triggered', 50, 1000);\n\n    // * changes detected\n    await retryAssertTrue(() => result.changes.length === 1 && result.changes[0].includes('modules/default-page/ui/apos/components/FakeComponent.vue'), 'Unable to verify changes contain the proper source files', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and recover after build error in development","suites":["Assets"],"updatePoint":{"line":633,"column":63,"index":24721},"line":633,"code":"  it('should watch and recover after build error in development', async function () {\n    await t.destroy(apos);\n    let result = {};\n    let called = 0;\n    const setTestResult = obj => {\n      result = obj;\n      called++;\n    };\n    const rootPath = process.cwd();\n    const assetPathScss = path.join(rootPath, 'test/modules/default-page/ui/src/index.scss');\n    const assetPathPublicCss = path.join(rootPath, 'test/public/apos-frontend/default/public-bundle.css');\n    const assetPathAposCss = path.join(rootPath, 'test/public/apos-frontend/default/apos-bundle.css');\n    const assetContentScss = '.default-page {color:red;}\\n';\n    // Resurrect the default assets content if test has failed\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        'default-page': {},\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(setTestResult);\n              }\n            };\n          }\n        }\n      }\n    });\n    // Assert defaults\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n\n    // * modify assets and rebuild\n    fs.writeFileSync(assetPathScss, 'bad code;\\n', 'utf8');\n\n    // * wait till the build ends\n    await retryAssertTrue(() => called === 1 && result.builds.length === 0, 'Unable to verify build with error was triggered', 100, 10000);\n\n    // * page has NOT been restarted\n    await retryAssertTrue(() => apos.asset.restartId === restartId, 'Unable to verify restartId has been changed', 100, 10000);\n\n    // * modify assets and recover\n    fs.writeFileSync(assetPathScss, '.default-page-watcher-test-recover{color:red;}\\n', 'utf8');\n\n    // * change is in the public bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublicCss, 'utf8')).match(/\\.default-page-watcher-test-recover/), 'Unable to verify public CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * change is in the apos bundle\n    await retryAssertTrue(async () => (await fs.readFile(assetPathAposCss, 'utf8')).match(/\\.default-page-watcher-test-recover/), 'Unable to verify apos CSS asset was rebuilt by the watcher', 500, 10000);\n\n    // * page has been restarted\n    await retryAssertTrue(() => apos.asset.restartId !== restartId, 'Unable to verify restartId has been changed', 500, 10000);\n\n    // * only src related builds were triggered\n    await retryAssertTrue(() => result.builds.length === 1 && result.builds.includes('src'), 'Unable to verify build \"src\" have been triggered', 50, 1000);\n\n    // * changes detected\n    await retryAssertTrue(() => result.changes.length === 1 && result.changes.filter(f => f.includes('modules/default-page/ui/src/index.scss')).length === 1, 'Unable to verify changes contain the proper source files', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch but not rebuild assets and not reload page when changes are not in use","suites":["Assets"],"updatePoint":{"line":702,"column":89,"index":27912},"line":702,"code":"  it('should watch but not rebuild assets and not reload page when changes are not in use', async function () {\n    await t.destroy(apos);\n    let result = {};\n    let rebuilt = false;\n    const setTestResult = obj => {\n      result = obj;\n      rebuilt = true;\n    };\n    const rootPath = process.cwd();\n    const assetPathJs = path.join(rootPath, 'test/modules/default-page/ui/src/index.js');\n    const assetPathScss = path.join(rootPath, 'test/modules/default-page/ui/src/index.scss');\n    const assetPathPublicJs = path.join(rootPath, 'test/public/apos-frontend/default/public-module-bundle.js');\n    const assetPathPublicCss = path.join(rootPath, 'test/public/apos-frontend/default/public-bundle.css');\n    const assetPathAposJs = path.join(rootPath, 'test/public/apos-frontend/default/apos-module-bundle.js');\n    const assetPathAposCss = path.join(rootPath, 'test/public/apos-frontend/default/apos-bundle.css');\n    const assetContentJs = fs.readFileSync(assetPathJs, 'utf-8');\n    const assetContentScss = fs.readFileSync(assetPathScss, 'utf-8');\n    // Resurrect the default assets content if test has failed\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(setTestResult);\n              }\n            };\n          }\n        }\n      }\n    });\n    // Assert defaults\n    const restartId = apos.asset.restartId;\n    assert(apos.asset.buildWatcher);\n    assert(apos.asset.restartId);\n    assert(!result.builds);\n    assert(!result.changes);\n    assert.equal(rebuilt, false);\n\n    // * modify assets\n    fs.writeFileSync(assetPathJs, 'export default () => { \\'default-page-watcher-test-src\\'; };\\n', 'utf8');\n    fs.writeFileSync(assetPathScss, '.default-page-watcher-test-src{color:red;}\\n', 'utf8');\n\n    // * rebuild handler has been triggered\n    await retryAssertTrue(() => rebuilt === true, 'Unable to verify rebuild has been triggered', 500, 10000);\n\n    // * change is NOT in the public bundle\n    await retryAssertTrue(async () => !(await fs.readFile(assetPathPublicJs, 'utf8')).match(/default-page-watcher-test-src/), 'Unable to verify public JS asset was NOT rebuilt by the watcher', 500, 1000);\n    await retryAssertTrue(async () => !(await fs.readFile(assetPathPublicCss, 'utf8')).match(/\\.default-page-watcher-test-src/), 'Unable to verify public CSS asset was NOT rebuilt by the watcher', 500, 1000);\n\n    // * change is NOT in the apos bundle\n    await retryAssertTrue(async () => !(await fs.readFile(assetPathAposJs, 'utf8')).match(/default-page-watcher-test-src/), 'Unable to verify apos JS asset was NOT rebuilt by the watcher', 500, 1000);\n    await retryAssertTrue(async () => !(await fs.readFile(assetPathAposCss, 'utf8')).match(/\\.default-page-watcher-test-src/), 'Unable to verify apos CSS asset was NOT rebuilt by the watcher', 500, 1000);\n\n    // * page has NOT been restarted\n    await retryAssertTrue(() => apos.asset.restartId === restartId, 'Unable to verify restartId has NOT been changed', 500, 1000);\n\n    // * no builds were triggered\n    await retryAssertTrue(() => result.builds.length === 0, 'Unable to verify build \"src\" has NOT been triggered', 50, 1000);\n\n    // * changes detected\n    await retryAssertTrue(() => result.changes.length === 2 && result.changes.filter(f => f.includes('modules/default-page/ui/src/index.js') || f.includes('modules/default-page/ui/src/index.scss')).length === 2, 'Unable to verify changes contain the proper source files', 50, 1000);\n    await t.destroy(apos);\n    assert.equal(apos.asset.buildWatcher, null);\n    apos = null;\n    fs.writeFileSync(assetPathJs, assetContentJs, 'utf8');\n    fs.writeFileSync(assetPathScss, assetContentScss, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should watch and rebuild assets in a debounced queue","suites":["Assets"],"updatePoint":{"line":774,"column":58,"index":31834},"line":774,"code":"  it('should watch and rebuild assets in a debounced queue', async function () {\n    await t.destroy(apos);\n    let timesRebuilt = 0;\n    const inc = () => {\n      timesRebuilt += 1;\n    };\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        ...modules,\n        '@apostrophecms/asset': {\n          extendMethods() {\n            return {\n              async watchUiAndRebuild(_super) {\n                return _super(inc);\n              }\n            };\n          }\n        }\n      }\n    });\n    assert(apos.asset.buildWatcher);\n    const assetPath = path.join(process.cwd(), 'test/modules/bundle-page/ui/src/extra.js');\n    const assetPathPublic = path.join(process.cwd(), 'test/public/apos-frontend/default/extra-module-bundle.js');\n    const assetContent = fs.readFileSync(assetPath, 'utf-8');\n\n    // Modify below the debounce rate\n    for (const i of [1, 2, 3]) {\n      await fs.writeFile(assetPath, `export default () => { 'bundle-page-watcher-test-${i}'; };\\n`, 'utf8');\n      await Promise.delay(300);\n    }\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublic, 'utf8')).match(/bundle-page-watcher-test-3/), 'Unable to verify public asset rebuilding by the watcher', 500, 10000);\n    await retryAssertTrue(() => timesRebuilt === 1, `Expected to rebuild 1 time, got ${timesRebuilt}`, 100, 5000);\n\n    // Modify above the debounce rate, test the queue cap\n    timesRebuilt = 0;\n    for (const i of [1, 2, 3]) {\n      await fs.writeFile(assetPath, `export default () => { 'bundle-page-watcher-test-${i}0'; };\\n`, 'utf8');\n      await Promise.delay(1050);\n    }\n    await retryAssertTrue(async () => (await fs.readFile(assetPathPublic, 'utf8')).match(/bundle-page-watcher-test-30/), 'Unable to verify public asset rebuilding by the watcher', 500, 10000);\n    await retryAssertTrue(() => timesRebuilt === 3, `Expected to rebuild 3 times, got ${timesRebuilt}`, 100, 5000);\n    await t.destroy(apos);\n    apos = null;\n    fs.writeFileSync(assetPath, assetContent, 'utf8');\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should be able to setup the debounce time","suites":["Assets"],"updatePoint":{"line":821,"column":47,"index":33865},"line":821,"code":"  it('should be able to setup the debounce time', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/asset': {\n          options: {\n            watchDebounceMs: 500\n          }\n        }\n      }\n    });\n    assert.equal(apos.asset.buildWatcherDebounceMs, 500);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should be able to register an external build watcher","suites":["Assets"],"updatePoint":{"line":834,"column":58,"index":34201},"line":834,"code":"  it('should be able to register an external build watcher', async function () {\n    await t.destroy(apos);\n    const chokidar = require('chokidar');\n    let instance;\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        '@apostrophecms/asset': {\n          methods(self) {\n            return {\n              registerBuildWatcher() {\n                self.buildWatcher = chokidar.watch([__filename], {\n                  cwd: self.apos.rootDir,\n                  ignoreInitial: true\n                });\n                instance = self.buildWatcher;\n              }\n            };\n          }\n        }\n      }\n    });\n    assert.equal(apos.asset.buildWatcher, instance);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should not watch if explicitly disabled by option or env in development","suites":["Assets"],"updatePoint":{"line":859,"column":77,"index":34937},"line":859,"code":"  it('should not watch if explicitly disabled by option or env in development', async function () {\n    await t.destroy(apos);\n    process.env.APOS_ASSET_WATCH = '0';\n    apos = await t.create({\n      root: module,\n      autoBuild: true\n    });\n    assert(!apos.asset.buildWatcher);\n    delete process.env.APOS_ASSET_WATCH;\n    await t.destroy(apos);\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules: {\n        '@apostrophecms/asset': {\n          options: {\n            watch: false\n          }\n        }\n      }\n    });\n    assert(!apos.asset.buildWatcher);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should not watch if autoBuild is disabled","suites":["Assets"],"updatePoint":{"line":882,"column":47,"index":35508},"line":882,"code":"  it('should not watch if autoBuild is disabled', async function () {\n    await t.destroy(apos);\n    apos = await t.create({\n      root: module\n    });\n    assert(!apos.asset.buildWatcher);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should not watch in production","suites":["Assets"],"updatePoint":{"line":889,"column":36,"index":35693},"line":889,"code":"  it('should not watch in production', async function () {\n    await t.destroy(apos);\n    process.env.NODE_ENV = 'production';\n    apos = await t.create({\n      root: module,\n      autoBuild: true,\n      modules\n    });\n    assert(!apos.asset.buildWatcher);\n    process.env.NODE_ENV = 'development';\n    await t.destroy(apos);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should pass the right options to webpack extensions from all modules","suites":["Assets"],"updatePoint":{"line":901,"column":74,"index":36064},"line":901,"code":"  it('should pass the right options to webpack extensions from all modules', async function () {\n    const {\n      extConfig1,\n      extConfig2\n    } = getWebpackConfigsForExtensionOptions();\n    apos = await t.create({\n      root: module,\n      modules: {\n        'test-widget': {\n          extend: '@apostrophecms/widget-type',\n          webpack: extConfig1\n        },\n        test: {\n          extend: '@apostrophecms/piece-type',\n          webpack: extConfig2\n        }\n      }\n    });\n    const {\n      extensions,\n      extensionOptions\n    } = await getWebpackExtensions({\n      name: 'src',\n      getMetadata: apos.synth.getMetadata,\n      modulesToInstantiate: apos.modulesToBeInstantiated()\n    });\n    assertWebpackExtensionOptions(extensions, extensionOptions);\n    await t.destroy(apos);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should allow two modules extending each others to pass options to the same webpack extension","suites":["Assets"],"updatePoint":{"line":930,"column":98,"index":36895},"line":930,"code":"  it('should allow two modules extending each others to pass options to the same webpack extension', async function () {\n    const {\n      extConfig1,\n      extConfig2\n    } = getWebpackConfigsForExtensionOptions();\n    apos = await t.create({\n      root: module,\n      modules: {\n        'test-widget': {\n          extend: '@apostrophecms/widget-type',\n          instantiate: false,\n          webpack: extConfig1\n        },\n        'test-widget-special': {\n          extend: 'test-widget',\n          webpack: extConfig2\n        }\n      }\n    });\n    assert(!apos.modules['test-widget']);\n    const {\n      extensions,\n      extensionOptions\n    } = await getWebpackExtensions({\n      name: 'src',\n      getMetadata: apos.synth.getMetadata,\n      modulesToInstantiate: apos.modulesToBeInstantiated()\n    });\n    assertWebpackExtensionOptions(extensions, extensionOptions);\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should verify that asset re-bundle configs are valid","suites":["Assets"],"updatePoint":{"line":960,"column":58,"index":37734},"line":960,"code":"  it('should verify that asset re-bundle configs are valid', async function () {\n    assert.doesNotThrow(() => verifyRebundleConfig());\n    assert.doesNotThrow(() => verifyRebundleConfig([]));\n    assert.doesNotThrow(() => formatRebundleConfig());\n    assert.doesNotThrow(() => formatRebundleConfig({}));\n    assert.doesNotThrow(() => formatRebundleConfig({\n      'bundle-page': 'main',\n      'bundle-page-type': 'new',\n      'bundle-widget:extra': 'widget',\n      '@company/bundle:company': 'newcompany',\n      'bundle-edge:edge': 'main'\n    }));\n\n    // too much catch-all\n    assert.throws(() => formatRebundleConfig({\n      'bundle-page': 'main',\n      'bundle-page:extra': 'new'\n    }));\n    assert.throws(() => formatRebundleConfig({\n      'bundle-page:extra': 'new',\n      'bundle-page': 'main'\n    }));\n    assert.throws(() => formatRebundleConfig({\n      'bundle-page': 'main',\n      'bundle-page:extra': 'main'\n    }));\n    assert.throws(() => formatRebundleConfig({\n      'bundle-page': 'new',\n      'bundle-page:extra': 'another'\n    }));\n    assert.throws(() => formatRebundleConfig({\n      'bundle-page:extra': 'another',\n      'bundle-page': 'new'\n    }));\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should build and remap the right bundles in dev and prod modes","suites":["Assets"],"updatePoint":{"line":995,"column":68,"index":38922},"line":995,"code":"  it('should build and remap the right bundles in dev and prod modes', async function () {\n    await t.destroy(apos);\n    const getPath = p => `${publicFolderPath}/apos-frontend/` + p;\n    const checkFileExists = async p => fs.pathExists(getPath(p));\n    async function checkBundlesExists(folderPath, fileNames) {\n      for (const fileName of fileNames) {\n        const extraBundleExists = await checkFileExists(folderPath + fileName);\n        assert(extraBundleExists);\n      }\n    }\n    function checkBundlesContents(folderPath, bundles, not = false) {\n      for (const [fileName, regexes] of Object.entries(bundles)) {\n        const contents = fs.readFileSync(getPath(folderPath + fileName), 'utf-8');\n        for (const regex of regexes) {\n          const method = not ? 'doesNotMatch' : 'match';\n          assert[method](contents, new RegExp(regex), `${fileName} - ${regex}`);\n        }\n      }\n    }\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@company/bundle': {},\n        'bundle-edge': {},\n        ...modules,\n        '@apostrophecms/asset': {\n          options: {\n            rebundleModules: {\n              // Everything from the `bundle-page` module should\n              // go in the regular \"main\" bundle\n              'bundle-page': 'main',\n              // all from `bundle-page-type` should go\n              // in a new bundle 'bundle-page'\n              'bundle-page-type': 'new',\n              // 'extra2' bundle from `bundle-widget` should go\n              // in a new bundle 'widget-bundle'\n              'bundle-widget:extra2': 'widget',\n              // 'company' bundle from `@company/bundle:company` should go\n              // in a new bundle 'newcompany'. The local module contribution\n              // to the 'company' build should stay.\n              '@company/bundle:company': 'newcompany',\n              // Edge case - send \"edge\" bundle only to the main bundle\n              'bundle-edge:edge': 'main'\n            }\n          }\n        }\n      }\n    });\n    const existingBundleNames = ['public-module-bundle.js', 'public-bundle.css', 'new-module-bundle.js', 'new-bundle.css', 'company-module-bundle.js', 'company-bundle.css', 'newcompany-module-bundle.js', 'newcompany-bundle.css', 'widget-module-bundle.js'];\n    const bundleContents = {\n      'public-module-bundle.js': [/BUNDLE_MAIN_PAGE['\"]+/g, /BUNDLE_EXTRA_PAGE['\"]+/g, /BUNDLE_EDGE['\"]+/g],\n      'public-bundle.css': [/\\.main-page[\\s]*\\{/g, /\\.extra-page[\\s]*\\{/g, /\\.edge[\\s]*\\{/g],\n      'new-module-bundle.js': [/BUNDLE_INDEX_PAGE_TYPE['\"]+/g, /BUNDLE_ANOTHER_PAGE_TYPE['\"]+/g, /BUNDLE_MAIN_PAGE_TYPE['\"]+/g],\n      'new-bundle.css': [/\\.index-page-type[\\s]*\\{/g, /\\.main-page-type[\\s]*\\{/g],\n      'company-module-bundle.js': [/BUNDLE_OVERRIDE_COMPANY['\"]+/g],\n      'company-bundle.css': [/\\.override-company[\\s]*\\{/g],\n      'newcompany-module-bundle.js': [/BUNDLE_COMPANY['\"]+/g],\n      'newcompany-bundle.css': [/\\.company[\\s]*\\{/g],\n      'widget-module-bundle.js': [/BUNDLE_WIDGET_EXTRA2['\"]+/g]\n    };\n    const bundleNoDuplicateContents = {\n      'public-module-bundle.js': [/BUNDLE_COMPANY['\"]+/g, /BUNDLE_WIDGET_EXTRA2['\"]+/g, /BUNDLE_OVERRIDE_COMPANY['\"]+/g, /BUNDLE_MAIN_PAGE_TYPE['\"]+/g, /BUNDLE_ANOTHER_PAGE_TYPE['\"]+/g, /BUNDLE_INDEX_PAGE_TYPE['\"]+/g],\n      'public-bundle.css': [/\\.main-page-type[\\s]*\\{/g, /\\.override-company[\\s]*\\{/g, /\\.company[\\s]*\\{/g]\n    };\n    const nonExistingBundleNames = ['main-module-bundle.js', 'extra-module-bundle.js', 'extra2-module-bundle.js', 'edge-module-bundle.js', 'main-bundle.css', 'extra-bundle.css', 'edge-bundle.css'];\n    process.env.NODE_ENV = 'production';\n    await deleteBuiltFolders(publicFolderPath, true);\n    await apos.asset.tasks.build.task();\n    {\n      const [releaseId] = await fs.readdir(getPath('releases'));\n      const releasePath = `releases/${releaseId}/default/`;\n      await checkBundlesExists(releasePath, existingBundleNames);\n      checkBundlesContents(releasePath, bundleContents);\n      checkBundlesContents(releasePath, bundleNoDuplicateContents, true);\n      for (const file of nonExistingBundleNames) {\n        assert.throws(() => fs.readFileSync(releasePath + file), {\n          code: 'ENOENT'\n        }, file);\n      }\n    }\n    process.env.NODE_ENV = 'development';\n    await deleteBuiltFolders(publicFolderPath, true);\n    await apos.asset.tasks.build.task();\n    {\n      const releasePath = getPath('default/');\n      await checkBundlesExists('default/', existingBundleNames);\n      checkBundlesContents('default/', bundleContents);\n      checkBundlesContents('default/', bundleNoDuplicateContents, true);\n      for (const file of nonExistingBundleNames) {\n        assert.throws(() => fs.readFileSync(releasePath + file), {\n          code: 'ENOENT'\n        }, file);\n      }\n    }\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should load the right remapped bundles inside the right page","suites":["Assets"],"updatePoint":{"line":1090,"column":66,"index":43728},"line":1090,"code":"  it('should load the right remapped bundles inside the right page', async function () {\n    await t.destroy(apos);\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@company/bundle': {},\n        'bundle-edge': {},\n        ...modules,\n        '@apostrophecms/asset': {\n          options: {\n            rebundleModules: {\n              'bundle-page': 'main',\n              'bundle-page-type': 'new',\n              'bundle-widget:extra2': 'widget',\n              '@company/bundle:company': 'newcompany'\n            }\n          }\n        }\n      }\n    });\n    const {\n      _id: homeId\n    } = await apos.page.find(apos.task.getAnonReq(), {\n      level: 0\n    }).toObject();\n    const jar = apos.http.jar();\n    await apos.doc.db.insertMany(pagesToInsert(homeId));\n    const bundlePage = await apos.http.get('/bundle', {\n      jar\n    });\n    assert(bundlePage.includes(getStylesheetMarkup('public-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('new-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('main-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('extra-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('extra2-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('newcompany-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('company-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('public-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('new-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('widget-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('main-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('extra-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('extra2-module-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('newcompany-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('company-bundle')));\n    const childPage = await apos.http.get('/bundle/child', {\n      jar\n    });\n    assert(childPage.includes(getStylesheetMarkup('public-bundle')));\n    assert(childPage.includes(getStylesheetMarkup('new-bundle')));\n    assert(!childPage.includes(getStylesheetMarkup('main-bundle')));\n    assert(!childPage.includes(getStylesheetMarkup('extra-bundle')));\n    assert(!childPage.includes(getStylesheetMarkup('extra2-bundle')));\n    assert(childPage.includes(getScriptMarkup('public-module-bundle')));\n    assert(childPage.includes(getScriptMarkup('new-module-bundle')));\n    assert(!childPage.includes(getScriptMarkup('widget-module-bundle')));\n    assert(!childPage.includes(getScriptMarkup('main-module-bundle')));\n    assert(!childPage.includes(getScriptMarkup('extra-module-bundle')));\n    assert(!childPage.includes(getScriptMarkup('extra2-module-bundle')));\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should load all the remapped bundles on all pages when the user is logged in","suites":["Assets"],"updatePoint":{"line":1150,"column":82,"index":46563},"line":1150,"code":"  it('should load all the remapped bundles on all pages when the user is logged in', async function () {\n    await t.createAdmin(apos);\n    const jar = await t.getUserJar(apos);\n    const homePage = await apos.http.get('/', {\n      jar\n    });\n    assert(homePage.match(/logged in/));\n    const bundlePage = await apos.http.get('/bundle', {\n      jar\n    });\n    assert(bundlePage.includes(getStylesheetMarkup('apos-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('new-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('company-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('newcompany-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('public-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('main-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('extra-bundle')));\n    assert(!bundlePage.includes(getStylesheetMarkup('extra2-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('apos-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('new-module-bundle')));\n    assert(bundlePage.includes(getScriptMarkup('widget-module-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('newcompany-bundle')));\n    assert(bundlePage.includes(getStylesheetMarkup('company-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('public-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('main-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('extra-module-bundle')));\n    assert(!bundlePage.includes(getScriptMarkup('extra2-module-bundle')));\n  });","file":"assets.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Attachment"],"updatePoint":{"line":19,"column":45,"index":685},"line":19,"code":"  it('should be a property of the apos object', async function () {\n    this.timeout(t.timeout);\n    this.slow(2000);\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.attachment);\n  });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should upload a text file using the attachments api when user","suites":["Attachment","insert"],"updatePoint":{"line":46,"column":69,"index":1494},"line":46,"code":"    it('should upload a text file using the attachments api when user', async function () {\n      return insert('upload_apos_api.txt');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should upload an image file using the attachments api when user","suites":["Attachment","insert"],"updatePoint":{"line":49,"column":71,"index":1640},"line":49,"code":"    it('should upload an image file using the attachments api when user', async function () {\n      imageOne = await insert('upload_image.png');\n      assert(imageOne && imageOne._id);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should not upload an exe file","suites":["Attachment","insert"],"updatePoint":{"line":53,"column":37,"index":1799},"line":53,"code":"    it('should not upload an exe file', async function () {\n      const filename = 'bad_file.exe';\n      let good = false;\n      try {\n        await apos.attachment.insert(apos.task.getReq(), {\n          name: filename,\n          path: uploadSource + filename\n        });\n      } catch (e) {\n        good = true;\n      }\n      assert(good);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should allow upload if extension has been added to the current fileGroups","suites":["Attachment","insert"],"updatePoint":{"line":66,"column":81,"index":2192},"line":66,"code":"    it('should allow upload if extension has been added to the current fileGroups', async function () {\n      let apos;\n      let good = true;\n      try {\n        apos = await t.create({\n          root: module,\n          modules: {\n            '@apostrophecms/attachment': {\n              options: {\n                addFileGroups: [{\n                  name: 'images',\n                  extensions: ['mp4']\n                }]\n              }\n            }\n          }\n        });\n        const filename = 'tiny.mp4';\n        await apos.attachment.insert(apos.task.getReq(), {\n          name: filename,\n          path: uploadSource + filename\n        });\n      } catch (e) {\n        good = false;\n      } finally {\n        assert(good);\n        t.destroy(apos);\n      }\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should allow upload if extension has been added in a new fileGroup","suites":["Attachment","insert"],"updatePoint":{"line":95,"column":74,"index":2961},"line":95,"code":"    it('should allow upload if extension has been added in a new fileGroup', async function () {\n      let apos;\n      let good = true;\n      try {\n        apos = await t.create({\n          root: module,\n          modules: {\n            '@apostrophecms/attachment': {\n              options: {\n                addFileGroups: [{\n                  name: 'testGroup',\n                  extensions: ['mp4'],\n                  extensionMaps: {}\n                }]\n              }\n            }\n          }\n        });\n        const filename = 'tiny.mp4';\n        await apos.attachment.insert(apos.task.getReq(), {\n          name: filename,\n          path: uploadSource + filename\n        });\n      } catch (e) {\n        good = false;\n      } finally {\n        assert(good);\n        t.destroy(apos);\n      }\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should crop an image file when requested","suites":["Attachment","insert"],"updatePoint":{"line":125,"column":48,"index":3744},"line":125,"code":"    it('should crop an image file when requested', async function () {\n      let result = await insert('crop_image.png');\n      const crop = {\n        top: 10,\n        left: 10,\n        width: 80,\n        height: 80\n      };\n      await apos.attachment.crop(apos.task.getReq(), result._id, crop);\n      result = await apos.db.collection(collectionName).findOne({\n        _id: result._id\n      });\n      assert(result);\n      assert(result.crops.length);\n      const t = uploadTarget + result._id + '-' + result.name + '.' + result.crops[0].left + '.' + result.crops[0].top + '.' + result.crops[0].width + '.' + result.crops[0].height + '.' + result.extension;\n      assert(fs.existsSync(t));\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should handle a file with a jpeg extension properly and set extension to jpg","suites":["Attachment","insert"],"updatePoint":{"line":142,"column":84,"index":4480},"line":142,"code":"    it('should handle a file with a jpeg extension properly and set extension to jpg', async function () {\n      let result = await insert('crop_image.jpeg');\n      const crop = {\n        top: 10,\n        left: 10,\n        width: 80,\n        height: 80\n      };\n      await apos.attachment.crop(apos.task.getReq(), result._id, crop);\n      result = await apos.db.collection(collectionName).findOne({\n        _id: result._id\n      });\n      assert(result);\n      assert(result.crops.length);\n      const t = uploadTarget + result._id + '-' + result.name + '.' + result.crops[0].left + '.' + result.crops[0].top + '.' + result.crops[0].width + '.' + result.crops[0].height + '.jpg';\n      assert(fs.existsSync(t));\n      assert(result.extension === 'jpg');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should generate the \"full\" URL when no size specified for image","suites":["Attachment","insert"],"updatePoint":{"line":160,"column":71,"index":5230},"line":160,"code":"    it('should generate the \"full\" URL when no size specified for image', function () {\n      const url = apos.attachment.url({\n        group: 'images',\n        name: 'test',\n        extension: 'jpg',\n        _id: 'test'\n      });\n      assert.strictEqual(url, '/uploads/attachments/test-test.full.jpg');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should generate the \"one-half\" URL when one-half size specified for image","suites":["Attachment","insert"],"updatePoint":{"line":169,"column":81,"index":5553},"line":169,"code":"    it('should generate the \"one-half\" URL when one-half size specified for image', function () {\n      const url = apos.attachment.url({\n        group: 'images',\n        name: 'test',\n        extension: 'jpg',\n        _id: 'test'\n      }, {\n        size: 'one-half'\n      });\n      assert(url === '/uploads/attachments/test-test.one-half.jpg');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should generate the original URL when \"original\" size specified for image","suites":["Attachment","insert"],"updatePoint":{"line":180,"column":81,"index":5907},"line":180,"code":"    it('should generate the original URL when \"original\" size specified for image', function () {\n      const url = apos.attachment.url({\n        group: 'images',\n        name: 'test',\n        extension: 'jpg',\n        _id: 'test'\n      }, {\n        size: 'original'\n      });\n      assert(url === '/uploads/attachments/test-test.jpg');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should generate the original URL when no size specified for pdf","suites":["Attachment","insert"],"updatePoint":{"line":191,"column":71,"index":6242},"line":191,"code":"    it('should generate the original URL when no size specified for pdf', function () {\n      const url = apos.attachment.url({\n        group: 'office',\n        name: 'test',\n        extension: 'pdf',\n        _id: 'test'\n      });\n      assert(url === '/uploads/attachments/test-test.pdf');\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should save and track docIds properly as part of an @apostrophecms/image","suites":["Attachment","insert"],"updatePoint":{"line":200,"column":80,"index":6550},"line":200,"code":"    it('should save and track docIds properly as part of an @apostrophecms/image', async function () {\n      let image = apos.image.newInstance();\n      const req = apos.task.getReq();\n      let attachment = await apos.attachment.insert(apos.task.getReq(), {\n        name: 'upload_image.png',\n        path: uploadSource + 'upload_image.png'\n      });\n      assert(attachment);\n      image.title = 'Test Image';\n      image.attachment = attachment;\n      image = await apos.image.insert(req, image);\n      assert(image);\n      attachment = await apos.attachment.db.findOne({\n        _id: image.attachment._id\n      });\n      assert(attachment);\n      assert(attachment.archived === false);\n      assert(attachment.docIds);\n      // Should be 3 because of \"previous\"\n      assert(attachment.docIds.length === 3);\n      assert(attachment.docIds.find(docId => docId === `${image.aposDocId}:en:draft`));\n      assert(attachment.docIds.find(docId => docId === `${image.aposDocId}:en:published`));\n      assert(attachment.archivedDocIds);\n      assert(attachment.archivedDocIds.length === 0);\n      try {\n        const fd = fs.openSync(apos.rootDir + '/public' + apos.attachment.url(attachment, {\n          size: 'original'\n        }), 'r');\n        assert(fd);\n        fs.closeSync(fd);\n      } catch (e) {\n        assert(false);\n      }\n      image.archived = true;\n      await apos.image.update(req, image);\n      attachment = await apos.attachment.db.findOne({\n        _id: image.attachment._id\n      });\n      assert(!attachment.archived);\n      // Because \"draft\" and \"previous\" both have it, unarchived\n      assert(attachment.docIds.length === 2);\n      assert(attachment.archivedDocIds.length === 1);\n      // Should still be accessible at this point because the draft still uses it\n      const fd = fs.openSync(apos.rootDir + '/public' + apos.attachment.url(attachment, {\n        size: 'original'\n      }), 'r');\n      assert(fd);\n      fs.closeSync(fd);\n      // Now archive the draft\n      const draftReq = apos.task.getReq({\n        mode: 'draft'\n      });\n      const draft = await apos.image.find(draftReq, {\n        aposDocId: image.aposDocId\n      }).toObject();\n      assert(draft);\n      assert(draft.aposLocale === 'en:draft');\n      draft.archived = true;\n      await apos.image.update(req, draft);\n      // Now it should be inaccessible\n      attachment = await apos.attachment.db.findOne({\n        _id: image.attachment._id\n      });\n      assert(attachment.archived);\n      assert(attachment.docIds.length === 0);\n      assert(attachment.archivedDocIds.length === 3);\n      let good = false;\n      try {\n        fs.openSync(apos.rootDir + '/public' + apos.attachment.url(attachment, {\n          size: 'original'\n        }), 'r');\n      } catch (e) {\n        good = true;\n      }\n      if (!good) {\n        throw new Error('should not have been accessible');\n      }\n      // Now rescue the published version from the archive\n      image.archived = false;\n      await apos.image.update(req, image);\n      attachment = await apos.attachment.db.findOne({\n        _id: image.attachment._id\n      });\n      assert(!attachment.archived);\n      assert(attachment.docIds.length === 1);\n      // Don't forget \"previous\"\n      assert(attachment.archivedDocIds.length === 2);\n      try {\n        const fd = fs.openSync(apos.rootDir + '/public' + apos.attachment.url(attachment, {\n          size: 'original'\n        }), 'r');\n        assert(fd);\n        fs.closeSync(fd);\n      } catch (e) {\n        assert(false);\n      }\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should annotate images with URLs using .all method","suites":["Attachment","api"],"updatePoint":{"line":336,"column":58,"index":10920},"line":336,"code":"    it('should annotate images with URLs using .all method', async function () {\n      assert(!imageOne._urls);\n      apos.attachment.all({\n        imageOne\n      }, {\n        annotate: true\n      });\n      assert(imageOne._urls);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment of a given image with the image cropping and focal point values","suites":["Attachment","api"],"updatePoint":{"line":345,"column":100,"index":11201},"line":345,"code":"    it('should return the attachment of a given image with the image cropping and focal point values', function () {\n      const attachments = apos.attachment.all(imageMock, {\n        annotate: true\n      });\n      assert(attachments[0]._crop.top === imageMock._fields.top);\n      assert(attachments[0]._crop.left === imageMock._fields.left);\n      assert(attachments[0]._crop.width === imageMock._fields.width);\n      assert(attachments[0]._crop.height === imageMock._fields.height);\n      assert(attachments[0]._focalPoint.x === imageMock._fields.x);\n      assert(attachments[0]._focalPoint.y === imageMock._fields.y);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment of a given image with the uncropped urls","suites":["Attachment","api"],"updatePoint":{"line":356,"column":77,"index":11807},"line":356,"code":"    it('should return the attachment of a given image with the uncropped urls', function () {\n      const [attachment] = apos.attachment.all(imageMock, {\n        annotate: true\n      });\n      const imgVersions = ['original', 'max', 'full', 'two-thirds', 'one-half', 'one-third', 'one-sixth'];\n      assert(attachment._urls.uncropped);\n      assert(!Array.isArray(attachment._urls.uncropped));\n      assert(typeof attachment._urls.uncropped === 'object');\n      imgVersions.forEach(version => {\n        assert(attachment._urls.uncropped[version]);\n        assert(typeof attachment._urls.uncropped[version] === 'string');\n      });\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should not clone attachment","suites":["Attachment","api"],"updatePoint":{"line":369,"column":35,"index":12404},"line":369,"code":"    it('should not clone attachment', function () {\n      const attachments = apos.attachment.all(imageMock, {\n        annotate: true\n      });\n      assert(attachments[0] === imageMock.attachment);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment width","suites":["Attachment","api"],"updatePoint":{"line":375,"column":42,"index":12618},"line":375,"code":"    it('should return the attachment width', async function () {\n      const width = apos.attachment.getWidth(attachmentMock);\n      assert(width === 960);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment cropping width","suites":["Attachment","api"],"updatePoint":{"line":379,"column":51,"index":12791},"line":379,"code":"    it('should return the attachment cropping width', async function () {\n      const width = apos.attachment.getWidth({\n        ...attachmentMock,\n        _crop: {\n          width: 300\n        }\n      });\n      assert(width === 300);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment height","suites":["Attachment","api"],"updatePoint":{"line":388,"column":43,"index":13026},"line":388,"code":"    it('should return the attachment height', async function () {\n      const height = apos.attachment.getHeight(attachmentMock);\n      assert(height === 542);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should return the attachment cropping height","suites":["Attachment","api"],"updatePoint":{"line":392,"column":52,"index":13203},"line":392,"code":"    it('should return the attachment cropping height', async function () {\n      const height = apos.attachment.getHeight({\n        ...attachmentMock,\n        _crop: {\n          height: 400\n        }\n      });\n      assert(height === 400);\n    });","file":"attachments.js","skipped":false,"dir":"test"},{"name":"should be subclassable","suites":["Base Module"],"updatePoint":{"line":9,"column":28,"index":242},"line":9,"code":"  it('should be subclassable', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        // will push an asset for us to look for later\n        '@apostrophecms/test-module-push': {},\n        // test the getOption method of modules\n        'test-get-option': {},\n        'test-get-option-2': {}\n      }\n    });\n    assert(apos.test && apos.test.color === 'red');\n  });","file":"base-module.js","skipped":false,"dir":"test"},{"name":"should produce correct responses via the getOption method","suites":["Base Module"],"updatePoint":{"line":22,"column":63,"index":680},"line":22,"code":"  it('should produce correct responses via the getOption method', async function () {\n    const mod = apos.modules['test-get-option'];\n    const req = apos.task.getReq();\n    assert.strictEqual(mod.getOption(req, 'flavors.grape.sweetness'), 20);\n    assert.strictEqual(mod.getOption(req, 'flavors.cheese.swarthiness'), undefined);\n    assert.strictEqual(mod.getOption(req, 'flavors.grape.ingredients.0'), 'chemicals');\n    const markup = await mod.render(req, 'test.html');\n    assert(markup.match(/20/));\n    assert(markup.match(/yup/));\n  });","file":"base-module.js","skipped":false,"dir":"test"},{"name":"APOS_BASE_URL should take effect","suites":["Locales"],"updatePoint":{"line":25,"column":38,"index":676},"line":25,"code":"  it('APOS_BASE_URL should take effect', async function () {\n    const req = apos.task.getReq();\n    const home = await apos.doc.find(req, {\n      slug: '/'\n    }).toObject();\n    assert(home);\n    assert.strictEqual(home._url, 'https://madethisup.com/');\n  });","file":"base-url-env-var.js","skipped":false,"dir":"test"},{"name":"should merge the options and local.js correctly","suites":["bootstrap of Apostrophe core"],"updatePoint":{"line":8,"column":53,"index":286},"line":8,"code":"  it('should merge the options and local.js correctly', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        overrideTest: 'test' // overriden by data/local.js\n      });\n\n      assert(apos.options.overrideTest === 'foo');\n    } finally {\n      await t.destroy(apos);\n    }\n  });","file":"bootstrapping.js","skipped":false,"dir":"test"},{"name":"should accept a `__localPath` option and invoke local.js as a function if it is provided as one","suites":["bootstrap of Apostrophe core"],"updatePoint":{"line":21,"column":101,"index":664},"line":21,"code":"  it('should accept a `__localPath` option and invoke local.js as a function if it is provided as one', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        overrideTest: 'test',\n        // overriden by data/local_fn.js\n\n        __localPath: '/data/local_fn.js'\n      });\n      assert(apos.options.overrideTest === 'foo');\n    } finally {\n      await t.destroy(apos);\n    }\n  });","file":"bootstrapping.js","skipped":false,"dir":"test"},{"name":"should invoke local.js as a function with the apos and config object","suites":["bootstrap of Apostrophe core"],"updatePoint":{"line":36,"column":74,"index":1068},"line":36,"code":"  it('should invoke local.js as a function with the apos and config object', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        overrideTest: 'test',\n        // concated in local_fn_b.js\n\n        __localPath: '/data/local_fn_b.js'\n      });\n      assert(apos.options.overrideTest === 'test-foo');\n    } finally {\n      await t.destroy(apos);\n    }\n  });","file":"bootstrapping.js","skipped":false,"dir":"test"},{"name":"should support bundle","suites":["Bundle"],"updatePoint":{"line":29,"column":27,"index":1135},"line":29,"code":"  it('should support bundle', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          'test-bundle': {},\n          'test-bundle-sub': {}\n        }\n      });\n      assert(apos.test && apos.test.color === 'red');\n      assert(apos.subtest && apos.subtest.color === 'red');\n    } finally {\n      if (apos) {\n        await apos.destroy();\n      }\n    }\n  });","file":"bundle.js","skipped":false,"dir":"test"},{"name":"should ignore transitive dependencies even when present in node_modules due to flattening","suites":["Bundle"],"updatePoint":{"line":47,"column":95,"index":1627},"line":47,"code":"  it('should ignore transitive dependencies even when present in node_modules due to flattening', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          'same-name-as-transitive-dependency': {}\n        }\n      });\n      assert(apos.same && apos.same.color === 'purple');\n    } finally {\n      if (apos) {\n        await apos.destroy();\n      }\n    }\n  });","file":"bundle.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Caches"],"updatePoint":{"line":9,"column":37,"index":248},"line":9,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.cache);\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should not contain capuchin yet","suites":["Caches"],"updatePoint":{"line":15,"column":37,"index":393},"line":15,"code":"  it('should not contain capuchin yet', async function () {\n    assert(!(await apos.cache.get('test', 'capuchin')));\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should allow us to store capuchin","suites":["Caches"],"updatePoint":{"line":18,"column":39,"index":518},"line":18,"code":"  it('should allow us to store capuchin', async function () {\n    await apos.cache.set('test', 'capuchin', {\n      message: 'eek eek'\n    });\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"second cache can contain capuchin with a different value","suites":["Caches"],"updatePoint":{"line":23,"column":62,"index":689},"line":23,"code":"  it('second cache can contain capuchin with a different value', async function () {\n    await apos.cache.set('test2', 'capuchin', {\n      message: 'ook ook'\n    });\n    assert.strictEqual((await apos.cache.get('test', 'capuchin')).message, 'eek eek');\n    assert.strictEqual((await apos.cache.get('test2', 'capuchin')).message, 'ook ook');\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should now contain capuchin","suites":["Caches"],"updatePoint":{"line":30,"column":33,"index":1007},"line":30,"code":"  it('should now contain capuchin', async function () {\n    const monkey = await apos.cache.get('test', 'capuchin');\n    assert(monkey);\n    assert(monkey.message === 'eek eek');\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should not crash on clear #2","suites":["Caches"],"updatePoint":{"line":35,"column":34,"index":1193},"line":35,"code":"  it('should not crash on clear #2', async function () {\n    await apos.cache.clear('test');\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should not contain capuchin anymore","suites":["Caches"],"updatePoint":{"line":38,"column":41,"index":1299},"line":38,"code":"  it('should not contain capuchin anymore', async function () {\n    assert(!(await apos.cache.get('test', 'capuchin')));\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"but test2 cache still does contain capuchin","suites":["Caches"],"updatePoint":{"line":41,"column":49,"index":1434},"line":41,"code":"  it('but test2 cache still does contain capuchin', async function () {\n    assert.strictEqual((await apos.cache.get('test2', 'capuchin')).message, 'ook ook');\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"unique key index does block double insert in same namespace","suites":["Caches"],"updatePoint":{"line":44,"column":65,"index":1616},"line":44,"code":"  it('unique key index does block double insert in same namespace', async function () {\n    try {\n      await apos.cache.cacheCollection.insert({\n        name: 'test2',\n        key: 'capuchin'\n      });\n      // That's bad, we should be blocked\n      assert(false);\n    } catch (e) {\n      // That's good, we were blocked\n    }\n  });","file":"caches.js","skipped":false,"dir":"test"},{"name":"should initialize the apos object","suites":["change-doc-ids"],"updatePoint":{"line":11,"column":39,"index":294},"line":11,"code":"  it('should initialize the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        article: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'article'\n          },\n          fields: {\n            add: {\n              _categories: {\n                type: 'relationship',\n                withType: 'category'\n              }\n            }\n          }\n        },\n        category: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'category'\n          }\n        },\n        'default-page': {},\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              slug: '/test',\n              type: 'default-page',\n              title: 'Test',\n              parkedId: 'test',\n              visibility: 'public',\n              _children: [{\n                slug: '/test/child',\n                type: 'default-page',\n                title: 'Test Child',\n                parkedId: 'test-child',\n                visibility: 'public'\n              }]\n            }]\n          }\n        }\n      }\n    });\n  });","file":"change-doc-ids.js","skipped":false,"dir":"test"},{"name":"should insert categories","suites":["change-doc-ids"],"updatePoint":{"line":57,"column":30,"index":1436},"line":57,"code":"  it('should insert categories', async function () {\n    for (let i = 0; i < 10; i++) {\n      const category = apos.category.newInstance();\n      categories.push(await apos.category.insert(apos.task.getReq(), {\n        ...category,\n        title: 'Category ' + i,\n        slug: 'category-' + i\n      }));\n    }\n  });","file":"change-doc-ids.js","skipped":false,"dir":"test"},{"name":"should insert articles with relationships to categories","suites":["change-doc-ids"],"updatePoint":{"line":67,"column":61,"index":1784},"line":67,"code":"  it('should insert articles with relationships to categories', async function () {\n    for (let i = 0; i < 10; i++) {\n      const article = apos.article.newInstance();\n      articles.push(await apos.article.insert(apos.task.getReq(), {\n        ...article,\n        title: 'Article ' + i,\n        slug: 'article-' + i,\n        _categories: [categories[i % 4], categories[(i + 1) % 4]]\n      }));\n    }\n  });","file":"change-doc-ids.js","skipped":false,"dir":"test"},{"name":"changeDocIds should work across a mix of pages and pieces","suites":["change-doc-ids"],"updatePoint":{"line":78,"column":63,"index":2193},"line":78,"code":"  it('changeDocIds should work across a mix of pages and pieces', async function () {\n    await sanityCheck();\n    const pages = await apos.page.find(apos.task.getReq(), {}).toArray();\n    const test = pages.find(page => page.slug === '/test');\n    const newPageId = `new-test-page-id:${test.aposLocale}`;\n    const newCategoryId = `new-test-category-id:${categories[0].aposLocale}`;\n    const pairs = [[test._id, newPageId], [categories[0]._id, newCategoryId]];\n    await apos.doc.changeDocIds(pairs);\n    await sanityCheck(newPageId, newCategoryId);\n  });","file":"change-doc-ids.js","skipped":false,"dir":"test"},{"name":"should compose removes","suites":["Command-Menu"],"updatePoint":{"line":28,"column":28,"index":584},"line":28,"code":"  it('should compose removes', function () {\n    const initialState = {\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [{\n        ...moduleD.commands,\n        remove: ['toggle-publish-draft-mode']\n      }], [{\n        remove: ['redo', 'command-menu']\n      }]]\n    };\n    const actual = apos.commandMenu.composeRemoves(initialState);\n    const expected = {\n      ...initialState,\n      removes: ['@apostrophecms/command-menu:test', 'toggle-publish-draft-mode', 'redo', 'command-menu']\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compose removes sequentially","suites":["Command-Menu"],"updatePoint":{"line":44,"column":41,"index":1168},"line":44,"code":"  it('should compose removes sequentially', function () {\n    const initialState = {\n      definitions: [[{\n        add: {\n          '@apostrophecms/command-menu:test': {\n            type: 'item',\n            label: 'commandMenuShortcutTest',\n            action: {\n              type: 'test',\n              payload: {}\n            },\n            shortcut: 'Shift+G'\n          }\n        }\n      }, {\n        remove: ['@apostrophecms/command-menu:test']\n      }], [{\n        add: {\n          '@apostrophecms/command-menu:test': {\n            type: 'item',\n            label: 'commandMenuShortcutTest',\n            action: {\n              type: 'test',\n              payload: {}\n            },\n            shortcut: 'Shift+G'\n          }\n        }\n      }]]\n    };\n    const actual = apos.commandMenu.composeRemoves(initialState);\n    const expected = {\n      ...initialState,\n      removes: []\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compose commands","suites":["Command-Menu"],"updatePoint":{"line":81,"column":29,"index":2101},"line":81,"code":"  it('should compose commands', function () {\n    const initialState = {\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n    };\n    const actual = apos.commandMenu.composeCommands(initialState);\n    const expected = {\n      ...initialState,\n      commands: {\n        '@apostrophecms/command-menu:toggle-shortcuts': {\n          action: {\n            payload: {},\n            type: 'toggle-shortcuts'\n          },\n          label: 'commandMenuShortcutToggleShortcuts',\n          shortcut: '?',\n          type: 'item'\n        },\n        '@apostrophecms/command-menu:test': {\n          type: 'item',\n          label: 'commandMenuShortcutTest',\n          action: {\n            type: 'test',\n            payload: {}\n          },\n          shortcut: 'Shift+G'\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compose groups","suites":["Command-Menu"],"updatePoint":{"line":111,"column":27,"index":2975},"line":111,"code":"  it('should compose groups', function () {\n    const initialState = {\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n    };\n    const actual = apos.commandMenu.composeGroups(initialState);\n    const expected = {\n      ...initialState,\n      groups: {\n        '@apostrophecms/command-menu:general': {\n          label: 'commandMenuGeneral',\n          commands: ['@apostrophecms/command-menu:toggle-shortcuts', 'command-menu']\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compose groups and remove duplicate commands","suites":["Command-Menu"],"updatePoint":{"line":127,"column":57,"index":3554},"line":127,"code":"  it('should compose groups and remove duplicate commands', function () {\n    const initialState = {\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [{\n        add: {\n          '@apostrophecms/command-menu:help': {\n            shortcut: '?'\n          }\n        },\n        group: {\n          '@apostrophecms/command-menu:help': {\n            label: 'commandMenuHelp',\n            commands: ['@apostrophecms/command-menu:toggle-shortcuts', '@apostrophecms/command-menu:help']\n          }\n        }\n      }]]\n    };\n    const actual = apos.commandMenu.composeGroups(initialState);\n    const expected = {\n      ...initialState,\n      groups: {\n        '@apostrophecms/command-menu:general': {\n          label: 'commandMenuGeneral',\n          commands: ['command-menu']\n        },\n        '@apostrophecms/command-menu:help': {\n          label: 'commandMenuHelp',\n          commands: ['@apostrophecms/command-menu:toggle-shortcuts', '@apostrophecms/command-menu:help']\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compose modals","suites":["Command-Menu"],"updatePoint":{"line":159,"column":27,"index":4610},"line":159,"code":"  it('should compose modals', function () {\n    const initialState = {\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [article.commands], [topic.commands]]\n    };\n    const actual = apos.commandMenu.composeModals(initialState);\n    const expected = {\n      ...initialState,\n      modals: {\n        default: {\n          '@apostrophecms/command-menu:content': {\n            label: 'commandMenuContent',\n            commands: ['@apostrophecms/command-menu:undo', '@apostrophecms/command-menu:redo', '@apostrophecms/command-menu:toggle-shortcuts', '@apostrophecms/command-menu:discard-draft', '@apostrophecms/command-menu:publish-draft', '@apostrophecms/command-menu:test']\n          },\n          '@apostrophecms/command-menu:modes': {\n            label: 'commandMenuModes',\n            commands: ['@apostrophecms/command-menu:toggle-edit-preview-mode', '@apostrophecms/command-menu:toggle-publish-draft-mode']\n          }\n        },\n        'article:manager': {\n          '@apostrophecms/command-menu:manager': {\n            label: null,\n            commands: ['article:create-new', 'article:search', 'article:select-all', 'article:archive-selected', 'article:exit-manager']\n          }\n        },\n        'topic:manager': {\n          '@apostrophecms/command-menu:manager': {\n            label: null,\n            commands: ['topic:create-new', 'topic:search', 'topic:select-all', 'topic:archive-selected', 'topic:exit-manager']\n          }\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should validate commands","suites":["Command-Menu"],"updatePoint":{"line":193,"column":30,"index":6174},"line":193,"code":"  it('should validate commands', function () {\n    const initialState = apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n    });\n    const actual = Object.entries(initialState.commands).map(([name, command]) => apos.commandMenu.validateCommand({\n      name,\n      command\n    }));\n    const expected = [[true, null], [true, null]];\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should validate groups","suites":["Command-Menu"],"updatePoint":{"line":204,"column":28,"index":6749},"line":204,"code":"  it('should validate groups', function () {\n    const initialState = apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n    });\n    const actual = Object.entries(initialState.groups).map(([name, group]) => apos.commandMenu.validateGroup({\n      name,\n      group\n    }));\n    const expected = [[true, null]];\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should validate modals","suites":["Command-Menu"],"updatePoint":{"line":215,"column":28,"index":7302},"line":215,"code":"  it('should validate modals', function () {\n    const initialState = apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n    });\n    const actual = Object.entries(initialState.modals).flatMap(([name, modal]) => apos.commandMenu.validateModal({\n      name,\n      modal\n    }));\n    const expected = [[true, null], [true, null]];\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should compile errors","suites":["Command-Menu"],"updatePoint":{"line":226,"column":27,"index":7872},"line":226,"code":"  it('should compile errors', function () {\n    const initialState = apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n      definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [{\n        add: {\n          command1: {}\n        }\n      }], [{\n        group: {\n          groupA: {}\n        }\n      }], [{\n        modal: {\n          modalA: {\n            groupB: {}\n          }\n        }\n      }]]\n    });\n    const result = [].concat(Object.entries(initialState.commands).map(([name, command]) => apos.commandMenu.validateCommand({\n      name,\n      command\n    })), Object.entries(initialState.groups).map(([name, group]) => apos.commandMenu.validateGroup({\n      name,\n      group\n    })), Object.entries(initialState.modals).flatMap(([name, modal]) => apos.commandMenu.validateModal({\n      name,\n      modal\n    })));\n    const actual = () => apos.commandMenu.compileErrors(result);\n    const expected = {\n      name: 'Error',\n      message: 'Invalid',\n      cause: [new assert.AssertionError({\n        message: 'Invalid command type, must be \"item\", for command1',\n        expected: 'item',\n        operator: 'strictEqual'\n      }), new assert.AssertionError({\n        message: 'Invalid group label, must be a string, for groupA \"undefined\" provided',\n        actual: 'undefined',\n        expected: 'string',\n        operator: 'strictEqual'\n      }), new assert.AssertionError({\n        message: 'Invalid group label, must be a string, for modalA:groupB \"undefined\" provided',\n        actual: 'undefined',\n        expected: 'string',\n        operator: 'strictEqual'\n      })]\n    };\n    assert.throws(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should build commands","suites":["Command-Menu"],"updatePoint":{"line":276,"column":27,"index":9640},"line":276,"code":"  it('should build commands', function () {\n    const initialState = {\n      composed: apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n        definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n      })\n    };\n    const actual = apos.commandMenu.buildCommands(initialState);\n    const expected = {\n      ...initialState,\n      commands: {\n        '@apostrophecms/command-menu:toggle-shortcuts': {\n          action: {\n            payload: {},\n            type: 'toggle-shortcuts'\n          },\n          label: 'commandMenuShortcutToggleShortcuts',\n          shortcut: '?',\n          type: 'item'\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should build groups","suites":["Command-Menu"],"updatePoint":{"line":299,"column":25,"index":10447},"line":299,"code":"  it('should build groups', function () {\n    const initialState = {\n      composed: apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n        definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands]]\n      })\n    };\n    const {\n      commands\n    } = apos.commandMenu.buildCommands(initialState);\n    const actual = apos.commandMenu.buildGroups({\n      ...initialState,\n      commands\n    });\n    const expected = {\n      ...initialState,\n      commands,\n      groups: {\n        '@apostrophecms/command-menu:general': {\n          label: 'commandMenuGeneral',\n          commands: {\n            '@apostrophecms/command-menu:toggle-shortcuts': {\n              action: {\n                payload: {},\n                type: 'toggle-shortcuts'\n              },\n              label: 'commandMenuShortcutToggleShortcuts',\n              shortcut: '?',\n              type: 'item'\n            }\n          }\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should build modals","suites":["Command-Menu"],"updatePoint":{"line":334,"column":25,"index":11548},"line":334,"code":"  it('should build modals', function () {\n    const initialState = {\n      composed: apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n        definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [article.commands], [topic.commands]]\n      })\n    };\n    const {\n      commands,\n      groups\n    } = apos.util.pipe(apos.commandMenu.buildCommands, apos.commandMenu.buildGroups)(initialState);\n    const actual = apos.commandMenu.buildModals({\n      ...initialState,\n      commands,\n      groups\n    });\n    const expected = {\n      ...initialState,\n      commands,\n      groups,\n      modals: {\n        default: {\n          '@apostrophecms/command-menu:content': {\n            label: 'commandMenuContent',\n            commands: {\n              '@apostrophecms/command-menu:toggle-shortcuts': {\n                type: 'item',\n                label: 'commandMenuShortcutToggleShortcuts',\n                action: {\n                  type: 'toggle-shortcuts',\n                  payload: {}\n                },\n                shortcut: '?'\n              }\n            }\n          }\n        },\n        'article:manager': {\n          '@apostrophecms/command-menu:manager': {\n            label: null,\n            commands: {\n              'article:create-new': {\n                type: 'item',\n                label: 'apostrophe:commandMenuCreateNew',\n                action: {},\n                shortcut: '',\n                modal: 'article:manager'\n              },\n              'article:search': {\n                type: 'item',\n                label: 'apostrophe:commandMenuSearch',\n                action: {},\n                shortcut: '',\n                modal: 'article:manager'\n              },\n              'article:select-all': {\n                type: 'item',\n                label: 'apostrophe:commandMenuSelectAll',\n                action: {},\n                shortcut: '',\n                modal: 'article:manager'\n              },\n              'article:archive-selected': {\n                type: 'item',\n                label: 'apostrophe:commandMenuArchiveSelected',\n                action: {},\n                shortcut: '',\n                modal: 'article:manager'\n              },\n              'article:exit-manager': {\n                type: 'item',\n                label: 'apostrophe:commandMenuExitManager',\n                action: {},\n                shortcut: '',\n                modal: 'article:manager'\n              }\n            }\n          }\n        },\n        'topic:manager': {\n          '@apostrophecms/command-menu:manager': {\n            label: null,\n            commands: {\n              'topic:create-new': {\n                type: 'item',\n                label: 'apostrophe:commandMenuCreateNew',\n                action: {},\n                shortcut: ''\n              },\n              'topic:search': {\n                type: 'item',\n                label: 'apostrophe:commandMenuSearch',\n                action: {},\n                shortcut: ''\n              },\n              'topic:select-all': {\n                type: 'item',\n                label: 'apostrophe:commandMenuSelectAll',\n                action: {},\n                shortcut: ''\n              },\n              'topic:archive-selected': {\n                type: 'item',\n                label: 'apostrophe:commandMenuArchiveSelected',\n                action: {},\n                shortcut: ''\n              },\n              'topic:exit-manager': {\n                type: 'item',\n                label: 'apostrophe:commandMenuExitManager',\n                action: {},\n                shortcut: ''\n              }\n            }\n          }\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should tell that the command is visible without command permission","suites":["Command-Menu"],"updatePoint":{"line":453,"column":72,"index":15425},"line":453,"code":"  it('should tell that the command is visible without command permission', function () {\n    const req = apos.task.getReq();\n    const command = {\n      type: 'item',\n      label: 'apostrophe:commandMenuCreateNew',\n      action: {},\n      shortcut: 'c'\n    };\n    const actual = apos.commandMenu.isCommandVisible(req, command);\n    const expected = true;\n    assert.equal(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should tell that the command not visible with correct command permission","suites":["Command-Menu"],"updatePoint":{"line":465,"column":78,"index":15828},"line":465,"code":"  it('should tell that the command not visible with correct command permission', function () {\n    const req = apos.task.getReq();\n    const command = {\n      type: 'item',\n      label: 'apostrophe:commandMenuCreateNew',\n      action: {},\n      shortcut: 'c',\n      permission: {\n        action: 'edit',\n        type: '@apostrophecms/page',\n        mode: 'draft'\n      }\n    };\n    const actual = apos.commandMenu.isCommandVisible(req, command);\n    const expected = true;\n    assert.equal(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should tell that the command is not visible with wrong command permission","suites":["Command-Menu"],"updatePoint":{"line":482,"column":79,"index":16344},"line":482,"code":"  it('should tell that the command is not visible with wrong command permission', function () {\n    const req = apos.task.getContributorReq();\n    const command = {\n      type: 'item',\n      label: 'apostrophe:commandMenuCreateNew',\n      action: {},\n      shortcut: 'c',\n      permission: {\n        action: 'edit',\n        type: '@apostrophecms/page',\n        mode: 'published'\n      }\n    };\n    const actual = apos.commandMenu.isCommandVisible(req, command);\n    const expected = false;\n    assert.equal(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should get visible groups","suites":["Command-Menu"],"updatePoint":{"line":499,"column":31,"index":16828},"line":499,"code":"  it('should get visible groups', function () {\n    const initialState = {\n      composed: apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n        definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [article.commands], [topic.commands]]\n      })\n    };\n    const built = apos.util.pipe(apos.commandMenu.buildCommands, apos.commandMenu.buildGroups, apos.commandMenu.buildModals)(initialState);\n    const visibleCommands = ['@apostrophecms/command-menu:toggle-shortcuts'];\n    const actual = apos.commandMenu.getVisibleGroups(visibleCommands, built.groups);\n    const expected = {\n      '@apostrophecms/command-menu:general': {\n        label: 'commandMenuGeneral',\n        commands: {\n          '@apostrophecms/command-menu:toggle-shortcuts': {\n            type: 'item',\n            label: 'commandMenuShortcutToggleShortcuts',\n            action: {\n              type: 'toggle-shortcuts',\n              payload: {}\n            },\n            shortcut: '?'\n          }\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should get visible modals","suites":["Command-Menu"],"updatePoint":{"line":526,"column":31,"index":18008},"line":526,"code":"  it('should get visible modals', function () {\n    const initialState = {\n      composed: apos.util.pipe(apos.commandMenu.composeRemoves, apos.commandMenu.composeCommands, apos.commandMenu.composeGroups, apos.commandMenu.composeModals)({\n        definitions: [[moduleA.commands], [moduleB.commands], [moduleC.commands], [moduleD.commands], [article.commands], [topic.commands]]\n      })\n    };\n    const built = apos.util.pipe(apos.commandMenu.buildCommands, apos.commandMenu.buildGroups, apos.commandMenu.buildModals)(initialState);\n    const visibleCommands = ['article:search', 'article:select-all', 'article:archive-selected', 'article:exit-manager', 'topic:search', 'topic:select-all', 'topic:archive-selected', 'topic:exit-manager'];\n    const actual = apos.commandMenu.getVisibleModals(visibleCommands, built.modals);\n    const expected = {\n      'article:manager': {\n        '@apostrophecms/command-menu:manager': {\n          label: null,\n          commands: {\n            'article:search': {\n              type: 'item',\n              label: 'apostrophe:commandMenuSearch',\n              action: {},\n              shortcut: '',\n              modal: 'article:manager'\n            },\n            'article:select-all': {\n              type: 'item',\n              label: 'apostrophe:commandMenuSelectAll',\n              action: {},\n              shortcut: '',\n              modal: 'article:manager'\n            },\n            'article:archive-selected': {\n              type: 'item',\n              label: 'apostrophe:commandMenuArchiveSelected',\n              action: {},\n              shortcut: '',\n              modal: 'article:manager'\n            },\n            'article:exit-manager': {\n              type: 'item',\n              label: 'apostrophe:commandMenuExitManager',\n              action: {},\n              shortcut: '',\n              modal: 'article:manager'\n            }\n          }\n        }\n      },\n      'topic:manager': {\n        '@apostrophecms/command-menu:manager': {\n          label: null,\n          commands: {\n            'topic:search': {\n              type: 'item',\n              label: 'apostrophe:commandMenuSearch',\n              action: {},\n              shortcut: ''\n            },\n            'topic:select-all': {\n              type: 'item',\n              label: 'apostrophe:commandMenuSelectAll',\n              action: {},\n              shortcut: ''\n            },\n            'topic:archive-selected': {\n              type: 'item',\n              label: 'apostrophe:commandMenuArchiveSelected',\n              action: {},\n              shortcut: ''\n            },\n            'topic:exit-manager': {\n              type: 'item',\n              label: 'apostrophe:commandMenuExitManager',\n              action: {},\n              shortcut: ''\n            }\n          }\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should detect a single shortcut conflict","suites":["Command-Menu"],"updatePoint":{"line":605,"column":46,"index":20898},"line":605,"code":"  it('should detect a single shortcut conflict', () => {\n    const shortcuts = {\n      modal: {\n        '@apostrophecms/file:manager': ['C']\n      },\n      list: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new']\n        }\n      },\n      conflict: {}\n    };\n    const actual = apos.commandMenu.detectShortcutConflict({\n      shortcuts,\n      shortcut: 'C',\n      modal: '@apostrophecms/file:manager',\n      moduleName: '@apostrophecms/file:search'\n    });\n    const expected = {\n      modal: {\n        '@apostrophecms/file:manager': ['C']\n      },\n      list: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new', '@apostrophecms/file:search']\n        }\n      },\n      conflict: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new', '@apostrophecms/file:search']\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should detect multiple shortcut conflicts","suites":["Command-Menu"],"updatePoint":{"line":640,"column":47,"index":21847},"line":640,"code":"  it('should detect multiple shortcut conflicts', () => {\n    const shortcuts = {\n      modal: {\n        '@apostrophecms/file:manager': ['C']\n      },\n      list: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new', '@apostrophecms/file:search']\n        }\n      },\n      conflict: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new']\n        }\n      }\n    };\n    const actual = apos.commandMenu.detectShortcutConflict({\n      shortcuts,\n      shortcut: 'C',\n      modal: '@apostrophecms/file:manager',\n      moduleName: '@apostrophecms/file:select-all'\n    });\n    const expected = {\n      modal: {\n        '@apostrophecms/file:manager': ['C']\n      },\n      list: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new', '@apostrophecms/file:search', '@apostrophecms/file:select-all']\n        }\n      },\n      conflict: {\n        '@apostrophecms/file:manager': {\n          C: ['@apostrophecms/file:create-new', '@apostrophecms/file:search', '@apostrophecms/file:select-all']\n        }\n      }\n    };\n    assert.deepEqual(actual, expected);\n  });","file":"command-menu.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Concurrent Array Joins"],"updatePoint":{"line":15,"column":45,"index":327},"line":15,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'test-person': {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'person'\n          },\n          fields: {\n            add: {\n              hobbies: {\n                type: 'array',\n                fields: {\n                  add: {\n                    name: {\n                      type: 'string'\n                    },\n                    _friends: {\n                      type: 'relationship',\n                      withType: 'test-person'\n                      // builders: {\n                      //   project: {\n                      //     title: 1\n                      //   }\n                      // }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n  });","file":"concurrent-array-relationships.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve hobbies in parallel with all relationships","suites":["Concurrent Array Joins"],"updatePoint":{"line":52,"column":75,"index":1284},"line":52,"code":"  it('should be able to retrieve hobbies in parallel with all relationships', async function () {\n    const req = apos.task.getReq();\n    const hobbyists = [];\n    for (let i = 0; i < 10; i++) {\n      hobbyists.push(await apos.person.insert(req, {\n        title: `Hobbyist ${i}`,\n        visibility: 'public'\n      }));\n    }\n    for (let i = 0; i < 10; i++) {\n      await apos.person.update(req, {\n        ...hobbyists[i],\n        hobbies: [{\n          name: `Hobby ${i}`,\n          _friends: [\n          // Deep clone to avoid infinite recursion during the save operation\n          // as 4 points to 5 and vice versa\n          klona(hobbyists[9 - i])]\n        }]\n      });\n    }\n    const promises = [];\n    for (let i = 0; i < 100; i++) {\n      const req = apos.task.getReq();\n      promises.push(apos.person.find(req).toArray());\n    }\n    const results = await Promise.all(promises);\n    assert.strictEqual(results.length, 100);\n    for (const result of results) {\n      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare\n      result.sort((a, b) => a.title.localeCompare(b.title));\n      assert.strictEqual(result.length, 10);\n      for (let i = 0; i < 10; i++) {\n        const person = result[i];\n        assert.strictEqual(person.title, `Hobbyist ${i}`);\n        assert.strictEqual(person.hobbies.length, 1);\n        assert.strictEqual(person.hobbies[0].name, `Hobby ${i}`);\n        assert(person.hobbies[0]._friends);\n        assert(person.hobbies[0]._friends[0]);\n        assert.strictEqual(person.hobbies[0]._friends[0].title, `Hobbyist ${9 - i}`);\n      }\n    }\n  });","file":"concurrent-array-relationships.js","skipped":false,"dir":"test"},{"name":"should replicate key docs across locales at startup","suites":["Locales"],"updatePoint":{"line":57,"column":57,"index":1253},"line":57,"code":"  it('should replicate key docs across locales at startup', async function () {\n    apos = await t.create(config);\n    const homes = await apos.doc.db.find({\n      parkedId: 'home'\n    }).toArray();\n    // Draft and published\n    assert(homes.length === 8);\n    const archives = await apos.doc.db.find({\n      parkedId: 'archive'\n    }).toArray();\n    assert(archives.length === 8);\n    // Make sure all archive docs have the archived property set `true`\n    assert(!archives.find(archive => !archive.archived));\n    const globals = await apos.doc.db.find({\n      type: '@apostrophecms/global'\n    }).toArray();\n    assert(globals.length === 8);\n    const people = await apos.doc.db.find({\n      parkedId: 'people'\n    }).toArray();\n    assert(people.length === 8);\n    // People page in fr-CA has expected parked properties\n    const req = apos.task.getReq();\n    const peoplePageEn = await apos.page.find(req, {\n      parkedId: 'people'\n    }).toObject();\n    const frCAReq = apos.task.getReq({\n      locale: 'fr-CA'\n    });\n    let peoplePageFrCA = await apos.page.find(frCAReq, {\n      parkedId: 'people'\n    }).toObject();\n    assert(peoplePageEn.aposDocId === peoplePageFrCA.aposDocId);\n    assert(peoplePageEn.aposLocale === 'en:published');\n    assert(peoplePageFrCA.aposLocale === 'fr-CA:published');\n    assert(peoplePageEn.title === 'People');\n    assert(peoplePageFrCA.title === 'People');\n    peoplePageFrCA.title = 'Altered';\n    await apos.page.update(frCAReq, peoplePageFrCA);\n    peoplePageFrCA = await apos.page.find(frCAReq, {\n      parkedId: 'people'\n    }).toObject();\n    assert(peoplePageFrCA.title === 'Altered');\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"should not replicate redundantly on a second startup in same db, but should repark parked properties","suites":["Locales"],"updatePoint":{"line":102,"column":106,"index":2958},"line":102,"code":"  it('should not replicate redundantly on a second startup in same db, but should repark parked properties', async function () {\n    const apos2 = await t.create({\n      ...config,\n      shortName: apos.options.shortName\n    });\n    const homes = await apos2.doc.db.find({\n      parkedId: 'home'\n    }).toArray();\n    // Draft and published\n    assert(homes.length === 8);\n    home = homes.find(home => home.aposLocale === 'en:published');\n    const people = await apos2.doc.db.find({\n      parkedId: 'people'\n    }).toArray();\n    assert(people.length === 8);\n    const archives = await apos2.doc.db.find({\n      parkedId: 'archive'\n    }).toArray();\n    assert(archives.length === 8);\n    const globals = await apos2.doc.db.find({\n      type: '@apostrophecms/global'\n    }).toArray();\n    assert(globals.length === 8);\n    const frCAReq = apos2.task.getReq({\n      locale: 'fr-CA'\n    });\n    const peoplePageFrCA = await apos2.page.find(frCAReq, {\n      parkedId: 'people'\n    }).toObject();\n    // Restored to parked value\n    assert(peoplePageFrCA.title === 'People');\n    await apos2.destroy();\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"should have just one locale for a newly inserted draft page","suites":["Locales"],"updatePoint":{"line":136,"column":65,"index":4042},"line":136,"code":"  it('should have just one locale for a newly inserted draft page', async function () {\n    const req = apos.task.getReq({\n      mode: 'draft'\n    });\n    child = await apos.page.insert(req, '_home', 'lastChild', {\n      title: 'Child Page',\n      type: 'default-page'\n    });\n    const versions = await apos.doc.db.find({\n      aposDocId: child.aposDocId\n    }).toArray();\n    assert(versions.length === 1);\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"should be able to insert test user","suites":["Locales"],"updatePoint":{"line":149,"column":40,"index":4432},"line":149,"code":"  it('should be able to insert test user', async function () {\n    const user = apos.user.newInstance();\n    user.title = 'admin';\n    user.username = 'admin';\n    user.password = 'admin';\n    user.email = 'ad@min.com';\n    user.role = 'admin';\n    return apos.user.insert(apos.task.getReq(), user);\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"REST: should be able to log in as admin","suites":["Locales"],"updatePoint":{"line":158,"column":45,"index":4743},"line":158,"code":"  it('REST: should be able to log in as admin', async function () {\n    jar = apos.http.jar();\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n    assert(page.includes(`<a href=\"/api/v1/@apostrophecms/page/${home._id}/locale/en-CA\">Canadian English (en-CA)</a>`));\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"localize API should succeed","suites":["Locales"],"updatePoint":{"line":174,"column":33,"index":5235},"line":174,"code":"  it('localize API should succeed', async function () {\n    return apos.http.post(`/api/v1/@apostrophecms/page/${child._id}/localize`, {\n      body: {\n        toLocale: 'en-CA'\n      },\n      jar\n    });\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"after localizing child page should exist in 2 locales","suites":["Locales"],"updatePoint":{"line":182,"column":59,"index":5471},"line":182,"code":"  it('after localizing child page should exist in 2 locales', async function () {\n    const versions = await apos.doc.db.find({\n      aposDocId: child.aposDocId\n    }).toArray();\n    assert(versions.length === 2);\n    assert(!versions.find(version => version.title !== 'Child Page'));\n    const reqEn = apos.task.getReq({\n      locale: 'en',\n      mode: 'draft'\n    });\n    const en = await apos.doc.find(reqEn, {\n      slug: '/child-page'\n    }).toObject();\n    assert(en);\n    assert.strictEqual(en._url, 'http://localhost:3000/child-page');\n    await apos.page.publish(reqEn, en);\n    const reqEnCA = apos.task.getReq({\n      locale: 'en-CA',\n      mode: 'draft'\n    });\n    const enCA = await apos.doc.find(reqEnCA, {\n      slug: '/child-page'\n    }).toObject();\n    assert(enCA);\n    assert.strictEqual(enCA._url, 'http://localhost:3000/ca-en/child-page');\n    // Distinguish the content in this locale\n    enCA.title = 'Child Page, Toronto Style';\n    assert(apos.page.update(reqEnCA, enCA));\n    // Not published yet\n    try {\n      await apos.http.get('/ca-en/child-page', {});\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n    await apos.page.publish(reqEnCA, enCA);\n    // Now it should work\n    const childPage = await apos.http.get('/ca-en/child-page', {});\n    assert(childPage.includes('<title>Child Page, Toronto Style</title>'));\n    // Navigation links are localized\n    assert(childPage.includes('\"http://localhost:3000/ca-en/\">Home: /'));\n    assert(childPage.includes('\"http://localhost:3000/ca-en/child-page\">Tab: /child-page'));\n    // Locale-switching links are present for locales that are available\n    // and fall back to home page for locales that are not\n    const childPageId = enCA._id.replace(':draft', ':published');\n    assert(childPage.includes(`\"/api/v1/@apostrophecms/page/${childPageId}/locale/en\">English (en)</a></li>`));\n    assert(childPage.includes(`\"/api/v1/@apostrophecms/page/${childPageId}/locale/en-CA\">Canadian English (en-CA)</a></li>`));\n    assert(childPage.includes('\"http://localhost:3000/ca-fr/\">Canadian French (fr-CA)</a></li>'));\n    assert(childPage.includes('\"http://example.mx/\">Mexico (es-MX)</a></li>'));\n\n    // And the home page should be reachable\n    const home = await apos.http.get('/ca-en/');\n    assert(home);\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"Mexico locale should be received when hostname is correct","suites":["Locales"],"updatePoint":{"line":236,"column":63,"index":7792},"line":236,"code":"  it('Mexico locale should be received when hostname is correct', async function () {\n    const reqEsMX = apos.task.getReq({\n      locale: 'es-MX',\n      mode: 'draft'\n    });\n    let esMX = await apos.doc.find(reqEsMX, {\n      slug: '/'\n    }).toObject();\n    assert(esMX);\n    assert.strictEqual(esMX._url, 'http://example.mx/');\n    // Distinguish the content in this locale\n    esMX.title = 'Pagina De Inicio';\n    esMX = await apos.page.update(reqEsMX, esMX);\n    await apos.page.publish(reqEsMX, esMX);\n    // Without hostname, we default to English\n    const homePage = await apos.http.get('/', {});\n    assert(homePage.includes('<title>Home</title>'));\n    const homePageEsMX = await apos.http.get('/', {\n      headers: {\n        'X-Forwarded-Host': 'example.mx'\n      }\n    });\n    assert(homePageEsMX.includes('<title>Pagina De Inicio</title>'));\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"localize API should not succeed a second time without the update flag","suites":["Locales"],"updatePoint":{"line":260,"column":75,"index":8667},"line":260,"code":"  it('localize API should not succeed a second time without the update flag', async function () {\n    try {\n      await apos.http.post(`/api/v1/@apostrophecms/page/${child._id}/localize`, {\n        body: {\n          toLocale: 'en-CA'\n        },\n        jar\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 409);\n    }\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"localize API should succeed a second time with the update flag","suites":["Locales"],"updatePoint":{"line":273,"column":68,"index":9010},"line":273,"code":"  it('localize API should succeed a second time with the update flag', async function () {\n    return apos.http.post(`/api/v1/@apostrophecms/page/${child._id}/localize`, {\n      body: {\n        toLocale: 'en-CA',\n        update: true\n      },\n      jar\n    });\n  });","file":"content-i18n.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Db"],"updatePoint":{"line":10,"column":37,"index":276},"line":10,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.db);\n    // Verify a normal, boring connection to localhost without the db option worked\n    const doc = await apos.doc.db.findOne();\n    assert(doc);\n  });","file":"db.js","skipped":false,"dir":"test"},{"name":"should be able to launch a second instance reusing the connection","suites":["Db"],"updatePoint":{"line":19,"column":71,"index":598},"line":19,"code":"  it('should be able to launch a second instance reusing the connection', async function () {\n    // Often takes too long otherwise\n    this.timeout(10000);\n    apos2 = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/db': {\n          options: {\n            client: apos.dbClient,\n            uri: 'mongodb://this-will-not-work-unless-db-successfully-overrides-it/fail'\n          }\n        }\n      }\n    });\n    const doc = await apos2.doc.db.findOne();\n    assert(doc);\n  });","file":"db.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Docs"],"updatePoint":{"line":13,"column":45,"index":292},"line":13,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'test-people': {\n          extend: '@apostrophecms/piece-type',\n          fields: {\n            add: {\n              _friends: {\n                type: 'relationship',\n                max: 1,\n                withType: 'test-people',\n                label: 'Friends'\n              }\n            }\n          }\n        },\n        '@apostrophecms/page': {\n          options: {\n            park: [],\n            types: [{\n              name: 'test-page',\n              label: 'Test Page'\n            }]\n          }\n        },\n        'test-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    assert(apos.doc);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should have a db property","suites":["Docs"],"updatePoint":{"line":46,"column":31,"index":1061},"line":46,"code":"  it('should have a db property', function () {\n    assert(apos.doc.db);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should make sure all of the expected indexes are configured","suites":["Docs"],"updatePoint":{"line":54,"column":65,"index":1207},"line":54,"code":"  it('should make sure all of the expected indexes are configured', async function () {\n    const expectedIndexes = ['type', 'slug', 'titleSortified'];\n    const actualIndexes = [];\n    const info = await apos.doc.db.indexInformation();\n    // Extract the actual index info we care about.\n    _.forEach(info, function (index) {\n      actualIndexes.push(index[0][0]);\n    });\n\n    // Now make sure everything in expectedIndexes is in actualIndexes.\n    _.forEach(expectedIndexes, function (index) {\n      assert(_.includes(actualIndexes, index));\n    });\n\n    // Lastly, make sure there is a text index present\n    assert(info.highSearchText_text_lowSearchText_text_title_text_searchBoost_text[0][1] === 'text');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should make sure there is no test data hanging around from last time","suites":["Docs"],"updatePoint":{"line":71,"column":74,"index":1934},"line":71,"code":"  it('should make sure there is no test data hanging around from last time', async function () {\n    // Attempt to purge the entire aposDocs collection\n    await apos.doc.db.deleteMany({});\n\n    // Make sure it went away\n    const docs = await apos.doc.db.find({\n      slug: 'larry'\n    }).toArray();\n    assert(docs.length === 0);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to use db to insert documents","suites":["Docs"],"updatePoint":{"line":81,"column":50,"index":2248},"line":81,"code":"  it('should be able to use db to insert documents', async function () {\n    const testItems = [{\n      _id: 'lori:en:published',\n      aposDocId: 'lori',\n      aposLocale: 'en:published',\n      slug: 'lori',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Lori',\n      lastName: 'Pizzaroni',\n      age: 32,\n      alive: true\n    }, {\n      _id: 'larry:en:published',\n      aposDocId: 'larry',\n      aposLocale: 'en:published',\n      slug: 'larry',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Larry',\n      lastName: 'Cherber',\n      age: 28,\n      alive: true\n    }, {\n      _id: 'carl:en:published',\n      aposDocId: 'carl',\n      aposLocale: 'en:published',\n      slug: 'carl',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Carl',\n      lastName: 'Sagan',\n      age: 62,\n      alive: false,\n      friendsIds: ['larry']\n    }];\n    const response = await apos.doc.db.insertMany(testItems);\n    assert(response.result.ok === 1);\n    assert(response.insertedCount === 3);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to fetch schema relationships","suites":["Docs"],"updatePoint":{"line":121,"column":50,"index":3307},"line":121,"code":"  it('should be able to fetch schema relationships', async function () {\n    const manager = apos.doc.getManager('test-people');\n    const req = apos.task.getAnonReq();\n    assert(manager);\n    assert(manager.find);\n    assert(manager.schema);\n    const cursor = await manager.find(req, {\n      slug: 'carl'\n    });\n    assert(cursor);\n    const person = await cursor.toObject();\n    assert(person);\n    assert(person.slug === 'carl');\n    assert(person._friends);\n    assert(person._friends[0].slug === 'larry');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should support custom context menu (required only)","suites":["Docs"],"updatePoint":{"line":137,"column":56,"index":3833},"line":137,"code":"  it('should support custom context menu (required only)', async function () {\n    const operation = {\n      context: 'update',\n      action: 'test',\n      label: 'Menu Label',\n      modal: 'SomeModalComponent'\n    };\n    const initialLength = apos.doc.contextOperations.length;\n    apos.doc.addContextOperation('test-people', operation);\n    assert.strictEqual(apos.doc.contextOperations.length, initialLength + 1);\n    assert.deepStrictEqual(apos.doc.contextOperations.find(op => op.action === 'test'), {\n      ...operation,\n      moduleName: 'test-people'\n    });\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should support custom context menu (with optional)","suites":["Docs"],"updatePoint":{"line":152,"column":56,"index":4406},"line":152,"code":"  it('should support custom context menu (with optional)', async function () {\n    apos.doc.contextOperations = [];\n    const operation = {\n      context: 'update',\n      action: 'test',\n      label: 'Menu Label',\n      modal: 'SomeModalComponent',\n      manuallyPublished: true,\n      modifiers: ['danger']\n    };\n    assert.strictEqual(apos.doc.contextOperations.length, 0);\n    apos.doc.addContextOperation('test-people', operation);\n    assert.strictEqual(apos.doc.contextOperations.length, 1);\n    assert.deepStrictEqual(apos.doc.contextOperations[0], {\n      ...operation,\n      moduleName: 'test-people'\n    });\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should override custom context menu","suites":["Docs"],"updatePoint":{"line":170,"column":41,"index":5016},"line":170,"code":"  it('should override custom context menu', async function () {\n    apos.doc.contextOperations = [];\n    const operation1 = {\n      context: 'update',\n      action: 'test',\n      label: 'Op1',\n      modal: 'SomeModalComponent'\n    };\n    const operation2 = {\n      context: 'update',\n      action: 'test',\n      label: 'Op2',\n      modal: 'SomeModalComponent'\n    };\n    assert.strictEqual(apos.doc.contextOperations.length, 0);\n    apos.doc.addContextOperation('test-people', operation1);\n    apos.doc.addContextOperation('test-people', operation2);\n    assert.strictEqual(apos.doc.contextOperations.length, 1);\n    assert.deepStrictEqual(apos.doc.contextOperations[0], {\n      ...operation2,\n      moduleName: 'test-people'\n    });\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should fail if you try to insert a document with the same unique key twice","suites":["Docs"],"updatePoint":{"line":198,"column":80,"index":5833},"line":198,"code":"  it('should fail if you try to insert a document with the same unique key twice', async function () {\n    try {\n      await apos.doc.db.insertMany([{\n        _id: 'peter:en:published',\n        aposDocId: 'peter',\n        aposLocale: 'en:published',\n        type: 'test-people',\n        visibility: 'loginRequired',\n        age: 70,\n        slug: 'peter'\n      },\n      // ids will not conflict, but slug will\n      {\n        _id: 'peter2:en:published',\n        aposDocId: 'peter2',\n        aposLocale: 'en:published',\n        type: 'test-people',\n        visibility: 'loginRequired',\n        age: 70,\n        slug: 'peter'\n      }]);\n      assert(false);\n    } catch (e) {\n      assert(e);\n      assert(e.code === 11000);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should have a find method on docs that returns a query","suites":["Docs"],"updatePoint":{"line":230,"column":60,"index":6583},"line":230,"code":"  it('should have a find method on docs that returns a query', function () {\n    const query = apos.doc.find(apos.task.getAnonReq());\n    assert(query);\n    assert(query.toArray);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to find all test documents and output them as an array","suites":["Docs"],"updatePoint":{"line":235,"column":75,"index":6784},"line":235,"code":"  it('should be able to find all test documents and output them as an array', async function () {\n    const cursor = apos.doc.find(apos.task.getAnonReq(), {\n      type: 'test-people'\n    });\n    const docs = await cursor.toArray();\n\n    // There should be only 3 results.\n    assert(docs.length === 3);\n    // They should all have a type of test-people\n    assert(docs[0].type === 'test-people');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to specify which fields to get by passing a projection object","suites":["Docs"],"updatePoint":{"line":251,"column":82,"index":7233},"line":251,"code":"  it('should be able to specify which fields to get by passing a projection object', async function () {\n    const cursor = apos.doc.find(apos.task.getAnonReq(), {\n      type: 'test-people'\n    }, {\n      project: {\n        age: 1\n      }\n    });\n    const docs = await cursor.toArray();\n\n    // There SHOULD be an age\n    assert(docs[0].age);\n    // There SHOULD NOT be a firstName\n    assert(!docs[0].firstName);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to sort","suites":["Docs"],"updatePoint":{"line":271,"column":28,"index":7635},"line":271,"code":"  it('should be able to sort', async function () {\n    const cursor = apos.doc.find(apos.task.getAnonReq(), {\n      type: 'test-people'\n    }).sort({\n      age: 1\n    });\n    const docs = await cursor.toArray();\n    assert(docs[0].slug === 'larry');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to sort by multiple keys","suites":["Docs"],"updatePoint":{"line":280,"column":45,"index":7908},"line":280,"code":"  it('should be able to sort by multiple keys', async function () {\n    const cursor = apos.doc.find(apos.task.getAnonReq(), {\n      type: 'test-people'\n    }).sort({\n      firstName: 1,\n      age: 1\n    });\n    const docs = await cursor.toArray();\n    assert(docs[0].slug === 'carl');\n    assert(docs[1].slug === 'larry');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should have an \"insert\" method that returns a new database object","suites":["Docs"],"updatePoint":{"line":296,"column":71,"index":8301},"line":296,"code":"  it('should have an \"insert\" method that returns a new database object', async function () {\n    const object = {\n      slug: 'one',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Lori',\n      lastName: 'Ferber',\n      age: 15,\n      alive: true\n    };\n    const response = await apos.doc.insert(apos.task.getReq(), object);\n    assert(response);\n    assert(response._id);\n    assert(response._id.endsWith(':en:published'));\n    assert(response._id === `${response.aposDocId}:${response.aposLocale}`);\n    // Direct insertion in published locale should autocreate\n    // a corresponding draft for internal consistency\n    const draft = await apos.doc.db.findOne({\n      _id: `${response.aposDocId}:en:draft`\n    });\n    assert(draft);\n    // Unique index allows for duplicates across locales\n    assert(object.slug === draft.slug);\n    // Content properties coming through\n    assert(draft.firstName === response.firstName);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to insert a new object into the docs collection in the database","suites":["Docs"],"updatePoint":{"line":322,"column":84,"index":9272},"line":322,"code":"  it('should be able to insert a new object into the docs collection in the database', async function () {\n    const cursor = apos.doc.find(apos.task.getReq(), {\n      type: 'test-people',\n      slug: 'one'\n    });\n    const docs = await cursor.toArray();\n    assert(docs[0].slug === 'one');\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should append the slug property with a numeral if inserting an object whose slug already exists in the database","suites":["Docs"],"updatePoint":{"line":330,"column":117,"index":9603},"line":330,"code":"  it('should append the slug property with a numeral if inserting an object whose slug already exists in the database', async function () {\n    const object = {\n      slug: 'one',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Harry',\n      lastName: 'Gerber',\n      age: 29,\n      alive: true\n    };\n    const doc = await apos.doc.insert(apos.task.getReq(), object);\n    assert(doc);\n    assert(doc.slug.match(/^one\\d+$/));\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should add the aposDocId to the related documents' relatedReverseIds field and update their `cacheInvalidatedAt` field","suites":["Docs"],"updatePoint":{"line":344,"column":125,"index":10068},"line":344,"code":"  it('should add the aposDocId to the related documents\\' relatedReverseIds field and update their `cacheInvalidatedAt` field', async function () {\n    const object = {\n      aposDocId: 'paul',\n      aposLocale: 'en:published',\n      slug: 'paul',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Paul',\n      lastName: 'McCartney',\n      age: 24,\n      alive: false,\n      friendsIds: ['carl', 'larry'],\n      _friends: [{\n        _id: 'carl:en:published'\n      }, {\n        _id: 'larry:en:published'\n      }]\n    };\n    const response = await apos.doc.insert(apos.task.getReq(), object);\n    const carlDoc = await apos.doc.db.findOne({\n      slug: 'carl',\n      aposLocale: 'en:published'\n    });\n    const larryDoc = await apos.doc.db.findOne({\n      slug: 'larry',\n      aposLocale: 'en:published'\n    });\n    assert(carlDoc.relatedReverseIds.length === 1);\n    assert(carlDoc.relatedReverseIds[0] === 'paul');\n    assert(carlDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n    assert(larryDoc.relatedReverseIds.length === 1);\n    assert(larryDoc.relatedReverseIds[0] === 'paul');\n    assert(larryDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not allow you to call the insert method if you are not an admin","suites":["Docs"],"updatePoint":{"line":378,"column":76,"index":11238},"line":378,"code":"  it('should not allow you to call the insert method if you are not an admin', async function () {\n    const object = {\n      slug: 'not-for-you',\n      visibility: 'loginRequired',\n      type: 'test-people',\n      firstName: 'Darry',\n      lastName: 'Derrber',\n      age: 5,\n      alive: true\n    };\n    try {\n      await apos.doc.insert(apos.task.getAnonReq(), object);\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should have an \"update\" method on docs that updates an existing database object","suites":["Docs"],"updatePoint":{"line":400,"column":85,"index":11723},"line":400,"code":"  it('should have an \"update\" method on docs that updates an existing database object', async function () {\n    const req = apos.task.getReq();\n    const docs = await apos.doc.find(req, {\n      slug: 'one'\n    }).toArray();\n\n    // We should have one document in our results.\n    assert(docs);\n    assert(docs.length === 1);\n\n    // Grab the object and update the `alive` property.\n    const object = docs[0];\n    object.alive = false;\n    const updated = await apos.doc.update(apos.task.getReq(), object);\n\n    // Has the property been updated?\n    assert(updated);\n    assert(updated.alive === false);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should append an updated slug with a numeral if the updated slug already exists","suites":["Docs"],"updatePoint":{"line":419,"column":85,"index":12333},"line":419,"code":"  it('should append an updated slug with a numeral if the updated slug already exists', async function () {\n    const req = apos.task.getReq();\n    const cursor = apos.doc.find(req, {\n      type: 'test-people',\n      slug: 'one'\n    });\n    const doc = await cursor.toObject();\n    assert(doc);\n    doc.slug = 'peter';\n    const updated = await apos.doc.update(req, doc);\n    assert(updated);\n    // Has the updated slug been appended?\n    assert(updated.slug.match(/^peter\\d+$/));\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to fetch all unique firstNames with toDistinct","suites":["Docs"],"updatePoint":{"line":433,"column":67,"index":12803},"line":433,"code":"  it('should be able to fetch all unique firstNames with toDistinct', async function () {\n    const firstNames = await apos.doc.find(apos.task.getReq(), {\n      type: 'test-people'\n    }).toDistinct('firstName');\n    assert(Array.isArray(firstNames));\n    assert(firstNames.length === 5);\n    assert(_.includes(firstNames, 'Larry'));\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to fetch all unique firstNames and their counts with toDistinct and distinctCounts","suites":["Docs"],"updatePoint":{"line":441,"column":103,"index":13179},"line":441,"code":"  it('should be able to fetch all unique firstNames and their counts with toDistinct and distinctCounts', async function () {\n    const req = apos.task.getReq();\n    const cursor = apos.doc.find(req, {\n      type: 'test-people'\n    }).distinctCounts(true);\n    const firstNames = await cursor.toDistinct('firstName');\n    assert(Array.isArray(firstNames));\n    assert(firstNames.length === 5);\n    assert(_.includes(firstNames, 'Larry'));\n    const counts = await cursor.get('distinctCounts');\n    assert(counts.Larry === 1);\n    assert(counts.Lori === 2);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should remove the aposDocId from the related documents' relatedReverseIds field and update their `cacheInvalidatedAt` field","suites":["Docs"],"updatePoint":{"line":454,"column":130,"index":13769},"line":454,"code":"  it('should remove the aposDocId from the related documents\\' relatedReverseIds field and update their `cacheInvalidatedAt` field', async function () {\n    const paulDoc = await apos.doc.db.findOne({\n      slug: 'paul',\n      aposLocale: 'en:published'\n    });\n\n    // carl removed from paul's related friends, only larry remains\n    const object = {\n      ...paulDoc,\n      friendsIds: ['larry'],\n      _friends: [{\n        _id: 'larry:en:published'\n      }]\n    };\n    const response = await apos.doc.update(apos.task.getReq(), object);\n    const carlDoc = await apos.doc.db.findOne({\n      slug: 'carl',\n      aposLocale: 'en:published'\n    });\n    const larryDoc = await apos.doc.db.findOne({\n      slug: 'larry',\n      aposLocale: 'en:published'\n    });\n    assert(carlDoc.relatedReverseIds.length === 0);\n    assert(carlDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n    assert(larryDoc.relatedReverseIds.length === 1);\n    assert(larryDoc.relatedReverseIds[0] === 'paul');\n    assert(larryDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should update the related reverse documents' `cacheInvalidatedAt` field","suites":["Docs"],"updatePoint":{"line":483,"column":78,"index":14809},"line":483,"code":"  it('should update the related reverse documents\\' `cacheInvalidatedAt` field', async function () {\n    const object = {\n      aposDocId: 'john',\n      aposLocale: 'en:published',\n      slug: 'john',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'John',\n      lastName: 'McClane',\n      age: 40,\n      alive: true,\n      friendsIds: ['carl'],\n      _friends: [{\n        _id: 'carl:en:published'\n      }]\n    };\n    await apos.doc.insert(apos.task.getReq(), object);\n    const carlDoc = await apos.doc.db.findOne({\n      slug: 'carl',\n      aposLocale: 'en:published'\n    });\n\n    // update carl, now john (related reverse friend) should have its `cacheInvalidatedAt` field updated as well\n    const response = await apos.doc.update(apos.task.getReq(), {\n      ...carlDoc,\n      alive: false\n    });\n    const johnDoc = await apos.doc.db.findOne({\n      slug: 'john',\n      aposLocale: 'en:published'\n    });\n    assert(johnDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should update the pieces parent page's `cacheInvalidatedAt` field","suites":["Docs"],"updatePoint":{"line":516,"column":72,"index":15827},"line":516,"code":"  it('should update the pieces parent page\\'s `cacheInvalidatedAt` field', async function () {\n    const page = {\n      slug: '/parent/new-page',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'New Page'\n    };\n    const object = {\n      aposDocId: 'bruce',\n      aposLocale: 'en:published',\n      slug: 'bruce',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Bruce',\n      lastName: 'Lee',\n      age: 30,\n      alive: false,\n      _parentSlug: '/parent/new-page'\n    };\n    await apos.doc.insert(apos.task.getReq(), page);\n    const response = await apos.doc.insert(apos.task.getReq(), object);\n    const pageDoc = await apos.doc.db.findOne({\n      slug: '/parent/new-page',\n      aposLocale: 'en:published'\n    });\n    assert(pageDoc.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not allow you to call the update method if you are not an admin","suites":["Docs"],"updatePoint":{"line":543,"column":76,"index":16682},"line":543,"code":"  it('should not allow you to call the update method if you are not an admin', async function () {\n    const cursor = apos.doc.find(apos.task.getAnonReq(), {\n      type: 'test-people',\n      slug: 'lori'\n    });\n    const doc = cursor.toObject();\n    assert(doc);\n    doc.slug = 'laurie';\n    try {\n      await apos.doc.update(apos.task.getAnonReq(), doc);\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should archive docs by updating them","suites":["Docs"],"updatePoint":{"line":563,"column":42,"index":17108},"line":563,"code":"  it('should archive docs by updating them', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.find(req, {\n      type: 'test-people',\n      slug: 'carl'\n    }).toObject();\n    const archived = await apos.doc.update(req, {\n      ...doc,\n      archived: true\n    });\n    assert(archived.archived === true);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not be able to find the archived object","suites":["Docs"],"updatePoint":{"line":575,"column":52,"index":17466},"line":575,"code":"  it('should not be able to find the archived object', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.find(req, {\n      slug: 'carl'\n    }).toObject();\n    assert(!doc);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not allow you to call the archive method if you are not an admin","suites":["Docs"],"updatePoint":{"line":582,"column":77,"index":17707},"line":582,"code":"  it('should not allow you to call the archive method if you are not an admin', async function () {\n    try {\n      await apos.doc.archived(apos.task.getAnonReq(), {\n        slug: 'lori'\n      });\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to find the archived object when using the \"archived\" method on find()","suites":["Docs"],"updatePoint":{"line":592,"column":91,"index":17986},"line":592,"code":"  it('should be able to find the archived object when using the \"archived\" method on find()', async function () {\n    // Look for the archived doc with the `deduplicate-` + its `_id` + its `name` properties.\n    const doc = await apos.doc.find(apos.task.getReq(), {\n      slug: 'deduplicate-carl-carl'\n    }).archived(true).toObject();\n    assert(doc);\n    assert(doc.archived);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should rescue a doc by updating the \"archived\" property from an object","suites":["Docs"],"updatePoint":{"line":605,"column":76,"index":18390},"line":605,"code":"  it('should rescue a doc by updating the \"archived\" property from an object', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.find(req, {\n      slug: 'deduplicate-carl-carl'\n    }).archived(null).toObject();\n    await apos.doc.update(req, {\n      ...doc,\n      archived: false\n    });\n    const newDoc = await apos.doc.find(req, {\n      slug: 'carl'\n    }).toObject();\n\n    // We should have a document.\n    assert(newDoc);\n    assert(newDoc.slug === 'carl');\n    assert(newDoc.archived === false);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not allow you to call the restore method if you are not an admin","suites":["Docs"],"updatePoint":{"line":623,"column":77,"index":18936},"line":623,"code":"  it('should not allow you to call the restore method if you are not an admin', async function () {\n    try {\n      await apos.doc.restore(apos.task.getAnonReq(), {\n        slug: 'carl'\n      });\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should throw an exception on find() if you fail to pass req as the first argument","suites":["Docs"],"updatePoint":{"line":633,"column":87,"index":19210},"line":633,"code":"  it('should throw an exception on find() if you fail to pass req as the first argument', async function () {\n    try {\n      await apos.doc.find({\n        slug: 'larry'\n      });\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should respect _ids()","suites":["Docs"],"updatePoint":{"line":643,"column":27,"index":19398},"line":643,"code":"  it('should respect _ids()', async function () {\n    const testItems = [];\n    let i;\n    for (i = 0; i < 100; i++) {\n      testItems.push({\n        _id: `i${i}:en:published`,\n        aposDocId: `i${i}`,\n        aposLocale: 'en:published',\n        slug: `i${i}`,\n        visibility: 'public',\n        type: 'test',\n        title: 'title: ' + i\n      });\n    }\n    await apos.doc.db.insertMany(testItems);\n    const docs = await apos.doc.find(apos.task.getAnonReq(), {})._ids(['i7:en:published', 'i3:en:published', 'i27:en:published', 'i9:en:published']).toArray();\n    assert(docs[0]._id === 'i7:en:published');\n    assert(docs[0].aposDocId === 'i7');\n    assert(docs[0].aposLocale === 'en:published');\n    assert(docs[1]._id === 'i3:en:published');\n    assert(docs[2]._id === 'i27:en:published');\n    assert(docs[3]._id === 'i9:en:published');\n    assert(!docs[4]);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should respect _ids with skip and limit","suites":["Docs"],"updatePoint":{"line":667,"column":45,"index":20290},"line":667,"code":"  it('should respect _ids with skip and limit', async function () {\n    // Relies on test data of previous test\n    const docs = await apos.doc.find(apos.task.getAnonReq(), {})._ids(['i7:en:published', 'i3:en:published', 'i27:en:published', 'i9:en:published']).skip(2).limit(2).toArray();\n    assert(docs[0]._id === 'i27:en:published');\n    assert(docs[1]._id === 'i9:en:published');\n    assert(!docs[2]);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to lock a document","suites":["Docs"],"updatePoint":{"line":674,"column":39,"index":20696},"line":674,"code":"  it('should be able to lock a document', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.lock(req, doc, 'abc');\n    } catch (e) {\n      assert(!e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not be able to lock a document with a different tabId","suites":["Docs"],"updatePoint":{"line":685,"column":66,"index":21005},"line":685,"code":"  it('should not be able to lock a document with a different tabId', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.lock(req, doc, 'def');\n    } catch (e) {\n      assert(e);\n      assert(e.name === 'locked');\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to refresh the lock with the same tabId","suites":["Docs"],"updatePoint":{"line":697,"column":60,"index":21342},"line":697,"code":"  it('should be able to refresh the lock with the same tabId', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.lock(req, doc, 'abc');\n    } catch (e) {\n      assert(!e);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to unlock a document","suites":["Docs"],"updatePoint":{"line":708,"column":41,"index":21626},"line":708,"code":"  it('should be able to unlock a document', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.unlock(req, doc, 'abc');\n    } catch (e) {\n      assert(false);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to re-lock an unlocked document","suites":["Docs"],"updatePoint":{"line":719,"column":52,"index":21926},"line":719,"code":"  it('should be able to re-lock an unlocked document', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.lock(req, doc, 'def');\n    } catch (e) {\n      assert(false);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to lock a locked document with force: true","suites":["Docs"],"updatePoint":{"line":730,"column":63,"index":22235},"line":730,"code":"  it('should be able to lock a locked document with force: true', async function () {\n    const req = apos.task.getReq();\n    const doc = await apos.doc.db.findOne({\n      _id: 'i27:en:published'\n    });\n    try {\n      await apos.doc.lock(req, doc, 'abc', {\n        force: true\n      });\n    } catch (e) {\n      assert(false);\n    }\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should be able to recover if the text index weights are mysteriously wrong at startup","suites":["Docs"],"updatePoint":{"line":743,"column":91,"index":22603},"line":743,"code":"  it('should be able to recover if the text index weights are mysteriously wrong at startup', async function () {\n    await apos.doc.db.dropIndex('highSearchText_text_lowSearchText_text_title_text_searchBoost_text');\n    await apos.doc.db.createIndex({\n      highSearchText: 'text',\n      lowSearchText: 'text',\n      title: 'text',\n      searchBoost: 'text'\n    }, {\n      default_language: 'none',\n      weights: {\n        // These are the weird weights we've seen when this\n        // mystery bug crops up, flunking createIndex on a\n        // later startup\n        title: 1,\n        searchBoost: 1,\n        highSearchText: 1,\n        lowSearchText: 1\n      }\n    });\n    await apos.doc.createTextIndex();\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should add via a migration the `cacheInvalidatedAt` field to any doc and set it to equal the doc's `updatedAt` field","suites":["Docs"],"updatePoint":{"line":769,"column":123,"index":23388},"line":769,"code":"  it('should add via a migration the `cacheInvalidatedAt` field to any doc and set it to equal the doc\\'s `updatedAt` field', async function () {\n    const objects = [{\n      slug: 'test-for-cacheInvalidatedAt-field-migration1',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Kurt',\n      lastName: 'Cobain',\n      age: 27,\n      alive: false,\n      updatedAt: '2022-03-28T12:57:03.685Z'\n    }, {\n      slug: 'test-for-cacheInvalidatedAt-field-migration2',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Jim',\n      lastName: 'Morrison',\n      age: 27,\n      alive: false,\n      updatedAt: '2020-08-29T12:57:03.685Z'\n    }];\n    await apos.doc.db.insertMany(objects);\n    await apos.doc.setCacheField();\n    const docs = await apos.doc.db.find({\n      slug: /test-for-cacheInvalidatedAt-field-migration/\n    }).toArray();\n    docs.forEach((doc, index) => {\n      const timestamps = {\n        doc: new Date(doc.cacheInvalidatedAt).toString(),\n        expected: new Date(objects[index].updatedAt).toString()\n      };\n      assert(timestamps.doc === timestamps.expected);\n    });\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should not add via a migration the `cacheInvalidatedAt` field to docs that already have it","suites":["Docs"],"updatePoint":{"line":802,"column":96,"index":24496},"line":802,"code":"  it('should not add via a migration the `cacheInvalidatedAt` field to docs that already have it', async function () {\n    const object = {\n      slug: 'test-for-cacheInvalidatedAt-field-migration3',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Janis',\n      lastName: 'Joplin',\n      age: 27,\n      alive: false,\n      updatedAt: '2018-08-29T12:57:03.685Z',\n      cacheInvalidatedAt: '2019-08-29T12:57:03.685Z'\n    };\n    await apos.doc.db.insert(object);\n    await apos.doc.setCacheField();\n    const doc = await apos.doc.db.findOne({\n      slug: 'test-for-cacheInvalidatedAt-field-migration3'\n    });\n    const timestamps = {\n      doc: new Date(doc.cacheInvalidatedAt).toString(),\n      expected: new Date(object.cacheInvalidatedAt).toString()\n    };\n    assert(timestamps.doc === timestamps.expected);\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should add a `cacheInvalidatedAt` field and set it to equal `updatedAt` field when saving a doc","suites":["Docs"],"updatePoint":{"line":830,"column":101,"index":25377},"line":830,"code":"  it('should add a `cacheInvalidatedAt` field and set it to equal `updatedAt` field when saving a doc', async function () {\n    const object = {\n      slug: 'test-for-cacheInvalidatedAt-field',\n      visibility: 'public',\n      type: 'test-people',\n      firstName: 'Michael',\n      lastName: 'Jackson',\n      age: 64,\n      alive: true\n    };\n    const response = await apos.doc.insert(apos.task.getReq(), object);\n    const draft = await apos.doc.db.findOne({\n      _id: `${response.aposDocId}:en:draft`\n    });\n    assert(response.cacheInvalidatedAt.getTime() === response.updatedAt.getTime());\n    assert(draft.cacheInvalidatedAt.getTime() === draft.updatedAt.getTime());\n  });","file":"docs.js","skipped":false,"dir":"test"},{"name":"should initialize with a schema","suites":["Draft / Published"],"updatePoint":{"line":14,"column":37,"index":294},"line":14,"code":"  it('should initialize with a schema', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [],\n            types: [{\n              name: '@apostrophecms/home-page',\n              label: 'Home'\n            }, {\n              name: 'test-page',\n              label: 'Test Page'\n            }]\n          }\n        },\n        'test-page': {\n          extend: '@apostrophecms/page-type'\n        },\n        product: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'product'\n          },\n          fields: {\n            add: {\n              body: {\n                type: 'area',\n                options: {\n                  widgets: {\n                    '@apostrophecms/rich-text': {},\n                    '@apostrophecms/image': {}\n                  }\n                }\n              },\n              color: {\n                type: 'select',\n                choices: [{\n                  label: 'Red',\n                  value: 'red'\n                }, {\n                  label: 'Blue',\n                  value: 'blue'\n                }]\n              },\n              photo: {\n                type: 'attachment',\n                group: 'images'\n              },\n              addresses: {\n                type: 'array',\n                fields: {\n                  add: {\n                    street: {\n                      type: 'string'\n                    }\n                  }\n                }\n              },\n              _articles: {\n                type: 'relationship',\n                withType: 'article',\n                builders: {\n                  project: {\n                    _url: 1,\n                    title: 1\n                  }\n                },\n                fields: {\n                  add: {\n                    relevance: {\n                      // Explains the relevance of the article to the\n                      // product in 1 sentence\n                      type: 'string'\n                    }\n                  }\n                }\n              }\n            }\n          }\n        },\n        article: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'article'\n          },\n          fields: {\n            add: {\n              name: {\n                type: 'string'\n              }\n            }\n          }\n        }\n      }\n    });\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to create and insert a draft product","suites":["Draft / Published"],"updatePoint":{"line":112,"column":57,"index":2798},"line":112,"code":"  it('should be able to create and insert a draft product', async function () {\n    const product = apos.product.newInstance();\n    product.title = 'Test Product';\n    testDraftProduct = await apos.product.insert(apos.task.getReq({\n      mode: 'draft'\n    }), product);\n    assert(testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published should not exist yet","suites":["Draft / Published"],"updatePoint":{"line":120,"column":36,"index":3092},"line":120,"code":"  it('published should not exist yet', async function () {\n    assert(!(await apos.doc.db.findOne({\n      _id: testDraftProduct._id.replace(':draft', ':published')\n    })));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the product","suites":["Draft / Published"],"updatePoint":{"line":125,"column":43,"index":3279},"line":125,"code":"  it('should be able to publish the product', async function () {\n    await apos.product.publish(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published product should exist and be the same","suites":["Draft / Published"],"updatePoint":{"line":130,"column":52,"index":3457},"line":130,"code":"  it('published product should exist and be the same', async function () {\n    const product = await apos.product.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      _id: testDraftProduct._id.replace(':draft', ':published')\n    }).toObject();\n    assert(product);\n    assert(product.aposDocId === testDraftProduct.aposDocId);\n    assert(product.aposLocale === 'en:published');\n    assert(product.title === testDraftProduct.title);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original product should no longer be modified","suites":["Draft / Published"],"updatePoint":{"line":141,"column":51,"index":3905},"line":141,"code":"  it('original product should no longer be modified', async function () {\n    testDraftProduct = await apos.product.find(apos.task.getReq({\n      mode: 'draft'\n    }), {\n      _id: testDraftProduct._id\n    }).toObject();\n    assert(testDraftProduct);\n    assert(!testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original product still shows as unmodified if we update it with no changes","suites":["Draft / Published"],"updatePoint":{"line":150,"column":80,"index":4231},"line":150,"code":"  it('original product still shows as unmodified if we update it with no changes', async function () {\n    testDraftProduct = await apos.product.update(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(!testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original product shows as modified if we make a change to it","suites":["Draft / Published"],"updatePoint":{"line":156,"column":66,"index":4481},"line":156,"code":"  it('original product shows as modified if we make a change to it', async function () {\n    testDraftProduct.title = 'Another Title';\n    testDraftProduct = await apos.product.update(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the draft to published","suites":["Draft / Published"],"updatePoint":{"line":163,"column":39,"index":4749},"line":163,"code":"  it('can revert the draft to published', async function () {\n    testDraftProduct = await apos.product.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(testDraftProduct);\n    assert(!testDraftProduct.modified);\n    assert(testDraftProduct.title === 'Test Product');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"cannot revert the draft again","suites":["Draft / Published"],"updatePoint":{"line":171,"column":35,"index":5069},"line":171,"code":"  it('cannot revert the draft again', async function () {\n    assert(!(await apos.product.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct)));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original product shows as modified if we make another change to it","suites":["Draft / Published"],"updatePoint":{"line":176,"column":72,"index":5293},"line":176,"code":"  it('original product shows as modified if we make another change to it', async function () {\n    testDraftProduct.title = 'Title 3';\n    testDraftProduct = await apos.product.update(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the product again","suites":["Draft / Published"],"updatePoint":{"line":183,"column":49,"index":5565},"line":183,"code":"  it('should be able to publish the product again', async function () {\n    await apos.product.publish(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"\"previous published\" should be deduplicated at this point, and previous have the right props","suites":["Draft / Published"],"updatePoint":{"line":188,"column":98,"index":5789},"line":188,"code":"  it('\"previous published\" should be deduplicated at this point, and previous have the right props', async function () {\n    const previous = await apos.doc.db.findOne({\n      _id: testDraftProduct._id.replace(':draft', ':previous')\n    });\n    assert(previous);\n    assert(previous.aposMode === 'previous');\n    assert.strictEqual(previous.slug, `deduplicate-${previous.aposDocId}-test-product`);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original product shows as modified if we make a third change to it","suites":["Draft / Published"],"updatePoint":{"line":196,"column":72,"index":6167},"line":196,"code":"  it('original product shows as modified if we make a third change to it', async function () {\n    testDraftProduct.title = 'Title 4';\n    testDraftProduct = await apos.product.update(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the draft to Title 3","suites":["Draft / Published"],"updatePoint":{"line":203,"column":37,"index":6427},"line":203,"code":"  it('can revert the draft to Title 3', async function () {\n    testDraftProduct = await apos.product.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), testDraftProduct);\n    assert(testDraftProduct);\n    assert(!testDraftProduct.modified);\n    assert(testDraftProduct.title === 'Title 3');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the published version to Test Product (previous publication)","suites":["Draft / Published"],"updatePoint":{"line":211,"column":77,"index":6784},"line":211,"code":"  it('can revert the published version to Test Product (previous publication)', async function () {\n    const req = apos.task.getReq({\n      mode: 'published'\n    });\n    let published = await apos.product.findOneForEditing(req, {\n      aposDocId: testDraftProduct.aposDocId\n    });\n    assert(published && published.aposLocale === 'en:published');\n    published = await apos.product.revertPublishedToPrevious(req, published);\n    assert(published);\n    // Make sure the slug is no longer deduplicated\n    assert(published.slug === 'test-product');\n    assert(published.title === 'Test Product');\n    testDraftProduct = await apos.product.findOneForEditing(req.clone({\n      mode: 'draft'\n    }), {\n      _id: testDraftProduct._id\n    });\n    assert(testDraftProduct);\n    assert(testDraftProduct.title === 'Title 3');\n    assert(testDraftProduct.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"cannot revert published to previous again","suites":["Draft / Published"],"updatePoint":{"line":233,"column":47,"index":7618},"line":233,"code":"  it('cannot revert published to previous again', async function () {\n    const req = apos.task.getReq({\n      mode: 'published'\n    });\n    const published = await apos.product.findOneForEditing(req, {\n      aposDocId: testDraftProduct.aposDocId\n    });\n    try {\n      await apos.product.revertPublishedToPrevious(apos.task.getReq({\n        mode: 'draft'\n      }), published);\n      assert(false);\n    } catch (e) {\n      assert(e.name === 'invalid');\n    }\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to create and insert a draft page","suites":["Draft / Published"],"updatePoint":{"line":250,"column":54,"index":8105},"line":250,"code":"  it('should be able to create and insert a draft page', async function () {\n    parent = {\n      type: 'test-page',\n      title: 'Parent',\n      slug: '/parent'\n    };\n    const req = apos.task.getReq({\n      mode: 'draft'\n    });\n    parent = await apos.page.insert(req, '_home', 'lastChild', parent);\n    const home = await apos.page.find(req, {\n      slug: '/',\n      level: 0\n    }).toObject();\n    assert.strictEqual(parent.path, `${home.path}/${parent.aposDocId}`);\n    assert(parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published should not exist yet again","suites":["Draft / Published"],"updatePoint":{"line":267,"column":42,"index":8601},"line":267,"code":"  it('published should not exist yet again', async function () {\n    assert(!(await apos.doc.db.findOne({\n      _id: parent._id.replace(':draft', ':published')\n    })));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the page","suites":["Draft / Published"],"updatePoint":{"line":272,"column":40,"index":8775},"line":272,"code":"  it('should be able to publish the page', async function () {\n    await apos.page.publish(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published page should exist and be the same","suites":["Draft / Published"],"updatePoint":{"line":277,"column":49,"index":8937},"line":277,"code":"  it('published page should exist and be the same', async function () {\n    const publishedParent = await apos.page.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      _id: parent._id.replace(':draft', ':published')\n    }).toObject();\n    assert(publishedParent);\n    assert(publishedParent.aposDocId === parent.aposDocId);\n    assert(publishedParent.aposLocale === 'en:published');\n    assert(publishedParent.title === parent.title);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original page should no longer be modified","suites":["Draft / Published"],"updatePoint":{"line":288,"column":48,"index":9389},"line":288,"code":"  it('original page should no longer be modified', async function () {\n    parent = await apos.page.find(apos.task.getReq({\n      mode: 'draft'\n    }), {\n      _id: parent._id\n    }).toObject();\n    assert(parent);\n    assert(!parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original page still shows as unmodified if we update it with no changes","suites":["Draft / Published"],"updatePoint":{"line":297,"column":77,"index":9669},"line":297,"code":"  it('original page still shows as unmodified if we update it with no changes', async function () {\n    parent = await apos.page.update(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(!parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original page shows as modified if we make a change to it","suites":["Draft / Published"],"updatePoint":{"line":303,"column":63,"index":9883},"line":303,"code":"  it('original page shows as modified if we make a change to it', async function () {\n    parent.title = 'Parent Title 2';\n    parent = await apos.page.update(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the page draft to published","suites":["Draft / Published"],"updatePoint":{"line":310,"column":44,"index":10114},"line":310,"code":"  it('can revert the page draft to published', async function () {\n    parent = await apos.page.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(parent);\n    assert(!parent.modified);\n    assert(parent.title === 'Parent');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"cannot revert the draft again (2)","suites":["Draft / Published"],"updatePoint":{"line":318,"column":39,"index":10379},"line":318,"code":"  it('cannot revert the draft again (2)', async function () {\n    assert(!(await apos.page.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), parent)));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original page shows as modified if we make another change to it","suites":["Draft / Published"],"updatePoint":{"line":327,"column":69,"index":10731},"line":327,"code":"  it('original page shows as modified if we make another change to it', async function () {\n    parent.title = 'Parent Title 3';\n    parent = await apos.page.update(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the page again","suites":["Draft / Published"],"updatePoint":{"line":334,"column":46,"index":10964},"line":334,"code":"  it('should be able to publish the page again', async function () {\n    await apos.page.publish(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"original page shows as modified if we make a third change to it","suites":["Draft / Published"],"updatePoint":{"line":339,"column":69,"index":11146},"line":339,"code":"  it('original page shows as modified if we make a third change to it', async function () {\n    parent.title = 'Parent Title 4';\n    parent = await apos.page.update(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the draft to parent Title 3","suites":["Draft / Published"],"updatePoint":{"line":346,"column":44,"index":11377},"line":346,"code":"  it('can revert the draft to parent Title 3', async function () {\n    parent = await apos.page.revertDraftToPublished(apos.task.getReq({\n      mode: 'draft'\n    }), parent);\n    assert(parent);\n    assert(!parent.modified);\n    assert(parent.title === 'Parent Title 3');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"can revert the published version to previous","suites":["Draft / Published"],"updatePoint":{"line":354,"column":50,"index":11661},"line":354,"code":"  it('can revert the published version to previous', async function () {\n    const req = apos.task.getReq({\n      mode: 'published'\n    });\n    let published = await apos.page.findOneForEditing(req, {\n      aposDocId: parent.aposDocId\n    });\n    assert(published && published.aposLocale === 'en:published');\n    published = await apos.page.revertPublishedToPrevious(apos.task.getReq({\n      mode: 'draft'\n    }), published);\n    assert(published);\n    assert(published.title === 'Parent');\n    parent = await apos.page.findOneForEditing(req.clone({\n      mode: 'draft'\n    }), {\n      _id: parent._id\n    });\n    assert(parent);\n    assert(parent.title === 'Parent Title 3');\n    assert(parent.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"cannot revert published to previous again (2)","suites":["Draft / Published"],"updatePoint":{"line":376,"column":51,"index":12374},"line":376,"code":"  it('cannot revert published to previous again (2)', async function () {\n    const req = apos.task.getReq({\n      mode: 'published'\n    });\n    const published = await apos.page.findOneForEditing(req, {\n      aposDocId: parent.aposDocId\n    });\n    try {\n      await apos.page.revertPublishedToPrevious(apos.task.getReq({\n        mode: 'draft'\n      }), published);\n      assert(false);\n    } catch (e) {\n      assert(e.name === 'invalid');\n    }\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to create and insert a sibling draft page","suites":["Draft / Published"],"updatePoint":{"line":393,"column":62,"index":12854},"line":393,"code":"  it('should be able to create and insert a sibling draft page', async function () {\n    sibling = {\n      type: 'test-page',\n      title: 'Sibling',\n      slug: '/sibling'\n    };\n    sibling = await apos.page.insert(apos.task.getReq({\n      mode: 'draft'\n    }), '_home', 'lastChild', sibling);\n    assert(sibling.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the sibling page","suites":["Draft / Published"],"updatePoint":{"line":404,"column":48,"index":13172},"line":404,"code":"  it('should be able to publish the sibling page', async function () {\n    await apos.page.publish(apos.task.getReq({\n      mode: 'draft'\n    }), sibling);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to create and insert a grandchild page","suites":["Draft / Published"],"updatePoint":{"line":410,"column":59,"index":13363},"line":410,"code":"  it('should be able to create and insert a grandchild page', async function () {\n    grandchild = {\n      type: 'test-page',\n      title: 'Grandchild',\n      // At insert time, a good slug is up to the caller\n      slug: '/parent/grandchild'\n    };\n    grandchild = await apos.page.insert(apos.task.getReq({\n      mode: 'draft'\n    }), parent._id, 'lastChild', grandchild);\n    assert(grandchild.modified);\n    assert.strictEqual(grandchild.path, `${parent.path}/${grandchild.aposDocId}`);\n    assert.strictEqual(grandchild.slug, '/parent/grandchild');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published grandchild should not exist yet","suites":["Draft / Published"],"updatePoint":{"line":424,"column":47,"index":13911},"line":424,"code":"  it('published grandchild should not exist yet', async function () {\n    assert(!(await apos.page.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      aposDocId: grandchild.aposDocId\n    }).toObject()));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the grandchild page","suites":["Draft / Published"],"updatePoint":{"line":431,"column":51,"index":14137},"line":431,"code":"  it('should be able to publish the grandchild page', async function () {\n    await apos.page.publish(apos.task.getReq({\n      mode: 'draft'\n    }), grandchild);\n    const published = await apos.page.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      aposDocId: grandchild.aposDocId\n    }).toObject();\n    assert(published);\n    assert.strictEqual(published.aposMode, 'published');\n    assert.strictEqual(published.path, `${parent.path}/${grandchild.aposDocId}`);\n    assert.strictEqual(published.slug, '/parent/grandchild');\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to move the grandchild page beneath the sibling page","suites":["Draft / Published"],"updatePoint":{"line":445,"column":73,"index":14704},"line":445,"code":"  it('should be able to move the grandchild page beneath the sibling page', async function () {\n    grandchild = await apos.page.find(apos.task.getReq({\n      mode: 'draft'\n    }), {\n      _id: grandchild._id\n    }).toObject();\n    // Should not be modified to start\n    assert(!grandchild.modified);\n    await apos.page.move(apos.task.getReq({\n      mode: 'draft'\n    }), grandchild._id, sibling._id, 'lastChild');\n    sibling = await apos.page.find(apos.task.getReq({\n      mode: 'draft'\n    }), {\n      _id: sibling._id\n    }).children(true).toObject();\n    assert(sibling && sibling._children && sibling._children[0] && sibling._children[0]._id === grandchild._id);\n    grandchild = await apos.page.find(apos.task.getReq({\n      mode: 'draft'\n    }), {\n      _id: grandchild._id\n    }).toObject();\n    // Should be considered modified because we moved it\n    assert(!grandchild.modified);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published grandchild page should now also be beneath the sibling page","suites":["Draft / Published"],"updatePoint":{"line":470,"column":75,"index":15605},"line":470,"code":"  it('published grandchild page should now also be beneath the sibling page', async function () {\n    sibling = await apos.page.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      aposDocId: sibling.aposDocId\n    }).children(true).toObject();\n    assert(sibling && sibling._children && sibling._children[0] && sibling._children[0].aposDocId === grandchild.aposDocId);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be able to publish the grandchild page again to re-execute the move in the published locale","suites":["Draft / Published"],"updatePoint":{"line":478,"column":104,"index":16020},"line":478,"code":"  it('should be able to publish the grandchild page again to re-execute the move in the published locale', async function () {\n    await apos.page.publish(apos.task.getReq({\n      mode: 'draft'\n    }), grandchild);\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"published grandchild page should now be beneath sibling page","suites":["Draft / Published"],"updatePoint":{"line":483,"column":66,"index":16203},"line":483,"code":"  it('published grandchild page should now be beneath sibling page', async function () {\n    const siblingPublished = await apos.page.find(apos.task.getReq({\n      mode: 'published'\n    }), {\n      aposDocId: sibling.aposDocId\n    }).children(true).toObject();\n    assert(siblingPublished && siblingPublished._children && siblingPublished._children[0] && siblingPublished._children[0]._id === grandchild._id.replace(':draft', ':published'));\n  });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should remove the published and previous versions of a page","suites":["Draft / Published","unpublish","page"],"updatePoint":{"line":544,"column":69,"index":18170},"line":544,"code":"      it('should remove the published and previous versions of a page', function () {\n        assert(published === null);\n        assert(previous === null);\n      });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should update the draft version of a page","suites":["Draft / Published","unpublish","page"],"updatePoint":{"line":548,"column":51,"index":18319},"line":548,"code":"      it('should update the draft version of a page', function () {\n        assert(draft._id === draftItem._id);\n        assert(draft.modified === true);\n        assert(draft.lastPublishedAt === null);\n      });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should not unpublish parked pages","suites":["Draft / Published","unpublish","parked page"],"updatePoint":{"line":555,"column":43,"index":18573},"line":555,"code":"      it('should not unpublish parked pages', async function () {\n        const baseItem = {\n          aposDocId: 'some-parked-page',\n          type: 'test-page',\n          slug: '/some-parked-page',\n          visibility: 'public',\n          path: '/some-parked-page',\n          level: 1,\n          rank: 0,\n          parked: 1\n        };\n        const draftItem = {\n          ...baseItem,\n          _id: 'some-parked-page:en:draft',\n          aposLocale: 'en:draft'\n        };\n        const publishedItem = {\n          ...baseItem,\n          _id: 'some-parked-page:en:published',\n          aposLocale: 'en:published'\n        };\n        await apos.doc.db.insertMany([draftItem, publishedItem]);\n        const res = await apos.doc.db.findOne({\n          _id: 'some-parked-page:en:published'\n        });\n        const req = apos.task.getReq({\n          mode: 'published'\n        });\n        try {\n          await apos.page.unpublish(req, res);\n        } catch (error) {\n          assert(error.message === 'apostrophe:pageIsParkedAndCannotBeUnpublished');\n          return;\n        }\n        throw new Error('unpublish should have thrown');\n      });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should remove the published and previous versions of a piece","suites":["Draft / Published","unpublish","piece"],"updatePoint":{"line":638,"column":70,"index":21112},"line":638,"code":"      it('should remove the published and previous versions of a piece', function () {\n        assert(published === null);\n        assert(previous === null);\n      });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should update the draft version of a piece","suites":["Draft / Published","unpublish","piece"],"updatePoint":{"line":642,"column":52,"index":21262},"line":642,"code":"      it('should update the draft version of a piece', function () {\n        assert(draft._id === draftItem._id);\n        assert(draft.modified === true);\n        assert(draft.lastPublishedAt === null);\n      });","file":"draft-published.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Email"],"updatePoint":{"line":9,"column":45,"index":260},"line":9,"code":"  it('should be a property of the apos object', async function () {\n    this.timeout(t.timeout);\n    this.slow(2000);\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/email': {\n          options: {\n            nodemailer: {\n              streamTransport: true,\n              buffer: true,\n              newline: 'unix'\n            }\n          }\n        },\n        'email-test': {}\n      }\n    });\n    assert(apos.modules['@apostrophecms/email']);\n  });","file":"email.js","skipped":false,"dir":"test"},{"name":"can send email on behalf of a module","suites":["Email"],"updatePoint":{"line":29,"column":42,"index":750},"line":29,"code":"  it('can send email on behalf of a module', async function () {\n    const info = await apos.modules['email-test'].email(apos.task.getReq(), 'welcome', {\n      name: 'Fred Astaire'\n    }, {\n      from: 'test@example.com',\n      to: 'recipient@example.com',\n      subject: 'Welcome Aboard'\n    });\n    assert(info);\n    const message = info.message.toString();\n    assert(message.match(/Fred Astaire/));\n    assert(message.match(/Subject: Welcome Aboard/));\n    assert(message.match(/From: test@example\\.com/));\n    assert(message.match(/To: recipient@example\\.com/));\n    assert(message.match(/\\[http:\\/\\/example\\.com\\/\\]/));\n  });","file":"email.js","skipped":false,"dir":"test"},{"name":"should convert html to text","suites":["Email"],"updatePoint":{"line":45,"column":33,"index":1373},"line":45,"code":"  it('should convert html to text', async function () {\n    await t.destroy(apos);\n    apos = await t.create({\n      root: module\n    });\n    const mockEmail = require('./data/fpw_email_mock.js');\n    const mockTransport = () => ({\n      sendMail: function (args) {\n        return Promise.resolve(args);\n      }\n    });\n    const mockModule = {\n      options: {\n        email: {\n          from: mockEmail.from\n        }\n      },\n      render: async () => mockEmail.html\n    };\n    apos.modules['@apostrophecms/email'].getTransport = mockTransport;\n    const result = await apos.modules['@apostrophecms/email'].emailForModule(apos.task.getReq(),\n    // req\n    'anyTemplate',\n    // templateName\n    {},\n    // data\n    {\n      to: mockEmail.to,\n      subject: mockEmail.subject\n    },\n    // options\n    mockModule // module\n    );\n\n    assert.equal(result.text, mockEmail.text);\n  });","file":"email.js","skipped":false,"dir":"test"},{"name":"should execute handlers for several events in the proper order","suites":["Promisified Events Core"],"updatePoint":{"line":12,"column":68,"index":380},"line":12,"code":"  it('should execute handlers for several events in the proper order', async function () {\n    let niceFinished = false;\n    apos = await t.create({\n      root: module,\n      modules: {\n        test1: {\n          options: {\n            alias: 'test1'\n          },\n          handlers(self) {\n            return {\n              ready1: {\n                async ready1AddA(context) {\n                  await Promise.delay(100);\n                  assert(!context.b);\n                  context.a = true;\n                }\n              },\n              ready2: {\n                async ready2AddB(context) {\n                  assert(context.a);\n                  context.b = true;\n                },\n                async ready2AddC(context) {\n                  await Promise.delay(10);\n                  assert(context.a);\n                  assert(context.b);\n                  context.c = true;\n                }\n              },\n              ready3: {\n                async ready3HeyNice() {\n                  await Promise.delay(100);\n                  niceFinished = true;\n                }\n              },\n              'apostrophe:modulesRegistered': {\n                async testHandlers() {\n                  const context = {};\n                  await self.emit('ready1', context);\n                  assert(context.a);\n                  await self.emit('ready2', context);\n                  assert(context.a);\n                  assert(context.b);\n                  assert(context.c);\n                  await self.emit('ready3');\n                  assert(context.a);\n                  assert(context.b);\n                  assert(context.c);\n                  assert(context.d);\n                  assert(niceFinished);\n                }\n              },\n              // Verify legacy event name aliases still work\n              'apostrophe:modulesReady': {\n                async stillFires() {\n                  modulesReadyStillFires = true;\n                }\n              },\n              'apostrophe:afterInit': {\n                async stillFires() {\n                  afterInitStillFires = true;\n                }\n              }\n            };\n          }\n        },\n        test2: {\n          options: {\n            alias: 'test2'\n          },\n          handlers(self) {\n            return {\n              'test1:ready1': {\n                ready1SetD(context) {\n                  context.d = true;\n                }\n              }\n            };\n          }\n        },\n        test3: {\n          options: {\n            alias: 'test3'\n          }\n        }\n      }\n    });\n    assert(niceFinished);\n    assert(modulesReadyStillFires);\n    assert(afterInitStillFires);\n  });","file":"events.js","skipped":false,"dir":"test"},{"name":"should implement @apostrophecms/doc-type:beforeInsert handlers properly","suites":["Promisified Events: @apostrophecms/doc-type:beforeInsert"],"updatePoint":{"line":11,"column":77,"index":395},"line":11,"code":"  it('should implement @apostrophecms/doc-type:beforeInsert handlers properly', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        test1: {\n          options: {\n            alias: 'test1'\n          },\n          handlers(self) {\n            return {\n              '@apostrophecms/doc-type:beforeInsert': {\n                async beforeInsertReverseTitle(req, doc, options) {\n                  if (doc.type === 'default-page') {\n                    await Promise.delay(50);\n                    doc.title = doc.title.split('').reverse().join('');\n                  }\n                }\n              },\n              'apostrophe:modulesRegistered': {\n                modulesReadyCoreEventsWork() {\n                  coreEventsWork = true;\n                }\n              }\n            };\n          }\n        },\n        'default-page': {},\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              type: 'default-page',\n              findMeAgain: true,\n              title: 'Test',\n              slug: '/test',\n              visibility: 'public',\n              parkedId: 'test'\n            }]\n          }\n        }\n      }\n    });\n  });","file":"events2.js","skipped":false,"dir":"test"},{"name":"should find the results","suites":["Promisified Events: @apostrophecms/doc-type:beforeInsert"],"updatePoint":{"line":53,"column":29,"index":1551},"line":53,"code":"  it('should find the results', async function () {\n    const doc = await apos.doc.db.findOne({\n      findMeAgain: true\n    });\n    assert(doc);\n    assert.strictEqual(doc.title, 'tseT');\n    assert(coreEventsWork);\n  });","file":"events2.js","skipped":false,"dir":"test"},{"name":"express should exist on the apos object","suites":["Express"],"updatePoint":{"line":7,"column":45,"index":202},"line":7,"code":"  it('express should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'express-test': {},\n        'template-test': {},\n        'template-subclass-test': {}\n      }\n    });\n    assert(apos.express);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"app should exist on the apos object","suites":["Express"],"updatePoint":{"line":18,"column":41,"index":473},"line":18,"code":"  it('app should exist on the apos object', function () {\n    assert(apos.app);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"baseApp should exist on the apos object","suites":["Express"],"updatePoint":{"line":21,"column":45,"index":563},"line":21,"code":"  it('baseApp should exist on the apos object', function () {\n    assert(apos.baseApp);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"app and baseApp should be the same in the absence of a prefix","suites":["Express"],"updatePoint":{"line":24,"column":67,"index":679},"line":24,"code":"  it('app and baseApp should be the same in the absence of a prefix', function () {\n    assert(apos.baseApp === apos.app);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should successfully make a GET request to establish CSRF","suites":["Express"],"updatePoint":{"line":27,"column":62,"index":803},"line":27,"code":"  it('should successfully make a GET request to establish CSRF', async function () {\n    jar = apos.http.jar();\n    const body = await apos.http.get('/tests/welcome', {\n      jar\n    });\n    assert(body.toString() === 'ok');\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should flunk a POST request without the CSRF cookie","suites":["Express"],"updatePoint":{"line":34,"column":57,"index":1029},"line":34,"code":"  it('should flunk a POST request without the CSRF cookie', async function () {\n    try {\n      await apos.http.post('/tests/body', {\n        body: {\n          person: {\n            age: '30'\n          }\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should use the extended bodyParser for submitted forms, and pass CSRF with the cookie","suites":["Express"],"updatePoint":{"line":48,"column":91,"index":1355},"line":48,"code":"  it('should use the extended bodyParser for submitted forms, and pass CSRF with the cookie', async function () {\n    const response = await apos.http.post('/tests/body', {\n      send: 'form',\n      body: {\n        person: {\n          age: '30'\n        }\n      },\n      jar\n    });\n    assert(response.toString() === '30');\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should allow us to implement a route that requires the JSON bodyParser","suites":["Express"],"updatePoint":{"line":60,"column":76,"index":1670},"line":60,"code":"  it('should allow us to implement a route that requires the JSON bodyParser', async function () {\n    const response = await apos.http.post('/tests/body', {\n      send: 'json',\n      body: {\n        person: {\n          age: '30'\n        }\n      },\n      jar\n    });\n    assert(response.toString() === '30');\n    // Last one before a new apos object\n    await t.destroy(apos);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should set prefix on the apos object if passed in","suites":["Express"],"updatePoint":{"line":77,"column":55,"index":2052},"line":77,"code":"  it('should set prefix on the apos object if passed in', async function () {\n    apos = await t.create({\n      root: module,\n      prefix: '/prefix',\n      modules: {\n        'express-test': {},\n        'template-test': {},\n        'template-subclass-test': {}\n      }\n    });\n    assert(apos.prefix);\n    assert(apos.prefix === '/prefix');\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should have different baseApp and app properties with a prefix","suites":["Express"],"updatePoint":{"line":90,"column":68,"index":2413},"line":90,"code":"  it('should have different baseApp and app properties with a prefix', function () {\n    assert(apos.app !== apos.baseApp);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should successfully make a GET request to establish CSRF (prefix)","suites":["Express"],"updatePoint":{"line":93,"column":71,"index":2546},"line":93,"code":"  it('should successfully make a GET request to establish CSRF (prefix)', async function () {\n    jar = apos.http.jar();\n    const body = await apos.http.get('/prefix/tests/welcome', {\n      jar\n    });\n    assert(body.toString() === 'ok');\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should take same requests at the prefix","suites":["Express"],"updatePoint":{"line":100,"column":45,"index":2767},"line":100,"code":"  it('should take same requests at the prefix', async function () {\n    const body = await apos.http.post('/prefix/tests/body', {\n      body: {\n        person: {\n          age: '30'\n        }\n      },\n      jar\n    });\n    assert(body.toString() === '30');\n    await t.destroy(apos);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should provide reasonable absolute and base URLs in tasks reqs if baseUrl option is set on apos object","suites":["Express"],"updatePoint":{"line":112,"column":108,"index":3120},"line":112,"code":"  it('should provide reasonable absolute and base URLs in tasks reqs if baseUrl option is set on apos object', async function () {\n    apos = await t.create({\n      root: module,\n      baseUrl: 'https://example.com',\n      modules: {\n        'express-test': {},\n        'template-test': {},\n        'template-subclass-test': {}\n      }\n    });\n    assert(apos.baseUrl);\n    assert(apos.baseUrl === 'https://example.com');\n    const req = apos.task.getReq({\n      url: '/test'\n    });\n    assert(req.baseUrl === 'https://example.com');\n    assert(req.absoluteUrl === 'https://example.com/test');\n\n    // Last one before a new apos object\n    await t.destroy(apos);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should provide reasonable absolute and base URLs in tasks reqs if baseUrl and prefix options are set on apos object","suites":["Express"],"updatePoint":{"line":133,"column":121,"index":3803},"line":133,"code":"  it('should provide reasonable absolute and base URLs in tasks reqs if baseUrl and prefix options are set on apos object', async function () {\n    apos = await t.create({\n      root: module,\n      baseUrl: 'https://example.com',\n      prefix: '/subdir',\n      modules: {\n        'express-test': {},\n        'template-test': {},\n        'template-subclass-test': {}\n      }\n    });\n    assert(apos.baseUrl);\n    assert(apos.baseUrl === 'https://example.com');\n    assert(apos.prefix === '/subdir');\n    const req = apos.task.getReq({\n      url: '/test'\n    });\n    assert(req.baseUrl === 'https://example.com');\n    assert(req.baseUrlWithPrefix === 'https://example.com/subdir');\n    assert(req.absoluteUrl === 'https://example.com/subdir/test');\n\n    // Last use of this apos object\n    await t.destroy(apos);\n  });","file":"express.js","skipped":false,"dir":"test"},{"name":"should follow a parent field in array and object","suites":["Schema - follow ancestor fields"],"updatePoint":{"line":13,"column":54,"index":376},"line":13,"code":"  it('should follow a parent field in array and object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        household: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'household'\n          },\n          fields: {\n            add: {\n              petPreference: {\n                type: 'select',\n                label: 'Pet Preference',\n                choices: [{\n                  value: 'cats',\n                  label: 'Cats'\n                }, {\n                  value: 'dogs',\n                  label: 'Dogs'\n                }],\n                required: true\n              },\n              pets: {\n                type: 'array',\n                label: 'Pets',\n                fields: {\n                  add: {\n                    name: {\n                      type: 'string',\n                      label: 'Name',\n                      // Follow one level up\n                      following: ['<petPreference']\n                    }\n                  }\n                }\n              },\n              favoritePet: {\n                type: 'object',\n                label: 'Favorite Pet',\n                fields: {\n                  add: {\n                    name: {\n                      type: 'string',\n                      label: 'Name',\n                      // Follow one level up\n                      following: ['<petPreference']\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n    const schema = apos.modules.household.schema;\n    const petField = schema.find(field => field.name === 'pets');\n    const favPetField = schema.find(field => field.name === 'favoritePet');\n    assert(petField);\n    assert.deepEqual(petField.following, ['petPreference']);\n    assert(favPetField);\n    assert.deepEqual(favPetField.following, ['petPreference']);\n  });","file":"follow-ancestors.js","skipped":false,"dir":"test"},{"name":"should follow a grand parent field in array and object","suites":["Schema - follow ancestor fields"],"updatePoint":{"line":77,"column":60,"index":2308},"line":77,"code":"  it('should follow a grand parent field in array and object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        household: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'household'\n          },\n          fields: {\n            add: {\n              petPreference: {\n                type: 'select',\n                label: 'Pet Preference',\n                choices: [{\n                  value: 'cats',\n                  label: 'Cats'\n                }, {\n                  value: 'dogs',\n                  label: 'Dogs'\n                }],\n                required: true\n              },\n              rooms: {\n                type: 'array',\n                label: 'Rooms',\n                fields: {\n                  add: {\n                    pets: {\n                      type: 'array',\n                      label: 'Pets',\n                      fields: {\n                        add: {\n                          name: {\n                            type: 'string',\n                            label: 'Name',\n                            // Follow two levels up\n                            following: ['<<petPreference']\n                          }\n                        }\n                      }\n                    },\n                    favoritePet: {\n                      type: 'object',\n                      label: 'Favorite Pet',\n                      fields: {\n                        add: {\n                          name: {\n                            type: 'string',\n                            label: 'Name',\n                            // Follow two levels up\n                            following: ['<<petPreference']\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n    const schema = apos.modules.household.schema;\n    const rooms = schema.find(field => field.name === 'rooms');\n    assert(rooms);\n    assert.deepEqual(rooms.following, ['petPreference']);\n    const petField = rooms.schema.find(field => field.name === 'pets');\n    const favPetField = rooms.schema.find(field => field.name === 'favoritePet');\n    assert(petField);\n    assert.deepEqual(petField.following, ['<petPreference']);\n    assert(favPetField);\n    assert.deepEqual(favPetField.following, ['<petPreference']);\n  });","file":"follow-ancestors.js","skipped":false,"dir":"test"},{"name":"global should exist on the apos object","suites":["Global"],"updatePoint":{"line":9,"column":44,"index":247},"line":9,"code":"  it('global should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/global': {\n          fields: {\n            add: {\n              spiffiness: {\n                type: 'integer',\n                def: 100\n              }\n            }\n          }\n        },\n        'global-tests': {\n          apiRoutes(self) {\n            return {\n              get: {\n                test(req) {\n                  return req.data.global.test;\n                }\n              }\n            };\n          }\n        }\n      }\n    });\n  });","file":"global.js","skipped":false,"dir":"test"},{"name":"should be able to add a test property","suites":["Global"],"updatePoint":{"line":37,"column":43,"index":855},"line":37,"code":"  it('should be able to add a test property', async function () {\n    return apos.doc.db.updateOne({\n      slug: 'global',\n      aposLocale: 'en:published'\n    }, {\n      $set: {\n        test: 'test'\n      }\n    });\n  });","file":"global.js","skipped":false,"dir":"test"},{"name":"should populate when global.addGlobalToData is awaited","suites":["Global"],"updatePoint":{"line":47,"column":60,"index":1094},"line":47,"code":"  it('should populate when global.addGlobalToData is awaited', async function () {\n    const req = apos.task.getAnonReq();\n    await apos.global.addGlobalToData(req);\n    assert(req.data.global);\n    assert(req.data.global.type === '@apostrophecms/global');\n    assert(req.data.global.test === 'test');\n    // def is respected\n    assert(req.data.global.spiffiness === 100);\n  });","file":"global.js","skipped":false,"dir":"test"},{"name":"should populate via middleware","suites":["Global"],"updatePoint":{"line":56,"column":36,"index":1451},"line":56,"code":"  it('should populate via middleware', async function () {\n    const body = await apos.http.get('/api/v1/global-tests/test');\n    assert(body === 'test');\n  });","file":"global.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Http"],"updatePoint":{"line":10,"column":37,"index":253},"line":10,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        test: {\n          apiRoutes: self => ({\n            post: {\n              '/csrf-test': req => {\n                return {\n                  ok: true\n                };\n              }\n            }\n          })\n        }\n      }\n    });\n    assert(apos.http);\n    jar = apos.http.jar();\n  });","file":"http.js","skipped":false,"dir":"test"},{"name":"should be able to make an http request","suites":["Http"],"updatePoint":{"line":30,"column":44,"index":686},"line":30,"code":"  it('should be able to make an http request', async function () {\n    const result = await apos.http.get('/', {\n      jar\n    });\n    assert(result);\n    assert(result.match(/logged out/));\n  });","file":"http.js","skipped":false,"dir":"test"},{"name":"should be able to make an http POST request with csrf header via default csrf convenience of http.post","suites":["Http"],"updatePoint":{"line":37,"column":108,"index":947},"line":37,"code":"  it('should be able to make an http POST request with csrf header via default csrf convenience of http.post', async function () {\n    const response = await apos.http.post('/csrf-test', {\n      jar,\n      body: {}\n    });\n    assert(response.ok === true);\n  });","file":"http.js","skipped":false,"dir":"test"},{"name":"should should exist on the apos object","suites":["static i18n"],"updatePoint":{"line":49,"column":44,"index":1224},"line":49,"code":"  it('should should exist on the apos object', async function () {\n    assert(apos.i18n);\n    assert(apos.i18n.i18next);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should localize apostrophe namespace phrases in the default locale","suites":["static i18n"],"updatePoint":{"line":53,"column":72,"index":1379},"line":53,"code":"  it('should localize apostrophe namespace phrases in the default locale', function () {\n    assert.strictEqual(apos.task.getReq().t('apostrophe:notFoundPageTitle'), '404 - Page not found');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should localize default namespace phrases contributed by a project level module","suites":["static i18n"],"updatePoint":{"line":56,"column":85,"index":1589},"line":56,"code":"  it('should localize default namespace phrases contributed by a project level module', function () {\n    assert.strictEqual(apos.task.getReq().t('projectLevelPhrase'), 'Project Level Phrase');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should merge translations in different languages of the same phrases from @apostrophecms/i18n and a different module","suites":["static i18n"],"updatePoint":{"line":59,"column":122,"index":1826},"line":59,"code":"  it('should merge translations in different languages of the same phrases from @apostrophecms/i18n and a different module', function () {\n    assert.strictEqual(apos.task.getReq().t('apostrophe:richTextAlignCenter'), 'Align Center');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should merge translations in different languages of the same phrases from @apostrophecms/i18n and a different module (fr)","suites":["static i18n"],"updatePoint":{"line":62,"column":127,"index":2072},"line":62,"code":"  it('should merge translations in different languages of the same phrases from @apostrophecms/i18n and a different module (fr)', function () {\n    // je suis désolé re: Google Translate-powered French test, feel free to PR better example\n    assert.strictEqual(apos.task.getReq({\n      locale: 'fr'\n    }).t('apostrophe:richTextAlignCenter'), 'Aligner Le Centre');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should fetch default locale phrases from main i18n dir with no i18n option necessary","suites":["static i18n"],"updatePoint":{"line":68,"column":90,"index":2407},"line":68,"code":"  it('should fetch default locale phrases from main i18n dir with no i18n option necessary', function () {\n    assert.strictEqual(apos.task.getReq().t('defaultTestOne'), 'Default Test One');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should fetch custom locale phrases from corresponding subdir","suites":["static i18n"],"updatePoint":{"line":71,"column":66,"index":2580},"line":71,"code":"  it('should fetch custom locale phrases from corresponding subdir', function () {\n    assert.strictEqual(apos.task.getReq().t('custom:customTestTwo'), 'Custom Test Two From Base Type');\n    assert.strictEqual(apos.task.getReq().t('custom:customTestThree'), 'Custom Test Three From Subtype');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"last appearance in inheritance + configuration order wins","suites":["static i18n"],"updatePoint":{"line":75,"column":63,"index":2876},"line":75,"code":"  it('last appearance in inheritance + configuration order wins', function () {\n    assert.strictEqual(apos.task.getReq().t('custom:customTestOne'), 'Custom Test One From Subtype');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should honor the browser: true flag in the i18n section of an index.js file","suites":["static i18n"],"updatePoint":{"line":78,"column":81,"index":3082},"line":78,"code":"  it('should honor the browser: true flag in the i18n section of an index.js file', function () {\n    const browserData = apos.i18n.getBrowserData(apos.task.getReq());\n    assert.strictEqual(browserData.i18n.en.custom.customTestOne, 'Custom Test One From Subtype');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should return a 404 HTTP error code when a logged out user tries to access to a content in a private locale","suites":["private locales"],"updatePoint":{"line":110,"column":113,"index":3977},"line":110,"code":"  it('should return a 404 HTTP error code when a logged out user tries to access to a content in a private locale', async function () {\n    try {\n      await apos.http.get('/sk');\n    } catch (error) {\n      assert(error.status === 404);\n      return;\n    }\n    throw new Error('should have thrown 404 error');\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should not redirect to the first prefixed locale when the page requested is not the homepage","suites":["redirection to first locale"],"updatePoint":{"line":177,"column":98,"index":5735},"line":177,"code":"  it('should not redirect to the first prefixed locale when the page requested is not the homepage', async function () {\n    const response = await apos.http.get('/child', {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    assert.strictEqual(response.status, 200);\n    assert.strictEqual(response.headers.location, undefined);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should redirect to the first prefixed locale","suites":["redirection to first locale"],"updatePoint":{"line":186,"column":50,"index":6063},"line":186,"code":"  it('should redirect to the first prefixed locale', async function () {\n    const response = await apos.http.get('/', {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    assert.strictEqual(response.headers.location, `${apos.http.getBase()}/es/`);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should redirect to the first prefixed locale that matches the requested hostname","suites":["redirection to first locale"],"updatePoint":{"line":194,"column":86,"index":6395},"line":194,"code":"  it('should redirect to the first prefixed locale that matches the requested hostname', async function () {\n    const server = apos.modules['@apostrophecms/express'].server;\n    const response = await apos.http.get(`http://ca.localhost:${server.address().port}`, {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    assert.strictEqual(response.headers.location, `http://ca.localhost:${server.address().port}/en-ca/`);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should not redirect to the first prefixed locale when at least one locale has no prefix","suites":["no redirection to first locale"],"updatePoint":{"line":252,"column":93,"index":8053},"line":252,"code":"  it('should not redirect to the first prefixed locale when at least one locale has no prefix', async function () {\n    const response = await apos.http.get('/', {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    assert.strictEqual(response.status, 200);\n    assert.strictEqual(response.headers.location, undefined);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should not redirect to the first prefixed locale that matches the requested hostname when at least one locale has no prefix","suites":["no redirection to first locale"],"updatePoint":{"line":261,"column":129,"index":8455},"line":261,"code":"  it('should not redirect to the first prefixed locale that matches the requested hostname when at least one locale has no prefix', async function () {\n    const server = apos.modules['@apostrophecms/express'].server;\n    const response = await apos.http.get(`http://ca.localhost:${server.address().port}`, {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    assert.strictEqual(response.status, 200);\n    assert.strictEqual(response.headers.location, undefined);\n  });","file":"i18n.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Images"],"updatePoint":{"line":50,"column":45,"index":981},"line":50,"code":"  it('should be a property of the apos object', async function () {\n    this.timeout(t.timeout);\n    this.slow(2000);\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.image);\n    assert(apos.image.__meta.name === '@apostrophecms/image');\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should clean up any existing images for testing","suites":["Images"],"updatePoint":{"line":61,"column":53,"index":1280},"line":61,"code":"  it('should clean up any existing images for testing', async function () {\n    try {\n      const response = await apos.doc.db.deleteMany({\n        type: '@apostrophecms/image'\n      });\n      assert(response.result.ok === 1);\n    } catch (e) {\n      assert(false);\n    }\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should add images for testing","suites":["Images"],"updatePoint":{"line":71,"column":35,"index":1540},"line":71,"code":"  it('should add images for testing', async function () {\n    assert(apos.image.insert);\n    const req = apos.task.getReq();\n    const insertPromises = mockImages.map(async image => {\n      return apos.image.insert(req, image);\n    });\n    inserted = await Promise.all(insertPromises);\n    assert(inserted.length === mockImages.length);\n    assert(inserted[0]._id);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should respect minSize filter (svg is always OK)","suites":["Images"],"updatePoint":{"line":81,"column":54,"index":1931},"line":81,"code":"  it('should respect minSize filter (svg is always OK)', async function () {\n    const req = apos.task.getAnonReq();\n    const images = await apos.image.find(req).minSize([200, 200]).toArray();\n    assert(images.length === 3);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should respect minSize filter in toCount, which uses a cloned cursor","suites":["Images"],"updatePoint":{"line":86,"column":74,"index":2184},"line":86,"code":"  it('should respect minSize filter in toCount, which uses a cloned cursor', async function () {\n    const req = apos.task.getAnonReq();\n    const count = await apos.image.find(req).minSize([200, 200]).toCount();\n    assert(count === 3);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should generate a srcset string for an image","suites":["Images"],"updatePoint":{"line":91,"column":50,"index":2404},"line":91,"code":"  it('should generate a srcset string for an image', function () {\n    const srcset = apos.image.srcset({\n      name: 'test',\n      _id: 'test',\n      extension: 'jpg',\n      width: 1200,\n      height: 800\n    });\n    assert.strictEqual(srcset, ['/uploads/attachments/test-test.max.jpg 1200w', '/uploads/attachments/test-test.full.jpg 1140w', '/uploads/attachments/test-test.two-thirds.jpg 760w', '/uploads/attachments/test-test.one-half.jpg 570w', '/uploads/attachments/test-test.one-third.jpg 380w', '/uploads/attachments/test-test.one-sixth.jpg 190w'].join(', '));\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should not generate a srcset string for an SVG image","suites":["Images"],"updatePoint":{"line":101,"column":58,"index":2986},"line":101,"code":"  it('should not generate a srcset string for an SVG image', function () {\n    const srcset = apos.image.srcset({\n      name: 'test',\n      _id: 'test',\n      extension: 'svg',\n      width: 1200,\n      height: 800\n    });\n    assert.strictEqual(srcset, '');\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"should be able to insert test users","suites":["Images"],"updatePoint":{"line":111,"column":41,"index":3233},"line":111,"code":"  it('should be able to insert test users', async function () {\n    await insertUser({\n      title: 'admin',\n      username: 'admin',\n      password: 'admin',\n      email: 'ad@min.com',\n      role: 'admin'\n    });\n    await insertUser({\n      title: 'contributor',\n      username: 'contributor',\n      password: 'contributor',\n      email: 'con@tributor.com',\n      role: 'contributor'\n    });\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: should be able to log in as admin","suites":["Images"],"updatePoint":{"line":127,"column":45,"index":3637},"line":127,"code":"  it('REST: should be able to log in as admin', async function () {\n    jar = await login('admin');\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"\"editable\" API includes images for admin","suites":["Images"],"updatePoint":{"line":130,"column":46,"index":3744},"line":130,"code":"  it('\"editable\" API includes images for admin', async function () {\n    const editable = await getEditableImages(jar);\n    assert(editable.length === 4);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: should be able to log in as contributor","suites":["Images"],"updatePoint":{"line":134,"column":51,"index":3910},"line":134,"code":"  it('REST: should be able to log in as contributor', async function () {\n    jar = await login('contributor');\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"\"editable\" API does not include images for contributor","suites":["Images"],"updatePoint":{"line":137,"column":60,"index":4037},"line":137,"code":"  it('\"editable\" API does not include images for contributor', async function () {\n    const editable = await getEditableImages(jar);\n    assert(editable.length === 0);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: should be able to upload an image with an attachment as an admin","suites":["Images"],"updatePoint":{"line":141,"column":76,"index":4228},"line":141,"code":"  it('REST: should be able to upload an image with an attachment as an admin', async function () {\n    jar = await login('admin');\n    const formData = new FormData();\n    formData.append('file', fs.createReadStream(path.join(apos.rootDir, '/public/test-image.jpg')));\n\n    // Make an async request to upload the image.\n    const attachment = await apos.http.post('/api/v1/@apostrophecms/attachment/upload', {\n      body: formData,\n      jar\n    });\n    image = await apos.http.post('/api/v1/@apostrophecms/image', {\n      body: {\n        title: 'Test Image',\n        attachment\n      },\n      jar\n    });\n    assert(image);\n    assert(image.title === 'Test Image');\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: autocrop should have no effect when there are no widget options","suites":["Images"],"updatePoint":{"line":161,"column":75,"index":4900},"line":161,"code":"  it('REST: autocrop should have no effect when there are no widget options', async function () {\n    const result = await apos.http.post('/api/v1/@apostrophecms/image/autocrop', {\n      body: {\n        relationship: [image],\n        widgetOptions: {}\n      },\n      jar\n    });\n    assert(result.relationship);\n    assert(result.relationship[0]);\n    assert(result.relationship[0].title === 'Test Image');\n    assert(!result.relationship[0]._fields);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: autocrop should work when aspectRatio is less than actual image","suites":["Images"],"updatePoint":{"line":174,"column":75,"index":5358},"line":174,"code":"  it('REST: autocrop should work when aspectRatio is less than actual image', async function () {\n    const result = await apos.http.post('/api/v1/@apostrophecms/image/autocrop', {\n      body: {\n        relationship: [image],\n        widgetOptions: {\n          aspectRatio: [1, 2]\n        }\n      },\n      jar\n    });\n    assert(result.relationship);\n    const output = result.relationship[0];\n    assert(output);\n    assert(output.title === 'Test Image');\n    const fields = output._fields;\n    assert(fields);\n    // Useful for visual verification\n    // require('child_process').execSync(`open test/public${output.attachment._urls.full} &`);\n\n    assert.strictEqual(fields.top, 0);\n    assert.strictEqual(fields.left, 75);\n    assert.strictEqual(fields.width, 300);\n    assert.strictEqual(fields.height, 600);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"REST: autocrop should work when aspectRatio is greater than actual image","suites":["Images"],"updatePoint":{"line":198,"column":78,"index":6180},"line":198,"code":"  it('REST: autocrop should work when aspectRatio is greater than actual image', async function () {\n    const result = await apos.http.post('/api/v1/@apostrophecms/image/autocrop', {\n      body: {\n        relationship: [image],\n        widgetOptions: {\n          aspectRatio: [2, 1]\n        }\n      },\n      jar\n    });\n    assert(result.relationship);\n    const output = result.relationship[0];\n    assert(output);\n    assert(output.title === 'Test Image');\n    const fields = output._fields;\n    assert(fields);\n    // Useful for visual verification\n    // require('child_process').execSync(`open test/public${output.attachment._urls.full} &`);\n    assert.strictEqual(fields.top, 187);\n    assert.strictEqual(fields.left, 0);\n    assert.strictEqual(fields.width, 450);\n    assert.strictEqual(fields.height, 225);\n  });","file":"images.js","skipped":false,"dir":"test"},{"name":"\"improve\" should work, but project level should override it","suites":["Improve Overrides"],"updatePoint":{"line":5,"column":65,"index":213},"line":5,"code":"  it('\"improve\" should work, but project level should override it', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          'improve-piece-type': {},\n          'improve-global': {}\n        }\n      });\n      assert(apos.global.options.verifyProjectLevelLoaded);\n      assert.strictEqual(apos.user.options.testPieceTypeLevelLoaded, true);\n      assert.strictEqual(apos.user.options.testPieceTypeLevel, true);\n      assert.strictEqual(apos.global.options.testPieceTypeLevelLoaded, true);\n      assert.strictEqual(apos.global.options.testPieceTypeLevel, false);\n      assert.strictEqual(apos.global.options.testGlobalLevelLoaded, true);\n      assert.strictEqual(apos.global.options.testGlobalLevel, false);\n    } finally {\n      t.destroy(apos);\n    }\n  });","file":"improve-overrides.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Job module"],"updatePoint":{"line":11,"column":45,"index":312},"line":11,"code":"  it('should be a property of the apos object', async function () {\n    this.timeout(t.timeout);\n    this.slow(2000);\n    apos = await t.create({\n      root: module,\n      modules: {\n        article: {\n          extend: '@apostrophecms/piece-type'\n        }\n      }\n    });\n    jobModule = apos.modules['@apostrophecms/job'];\n    assert(apos.modules['@apostrophecms/job']);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"has a related database collection","suites":["Job module"],"updatePoint":{"line":25,"column":39,"index":686},"line":25,"code":"  it('has a related database collection', async function () {\n    assert(jobModule.db);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"should create a new job","suites":["Job module"],"updatePoint":{"line":29,"column":29,"index":784},"line":29,"code":"  it('should create a new job', async function () {\n    jobOne = await jobModule.start({});\n    assert(jobOne._id);\n    const found = await jobModule.db.findOne({\n      _id: jobOne._id\n    });\n    assert(found);\n    assert(found.status === 'running');\n    assert(found.ended === false);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"should end a job and mark it as successful","suites":["Job module"],"updatePoint":{"line":39,"column":48,"index":1096},"line":39,"code":"  it('should end a job and mark it as successful', async function () {\n    const result = await jobModule.end(jobOne, 'success', {\n      testing: 'testing'\n    });\n    assert(result.result.nModified === 1);\n    const found = await jobModule.db.findOne({\n      _id: jobOne._id\n    });\n    assert(found);\n    assert(found.status === 'completed');\n    assert(found.ended === true);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"should get admin jar","suites":["Job module"],"updatePoint":{"line":52,"column":26,"index":1470},"line":52,"code":"  it('should get admin jar', async function () {\n    await t.createAdmin(apos);\n    jar = await t.getUserJar(apos);\n    assert(jar);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"should access a job via REST API GET request","suites":["Job module"],"updatePoint":{"line":57,"column":50,"index":1633},"line":57,"code":"  it('should access a job via REST API GET request', async function () {\n    const job = await apos.http.get(`/api/v1/@apostrophecms/job/${jobOne._id}`, {\n      jar\n    });\n    assert(job._id === jobOne._id);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"can insert many test articles","suites":["Job module"],"updatePoint":{"line":64,"column":35,"index":1851},"line":64,"code":"  it('can insert many test articles', async function () {\n    const req = apos.task.getReq();\n    const promises = [];\n    for (let i = 1; i <= 500; i++) {\n      promises.push(insert(req, apos.modules.article, 'article', {}, i));\n    }\n    const inserted = await Promise.all(promises);\n    articleIds = inserted.map(doc => doc._id);\n    assert(inserted.length === 500);\n    assert(!!inserted[0]._id);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"can run a batch job","suites":["Job module"],"updatePoint":{"line":76,"column":25,"index":2262},"line":76,"code":"  it('can run a batch job', async function () {\n    const req = apos.task.getReq();\n    jobTwo = await jobModule.runBatch(req, articleIds, async function (req, id) {\n      await apos.doc.db.updateOne({\n        _id: id\n      }, {\n        $set: {\n          checked: true\n        }\n      });\n    });\n    assert(!!jobTwo.jobId);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"can follow the second job as it works","suites":["Job module"],"updatePoint":{"line":89,"column":43,"index":2611},"line":89,"code":"  it('can follow the second job as it works', async function () {\n    const {\n      completed\n    } = await pollJob({\n      route: `${jobModule.action}/${jobTwo.jobId}`\n    }, {\n      jar\n    });\n    assert(completed === articleIds.length);\n    const index = Math.floor(Math.random() * (articleIds.length - 1));\n    const article = await apos.http.get(`/api/v1/article/${articleIds[index]}`, {\n      jar\n    });\n    assert(article.checked === true);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"can run a generic job","suites":["Job module"],"updatePoint":{"line":106,"column":27,"index":3088},"line":106,"code":"  it('can run a generic job', async function () {\n    const req = apos.task.getReq();\n    jobThree = await jobModule.run(req, async function (req, reporters) {\n      let count = 1;\n      reporters.setTotal(articleIds.length);\n      for (const id of articleIds) {\n        await Promise.delay(3);\n        logged.push(id);\n        if (count % 2) {\n          reporters.success();\n        } else {\n          reporters.failure();\n        }\n        count++;\n      }\n    });\n    assert(!!jobThree.jobId);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"can follow the third job as it works","suites":["Job module"],"updatePoint":{"line":124,"column":42,"index":3606},"line":124,"code":"  it('can follow the third job as it works', async function () {\n    const route = `${jobModule.action}/${jobThree.jobId}`;\n    const {\n      total\n    } = await apos.http.get(route, {\n      jar\n    });\n    // Tests setTotal()\n    assert(total === articleIds.length);\n    const {\n      completed,\n      good,\n      bad\n    } = await pollJob({\n      route\n    }, {\n      jar\n    });\n    assert(completed === articleIds.length);\n    // Tests success()\n    assert(good === articleIds.length / 2);\n    // Tests failure()\n    assert(bad === articleIds.length / 2);\n  });","file":"job.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Launder"],"updatePoint":{"line":9,"column":37,"index":243},"line":9,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.launder);\n  });","file":"launder.js","skipped":false,"dir":"test"},{"name":"should launder a number to a string","suites":["Launder"],"updatePoint":{"line":20,"column":41,"index":534},"line":20,"code":"  it('should launder a number to a string', function () {\n    assert(apos.launder.string(5) === '5');\n  });","file":"launder.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Locks"],"updatePoint":{"line":10,"column":45,"index":284},"line":10,"code":"  it('should be a property of the apos object', async function () {\n    this.timeout(t.timeout);\n    this.slow(2000);\n    apos = await t.create({\n      root: module,\n      modules: {\n        // Make some subclasses of the locks module. NORMALLY A BAD IDEA. But\n        // we're doing it to deliberately force them to contend with each other,\n        // rather than just throwing an error saying \"hey you have this lock\n        // now\"\n        '@apostrophecms/lock-1': {\n          extend: '@apostrophecms/lock',\n          options: {\n            alias: 'locks1'\n          }\n        },\n        '@apostrophecms/lock-2': {\n          extend: '@apostrophecms/lock',\n          options: {\n            alias: 'locks2'\n          }\n        },\n        '@apostrophecms/lock-3': {\n          extend: '@apostrophecms/lock',\n          options: {\n            alias: 'locks3'\n          }\n        }\n      }\n    });\n    assert(apos.modules['@apostrophecms/lock']);\n    assert(apos.modules['@apostrophecms/lock-1']);\n    assert(apos.modules['@apostrophecms/lock-2']);\n    assert(apos.modules['@apostrophecms/lock-3']);\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"cleanup","suites":["Locks"],"updatePoint":{"line":45,"column":13,"index":1354},"line":45,"code":"  it('cleanup', async function () {\n    await apos.lock.db.deleteMany({});\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"should allow a single lock without contention uneventfully","suites":["Locks"],"updatePoint":{"line":48,"column":64,"index":1486},"line":48,"code":"  it('should allow a single lock without contention uneventfully', async function () {\n    await apos.lock.lock('test');\n    await apos.lock.unlock('test');\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"should allow two differently-named locks uneventfully","suites":["Locks"],"updatePoint":{"line":52,"column":59,"index":1644},"line":52,"code":"  it('should allow two differently-named locks uneventfully', async function () {\n    await apos.lock.lock('test1');\n    await apos.lock.lock('test2');\n    await apos.lock.unlock('test1');\n    await apos.lock.unlock('test2');\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"should flunk a second lock by the same module with waitForSelf: false","suites":["Locks"],"updatePoint":{"line":58,"column":75,"index":1892},"line":58,"code":"  it('should flunk a second lock by the same module with waitForSelf: false', async function () {\n    await apos.lock.lock('test');\n    try {\n      await apos.lock.lock('test', {\n        waitForSelf: false\n      });\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n    await apos.lock.unlock('test');\n    try {\n      await apos.lock.unlock('test');\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"four parallel lock calls via the different modules should all succeed but not simultaneously","suites":["Locks"],"updatePoint":{"line":76,"column":98,"index":2345},"line":76,"code":"  it('four parallel lock calls via the different modules should all succeed but not simultaneously', async function () {\n    const one = apos.modules['@apostrophecms/lock'];\n    const two = apos.modules['@apostrophecms/lock-1'];\n    const three = apos.modules['@apostrophecms/lock-2'];\n    const four = apos.modules['@apostrophecms/lock-3'];\n    let active = 0;\n    let successful = 0;\n    await Promise.all([attempt(one), attempt(two), attempt(three), attempt(four)]);\n    assert(successful === 4);\n    async function attempt(locks) {\n      await apos.lock.lock('test');\n      active++;\n      assert(active === 1);\n      return release();\n      async function release() {\n        // We have to decrement this before we start the call to\n        // apos.lock.unlock because otherwise the callback for one of our\n        // peers' insert attempts may succeed before the callback for\n        // remove, leading to a false positive for test failure. -Tom\n        active--;\n        await Promise.delay(75 + Math.random() * 50);\n        await apos.lock.unlock('test');\n        successful++;\n        return null;\n      }\n    }\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"four parallel lock calls via the different modules should all succeed but not simultaneously, even when the idleTimeout is short","suites":["Locks"],"updatePoint":{"line":103,"column":134,"index":3508},"line":103,"code":"  it('four parallel lock calls via the different modules should all succeed but not simultaneously, even when the idleTimeout is short', async function () {\n    const one = apos.modules['@apostrophecms/lock'];\n    const two = apos.modules['@apostrophecms/lock-1'];\n    const three = apos.modules['@apostrophecms/lock-2'];\n    const four = apos.modules['@apostrophecms/lock-3'];\n    let active = 0;\n    let successful = 0;\n    await Promise.all([attempt(one), attempt(two), attempt(three), attempt(four)]);\n    assert(successful === 4);\n    async function attempt(locks) {\n      await apos.lock.lock('test', {\n        idleTimeout: 50\n      });\n      active++;\n      assert(active === 1);\n      await release();\n      async function release() {\n        // We have to decrement this before we start the call to\n        // apos.lock.unlock because otherwise the callback for one of our\n        // peers' insert attempts may succeed before the callback for\n        // remove, leading to a false positive for test failure. -Tom\n        active--;\n        await Promise.delay(75 + Math.random() * 50);\n        await apos.lock.unlock('test');\n        successful++;\n        return null;\n      }\n    }\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"withLock method should run a function inside a lock","suites":["Locks"],"updatePoint":{"line":132,"column":57,"index":4628},"line":132,"code":"  it('withLock method should run a function inside a lock', async function () {\n    const result = await apos.lock.withLock('test-lock', async () => {\n      await Promise.delay(50);\n      return 'result';\n    });\n    assert(result === 'result');\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"withLock method should be able to run again (lock released)","suites":["Locks"],"updatePoint":{"line":139,"column":65,"index":4888},"line":139,"code":"  it('withLock method should be able to run again (lock released)', async function () {\n    const result = await apos.lock.withLock('test-lock', async () => {\n      await Promise.delay(50);\n      return 'result';\n    });\n    assert(result === 'result');\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"withLock method should hold the lock (cannot relock within fn)","suites":["Locks"],"updatePoint":{"line":146,"column":68,"index":5151},"line":146,"code":"  it('withLock method should hold the lock (cannot relock within fn)', async function () {\n    return apos.lock.withLock('test-lock', async () => {\n      await Promise.delay(50);\n      try {\n        await apos.lock.lock('test-lock', {\n          waitForSelf: false\n        });\n        assert(false);\n      } catch (e) {\n        assert(e);\n      }\n    });\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"Second lock should wait for release of first one","suites":["Locks"],"updatePoint":{"line":159,"column":54,"index":5497},"line":159,"code":"  it('Second lock should wait for release of first one', async function () {\n    let timedOut = false;\n    await apos.lock.lock('test-lock');\n    setTimeout(async () => {\n      await apos.lock.unlock('test-lock');\n      timedOut = true;\n    });\n    await apos.lock.lock('test-lock');\n    assert(timedOut);\n    await apos.lock.unlock('test-lock');\n  });","file":"locks.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Login"],"updatePoint":{"line":14,"column":23,"index":336},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/login': {\n          requirements(self) {\n            return {\n              add: {\n                WeakCaptcha: {\n                  phase: 'beforeSubmit',\n                  async props(req) {\n                    return {\n                      hint: 'xyz'\n                    };\n                  },\n                  async verify(req, data) {\n                    if (data !== 'xyz') {\n                      throw self.apos.error('invalid', captchaErr);\n                    }\n                  }\n                },\n                ExtraSecret: {\n                  phase: 'afterPasswordVerified',\n                  async props(req, user) {\n                    return {\n                      // Verify we had access to the user here\n                      hint: user.username\n                    };\n                  },\n                  async verify(req, data, user) {\n                    if (data !== user.extraSecret) {\n                      throw self.apos.error('invalid', extraSecretErr);\n                    }\n                  }\n                }\n              }\n            };\n          }\n        }\n      }\n    });\n    assert(apos.modules['@apostrophecms/login']);\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"should be able to insert test user","suites":["Login"],"updatePoint":{"line":57,"column":40,"index":1664},"line":57,"code":"  it('should be able to insert test user', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'Harry Putter';\n    user.username = 'HarryPutter';\n    user.password = 'crookshanks';\n    user.email = 'hputter@aol.com';\n    user.role = 'admin';\n    user.extraSecret = 'roll-on';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    const doc = await apos.user.insert(apos.task.getReq(), user);\n    assert(doc._id);\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"should not be able to login a user without meeting a beforeSubmit requirement","suites":["Login"],"updatePoint":{"line":72,"column":83,"index":2235},"line":72,"code":"  it('should not be able to login a user without meeting a beforeSubmit requirement', async function () {\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    const context = await apos.http.post('/api/v1/@apostrophecms/login/context', {\n      method: 'POST',\n      body: {},\n      jar\n    });\n    assert(context.requirementProps);\n    assert(context.requirementProps.WeakCaptcha);\n    assert.strictEqual(context.requirementProps.WeakCaptcha.hint, 'xyz');\n    try {\n      await apos.http.post('/api/v1/@apostrophecms/login/login', {\n        method: 'POST',\n        body: {\n          username: 'HarryPutter',\n          password: 'crookshanks',\n          session: true\n        },\n        jar\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 400);\n      assert.strictEqual(e.body.message, captchaErr);\n      assert.strictEqual(e.body.data.requirement, 'WeakCaptcha');\n    }\n\n    // Make sure it really didn't work\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"should not be able to login a user with the wrong value for a beforeSubmit requirement","suites":["Login"],"updatePoint":{"line":111,"column":92,"index":3389},"line":111,"code":"  it('should not be able to login a user with the wrong value for a beforeSubmit requirement', async function () {\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    try {\n      await apos.http.post('/api/v1/@apostrophecms/login/login', {\n        method: 'POST',\n        body: {\n          username: 'HarryPutter',\n          password: 'crookshanks',\n          session: true,\n          requirements: {\n            WeakCaptcha: 'abc'\n          }\n        },\n        jar\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 400);\n      assert.strictEqual(e.body.message, captchaErr);\n      assert.strictEqual(e.body.data.requirement, 'WeakCaptcha');\n    }\n\n    // Make sure it really didn't work\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"should throttle requirements verify attemps and show a proper error when the limit is reached","suites":["Login"],"updatePoint":{"line":145,"column":99,"index":4319},"line":145,"code":"  it('should throttle requirements verify attemps and show a proper error when the limit is reached', async function () {\n    const loginModule = apos.modules['@apostrophecms/login'];\n    const {\n      allowedAttempts\n    } = loginModule.options.throttle;\n    const namespace = '@apostrophecms/loginAttempt/ExtraSecret';\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    const result = await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'HarryPutter',\n        password: 'crookshanks',\n        session: true,\n        requirements: {\n          WeakCaptcha: 'xyz'\n        }\n      },\n      jar\n    });\n    assert(result.incompleteToken);\n\n    // Make sure it did not create a login session prematurely\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    const token = result.incompleteToken;\n    for (let index = 0; index <= allowedAttempts; index++) {\n      try {\n        await apos.http.post('/api/v1/@apostrophecms/login/requirement-verify', {\n          body: {\n            incompleteToken: token,\n            session: true,\n            name: 'ExtraSecret',\n            value: 'roll-off'\n          },\n          jar\n        });\n      } catch ({\n        status,\n        body\n      }) {\n        if (index < allowedAttempts) {\n          assert(body.message === extraSecretErr);\n        } else {\n          assert(body.message === 'Too many attempts. You may try again in a minute.');\n        }\n      }\n    }\n    await loginModule.clearLoginAttempts('HarryPutter', namespace);\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"initial login should produce an incompleteToken, convertible with the afterPasswordVerified requirements","suites":["Login"],"updatePoint":{"line":202,"column":110,"index":6027},"line":202,"code":"  it('initial login should produce an incompleteToken, convertible with the afterPasswordVerified requirements', async function () {\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    const result = await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'HarryPutter',\n        password: 'crookshanks',\n        session: true,\n        requirements: {\n          WeakCaptcha: 'xyz'\n        }\n      },\n      jar\n    });\n    assert(result.incompleteToken);\n\n    // Make sure it did not create a login session prematurely\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n\n    // Make sure it won't convert with an incorrect ExtraSecret\n\n    const token = result.incompleteToken;\n    try {\n      await apos.http.post('/api/v1/@apostrophecms/login/requirement-verify', {\n        body: {\n          incompleteToken: token,\n          session: true,\n          name: 'ExtraSecret',\n          value: 'roll-off'\n        },\n        jar\n      });\n    } catch ({\n      status,\n      body\n    }) {\n      assert(status === 400);\n      assert.strictEqual(body.message, extraSecretErr);\n      assert.strictEqual(body.data.requirement, 'ExtraSecret');\n    }\n\n    // If we try the final login without\n    // having successfully verified all requirements we get an error\n    try {\n      await apos.http.post('/api/v1/@apostrophecms/login/login', {\n        method: 'POST',\n        body: {\n          incompleteToken: token,\n          session: true\n        },\n        jar\n      });\n    } catch ({\n      status,\n      body\n    }) {\n      assert(status === 403);\n      assert.strictEqual(body.message, 'All requirements must be verified');\n    }\n\n    // Make sure it did not create a login session prematurely\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n\n    // Fetch props for afterPasswordVerified component\n\n    const props = await apos.http.post('/api/v1/@apostrophecms/login/requirement-props', {\n      method: 'POST',\n      body: {\n        incompleteToken: token,\n        name: 'ExtraSecret'\n      },\n      jar\n    });\n    assert.strictEqual(props.hint, 'HarryPutter');\n\n    // Now convert token to an actual login session\n    // by providing the post-password-verification requirements,\n    // correctly\n\n    await apos.http.post('/api/v1/@apostrophecms/login/requirement-verify', {\n      body: {\n        incompleteToken: token,\n        session: true,\n        name: 'ExtraSecret',\n        value: 'roll-on'\n      },\n      jar\n    });\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        incompleteToken: token,\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n  });","file":"login-requirements.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Login"],"updatePoint":{"line":36,"column":23,"index":739},"line":36,"code":"  it('should initialize', async function () {\n    assert(apos);\n    assert(apos.modules['@apostrophecms/login']);\n    assert(apos.user.safe.remove);\n    const response = await apos.user.safe.removeMany({});\n    assert(response.result.ok === 1);\n    const loginModule = apos.modules['@apostrophecms/login'];\n    const context = await loginModule.getContext();\n    assert(context.env === 'test');\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should be able to insert test user","suites":["Login"],"updatePoint":{"line":46,"column":40,"index":1157},"line":46,"code":"  it('should be able to insert test user', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'Harry Putter';\n    user.username = 'HarryPutter';\n    user.password = 'crookshanks';\n    user.email = 'hputter@aol.com';\n    user.role = 'admin';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    const doc = await apos.user.insert(apos.task.getReq(), user);\n    assert(doc._id);\n    const user2 = apos.user.newInstance();\n    user2.title = 'Bob Smith';\n    user2.username = 'BobSmith';\n    user2.password = 'bobsmith';\n    user2.email = 'bobsmith@aol.com';\n    user2.role = 'guest';\n    await apos.user.insert(apos.task.getReq(), user2);\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should throttle login attempts and show a proper error when the limit is reached","suites":["Login"],"updatePoint":{"line":67,"column":86,"index":1956},"line":67,"code":"  it('should throttle login attempts and show a proper error when the limit is reached', async function () {\n    const loginModule = apos.modules['@apostrophecms/login'];\n    const {\n      allowedAttempts\n    } = loginModule.options.throttle;\n    const jar = apos.http.jar();\n    const username = 'HarryPutter';\n    // establish session\n    const page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    for (let index = 0; index <= allowedAttempts; index++) {\n      try {\n        await apos.http.post('/api/v1/@apostrophecms/login/login', {\n          method: 'POST',\n          body: {\n            username,\n            password: 'badpassword',\n            session: true\n          },\n          jar\n        });\n      } catch ({\n        body\n      }) {\n        if (index < allowedAttempts) {\n          assert(body.message === 'Your credentials are incorrect, or there is no such user');\n        } else {\n          assert(body.message === 'Too many attempts. You may try again in a minute.');\n        }\n      }\n    }\n    await loginModule.clearLoginAttempts(username);\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should be able to login a user with their username","suites":["Login"],"updatePoint":{"line":102,"column":56,"index":3035},"line":102,"code":"  it('should be able to login a user with their username', async function () {\n    const getLoggedInCookieValue = jar => jar.toJSON().cookies.find(cookie => cookie.key === `${apos.options.shortName}.loggedIn`).value;\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'HarryPutter',\n        password: 'crookshanks',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n    assert(page.match(/Harry Putter/));\n    assert(getLoggedInCookieValue(jar) === 'true');\n\n    // otherwise logins are not remembered in a session\n    await apos.http.post('/api/v1/@apostrophecms/login/logout', {\n      body: {\n        username: 'hputter@aol.com',\n        password: 'crookshanks',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n\n    // are we back to being able to log in?\n    assert(page.match(/logged out/));\n    assert(getLoggedInCookieValue(jar) === 'false');\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should be able to login a user with their email","suites":["Login"],"updatePoint":{"line":144,"column":53,"index":4261},"line":144,"code":"  it('should be able to login a user with their email', async function () {\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'hputter@aol.com',\n        password: 'crookshanks',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n\n    // Did we get our page back?\n    assert(page.match(/logged in/));\n\n    // otherwise logins are not remembered in a session\n    await apos.http.post('/api/v1/@apostrophecms/login/logout', {\n      body: {\n        username: 'hputter@aol.com',\n        password: 'crookshanks',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n\n    // are we back to being able to log in?\n    assert(page.match(/logged out/));\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"changing a user's password should invalidate sessions for that user","suites":["Login"],"updatePoint":{"line":183,"column":74,"index":5241},"line":183,"code":"  it('changing a user\\'s password should invalidate sessions for that user', async function () {\n    const jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'HarryPutter',\n        password: 'crookshanks',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n    const req = apos.task.getReq();\n    let user = await apos.user.find(req, {\n      username: 'HarryPutter'\n    }).toObject();\n    assert(user);\n    user.password = 'VeryPasswordManySecure🐶';\n    await apos.user.update(req, user);\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(!page.match(/logged in/));\n    assert(page.match(/logged out/));\n\n    // Make sure we can come back from that\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'HarryPutter',\n        password: 'VeryPasswordManySecure🐶',\n        session: true\n      },\n      jar\n    });\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n\n    // So we do not have a stale _passwordUpdated flag\n    user = await apos.user.find(req, {\n      _id: user._id\n    }).toObject();\n\n    // Unrelated writes to user should not invalidate sessions\n    user.title = 'Extra Cool Putter';\n    await apos.user.update(req, user);\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n\n    // Marking a user account as disabled should invalidate sessions\n    user.disabled = true;\n    await apos.user.update(req, user);\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n\n    // Restore access for next test\n    user.disabled = false;\n    await apos.user.update(req, user);\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"changing a user's password should invalidate bearer tokens for that user","suites":["Login"],"updatePoint":{"line":257,"column":79,"index":7247},"line":257,"code":"  it('changing a user\\'s password should invalidate bearer tokens for that user', async function () {\n    // Log in\n    let response = await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'HarryPutter',\n        password: 'VeryPasswordManySecure🐶'\n      }\n    });\n    assert(response.token);\n    let token = response.token;\n\n    // For verification: can't do this without an admin bearer token\n    await apos.http.get('/api/v1/@apostrophecms/user', {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    const req = apos.task.getReq();\n    const user = await apos.user.find(req, {\n      username: 'HarryPutter'\n    }).toObject();\n    assert(user);\n    user.password = 'AnotherLovelyPassword';\n    await apos.user.update(req, user);\n    let failed = false;\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/user', {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      // Should NOT work\n      assert(false);\n    } catch (e) {\n      failed = true;\n      assert.strictEqual(e.status, 401);\n    }\n    assert(failed);\n\n    // Make sure we can come back from that\n    response = await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'HarryPutter',\n        password: 'AnotherLovelyPassword'\n      }\n    });\n    assert(response.token);\n    token = response.token;\n    await apos.http.get('/api/v1/@apostrophecms/user', {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"api key should beat session when both are present","suites":["Login"],"updatePoint":{"line":311,"column":55,"index":8766},"line":311,"code":"  it('api key should beat session when both are present', async function () {\n    const jar = apos.http.jar();\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      method: 'POST',\n      body: {\n        username: 'BobSmith',\n        password: 'bobsmith',\n        session: true\n      },\n      jar\n    });\n    const page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n    assert(page.match(/Bob Smith/));\n    const page2 = await apos.http.get('/', {\n      jar,\n      headers: {\n        Authorization: 'ApiKey adminApiKey'\n      }\n    });\n    assert(page2.match(/logged in/));\n    assert(!page2.match(/Bob Smith/));\n    assert(page2.match(/System Task/));\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should validate POST /login/reset-request","suites":["Login"],"updatePoint":{"line":337,"column":47,"index":9471},"line":337,"code":"  it('should validate POST /login/reset-request', async function () {\n    const jar = apos.http.jar();\n    await apos.http.get('/', {\n      jar\n    });\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset-request', {\n      body: {\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should hide sensitive exceptions POST /login/reset-request","suites":["Login"],"updatePoint":{"line":351,"column":64,"index":9831},"line":351,"code":"  it('should hide sensitive exceptions POST /login/reset-request', async function () {\n    let log;\n    const orig = apos.util.error;\n    apos.util.error = m => {\n      log = m;\n    };\n    const jar = apos.http.jar();\n    await apos.http.get('/', {\n      jar\n    });\n    await apos.http.post('/api/v1/@apostrophecms/login/reset-request', {\n      body: {\n        email: 'invalidUser',\n        session: true\n      },\n      jar\n    });\n    assert.match(log, /invalidUser/);\n    const user = apos.user.newInstance();\n    user.title = 'noEmail';\n    user.username = 'noEmail';\n    user.password = 'secret';\n    user.role = 'guest';\n    await apos.user.insert(apos.task.getReq(), user);\n    await apos.http.post('/api/v1/@apostrophecms/login/reset-request', {\n      body: {\n        email: 'noEmail',\n        session: true\n      },\n      jar\n    });\n    assert.match(log, /noEmail/);\n    apos.util.error = orig;\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should reset password POST /login/reset-request (request)","suites":["Login"],"updatePoint":{"line":385,"column":63,"index":10741},"line":385,"code":"  it('should reset password POST /login/reset-request (request)', async function () {\n    let args;\n    const orig = apos.login.email;\n    apos.login.email = (req, ...a) => {\n      args = a;\n    };\n    const jar = apos.http.jar();\n    await apos.http.get('/', {\n      jar\n    });\n    let user = apos.user.newInstance();\n    user.title = 'resetUser';\n    user.email = 'resetUser@example.com';\n    user.username = 'resetUser';\n    user.password = 'secret';\n    user.role = 'guest';\n    user = await apos.user.insert(apos.task.getReq(), user);\n    resetUserId = user._id;\n    await apos.http.post('/api/v1/@apostrophecms/login/reset-request', {\n      body: {\n        email: 'resetUser',\n        session: true\n      },\n      jar\n    });\n    {\n      assert(Array.isArray(args));\n      const [template, data, opts] = args;\n      assert(template);\n      assert.deepEqual(data.user._id, user._id);\n      assert(data.user.passwordResetAt);\n      assert.match(data.url, /\\/login\\?reset=/);\n      assert.match(data.url, /&email=/);\n      assert(data.site);\n      assert.equal(opts.to, user.email);\n      assert(opts.subject);\n    }\n    await apos.http.post('/api/v1/@apostrophecms/login/reset-request', {\n      body: {\n        email: 'resetUser@example.com',\n        session: true\n      },\n      jar\n    });\n    {\n      assert(Array.isArray(args));\n      const [template, data, opts] = args;\n      assert(template);\n      assert.deepEqual(data.user._id, user._id);\n      assert(data.user.passwordResetAt);\n      assert.match(data.url, /\\/login\\?reset=/);\n      assert.match(data.url, /&email=/);\n      assert(data.site);\n      assert.equal(opts.to, user.email);\n      assert(opts.subject);\n\n      // Safe the token for the reset tests\n      const url = new URL(data.url);\n      resetToken = url.searchParams.get('reset');\n    }\n    apos.login.email = orig;\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should reset password GET /login/reset (validate)","suites":["Login"],"updatePoint":{"line":447,"column":55,"index":12585},"line":447,"code":"  it('should reset password GET /login/reset (validate)', async function () {\n    const user = await apos.doc.db.findOne({\n      _id: resetUserId\n    });\n\n    // Fail\n    await assert.rejects(() => apos.http.get('/api/v1/@apostrophecms/login/reset', {\n      qs: {}\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.get('/api/v1/@apostrophecms/login/reset', {\n      qs: {\n        reset: 'invalid',\n        email: user.username\n      }\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.get('/api/v1/@apostrophecms/login/reset', {\n      qs: {\n        reset: resetToken,\n        email: 'invalid'\n      }\n    }), {\n      status: 400\n    });\n\n    // Success\n    await apos.http.get('/api/v1/@apostrophecms/login/reset', {\n      qs: {\n        reset: resetToken,\n        email: user.username\n      }\n    });\n    await apos.http.get('/api/v1/@apostrophecms/login/reset', {\n      qs: {\n        reset: resetToken,\n        email: user.email\n      }\n    });\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should reset password POST /login/reset (validate & reset)","suites":["Login"],"updatePoint":{"line":489,"column":64,"index":13599},"line":489,"code":"  it('should reset password POST /login/reset (validate & reset)', async function () {\n    const jar = apos.http.jar();\n    const user = await apos.doc.db.findOne({\n      _id: resetUserId\n    });\n    await apos.http.get('/', {\n      jar\n    });\n\n    // Validate\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        reset: 'invalid',\n        email: user.email,\n        password: 'new more secret',\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        reset: resetToken,\n        email: 'invalid',\n        password: 'new more secret',\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        reset: resetToken,\n        email: user.email,\n        password: '',\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        // explicit check for boolean cheat!\n        reset: false,\n        email: user.email,\n        password: 'new more secret',\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n\n    // Reset\n    await apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        reset: resetToken,\n        email: user.email,\n        password: 'new more secret',\n        session: true\n      },\n      jar\n    });\n\n    // Can not reset anymore\n    await assert.rejects(() => apos.http.post('/api/v1/@apostrophecms/login/reset', {\n      body: {\n        reset: resetToken,\n        email: user.email,\n        password: 'new even more secret',\n        session: true\n      },\n      jar\n    }), {\n      status: 400\n    });\n\n    // Login with the new password\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: user.email,\n        password: 'new more secret',\n        session: true\n      },\n      jar\n    });\n    const page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should find user by reset data","suites":["Login"],"updatePoint":{"line":591,"column":36,"index":15977},"line":591,"code":"  it('should find user by reset data', async function () {\n    let user = apos.user.newInstance();\n    user.title = 'getResetUser';\n    user.email = 'getResetUser@example.com';\n    user.username = 'getResetUser';\n    user.password = 'secret';\n    user.role = 'guest';\n    user = await apos.user.insert(apos.task.getReq(), user);\n\n    // Find by email\n    {\n      const found = await apos.login.getPasswordResetUser(user.email);\n      assert.equal(found._id, user._id);\n    }\n    // Find by username\n    {\n      const found = await apos.login.getPasswordResetUser(user.username);\n      assert.equal(found._id, user._id);\n    }\n    // Fail with no token\n    await assert.rejects(() => apos.login.getPasswordResetUser(user.username, ''), {\n      message: 'invalid'\n    });\n    await assert.rejects(() => apos.login.getPasswordResetUser(user.username, null), {\n      message: 'invalid'\n    });\n    await assert.rejects(() => apos.login.getPasswordResetUser(user.username, 'invalid'), {\n      message: 'notfound'\n    });\n    user.passwordReset = 'secret';\n    user.passwordResetAt = new Date();\n    user = await apos.user.update(apos.task.getReq(), user);\n    // Find by email and validate token\n    {\n      const found = await apos.login.getPasswordResetUser(user.email, 'secret');\n      assert.equal(found._id, user._id);\n    }\n    // // Find by username and validate token\n    {\n      const found = await apos.login.getPasswordResetUser(user.username, 'secret');\n      assert.equal(found._id, user._id);\n    }\n    await assert.rejects(() => apos.login.getPasswordResetUser(user.username, 'invalid'), {\n      message: 'Incorrect passwordReset'\n    });\n\n    // Expired\n    user.passwordResetAt = new Date(0);\n    user = await apos.user.update(apos.task.getReq(), user);\n    await assert.rejects(() => apos.login.getPasswordResetUser(user.username, 'invalid'), {\n      message: 'notfound'\n    });\n  });","file":"login.js","skipped":false,"dir":"test"},{"name":"should stand up","suites":["Middleware and Route Order"],"updatePoint":{"line":9,"column":21,"index":250},"line":9,"code":"  it('should stand up', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        first: {\n          middleware(self) {\n            return {\n              firstMiddleware(req, res, next) {\n                req.firstMiddlewareRan = true;\n                return next();\n              }\n            };\n          }\n        },\n        second: {\n          middleware(self) {\n            return {\n              secondMiddleware(req, res, next) {\n                req.secondMiddlewareRan = true;\n                return next();\n              }\n            };\n          }\n        },\n        third: {\n          middleware(self) {\n            return {\n              thirdMiddleware(req, res, next) {\n                req.thirdMiddlewareRan = true;\n                return next();\n              }\n            };\n          },\n          apiRoutes(self) {\n            return {\n              get: {\n                thirdRouteA(req) {\n                  return {\n                    firstMiddlewareRan: req.firstMiddlewareRan,\n                    secondMiddlewareRan: req.secondMiddlewareRan,\n                    thirdMiddlewareRan: req.thirdMiddlewareRan\n                  };\n                },\n                thirdRouteB: {\n                  before: 'middleware:second',\n                  route(req) {\n                    return {\n                      firstMiddlewareRan: req.firstMiddlewareRan,\n                      secondMiddlewareRan: req.secondMiddlewareRan,\n                      thirdMiddlewareRan: req.thirdMiddlewareRan\n                    };\n                  }\n                }\n              }\n            };\n          }\n        }\n      }\n    });\n  });","file":"middleware-and-route-order.js","skipped":false,"dir":"test"},{"name":"should hit all middleware in thirdRouteA","suites":["Middleware and Route Order"],"updatePoint":{"line":69,"column":46,"index":1956},"line":69,"code":"  it('should hit all middleware in thirdRouteA', async function () {\n    const result = await apos.http.get('/api/v1/third/third-route-a');\n    assert(result.firstMiddlewareRan);\n    assert(result.secondMiddlewareRan);\n    assert(result.thirdMiddlewareRan);\n  });","file":"middleware-and-route-order.js","skipped":false,"dir":"test"},{"name":"should hit only the first middleware in thirdRouteB","suites":["Middleware and Route Order"],"updatePoint":{"line":75,"column":57,"index":2231},"line":75,"code":"  it('should hit only the first middleware in thirdRouteB', async function () {\n    const result = await apos.http.get('/api/v1/third/third-route-b');\n    assert(result.firstMiddlewareRan);\n    assert(!result.secondMiddlewareRan);\n    assert(!result.thirdMiddlewareRan);\n  });","file":"middleware-and-route-order.js","skipped":false,"dir":"test"},{"name":"should exist","suites":["moog"],"updatePoint":{"line":3,"column":18,"index":84},"line":3,"code":"  it('should exist', function () {\n    const moog = require('../lib/moog.js')({});\n    assert(moog);\n  });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should be initialized without arguments","suites":["moog"],"updatePoint":{"line":7,"column":45,"index":218},"line":7,"code":"  it('should be initialized without arguments', function () {\n    const moog = require('../lib/moog.js')();\n    assert(moog);\n  });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should have a `define` method","suites":["moog","methods"],"updatePoint":{"line":12,"column":37,"index":378},"line":12,"code":"    it('should have a `define` method', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.define);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should have a `redefine` method","suites":["moog","methods"],"updatePoint":{"line":16,"column":39,"index":519},"line":16,"code":"    it('should have a `redefine` method', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.redefine);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should have a `create` method","suites":["moog","methods"],"updatePoint":{"line":20,"column":37,"index":660},"line":20,"code":"    it('should have a `create` method', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.create);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should have an `isDefined` method","suites":["moog","methods"],"updatePoint":{"line":24,"column":41,"index":803},"line":24,"code":"    it('should have an `isDefined` method', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.isDefined);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should be able to `define` a class","suites":["moog","defining and creating"],"updatePoint":{"line":30,"column":42,"index":1006},"line":30,"code":"    it('should be able to `define` a class', function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        methods(self) {\n          return {};\n        }\n      });\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should be able to `define` and then `create` an instance","suites":["moog","defining and creating"],"updatePoint":{"line":38,"column":64,"index":1242},"line":38,"code":"    it('should be able to `define` and then `create` an instance', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        options: {\n          color: 'blue'\n        },\n        init(self) {\n          self.color = self.options.color;\n        }\n      });\n      const myObject = await moog.create('myObject', {});\n      assert(myObject);\n      assert(myObject.color === 'blue');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should `create` without options","suites":["moog","`create` syntax"],"updatePoint":{"line":54,"column":39,"index":1705},"line":54,"code":"    it('should `create` without options', async function () {\n      const moog = require('../lib/moog.js')();\n      moog.define('myClass', {});\n      const myObj = await moog.create('myClass');\n      assert(myObj);\n      assert(myObj.__meta.name === 'myClass');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should be able to create a subclass with expected default option behavior (async)","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":63,"column":89,"index":2089},"line":63,"code":"    it('should be able to create a subclass with expected default option behavior (async)', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('baseClass', {\n        options: {\n          color: 'blue'\n        }\n      });\n      moog.define('subClass', {\n        options: {\n          color: 'red'\n        },\n        extend: 'baseClass'\n      });\n      const myObject = await moog.create('subClass', {});\n      assert(myObject);\n      assert(myObject.options.color === 'red');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should report an error gracefully if subclass to be extended does not exist (async)","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":80,"column":91,"index":2610},"line":80,"code":"    it('should report an error gracefully if subclass to be extended does not exist (async)', async function () {\n      const moog = require('../lib/moog.js')({});\n\n      // base class does not actually exist\n      moog.define('subClass', {\n        options: {\n          color: 'red'\n        },\n        extend: 'baseClass'\n      });\n      try {\n        await moog.create('subClass', {});\n        assert(false);\n      } catch (e) {\n        assert(e);\n        assert(e.toString().match(/baseClass/));\n      }\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should be able to `extend` a subclass into yet another subclass","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":98,"column":71,"index":3104},"line":98,"code":"    it('should be able to `extend` a subclass into yet another subclass', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('baseClass', {\n        options: {\n          color: 'blue'\n        }\n      });\n      moog.define('subClassOne', {\n        options: {\n          color: 'red'\n        },\n        extend: 'baseClass'\n      });\n      moog.define('subClassTwo', {\n        options: {\n          color: 'green'\n        },\n        extend: 'subClassOne'\n      });\n      const myObject = await moog.create('subClassTwo', {});\n      assert(myObject);\n      assert(myObject.options.color === 'green');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"default base class should take effect if configured","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":121,"column":59,"index":3731},"line":121,"code":"    it('default base class should take effect if configured', async function () {\n      const moog = require('../lib/moog.js')({\n        defaultBaseClass: 'baseClass'\n      });\n      moog.define('baseClass', {\n        init(self) {\n          assert(self.__meta);\n          assert(self.__meta.chain);\n          assert(self.__meta.chain[0]);\n          assert(self.__meta.chain[0].name === 'baseClass');\n          assert(self.__meta.chain[1].name === 'subClass');\n          assert(self.__meta.name === 'subClass');\n          self.color = self.options.color;\n        }\n      });\n      moog.define('subClass', {\n        options: {\n          color: 'red'\n        }\n      });\n      const myObject = await moog.create('subClass', {});\n      assert(myObject);\n      // This verifies that init() for base class actually ran\n      assert(myObject.color === 'red');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"default base class should not take effect if extend is explicitly set to false","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":146,"column":86,"index":4619},"line":146,"code":"    it('default base class should not take effect if extend is explicitly set to false', async function () {\n      const moog = require('../lib/moog.js')({\n        defaultBaseClass: 'baseClass'\n      });\n      moog.define('baseClass', {\n        construct: function (self) {\n          self.based = true;\n        }\n      });\n      moog.define('subClass', {\n        options: {\n          color: 'red'\n        },\n        extend: false\n      });\n      const myObject = await moog.create('subClass', {});\n      assert(myObject);\n      assert(!myObject.based);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should define methods and allow overriding and extending them through implicit subclassing","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":165,"column":98,"index":5192},"line":165,"code":"    it('should define methods and allow overriding and extending them through implicit subclassing', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        methods(self) {\n          return {\n            basic() {\n              return true;\n            },\n            overridden() {\n              return false;\n            },\n            extended(times) {\n              return 2 * times;\n            }\n          };\n        }\n      });\n      moog.define('myObject', {\n        methods(self) {\n          return {\n            overridden() {\n              return true;\n            }\n          };\n        },\n        extendMethods(self) {\n          return {\n            extended(_super, times) {\n              return _super(times) * 2;\n            }\n          };\n        }\n      });\n      const myObject = await moog.create('myObject', {});\n      assert(myObject);\n      assert(myObject.basic());\n      assert(myObject.overridden());\n      assert(myObject.extended(5) === 20);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should support inheriting field group fields rather than requiring all fields to be restated","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":204,"column":100,"index":6226},"line":204,"code":"    it('should support inheriting field group fields rather than requiring all fields to be restated', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        cascades: ['fields'],\n        fields: {\n          add: {\n            one: {\n              type: 'string'\n            },\n            two: {\n              type: 'string'\n            },\n            three: {\n              type: 'string'\n            }\n          },\n          group: {\n            basics: {\n              fields: ['one', 'two', 'three']\n            }\n          }\n        }\n      });\n      moog.define('myObject', {\n        fields: {\n          add: {\n            four: {\n              type: 'string'\n            },\n            five: {\n              type: 'string'\n            }\n          },\n          group: {\n            basics: {\n              fields: ['four', 'five']\n            },\n            other: {\n              fields: ['one']\n            }\n          }\n        }\n      });\n      const myObject = await moog.create('myObject', {});\n      assert(myObject);\n      assert(myObject.fieldsGroups);\n      assert(!myObject.fieldsGroups.basics.fields.includes('one'));\n      assert(myObject.fieldsGroups.other.fields.includes('one'));\n      assert(myObject.fieldsGroups.basics.fields.includes('two'));\n      assert(myObject.fieldsGroups.basics.fields.includes('three'));\n      assert(myObject.fieldsGroups.basics.fields.includes('four'));\n      assert(myObject.fieldsGroups.basics.fields.includes('five'));\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should order fields with the last option unless the order array overrides","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":257,"column":81,"index":7745},"line":257,"code":"    it('should order fields with the last option unless the order array overrides', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('unorderedObject', {\n        cascades: ['fields'],\n        fields: {\n          add: {\n            first: {\n              type: 'string'\n            },\n            last: {\n              type: 'string',\n              last: true\n            },\n            second: {\n              type: 'string'\n            },\n            third: {\n              type: 'string'\n            }\n          }\n        }\n      });\n      moog.define('orderedObject', {\n        cascades: ['fields'],\n        fields: {\n          add: {\n            first: {\n              type: 'string'\n            },\n            last: {\n              type: 'string',\n              last: true\n            },\n            second: {\n              type: 'string'\n            },\n            third: {\n              type: 'string'\n            }\n          },\n          order: ['last', 'third', 'second', 'first']\n        }\n      });\n      const unordered = await moog.create('unorderedObject', {});\n      assert(unordered);\n      assert(Object.keys(unordered.fields)[0] === 'first');\n      assert(Object.keys(unordered.fields)[1] === 'second');\n      assert(Object.keys(unordered.fields)[2] === 'third');\n      assert(Object.keys(unordered.fields)[3] === 'last');\n      const ordered = await moog.create('orderedObject', {});\n      assert(ordered);\n      assert(Object.keys(ordered.fields)[0] === 'last');\n      assert(Object.keys(ordered.fields)[1] === 'third');\n      assert(Object.keys(ordered.fields)[2] === 'second');\n      assert(Object.keys(ordered.fields)[3] === 'first');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should allow a module to be redefined","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":318,"column":45,"index":9566},"line":318,"code":"    it('should allow a module to be redefined', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        methods(self) {\n          return {\n            oldMethod() {}\n          };\n        }\n      });\n      moog.redefine('myObject', {\n        methods(self) {\n          return {\n            newMethod() {}\n          };\n        }\n      });\n      const myObject = await moog.create('myObject', {});\n      assert(myObject);\n      assert(!myObject.oldMethod);\n      assert(myObject.newMethod);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should find a module definition using `isDefined`","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":339,"column":57,"index":10127},"line":339,"code":"    it('should find a module definition using `isDefined`', function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {});\n      assert(moog.isDefined('myObject'));\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should NOT find a non-existant module definition using `isDefined`","suites":["moog","explicit subclassing behavior"],"updatePoint":{"line":344,"column":74,"index":10353},"line":344,"code":"    it('should NOT find a non-existant module definition using `isDefined`', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(!moog.isDefined('myObject'));\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should allow a class defined twice to be implicitly subclassed","suites":["moog","implicit subclassing behavior"],"updatePoint":{"line":350,"column":70,"index":10605},"line":350,"code":"    it('should allow a class defined twice to be implicitly subclassed', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('myObject', {\n        init(self) {\n          self.order = (self.order || []).concat('first');\n        }\n      });\n      moog.define('myObject', {\n        init(self) {\n          self.order = (self.order || []).concat('second');\n        }\n      });\n      const myObject = await moog.create('myObject', {});\n      assert(myObject);\n      assert(myObject.order[0] === 'first');\n      assert(myObject.order[1] === 'second');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should call `init` methods baseClass-first","suites":["moog","order of operations"],"updatePoint":{"line":373,"column":50,"index":11361},"line":373,"code":"    it('should call `init` methods baseClass-first', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('baseClass', {\n        init(self) {\n          self.order = (self.order || []).concat('first');\n        }\n      });\n      moog.define('subClassOne', {\n        extend: 'baseClass',\n        init(self) {\n          self.order = (self.order || []).concat('second');\n        }\n      });\n      moog.define('subClassTwo', {\n        extend: 'subClassOne',\n        init(self) {\n          self.order = (self.order || []).concat('third');\n        }\n      });\n      const subClassTwo = await moog.create('subClassTwo', {});\n      assert(subClassTwo.order[0] === 'first');\n      assert(subClassTwo.order[1] === 'second');\n      assert(subClassTwo.order[2] === 'third');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should call `beforeSuperClass` methods subClass-first","suites":["moog","order of operations"],"updatePoint":{"line":397,"column":61,"index":12176},"line":397,"code":"    it('should call `beforeSuperClass` methods subClass-first', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('baseClass', {\n        beforeSuperClass(self) {\n          self.options.order = (self.options.order || []).concat('third');\n        }\n      });\n      moog.define('subClassOne', {\n        extend: 'baseClass',\n        beforeSuperClass(self) {\n          self.options.order = (self.options.order || []).concat('second');\n        }\n      });\n      moog.define('subClassTwo', {\n        extend: 'subClassOne',\n        beforeSuperClass(self) {\n          self.options.order = (self.options.order || []).concat('first');\n        }\n      });\n      const subClassTwo = await moog.create('subClassTwo', {});\n      assert(subClassTwo.options.order[0] === 'first');\n      assert(subClassTwo.options.order[1] === 'second');\n      assert(subClassTwo.options.order[2] === 'third');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should report an error on a cyclical reference (extend in a loop)","suites":["moog","odds and ends"],"updatePoint":{"line":428,"column":73,"index":13370},"line":428,"code":"    it('should report an error on a cyclical reference (extend in a loop)', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('classOne', {\n        extend: 'classTwo'\n      });\n      moog.define('classTwo', {\n        extend: 'classOne'\n      });\n      let e;\n      let classOne;\n      try {\n        classOne = await moog.create('classOne', {});\n      } catch (_e) {\n        e = _e;\n      }\n      assert(e);\n      assert(!classOne);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should report an error asynchronously when creating a nonexistent type asynchronously","suites":["moog","odds and ends"],"updatePoint":{"line":446,"column":93,"index":13868},"line":446,"code":"    it('should report an error asynchronously when creating a nonexistent type asynchronously', async function () {\n      const moog = require('../lib/moog.js')({});\n      try {\n        await moog.create('nonesuch');\n        assert(false);\n      } catch (e) {\n        assert(true);\n      }\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"instanceOf should yield correct results","suites":["moog","odds and ends"],"updatePoint":{"line":455,"column":47,"index":14120},"line":455,"code":"    it('instanceOf should yield correct results', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('classOne', {});\n      moog.define('classTwo', {\n        extend: 'classOne'\n      });\n      moog.define('classThree', {});\n      moog.define('classFour', {\n        extend: 'classTwo'\n      });\n      const one = await moog.create('classOne');\n      const two = await moog.create('classTwo');\n      const three = await moog.create('classThree');\n      const four = await moog.create('classFour');\n      const rando = {\n        strange: 'object'\n      };\n      assert(moog.instanceOf(one, 'classOne'));\n      assert(moog.instanceOf(two, 'classOne'));\n      assert(!moog.instanceOf(three, 'classOne'));\n      assert(moog.instanceOf(four, 'classOne'));\n      assert(!moog.instanceOf(rando, 'classOne'));\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"sanity check of await behavior","suites":["moog","odds and ends"],"updatePoint":{"line":478,"column":38,"index":14956},"line":478,"code":"    it('sanity check of await behavior', async function () {\n      const moog = require('../lib/moog.js')({});\n      moog.define('classOne', {\n        async init(self) {\n          await delay(100);\n          self.size = 1;\n        }\n      });\n      moog.define('classTwo', {\n        extend: 'classOne',\n        async init(self) {\n          await delay(1);\n          self.size = 2;\n        }\n      });\n      assert((await moog.create('classTwo', {})).size === 2);\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"isMy behaves sensibly","suites":["moog","odds and ends"],"updatePoint":{"line":495,"column":29,"index":15418},"line":495,"code":"    it('isMy behaves sensibly', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.isMy('my-foo'));\n      assert(!moog.isMy('foo'));\n      assert(moog.isMy('@namespace/my-foo'));\n      assert(!moog.isMy('@namespace/foo'));\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"originalToMy behaves sensibly","suites":["moog","odds and ends"],"updatePoint":{"line":502,"column":37,"index":15688},"line":502,"code":"    it('originalToMy behaves sensibly', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.originalToMy('foo') === 'my-foo');\n      assert(moog.originalToMy('@namespace/foo') === '@namespace/my-foo');\n      // originalToMy is not guaranteed to do anything specific with\n      // names that already have my-\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"myToOriginal behaves sensibly","suites":["moog","odds and ends"],"updatePoint":{"line":510,"column":37,"index":16035},"line":510,"code":"    it('myToOriginal behaves sensibly', function () {\n      const moog = require('../lib/moog.js')({});\n      assert(moog.myToOriginal('my-foo') === 'foo');\n      assert(moog.myToOriginal('foo') === 'foo');\n      assert(moog.myToOriginal('@namespace/my-foo') === '@namespace/foo');\n      assert(moog.myToOriginal('@namespace/foo') === '@namespace/foo');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"routes should work, including extending routes","suites":["moog","sections should work"],"updatePoint":{"line":519,"column":54,"index":16469},"line":519,"code":"    it('routes should work, including extending routes', async function () {\n      const moog = require('../lib/moog.js')({\n        sections: ['routes']\n      });\n      moog.define('baseclass', {\n        routes(self) {\n          return {\n            post: {\n              async insert(req) {\n                return 'inserted';\n              },\n              async list(req) {\n                return 'listed';\n              }\n            }\n          };\n        }\n      });\n      moog.define('subclass', {\n        extend: 'baseclass',\n        routes(self) {\n          return {\n            post: {\n              async remove(req) {\n                return 'removed';\n              },\n              floss: [(req, res, next) => {\n                req.seen = true;\n                next();\n              }, req => 'flossed']\n            }\n          };\n        },\n        extendRoutes(self) {\n          return {\n            post: {\n              async list(_super, req) {\n                return (await _super(req)) + '-suffix';\n              },\n              async floss(_super, req) {\n                return (await _super(req)) + '-daily';\n              }\n            }\n          };\n        }\n      });\n      const instance = await moog.create('subclass', {});\n      assert(instance);\n      assert((await instance.routes.post.insert({})) === 'inserted');\n      assert((await instance.routes.post.list({})) === 'listed-suffix');\n      assert((await instance.routes.post.remove({})) === 'removed');\n      const req = {};\n      const floss = await instance.routes.post.floss;\n      // We are not here to reimplement middleware, just to verify\n      // the chain is there and would work\n      assert(typeof floss[0] === 'function');\n      floss[0](req, {}, function () {});\n      assert(req.seen);\n      assert((await floss[1](req)) === 'flossed-daily');\n    });","file":"moog.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Oembed"],"updatePoint":{"line":14,"column":23,"index":265},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.modules['@apostrophecms/oembed']);\n    assert(apos.oembed.__meta.name === '@apostrophecms/oembed');\n  });","file":"oembed.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["page-type"],"updatePoint":{"line":14,"column":23,"index":272},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'nifty-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    assert(apos && apos.__meta.name === 'apostrophe');\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should fire a dispatch route for its homepage","suites":["page-type"],"updatePoint":{"line":25,"column":51,"index":567},"line":25,"code":"  it('should fire a dispatch route for its homepage', async function () {\n    const niftyPages = apos.modules['nifty-page'];\n    niftyPages.dispatch('/', async function (req) {\n      req.handlerInvoked = true;\n      niftyPages.setTemplate(req, 'index');\n    });\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: {\n          type: 'nifty-page'\n        }\n      },\n      remainder: '/'\n    });\n    await apos.page.emit('serve', req);\n    assert(req.handlerInvoked);\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should fire a dispatch route matching a second, longer URL","suites":["page-type"],"updatePoint":{"line":43,"column":64,"index":1101},"line":43,"code":"  it('should fire a dispatch route matching a second, longer URL', async function () {\n    const niftyPages = apos.modules['nifty-page'];\n    niftyPages.dispatch('/foo', async function (req) {\n      req.handlerInvoked = true;\n      niftyPages.setTemplate(req, 'foo');\n    });\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: {\n          type: 'nifty-page'\n        }\n      },\n      remainder: '/foo'\n    });\n    await apos.page.emit('serve', req);\n    assert(req.handlerInvoked);\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should fire a dispatch route with parameters","suites":["page-type"],"updatePoint":{"line":61,"column":50,"index":1625},"line":61,"code":"  it('should fire a dispatch route with parameters', async function () {\n    const niftyPages = apos.modules['nifty-page'];\n    niftyPages.dispatch('/bar/:bizzle/:kapow/*', async function (req) {\n      req.barInvoked = true;\n      niftyPages.setTemplate(req, 'bar');\n    });\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: {\n          type: 'nifty-page'\n        }\n      },\n      remainder: '/bar/wacky/wonky/wibble/skip'\n    });\n    await apos.page.emit('serve', req);\n    assert(req.barInvoked);\n    assert(req.params.bizzle === 'wacky');\n    assert(req.params.kapow === 'wonky');\n    assert(req.params[0] === 'wibble/skip');\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should allow a later call to dispatch to override an earlier dispatch route","suites":["page-type"],"updatePoint":{"line":82,"column":81,"index":2343},"line":82,"code":"  it('should allow a later call to dispatch to override an earlier dispatch route', async function () {\n    const niftyPages = apos.modules['nifty-page'];\n    await niftyPages.dispatch('/foo', function (req) {\n      req.foo2Invoked = true;\n      niftyPages.setTemplate(req, 'foo2');\n    });\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: {\n          type: 'nifty-page'\n        }\n      },\n      remainder: '/foo'\n    });\n    await apos.page.emit('serve', req);\n    assert(req.foo2Invoked);\n    assert(!req.fooInvoked);\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should not match when page type is wrong","suites":["page-type"],"updatePoint":{"line":101,"column":46,"index":2887},"line":101,"code":"  it('should not match when page type is wrong', async function () {\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: {\n          type: 'wibble-page'\n        }\n      },\n      remainder: '/foo'\n    });\n    await apos.page.emit('serve', req);\n    assert(!req.foo2Invoked);\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should not match when there is no bestPage","suites":["page-type"],"updatePoint":{"line":114,"column":48,"index":3219},"line":114,"code":"  it('should not match when there is no bestPage', async function () {\n    // Simulate a page request\n    const req = apos.task.getAnonReq({\n      data: {\n        bestPage: null\n      },\n      remainder: '/foo'\n    });\n    await apos.page.emit('serve', req);\n    assert(!req.foo2Invoked);\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should be able to insert a test page manually into the db","suites":["page-type"],"updatePoint":{"line":125,"column":63,"index":3529},"line":125,"code":"  it('should be able to insert a test page manually into the db', async function () {\n    const testItem = {\n      _id: 'niftyPages1',\n      type: 'nifty-page',\n      slug: '/niftyPages',\n      visibility: 'public',\n      path: '/niftyPages',\n      level: 1,\n      rank: 5,\n      archived: false\n    };\n    const response = await apos.doc.db.insertOne(testItem);\n    assert(response.insertedCount === 1);\n    assert(response.ops[0]._id === 'niftyPages1');\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should match a dispatch route on a real live page request","suites":["page-type"],"updatePoint":{"line":140,"column":63,"index":3991},"line":140,"code":"  it('should match a dispatch route on a real live page request', async function () {\n    const body = await apos.http.get('/niftyPages');\n    // Did we get the index output?\n    assert(body.match(/niftyPages-index-template-rendered-this/));\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"runs foo route with /foo remainder","suites":["page-type"],"updatePoint":{"line":145,"column":40,"index":4216},"line":145,"code":"  it('runs foo route with /foo remainder', async function () {\n    const body = await apos.http.get('/niftyPages/foo');\n    // Did we get the foo output?\n    assert(body.match(/niftyPages-foo2-template-rendered-this/));\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"yields 404 with bad remainder (not matching any dispatch routes)","suites":["page-type"],"updatePoint":{"line":150,"column":70,"index":4472},"line":150,"code":"  it('yields 404 with bad remainder (not matching any dispatch routes)', async function () {\n    try {\n      await apos.http.get('/niftyPages/tututu');\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n  });","file":"page-type.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Pages Public API"],"updatePoint":{"line":14,"column":45,"index":301},"line":14,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [],\n            types: [{\n              name: '@apostrophecms/home-page',\n              label: 'Home'\n            }, {\n              name: 'test-page',\n              label: 'Test Page'\n            }]\n          }\n        },\n        'test-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    assert(apos.page.__meta.name === '@apostrophecms/page');\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"cannot GET the home page without session without publicApiProjection","suites":["Pages Public API"],"updatePoint":{"line":37,"column":74,"index":919},"line":37,"code":"  it('cannot GET the home page without session without publicApiProjection', async function () {\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/page', {});\n      // Getting here would be bad\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"can GET the home page without session with publicApiProjection","suites":["Pages Public API"],"updatePoint":{"line":46,"column":68,"index":1200},"line":46,"code":"  it('can GET the home page without session with publicApiProjection', async function () {\n    // Patch the option to simplify test\n    apos.page.options.publicApiProjection = {\n      title: 1,\n      _url: 1,\n      path: 1,\n      level: 1,\n      rank: 1\n    };\n    const home = await apos.http.get('/api/v1/@apostrophecms/page', {});\n    assert(home);\n    // But projection did apply\n    assert(!home.searchSummary);\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"should not set a \"max-age\" cache-control value when retrieving pages, when cache option is not set, with a public API projection","suites":["Pages Public API"],"updatePoint":{"line":60,"column":134,"index":1689},"line":60,"code":"  it('should not set a \"max-age\" cache-control value when retrieving pages, when cache option is not set, with a public API projection', async function () {\n    apos.page.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${response1.body._id}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"should not set a \"max-age\" cache-control value when retrieving a single page, when \"etags\" cache option is set, with a public API projection","suites":["Pages Public API"],"updatePoint":{"line":74,"column":146,"index":2309},"line":74,"code":"  it('should not set a \"max-age\" cache-control value when retrieving a single page, when \"etags\" cache option is set, with a public API projection', async function () {\n    apos.page.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${response1.body._id}`, {\n      fullResponse: true\n    });\n    assert(response2.headers['cache-control'] === undefined);\n    delete apos.page.options.cache;\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"should set a \"max-age\" cache-control value when retrieving pages, with a public API projection","suites":["Pages Public API"],"updatePoint":{"line":94,"column":100,"index":2959},"line":94,"code":"  it('should set a \"max-age\" cache-control value when retrieving pages, with a public API projection', async function () {\n    apos.page.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${response1.body._id}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'max-age=1111');\n    assert(response2.headers['cache-control'] === 'max-age=1111');\n    delete apos.page.options.cache;\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"should set a custom etag when retrieving a single page","suites":["Pages Public API"],"updatePoint":{"line":114,"column":60,"index":3620},"line":114,"code":"  it('should set a custom etag when retrieving a single page', async function () {\n    apos.page.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${response1.body._id}`, {\n      fullResponse: true\n    });\n    const eTagParts = response2.headers.etag.split(':');\n    assert(eTagParts[0] === apos.asset.getReleaseId());\n    assert(eTagParts[1] === new Date(response2.body.cacheInvalidatedAt).getTime().toString());\n    assert(eTagParts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages-public-api.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Pages REST"],"updatePoint":{"line":31,"column":45,"index":695},"line":31,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            publicApiProjection: {\n              title: 1,\n              _url: 1,\n              path: 1,\n              level: 1,\n              rank: 1\n            },\n            park: [],\n            types: [{\n              name: '@apostrophecms/home-page',\n              label: 'Home'\n            }, {\n              name: 'test-page',\n              label: 'Test Page'\n            }]\n          }\n        },\n        'two-column-widget': {\n          extend: '@apostrophecms/widget-type',\n          options: {\n            label: 'Two Column'\n          },\n          fields: {\n            add: {\n              one: {\n                type: 'area',\n                contextual: true,\n                options: {\n                  widgets: areaConfig\n                }\n              },\n              two: {\n                type: 'area',\n                contextual: true,\n                options: {\n                  widgets: areaConfig\n                }\n              }\n            }\n          }\n        },\n        'test-page': {\n          extend: '@apostrophecms/page-type',\n          fields: {\n            add: {\n              color: {\n                type: 'string'\n              },\n              body: {\n                type: 'area',\n                options: {\n                  widgets: {\n                    '@apostrophecms/rich-text': {\n                      toolbar: ['bold', 'italic']\n                    },\n                    '@apostrophecms/image': {},\n                    '@apostrophecms/video': {},\n                    'two-column': {}\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n    assert(apos.page.__meta.name === '@apostrophecms/page');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be able to insert test users","suites":["Pages REST"],"updatePoint":{"line":105,"column":41,"index":2591},"line":105,"code":"  it('should be able to insert test users', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'admin';\n    user.username = 'admin';\n    user.password = 'admin';\n    user.email = 'ad@min.com';\n    user.role = 'admin';\n    await apos.user.insert(apos.task.getReq(), user);\n    const user2 = apos.user.newInstance();\n    assert(user2);\n    user2.title = 'admin2';\n    user2.username = 'admin2';\n    user2.password = 'admin2';\n    user2.email = 'ad@min2.com';\n    user2.role = 'admin';\n    return apos.user.insert(apos.task.getReq(), user2);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"REST: should be able to log in as admin","suites":["Pages REST"],"updatePoint":{"line":124,"column":45,"index":3221},"line":124,"code":"  it('REST: should be able to log in as admin', async function () {\n    jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n\n    // Log in\n\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n\n    // Confirm login\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can GET the home page without session","suites":["Pages REST"],"updatePoint":{"line":150,"column":43,"index":3757},"line":150,"code":"  it('can GET the home page without session', async function () {\n    const home = await apos.http.get('/api/v1/@apostrophecms/page', {});\n    assert(home);\n    assert(home.slug === '/');\n    // make sure new style paths used\n    assert(home.path !== '/');\n    assert(`${home.path}:en:published` === home._id);\n    assert(home.level === 0);\n    homeId = home._id;\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be able to use db to insert documents","suites":["Pages REST"],"updatePoint":{"line":160,"column":50,"index":4134},"line":160,"code":"  it('should be able to use db to insert documents', async function () {\n    const testItems = [{\n      _id: 'parent:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'parent',\n      type: 'test-page',\n      slug: '/parent',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent`,\n      level: 1,\n      rank: 0\n    }, {\n      _id: 'child:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'child',\n      slug: '/child',\n      type: 'test-page',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/child`,\n      level: 2,\n      rank: 0\n    }, {\n      _id: 'grandchild:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'grandchild',\n      type: 'test-page',\n      slug: '/grandchild',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/child/grandchild`,\n      level: 3,\n      rank: 0\n    }, {\n      _id: 'sibling:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'sibling',\n      type: 'test-page',\n      slug: '/sibling',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/sibling`,\n      level: 2,\n      rank: 1\n    }, {\n      _id: 'cousin:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'cousin',\n      type: 'test-page',\n      slug: '/cousin',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/sibling/cousin`,\n      level: 3,\n      rank: 0\n    }, {\n      _id: 'another-parent:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'another-parent',\n      type: 'test-page',\n      slug: '/another-parent',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/another-parent`,\n      level: 1,\n      rank: 1\n    }, {\n      _id: 'neighbor:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'neighbor',\n      type: 'test-page',\n      slug: '/neighbor',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/neighbor`,\n      level: 1,\n      rank: 2\n    }];\n\n    // Insert draft versions too to match the A3 data model\n    const draftItems = await apos.doc.db.insertMany(testItems.map(item => ({\n      ...item,\n      aposLocale: item.aposLocale.replace(':published', ':draft'),\n      _id: item._id.replace(':published', ':draft')\n    })));\n    assert(draftItems.result.ok === 1);\n    assert(draftItems.insertedCount === 7);\n\n    // Change the rank of the archive pages to preserve the constraint that it comes last\n    await apos.doc.db.updateMany({\n      type: '@apostrophecms/archive-page'\n    }, {\n      $set: {\n        rank: 3\n      }\n    });\n    const items = await apos.doc.db.insertMany(testItems);\n    assert(items.result.ok === 1);\n    assert(items.insertedCount === 7);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to make a subpage of the homepage without _position or _targetId","suites":["Pages REST"],"updatePoint":{"line":254,"column":78,"index":6982},"line":254,"code":"  it('is able to make a subpage of the homepage without _position or _targetId', async function () {\n    const body = {\n      slug: '/new-tab',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'New Tab'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    assert(page);\n    assert(page.title === 'New Tab');\n    // Is the path generally correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/${page._id.replace(':en:published', '')}`);\n    assert.strictEqual(page.level, 1);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to make a subpage of the homepage at index `1` with numerical _position","suites":["Pages REST"],"updatePoint":{"line":271,"column":85,"index":7574},"line":271,"code":"  it('is able to make a subpage of the homepage at index `1` with numerical _position', async function () {\n    const body = {\n      slug: '/second-new',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'Second New',\n      _targetId: '_home',\n      _position: '1'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    assert(page);\n    assert(page.title === 'Second New');\n    // Is the path generally correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/${page._id.replace(':en:published', '')}`);\n    const home = await apos.http.get('/api/v1/@apostrophecms/page?children=1', {\n      jar\n    });\n    assert(home);\n    assert(home._children);\n    assert(home._children[1]);\n    assert(home._children[1]._id === page._id);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to make a subpage of /parent with _position and _targetId","suites":["Pages REST"],"updatePoint":{"line":297,"column":71,"index":8411},"line":297,"code":"  it('is able to make a subpage of /parent with _position and _targetId', async function () {\n    const body = {\n      slug: '/new-page',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'New Page',\n      _targetId: 'parent:en:published',\n      _position: 'lastChild'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    newPageId = page._id;\n    assert(page);\n    assert(page.title === 'New Page');\n    // Is the path generally correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/${page._id.replace(':en:published', '')}`);\n    assert.strictEqual(page.level, 2);\n    assert.strictEqual(page.rank, 2);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"cannot POST a page without a session","suites":["Pages REST"],"updatePoint":{"line":318,"column":42,"index":9104},"line":318,"code":"  it('cannot POST a page without a session', async function () {\n    const body = {\n      slug: '/new-tab',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'New Tab'\n    };\n    try {\n      await apos.http.post('/api/v1/@apostrophecms/page', {\n        body\n      });\n      assert(false);\n    } catch (e) {\n      assert(true);\n    }\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be able to find just a single page with ancestors","suites":["Pages REST"],"updatePoint":{"line":334,"column":62,"index":9479},"line":334,"code":"  it('should be able to find just a single page with ancestors', async function () {\n    const page = await apos.http.get('/api/v1/@apostrophecms/page/child:en:published');\n    assert(page);\n    assert(page.path === `${homeId.replace(':en:published', '')}/parent/child`);\n    // There should be 2 ancestors.\n    assert(page._ancestors.length === 2);\n    // The first ancestor should be the homepage\n    assert.strictEqual(page._ancestors[0].path, `${homeId.replace(':en:published', '')}`);\n    // The second ancestor should be 'parent'\n    assert.strictEqual(page._ancestors[1].path, `${homeId.replace(':en:published', '')}/parent`);\n\n    // There should be only 1 result.\n    assert(page);\n    // There should be 2 ancestors.\n    assert(page._ancestors.length === 2);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be able to find just a single page with children","suites":["Pages REST"],"updatePoint":{"line":350,"column":61,"index":10253},"line":350,"code":"  it('should be able to find just a single page with children', async function () {\n    const page = await apos.http.get('/api/v1/@apostrophecms/page/parent:en:published');\n    assert(page);\n    assert(page.path === `${homeId.replace(':en:published', '')}/parent`);\n    // There should be 1 ancestor\n    assert(page._ancestors.length === 1);\n    // The first ancestor should be the homepage\n    assert.strictEqual(page._ancestors[0].path, `${homeId.replace(':en:published', '')}`);\n\n    // There should be children\n    assert(page._children);\n    assert(page._children.length === 3);\n    assert(page._children[0]._id === 'child:en:published');\n    assert(page._children[1]._id === 'sibling:en:published');\n    assert(page._children[2].slug === '/new-page');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/sibling/cousin after root/parent","suites":["Pages REST"],"updatePoint":{"line":366,"column":66,"index":11022},"line":366,"code":"  it('is able to move root/parent/sibling/cousin after root/parent', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/cousin:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 'after'\n      },\n      jar\n    });\n    assert(page._id);\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/cousin`);\n    // Is the rank correct?\n    const home = await apos.http.get('/api/v1/@apostrophecms/page', {});\n    assert(home._children);\n    assert(home._children[1]._id === 'cousin:en:published');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/cousin before root/parent/child","suites":["Pages REST"],"updatePoint":{"line":382,"column":58,"index":11639},"line":382,"code":"  it('is able to move root/cousin before root/parent/child', async function () {\n    // 'Cousin' _id === 4312\n    // 'Child' _id === 2341\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/cousin:en:published', {\n      body: {\n        _targetId: 'child:en:published',\n        _position: 'before'\n      },\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/cousin`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/child before root/parent/cousin using numerical position","suites":["Pages REST"],"updatePoint":{"line":398,"column":90,"index":12207},"line":398,"code":"  it('is able to move root/parent/child before root/parent/cousin using numerical position', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/child:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 0\n      },\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/child`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/new-page between root/parent/cousin and root/parent/sibling using numerical position","suites":["Pages REST"],"updatePoint":{"line":412,"column":118,"index":12738},"line":412,"code":"  it('is able to move root/parent/new-page between root/parent/cousin and root/parent/sibling using numerical position', async function () {\n    const page = await apos.http.patch(`/api/v1/@apostrophecms/page/${newPageId}`, {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 2\n      },\n      jar\n    });\n    const cousin = await apos.http.get('/api/v1/@apostrophecms/page/cousin:en:published', {\n      jar\n    });\n    const sibling = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/${newPageId.replace(':en:published', '')}`);\n    // Is the rank correct?\n    assert(page.rank > cousin.rank);\n    assert(page.rank < sibling.rank);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/neighbor as the last child of /root/parent using numerical position","suites":["Pages REST"],"updatePoint":{"line":433,"column":94,"index":13534},"line":433,"code":"  it('is able to move root/neighbor as the last child of /root/parent using numerical position', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/neighbor:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 4\n      },\n      jar\n    });\n\n    // `sibling` was previously the last child of `parent`.\n    const sibling = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/neighbor`);\n    // Is the rank correct?\n    assert(page.rank > sibling.rank);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"allows positioning a page at its existing location (lastChild) using numerical position","suites":["Pages REST"],"updatePoint":{"line":452,"column":93,"index":14219},"line":452,"code":"  it('allows positioning a page at its existing location (lastChild) using numerical position', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/neighbor:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 4\n      },\n      jar\n    });\n\n    // `sibling` was previously the last child of `parent`.\n    const sibling = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/neighbor`);\n    // Is the rank correct?\n    assert(page.rank > sibling.rank);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/child/grandchild to the next-to-last position under `parent`","suites":["Pages REST"],"updatePoint":{"line":471,"column":94,"index":14905},"line":471,"code":"  it('is able to move root/parent/child/grandchild to the next-to-last position under `parent`', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/grandchild:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 4\n      },\n      jar\n    });\n\n    // `sibling` was previously the next-to-last child of `parent`.\n    const sibling = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    const neighbor = await apos.http.get('/api/v1/@apostrophecms/page/neighbor:en:published', {\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/grandchild`);\n    // Is the rank correct?\n    assert(page.rank > sibling.rank);\n    assert(page.rank < neighbor.rank);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"allows positioning a page at its existing location (4 of 5) using numerical position","suites":["Pages REST"],"updatePoint":{"line":494,"column":90,"index":15752},"line":494,"code":"  it('allows positioning a page at its existing location (4 of 5) using numerical position', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/grandchild:en:published', {\n      body: {\n        _targetId: 'parent:en:published',\n        _position: 4\n      },\n      jar\n    });\n\n    // `sibling` was previously the next-to-last child of `parent`.\n    const sibling = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    const neighbor = await apos.http.get('/api/v1/@apostrophecms/page/neighbor:en:published', {\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/grandchild`);\n    // Is the rank correct?\n    assert(page.rank > sibling.rank);\n    assert(page.rank < neighbor.rank);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/cousin inside root/parent/sibling","suites":["Pages REST"],"updatePoint":{"line":517,"column":67,"index":16576},"line":517,"code":"  it('is able to move root/parent/cousin inside root/parent/sibling', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/cousin:en:published', {\n      body: {\n        _targetId: 'sibling:en:published',\n        _position: 'firstChild'\n      },\n      jar\n    });\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/sibling/cousin`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"moving /parent into /another-parent should also move /parent/sibling","suites":["Pages REST"],"updatePoint":{"line":531,"column":74,"index":17085},"line":531,"code":"  it('moving /parent into /another-parent should also move /parent/sibling', async function () {\n    await apos.http.patch('/api/v1/@apostrophecms/page/parent:en:published', {\n      body: {\n        _targetId: 'another-parent:en:published',\n        _position: 'firstChild'\n      },\n      jar\n    });\n    const page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n\n    // Is the grandchild's path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/another-parent/parent/sibling`);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to make a subpage of the homepage at the last index with _position: lastChild","suites":["Pages REST"],"updatePoint":{"line":546,"column":91,"index":17665},"line":546,"code":"  it('is able to make a subpage of the homepage at the last index with _position: lastChild', async function () {\n    const body = {\n      slug: '/third-new',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'Third New',\n      _targetId: '_home',\n      _position: 'lastChild'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    assert(page);\n    assert(page.title === 'Third New');\n    // Is the path generally correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/${page._id.replace(':en:published', '')}`);\n    const home = await apos.http.get('/api/v1/@apostrophecms/page?children=1', {\n      jar\n    });\n    assert(home);\n    assert(home._children);\n    assert(home._children[3]._id === page._id);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can use PUT to modify a page","suites":["Pages REST"],"updatePoint":{"line":570,"column":34,"index":18422},"line":570,"code":"  it('can use PUT to modify a page', async function () {\n    const page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page);\n    page.title = 'Changed Title';\n    page.color = 'blue';\n    await apos.http.put('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: page,\n      jar\n    });\n    const page2 = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert.strictEqual(page2.title, 'Changed Title');\n    assert.strictEqual(page2.color, 'blue');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can use PATCH to modify one property of a page","suites":["Pages REST"],"updatePoint":{"line":587,"column":52,"index":19012},"line":587,"code":"  it('can use PATCH to modify one property of a page', async function () {\n    const page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page);\n    page.title = 'Changed Title';\n    await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        title: 'New Title'\n      },\n      jar\n    });\n    const page2 = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert.strictEqual(page2.title, 'New Title');\n    // Did not modify this\n    assert.strictEqual(page2.color, 'blue');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can use PATCH to move a page beneath the home page with _targetId: _home","suites":["Pages REST"],"updatePoint":{"line":606,"column":78,"index":19660},"line":606,"code":"  it('can use PATCH to move a page beneath the home page with _targetId: _home', async function () {\n    const page = await apos.http.patch('/api/v1/@apostrophecms/page/cousin:en:published', {\n      body: {\n        _targetId: '_home',\n        _position: 'firstChild'\n      },\n      jar\n    });\n    assert(page._id);\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/${page.aposDocId}`);\n    assert.strictEqual(page.level, 1);\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can use PATCH to move a page into the archive using _archive as _targetId","suites":["Pages REST"],"updatePoint":{"line":619,"column":79,"index":20155},"line":619,"code":"  it('can use PATCH to move a page into the archive using _archive as _targetId', async function () {\n    let page = await apos.http.patch('/api/v1/@apostrophecms/page/cousin:en:published', {\n      body: {\n        _targetId: '_archive',\n        _position: 'firstChild'\n      },\n      jar\n    });\n    assert(page._id);\n    const archive = await apos.http.get('/api/v1/@apostrophecms/page/_archive?archived=1', {\n      jar\n    });\n    assert(archive);\n    // Verify this is really working because of the _archived\n    // shortcut\n    assert(archive._id !== '_archive');\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/${archive.aposDocId}/${page.aposDocId}`);\n    assert.strictEqual(page.level, 2);\n    assert.strictEqual(page.rank, 0);\n    page = await apos.http.get('/api/v1/@apostrophecms/page/cousin:en:published?_edit=1&archived=1', {\n      jar\n    });\n    assert(page.archived);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use PATCH to add a widget to an area by path","suites":["Pages REST"],"updatePoint":{"line":643,"column":54,"index":21045},"line":643,"code":"  it('Can use PATCH to add a widget to an area by path', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        $push: {\n          'body.items': {\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            content: 'This is <b>Bold</b>'\n          }\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/<b>Bold<\\/b>/));\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use PATCH to update a widget by path","suites":["Pages REST"],"updatePoint":{"line":665,"column":46,"index":21738},"line":665,"code":"  it('Can use PATCH to update a widget by path', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        'body.items.0': {\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: 'This is normal'\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/normal/));\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use PATCH to update a widget via @ syntax","suites":["Pages REST"],"updatePoint":{"line":685,"column":51,"index":22390},"line":685,"code":"  it('Can use PATCH to update a widget via @ syntax', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    const _id = `@${page.body.items[0]._id}`;\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        [_id]: {\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: 'I @ syntax'\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/I @ syntax/));\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use $position to insert a widget at the beginning of the area","suites":["Pages REST"],"updatePoint":{"line":706,"column":71,"index":23099},"line":706,"code":"  it('Can use $position to insert a widget at the beginning of the area', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        $push: {\n          'body.items': {\n            $each: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: 'Oh in the beginning'\n            }],\n            $position: 0\n          }\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/Oh in the beginning/));\n    assert(page.body.items[1]);\n    assert(page.body.items[1].content.match(/I @ syntax/));\n    assert(!page.body.items[2]);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use $position to insert a widget in the middle of the area","suites":["Pages REST"],"updatePoint":{"line":734,"column":68,"index":24015},"line":734,"code":"  it('Can use $position to insert a widget in the middle of the area', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        $push: {\n          'body.items': {\n            $each: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: 'Why don\\'t you meet me in the middle'\n            }],\n            $position: 1\n          }\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/Oh in the beginning/));\n    assert(page.body.items[1]);\n    assert(page.body.items[1].content.match(/middle/));\n    assert(page.body.items[2]);\n    assert(page.body.items[2].content.match(/I @ syntax/));\n    assert(!page.body.items[3]);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use $before to insert a widget in the middle of the area","suites":["Pages REST"],"updatePoint":{"line":764,"column":66,"index":25034},"line":764,"code":"  it('Can use $before to insert a widget in the middle of the area', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        $push: {\n          'body.items': {\n            $each: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: 'before'\n            }],\n            $before: page.body.items[1]._id\n          }\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/Oh in the beginning/));\n    assert(page.body.items[1]);\n    assert(page.body.items[1].content.match(/before/));\n    assert(page.body.items[2]);\n    assert(page.body.items[2].content.match(/middle/));\n    assert(page.body.items[3]);\n    assert(page.body.items[3].content.match(/I @ syntax/));\n    assert(!page.body.items[4]);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"Can use $after to insert a widget in the middle of the area","suites":["Pages REST"],"updatePoint":{"line":796,"column":65,"index":26129},"line":796,"code":"  it('Can use $after to insert a widget in the middle of the area', async function () {\n    let page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    page = await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      body: {\n        $push: {\n          'body.items': {\n            $each: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: 'after'\n            }],\n            $after: page.body.items[0]._id\n          }\n        }\n      },\n      jar\n    });\n    page = await apos.http.get('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar\n    });\n    assert(page.body.items[0]);\n    assert(page.body.items[0].content.match(/Oh in the beginning/));\n    assert(page.body.items[1]);\n    assert(page.body.items[1].content.match(/after/));\n    assert(page.body.items[2]);\n    assert(page.body.items[2].content.match(/before/));\n    assert(page.body.items[3]);\n    assert(page.body.items[3].content.match(/middle/));\n    assert(page.body.items[4]);\n    assert(page.body.items[4].content.match(/I @ syntax/));\n    assert(!page.body.items[5]);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can patch an @ reference in a patch containing other out-of-order @ references","suites":["Pages REST"],"updatePoint":{"line":830,"column":84,"index":27328},"line":830,"code":"  it('can patch an @ reference in a patch containing other out-of-order @ references', async function () {\n    // recreate the exact scenario since we cannot\n    // reproduce it from scratch\n    await apos.doc.db.updateOne({\n      _id: 'sibling'\n    }, {\n      $set: {\n        'body.items': [{\n          _id: 'cki6gxnch00093g631cw03444',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: '<p>one</p>'\n        }, {\n          _id: 'ckgs41w9r000e3h5xmjl9g1uv',\n          one: {\n            _id: 'ckhxhuyoz00084j4l7yw7brq7',\n            items: [{\n              _id: 'ckhxmr8ds001h2a67copguxnk',\n              metaType: 'widget',\n              type: '@apostrophecms/image',\n              imageIds: ['ckhuxqw8o006h094lnkip3gen']\n            }],\n            metaType: 'area'\n          },\n          two: {\n            _id: 'ckhxhuypw00094j4l0mdg0b06',\n            items: [{\n              _id: 'cki4zm66r000t2a67ojd2iyuc',\n              video: {\n                url: 'https://vimeo.com/56282283',\n                title: 'Public Test Video',\n                thumbnail: 'https://i.vimeocdn.com/video/389683305_1000.jpg'\n              },\n              metaType: 'widget',\n              type: '@apostrophecms/video'\n            }],\n            metaType: 'area'\n          },\n          metaType: 'widget',\n          type: 'two-column'\n        }, {\n          _id: 'ckgs11fi200013h5x59udhats',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: '<p>Today\\'s featured product:</p><p>Today\\'s featured product:</p>'\n        }, {\n          _id: 'ckhxsb9yb002b3f62q5h31dhv',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki4zlkqh000q2a67qqbtlv2l',\n          video: {\n            url: 'https://www.youtube.com/watch?v=-e6xOBCAVvA',\n            title: 'The 10-Year Hunt for the Lost McDonald\\'s DS Game',\n            thumbnail: 'https://i.ytimg.com/vi/-e6xOBCAVvA/hqdefault.jpg'\n          },\n          metaType: 'widget',\n          type: '@apostrophecms/video'\n        }, {\n          _id: 'ckhxsbcgl002c3f62hyk8a5p8',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'ckhxsbeoo002d3f62692wxm28',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki6g7v3b0003xrecv5oldhh9',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki6g7v3b0004xrec9hawsy7o',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki6g7v3b0005xrecwc9teivh',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki6g7v3b0006xrec6ubczv1z',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'cki6g7v3b0007xrecjxcgk5ub',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: ''\n        }, {\n          _id: 'ckgwevhkd000v3e5x99dy9jv2',\n          metaType: 'widget',\n          type: '@apostrophecms/rich-text',\n          content: '<blockquote><p>This is cool.</p></blockquote>'\n        }, {\n          _id: 'ckgwevqy600143e5xv4ihv38j',\n          one: {\n            _id: 'ckhxhuyse000g4j4lqcjklpxd',\n            items: [],\n            metaType: 'area'\n          },\n          two: {\n            _id: 'ckhxhuysm000h4j4ljjzd45kx',\n            items: [],\n            metaType: 'area'\n          },\n          metaType: 'widget',\n          type: 'two-column'\n        }]\n      }\n    });\n    const bodyId = (await apos.doc.db.findOne({\n      _id: 'sibling:en:published'\n    })).body._id;\n    // apply the patch that fails without the fix\n    await apos.http.patch('/api/v1/@apostrophecms/page/sibling:en:published', {\n      jar,\n      body: {\n        _patches: [{\n          [`@${bodyId}`]: {\n            _id: 'ckgrzsklg0007ulec0ffxg5bj',\n            items: [{\n              _id: 'ckgs41w9r000e3h5xmjl9g1uv',\n              one: {\n                _id: 'ckhxhuyoz00084j4l7yw7brq7',\n                items: [{\n                  _id: 'ckhxmr8ds001h2a67copguxnk',\n                  metaType: 'widget',\n                  type: '@apostrophecms/image',\n                  imageIds: ['ckhuxqw8o006h094lnkip3gen'],\n                  _edit: true,\n                  _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n                  _image: [{\n                    _id: 'ckhuxqw8o006h094lnkip3gen',\n                    visibility: 'public',\n                    archived: false,\n                    type: '@apostrophecms/image',\n                    attachment: {\n                      _id: 'ckhxvoqra00qsuj4lq0hnkrzg',\n                      crop: null,\n                      group: 'images',\n                      createdAt: '2020-11-25T20:46:28.611Z',\n                      name: 'squirrel',\n                      title: 'squirrel',\n                      extension: 'jpg',\n                      type: 'attachment',\n                      docIds: ['ckhuxqw8o006h094lnkip3gen'],\n                      archivedDocIds: [],\n                      length: {\n                        dev: 51713,\n                        mode: 33204,\n                        nlink: 1,\n                        uid: 1001,\n                        gid: 1001,\n                        rdev: 0,\n                        blksize: 4096,\n                        ino: 4196261,\n                        size: 107948,\n                        blocks: 216,\n                        atimeMs: 1606337187953.1726,\n                        mtimeMs: 1606337187955.1726,\n                        ctimeMs: 1606337187955.1726,\n                        birthtimeMs: 1606337187955.1726,\n                        atime: '2020-11-25T20:46:27.953Z',\n                        mtime: '2020-11-25T20:46:27.955Z',\n                        ctime: '2020-11-25T20:46:27.955Z',\n                        birthtime: '2020-11-25T20:46:27.955Z'\n                      },\n                      md5: '464686711e5df3a60ba5f5384196514a',\n                      width: 1072,\n                      height: 715,\n                      landscape: true,\n                      used: true,\n                      utilized: true,\n                      archived: false,\n                      _urls: {\n                        max: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.max.jpg',\n                        full: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.full.jpg',\n                        'two-thirds': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.two-thirds.jpg',\n                        'one-half': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-half.jpg',\n                        'one-third': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-third.jpg',\n                        'one-sixth': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-sixth.jpg',\n                        original: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.jpg'\n                      }\n                    },\n                    title: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641',\n                    alt: 'I promise that\\'s a squirrel',\n                    credit: '',\n                    creditUrl: null,\n                    slug: 'image-f23976a0-f103-4c43-844a-d879a60eb609-1140x6410',\n                    metaType: 'doc',\n                    createdAt: '2020-11-23T19:20:49.080Z',\n                    titleSortified: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641',\n                    updatedAt: '2020-11-25T20:48:58.668Z',\n                    highSearchText: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641 image f23976a0 f103 4c43 844a d879a60eb609 1140x6410',\n                    highSearchWords: ['f23976a0', 'f103', '4c43', '844a', 'd879a60eb609', '1140x641', 'image', '1140x6410'],\n                    lowSearchText: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641 image f23976a0 f103 4c43 844a d879a60eb609 1140x6410',\n                    searchSummary: '',\n                    tagsIds: [],\n                    _edit: true\n                  }]\n                }],\n                metaType: 'area',\n                _edit: true,\n                _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n              },\n              two: {\n                _id: 'ckhxhuypw00094j4l0mdg0b06',\n                items: [{\n                  _id: 'cki4zm66r000t2a67ojd2iyuc',\n                  video: {\n                    url: 'https://vimeo.com/56282283',\n                    title: 'Public Test Video',\n                    thumbnail: 'https://i.vimeocdn.com/video/389683305_1000.jpg'\n                  },\n                  metaType: 'widget',\n                  type: '@apostrophecms/video',\n                  _edit: true,\n                  _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n                }],\n                metaType: 'area',\n                _edit: true,\n                _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n              },\n              metaType: 'widget',\n              type: 'two-column',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckgs11fi200013h5x59udhats',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '<p>Today\\'s featured product:</p><p>Today\\'s featured product:</p>',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckhxsb9yb002b3f62q5h31dhv',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki4zlkqh000q2a67qqbtlv2l',\n              video: {\n                url: 'https://www.youtube.com/watch?v=-e6xOBCAVvA',\n                title: 'The 10-Year Hunt for the Lost McDonald\\'s DS Game',\n                thumbnail: 'https://i.ytimg.com/vi/-e6xOBCAVvA/hqdefault.jpg'\n              },\n              metaType: 'widget',\n              type: '@apostrophecms/video',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckhxsbcgl002c3f62hyk8a5p8',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckhxsbeoo002d3f62692wxm28',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki6g7v3b0003xrecv5oldhh9',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki6g7v3b0004xrec9hawsy7o',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki6g7v3b0005xrecwc9teivh',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki6g7v3b0006xrec6ubczv1z',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'cki6g7v3b0007xrecjxcgk5ub',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckgwevhkd000v3e5x99dy9jv2',\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              content: '<blockquote><p>This is cool.</p></blockquote>',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }, {\n              _id: 'ckgwevqy600143e5xv4ihv38j',\n              one: {\n                _id: 'ckhxhuyse000g4j4lqcjklpxd',\n                items: [],\n                metaType: 'area',\n                _edit: true,\n                _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n              },\n              two: {\n                _id: 'ckhxhuysm000h4j4ljjzd45kx',\n                items: [],\n                metaType: 'area',\n                _edit: true,\n                _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n              },\n              metaType: 'widget',\n              type: 'two-column',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }],\n            metaType: 'area',\n            _edit: true,\n            _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n            _fieldId: 'ef3e5cb82b863cff62bcad353fde019a'\n          },\n          '@ckhxhuyoz00084j4l7yw7brq7': {\n            _id: 'ckhxhuyoz00084j4l7yw7brq7',\n            items: [{\n              _id: 'ckhxmr8ds001h2a67copguxnk',\n              metaType: 'widget',\n              type: '@apostrophecms/image',\n              imageIds: ['ckhuxqw8o006h094lnkip3gen'],\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n              _image: [{\n                _id: 'ckhuxqw8o006h094lnkip3gen',\n                visibility: 'public',\n                archived: false,\n                type: '@apostrophecms/image',\n                attachment: {\n                  _id: 'ckhxvoqra00qsuj4lq0hnkrzg',\n                  crop: null,\n                  group: 'images',\n                  createdAt: '2020-11-25T20:46:28.611Z',\n                  name: 'squirrel',\n                  title: 'squirrel',\n                  extension: 'jpg',\n                  type: 'attachment',\n                  docIds: ['ckhuxqw8o006h094lnkip3gen'],\n                  archivedDocIds: [],\n                  length: {\n                    dev: 51713,\n                    mode: 33204,\n                    nlink: 1,\n                    uid: 1001,\n                    gid: 1001,\n                    rdev: 0,\n                    blksize: 4096,\n                    ino: 4196261,\n                    size: 107948,\n                    blocks: 216,\n                    atimeMs: 1606337187953.1726,\n                    mtimeMs: 1606337187955.1726,\n                    ctimeMs: 1606337187955.1726,\n                    birthtimeMs: 1606337187955.1726,\n                    atime: '2020-11-25T20:46:27.953Z',\n                    mtime: '2020-11-25T20:46:27.955Z',\n                    ctime: '2020-11-25T20:46:27.955Z',\n                    birthtime: '2020-11-25T20:46:27.955Z'\n                  },\n                  md5: '464686711e5df3a60ba5f5384196514a',\n                  width: 1072,\n                  height: 715,\n                  landscape: true,\n                  used: true,\n                  utilized: true,\n                  archived: false,\n                  _urls: {\n                    max: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.max.jpg',\n                    full: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.full.jpg',\n                    'two-thirds': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.two-thirds.jpg',\n                    'one-half': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-half.jpg',\n                    'one-third': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-third.jpg',\n                    'one-sixth': '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.one-sixth.jpg',\n                    original: '/uploads/attachments/ckhxvoqra00qsuj4lq0hnkrzg-squirrel.jpg'\n                  }\n                },\n                title: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641',\n                alt: 'I promise that\\'s a squirrel',\n                credit: '',\n                creditUrl: null,\n                slug: 'image-f23976a0-f103-4c43-844a-d879a60eb609-1140x6410',\n                metaType: 'doc',\n                createdAt: '2020-11-23T19:20:49.080Z',\n                titleSortified: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641',\n                updatedAt: '2020-11-25T20:48:58.668Z',\n                highSearchText: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641 image f23976a0 f103 4c43 844a d879a60eb609 1140x6410',\n                highSearchWords: ['f23976a0', 'f103', '4c43', '844a', 'd879a60eb609', '1140x641', 'image', '1140x6410'],\n                lowSearchText: 'f23976a0 f103 4c43 844a d879a60eb609 1140x641 image f23976a0 f103 4c43 844a d879a60eb609 1140x6410',\n                searchSummary: '',\n                tagsIds: [],\n                _edit: true\n              }]\n            }],\n            metaType: 'area',\n            _edit: true,\n            _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n            _fieldId: 'e49e6abd03df799df82381186ee5fdda'\n          },\n          '@ckhxhuypw00094j4l0mdg0b06': {\n            _id: 'ckhxhuypw00094j4l0mdg0b06',\n            items: [{\n              _id: 'cki4zm66r000t2a67ojd2iyuc',\n              video: {\n                url: 'https://vimeo.com/56282283',\n                title: 'Public Test Video',\n                thumbnail: 'https://i.vimeocdn.com/video/389683305_1000.jpg'\n              },\n              metaType: 'widget',\n              type: '@apostrophecms/video',\n              _edit: true,\n              _docId: 'ckgrzqh5a000bx7ecn4hpskk7'\n            }],\n            metaType: 'area',\n            _edit: true,\n            _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n            _fieldId: 'c550ad6db39c7248dd94f47a8754ab03'\n          },\n          '@ckhxhuyse000g4j4lqcjklpxd': {\n            _id: 'ckhxhuyse000g4j4lqcjklpxd',\n            items: [],\n            metaType: 'area',\n            _edit: true,\n            _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n            _fieldId: 'e49e6abd03df799df82381186ee5fdda'\n          },\n          '@ckhxhuysm000h4j4ljjzd45kx': {\n            _id: 'ckhxhuysm000h4j4ljjzd45kx',\n            items: [],\n            metaType: 'area',\n            _edit: true,\n            _docId: 'ckgrzqh5a000bx7ecn4hpskk7',\n            _fieldId: 'c550ad6db39c7248dd94f47a8754ab03'\n          }\n        }, {\n          $push: {\n            '@ckgrzsklg0007ulec0ffxg5bj.items': {\n              $each: [{\n                _id: 'cki6gxnch00093g631cw03444',\n                type: '@apostrophecms/rich-text',\n                content: ''\n              }],\n              $before: 'ckgs41w9r000e3h5xmjl9g1uv'\n            }\n          }\n        }]\n      }\n    });\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can insert a page for advisory lock testing","suites":["Pages REST"],"updatePoint":{"line":1305,"column":49,"index":46215},"line":1305,"code":"  it('can insert a page for advisory lock testing', async function () {\n    const body = {\n      slug: '/advisory-test',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'Advisory Test'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    assert(page);\n    assert(page.title === 'Advisory Test');\n    advisoryLockTestId = page._id;\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can get an advisory lock on a page while patching a property","suites":["Pages REST"],"updatePoint":{"line":1320,"column":66,"index":46646},"line":1320,"code":"  it('can get an advisory lock on a page while patching a property', async function () {\n    const page = await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'xyz',\n          lock: true\n        },\n        title: 'Advisory Test Patched'\n      }\n    });\n    assert(page.title === 'Advisory Test Patched');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"cannot get an advisory lock with a different context id","suites":["Pages REST"],"updatePoint":{"line":1333,"column":61,"index":47043},"line":1333,"code":"  it('cannot get an advisory lock with a different context id', async function () {\n    try {\n      await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n        jar,\n        body: {\n          _advisoryLock: {\n            tabId: 'pdq',\n            lock: true\n          }\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 409);\n      assert(e.body.name === 'locked');\n      assert(e.body.data.me);\n    }\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can get an advisory lock with a different context id if forcing","suites":["Pages REST"],"updatePoint":{"line":1351,"column":69,"index":47518},"line":1351,"code":"  it('can get an advisory lock with a different context id if forcing', async function () {\n    await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: true,\n          force: true\n        }\n      }\n    });\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can renew the advisory lock with the second context id after forcing","suites":["Pages REST"],"updatePoint":{"line":1363,"column":74,"index":47846},"line":1363,"code":"  it('can renew the advisory lock with the second context id after forcing', async function () {\n    await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: true\n        }\n      }\n    });\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can unlock the advisory lock while patching a property","suites":["Pages REST"],"updatePoint":{"line":1374,"column":60,"index":48137},"line":1374,"code":"  it('can unlock the advisory lock while patching a property', async function () {\n    const page = await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: false\n        },\n        title: 'Advisory Test Patched Again'\n      }\n    });\n    assert(page.title === 'Advisory Test Patched Again');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can relock with the first context id after unlocking","suites":["Pages REST"],"updatePoint":{"line":1387,"column":58,"index":48544},"line":1387,"code":"  it('can relock with the first context id after unlocking', async function () {\n    const doc = await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'xyz',\n          lock: true\n        }\n      }\n    });\n    assert(doc.title === 'Advisory Test Patched Again');\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"is able to make a page including diacritics","suites":["Pages REST"],"updatePoint":{"line":1400,"column":49,"index":48913},"line":1400,"code":"  it('is able to make a page including diacritics', async function () {\n    const body = {\n      slug: '/ḑiaçritiçs-čharaćters',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'Ḑiaçritiçs Čharaćters',\n      _targetId: '_home',\n      _position: '1'\n    };\n    const page = await apos.http.post('/api/v1/@apostrophecms/page', {\n      body,\n      jar\n    });\n    assert(page);\n    assert(page.title === 'Ḑiaçritiçs Čharaćters');\n    diacriticsId = page._id;\n    // Accesses the published page.\n    const published = await apos.http.get('/ḑiaçritiçs-čharaćters');\n    assert(published);\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"can archive the diacritics page then access the draft preview","suites":["Pages REST"],"updatePoint":{"line":1420,"column":67,"index":49539},"line":1420,"code":"  it('can archive the diacritics page then access the draft preview', async function () {\n    // Now only a draft preview will be available.\n    await apos.page.archive(apos.task.getReq(), diacriticsId);\n    try {\n      const rendered = await apos.http.get('/ḑiaçritiçs-čharaćters', {\n        jar\n      });\n      assert(rendered.match(/Sing to me, Oh Muse\\./));\n    } catch (error) {\n      console.error(error);\n      assert(false);\n    }\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be able to log in as second user","suites":["Pages REST"],"updatePoint":{"line":1434,"column":45,"index":49974},"line":1434,"code":"  it('should be able to log in as second user', async function () {\n    jar2 = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar: jar2\n    });\n    assert(page.match(/logged out/));\n\n    // Log in\n\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin2',\n        password: 'admin2',\n        session: true\n      },\n      jar: jar2\n    });\n\n    // Confirm login\n    page = await apos.http.get('/', {\n      jar: jar2\n    });\n    assert(page.match(/logged in/));\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"second user with a distinct tabId gets an appropriate error specifying who has the lock","suites":["Pages REST"],"updatePoint":{"line":1460,"column":93,"index":50581},"line":1460,"code":"  it('second user with a distinct tabId gets an appropriate error specifying who has the lock', async function () {\n    try {\n      await apos.http.patch(`/api/v1/@apostrophecms/page/${advisoryLockTestId}`, {\n        jar: jar2,\n        body: {\n          _advisoryLock: {\n            tabId: 'nbc',\n            lock: true\n          }\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 409);\n      assert(e.body.name === 'locked');\n      assert(!e.body.data.me);\n      assert(e.body.data.username === 'admin');\n    }\n  });","file":"pages-rest.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Pages"],"updatePoint":{"line":15,"column":45,"index":346},"line":15,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/express': {\n          options: {\n            apiKeys: {\n              [apiKey]: {\n                role: 'admin'\n              }\n            }\n          }\n        },\n        '@apostrophecms/page': {\n          options: {\n            park: [],\n            types: [{\n              name: '@apostrophecms/home-page',\n              label: 'Home'\n            }, {\n              name: 'test-page',\n              label: 'Test Page'\n            }],\n            publicApiProjection: {\n              title: 1,\n              _url: 1\n            }\n          }\n        },\n        'test-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    assert(apos.page.__meta.name === '@apostrophecms/page');\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should make sure all of the expected indexes are configured","suites":["Pages"],"updatePoint":{"line":54,"column":65,"index":1253},"line":54,"code":"  it('should make sure all of the expected indexes are configured', async function () {\n    const expectedIndexes = ['path'];\n    const actualIndexes = [];\n    const info = await apos.doc.db.indexInformation();\n\n    // Extract the actual index info we care about\n    _.each(info, function (index) {\n      actualIndexes.push(index[0][0]);\n    });\n\n    // Now make sure everything in expectedIndexes is in actualIndexes\n    _.each(expectedIndexes, function (index) {\n      assert(_.includes(actualIndexes, index));\n    });\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"parked homepage exists","suites":["Pages"],"updatePoint":{"line":69,"column":28,"index":1743},"line":69,"code":"  it('parked homepage exists', async function () {\n    const home = await apos.page.find(apos.task.getAnonReq(), {\n      level: 0\n    }).toObject();\n    assert(home);\n    homeId = home._id;\n    assert(home.slug === '/');\n    assert(`${home.path}:en:published` === home._id);\n    assert(home.type === '@apostrophecms/home-page');\n    assert(home.parked);\n    assert(home.visibility === 'public');\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"parked archive page exists","suites":["Pages"],"updatePoint":{"line":81,"column":32,"index":2149},"line":81,"code":"  it('parked archive page exists', async function () {\n    const archive = await apos.page.find(apos.task.getReq(), {\n      slug: '/archive'\n    }).archived(null).toObject();\n    assert(archive);\n    assert(archive.slug === '/archive');\n    assert(archive.path === `${homeId.replace(':en:published', '')}/${archive._id.replace(':en:published', '')}`);\n    assert(archive.type === '@apostrophecms/archive-page');\n    assert(archive.parked);\n    // Verify that clonePermanent did its\n    // job and removed properties not meant\n    // to be stored in mongodb\n    assert(!archive._children);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to use db to insert documents","suites":["Pages"],"updatePoint":{"line":95,"column":50,"index":2762},"line":95,"code":"  it('should be able to use db to insert documents', async function () {\n    const testItems = [{\n      _id: 'parent:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'parent',\n      type: 'test-page',\n      slug: '/parent',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent`,\n      level: 1,\n      rank: 0\n    }, {\n      _id: 'child:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'child',\n      type: 'test-page',\n      slug: '/parent/child',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/child`,\n      level: 2,\n      rank: 0\n    }, {\n      _id: 'grandchild:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'grandchild',\n      type: 'test-page',\n      slug: '/parent/child/grandchild',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/child/grandchild`,\n      level: 3,\n      rank: 0\n    }, {\n      _id: 'sibling:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'sibling',\n      type: 'test-page',\n      slug: '/parent/sibling',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/sibling`,\n      level: 2,\n      rank: 1\n    }, {\n      _id: 'cousin:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'cousin',\n      type: 'test-page',\n      slug: '/parent/sibling/cousin',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/parent/sibling/cousin`,\n      level: 3,\n      rank: 0\n    }, {\n      _id: 'another-parent:en:published',\n      aposLocale: 'en:published',\n      aposDocId: 'another-parent',\n      type: 'test-page',\n      slug: '/another-parent',\n      visibility: 'public',\n      path: `${homeId.replace(':en:published', '')}/another-parent`,\n      level: 1,\n      rank: 1\n    }];\n    // Insert draft versions too to match the A3 data model\n    const draftItems = await apos.doc.db.insertMany(testItems.map(item => ({\n      ...item,\n      aposLocale: item.aposLocale.replace(':published', ':draft'),\n      _id: item._id.replace(':published', ':draft')\n    })));\n    assert(draftItems.result.ok === 1);\n    assert(draftItems.insertedCount === 6);\n    const items = await apos.doc.db.insertMany(testItems);\n    assert(items.result.ok === 1);\n    assert(items.insertedCount === 6);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should have a find method on pages that returns a cursor","suites":["Pages"],"updatePoint":{"line":172,"column":62,"index":5148},"line":172,"code":"  it('should have a find method on pages that returns a cursor', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq());\n    assert(cursor);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to find the parked homepage","suites":["Pages"],"updatePoint":{"line":176,"column":48,"index":5304},"line":176,"code":"  it('should be able to find the parked homepage', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/'\n    });\n    const page = await cursor.toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    assert(`${page.path}:en:published` === page._id);\n    assert(page.rank === 0);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to find just a single page","suites":["Pages"],"updatePoint":{"line":187,"column":47,"index":5646},"line":187,"code":"  it('should be able to find just a single page', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/parent/child'\n    });\n    const page = await cursor.toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    // It should have a path of /parent/child\n    assert(page.path === `${homeId.replace(':en:published', '')}/parent/child`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should convert an uppercase URL to its lowercase version","suites":["Pages"],"updatePoint":{"line":198,"column":62,"index":6059},"line":198,"code":"  it('should convert an uppercase URL to its lowercase version', async function () {\n    const response = await apos.http.get('/PArent/cHild', {\n      fullResponse: true\n    });\n    assert(response.body.match(/URL: \\/parent\\/child/));\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should NOT convert an uppercase URL if redirectFailedUpperCaseUrls is false","suites":["Pages"],"updatePoint":{"line":204,"column":81,"index":6319},"line":204,"code":"  it('should NOT convert an uppercase URL if redirectFailedUpperCaseUrls is false', async function () {\n    apos.page.options.redirectFailedUpperCaseUrls = false;\n    try {\n      await apos.http.get('/PArent/cHild', {\n        fullResponse: true\n      });\n    } catch (error) {\n      assert(error.status === 404);\n    }\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to include the ancestors of a page","suites":["Pages"],"updatePoint":{"line":214,"column":55,"index":6618},"line":214,"code":"  it('should be able to include the ancestors of a page', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/parent/child'\n    });\n    const page = await cursor.ancestors(true).toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    // There should be 2 ancestors.\n    assert(page._ancestors.length === 2);\n    // The first ancestor should be the homepage\n    assert.strictEqual(`${page._ancestors[0].path}:en:published`, homeId);\n    // The second ancestor should be 'parent'\n    assert.strictEqual(page._ancestors[1].path, `${homeId.replace(':en:published', '')}/parent`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to include just one ancestor of a page, i.e. the parent","suites":["Pages"],"updatePoint":{"line":229,"column":76,"index":7280},"line":229,"code":"  it('should be able to include just one ancestor of a page, i.e. the parent', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/parent/child'\n    });\n    const page = await cursor.ancestors({\n      depth: 1\n    }).toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    // There should be 1 ancestor returned.\n    assert(page._ancestors.length === 1);\n    // The first ancestor returned should be 'parent'\n    assert.strictEqual(page._ancestors[0].path, `${homeId.replace(':en:published', '')}/parent`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to include the children of the ancestors of a page","suites":["Pages"],"updatePoint":{"line":244,"column":71,"index":7847},"line":244,"code":"  it('should be able to include the children of the ancestors of a page', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/parent/child'\n    });\n    const page = await cursor.ancestors({\n      children: 1\n    }).toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    // There should be 2 ancestors.\n    assert(page._ancestors.length === 2);\n    // The second ancestor should have children\n    assert(page._ancestors[1]._children);\n    // The first ancestor's child should have a path '/parent/child'\n    assert.strictEqual(page._ancestors[1]._children[0].path, `${homeId.replace(':en:published', '')}/parent/child`);\n    // The second ancestor's child should have a path '/parent/sibling'\n    assert.strictEqual(page._ancestors[1]._children[1].path, `${homeId.replace(':en:published', '')}/parent/sibling`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to insert a new page","suites":["Pages"],"updatePoint":{"line":266,"column":34,"index":8704},"line":266,"code":"  it('is able to insert a new page', async function () {\n    const parentId = 'parent:en:published';\n    const newPage = {\n      slug: '/parent/new-page',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'New Page'\n    };\n    const page = await apos.page.insert(apos.task.getReq(), parentId, 'lastChild', newPage);\n\n    // Is the path generally correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/${page._id.replace(':en:published', '')}`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to insert a new page in the correct order","suites":["Pages"],"updatePoint":{"line":280,"column":55,"index":9242},"line":280,"code":"  it('is able to insert a new page in the correct order', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/parent/new-page'\n    });\n    newPage = await cursor.toObject();\n    assert(newPage);\n    assert.strictEqual(newPage.rank, 2);\n    assert.strictEqual(newPage.level, 2);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to insert a subpage","suites":["Pages"],"updatePoint":{"line":289,"column":33,"index":9546},"line":289,"code":"  it('is able to insert a subpage', async function () {\n    const subPageInfo = {\n      slug: '/parent/new-page/sub-page',\n      visibility: 'public',\n      type: 'test-page',\n      title: 'Sub Page'\n    };\n    const subPage = await apos.page.insert(apos.task.getReq(), newPage._id, 'lastChild', subPageInfo);\n    const homePage = await apos.doc.db.findOne({\n      slug: '/',\n      aposMode: 'published'\n    });\n    const components = subPage.path.split('/');\n    assert.strictEqual(components.length, 4);\n    assert(components[0] === homePage.aposDocId);\n    assert(components[1] === 'parent');\n    assert(components[2] === newPage.aposDocId);\n    assert(components[3] === subPage.aposDocId);\n    assert.strictEqual(subPage.slug, '/parent/new-page/sub-page');\n    assert(subPage.rank === 0);\n    assert(subPage.level === 3);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/sibling/cousin after root/parent","suites":["Pages"],"updatePoint":{"line":314,"column":66,"index":10425},"line":314,"code":"  it('is able to move root/parent/sibling/cousin after root/parent', async function () {\n    await apos.page.move(apos.task.getReq(), 'cousin:en:published', 'parent:en:published', 'after');\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      _id: 'cousin:en:published'\n    });\n    const page = await cursor.toObject();\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/cousin`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 1);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to move root/cousin before root/parent/child","suites":["Pages"],"updatePoint":{"line":326,"column":58,"index":10939},"line":326,"code":"  it('is able to move root/cousin before root/parent/child', async function () {\n    // 'Cousin' _id === 4312\n    // 'Child' _id === 2341\n\n    await apos.page.move(apos.task.getReq(), 'cousin:en:published', 'child:en:published', 'before');\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      _id: 'cousin:en:published'\n    });\n    const page = await cursor.toObject();\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/cousin`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to move root/parent/cousin inside root/parent/sibling","suites":["Pages"],"updatePoint":{"line":341,"column":67,"index":11527},"line":341,"code":"  it('is able to move root/parent/cousin inside root/parent/sibling', async function () {\n    await apos.page.move(apos.task.getReq(), 'cousin:en:published', 'sibling:en:published', 'firstChild');\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      _id: 'cousin:en:published'\n    });\n    const page = await cursor.toObject();\n\n    // Is the new path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/parent/sibling/cousin`);\n    // Is the rank correct?\n    assert.strictEqual(page.rank, 0);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"moving /parent into /another-parent should also move /parent/sibling","suites":["Pages"],"updatePoint":{"line":353,"column":74,"index":12078},"line":353,"code":"  it('moving /parent into /another-parent should also move /parent/sibling', async function () {\n    await apos.page.move(apos.task.getReq(), 'parent:en:published', 'another-parent:en:published', 'firstChild');\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      _id: 'sibling:en:published'\n    });\n    const page = await cursor.toObject();\n\n    // Is the grandchild's path correct?\n    assert.strictEqual(page.path, `${homeId.replace(':en:published', '')}/another-parent/parent/sibling`);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to serve a page","suites":["Pages"],"updatePoint":{"line":363,"column":36,"index":12550},"line":363,"code":"  it('should be able to serve a page', async function () {\n    const response = await apos.http.get('/another-parent/parent/child', {\n      fullResponse: true\n    });\n\n    // Is our status code good?\n    assert.strictEqual(response.status, 200);\n    // Did we get our page back?\n    assert(response.body.match(/Sing to me, Oh Muse./));\n    // Does the response prove that data.home was available?\n    assert(response.body.match(/Home: \\//));\n    // Does the response prove that data.home._children was available?\n    assert(response.body.match(/Tab: \\/another-parent/));\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not be able to serve a nonexistent page","suites":["Pages"],"updatePoint":{"line":377,"column":52,"index":13143},"line":377,"code":"  it('should not be able to serve a nonexistent page', async function () {\n    try {\n      await apos.http.get('/nobodyschild');\n      assert(false);\n    } catch (e) {\n      // Is our status code good?\n      assert.strictEqual(e.status, 404);\n      // Does the response prove that data.home was available?\n      assert(e.body.match(/Home: \\//));\n      // Does the response prove that data.home._children was available?\n      assert(e.body.match(/Tab: \\/another-parent/));\n    }\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should detect that the home page is an ancestor of any page except itself","suites":["Pages"],"updatePoint":{"line":390,"column":79,"index":13654},"line":390,"code":"  it('should detect that the home page is an ancestor of any page except itself', function () {\n    assert(\n    // actual paths are made up of _ids in 3.x\n    apos.page.isAncestorOf({\n      path: 'home'\n    }, {\n      path: 'home/about'\n    }));\n    assert(apos.page.isAncestorOf({\n      path: 'home'\n    }, {\n      path: 'home/about/grandkid'\n    }));\n    assert(!apos.page.isAncestorOf({\n      path: 'home'\n    }, {\n      path: 'home'\n    }));\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should detect a tab as the ancestor of its great grandchild but not someone else's","suites":["Pages"],"updatePoint":{"line":409,"column":89,"index":14116},"line":409,"code":"  it('should detect a tab as the ancestor of its great grandchild but not someone else\\'s', function () {\n    assert(apos.page.isAncestorOf({\n      path: 'home/about'\n    }, {\n      path: 'home/about/test/thing'\n    }));\n    assert(!apos.page.isAncestorOf({\n      path: 'home/about'\n    }, {\n      path: 'home/wiggy/test/thing'\n    }));\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"is able to move parent to the archive","suites":["Pages"],"updatePoint":{"line":421,"column":43,"index":14413},"line":421,"code":"  it('is able to move parent to the archive', async function () {\n    await apos.page.archive(apos.task.getReq(), 'parent:en:published');\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      _id: 'parent'\n    });\n    const page = await cursor.toObject();\n    assert(!page);\n    const req = apos.task.getReq();\n    const archive = await apos.page.findOneForEditing(req, {\n      parkedId: 'archive'\n    });\n    const archived = await apos.page.findOneForEditing(req, {\n      _id: 'parent:en:published'\n    });\n    assert.strictEqual(archived.path, `${homeId.replace(':en:published', '')}/${archive._id.replace(':en:published', '')}/${archived._id.replace(':en:published', '')}`);\n    assert(archived.archived);\n    assert.strictEqual(archived.level, 2);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should be able to find the parked homepage again","suites":["Pages"],"updatePoint":{"line":439,"column":54,"index":15195},"line":439,"code":"  it('should be able to find the parked homepage again', async function () {\n    const cursor = apos.page.find(apos.task.getAnonReq(), {\n      slug: '/'\n    });\n    const page = await cursor.toObject();\n\n    // There should be only 1 result.\n    assert(page);\n    assert(`${page.path}:en:published` === page._id);\n    assert(page.rank === 0);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"After everything else, ranks must still be unduplicated among peers and level must be consistent with path","suites":["Pages"],"updatePoint":{"line":450,"column":112,"index":15602},"line":450,"code":"  it('After everything else, ranks must still be unduplicated among peers and level must be consistent with path', async function () {\n    const pages = await apos.doc.db.find({\n      slug: /^\\//,\n      aposLocale: 'en:published'\n    }).sort({\n      path: 1\n    }).toArray();\n    for (let i = 0; i < pages.length; i++) {\n      const iLevel = pages[i].path.replace(/[^/]+/g, '').length;\n      assert(iLevel === pages[i].level);\n      const ranks = [];\n      for (let j = i + 1; j < pages.length; j++) {\n        const jLevel = pages[j].path.replace(/[^/]+/g, '').length;\n        assert(jLevel === pages[j].level);\n        if (pages[j].path.substring(0, pages[i].path.length) !== pages[i].path) {\n          break;\n        }\n        if (pages[j].level !== pages[i].level + 1) {\n          // Ignore grandchildren etc.\n          continue;\n        }\n        assert(!ranks.includes(pages[j].rank));\n        ranks.push(pages[j].rank);\n      }\n    }\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving pages, when cache option is not set","suites":["Pages"],"updatePoint":{"line":476,"column":94,"index":16530},"line":476,"code":"  it('should not set a cache-control value when retrieving pages, when cache option is not set', async function () {\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving a single page, when \"etags\" cache option is set","suites":["Pages"],"updatePoint":{"line":486,"column":106,"index":17015},"line":486,"code":"  it('should not set a cache-control value when retrieving a single page, when \"etags\" cache option is set', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 5555,\n        etags: true\n      }\n    };\n    const response = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving pages, when \"api\" cache option is not set","suites":["Pages"],"updatePoint":{"line":499,"column":100,"index":17460},"line":499,"code":"  it('should not set a cache-control value when retrieving pages, when \"api\" cache option is not set', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 5555\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a \"max-age\" cache-control value when retrieving pieces, when \"api\" cache option is set","suites":["Pages"],"updatePoint":{"line":515,"column":103,"index":18060},"line":515,"code":"  it('should set a \"max-age\" cache-control value when retrieving pieces, when \"api\" cache option is set', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'max-age=4444');\n    assert(response2.headers['cache-control'] === 'max-age=4444');\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pages, when user is connected","suites":["Pages"],"updatePoint":{"line":531,"column":95,"index":18661},"line":531,"code":"  it('should set a \"no-store\" cache-control value when retrieving pages, when user is connected', async function () {\n    const jar = apos.http.jar();\n    const user = apos.user.newInstance();\n    user.title = 'admin';\n    user.username = 'admin';\n    user.password = 'admin';\n    user.email = 'ad@min.com';\n    user.role = 'admin';\n    await apos.user.insert(apos.task.getReq(), user);\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true,\n      jar\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      jar\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pages, when \"api\" cache option is set, when user is connected","suites":["Pages"],"updatePoint":{"line":559,"column":127,"index":19642},"line":559,"code":"  it('should set a \"no-store\" cache-control value when retrieving pages, when \"api\" cache option is set, when user is connected', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444\n      }\n    };\n    const jar = apos.http.jar();\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response1 = await apos.http.get('/api/v1/@apostrophecms/page', {\n      fullResponse: true,\n      jar\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      jar\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pages, when user is connected using an api key","suites":["Pages"],"updatePoint":{"line":586,"column":112,"index":20489},"line":586,"code":"  it('should set a \"no-store\" cache-control value when retrieving pages, when user is connected using an api key', async function () {\n    const response1 = await apos.http.get(`/api/v1/@apostrophecms/page?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pages, when \"api\" cache option is set, when user is connected using an api key","suites":["Pages"],"updatePoint":{"line":596,"column":144,"index":21048},"line":596,"code":"  it('should set a \"no-store\" cache-control value when retrieving pages, when \"api\" cache option is set, when user is connected using an api key', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444\n      }\n    };\n    const response1 = await apos.http.get(`/api/v1/@apostrophecms/page?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when serving a page, when cache option is not set","suites":["Pages"],"updatePoint":{"line":612,"column":92,"index":21672},"line":612,"code":"  it('should not set a cache-control value when serving a page, when cache option is not set', async function () {\n    const response = await apos.http.get('/', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when serving a page, when \"page\" cache option is not set","suites":["Pages"],"updatePoint":{"line":618,"column":99,"index":21942},"line":618,"code":"  it('should not set a cache-control value when serving a page, when \"page\" cache option is not set', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444\n      }\n    };\n    const response = await apos.http.get('/', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when serving a page, when \"etags\" cache option is set","suites":["Pages"],"updatePoint":{"line":630,"column":96,"index":22326},"line":630,"code":"  it('should not set a cache-control value when serving a page, when \"etags\" cache option is set', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a cache-control value when serving a page, when \"page\" cache option is set","suites":["Pages"],"updatePoint":{"line":643,"column":91,"index":22727},"line":643,"code":"  it('should set a cache-control value when serving a page, when \"page\" cache option is set', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 5555\n      }\n    };\n    const response = await apos.http.get('/', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === 'max-age=5555');\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a custom etag when retrieving a single page","suites":["Pages"],"updatePoint":{"line":655,"column":60,"index":23081},"line":655,"code":"  it('should set a custom etag when retrieving a single page', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] === apos.asset.getReleaseId());\n    assert(eTagParts[1] === new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    assert(eTagParts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should return a 304 status code when retrieving a page with a matching etag","suites":["Pages"],"updatePoint":{"line":671,"column":81,"index":23678},"line":671,"code":"  it('should return a 304 status code when retrieving a page with a matching etag', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 304);\n    assert(response2.body === '');\n\n    // Same ETag should be sent again to the client\n    assert(response1.headers.etag === response2.headers.etag);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when retrieving a page that has been edited","suites":["Pages"],"updatePoint":{"line":696,"column":85,"index":24495},"line":696,"code":"  it('should not return a 304 status code when retrieving a page that has been edited', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    const pageDoc = await apos.doc.db.findOne({\n      slug: '/',\n      aposLocale: 'en:published'\n    });\n\n    // Edit homepage, this should invalidate its cache,\n    // so requesting it again should not return a 304 status code\n    const pageUpdateResponse = await apos.doc.update(apos.task.getReq(), pageDoc);\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New ETag has been generated, with the new value of the edited homepage's `cacheInvalidatedAt` field...\n    assert(eTag2Parts[1] === pageUpdateResponse.cacheInvalidatedAt.getTime().toString());\n    // ...and a new timestamp\n    assert(eTag2Parts[2] !== eTag1Parts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when retrieving a page after the max-age period","suites":["Pages"],"updatePoint":{"line":733,"column":89,"index":25897},"line":733,"code":"  it('should not return a 304 status code when retrieving a page after the max-age period', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true\n    });\n    const eTagParts = response1.headers.etag.split(':');\n    const outOfDateETagParts = [...eTagParts];\n    outOfDateETagParts[2] = Number(outOfDateETagParts[2]) - (4444 + 1) * 1000; // 1s outdated\n\n    const response2 = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      headers: {\n        'if-none-match': outOfDateETagParts.join(':')\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New timestamp\n    assert(eTag1Parts[2] !== eTag2Parts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should set a custom etag when serving a page","suites":["Pages"],"updatePoint":{"line":764,"column":50,"index":26944},"line":764,"code":"  it('should set a custom etag when serving a page', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/', {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] === apos.asset.getReleaseId());\n    assert(eTagParts[1]);\n    assert(eTagParts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should return a 304 status code when requesting a page with a matching etag","suites":["Pages"],"updatePoint":{"line":780,"column":81,"index":27438},"line":780,"code":"  it('should return a 304 status code when requesting a page with a matching etag', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 304);\n    assert(response2.body === '');\n\n    // Same ETag should be sent again to the client\n    assert(response1.headers.etag === response2.headers.etag);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when requesting a page that has been edited","suites":["Pages"],"updatePoint":{"line":805,"column":85,"index":28184},"line":805,"code":"  it('should not return a 304 status code when requesting a page that has been edited', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/', {\n      fullResponse: true\n    });\n    const pageDoc = await apos.doc.db.findOne({\n      slug: '/',\n      aposLocale: 'en:published'\n    });\n\n    // Edit homepage, this should invalidate its cache,\n    // so requesting it again should not return a 304 status code\n    const pageUpdateResponse = await apos.doc.update(apos.task.getReq(), pageDoc);\n    const response2 = await apos.http.get('/', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New ETag has been generated, with the new value of the edited homepage's `cacheInvalidatedAt` field...\n    assert(eTag2Parts[1] === pageUpdateResponse.cacheInvalidatedAt.getTime().toString());\n    // ...and a new timestamp\n    assert(eTag2Parts[2] !== eTag1Parts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when requesting a page with an outdated release id","suites":["Pages"],"updatePoint":{"line":842,"column":92,"index":29518},"line":842,"code":"  it('should not return a 304 status code when requesting a page with an outdated release id', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/', {\n      fullResponse: true\n    });\n    const eTagParts = response1.headers.etag.split(':');\n    const outOfDateETagParts = [...eTagParts];\n    outOfDateETagParts[0] = 'abcdefghi';\n    const response2 = await apos.http.get('/', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': outOfDateETagParts.join(':')\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New timestamp\n    assert(eTag1Parts[2] !== eTag2Parts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when requesting a page after the max-age period","suites":["Pages"],"updatePoint":{"line":872,"column":89,"index":30479},"line":872,"code":"  it('should not return a 304 status code when requesting a page after the max-age period', async function () {\n    apos.page.options.cache = {\n      page: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/', {\n      fullResponse: true\n    });\n    const eTagParts = response1.headers.etag.split(':');\n    const outOfDateETagParts = [...eTagParts];\n    outOfDateETagParts[2] = Number(outOfDateETagParts[2]) - (4444 + 1) * 1000; // 1s outdated\n\n    const response2 = await apos.http.get('/', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': outOfDateETagParts.join(':')\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New timestamp\n    assert(eTag1Parts[2] !== eTag2Parts[2]);\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a custom etag when retrieving a single page, when user is connected","suites":["Pages"],"updatePoint":{"line":903,"column":88,"index":31493},"line":903,"code":"  it('should not set a custom etag when retrieving a single page, when user is connected', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const jar = apos.http.jar();\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}`, {\n      fullResponse: true,\n      jar\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] !== apos.asset.getReleaseId());\n    assert(eTagParts[1] !== new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should not set a custom etag when retrieving a single page, when user is connected using an api key","suites":["Pages"],"updatePoint":{"line":928,"column":105,"index":32314},"line":928,"code":"  it('should not set a custom etag when retrieving a single page, when user is connected using an api key', async function () {\n    apos.page.options.cache = {\n      api: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response = await apos.http.get(`/api/v1/@apostrophecms/page/${homeId}?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] !== apos.asset.getReleaseId());\n    assert(eTagParts[1] !== new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    delete apos.page.options.cache;\n  });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should remove the published and previous versions of a page","suites":["Pages","unpublish"],"updatePoint":{"line":989,"column":67,"index":34130},"line":989,"code":"    it('should remove the published and previous versions of a page', function () {\n      assert(published === null);\n      assert(previous === null);\n    });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should update the draft version of a page","suites":["Pages","unpublish"],"updatePoint":{"line":993,"column":49,"index":34271},"line":993,"code":"    it('should update the draft version of a page', function () {\n      assert(draft._id === draftItem._id);\n      assert(draft.modified === true);\n      assert(draft.lastPublishedAt === null);\n    });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should have a \"share\" method that returns a draft with aposShareKey","suites":["Pages","draft sharing","share"],"updatePoint":{"line":1038,"column":77,"index":35781},"line":1038,"code":"      it('should have a \"share\" method that returns a draft with aposShareKey', async function () {\n        const draft = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:draft`\n        });\n        const published = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:published`\n        });\n        assert(apos.page.share);\n        assert(!Object.prototype.hasOwnProperty.call(published, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(previousDraft, 'aposShareKey'));\n        assert(shareResponse.aposShareKey);\n        assert(draft.aposShareKey);\n        assert(shareResponse.aposShareKey === draft.aposShareKey);\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft after having enabled draft sharing","suites":["Pages","draft sharing","share"],"updatePoint":{"line":1052,"column":82,"index":36482},"line":1052,"code":"      it('should grant public access to a draft after having enabled draft sharing', async function () {\n        const publicUrl = generatePublicUrl(shareResponse);\n        const response = await apos.http.get(shareResponse._url, {\n          fullResponse: true\n        });\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true\n        });\n        assert(response.status === 200);\n        assert(response.body.includes('Some Page'));\n        assert(!response.body.includes('Some Page EDITED'));\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Page EDITED'));\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft without admin UI, even when logged-in","suites":["Pages","draft sharing","share"],"updatePoint":{"line":1066,"column":85,"index":37141},"line":1066,"code":"      it('should grant public access to a draft without admin UI, even when logged-in', async function () {\n        const jar = apos.http.jar();\n        await apos.http.post('/api/v1/@apostrophecms/login/login', {\n          body: {\n            username: 'admin',\n            password: 'admin',\n            session: true\n          },\n          jar\n        });\n        const publicUrl = generatePublicUrl(shareResponse);\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true,\n          jar\n        });\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Page EDITED'));\n        assert(!publicResponse.body.includes('apos-admin-bar'));\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft after having re-enabled draft sharing","suites":["Pages","draft sharing","share"],"updatePoint":{"line":1085,"column":85,"index":37868},"line":1085,"code":"      it('should grant public access to a draft after having re-enabled draft sharing', async function () {\n        await apos.page.unshare(req, previousDraft);\n        const shareResponse = await apos.page.share(req, previousDraft);\n        const publicUrl = generatePublicUrl(shareResponse);\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true\n        });\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Page EDITED'));\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should have a \"unshare\" method that returns a draft without aposShareKey","suites":["Pages","draft sharing","unshare"],"updatePoint":{"line":1100,"column":82,"index":38552},"line":1100,"code":"      it('should have a \"unshare\" method that returns a draft without aposShareKey', async function () {\n        const unshareResponse = await apos.page.unshare(req, previousDraft);\n        const draft = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:draft`\n        });\n        const published = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:published`\n        });\n        assert(apos.page.unshare);\n        assert(!Object.prototype.hasOwnProperty.call(previousPublished, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(previousDraft, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(published, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(draft, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(unshareResponse, 'aposShareKey'));\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"should remove public access to a draft after having disabled draft sharing","suites":["Pages","draft sharing","unshare"],"updatePoint":{"line":1115,"column":84,"index":39443},"line":1115,"code":"      it('should remove public access to a draft after having disabled draft sharing', async function () {\n        await apos.page.unshare(req, previousDraft);\n        try {\n          const publicUrl = generatePublicUrl(shareResponse);\n          await apos.http.get(publicUrl, {\n            fullResponse: true\n          });\n        } catch (error) {\n          assert(error.status === 404);\n          return;\n        }\n        throw new Error('should have thrown 404 error');\n      });","file":"pages.js","skipped":false,"dir":"test"},{"name":"standard and custom parked pages should be as expected","suites":["Parked Pages"],"updatePoint":{"line":37,"column":60,"index":845},"line":37,"code":"  it('standard and custom parked pages should be as expected', async function () {\n    this.timeout(20000);\n    apos = await t.create({\n      root: module,\n      modules: {\n        'default-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    const req = apos.task.getReq();\n    const home = await apos.page.find(req, {\n      slug: '/'\n    }).toObject();\n    assert(home);\n    assert(home.parkedId === 'home');\n    assert(home.type === '@apostrophecms/home-page');\n    const archive = await apos.page.find(req, {\n      slug: '/archive'\n    }).archived(true).toObject();\n    assert(archive);\n    assert(archive.parkedId === 'archive');\n    assert(archive.type === '@apostrophecms/archive-page');\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"overridden home page should work without disturbing archive","suites":["Parked Pages"],"updatePoint":{"line":61,"column":65,"index":1582},"line":61,"code":"  it('overridden home page should work without disturbing archive', async function () {\n    this.timeout(20000);\n    apos2 = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: park2\n          }\n        },\n        'default-page': {}\n      }\n    });\n    const req = apos2.task.getAnonReq();\n    const home = await apos2.page.find(req, {\n      slug: '/'\n    }).toObject();\n    assert(home);\n    assert(home.parkedId === 'home');\n    assert(home.type === 'default-page');\n    const archive = await apos2.page.find(req, {\n      slug: '/archive'\n    }).archived(true).toObject();\n    assert(archive);\n    assert(archive.parkedId === 'archive');\n    assert(archive.type === '@apostrophecms/archive-page');\n    await apos2.db.collection('verify').insertOne({\n      checkSameDb: true\n    });\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"all pages should have consistent aposDocId across draft and published","suites":["Parked Pages"],"updatePoint":{"line":91,"column":75,"index":2456},"line":91,"code":"  it('all pages should have consistent aposDocId across draft and published', async function () {\n    this.timeout(20000);\n    await validate(apos2, ['/', '/archive', '/default1', '/default2']);\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"third apos object should park a third child correctly when spinning up later on existing db","suites":["Parked Pages"],"updatePoint":{"line":95,"column":97,"index":2679},"line":95,"code":"  it('third apos object should park a third child correctly when spinning up later on existing db', async function () {\n    this.timeout(20000);\n    apos3 = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [...park2, {\n              slug: '/default3',\n              parkedId: 'default3',\n              _defaults: {\n                type: 'default-page',\n                title: 'Default 3'\n              }\n            }]\n          }\n        },\n        'default-page': {}\n      },\n      shortName: apos2.options.shortName\n    });\n    // prove apos2 and apos3 are talking to the same db and it hasn't been erased\n    assert(await apos3.db.collection('verify').findOne({\n      checkSameDb: true\n    }));\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"all pages should have consistent aposDocId across draft and published (2)","suites":["Parked Pages"],"updatePoint":{"line":121,"column":79,"index":3443},"line":121,"code":"  it('all pages should have consistent aposDocId across draft and published (2)', async function () {\n    await validate(apos3, ['/', '/archive', '/default1', '/default2', '/default3']);\n    // Should be same db, make sure of that\n    await validate(apos2, ['/', '/archive', '/default1', '/default2', '/default3']);\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"nested parked children work","suites":["Parked Pages"],"updatePoint":{"line":126,"column":33,"index":3719},"line":126,"code":"  it('nested parked children work', async function () {\n    this.timeout(20000);\n    apos4 = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [...park2, {\n              slug: '/default3',\n              parkedId: 'default3',\n              _defaults: {\n                type: 'default-page',\n                title: 'Default 3'\n              },\n              _children: [{\n                slug: '/default3/child1',\n                parkedId: 'default3child1',\n                _defaults: {\n                  type: 'default-page',\n                  title: 'Default 3 Child 1'\n                }\n              }]\n            }]\n          }\n        },\n        'default-page': {}\n      },\n      shortName: apos2.options.shortName\n    });\n    await validate(apos4, ['/', '/archive', '/default1', '/default2', '/default3', '/default3/child1']);\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"nested parked children work across locales if locales are added later","suites":["Parked Pages"],"updatePoint":{"line":157,"column":75,"index":4676},"line":157,"code":"  it('nested parked children work across locales if locales are added later', async function () {\n    this.timeout(20000);\n    apos5 = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/i18n': {\n          options: {\n            locales: {\n              en: {\n                label: 'English',\n                hostname: 'en'\n              },\n              fr: {\n                label: 'French',\n                hostname: 'fr'\n              }\n            }\n          }\n        },\n        '@apostrophecms/page': {\n          options: {\n            park: [...park2, {\n              slug: '/default3',\n              parkedId: 'default3',\n              _defaults: {\n                type: 'default-page',\n                title: 'Default 3'\n              },\n              _children: [{\n                slug: '/default3/child1',\n                parkedId: 'default3child1',\n                _defaults: {\n                  type: 'default-page',\n                  title: 'Default 3 Child 1'\n                }\n              }]\n            }]\n          }\n        },\n        'default-page': {}\n      },\n      shortName: apos4.options.shortName\n    });\n    await validate(apos5, ['/', '/archive', '/default1', '/default2', '/default3', '/default3/child1']);\n  });","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"nested parked children work across locales if locales are present from the start","suites":["Parked Pages"],"updatePoint":{"line":203,"column":84,"index":5962},"line":203,"code":"it('nested parked children work across locales if locales are present from the start', async function () {\n  this.timeout(20000);\n  apos6 = await t.create({\n    root: module,\n    modules: {\n      '@apostrophecms/i18n': {\n        options: {\n          locales: {\n            en: {\n              label: 'English',\n              hostname: 'en'\n            },\n            fr: {\n              label: 'French',\n              hostname: 'fr'\n            }\n          }\n        }\n      },\n      '@apostrophecms/page': {\n        options: {\n          park: [...park2, {\n            slug: '/default3',\n            parkedId: 'default3',\n            _defaults: {\n              type: 'default-page',\n              title: 'Default 3'\n            },\n            _children: [{\n              slug: '/default3/child1',\n              parkedId: 'default3child1',\n              _defaults: {\n                type: 'default-page',\n                title: 'Default 3 Child 1'\n              }\n            }]\n          }]\n        }\n      },\n      'default-page': {}\n    }\n  });\n  await validate(apos6, ['/', '/archive', '/default1', '/default2', '/default3', '/default3/child1']);\n});","file":"parked-pages.js","skipped":false,"dir":"test"},{"name":"should have a permissions property","suites":["Permissions"],"updatePoint":{"line":17,"column":40,"index":434},"line":17,"code":"  it('should have a permissions property', async function () {\n    assert(apos.permission.__meta.name = '@apostrophecms/permission');\n  });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"allows the public to view by type","suites":["Permissions","methods","can"],"updatePoint":{"line":22,"column":43,"index":647},"line":22,"code":"      it('allows the public to view by type', function () {\n        assert(apos.permission.can(apos.task.getAnonReq(), 'view', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"allows the admin to view by type","suites":["Permissions","methods","can"],"updatePoint":{"line":25,"column":42,"index":813},"line":25,"code":"      it('allows the admin to view by type', function () {\n        assert(apos.permission.can(apos.task.getAdminReq(), 'view', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"Forbids the public to update by type","suites":["Permissions","methods","can"],"updatePoint":{"line":28,"column":46,"index":984},"line":28,"code":"      it('Forbids the public to update by type', function () {\n        assert(!apos.permission.can(apos.task.getAnonReq(), 'edit', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"Forbids the contributor to update by type in published mode","suites":["Permissions","methods","can"],"updatePoint":{"line":31,"column":69,"index":1178},"line":31,"code":"      it('Forbids the contributor to update by type in published mode', function () {\n        assert(!apos.permission.can(apos.task.getContributorReq(), 'edit', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"Allows the editor to update by type in published mode","suites":["Permissions","methods","can"],"updatePoint":{"line":34,"column":63,"index":1373},"line":34,"code":"      it('Allows the editor to update by type in published mode', function () {\n        assert(apos.permission.can(apos.task.getEditorReq(), 'edit', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"Allows the admin to update by type","suites":["Permissions","methods","can"],"updatePoint":{"line":37,"column":44,"index":1543},"line":37,"code":"      it('Allows the admin to update by type', function () {\n        assert(apos.permission.can(apos.task.getAdminReq(), 'edit', '@apostrophecms/home-page'));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"allows the public to view a particular doc via criteria and via can()","suites":["Permissions","methods","can"],"updatePoint":{"line":40,"column":79,"index":1747},"line":40,"code":"      it('allows the public to view a particular doc via criteria and via can()', async function () {\n        const req = apos.task.getAnonReq();\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        assert(apos.permission.can(apos.task.getAnonReq(), 'view', home));\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"public cannot update via actual update api","suites":["Permissions","methods","can"],"updatePoint":{"line":48,"column":52,"index":2065},"line":48,"code":"      it('public cannot update via actual update api', async function () {\n        const req = apos.task.getAnonReq();\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        try {\n          home.visibility = 'loginRequired';\n          await apos.page.update(req, home);\n          assert(false);\n        } catch (e) {\n          assert(e.message === 'forbidden');\n        }\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"contributor cannot update published doc via actual update api","suites":["Permissions","methods","can"],"updatePoint":{"line":62,"column":71,"index":2533},"line":62,"code":"      it('contributor cannot update published doc via actual update api', async function () {\n        const req = apos.task.getContributorReq();\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        try {\n          home.title = 'Contributor Updated';\n          await apos.page.update(req, home);\n          assert(false);\n        } catch (e) {\n          assert(e.message === 'forbidden');\n        }\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"contributor can update draft doc via actual update api","suites":["Permissions","methods","can"],"updatePoint":{"line":76,"column":64,"index":3002},"line":76,"code":"      it('contributor can update draft doc via actual update api', async function () {\n        const req = apos.task.getContributorReq({\n          mode: 'draft'\n        });\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        home.title = 'Contributor Updated';\n        const updated = await apos.page.update(req, home);\n        assert(updated.title === 'Contributor Updated');\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"contributor cannot publish doc","suites":["Permissions","methods","can"],"updatePoint":{"line":88,"column":40,"index":3435},"line":88,"code":"      it('contributor cannot publish doc', async function () {\n        const req = apos.task.getContributorReq({\n          mode: 'draft'\n        });\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        try {\n          await apos.page.publish(req, home);\n          assert(false);\n        } catch (e) {\n          assert(e.message === 'forbidden');\n        }\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"editor can publish doc","suites":["Permissions","methods","can"],"updatePoint":{"line":103,"column":32,"index":3862},"line":103,"code":"      it('editor can publish doc', async function () {\n        const req = apos.task.getEditorReq({\n          mode: 'draft'\n        });\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        await apos.page.publish(req, home);\n        const pReq = apos.task.getEditorReq();\n        const pHome = await apos.page.find(pReq, {\n          slug: '/'\n        }).toObject();\n        assert(pHome.title === 'Contributor Updated');\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"editor can update published doc via actual update api","suites":["Permissions","methods","can"],"updatePoint":{"line":118,"column":63,"index":4393},"line":118,"code":"      it('editor can update published doc via actual update api', async function () {\n        const req = apos.task.getEditorReq();\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        home.title = 'Editor Updated';\n        const updated = await apos.page.update(req, home);\n        assert(updated.title === 'Editor Updated');\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"admin can update via actual update api","suites":["Permissions","methods","can"],"updatePoint":{"line":128,"column":48,"index":4784},"line":128,"code":"      it('admin can update via actual update api', async function () {\n        const req = apos.task.getAdminReq();\n        const home = await apos.page.find(req, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n        home.visibility = 'loginRequired';\n        await apos.page.update(req, home);\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"public cannot access when visibility is loginRequired","suites":["Permissions","methods","can"],"updatePoint":{"line":137,"column":63,"index":5125},"line":137,"code":"      it('public cannot access when visibility is loginRequired', async function () {\n        const anonReq = apos.task.getAnonReq();\n        const home = await apos.page.find(anonReq, {\n          slug: '/'\n        }).toObject();\n        assert(!home);\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"guest can access when visibility is loginRequired","suites":["Permissions","methods","can"],"updatePoint":{"line":144,"column":59,"index":5384},"line":144,"code":"      it('guest can access when visibility is loginRequired', async function () {\n        const guestReq = apos.task.getGuestReq();\n        const home = await apos.page.find(guestReq, {\n          slug: '/'\n        }).toObject();\n        assert(home);\n      });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"should return the right permission sets for \"\" role","suites":["Permissions","apiRoutes","GET","grid"],"updatePoint":{"line":163,"column":72,"index":5999},"line":163,"code":"          it(`should return the right permission sets for \"${role}\" role`, async function () {\n            const {\n              permissionSets\n            } = await apos.http.get(`${apos.permission.action}/grid`, {\n              qs: {\n                role\n              },\n              jar\n            });\n            assert.deepEqual(permissionSets, expectedPermissionSetsByRole[role]);\n          });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"should return the right permission sets for \"\" role","suites":["Permissions","apiRoutes","POST","grid"],"updatePoint":{"line":180,"column":72,"index":6537},"line":180,"code":"          it(`should return the right permission sets for \"${role}\" role`, async function () {\n            const {\n              permissionSets\n            } = await apos.http.post(`${apos.permission.action}/grid`, {\n              body: {\n                role\n              },\n              jar\n            });\n            assert.deepEqual(permissionSets, expectedPermissionSetsByRole[role]);\n          });","file":"permissions.js","skipped":false,"dir":"test"},{"name":"should fail to initialize with a schema containing a field named \"type\"","suites":["Malformed Pieces"],"updatePoint":{"line":8,"column":77,"index":270},"line":8,"code":"  it('should fail to initialize with a schema containing a field named \"type\"', function (done) {\n    let throwsError = true;\n    const mochaProcess = spawn('node', ['./test/pieces-children/pieces-malformed-child.js']);\n    mochaProcess.stdout.on('data', data => {\n      console.log(`Mocha output: ${data}`);\n    });\n    mochaProcess.stderr.on('data', data => {\n      const errorMsg = data.toString();\n      const errorMatch = errorMsg.match(/(?<error>Error:.*\\n)/);\n      if (errorMatch) {\n        throwsError = true;\n        assert.equal(errorMatch.groups.error, 'Error: The malformed module contains a forbidden field property name: \"type\".\\n');\n      } else {\n        throwsError = false;\n      }\n    });\n    mochaProcess.on('close', code => {\n      assert.equal(code, 1, 'Mocha process exited with status code 0');\n      assert.ok(throwsError, 'Error message not found in stderr');\n      done();\n    });\n  });","file":"pieces-malformed.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Pieces Pages"],"updatePoint":{"line":12,"column":23,"index":255},"line":12,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        event: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            name: 'event',\n            label: 'Event',\n            alias: 'event',\n            sort: {\n              title: 1\n            }\n          }\n        },\n        'event-page': {\n          extend: '@apostrophecms/piece-page-type',\n          options: {\n            name: 'eventPage',\n            label: 'Event',\n            alias: 'eventPage',\n            perPage: 10\n          }\n        },\n        home: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            name: 'home',\n            label: 'Home',\n            alias: 'home',\n            sort: {\n              title: 1\n            }\n          }\n        },\n        'home-page': {\n          extend: '@apostrophecms/piece-page-type',\n          options: {\n            name: 'homePiecePage',\n            label: 'Home Piece Page',\n            alias: 'homePiecePage',\n            perPage: 10\n          }\n        },\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              title: 'Events',\n              type: 'eventPage',\n              slug: '/events',\n              parkedId: 'events'\n            }, {\n              title: 'Home piece page',\n              type: 'homePiecePage',\n              slug: '/',\n              parkedId: 'home'\n            }]\n          }\n        }\n      }\n    });\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should be able to use db to insert test pieces","suites":["Pieces Pages"],"updatePoint":{"line":74,"column":52,"index":1786},"line":74,"code":"  it('should be able to use db to insert test pieces', async function () {\n    assert(apos.modules.event);\n    const testItems = [];\n    const total = 100;\n    for (let i = 1; i <= total; i++) {\n      const paddedInt = apos.launder.padInteger(i, 3);\n      testItems.push({\n        _id: 'event' + paddedInt,\n        slug: 'event-' + paddedInt,\n        visibility: 'public',\n        type: 'event',\n        title: 'Event ' + paddedInt,\n        titleSortified: 'event ' + paddedInt,\n        body: {\n          metaType: 'area',\n          _id: apos.util.generateId(),\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            content: '<p>This is some content.</p>'\n          }]\n        }\n      });\n    }\n    return apos.doc.db.insertMany(testItems);\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should be able to use db to insert test \"home\" pieces","suites":["Pieces Pages"],"updatePoint":{"line":100,"column":59,"index":2596},"line":100,"code":"  it('should be able to use db to insert test \"home\" pieces', async function () {\n    assert(apos.modules.home);\n    const testItems = [];\n    const total = 100;\n    for (let i = 1; i <= total; i++) {\n      const paddedInt = apos.launder.padInteger(i, 3);\n      testItems.push({\n        _id: 'home' + paddedInt,\n        slug: 'home-' + paddedInt,\n        visibility: 'public',\n        type: 'home',\n        title: 'Home ' + paddedInt,\n        titleSortified: 'home ' + paddedInt,\n        body: {\n          metaType: 'area',\n          _id: apos.util.generateId(),\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            content: '<p>This is some content.</p>'\n          }]\n        }\n      });\n    }\n    return apos.doc.db.insertMany(testItems);\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should populate the ._url property of pieces in any docs query","suites":["Pieces Pages"],"updatePoint":{"line":126,"column":68,"index":3409},"line":126,"code":"  it('should populate the ._url property of pieces in any docs query', async function () {\n    const piece = await apos.doc.find(apos.task.getAnonReq(), {\n      type: 'event',\n      title: 'Event 001'\n    }).toObject();\n    assert(piece);\n    assert(piece._url);\n    assert(piece._url === '/events/event-001');\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should not correctly populate the ._url property of pieces in a docs query with an inadequate projection","suites":["Pieces Pages"],"updatePoint":{"line":135,"column":110,"index":3768},"line":135,"code":"  it('should not correctly populate the ._url property of pieces in a docs query with an inadequate projection', async function () {\n    const piece = await apos.doc.find(apos.task.getAnonReq(), {\n      type: 'event',\n      title: 'Event 001'\n    }, {\n      project: {\n        type: 1\n      }\n    }).toObject();\n    assert(piece);\n    assert(!piece._url || piece._url.match(/undefined/));\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should not create a double-slashed _url on a piece-page-type set as the homepage","suites":["Pieces Pages"],"updatePoint":{"line":147,"column":86,"index":4139},"line":147,"code":"  it('should not create a double-slashed _url on a piece-page-type set as the homepage', async function () {\n    const piece = await apos.doc.find(apos.task.getAnonReq(), {\n      type: 'home',\n      title: 'Home 001'\n    }).toObject();\n    assert(piece);\n    assert(piece._url === '/home-001');\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should correctly populate the ._url property of pieces in a docs query if _url itself is \"projected\"","suites":["Pieces Pages"],"updatePoint":{"line":155,"column":106,"index":4460},"line":155,"code":"  it('should correctly populate the ._url property of pieces in a docs query if _url itself is \"projected\"', async function () {\n    const piece = await apos.doc.find(apos.task.getAnonReq(), {\n      type: 'event',\n      title: 'Event 001'\n    }, {\n      project: {\n        _url: 1\n      }\n    }).toObject();\n    assert(piece);\n    assert(piece._url);\n    assert(piece._url === '/events/event-001');\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should be able to access index page with first event on it, but not eleventh event","suites":["Pieces Pages"],"updatePoint":{"line":168,"column":88,"index":4847},"line":168,"code":"  it('should be able to access index page with first event on it, but not eleventh event', async function () {\n    const body = await apos.http.get('/events');\n    // Only page one events should show up\n    assert(body.match(/event-001\"/));\n    assert(!body.match(/event-011\"/));\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should be able to access second page","suites":["Pieces Pages"],"updatePoint":{"line":174,"column":42,"index":5087},"line":174,"code":"  it('should be able to access second page', async function () {\n    const body = await apos.http.get('/events?page=2');\n    // Only page two events should show up\n    assert(body.match(/event-011\"/));\n    assert(!body.match(/event-001\"/));\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should be able to access \"show\" page for first event, should not also contain second event","suites":["Pieces Pages"],"updatePoint":{"line":180,"column":96,"index":5388},"line":180,"code":"  it('should be able to access \"show\" page for first event, should not also contain second event', async function () {\n    const body = await apos.http.get('/events/event-001');\n    // Only event 1's title should show up\n    assert(body.match(/Event 001/));\n    assert(!body.match(/Event 002/));\n  });","file":"pieces-page-type.js","skipped":false,"dir":"test"},{"name":"should initialize with a schema","suites":["Pieces Public API"],"updatePoint":{"line":16,"column":37,"index":350},"line":16,"code":"  it('should initialize with a schema', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        thing: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            alias: 'thing',\n            label: 'Thing'\n          },\n          fields: {\n            add: {\n              foo: {\n                label: 'Foo',\n                type: 'string'\n              },\n              _image: {\n                label: 'Image',\n                type: 'relationship',\n                withType: '@apostrophecms/image',\n                max: 1\n              }\n            }\n          }\n        }\n      }\n    });\n    assert(apos.modules.thing);\n    assert(apos.modules.thing.schema);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should be able to insert a piece into the database","suites":["Pieces Public API"],"updatePoint":{"line":52,"column":56,"index":1220},"line":52,"code":"  it('should be able to insert a piece into the database', async function () {\n    await apos.thing.insert(apos.task.getReq(), testThing);\n    const thing = await apos.thing.find(apos.task.getReq(), {\n      _id: 'testThing:en:published'\n    }).toObject();\n    assert(thing);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should not be able to anonymously retrieve a piece by id from the database without a public API projection","suites":["Pieces Public API"],"updatePoint":{"line":59,"column":112,"index":1557},"line":59,"code":"  it('should not be able to anonymously retrieve a piece by id from the database without a public API projection', async function () {\n    try {\n      await apos.http.get('/api/v1/thing');\n      // Bad, we expected a 404\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should not be able to retrieve a piece by id from the database without a public API projection as a guest","suites":["Pieces Public API"],"updatePoint":{"line":68,"column":111,"index":1860},"line":68,"code":"  it('should not be able to retrieve a piece by id from the database without a public API projection as a guest', async function () {\n    await t.createUser(apos, 'guest');\n    const jar = await t.loginAs(apos, 'guest');\n    try {\n      await apos.http.get('/api/v1/thing', {\n        jar\n      });\n      // Bad, we expected a 404\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve a piece by id from the database without a public API projection as a guest if guest API access is enabled","suites":["Pieces Public API"],"updatePoint":{"line":81,"column":138,"index":2300},"line":81,"code":"  it('should be able to retrieve a piece by id from the database without a public API projection as a guest if guest API access is enabled', async function () {\n    let response;\n    try {\n      apos.modules.thing.options.guestApiAccess = true;\n      const jar = await t.loginAs(apos, 'guest');\n      response = await apos.http.get('/api/v1/thing', {\n        jar\n      });\n    } finally {\n      apos.modules.thing.options.guestApiAccess = false;\n    }\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 1);\n    assert(response.results[0].title === 'hello');\n    assert(response.results[0].foo === 'bar');\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should be able to anonymously retrieve a piece by id from the database with a public API projection","suites":["Pieces Public API"],"updatePoint":{"line":98,"column":105,"index":2918},"line":98,"code":"  it('should be able to anonymously retrieve a piece by id from the database with a public API projection', async function () {\n    // Patch the option setting to simplify the test code\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    const response = await apos.http.get('/api/v1/thing');\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 1);\n    assert(response.results[0].title === 'hello');\n    assert(!response.results[0].foo);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should not set a \"max-age\" cache-control value when retrieving pieces, when cache option is not set, with a public API projection","suites":["Pieces Public API"],"updatePoint":{"line":111,"column":135,"index":3467},"line":111,"code":"  it('should not set a \"max-age\" cache-control value when retrieving pieces, when cache option is not set, with a public API projection', async function () {\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should not set a \"max-age\" cache-control value when retrieving a single piece, when \"etags\" cache option is set, with a public API projection","suites":["Pieces Public API"],"updatePoint":{"line":125,"column":147,"index":4062},"line":125,"code":"  it('should not set a \"max-age\" cache-control value when retrieving a single piece, when \"etags\" cache option is set, with a public API projection', async function () {\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 2222,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should set a \"max-age\" cache-control value when retrieving pieces, with a public API projection","suites":["Pieces Public API"],"updatePoint":{"line":141,"column":101,"index":4556},"line":141,"code":"  it('should set a \"max-age\" cache-control value when retrieving pieces, with a public API projection', async function () {\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 2222\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'max-age=2222');\n    assert(response2.headers['cache-control'] === 'max-age=2222');\n    delete apos.thing.options.cache;\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should set a custom etag when retrieving a single piece","suites":["Pieces Public API"],"updatePoint":{"line":161,"column":61,"index":5194},"line":161,"code":"  it('should set a custom etag when retrieving a single piece', async function () {\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1\n    };\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] === apos.asset.getReleaseId());\n    assert(eTagParts[1] === new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    assert(eTagParts[2]);\n    delete apos.thing.options.cache;\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should resolve _urls for image attachments","suites":["Pieces Public API"],"updatePoint":{"line":181,"column":48,"index":5843},"line":181,"code":"  it('should resolve _urls for image attachments', async function () {\n    // Reproduces https://github.com/apostrophecms/apostrophe/issues/3643\n    // Create piece with image\n    await await apos.doc.db.deleteMany({\n      type: 'thing'\n    });\n    const req = apos.task.getReq();\n    await wipeUploads();\n    const attachment = await upload('upload_image.png');\n    const image = await apos.image.insert(req, {\n      type: '@apostrophecms/image',\n      slug: 'image-1',\n      visibility: 'public',\n      attachment\n    });\n    await apos.thing.insert(req, {\n      ...testThing,\n      _id: 'testThingAttachment:en:published',\n      title: 'Hello Image',\n      _image: [image]\n    });\n    apos.thing.options.publicApiProjection = {\n      title: 1,\n      _url: 1,\n      _image: 1\n    };\n\n    // Test\n    const response = await apos.http.get('/api/v1/thing');\n    assert(response);\n    assert.strictEqual(response.results.length, 1);\n    const [img] = response.results[0]._image;\n    assert(img);\n    const att = img.attachment;\n    assert(att);\n    assert(att._urls);\n    assert(Object.keys(att._urls).length > 0);\n  });","file":"pieces-public-api.js","skipped":false,"dir":"test"},{"name":"should generate pieces","suites":["Pieces - tasks"],"updatePoint":{"line":29,"column":28,"index":665},"line":29,"code":"  it('should generate pieces', async function () {\n    const before = await apos.doc.db.find({\n      type: 'article'\n    }).count();\n    assert.equal(before, 0);\n    await apos.task.invoke('article:generate', {\n      total: 10\n    });\n    const after = await apos.doc.db.find({\n      type: 'article'\n    }).count();\n    assert.equal(after, 20);\n  });","file":"pieces-tasks.js","skipped":false,"dir":"test"},{"name":"should touch pieces","suites":["Pieces - tasks"],"updatePoint":{"line":42,"column":25,"index":1013},"line":42,"code":"  it('should touch pieces', async function () {\n    await apos.task.invoke('article:generate', {\n      total: 10\n    });\n    const docs = await apos.doc.db.find({\n      type: 'article'\n    }).toArray();\n    assert.equal(docs.length, 20);\n    const result = await apos.task.invoke('article:touch');\n    assert.equal(result.touched, 20);\n    assert.equal(result.errors, 0);\n    const touched = await apos.doc.db.find({\n      type: 'article'\n    }).toArray();\n    assert.equal(touched.length, 20);\n    for (const doc of touched) {\n      const old = docs.find(d => d._id === doc._id);\n      assert(old);\n      assert(old.updatedAt);\n      assert(doc.updatedAt);\n      assert.equal(new Date(doc.updatedAt) > new Date(old.updatedAt), true);\n    }\n  });","file":"pieces-tasks.js","skipped":false,"dir":"test"},{"name":"should touch pieces with autopublish enabled","suites":["Pieces - tasks"],"updatePoint":{"line":65,"column":50,"index":1785},"line":65,"code":"  it('should touch pieces with autopublish enabled', async function () {\n    apos.article.options.autopublish = true;\n    await apos.task.invoke('article:generate', {\n      total: 10\n    });\n    const docs = await apos.doc.db.find({\n      type: 'article'\n    }).toArray();\n    assert.equal(docs.length, 30);\n    const result = await apos.task.invoke('article:touch');\n    assert.equal(result.touched, 10);\n    assert.equal(result.errors, 0);\n    const touched = await apos.doc.db.find({\n      type: 'article'\n    }).toArray();\n    assert.equal(touched.length, 30);\n    for (const doc of touched) {\n      const old = docs.find(d => d._id === doc._id);\n      assert(old);\n      assert(old.updatedAt);\n      assert(doc.updatedAt);\n      assert.equal(new Date(doc.updatedAt) > new Date(old.updatedAt), true);\n    }\n  });","file":"pieces-tasks.js","skipped":false,"dir":"test"},{"name":"should initialize with a schema","suites":["Pieces"],"updatePoint":{"line":369,"column":37,"index":9723},"line":369,"code":"  it('should initialize with a schema', function () {\n    assert(apos.modules.thing);\n    assert(apos.modules.thing.schema);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to create a new piece","suites":["Pieces"],"updatePoint":{"line":410,"column":42,"index":10735},"line":410,"code":"  it('should be able to create a new piece', function () {\n    assert(apos.modules.thing.newInstance);\n    const thing = apos.modules.thing.newInstance();\n    assert(thing);\n    assert(thing.type === 'thing');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to insert a piece into the database","suites":["Pieces"],"updatePoint":{"line":418,"column":56,"index":10992},"line":418,"code":"  it('should be able to insert a piece into the database', async function () {\n    assert(apos.modules.thing.insert);\n    insertedOne = await apos.modules.thing.insert(apos.task.getReq(), testThing);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to insert a second piece into the database","suites":["Pieces"],"updatePoint":{"line":422,"column":63,"index":11205},"line":422,"code":"  it('should be able to insert a second piece into the database', async function () {\n    assert(apos.modules.thing.insert);\n    const template = {\n      ...testThing\n    };\n    template._id = null;\n    template.aposDocId = null;\n    template.title = 'hello #2';\n    insertedTwo = await apos.modules.thing.insert(apos.task.getReq(), template);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve a piece by id from the database","suites":["Pieces"],"updatePoint":{"line":432,"column":64,"index":11556},"line":432,"code":"  it('should be able to retrieve a piece by id from the database', async function () {\n    assert(apos.modules.thing.requireOneForEditing);\n    const req = apos.task.getReq();\n    req.piece = await apos.modules.thing.requireOneForEditing(req, {\n      _id: 'testThing:en:published'\n    });\n    assert(req.piece);\n    assert(req.piece._id === 'testThing:en:published');\n    assert(req.piece.title === 'hello');\n    assert(req.piece.foo === 'bar');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve the next piece from the database per sort order","suites":["Pieces"],"updatePoint":{"line":443,"column":80,"index":12024},"line":443,"code":"  it('should be able to retrieve the next piece from the database per sort order', async function () {\n    const req = apos.task.getReq();\n    // The default sort order is reverse chronological, so \"next\" is older, not newer\n    const next = await apos.modules.thing.find(req).next(insertedTwo).toObject();\n    assert(next.title === 'hello');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve the previous piece from the database","suites":["Pieces"],"updatePoint":{"line":449,"column":69,"index":12362},"line":449,"code":"  it('should be able to retrieve the previous piece from the database', async function () {\n    const req = apos.task.getReq();\n    // The default sort order is reverse chronological, so \"previous\" is newer, not older\n    const previous = await apos.modules.thing.find(req).previous(insertedOne).toObject();\n    assert(previous.title === 'hello #2');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to update a piece in the database","suites":["Pieces"],"updatePoint":{"line":457,"column":54,"index":12731},"line":457,"code":"  it('should be able to update a piece in the database', async function () {\n    assert(apos.modules.thing.update);\n    testThing.foo = 'moo';\n    const piece = await apos.modules.thing.update(apos.task.getReq(), testThing);\n    assert(testThing === piece);\n    // Now let's get the piece and check if it was updated\n    const req = apos.task.getReq();\n    req.piece = await apos.modules.thing.requireOneForEditing(req, {\n      _id: 'testThing:en:published'\n    });\n    assert(req.piece);\n    assert(req.piece._id === 'testThing:en:published');\n    assert(req.piece.foo === 'moo');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should only execute filters that are safe and have a launder method","suites":["Pieces"],"updatePoint":{"line":473,"column":73,"index":13373},"line":473,"code":"  it('should only execute filters that are safe and have a launder method', function () {\n    let publicTest = false;\n    let manageTest = false;\n    // addListFilters should execute launder and filters for filter\n    // definitions that are safe for 'public' or 'manage' contexts\n    const mockCursor = apos.doc.find(apos.task.getAnonReq());\n    _.merge(mockCursor, {\n      builders: {\n        publicTest: {\n          launder: function (s) {\n            return 'laundered';\n          }\n        },\n        manageTest: {\n          launder: function (s) {\n            return 'laundered';\n          }\n        },\n        unsafeTest: {}\n      },\n      publicTest: function (value) {\n        assert(value === 'laundered');\n        publicTest = true;\n      },\n      manageTest: function (value) {\n        assert(value === 'laundered');\n        manageTest = true;\n      },\n      unsafeTest: function (value) {\n        assert.fail('unsafe filter ran');\n      }\n    });\n    const filters = {\n      publicTest: 'foo',\n      manageTest: 'bar',\n      unsafeTest: 'nope',\n      fakeTest: 'notEvenReal'\n    };\n    mockCursor.applyBuildersSafely(filters);\n    assert(publicTest === true);\n    assert(manageTest === true);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to archive a piece with proper deduplication","suites":["Pieces"],"updatePoint":{"line":515,"column":65,"index":14577},"line":515,"code":"  it('should be able to archive a piece with proper deduplication', async function () {\n    assert(apos.modules.thing.requireOneForEditing);\n    const req = apos.task.getReq();\n    const id = 'testThing:en:published';\n    req.body = {\n      _id: id\n    };\n    // let's make sure the piece is not archived to start\n    const piece = await findPiece(req, id);\n    assert(!piece.archived);\n    piece.archived = true;\n    await apos.modules.thing.update(req, piece);\n    // let's get the piece to make sure it is archived\n    const piece2 = await findPiece(req, id);\n    assert(piece2);\n    assert(piece2.archived === true);\n    assert(piece2.aposWasArchived === true);\n    assert.equal(piece2.slug, 'deduplicate-testThing-hello');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to rescue a archived piece with proper deduplication","suites":["Pieces"],"updatePoint":{"line":534,"column":73,"index":15319},"line":534,"code":"  it('should be able to rescue a archived piece with proper deduplication', async function () {\n    const req = apos.task.getReq();\n    const id = 'testThing:en:published';\n    req.body = {\n      _id: id\n    };\n    // let's make sure the piece is archived to start\n    const piece = await findPiece(req, id);\n    assert(piece.archived === true);\n    piece.archived = false;\n    await apos.modules.thing.update(req, piece);\n    const piece2 = await findPiece(req, id);\n    assert(piece2);\n    assert(!piece2.archived);\n    assert(!piece2.aposWasArchived);\n    assert(piece2.slug === 'hello');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to insert test users","suites":["Pieces"],"updatePoint":{"line":551,"column":41,"index":15885},"line":551,"code":"  it('should be able to insert test users', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'admin';\n    user.username = 'admin';\n    user.password = 'admin';\n    user.email = 'ad@min.com';\n    user.role = 'admin';\n    await apos.user.insert(apos.task.getReq(), user);\n    const user2 = apos.user.newInstance();\n    user2.title = 'admin2';\n    user2.username = 'admin2';\n    user2.password = 'admin2';\n    user2.email = 'ad@min2.com';\n    user2.role = 'admin';\n    return apos.user.insert(apos.task.getReq(), user2);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"people can find things via a relationship","suites":["Pieces"],"updatePoint":{"line":569,"column":47,"index":16498},"line":569,"code":"  it('people can find things via a relationship', async function () {\n    const req = apos.task.getReq();\n    for (const person of testPeople) {\n      await apos.person.insert(req, person);\n    }\n    for (const thing of additionalThings) {\n      await apos.thing.insert(req, thing);\n    }\n    const person = await apos.doc.getManager('person').find(req, {}).toObject();\n    assert(person);\n    assert(person.title === 'Bob');\n    assert(person._things);\n    assert(person._things.length === 2);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"people cannot find things via a relationship with an inadequate projection","suites":["Pieces"],"updatePoint":{"line":583,"column":80,"index":17032},"line":583,"code":"  it('people cannot find things via a relationship with an inadequate projection', function () {\n    const req = apos.task.getReq();\n    return apos.doc.getManager('person').find(req, {}, {\n      // Use the options object rather than a chainable method\n      project: {\n        title: 1\n      }\n    }).toObject().then(function (person) {\n      assert(person);\n      assert(person.title === 'Bob');\n      // Verify projection\n      assert(!person.slug);\n      assert(!person._things || person._things.length === 0);\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"people can find things via a relationship with a \"projection\" of the relationship name","suites":["Pieces"],"updatePoint":{"line":598,"column":92,"index":17573},"line":598,"code":"  it('people can find things via a relationship with a \"projection\" of the relationship name', function () {\n    const req = apos.task.getReq();\n    return apos.doc.getManager('person').find(req, {}, {\n      project: {\n        title: 1,\n        _things: 1\n      }\n    }).toObject().then(function (person) {\n      assert(person);\n      assert(person.title === 'Bob');\n      assert(person._things);\n      assert(person._things.length === 2);\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to log in as admin","suites":["Pieces"],"updatePoint":{"line":612,"column":39,"index":17974},"line":612,"code":"  it('should be able to log in as admin', async function () {\n    jar = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged out/));\n\n    // Log in\n\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n\n    // Confirm login\n    page = await apos.http.get('/', {\n      jar\n    });\n    assert(page.match(/logged in/));\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can attach a tool to a person via the REST API","suites":["Pieces"],"updatePoint":{"line":638,"column":52,"index":18519},"line":638,"code":"  it('can attach a tool to a person via the REST API', async function () {\n    const person1 = await apos.http.get('/api/v1/person/person1:en:published');\n    assert(person1);\n    const thing1 = await apos.http.get('/api/v1/thing/thing1:en:published');\n    assert(thing1);\n    person1._tools = [{\n      ...thing1,\n      _fields: {\n        skillLevel: 5\n      }\n    }];\n    await apos.http.put('/api/v1/person/person1:en:published', {\n      body: person1,\n      jar\n    });\n    const person1After = await apos.http.get('/api/v1/person/person1:en:published', {\n      jar\n    });\n    assert(person1After);\n    assert(person1After._tools);\n    assert(person1After._tools.length);\n    assert(person1After._tools[0].title === 'Red');\n    assert(person1After._tools[0]._fields);\n    assert(person1After._tools[0]._fields.skillLevel === 5);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot POST a product without a session","suites":["Pieces"],"updatePoint":{"line":663,"column":45,"index":19351},"line":663,"code":"  it('cannot POST a product without a session', async function () {\n    try {\n      await apos.http.post('/api/v1/product', {\n        body: {\n          title: 'Fake Product',\n          body: {\n            metaType: 'area',\n            items: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              id: cuid(),\n              content: '<p>This is fake</p>'\n            }]\n          }\n        }\n      });\n      // Should not get here\n      assert(false);\n    } catch (e) {\n      assert(e.status === 403);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can POST products with a session, some visible","suites":["Pieces"],"updatePoint":{"line":686,"column":52,"index":19936},"line":686,"code":"  it('can POST products with a session, some visible', async function () {\n    // range is exclusive at the top end, I want 10 things\n    let widgetId;\n    for (let i = 1; i <= 10; i++) {\n      if (i === 1) {\n        widgetId = cuid();\n      }\n      const response = await apos.http.post('/api/v1/product', {\n        body: {\n          title: 'Cool Product #' + i,\n          visibility: i & 1 ? 'loginRequired' : 'public',\n          body: {\n            metaType: 'area',\n            items: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              _id: i === 1 ? widgetId : null,\n              content: '<p>This is thing ' + i + '</p>'\n            },\n            // Intentional attempt to use duplicate _id\n            {\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              _id: i === 1 ? widgetId : null,\n              content: '<p>This is thing ' + i + ' second widget</p>'\n            }]\n          }\n        },\n        jar\n      });\n      assert(response);\n      assert(response._id);\n      assert(response.body);\n      assert(response.title === 'Cool Product #' + i);\n      assert(response.slug === 'cool-product-' + i);\n      assert(response.type === 'product');\n      assert(response.body.items[0].content === `<p>This is thing ${i}</p>`);\n      assert(response.body.items[1].content === `<p>This is thing ${i} second widget</p>`);\n      if (i === 1) {\n        // Deduplicate any duplicate ids we specified at doc level\n        assert(response.body.items[0]._id === widgetId);\n        assert(response.body.items[1]._id);\n        // Quietly deduplicated for us\n        assert(response.body.items[1]._id !== widgetId);\n        updateProduct = response;\n      } else {\n        // All new _ids if we did not specify\n        assert(response.body.items[0]._id);\n        assert(response.body.items[1]._id);\n        assert(response.body.items[0]._id !== response.body.items[1]._id);\n        assert(response.body.items[0]._id !== widgetId);\n      }\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET five of those products without the user session","suites":["Pieces"],"updatePoint":{"line":740,"column":61,"index":21986},"line":740,"code":"  it('can GET five of those products without the user session', async function () {\n    const response = await apos.http.get('/api/v1/product');\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 5);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET all of those products with a user session","suites":["Pieces"],"updatePoint":{"line":746,"column":55,"index":22226},"line":746,"code":"  it('can GET all of those products with a user session', async function () {\n    const response = await apos.http.get('/api/v1/product', {\n      jar\n    });\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 10);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET only 5 if perPage is 5","suites":["Pieces"],"updatePoint":{"line":755,"column":36,"index":22482},"line":755,"code":"  it('can GET only 5 if perPage is 5', async function () {\n    const response = await apos.http.get('/api/v1/product?perPage=5', {\n      jar\n    });\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 5);\n    firstId = response.results[0]._id;\n    assert(response.pages === 2);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a different 5 on page 2","suites":["Pieces"],"updatePoint":{"line":765,"column":37,"index":22806},"line":765,"code":"  it('can GET a different 5 on page 2', async function () {\n    const response = await apos.http.get('/api/v1/product?perPage=5&page=2', {\n      jar\n    });\n    assert(response);\n    assert(response.results);\n    assert(response.results.length === 5);\n    assert(response.results[0]._id !== firstId);\n    assert(response.pages === 2);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET the results sorted ascending","suites":["Pieces"],"updatePoint":{"line":775,"column":42,"index":23152},"line":775,"code":"  it('can GET the results sorted ascending', async function () {\n    const response = await apos.http.get('/api/v1/product?perPage=5&sort[title]=1', {\n      jar\n    });\n    const actual = response.results.map(result => result.title);\n    const expected = ['Cool Product #1', 'Cool Product #10', 'Cool Product #2', 'Cool Product #3', 'Cool Product #4'];\n    assert.deepEqual(actual, expected);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET the results sorted descending","suites":["Pieces"],"updatePoint":{"line":783,"column":43,"index":23552},"line":783,"code":"  it('can GET the results sorted descending', async function () {\n    const response = await apos.http.get('/api/v1/product?perPage=5&sort[title]=-1', {\n      jar\n    });\n    const actual = response.results.map(result => result.title);\n    const expected = ['Cool Product #9', 'Cool Product #8', 'Cool Product #7', 'Cool Product #6', 'Cool Product #5'];\n    assert.deepEqual(actual, expected);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can update a product with PUT","suites":["Pieces"],"updatePoint":{"line":791,"column":35,"index":23944},"line":791,"code":"  it('can update a product with PUT', async function () {\n    const args = {\n      body: {\n        ...updateProduct,\n        title: 'I like cheese',\n        _id: 'should-not-change:en:published'\n      },\n      jar\n    };\n    const response = await apos.http.put(`/api/v1/product/${updateProduct._id}`, args);\n    assert(response);\n    assert(response._id === updateProduct._id);\n    assert(response.title === 'I like cheese');\n    assert(response.body.items.length);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"fetch of updated product shows updated content","suites":["Pieces"],"updatePoint":{"line":806,"column":52,"index":24434},"line":806,"code":"  it('fetch of updated product shows updated content', async function () {\n    const response = await apos.http.get(`/api/v1/product/${updateProduct._id}`, {\n      jar\n    });\n    assert(response);\n    assert(response._id === updateProduct._id);\n    assert(response.title === 'I like cheese');\n    assert(response.body.items.length);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can archive a product","suites":["Pieces"],"updatePoint":{"line":815,"column":27,"index":24749},"line":815,"code":"  it('can archive a product', async function () {\n    return apos.http.patch(`/api/v1/product/${updateProduct._id}`, {\n      body: {\n        archived: true\n      },\n      jar\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot fetch a archived product","suites":["Pieces"],"updatePoint":{"line":823,"column":37,"index":24948},"line":823,"code":"  it('cannot fetch a archived product', async function () {\n    try {\n      await apos.http.get(`/api/v1/product/${updateProduct._id}`, {\n        jar\n      });\n      // Should have been a 404, 200 = test fails\n      assert(false);\n    } catch (e) {\n      assert(e.status === 404);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can fetch archived product with archived=any and the right user","suites":["Pieces"],"updatePoint":{"line":834,"column":69,"index":25273},"line":834,"code":"  it('can fetch archived product with archived=any and the right user', async function () {\n    const product = await apos.http.get(`/api/v1/product/${updateProduct._id}?archived=any`, {\n      jar\n    });\n    // Should have been a 404, 200 = test fails\n    assert(product.archived);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can insert a product with relationships","suites":["Pieces"],"updatePoint":{"line":842,"column":45,"index":25562},"line":842,"code":"  it('can insert a product with relationships', async function () {\n    let response = await apos.http.post('/api/v1/article', {\n      body: {\n        title: 'First Article',\n        name: 'first-article'\n      },\n      jar\n    });\n    const article = response;\n    assert(article);\n    assert(article.title === 'First Article');\n    article._fields = {\n      relevance: 'The very first article that was ever published about this product'\n    };\n    response = await apos.http.post('/api/v1/product', {\n      body: {\n        title: 'Product Key Product With Relationship',\n        body: {\n          metaType: 'area',\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            id: cuid(),\n            content: '<p>This is the product key product with relationship</p>'\n          }]\n        },\n        _articles: [article],\n        relationshipsInArray: [{\n          _articles: [article]\n        }],\n        relationshipsInObject: {\n          _articles: [article]\n        }\n      },\n      jar\n    });\n    assert(response._id);\n    assert(response.articlesIds[0] === article.aposDocId);\n    assert(response.articlesFields[article.aposDocId].relevance === 'The very first article that was ever published about this product');\n    assert(response.relationshipsInArray[0].articlesIds[0] === article.aposDocId);\n    assert(response.relationshipsInObject.articlesIds[0] === article.aposDocId);\n    relatedProductId = response._id;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a product with relationships","suites":["Pieces"],"updatePoint":{"line":885,"column":42,"index":27039},"line":885,"code":"  it('can GET a product with relationships', async function () {\n    const response = await apos.http.get('/api/v1/product');\n    assert(response);\n    assert(response.results);\n    const product = _.find(response.results, {\n      slug: 'product-key-product-with-relationship'\n    });\n    assert(Array.isArray(product._articles));\n    assert(product._articles.length === 1);\n    assert(product._articles[0]._fields);\n    assert.strictEqual(product._articles[0]._fields.relevance, 'The very first article that was ever published about this product');\n    assert(product.relationshipsInArray[0]._articles[0].title === 'First Article');\n    assert(product.relationshipsInObject._articles[0].title === 'First Article');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a single product with relationships","suites":["Pieces"],"updatePoint":{"line":900,"column":49,"index":27792},"line":900,"code":"  it('can GET a single product with relationships', async function () {\n    const response = await apos.http.get(`/api/v1/product/${relatedProductId}`);\n    assert(response);\n    assert(response._articles);\n    assert(response._articles.length === 1);\n    relatedArticleId = response._articles[0]._id;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a single product using projections","suites":["Pieces"],"updatePoint":{"line":907,"column":48,"index":28099},"line":907,"code":"  it('can GET a single product using projections', async function () {\n    const response = await apos.http.get(`/api/v1/product/${relatedProductId}`, {\n      qs: {\n        project: {\n          _id: 1,\n          title: 1\n        }\n      }\n    });\n    const keys = Object.keys(response);\n    assert(response);\n    assert(keys.length === 2);\n    assert(keys.every(key => ['_id', 'title'].includes(key)));\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a single article with reverse relationships","suites":["Pieces"],"updatePoint":{"line":921,"column":57,"index":28517},"line":921,"code":"  it('can GET a single article with reverse relationships', async function () {\n    const response = await apos.http.get(`/api/v1/article/${relatedArticleId}`);\n    assert(response);\n    assert(response._products);\n    assert(response._products.length === 1);\n    assert(response._products[0]._id === relatedProductId);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a single article with reverse relationships in draft mode","suites":["Pieces"],"updatePoint":{"line":928,"column":71,"index":28857},"line":928,"code":"  it('can GET a single article with reverse relationships in draft mode', async function () {\n    const draftRelatedArticleId = relatedArticleId.replace(':published', ':draft');\n    const draftRelatedProductId = relatedProductId.replace(':published', ':draft');\n    const response = await apos.http.get(`/api/v1/article/${draftRelatedArticleId}`, {\n      jar\n    });\n    assert(response);\n    assert(response._products);\n    assert(response._products.length === 1);\n    assert(response._products[0]._id === draftRelatedProductId);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET results plus filter choices","suites":["Pieces"],"updatePoint":{"line":939,"column":41,"index":29364},"line":939,"code":"  it('can GET results plus filter choices', async function () {\n    const response = await apos.http.get('/api/v1/product?choices=title,visibility,_articles,articles', {\n      jar\n    });\n    assert(response);\n    assert(response.results);\n    assert(response.choices.title);\n    assert(response.choices.title[0].label.match(/Cool Product/));\n    assert(response.choices.visibility);\n    assert(response.choices.visibility.length === 2);\n    assert(response.choices.visibility.find(item => item.value === 'loginRequired'));\n    assert(response.choices.visibility.find(item => item.value === 'public'));\n    assert(response.choices._articles);\n    assert(response.choices._articles[0].label === 'First Article');\n    // an _id\n    assert(response.choices._articles[0].value.match(/^c/));\n    assert(response.choices.articles[0].label === 'First Article');\n    // a slug\n    assert(response.choices.articles[0].value === 'first-article');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET results plus filter counts","suites":["Pieces"],"updatePoint":{"line":959,"column":40,"index":30306},"line":959,"code":"  it('can GET results plus filter counts', async function () {\n    const response = await apos.http.get('/api/v1/product?_edit=1&counts=title,visibility,_articles,articles', {\n      jar\n    });\n    assert(response);\n    assert(response.results);\n    assert(response.counts);\n    assert(response.counts.title);\n    assert(response.counts.title[0].label.match(/Cool Product/));\n    // Doesn't work for every field type, but does for this\n    assert(response.counts.title[0].count === 1);\n    assert(response.counts.visibility);\n    assert(response.counts.visibility.length === 2);\n    assert(response.counts.visibility.find(item => item.value === 'loginRequired'));\n    assert(response.counts.visibility.find(item => item.value === 'public'));\n    assert(response.counts._articles);\n    assert(response.counts._articles[0].label === 'First Article');\n    // an _id\n    assert(response.counts._articles[0].value.match(/^c/));\n    assert(response.counts.articles[0].label === 'First Article');\n    // a slug\n    assert(response.counts.articles[0].value === 'first-article');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can patch a relationship","suites":["Pieces"],"updatePoint":{"line":982,"column":30,"index":31373},"line":982,"code":"  it('can patch a relationship', async function () {\n    let response = await apos.http.post('/api/v1/article', {\n      jar,\n      body: {\n        title: 'Relationship Article',\n        name: 'relationship-article'\n      }\n    });\n    const article = response;\n    assert(article);\n    assert(article.title === 'Relationship Article');\n    response = await apos.http.post('/api/v1/product', {\n      jar,\n      body: {\n        title: 'Initially No Relationship Value',\n        body: {\n          metaType: 'area',\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            id: cuid(),\n            content: '<p>This is the product key product without initial relationship</p>'\n          }]\n        }\n      }\n    });\n    const product = response;\n    assert(product._id);\n    response = await apos.http.patch(`/api/v1/product/${product._id}`, {\n      body: {\n        _articles: [article]\n      },\n      jar\n    });\n    assert(response.title === 'Initially No Relationship Value');\n    assert(response.articlesIds);\n    assert(response.articlesIds[0] === article.aposDocId);\n    assert(response._articles);\n    assert(response._articles[0]._id === article._id);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can insert a constrained piece that validates","suites":["Pieces"],"updatePoint":{"line":1022,"column":51,"index":32608},"line":1022,"code":"  it('can insert a constrained piece that validates', async function () {\n    const constrained = await apos.http.post('/api/v1/constrained', {\n      body: {\n        title: 'First Constrained',\n        description: 'longenough'\n      },\n      jar\n    });\n    assert(constrained);\n    assert(constrained.title === 'First Constrained');\n    assert(constrained.description === 'longenough');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot insert a constrained piece that does not validate","suites":["Pieces"],"updatePoint":{"line":1034,"column":62,"index":33014},"line":1034,"code":"  it('cannot insert a constrained piece that does not validate', async function () {\n    try {\n      await apos.http.post('/api/v1/constrained', {\n        body: {\n          title: 'Second Constrained',\n          description: 'shrt'\n        },\n        jar\n      });\n      // Getting here is bad\n      assert(false);\n    } catch (e) {\n      assert(e);\n      assert(e.status === 400);\n      assert(e.body.data.errors);\n      assert(e.body.data.errors.length === 1);\n      assert(e.body.data.errors[0].path === 'description');\n      assert(e.body.data.errors[0].name === 'min');\n      assert(e.body.data.errors[0].code === 400);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can insert a product for advisory lock testing","suites":["Pieces"],"updatePoint":{"line":1056,"column":52,"index":33667},"line":1056,"code":"  it('can insert a product for advisory lock testing', async function () {\n    const response = await apos.http.post('/api/v1/product', {\n      body: {\n        title: 'Advisory Test',\n        name: 'advisory-test'\n      },\n      jar\n    });\n    const article = response;\n    assert(article);\n    assert(article.title === 'Advisory Test');\n    advisoryLockTestId = article._id;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can get an advisory lock on a product while patching a property","suites":["Pieces"],"updatePoint":{"line":1069,"column":69,"index":34067},"line":1069,"code":"  it('can get an advisory lock on a product while patching a property', async function () {\n    const product = await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'xyz',\n          lock: true\n        },\n        title: 'Advisory Test Patched'\n      }\n    });\n    assert(product.title === 'Advisory Test Patched');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot get an advisory lock with a different context id","suites":["Pieces"],"updatePoint":{"line":1082,"column":61,"index":34458},"line":1082,"code":"  it('cannot get an advisory lock with a different context id', async function () {\n    try {\n      await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n        jar,\n        body: {\n          _advisoryLock: {\n            tabId: 'pdq',\n            lock: true\n          }\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 409);\n      assert(e.body.name === 'locked');\n      assert(e.body.data.me);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can get an advisory lock with a different context id if forcing","suites":["Pieces"],"updatePoint":{"line":1100,"column":69,"index":34921},"line":1100,"code":"  it('can get an advisory lock with a different context id if forcing', async function () {\n    await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: true,\n          force: true\n        }\n      }\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can renew the advisory lock with the second context id after forcing","suites":["Pieces"],"updatePoint":{"line":1112,"column":74,"index":35237},"line":1112,"code":"  it('can renew the advisory lock with the second context id after forcing', async function () {\n    await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: true\n        }\n      }\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can unlock the advisory lock while patching a property","suites":["Pieces"],"updatePoint":{"line":1123,"column":60,"index":35516},"line":1123,"code":"  it('can unlock the advisory lock while patching a property', async function () {\n    const product = await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'pdq',\n          lock: false\n        },\n        title: 'Advisory Test Patched Again'\n      }\n    });\n    assert(product.title === 'Advisory Test Patched Again');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can relock with the first context id after unlocking","suites":["Pieces"],"updatePoint":{"line":1136,"column":58,"index":35917},"line":1136,"code":"  it('can relock with the first context id after unlocking', async function () {\n    const doc = await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n      jar,\n      body: {\n        _advisoryLock: {\n          tabId: 'xyz',\n          lock: true\n        }\n      }\n    });\n    assert(doc.title === 'Advisory Test Patched Again');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to log in as second user","suites":["Pieces"],"updatePoint":{"line":1149,"column":45,"index":36262},"line":1149,"code":"  it('should be able to log in as second user', async function () {\n    jar2 = apos.http.jar();\n\n    // establish session\n    let page = await apos.http.get('/', {\n      jar: jar2\n    });\n    assert(page.match(/logged out/));\n\n    // Log in\n\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin2',\n        password: 'admin2',\n        session: true\n      },\n      jar: jar2\n    });\n\n    // Confirm login\n    page = await apos.http.get('/', {\n      jar: jar2\n    });\n    assert(page.match(/logged in/));\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"second user with a distinct tabId gets an appropriate error specifying who has the lock","suites":["Pieces"],"updatePoint":{"line":1175,"column":93,"index":36869},"line":1175,"code":"  it('second user with a distinct tabId gets an appropriate error specifying who has the lock', async function () {\n    try {\n      await apos.http.patch(`/api/v1/product/${advisoryLockTestId}`, {\n        jar: jar2,\n        body: {\n          _advisoryLock: {\n            tabId: 'nbc',\n            lock: true\n          }\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 409);\n      assert(e.body.name === 'locked');\n      assert(!e.body.data.me);\n      assert(e.body.data.username === 'admin');\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can log out to destroy a session","suites":["Pieces"],"updatePoint":{"line":1194,"column":38,"index":37356},"line":1194,"code":"  it('can log out to destroy a session', async function () {\n    await apos.http.post('/api/v1/@apostrophecms/login/logout', {\n      followAllRedirects: true,\n      jar\n    });\n    await apos.http.post('/api/v1/@apostrophecms/login/logout', {\n      followAllRedirects: true,\n      jar: jar2\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot POST a product with a logged-out cookie jar","suites":["Pieces"],"updatePoint":{"line":1204,"column":56,"index":37679},"line":1204,"code":"  it('cannot POST a product with a logged-out cookie jar', async function () {\n    try {\n      await apos.http.post('/api/v1/product', {\n        body: {\n          title: 'Fake Product After Logout',\n          body: {\n            metaType: 'area',\n            items: [{\n              metaType: 'widget',\n              type: '@apostrophecms/rich-text',\n              id: cuid(),\n              content: '<p>This is fake</p>'\n            }]\n          }\n        },\n        jar\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 403);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to log in as admin and get a bearer token","suites":["Pieces"],"updatePoint":{"line":1228,"column":62,"index":38286},"line":1228,"code":"  it('should be able to log in as admin and get a bearer token', async function () {\n    // Log in\n    const response = await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin'\n      }\n    });\n    assert(response.token);\n    token = response.token;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can POST a product with the bearer token","suites":["Pieces"],"updatePoint":{"line":1239,"column":46,"index":38596},"line":1239,"code":"  it('can POST a product with the bearer token', async function () {\n    const response = await apos.http.post('/api/v1/product', {\n      body: {\n        title: 'Bearer Token Product',\n        visibility: 'loginRequired',\n        slug: 'bearer-token-product',\n        body: {\n          metaType: 'area',\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            id: cuid(),\n            content: '<p>This is a bearer token thing</p>'\n          }]\n        }\n      },\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    assert(response);\n    assert(response._id);\n    assert(response.body);\n    assert(response.title === 'Bearer Token Product');\n    assert(response.slug === 'bearer-token-product');\n    assert(response.type === 'product');\n    bearerProductId = response._id;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a loginRequired product with the bearer token","suites":["Pieces"],"updatePoint":{"line":1267,"column":59,"index":39467},"line":1267,"code":"  it('can GET a loginRequired product with the bearer token', async function () {\n    const response = await apos.http.get(`/api/v1/product/${bearerProductId}`, {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n    assert(response);\n    assert(response.title === 'Bearer Token Product');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can log out to destroy a bearer token","suites":["Pieces"],"updatePoint":{"line":1276,"column":43,"index":39771},"line":1276,"code":"  it('can log out to destroy a bearer token', async function () {\n    return apos.http.post('/api/v1/@apostrophecms/login/logout', {\n      headers: {\n        Authorization: `Bearer ${token}`\n      }\n    });\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"cannot GET a loginRequired product with a destroyed bearer token","suites":["Pieces"],"updatePoint":{"line":1283,"column":70,"index":40011},"line":1283,"code":"  it('cannot GET a loginRequired product with a destroyed bearer token', async function () {\n    try {\n      await apos.http.get(`/api/v1/product/${bearerProductId}`, {\n        headers: {\n          Authorization: `Bearer ${token}`\n        }\n      });\n      assert(false);\n    } catch (e) {\n      assert(e.status === 401);\n    }\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can POST a product with the api key","suites":["Pieces"],"updatePoint":{"line":1296,"column":41,"index":40339},"line":1296,"code":"  it('can POST a product with the api key', async function () {\n    const response = await apos.http.post('/api/v1/product', {\n      body: {\n        title: 'API Key Product',\n        visibility: 'loginRequired',\n        slug: 'api-key-product',\n        body: {\n          metaType: 'area',\n          items: [{\n            metaType: 'widget',\n            type: '@apostrophecms/rich-text',\n            id: cuid(),\n            content: '<p>This is an api key thing</p>'\n          }]\n        }\n      },\n      headers: {\n        Authorization: `ApiKey ${apiKey}`\n      }\n    });\n    assert(response);\n    assert(response._id);\n    assert(response.body);\n    assert(response.title === 'API Key Product');\n    assert(response.slug === 'api-key-product');\n    assert(response.type === 'product');\n    apiKeyProductId = response._id;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can GET a loginRequired product with the api key","suites":["Pieces"],"updatePoint":{"line":1324,"column":54,"index":41182},"line":1324,"code":"  it('can GET a loginRequired product with the api key', async function () {\n    const response = await apos.http.get(`/api/v1/product/${apiKeyProductId}`, {\n      headers: {\n        Authorization: `ApiKey ${apiKey}`\n      }\n    });\n    assert(response);\n    assert(response.title === 'API Key Product');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"can insert a resume with an attachment","suites":["Pieces"],"updatePoint":{"line":1333,"column":44,"index":41483},"line":1333,"code":"  it('can insert a resume with an attachment', async function () {\n    const formData = new FormData();\n    formData.append('file', fs.createReadStream(path.join(__dirname, '/public/static-test.txt')));\n\n    // Make an async request to upload the image.\n    const attachment = await apos.http.post('/api/v1/@apostrophecms/attachment/upload', {\n      headers: {\n        Authorization: `ApiKey ${apiKey}`\n      },\n      body: formData\n    });\n    const resume = await apos.http.post('/api/v1/resume', {\n      headers: {\n        Authorization: `ApiKey ${apiKey}`\n      },\n      body: {\n        title: 'Jane Doe',\n        attachment\n      }\n    });\n    assert(resume);\n    assert(resume.title === 'Jane Doe');\n    assert(resume.attachment._url);\n    assert(fs.readFileSync(path.join(__dirname, 'public', resume.attachment._url), 'utf8') === fs.readFileSync(path.join(__dirname, '/public/static-test.txt'), 'utf8'));\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should convert a piece keeping only the present fields","suites":["Pieces"],"updatePoint":{"line":1358,"column":60,"index":42417},"line":1358,"code":"  it('should convert a piece keeping only the present fields', async function () {\n    const req = apos.task.getReq();\n    const inputPiece = {\n      title: 'new product name'\n    };\n    const existingPiece = {\n      color: 'red'\n    };\n    await apos.modules.product.convert(req, inputPiece, existingPiece, {\n      presentFieldsOnly: true\n    });\n    assert(Object.keys(existingPiece).length === 2);\n    assert(existingPiece.title === 'new product name');\n    assert(existingPiece.color === 'red');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving pieces, when cache option is not set","suites":["Pieces"],"updatePoint":{"line":1373,"column":95,"index":42958},"line":1373,"code":"  it('should not set a cache-control value when retrieving pieces, when cache option is not set', async function () {\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving a single piece, when \"etags\" cache option is set","suites":["Pieces"],"updatePoint":{"line":1383,"column":107,"index":43429},"line":1383,"code":"  it('should not set a cache-control value when retrieving a single piece, when \"etags\" cache option is set', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 5555,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response.headers['cache-control'] === undefined);\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not set a cache-control value when retrieving pieces, when \"api\" cache option is not set","suites":["Pieces"],"updatePoint":{"line":1395,"column":101,"index":43839},"line":1395,"code":"  it('should not set a cache-control value when retrieving pieces, when \"api\" cache option is not set', async function () {\n    apos.thing.options.cache = {\n      page: {\n        maxAge: 5555\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === undefined);\n    assert(response2.headers['cache-control'] === undefined);\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a \"max-age\" cache-control value when retrieving pieces, when \"api\" cache option is set","suites":["Pieces"],"updatePoint":{"line":1411,"column":103,"index":44426},"line":1411,"code":"  it('should set a \"max-age\" cache-control value when retrieving pieces, when \"api\" cache option is set', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 3333\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'max-age=3333');\n    assert(response2.headers['cache-control'] === 'max-age=3333');\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pieces, when user is connected","suites":["Pieces"],"updatePoint":{"line":1427,"column":96,"index":45015},"line":1427,"code":"  it('should set a \"no-store\" cache-control value when retrieving pieces, when user is connected', async function () {\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true,\n      jar\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      jar\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pieces, when \"api\" cache option is set, when user is connected","suites":["Pieces"],"updatePoint":{"line":1447,"column":128,"index":45713},"line":1447,"code":"  it('should set a \"no-store\" cache-control value when retrieving pieces, when \"api\" cache option is set, when user is connected', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 3333\n      }\n    };\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response1 = await apos.http.get('/api/v1/thing', {\n      fullResponse: true,\n      jar\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      jar\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pieces, when user is connected using an api key","suites":["Pieces"],"updatePoint":{"line":1473,"column":113,"index":46515},"line":1473,"code":"  it('should set a \"no-store\" cache-control value when retrieving pieces, when user is connected using an api key', async function () {\n    const response1 = await apos.http.get(`/api/v1/thing?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/thing/testThing:en:published?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a \"no-store\" cache-control value when retrieving pieces, when \"api\" cache option is set, when user is connected using an api key","suites":["Pieces"],"updatePoint":{"line":1483,"column":145,"index":47060},"line":1483,"code":"  it('should set a \"no-store\" cache-control value when retrieving pieces, when \"api\" cache option is set, when user is connected using an api key', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 3333\n      }\n    };\n    const response1 = await apos.http.get(`/api/v1/thing?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get(`/api/v1/thing/testThing:en:published?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    assert(response1.headers['cache-control'] === 'no-store');\n    assert(response2.headers['cache-control'] === 'no-store');\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should set a custom etag when retrieving a single piece","suites":["Pieces"],"updatePoint":{"line":1499,"column":61,"index":47640},"line":1499,"code":"  it('should set a custom etag when retrieving a single piece', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] === apos.asset.getReleaseId());\n    assert(eTagParts[1] === new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    assert(eTagParts[2]);\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should return a 304 status code when retrieving a piece with a matching etag","suites":["Pieces"],"updatePoint":{"line":1515,"column":82,"index":48239},"line":1515,"code":"  it('should return a 304 status code when retrieving a piece with a matching etag', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 304);\n    assert(response2.body === '');\n\n    // Same ETag should be sent again to the client\n    assert(response1.headers.etag === response2.headers.etag);\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when retrieving a piece that has been edited","suites":["Pieces"],"updatePoint":{"line":1540,"column":86,"index":49057},"line":1540,"code":"  it('should not return a 304 status code when retrieving a piece that has been edited', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 1111,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    const pieceDoc = await apos.doc.db.findOne({\n      aposDocId: 'testThing',\n      aposLocale: 'en:published'\n    });\n\n    // Edit piece, this should invalidate its cache,\n    // so requesting it again should not return a 304 status code\n    const pieceUpdateResponse = await apos.doc.update(apos.task.getReq(), pieceDoc);\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': response1.headers.etag\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New ETag has been generated, with the new value of the edited piece's `cacheInvalidatedAt` field...\n    assert(eTag2Parts[1] === pieceUpdateResponse.cacheInvalidatedAt.getTime().toString());\n    // ...and a new timestamp\n    assert(eTag2Parts[2] !== eTag1Parts[2]);\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not return a 304 status code when retrieving a piece after the max-age period","suites":["Pieces"],"updatePoint":{"line":1577,"column":90,"index":50471},"line":1577,"code":"  it('should not return a 304 status code when retrieving a piece after the max-age period', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 4444,\n        etags: true\n      }\n    };\n    const response1 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true\n    });\n    const eTagParts = response1.headers.etag.split(':');\n    const outOfDateETagParts = [...eTagParts];\n    outOfDateETagParts[2] = Number(outOfDateETagParts[2]) - (4444 + 1) * 1000; // 1s outdated\n\n    const response2 = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      headers: {\n        'if-none-match': outOfDateETagParts.join(':')\n      }\n    });\n    const eTag1Parts = response1.headers.etag.split(':');\n    const eTag2Parts = response2.headers.etag.split(':');\n    assert(response1.status === 200);\n    assert(response1.body);\n    assert(response2.status === 200);\n    assert(response2.body);\n\n    // New timestamp\n    assert(eTag1Parts[2] !== eTag2Parts[2]);\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not set a custom etag when retrieving a single piece, when user is connected","suites":["Pieces"],"updatePoint":{"line":1608,"column":89,"index":51557},"line":1608,"code":"  it('should not set a custom etag when retrieving a single piece, when user is connected', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 3333,\n        etags: true\n      }\n    };\n    await apos.http.post('/api/v1/@apostrophecms/login/login', {\n      body: {\n        username: 'admin',\n        password: 'admin',\n        session: true\n      },\n      jar\n    });\n    const response = await apos.http.get('/api/v1/thing/testThing:en:published', {\n      fullResponse: true,\n      jar\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] !== apos.asset.getReleaseId());\n    assert(eTagParts[1] !== new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should not set a custom etag when retrieving a single piece, when user is connected using an api key","suites":["Pieces"],"updatePoint":{"line":1632,"column":106,"index":52347},"line":1632,"code":"  it('should not set a custom etag when retrieving a single piece, when user is connected using an api key', async function () {\n    apos.thing.options.cache = {\n      api: {\n        maxAge: 3333,\n        etags: true\n      }\n    };\n    const response = await apos.http.get(`/api/v1/thing/testThing:en:published?apiKey=${apiKey}`, {\n      fullResponse: true\n    });\n    const eTagParts = response.headers.etag.split(':');\n    assert(eTagParts[0] !== apos.asset.getReleaseId());\n    assert(eTagParts[1] !== new Date(response.body.cacheInvalidatedAt).getTime().toString());\n    delete apos.thing.options.cache;\n  });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should remove the published and previous versions of a piece","suites":["Pieces","unpublish"],"updatePoint":{"line":1690,"column":68,"index":54118},"line":1690,"code":"    it('should remove the published and previous versions of a piece', function () {\n      assert(published === null);\n      assert(previous === null);\n    });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should update the draft version of a piece","suites":["Pieces","unpublish"],"updatePoint":{"line":1694,"column":50,"index":54260},"line":1694,"code":"    it('should update the draft version of a piece', function () {\n      assert(draft._id === draftItem._id);\n      assert(draft.modified === true);\n      assert(draft.lastPublishedAt === null);\n    });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should have a \"share\" method that returns a draft with aposShareKey","suites":["Pieces","draft sharing","share"],"updatePoint":{"line":1733,"column":77,"index":55681},"line":1733,"code":"      it('should have a \"share\" method that returns a draft with aposShareKey', async function () {\n        const draft = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:draft`\n        });\n        const published = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:published`\n        });\n        assert(apos.modules.product.share);\n        assert(!Object.prototype.hasOwnProperty.call(published, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(previousDraft, 'aposShareKey'));\n        assert(shareResponse.aposShareKey);\n        assert(draft.aposShareKey);\n        assert(shareResponse.aposShareKey === draft.aposShareKey);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft after having enabled draft sharing","suites":["Pieces","draft sharing","share"],"updatePoint":{"line":1747,"column":82,"index":56393},"line":1747,"code":"      it('should grant public access to a draft after having enabled draft sharing', async function () {\n        const publicUrl = generatePublicUrl(shareResponse);\n        const response = await apos.http.get(shareResponse._url, {\n          fullResponse: true\n        });\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true\n        });\n        assert(response.status === 200);\n        assert(response.body.includes('Some Product'));\n        assert(!response.body.includes('Some Product EDITED'));\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Product EDITED'));\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft without admin UI, even when logged-in","suites":["Pieces","draft sharing","share"],"updatePoint":{"line":1761,"column":85,"index":57061},"line":1761,"code":"      it('should grant public access to a draft without admin UI, even when logged-in', async function () {\n        const publicUrl = generatePublicUrl(shareResponse);\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true,\n          jar\n        });\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Product EDITED'));\n        assert(!publicResponse.body.includes('apos-admin-bar'));\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should grant public access to a draft after having re-enabled draft sharing","suites":["Pieces","draft sharing","share"],"updatePoint":{"line":1771,"column":85,"index":57540},"line":1771,"code":"      it('should grant public access to a draft after having re-enabled draft sharing', async function () {\n        await apos.modules.product.unshare(req, previousDraft);\n        const shareResponse = await apos.modules.product.share(req, previousDraft);\n        const publicUrl = generatePublicUrl(shareResponse);\n        const publicResponse = await apos.http.get(publicUrl, {\n          fullResponse: true\n        });\n        assert(publicResponse.status === 200);\n        assert(publicResponse.body.includes('Some Product EDITED'));\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should have a \"unshare\" method that returns a draft without aposShareKey","suites":["Pieces","draft sharing","unshare"],"updatePoint":{"line":1786,"column":82,"index":58260},"line":1786,"code":"      it('should have a \"unshare\" method that returns a draft without aposShareKey', async function () {\n        const unshareResponse = await apos.modules.product.unshare(req, previousDraft);\n        const draft = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:draft`\n        });\n        const published = await apos.doc.db.findOne({\n          _id: `${previousDraft.aposDocId}:en:published`\n        });\n        assert(apos.modules.product.unshare);\n        assert(!Object.prototype.hasOwnProperty.call(previousPublished, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(previousDraft, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(published, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(draft, 'aposShareKey'));\n        assert(!Object.prototype.hasOwnProperty.call(unshareResponse, 'aposShareKey'));\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should remove public access to a draft after having disabled draft sharing","suites":["Pieces","draft sharing","unshare"],"updatePoint":{"line":1801,"column":84,"index":59173},"line":1801,"code":"      it('should remove public access to a draft after having disabled draft sharing', async function () {\n        await apos.modules.product.unshare(req, previousDraft);\n        try {\n          const publicUrl = generatePublicUrl(shareResponse);\n          await apos.http.get(publicUrl, {\n            fullResponse: true\n          });\n        } catch (error) {\n          assert(error.status === 404);\n          return;\n        }\n        throw new Error('should have thrown 404 error');\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"getBrowserData","suites":["Pieces","field viewPermission|editPermission","admin"],"updatePoint":{"line":1829,"column":24,"index":60012},"line":1829,"code":"      it('getBrowserData', async function () {\n        const req = apos.task.getReq();\n        const {\n          schema\n        } = await apos.modules.board.getBrowserData(req);\n        const actual = schema.map(field => field.name);\n        const expected = ['title', 'slug', 'visibility', 'archived', 'stock', 'discontinued', 'nickname', 'sku', 'hidden', '_users', 'array', 'object'];\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve fields with viewPermission when having appropriate credentials on rest API","suites":["Pieces","field viewPermission|editPermission","admin"],"updatePoint":{"line":1838,"column":111,"index":60540},"line":1838,"code":"      it('should be able to retrieve fields with viewPermission when having appropriate credentials on rest API', async function () {\n        // admin user was inserted earlier\n        const jar = await t.loginAs(apos, 'admin');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.http.get(`/api/v1/board/${inserted._id}`, {\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to edit fields with editPermission when having appropriate credentials on rest API","suites":["Pieces","field viewPermission|editPermission","admin"],"updatePoint":{"line":1867,"column":107,"index":61549},"line":1867,"code":"      it('should be able to edit fields with editPermission when having appropriate credentials on rest API', async function () {\n        const jar = await t.loginAs(apos, 'admin');\n        editor = await t.createUser(apos, 'editor');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077',\n          nickname: 'flex',\n          sku: 'LI',\n          hidden: false,\n          _users: [editor],\n          array: [{\n            title: '01',\n            description: 'one',\n            _users: [editor]\n          }],\n          object: {\n            title: '01',\n            description: 'one',\n            _users: [editor]\n          }\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        await apos.http.get(`/api/v1/board/${inserted._id}`, {\n          jar\n        });\n        const board = await apos.http.put(`/api/v1/board/${inserted._id}`, {\n          body: {\n            ...inserted,\n            slug: 'board-icarus',\n            stock: 77,\n            discontinued: 'May 2049',\n            nickname: 'f1',\n            sku: 'LO-IC',\n            hidden: true\n          },\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued,\n          nickname: board.nickname,\n          sku: board.sku,\n          hidden: board.hidden\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'board-icarus',\n          stock: 77,\n          discontinued: 'May 2049',\n          nickname: 'f1',\n          sku: 'LO-IC',\n          hidden: true\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve all fields when using find","suites":["Pieces","field viewPermission|editPermission","admin"],"updatePoint":{"line":1928,"column":63,"index":63356},"line":1928,"code":"      it('should be able to retrieve all fields when using find', async function () {\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.modules.board.find(apos.task.getAdminReq(), {\n          _id: inserted._id\n        }).toObject();\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"getBrowserData","suites":["Pieces","field viewPermission|editPermission","editor"],"updatePoint":{"line":1957,"column":24,"index":64258},"line":1957,"code":"      it('getBrowserData', async function () {\n        const req = apos.task.getEditorReq();\n        const {\n          schema\n        } = await apos.modules.board.getBrowserData(req);\n        const actual = schema.map(field => field.name);\n        const expected = ['title', 'slug', 'visibility', 'archived', 'stock', 'nickname', '_users'];\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve fields with viewPermission when having appropriate credentials","suites":["Pieces","field viewPermission|editPermission","editor"],"updatePoint":{"line":1966,"column":99,"index":64728},"line":1966,"code":"      it('should be able to retrieve fields with viewPermission when having appropriate credentials', async function () {\n        const jar = await t.loginAs(apos, 'editor');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.http.get(`/api/v1/board/${inserted._id}`, {\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: undefined\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to edit fields with editPermission when having appropriate credentials on rest API","suites":["Pieces","field viewPermission|editPermission","editor"],"updatePoint":{"line":1994,"column":107,"index":65692},"line":1994,"code":"      it('should be able to edit fields with editPermission when having appropriate credentials on rest API', async function () {\n        const jar = await t.loginAs(apos, 'editor');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077',\n          nickname: 'flex',\n          sku: 'LI',\n          hidden: false\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        await apos.http.get(`/api/v1/board/${inserted._id}`, {\n          jar\n        });\n        const board = await apos.http.put(`/api/v1/board/${inserted._id}`, {\n          body: {\n            ...inserted,\n            slug: 'board-icarus',\n            stock: 77,\n            discontinued: 'May 2049',\n            nickname: 'f1',\n            sku: 'LO-IC',\n            hidden: true\n          },\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued,\n          nickname: board.nickname,\n          sku: board.sku,\n          hidden: board.hidden\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'board-icarus',\n          stock: 77,\n          discontinued: 'April 2077',\n          nickname: 'f1',\n          sku: 'LI',\n          hidden: false\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve all fields when using find","suites":["Pieces","field viewPermission|editPermission","editor"],"updatePoint":{"line":2043,"column":63,"index":67180},"line":2043,"code":"      it('should be able to retrieve all fields when using find', async function () {\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.modules.board.find(apos.task.getEditorReq(), {\n          _id: inserted._id\n        }).toObject();\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"getBrowserData","suites":["Pieces","field viewPermission|editPermission","contributor"],"updatePoint":{"line":2072,"column":24,"index":68088},"line":2072,"code":"      it('getBrowserData', async function () {\n        const req = apos.task.getContributorReq();\n        const {\n          schema\n        } = await apos.modules.board.getBrowserData(req);\n        const actual = schema.map(field => field.name);\n        const expected = ['title', 'slug', 'visibility', 'archived', '_users'];\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve fields with viewPermission when having appropriate credentials","suites":["Pieces","field viewPermission|editPermission","contributor"],"updatePoint":{"line":2081,"column":99,"index":68542},"line":2081,"code":"      it('should be able to retrieve fields with viewPermission when having appropriate credentials', async function () {\n        contributor = await t.createUser(apos, 'contributor');\n        const jar = await t.loginAs(apos, 'contributor');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.http.get(`/api/v1/board/${inserted._id}`, {\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: undefined\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to edit fields with editPermission when having appropriate credentials on rest API","suites":["Pieces","field viewPermission|editPermission","contributor"],"updatePoint":{"line":2110,"column":107,"index":69574},"line":2110,"code":"      it('should be able to edit fields with editPermission when having appropriate credentials on rest API', async function () {\n        const jar = await t.loginAs(apos, 'contributor');\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077',\n          nickname: 'flex',\n          sku: 'LI',\n          hidden: false\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const found = await apos.http.get(`/api/v1/board/${inserted._id.replace('published', 'draft')}`, {\n          jar\n        });\n        const board = await apos.http.put(`/api/v1/board/${found._id}`, {\n          body: {\n            ...found,\n            slug: 'board-icarus',\n            stock: 77,\n            discontinued: 'May 2049',\n            nickname: 'f1',\n            sku: 'LO-IC',\n            hidden: true\n          },\n          jar\n        });\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued,\n          nickname: board.nickname,\n          sku: board.sku,\n          hidden: board.hidden\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'board-icarus',\n          stock: 77,\n          discontinued: 'April 2077',\n          nickname: 'f1',\n          sku: 'LI',\n          hidden: false\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve all fields when using find","suites":["Pieces","field viewPermission|editPermission","contributor"],"updatePoint":{"line":2159,"column":63,"index":71105},"line":2159,"code":"      it('should be able to retrieve all fields when using find', async function () {\n        const req = apos.task.getReq();\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const board = await apos.modules.board.find(apos.task.getContributorReq(), {\n          _id: inserted._id\n        }).toObject();\n        const actual = {\n          title: board.title,\n          slug: board.slug,\n          stock: board.stock,\n          discontinued: board.discontinued\n        };\n        const expected = {\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077'\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should be able to edit with permission checks during prepareForStorage & updateCacheField handlers","suites":["Pieces","field viewPermission|editPermission","contributor"],"updatePoint":{"line":2186,"column":108,"index":72053},"line":2186,"code":"      it('should be able to edit with permission checks during prepareForStorage & updateCacheField handlers', async function () {\n        const jar = await t.loginAs(apos, 'contributor');\n        guest = await t.createUser(apos, 'guest');\n        const req = apos.task.getReq({\n          mode: 'draft'\n        });\n        const candidate = {\n          ...apos.modules.board.newInstance(),\n          title: 'Icarus',\n          slug: 'icarus',\n          stock: 99,\n          discontinued: 'April 2077',\n          nickname: 'flex',\n          sku: 'LI',\n          hidden: false,\n          _users: [editor],\n          array: [{\n            title: '01',\n            description: 'one',\n            _users: [editor]\n          }],\n          object: {\n            title: '01',\n            description: 'one',\n            _users: [editor]\n          }\n        };\n        const inserted = await apos.modules.board.insert(req, candidate);\n        const insertedDraft = await apos.modules.board.find(apos.task.getReq({\n          mode: 'draft'\n        }), {\n          _id: inserted._id.replace('published', 'draft')\n        }).toObject();\n        const found = await apos.http.get(`/api/v1/board/${insertedDraft._id}`, {\n          jar\n        });\n        const updated = await apos.http.put(`/api/v1/board/${found._id}`, {\n          body: {\n            ...found,\n            stock: 77,\n            _users: [guest],\n            array: [{\n              title: '02',\n              _users: [guest]\n            }],\n            object: {\n              title: '02',\n              _users: [guest]\n            }\n          },\n          jar\n        });\n        const expectedUsers = insertedDraft.object._users.map(user => ({\n          ...user,\n          cacheInvalidatedAt: new Date(updated.cacheInvalidatedAt)\n        }));\n        const actual = await apos.modules.board.find(apos.task.getReq({\n          mode: 'draft'\n        }), {\n          _id: updated._id\n        }).toObject();\n        const expected = {\n          ...insertedDraft,\n          _users: expectedUsers,\n          stock: 77,\n          cacheInvalidatedAt: new Date(updated.cacheInvalidatedAt),\n          updatedAt: new Date(updated.updatedAt),\n          updatedBy: {\n            _id: contributor._id,\n            title: contributor.title,\n            username: contributor.username\n          },\n          array: insertedDraft.array.map(item => ({\n            ...item,\n            _users: expectedUsers\n          })),\n          object: {\n            ...insertedDraft.object,\n            _users: expectedUsers\n          }\n        };\n        assert.deepEqual(actual, expected);\n      });","file":"pieces.js","skipped":false,"dir":"test"},{"name":"should insert person pieces and verify age query builder is working","suites":["Query Builders"],"updatePoint":{"line":117,"column":73,"index":3472},"line":117,"code":"  it('should insert person pieces and verify age query builder is working', async function () {\n    const req = apos.task.getReq();\n    const persons = getPersons(apos.young);\n    const {\n      insertedCount\n    } = await apos.doc.db.insertMany(persons);\n    assert(insertedCount === 6);\n    const children = await apos.young.find(req).age('children').toArray();\n    const adults = await apos.young.find(req).age('adults').toArray();\n    assert(children.length === 2);\n    children.forEach(child => {\n      assert(child.age <= 18);\n    });\n    assert(adults.length === 4);\n    adults.forEach(adult => {\n      assert(adult.age > 18);\n    });\n  });","file":"queryBuilders.js","skipped":false,"dir":"test"},{"name":"should insert seniors and verify the query builders have been properly extended","suites":["Query Builders"],"updatePoint":{"line":135,"column":85,"index":4131},"line":135,"code":"  it('should insert seniors and verify the query builders have been properly extended', async function () {\n    const req = apos.task.getReq();\n    const persons = getPersons(apos.person, true);\n    const {\n      insertedCount\n    } = await apos.doc.db.insertMany(persons);\n    assert(insertedCount === 8);\n    const children = await apos.person.find(req).age('children').toArray();\n    const adults = await apos.person.find(req).age('adults').toArray();\n    const seniors = await apos.person.find(req).age('seniors').toArray();\n    assert(children.length === 2);\n    children.forEach(child => {\n      assert(child.age <= 18);\n    });\n    assert(adults.length === 6);\n    adults.forEach(adult => {\n      assert(adult.age > 18);\n    });\n    assert(seniors.length === 2);\n    seniors.forEach(senior => {\n      assert(senior.age > 60);\n    });\n  });","file":"queryBuilders.js","skipped":false,"dir":"test"},{"name":"should verify that query methods work and can be extende","suites":["Query Builders"],"updatePoint":{"line":158,"column":62,"index":4955},"line":158,"code":"  it('should verify that query methods work and can be extende', async function () {\n    const req = apos.task.getReq();\n    const youngSorted = await apos.young.find(req).age('adults').sortByAge();\n    assert(youngSorted[0].age === 25);\n    assert(youngSorted[1].age === 32);\n    assert(youngSorted[2].age === 50);\n    assert(youngSorted[3].age === 58);\n    const personsSorted = await apos.person.find(req).age('adults').sortByAge();\n    assert(personsSorted[0].age === 80);\n    assert(personsSorted[1].age === 72);\n    assert(personsSorted[2].age === 58);\n    assert(personsSorted[3].age === 50);\n    assert(personsSorted[4].age === 32);\n  });","file":"queryBuilders.js","skipped":false,"dir":"test"},{"name":"should exist on the apos.util object","suites":["Recursion Guard"],"updatePoint":{"line":10,"column":42,"index":286},"line":10,"code":"  it('should exist on the apos.util object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        product: {\n          options: {\n            alias: 'product'\n          },\n          extend: '@apostrophecms/piece-type',\n          fields: {\n            add: {\n              _articles: {\n                type: 'relationshipReverse',\n                withType: 'article'\n              }\n            }\n          }\n        },\n        article: {\n          options: {\n            alias: 'article'\n          },\n          extend: '@apostrophecms/piece-type',\n          fields: {\n            add: {\n              _products: {\n                type: 'relationship',\n                withType: 'product'\n              },\n              main: {\n                type: 'area',\n                widgets: {\n                  article: {}\n                }\n              }\n            }\n          }\n        },\n        'article-widget': {\n          extend: '@apostrophecms/widget-type',\n          options: {\n            label: 'Article'\n          },\n          fields: {\n            add: {\n              _articles: {\n                type: 'relationship',\n                withType: 'article'\n              }\n            }\n          }\n        },\n        'scary-article-widget': {\n          extend: '@apostrophecms/widget-type',\n          options: {\n            label: 'Scary Article',\n            neverLoadSelf: false\n          },\n          fields: {\n            add: {\n              _articles: {\n                type: 'relationship',\n                withType: 'article'\n              }\n            }\n          }\n        },\n        'product-widget': {\n          extend: '@apostrophecms/widget-type',\n          options: {\n            label: 'Product'\n          },\n          fields: {\n            add: {\n              _products: {\n                type: 'relationship',\n                withType: 'product'\n              }\n            }\n          }\n        },\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              slug: '/recursion-test-page',\n              type: 'recursion-test-page',\n              title: 'Recursion Test Page',\n              parkedId: 'recursion-test-page'\n            }],\n            types: [{\n              name: '@apostrophecms/home-page',\n              label: 'Home'\n            }, {\n              name: 'recursion-test-page',\n              label: 'Recursion Test Page'\n            }]\n          }\n        },\n        'recursion-test-page': {\n          extend: '@apostrophecms/page-type'\n        }\n      }\n    });\n    assert(apos.util.recursionGuard);\n  });","file":"recursionGuard.js","skipped":false,"dir":"test"},{"name":"should create a stack as it goes and stop without executing depth 50","suites":["Recursion Guard"],"updatePoint":{"line":115,"column":74,"index":2940},"line":115,"code":"  it('should create a stack as it goes and stop without executing depth 50', async function () {\n    let depth = 0;\n    let depth49First = true;\n    const req = apos.task.getReq();\n    let warnings = '';\n    // Capture output of util.warn so we can verify there was a warning\n    apos.util.warn = function (...args) {\n      warnings += args.join('\\n');\n    };\n    const result = await load();\n    assert(warnings.match(/review the stack to find the problem/));\n    assert(warnings.match(/test/));\n    // Guarded functions not directly blocked by the depth rule should\n    // return their own result\n    assert(result === 'result');\n    assert(depth === 49);\n    assert(!req.aposStack.length);\n    async function load() {\n      return apos.util.recursionGuard(req, 'test', async () => {\n        depth++;\n        assert(req.aposStack);\n        assert(req.aposStack.length === depth);\n        const nestedResult = await load();\n        // Careful, \"depth\" stays at 49 as we return up the stack\n        if (depth === 49 && depth49First === true) {\n          // Guarded functions directly blocked by the depth rule\n          // should return undefined\n          assert(nestedResult === undefined);\n          depth49First = false;\n        } else {\n          // Other invocations should return the result of the inner function\n          assert(nestedResult === 'result');\n        }\n        return 'result';\n      });\n    }\n  });","file":"recursionGuard.js","skipped":false,"dir":"test"},{"name":"should immediately stop runaway self-references among widgets by default","suites":["Recursion Guard"],"updatePoint":{"line":152,"column":78,"index":4366},"line":152,"code":"  it('should immediately stop runaway self-references among widgets by default', async function () {\n    const req = apos.task.getReq();\n    const product = await apos.product.insert(req, {\n      title: 'Test Product'\n    });\n    const selfRefId = cuid();\n    await apos.article.insert(req, {\n      aposDocId: selfRefId,\n      title: 'Self Referential Article',\n      main: {\n        metaType: 'area',\n        _id: cuid(),\n        items: [{\n          metaType: 'widget',\n          type: 'article',\n          articlesIds: [selfRefId]\n        }, {\n          metaType: 'widget',\n          type: 'product',\n          productsIds: [product._id]\n        }]\n      }\n    });\n    const article = await apos.article.find(req, {\n      aposDocId: selfRefId\n    }).toObject();\n    assert(article);\n    // Sanity check that we didn't kill all widget loaders: check\n    // the product widget\n    assert(article.main.items[1]._products[0]);\n    // Now dig into the recursive article widget\n    assert(article.main.items[0]);\n    // We do go down one level, because it's not recursing within the\n    // widget loader yet on the first go\n    assert(article.main.items[0]._articles);\n    assert(article.main.items[0]._articles[0]);\n    // However there should be no second go!\n    assert(article.main.items[0]._articles[0].main);\n    assert(article.main.items[0]._articles[0].main.items[0]);\n    assert(!article.main.items[0]._articles[0].main.items[0]._articles);\n  });","file":"recursionGuard.js","skipped":false,"dir":"test"},{"name":"should eventually stop runaway self-references among widgets that use neverLoadSelf: false","suites":["Recursion Guard"],"updatePoint":{"line":193,"column":96,"index":5836},"line":193,"code":"  it('should eventually stop runaway self-references among widgets that use neverLoadSelf: false', async function () {\n    const req = apos.task.getReq();\n    const selfRefId = cuid();\n    await apos.article.insert(req, {\n      aposDocId: selfRefId,\n      title: 'Very Self Referential Article',\n      main: {\n        metaType: 'area',\n        _id: cuid(),\n        items: [{\n          metaType: 'widget',\n          type: 'scary-article',\n          articlesIds: [selfRefId]\n        }]\n      }\n    });\n    let warnings = '';\n    // Capture output of util.warn so we can verify there was a warning\n    apos.util.warn = function (...args) {\n      warnings += args.join('\\n');\n    };\n    const article = await apos.article.find(req, {\n      aposDocId: selfRefId\n    }).toObject();\n    // Verify the stack shown in the warning references the right bits\n    assert(warnings.match(/widget:scary-article/));\n    assert(warnings.match(/relationship:article/));\n    // If we get this far we successfully stopped the recursion at some depth\n    assert(article);\n    // ... But verify some recursion did take place\n    assert(article.main.items[0]);\n    assert(article.main.items[0]._articles[0]);\n    assert(article.main.items[0]._articles[0].main.items[0]._articles[0]);\n  });","file":"recursionGuard.js","skipped":false,"dir":"test"},{"name":"should eventually stop runaway self-references in async components","suites":["Recursion Guard"],"updatePoint":{"line":227,"column":72,"index":7078},"line":227,"code":"  it('should eventually stop runaway self-references in async components', async function () {\n    let warnings = '';\n    // Capture output of util.warn so we can verify there was a warning\n    apos.util.warn = function (...args) {\n      warnings += args.join('\\n');\n    };\n    const html = await apos.http.get('/recursion-test-page');\n    assert(warnings.match(/component:recursion-test-page:test/));\n    // If we got this far the recursion was eventually stopped\n    assert(html.match(/Sing to me, Oh Muse\\./));\n    assert(html.match(/At depth 0/));\n    assert(html.match(/At depth 48/));\n    assert(!html.match(/At depth 49/));\n    assert(!html.match(/Object/));\n  });","file":"recursionGuard.js","skipped":false,"dir":"test"},{"name":"should initialize apos","suites":["REST API routing"],"updatePoint":{"line":10,"column":28,"index":260},"line":10,"code":"  it('should initialize apos', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'rest-test': {\n          restApiRoutes(self) {\n            return {\n              getAll(req) {\n                return {\n                  action: 'getAll'\n                };\n              },\n              getOne(req, _id) {\n                return {\n                  action: 'getOne',\n                  _id\n                };\n              },\n              post(req) {\n                return {\n                  action: 'post',\n                  data: req.body\n                };\n              },\n              delete(req, _id) {\n                return {\n                  action: 'delete',\n                  _id\n                };\n              },\n              patch(req, _id) {\n                return {\n                  action: 'patch',\n                  _id\n                };\n              },\n              put(req, _id) {\n                return {\n                  action: 'put',\n                  _id\n                };\n              }\n            };\n          }\n        }\n      }\n    });\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to getAll","suites":["REST API routing"],"updatePoint":{"line":58,"column":39,"index":1399},"line":58,"code":"  it('should respond properly to getAll', async function () {\n    jar = apos.http.jar();\n    const body = await apos.http.get('/api/v1/rest-test', {\n      // Establish CSRF cookie in jar\n      jar\n    });\n    // We're just testing the routing, we don't actually get back a list of things,\n    // we'll test that with pieces\n    assert(body.action === 'getAll');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to post","suites":["REST API routing"],"updatePoint":{"line":68,"column":37,"index":1765},"line":68,"code":"  it('should respond properly to post', async function () {\n    const body = await apos.http.post('/api/v1/rest-test', {\n      // Use the cookie jar because CSRF tokens are required\n      jar\n    });\n    assert(body.action === 'post');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to delete","suites":["REST API routing"],"updatePoint":{"line":75,"column":39,"index":2009},"line":75,"code":"  it('should respond properly to delete', async function () {\n    const body = await apos.http.delete('/api/v1/rest-test/1000', {\n      jar\n    });\n    assert(body.action === 'delete');\n    assert(body._id === '1000');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to patch","suites":["REST API routing"],"updatePoint":{"line":82,"column":38,"index":2233},"line":82,"code":"  it('should respond properly to patch', async function () {\n    const body = await apos.http.patch('/api/v1/rest-test/1000', {\n      jar\n    });\n    assert(body.action === 'patch');\n    assert(body._id === '1000');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to put","suites":["REST API routing"],"updatePoint":{"line":89,"column":36,"index":2453},"line":89,"code":"  it('should respond properly to put', async function () {\n    const body = await apos.http.put('/api/v1/rest-test/1000', {\n      jar\n    });\n    assert(body.action === 'put');\n    assert(body._id === '1000');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"should respond properly to getOne","suites":["REST API routing"],"updatePoint":{"line":96,"column":39,"index":2672},"line":96,"code":"  it('should respond properly to getOne', async function () {\n    const body = await apos.http.get('/api/v1/rest-test/1000', {\n      jar\n    });\n    assert(body.action === 'getOne');\n    assert(body._id === '1000');\n  });","file":"restApiRoutes.js","skipped":false,"dir":"test"},{"name":"basic reverse relationship query works","suites":["Basic reverse relationships"],"updatePoint":{"line":14,"column":44,"index":554},"line":14,"code":"  it('basic reverse relationship query works', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          product: {\n            options: {\n              alias: 'product'\n            },\n            extend: '@apostrophecms/piece-type',\n            fields: {\n              add: {\n                _salespeople: {\n                  type: 'relationship',\n                  withType: 'salesperson'\n                }\n              }\n            }\n          },\n          salesperson: {\n            options: {\n              alias: 'salesperson'\n            },\n            extend: '@apostrophecms/piece-type',\n            fields: {\n              add: {\n                _products: {\n                  type: 'relationshipReverse',\n                  withType: 'product',\n                  reverseOf: '_salespeople'\n                }\n              }\n            }\n          }\n        }\n      });\n      const req = apos.task.getReq();\n      const salesperson = await apos.salesperson.insert(req, {\n        title: 'Willie Loman'\n      });\n      await apos.salesperson.insert(req, {\n        title: 'Bernie Sanders'\n      });\n      await apos.product.insert(req, {\n        title: 'Soap',\n        _salespeople: [salesperson]\n      });\n      await apos.product.insert(req, {\n        title: 'Rope'\n      });\n      const fetched = await apos.salesperson.find(req, {\n        title: 'Willie Loman'\n      }).toObject();\n      assert(fetched);\n      assert.strictEqual(fetched.title, 'Willie Loman');\n      assert(fetched._products);\n      assert.strictEqual(fetched._products.length, 1);\n      assert.strictEqual(fetched._products[0].title, 'Soap');\n    } finally {\n      if (apos) {\n        await t.destroy(apos);\n      }\n    }\n  });","file":"reverse-relationship.js","skipped":false,"dir":"test"},{"name":"basic reverse relationship query works in the presence of an extra relationship with the types configured in an unexpected order","suites":["Reverse relationships plus an extra relationship"],"updatePoint":{"line":82,"column":134,"index":2526},"line":82,"code":"  it('basic reverse relationship query works in the presence of an extra relationship with the types configured in an unexpected order', async function () {\n    let apos;\n    try {\n      apos = await t.create({\n        root: module,\n        modules: {\n          salesperson: {\n            options: {\n              alias: 'salesperson'\n            },\n            extend: '@apostrophecms/piece-type',\n            fields: {\n              add: {\n                _products: {\n                  type: 'relationshipReverse',\n                  withType: 'product',\n                  reverseOf: '_salespeople'\n                }\n              }\n            }\n          },\n          location: {\n            options: {\n              alias: 'location'\n            },\n            extend: '@apostrophecms/piece-type'\n          },\n          product: {\n            options: {\n              alias: 'product'\n            },\n            extend: '@apostrophecms/piece-type',\n            fields: {\n              add: {\n                _salespeople: {\n                  type: 'relationship',\n                  withType: 'salesperson'\n                },\n                _location: {\n                  type: 'relationship',\n                  withType: 'location'\n                }\n              }\n            }\n          }\n        }\n      });\n      const req = apos.task.getReq();\n      const salesperson = await apos.salesperson.insert(req, {\n        title: 'Willie Loman'\n      });\n      await apos.salesperson.insert(req, {\n        title: 'Bernie Sanders'\n      });\n      await apos.product.insert(req, {\n        title: 'Soap',\n        _salespeople: [salesperson]\n      });\n      await apos.product.insert(req, {\n        title: 'Rope'\n      });\n      const fetched = await apos.salesperson.find(req, {\n        title: 'Willie Loman'\n      }).toObject();\n      const soap = await apos.product.find(req, {\n        title: 'Soap'\n      }).toObject();\n      assert(fetched);\n      assert.strictEqual(fetched.title, 'Willie Loman');\n      assert(fetched._products);\n      assert.strictEqual(fetched._products.length, 1);\n      assert.strictEqual(fetched._products[0].title, 'Soap');\n      assert.strictEqual(soap.title, 'Soap');\n      assert.strictEqual(soap._salespeople[0].title, 'Willie Loman');\n    } finally {\n      if (apos) {\n        await t.destroy(apos);\n      }\n    }\n  });","file":"reverse-relationship.js","skipped":false,"dir":"test"},{"name":"test modules exist","suites":["Schema builders"],"updatePoint":{"line":17,"column":24,"index":344},"line":17,"code":"  it('test modules exist', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        cats: {\n          extend: '@apostrophecms/piece-type',\n          fields: {\n            add: {\n              flavor: {\n                type: 'select',\n                label: 'Flavor',\n                choices: [{\n                  label: 'Grape',\n                  value: 'grape'\n                }, {\n                  label: 'Cherry',\n                  value: 'cherry'\n                }, {\n                  label: 'Mint',\n                  value: 'mint'\n                }]\n              }\n            }\n          },\n          options: {\n            name: 'cat',\n            label: 'Cat',\n            alias: 'cats'\n          }\n        },\n        people: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            name: 'person',\n            label: 'Person',\n            alias: 'people'\n          },\n          fields: {\n            add: {\n              _cats: {\n                type: 'relationship',\n                idsStorage: 'catsIds',\n                label: 'Cats',\n                withType: 'cat'\n              },\n              _favorites: {\n                type: 'relationship',\n                max: 1,\n                idsStorage: 'favoriteIds',\n                label: 'Favorites',\n                withType: 'cat'\n              },\n              isACatPerson: {\n                type: 'boolean',\n                label: 'Is a cat person?',\n                required: true\n              }\n            }\n          }\n        }\n      }\n    });\n    assert(apos.schema);\n    assert(apos.cats);\n    assert(apos.people);\n    apos.argv._ = [];\n    let i;\n    for (i = 0; i < 11; i++) {\n      cats[i] = {};\n      cats[i].title = 'Cat ' + i;\n      cats[i].i = i;\n      people[i] = {};\n      people[i].i = i;\n      people[i].title = 'Person ' + i;\n    }\n    cats[0].flavor = 'cherry';\n    cats[1].flavor = 'mint';\n    cats[4].flavor = 'mint';\n    const req = apos.task.getReq();\n    await apos.doc.db.deleteMany({\n      type: 'cat'\n    });\n    for (i = 0; i < cats.length; i++) {\n      cats[i] = await apos.cats.insert(req, cats[i]);\n    }\n    for (i = 0; i < people.length; i++) {\n      const person = people[i];\n      person.isACatPerson = true;\n      // person 10 has no favorite cat\n      if (i < 10) {\n        person.favoriteIds = [cats[i].aposDocId];\n        person.isACatPerson = false;\n      }\n      person.catsIds = [];\n      let j;\n      // person 10 is allergic to cats\n      if (i < 10) {\n        for (j = 0; j < i; j++) {\n          person.catsIds.push(cats[j].aposDocId);\n        }\n      }\n      people[i] = await apos.people.insert(req, person);\n    }\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _cats exists","suites":["Schema builders"],"updatePoint":{"line":121,"column":30,"index":3053},"line":121,"code":"  it('builder for _cats exists', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    assert(query._cats);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _cats can select people with a specified cat","suites":["Schema builders"],"updatePoint":{"line":126,"column":62,"index":3246},"line":126,"code":"  it('builder for _cats can select people with a specified cat', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    // Four people should have cat 5 (because their i is greater than 5, see\n    // the sample data generator above)\n    query._cats(cats[5].aposDocId);\n    const people = await query.toArray();\n    assert(people.length === 4);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _cats can select people with any of three cats via array","suites":["Schema builders"],"updatePoint":{"line":135,"column":74,"index":3654},"line":135,"code":"  it('builder for _cats can select people with any of three cats via array', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query._cats([cats[0]._id, cats[1]._id, cats[2]._id]);\n    const people = await query.toArray();\n    // Everybody except person 0 has the first cat\n    assert(people.length === 9);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"_catsAnd builder can select people with all three cats","suites":["Schema builders"],"updatePoint":{"line":143,"column":60,"index":4004},"line":143,"code":"  it('_catsAnd builder can select people with all three cats', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query._catsAnd([cats[0]._id, cats[1]._id, cats[2]._id]);\n    const people = await query.toArray();\n    // Only people 3-9 have cat 2\n    assert(people.length === 7);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _cats can select sad people with no cat","suites":["Schema builders"],"updatePoint":{"line":151,"column":57,"index":4337},"line":151,"code":"  it('builder for _cats can select sad people with no cat', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query._cats('none');\n    const _people = await query.toArray();\n    // Persons 0 and 10 have no cats\n    assert(_people.length === 2);\n    const ids = _.map(_people, '_id');\n    assert(_.includes(ids, people[0]._id));\n    assert(_.includes(ids, people[10]._id));\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"when not used builder for _cats has no effect","suites":["Schema builders"],"updatePoint":{"line":162,"column":51,"index":4761},"line":162,"code":"  it('when not used builder for _cats has no effect', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const people = await query.toArray();\n    assert(people.length === 11);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for _cats","suites":["Schema builders"],"updatePoint":{"line":168,"column":34,"index":4977},"line":168,"code":"  it('can obtain choices for _cats', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const cats = await query.toChoices('_cats');\n    // Only the cats that are actually somebody's cat come up\n    assert(cats.length === 9);\n    assert(cats[0].value);\n    assert(cats[0].label);\n    assert(cats[0].slug);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for cats exists","suites":["Schema builders"],"updatePoint":{"line":178,"column":29,"index":5334},"line":178,"code":"  it('builder for cats exists', function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    assert(query.cats);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for cats can select people with a specified cat (by slug)","suites":["Schema builders"],"updatePoint":{"line":183,"column":71,"index":5529},"line":183,"code":"  it('builder for cats can select people with a specified cat (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    // Four people should have cat 5 (because their i is greater than 5, see\n    // the sample data generator above)\n    query.cats(cats[5].slug);\n    const people = await query.toArray();\n    assert(people.length === 4);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for cats can select people with any of three cats via array (by slug)","suites":["Schema builders"],"updatePoint":{"line":192,"column":83,"index":5940},"line":192,"code":"  it('builder for cats can select people with any of three cats via array (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query.cats([cats[0].slug, cats[1].slug, cats[2].slug]);\n    const people = await query.toArray();\n    // Everybody except person 0 has the first cat\n    assert(people.length === 9);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"catsAnd builder can select people with all three cats (by slug)","suites":["Schema builders"],"updatePoint":{"line":200,"column":69,"index":6301},"line":200,"code":"  it('catsAnd builder can select people with all three cats (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query.catsAnd([cats[0].slug, cats[1].slug, cats[2].slug]);\n    const people = await query.toArray();\n    // Only people 3-9 have cat 2\n    assert(people.length === 7);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for cats can select sad people with no cat (by slug)","suites":["Schema builders"],"updatePoint":{"line":208,"column":66,"index":6645},"line":208,"code":"  it('builder for cats can select sad people with no cat (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query.cats('none');\n    const _people = await query.toArray();\n    // Persons 0 and 10 have no cats\n    assert(_people.length === 2);\n    const ids = _.map(_people, '_id');\n    assert(_.includes(ids, people[0]._id));\n    assert(_.includes(ids, people[10]._id));\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"when not used builder for cats (by slug) has no effect","suites":["Schema builders"],"updatePoint":{"line":219,"column":60,"index":7077},"line":219,"code":"  it('when not used builder for cats (by slug) has no effect', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const people = await query.toArray();\n    assert(people.length === 11);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for cats (by slug)","suites":["Schema builders"],"updatePoint":{"line":225,"column":43,"index":7302},"line":225,"code":"  it('can obtain choices for cats (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const cats = await query.toChoices('cats');\n    // Only the cats that are actually somebody's cat come up\n    assert(cats.length === 9);\n    assert(cats[0].value);\n    assert(cats[0].label);\n    assert(cats[0].value === 'cat-0');\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _favorites exists","suites":["Schema builders"],"updatePoint":{"line":235,"column":35,"index":7677},"line":235,"code":"  it('builder for _favorites exists', function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    assert(query._favorites);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _favorites can select people with a specified favorite cat","suites":["Schema builders"],"updatePoint":{"line":240,"column":76,"index":7883},"line":240,"code":"  it('builder for _favorites can select people with a specified favorite cat', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    // Only one person has each favorite\n    query._favorites(cats[3]._id);\n    const people = await query.toArray();\n    assert(people.length === 1);\n    assert(people[0].i === 3);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _favorites can use array syntax","suites":["Schema builders"],"updatePoint":{"line":249,"column":49,"index":8220},"line":249,"code":"  it('builder for _favorites can use array syntax', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query._favorites([cats[7]._id]);\n    const people = await query.toArray();\n    // Only person 0 prefers the first cat\n    assert(people.length === 1);\n    assert(people[0].i === 7);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for _favorites can select sad people who dislike cats","suites":["Schema builders"],"updatePoint":{"line":258,"column":67,"index":8579},"line":258,"code":"  it('builder for _favorites can select sad people who dislike cats', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query._favorites('none');\n    const people = await query.toArray();\n    // Only person 10 has no favorite cat\n    assert(people.length === 1);\n    assert(people[0].i === 10);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"when not used builder for _favorites has no effect","suites":["Schema builders"],"updatePoint":{"line":267,"column":56,"index":8920},"line":267,"code":"  it('when not used builder for _favorites has no effect', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const people = await query.toArray();\n    assert(people.length === 11);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for _favorites","suites":["Schema builders"],"updatePoint":{"line":273,"column":39,"index":9141},"line":273,"code":"  it('can obtain choices for _favorites', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const cats = await query.toChoices('_favorites');\n    // Only the cats that are actually someone's favorite come up\n    assert(cats.length === 10);\n    assert(cats[0].value);\n    assert(cats[0].label);\n    assert(cats[0].slug);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for isACatPerson","suites":["Schema builders"],"updatePoint":{"line":283,"column":41,"index":9520},"line":283,"code":"  it('can obtain choices for isACatPerson', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const isACatPerson = await query.toChoices('isACatPerson');\n    const actual = isACatPerson;\n    const expected = [{\n      value: '1',\n      label: 'apostrophe:yes'\n    }, {\n      value: '0',\n      label: 'apostrophe:no'\n    }];\n    assert.deepEqual(actual, expected);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for favorite (by slug) exists","suites":["Schema builders"],"updatePoint":{"line":297,"column":43,"index":9942},"line":297,"code":"  it('builder for favorite (by slug) exists', function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    assert(query._favorites);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for favorite can select people with a specified favorite cat (by slug)","suites":["Schema builders"],"updatePoint":{"line":302,"column":84,"index":10156},"line":302,"code":"  it('builder for favorite can select people with a specified favorite cat (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    // Only one person has each favorite\n    query.favorites(cats[3].slug);\n    const people = await query.toArray();\n    assert(people.length === 1);\n    assert(people[0].i === 3);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for favorite can select people with a specified favorite cat (by slug) plus a search without a refinalize crash","suites":["Schema builders"],"updatePoint":{"line":311,"column":125,"index":10569},"line":311,"code":"  it('builder for favorite can select people with a specified favorite cat (by slug) plus a search without a refinalize crash', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    // Only one person has each favorite\n    query.favorites(cats[3].slug);\n    const people = await query.search('person').toArray();\n    assert(people.length === 1);\n    assert(people[0].i === 3);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for favorite (by slug) can use array syntax","suites":["Schema builders"],"updatePoint":{"line":320,"column":57,"index":10931},"line":320,"code":"  it('builder for favorite (by slug) can use array syntax', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query.favorites([cats[7].slug]);\n    const people = await query.toArray();\n    // Only person 0 prefers the first cat\n    assert(people.length === 1);\n    assert(people[0].i === 7);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for favorite (by slug) can select sad people who dislike cats","suites":["Schema builders"],"updatePoint":{"line":329,"column":75,"index":11298},"line":329,"code":"  it('builder for favorite (by slug) can select sad people who dislike cats', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    query.favorites('none');\n    const people = await query.toArray();\n    // Only person 10 has no favorite cat\n    assert(people.length === 1);\n    assert(people[0].i === 10);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"when not used builder for favorite (by slug) has no effect","suites":["Schema builders"],"updatePoint":{"line":338,"column":64,"index":11646},"line":338,"code":"  it('when not used builder for favorite (by slug) has no effect', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const people = await query.toArray();\n    assert(people.length === 11);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for favorite (by slug)","suites":["Schema builders"],"updatePoint":{"line":344,"column":47,"index":11875},"line":344,"code":"  it('can obtain choices for favorite (by slug)', async function () {\n    const req = apos.task.getReq();\n    const query = apos.people.find(req);\n    const cats = await query.toChoices('favorites');\n    // Only the cats that are actually someone's favorite come up\n    assert(cats.length === 10);\n    assert(cats[0].value);\n    assert(cats[0].label);\n    assert(cats[0].value === 'cat-0');\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for flavor exists","suites":["Schema builders"],"updatePoint":{"line":354,"column":31,"index":12256},"line":354,"code":"  it('builder for flavor exists', function () {\n    const req = apos.task.getReq();\n    const query = apos.cats.find(req);\n    assert(query.flavor);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for flavor can select cats of a specified flavor","suites":["Schema builders"],"updatePoint":{"line":359,"column":62,"index":12442},"line":359,"code":"  it('builder for flavor can select cats of a specified flavor', async function () {\n    const req = apos.task.getReq();\n    const query = apos.cats.find(req);\n    query.flavor('mint');\n    const cats = await query.toArray();\n    assert(cats.length === 2);\n    assert(_.find(cats, {\n      i: 1\n    }));\n    assert(_.find(cats, {\n      i: 4\n    }));\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"builder for flavor can use array syntax","suites":["Schema builders"],"updatePoint":{"line":372,"column":45,"index":12780},"line":372,"code":"  it('builder for flavor can use array syntax', async function () {\n    const req = apos.task.getReq();\n    const query = apos.cats.find(req);\n    query.flavor(['mint', 'cherry']);\n    const cats = await query.toArray();\n    assert(cats.length === 3);\n    assert(_.find(cats, {\n      i: 0\n    }));\n    assert(_.find(cats, {\n      i: 1\n    }));\n    assert(_.find(cats, {\n      i: 4\n    }));\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"when not used builder for flavor has no effect","suites":["Schema builders"],"updatePoint":{"line":388,"column":52,"index":13183},"line":388,"code":"  it('when not used builder for flavor has no effect', async function () {\n    const req = apos.task.getReq();\n    const query = apos.cats.find(req);\n    const cats = await query.toArray();\n    assert(cats.length === 11);\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"can obtain choices for flavor","suites":["Schema builders"],"updatePoint":{"line":394,"column":35,"index":13394},"line":394,"code":"  it('can obtain choices for flavor', async function () {\n    const req = apos.task.getReq();\n    const query = apos.cats.find(req);\n    const flavors = await query.toChoices('flavor');\n    // Only the flavors associated with at least one cat come up, in alpha order\n    assert(flavors.length === 2);\n    assert(flavors[0].value === 'cherry');\n    assert(flavors[0].label === 'Cherry');\n    assert(flavors[1].value === 'mint');\n    assert(flavors[1].label === 'Mint');\n  });","file":"schemaBuilders.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Schemas"],"updatePoint":{"line":243,"column":45,"index":4759},"line":243,"code":"  it('should be a property of the apos object', function () {\n    assert(apos.schema);\n    apos.argv._ = [];\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should compose schemas correctly","suites":["Schemas"],"updatePoint":{"line":247,"column":38,"index":4867},"line":247,"code":"  it('should compose schemas correctly', function () {\n    const options = {\n      addFields: [{\n        name: 'name',\n        type: 'string',\n        label: 'Name'\n      }, {\n        name: 'address',\n        type: 'string',\n        label: 'Address',\n        textarea: true\n      }, {\n        name: 'variety',\n        type: 'select',\n        label: 'Variety',\n        choices: [{\n          value: 'candy',\n          label: 'Candy'\n        }, {\n          value: 'cheese',\n          label: 'Cheese'\n        }]\n      }],\n      removeFields: ['address'],\n      alterFields: function (schema) {\n        const variety = _.find(schema, {\n          name: 'variety'\n        });\n        assert(variety);\n        variety.choices.push({\n          value: 'record',\n          label: 'Record'\n        });\n      }\n    };\n    const schema = apos.schema.compose(options);\n    assert(schema.length === 2);\n    assert(schema[0].name === 'name');\n    assert(schema[1].name === 'variety');\n    assert(_.keys(schema[1].choices).length === 3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should compose a schema for a complex real world case correctly","suites":["Schemas"],"updatePoint":{"line":288,"column":69,"index":5924},"line":288,"code":"  it('should compose a schema for a complex real world case correctly', function () {\n    const schema = apos.schema.compose(realWorldCase);\n    assert(schema);\n    const externalUrl = _.find(schema, {\n      name: 'externalUrl'\n    });\n    assert(externalUrl);\n    assert.strictEqual(externalUrl.group.name, 'otherFields');\n    const _newPage = _.find(schema, {\n      name: '_newPage'\n    });\n    assert(_newPage);\n    assert.strictEqual(_newPage.group.name, 'otherFields');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should error if a field is required and an empty value is submitted for a string field type","suites":["Schemas"],"updatePoint":{"line":302,"column":97,"index":6433},"line":302,"code":"  it('should error if a field is required and an empty value is submitted for a string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'name',\n        label: 'Name',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      name: ''\n    };\n    await testSchemaError(schema, input, 'name', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should error if the value submitted is less than min length for a string field type","suites":["Schemas"],"updatePoint":{"line":317,"column":89,"index":6858},"line":317,"code":"  it('should error if the value submitted is less than min length for a string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'name',\n        label: 'Name',\n        min: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      name: 'Cow'\n    };\n    await testSchemaError(schema, input, 'name', 'min');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert and keep the correct value for a field which is required for a string field type","suites":["Schemas"],"updatePoint":{"line":332,"column":101,"index":7285},"line":332,"code":"  it('should convert and keep the correct value for a field which is required for a string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'name',\n        label: 'Name',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      name: 'Apostrophe^CMS'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.name === 'Apostrophe^CMS');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should keep an empty submitted field value null when there is a min / max configuration for an integer field type","suites":["Schemas"],"updatePoint":{"line":350,"column":119,"index":7856},"line":350,"code":"  it('should keep an empty submitted field value null when there is a min / max configuration for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        min: 1,\n        max: 10\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: ''\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === null);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should keep an empty submitted field value null when there is a min / max configuration for a float field type","suites":["Schemas"],"updatePoint":{"line":370,"column":116,"index":8453},"line":370,"code":"  it('should keep an empty submitted field value null when there is a min / max configuration for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        min: 1,\n        max: 10\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: ''\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === null);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ensure a max value is being trimmed to the max length for a string field type","suites":["Schemas"],"updatePoint":{"line":390,"column":90,"index":9022},"line":390,"code":"  it('should ensure a max value is being trimmed to the max length for a string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'name',\n        label: 'Name',\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      name: 'Apostrophe'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.name === 'Apost');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a number if a field is required for an integer field type","suites":["Schemas"],"updatePoint":{"line":409,"column":105,"index":9599},"line":409,"code":"  it('should allow saving a 0 value provided as a number if a field is required for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 0\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a float if a field is required for an float field type","suites":["Schemas"],"updatePoint":{"line":428,"column":102,"index":10169},"line":428,"code":"  it('should allow saving a 0 value provided as a float if a field is required for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 0.00\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0.00);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a number if a field is required for an float field type","suites":["Schemas"],"updatePoint":{"line":447,"column":103,"index":10744},"line":447,"code":"  it('should allow saving a 0 value provided as a number if a field is required for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 0\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a number if a field is required for an string field type","suites":["Schemas"],"updatePoint":{"line":466,"column":104,"index":11314},"line":466,"code":"  it('should allow saving a 0 value provided as a number if a field is required for an string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 0\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === '0');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a string if a field is required for an integer field type","suites":["Schemas"],"updatePoint":{"line":485,"column":105,"index":11888},"line":485,"code":"  it('should allow saving a 0 value provided as a string if a field is required for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '0'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a string if a field is required for an string field type","suites":["Schemas"],"updatePoint":{"line":504,"column":104,"index":12462},"line":504,"code":"  it('should allow saving a 0 value provided as a string if a field is required for an string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '0'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === '0');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a string if a field is required for an float field type","suites":["Schemas"],"updatePoint":{"line":523,"column":103,"index":13036},"line":523,"code":"  it('should allow saving a 0 value provided as a string if a field is required for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '0'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a string if there is no min value set for an integer field type","suites":["Schemas"],"updatePoint":{"line":542,"column":111,"index":13615},"line":542,"code":"  it('should allow saving a 0 value provided as a string if there is no min value set for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '0'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a 0 value provided as a string if there is no min value set for a float field type","suites":["Schemas"],"updatePoint":{"line":560,"column":108,"index":14169},"line":560,"code":"  it('should allow saving a 0 value provided as a string if there is no min value set for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '0'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a number for an integer field type","suites":["Schemas"],"updatePoint":{"line":578,"column":89,"index":14702},"line":578,"code":"  it('should allow saving a negative value provided as a number for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: -1\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === -1);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a float for an float field type","suites":["Schemas"],"updatePoint":{"line":596,"column":86,"index":15234},"line":596,"code":"  it('should allow saving a negative value provided as a float for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: -1.3\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === -1.3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a float for an string field type","suites":["Schemas"],"updatePoint":{"line":614,"column":87,"index":15769},"line":614,"code":"  it('should allow saving a negative value provided as a float for an string field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'string',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: -1.3\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === '-1.3');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a number if a field is required for an integer field type","suites":["Schemas"],"updatePoint":{"line":632,"column":112,"index":16332},"line":632,"code":"  it('should allow saving a negative value provided as a number if a field is required for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: -1\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === -1);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a number if a field is required for an float field type","suites":["Schemas"],"updatePoint":{"line":651,"column":110,"index":16912},"line":651,"code":"  it('should allow saving a negative value provided as a number if a field is required for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: -1.3\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === -1.3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow saving a negative value provided as a string if a field is required for an float field type","suites":["Schemas"],"updatePoint":{"line":670,"column":110,"index":17494},"line":670,"code":"  it('should allow saving a negative value provided as a string if a field is required for an float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '-1.3'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === -1.3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should override the saved value if min and max value has been set and the submitted value is out of range for an integer field type","suites":["Schemas"],"updatePoint":{"line":689,"column":137,"index":18105},"line":689,"code":"  it('should override the saved value if min and max value has been set and the submitted value is out of range for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        min: 5,\n        max: 6\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '3'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should override the saved value if min and max value has been set and the submitted value is out of range for a float field type","suites":["Schemas"],"updatePoint":{"line":709,"column":134,"index":18717},"line":709,"code":"  it('should override the saved value if min and max value has been set and the submitted value is out of range for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        min: 5.1,\n        max: 6\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '3.2'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5.1);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ensure a min value is being set to the configured min value if a lower value is submitted for an integer field type","suites":["Schemas"],"updatePoint":{"line":729,"column":128,"index":19327},"line":729,"code":"  it('should ensure a min value is being set to the configured min value if a lower value is submitted for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        min: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '1'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ensure a min value is being set to the configured min value if a lower value is submitted for a float field type","suites":["Schemas"],"updatePoint":{"line":748,"column":125,"index":19914},"line":748,"code":"  it('should ensure a min value is being set to the configured min value if a lower value is submitted for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        min: 5.3\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '1.2'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5.3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ensure a max value is being set to the max if a higher value is submitted for an integer field type","suites":["Schemas"],"updatePoint":{"line":767,"column":112,"index":20492},"line":767,"code":"  it('should ensure a max value is being set to the max if a higher value is submitted for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '8'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ensure a max value is being set to the max if a higher value is submitted for a float field type","suites":["Schemas"],"updatePoint":{"line":786,"column":109,"index":21063},"line":786,"code":"  it('should ensure a max value is being set to the max if a higher value is submitted for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        max: 5.9\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '8'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5.9);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not modify a value if the submitted value is within min and max for an integer field type","suites":["Schemas"],"updatePoint":{"line":805,"column":102,"index":21629},"line":805,"code":"  it('should not modify a value if the submitted value is within min and max for an integer field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        min: 4,\n        max: 6\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '5'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 5);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not modify a value if the submitted value is within min and max for a float field type","suites":["Schemas"],"updatePoint":{"line":825,"column":99,"index":22206},"line":825,"code":"  it('should not modify a value if the submitted value is within min and max for a float field type', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        min: 4,\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '4.3'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.price === 4.3);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a required integer field","suites":["Schemas"],"updatePoint":{"line":845,"column":80,"index":22766},"line":845,"code":"  it('should not allow a text value to be submitted for a required integer field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a required float field","suites":["Schemas"],"updatePoint":{"line":860,"column":78,"index":23185},"line":860,"code":"  it('should not allow a text value to be submitted for a required float field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        required: true\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required integer field with min and max","suites":["Schemas"],"updatePoint":{"line":875,"column":101,"index":23625},"line":875,"code":"  it('should not allow a text value to be submitted for a non required integer field with min and max', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        min: 1,\n        max: 10\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required float field with min and max","suites":["Schemas"],"updatePoint":{"line":891,"column":99,"index":24074},"line":891,"code":"  it('should not allow a text value to be submitted for a non required float field with min and max', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        min: 1,\n        max: 10\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required integer field with a default value set","suites":["Schemas"],"updatePoint":{"line":907,"column":109,"index":24531},"line":907,"code":"  it('should not allow a text value to be submitted for a non required integer field with a default value set', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price',\n        def: 2\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required float field with a default value set","suites":["Schemas"],"updatePoint":{"line":922,"column":107,"index":24971},"line":922,"code":"  it('should not allow a text value to be submitted for a non required float field with a default value set', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price',\n        def: 2.10\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required integer field","suites":["Schemas"],"updatePoint":{"line":937,"column":84,"index":25389},"line":937,"code":"  it('should not allow a text value to be submitted for a non required integer field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not allow a text value to be submitted for a non required float field","suites":["Schemas"],"updatePoint":{"line":951,"column":82,"index":25788},"line":951,"code":"  it('should not allow a text value to be submitted for a non required float field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: 'A'\n    };\n    await testSchemaError(schema, input, 'price', 'invalid');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow a parsable string/integer value to be submitted for a non required integer field","suites":["Schemas"],"updatePoint":{"line":965,"column":99,"index":26202},"line":965,"code":"  it('should allow a parsable string/integer value to be submitted for a non required integer field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'integer',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '22a'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.price === 22);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should allow a parsable string/float value to be submitted for a non required float field","suites":["Schemas"],"updatePoint":{"line":982,"column":95,"index":26705},"line":982,"code":"  it('should allow a parsable string/float value to be submitted for a non required float field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'float',\n        name: 'price',\n        label: 'Price'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      price: '11.4b'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.price === 11.4);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should set the default range field value when undefined is given","suites":["Schemas"],"updatePoint":{"line":999,"column":70,"index":27185},"line":999,"code":"  it('should set the default range field value when undefined is given', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'range',\n        name: 'rating',\n        label: 'Rating',\n        def: 0,\n        min: 0,\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {};\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.rating === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should set the default range field value when null is given","suites":["Schemas"],"updatePoint":{"line":1017,"column":65,"index":27682},"line":1017,"code":"  it('should set the default range field value when null is given', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'range',\n        name: 'rating',\n        label: 'Rating',\n        def: 0,\n        min: 0,\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      rating: null\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.rating === 0);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should set the range field value to null when a value below the min threshold is given","suites":["Schemas"],"updatePoint":{"line":1037,"column":92,"index":28230},"line":1037,"code":"  it('should set the range field value to null when a value below the min threshold is given', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'range',\n        name: 'rating',\n        label: 'Rating',\n        def: 0,\n        min: 0,\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      rating: -1\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.rating === null);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should set the range field value to null when a value over the max threshold is given","suites":["Schemas"],"updatePoint":{"line":1057,"column":91,"index":28778},"line":1057,"code":"  it('should set the range field value to null when a value over the max threshold is given', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'range',\n        name: 'rating',\n        label: 'Rating',\n        def: 0,\n        min: 0,\n        max: 5\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      rating: 6\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.rating === null);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert simple data correctly","suites":["Schemas"],"updatePoint":{"line":1077,"column":42,"index":29276},"line":1077,"code":"  it('should convert simple data correctly', async function () {\n    const schema = apos.schema.compose({\n      addFields: simpleFields\n    });\n    assert(schema.length === 4);\n    const input = {\n      name: 'Bob Smith',\n      address: '5017 Awesome Street\\nPhiladelphia, PA 19147',\n      irrelevant: 'Irrelevant',\n      slug: 'This Is Cool'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(_.keys(result).length === 4);\n    // expected fields came through\n    assert(result.name === input.name);\n    assert(result.address === input.address);\n    // default\n    assert(result.variety === simpleFields[2].choices[0].value);\n    assert(result.slug === 'this-is-cool');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should update a password if provided","suites":["Schemas"],"updatePoint":{"line":1100,"column":42,"index":30076},"line":1100,"code":"  it('should update a password if provided', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'password',\n        name: 'password',\n        label: 'Password'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      password: 'silly'\n    };\n    const req = apos.task.getReq();\n    const result = {\n      password: 'serious'\n    };\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    // hashing is not the business of schemas, see the\n    // @apostrophecms/user module\n    assert(result.password === 'silly');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should leave a password alone if not provided","suites":["Schemas"],"updatePoint":{"line":1122,"column":51,"index":30716},"line":1122,"code":"  it('should leave a password alone if not provided', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'password',\n        name: 'password',\n        label: 'Password'\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      password: ''\n    };\n    const req = apos.task.getReq();\n    const result = {\n      password: 'serious'\n    };\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    // hashing is not the business of schemas, see the\n    // @apostrophecms/user module\n    assert(result.password === 'serious');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should handle array schemas","suites":["Schemas"],"updatePoint":{"line":1144,"column":33,"index":31335},"line":1144,"code":"  it('should handle array schemas', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'array',\n        name: 'addresses',\n        label: 'Addresses',\n        schema: [{\n          name: 'address',\n          type: 'string',\n          label: 'Address'\n        }]\n      }]\n    });\n    assert(schema.length === 1);\n    const input = {\n      addresses: [{\n        address: '500 test lane'\n      }, {\n        address: '602 test ave'\n      }]\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.addresses);\n    assert(result.addresses.length === 2);\n    assert(result.addresses[0]._id);\n    assert(result.addresses[1]._id);\n    assert(result.addresses[0].address === '500 test lane');\n    assert(result.addresses[1].address === '602 test ave');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should check for duplicates in arrays when relevant","suites":["Schemas"],"updatePoint":{"line":1176,"column":57,"index":32279},"line":1176,"code":"  it('should check for duplicates in arrays when relevant', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        type: 'array',\n        name: 'addresses',\n        label: 'Addresses',\n        schema: [{\n          name: 'address',\n          type: 'string',\n          label: 'Address',\n          unique: true\n        }]\n      }]\n    });\n    const input = {\n      addresses: [{\n        address: '500 test lane'\n      }, {\n        address: '602 test ave'\n      }]\n    };\n    const result = {};\n    const req = apos.task.getReq();\n    await apos.schema.convert(req, schema, input, result);\n    assert(_.keys(result).length === 1);\n    assert(result.addresses);\n    assert(result.addresses.length === 2);\n    assert(result.addresses[0]._id);\n    assert(result.addresses[1]._id);\n    assert(result.addresses[0].address === '500 test lane');\n    assert(result.addresses[1].address === '602 test ave');\n    input.addresses[1] = '500 test lane';\n    await apos.schema.convert(req, schema, input, result);\n    assert.throws(() => {\n      throw apos.error('duplicate', 'Address in Addresses must be unique');\n    }, {\n      name: 'duplicate',\n      message: 'Address in Addresses must be unique'\n    });\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert string values to areas correctly","suites":["Schemas"],"updatePoint":{"line":1216,"column":53,"index":33508},"line":1216,"code":"  it('should convert string values to areas correctly', async function () {\n    const schema = apos.schema.compose(hasArea);\n    assert(schema.length === 1);\n    const input = {\n      irrelevant: 'Irrelevant',\n      // Should get escaped, not be treated as HTML\n      body: 'This is the greatest <h1>thing</h1>'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(_.keys(result).length === 1);\n    // expected fields came through\n    assert(result.body);\n    assert(result.body.metaType === 'area');\n    assert(result.body.items);\n    assert(result.body.items[0]);\n    assert(result.body.items[0].type === '@apostrophecms/rich-text');\n    assert(result.body.items[0].content === apos.util.escapeHtml(input.body));\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert arrays of widgets to areas correctly","suites":["Schemas"],"updatePoint":{"line":1237,"column":57,"index":34355},"line":1237,"code":"  it('should convert arrays of widgets to areas correctly', async function () {\n    const schema = apos.schema.compose(hasArea);\n    assert(schema.length === 1);\n    const input = {\n      irrelevant: 'Irrelevant',\n      body: [{\n        metaType: 'widget',\n        _id: 'abc',\n        type: '@apostrophecms/rich-text',\n        content: '<h4>This <em>is</em> <strong>a header.</strong></h4>'\n      }]\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(_.keys(result).length === 1);\n    // expected fields came through\n    assert(result.body);\n    assert(result.body.metaType === 'area');\n    assert(result.body.items);\n    assert(result.body.items[0]);\n    assert(result.body.items[0].type === '@apostrophecms/rich-text');\n    assert.strictEqual(result.body.items[0].content, '<h4>This is <strong>a header.</strong></h4>');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not accept a widget not in the widgets object of the area","suites":["Schemas"],"updatePoint":{"line":1262,"column":70,"index":35321},"line":1262,"code":"  it('should not accept a widget not in the widgets object of the area', async function () {\n    const schema = apos.schema.compose(hasAreaWithoutWidgets);\n    assert(schema.length === 1);\n    const input = {\n      irrelevant: 'Irrelevant',\n      body: [{\n        metaType: 'widget',\n        _id: 'abc',\n        type: '@apostrophecms/rich-text',\n        content: '<h4>This <em>is</em> <strong>a header.</strong></h4>'\n      }]\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(!result.body.items[0]);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert areas gracefully when they are undefined","suites":["Schemas"],"updatePoint":{"line":1280,"column":61,"index":35944},"line":1280,"code":"  it('should convert areas gracefully when they are undefined', async function () {\n    const schema = apos.schema.compose(hasArea);\n    assert(schema.length === 1);\n    const input = {\n      irrelevant: 'Irrelevant',\n      // Should get escaped, not be treated as HTML\n      body: undefined\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(_.keys(result).length === 1);\n    // expected fields came through\n    assert(result.body);\n    assert(result.body.metaType === 'area');\n    assert(result.body.items);\n    assert(!result.body.items[0]);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should convert arrays of widgets when configured as groups to areas correctly","suites":["Schemas"],"updatePoint":{"line":1299,"column":83,"index":36641},"line":1299,"code":"  it('should convert arrays of widgets when configured as groups to areas correctly', async function () {\n    const schema = apos.schema.compose(hasGroupedArea);\n    assert(schema.length === 1);\n    const input = {\n      irrelevant: 'Irrelevant',\n      // Should get escaped, not be treated as HTML\n      body: 'I have <h1>groups</h1>!'\n    };\n    const req = apos.task.getReq();\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    // no irrelevant or missing fields\n    assert(_.keys(result).length === 1);\n    // expected fields came through\n    assert(result.body);\n    assert(result.body.metaType === 'area');\n    assert(result.body.items);\n    assert(result.body.items[0]);\n    assert(result.body.items[0].type === '@apostrophecms/rich-text');\n    assert(result.body.items[0].content === apos.util.escapeHtml(input.body));\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should clean up extra slashes in page slugs","suites":["Schemas"],"updatePoint":{"line":1320,"column":49,"index":37475},"line":1320,"code":"  it('should clean up extra slashes in page slugs', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: pageSlug\n    });\n    assert(schema.length === 1);\n    const input = {\n      slug: '/wiggy//wacky///wobbly////whizzle/////'\n    };\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert.strictEqual(result.slug, '/wiggy/wacky/wobbly/whizzle');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"retains trailing / on the home page","suites":["Schemas"],"updatePoint":{"line":1333,"column":41,"index":37919},"line":1333,"code":"  it('retains trailing / on the home page', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: pageSlug\n    });\n    assert(schema.length === 1);\n    const input = {\n      slug: '/'\n    };\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.slug === '/');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"does not keep slashes when page: true not present for slug","suites":["Schemas"],"updatePoint":{"line":1346,"column":64,"index":38314},"line":1346,"code":"  it('does not keep slashes when page: true not present for slug', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: regularSlug\n    });\n    assert(schema.length === 1);\n    const input = {\n      slug: '/wiggy//wacky///wobbly////whizzle/////'\n    };\n    const result = {};\n    await apos.schema.convert(req, schema, input, result);\n    assert(result.slug === 'wiggy-wacky-wobbly-whizzle');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"enforces required property for ordinary field","suites":["Schemas"],"updatePoint":{"line":1359,"column":51,"index":38761},"line":1359,"code":"  it('enforces required property for ordinary field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        label: 'Age',\n        type: 'integer',\n        required: true\n      }]\n    });\n    await testSchemaError(schema, {\n      age: ''\n    }, 'age', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"ignores required property for hidden field","suites":["Schemas"],"updatePoint":{"line":1372,"column":48,"index":39084},"line":1372,"code":"  it('ignores required property for hidden field', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }]\n      }]\n    });\n    const output = {};\n    await apos.schema.convert(req, schema, {\n      ageOrShoeSize: 'shoeSize',\n      age: ''\n    }, output);\n    assert(output.ageOrShoeSize === 'shoeSize');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"enforces required property for shown field","suites":["Schemas"],"updatePoint":{"line":1408,"column":48,"index":39941},"line":1408,"code":"  it('enforces required property for shown field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }]\n      }]\n    });\n    await testSchemaError(schema, {\n      ageOrShoeSize: 'age',\n      age: ''\n    }, 'age', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"ignores required property for recursively hidden field","suites":["Schemas"],"updatePoint":{"line":1441,"column":60,"index":40699},"line":1441,"code":"  it('ignores required property for recursively hidden field', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }],\n        if: {\n          doWeCare: '1'\n        }\n      }, {\n        name: 'doWeCare',\n        type: 'select',\n        choices: [{\n          label: 'Yes',\n          value: '1'\n        }, {\n          label: 'No',\n          value: '0'\n        }]\n      }]\n    });\n    const output = {};\n    await apos.schema.convert(req, schema, {\n      ageOrShoeSize: 'age',\n      doWeCare: '0',\n      age: ''\n    }, output);\n    assert(output.ageOrShoeSize === 'age');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"enforces required property for recursively shown field","suites":["Schemas"],"updatePoint":{"line":1491,"column":60,"index":41822},"line":1491,"code":"  it('enforces required property for recursively shown field', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }],\n        if: {\n          doWeCare: '1'\n        }\n      }, {\n        name: 'doWeCare',\n        type: 'select',\n        choices: [{\n          label: 'Yes',\n          value: '1'\n        }, {\n          label: 'No',\n          value: '0'\n        }]\n      }]\n    });\n    await testSchemaError(schema, {\n      ageOrShoeSize: 'age',\n      doWeCare: '1',\n      age: ''\n    }, 'age', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"ignores required property for recursively hidden field with boolean","suites":["Schemas"],"updatePoint":{"line":1538,"column":73,"index":42857},"line":1538,"code":"  it('ignores required property for recursively hidden field with boolean', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }],\n        if: {\n          doWeCare: true\n        }\n      }, {\n        name: 'doWeCare',\n        type: 'boolean',\n        choices: [{\n          value: true\n        }, {\n          value: false\n        }]\n      }]\n    });\n    const output = {};\n    await apos.schema.convert(req, schema, {\n      ageOrShoeSize: 'age',\n      doWeCare: false,\n      age: ''\n    }, output);\n    assert(output.ageOrShoeSize === 'age');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"enforces required property for recursively shown field with boolean","suites":["Schemas"],"updatePoint":{"line":1586,"column":73,"index":43953},"line":1586,"code":"  it('enforces required property for recursively shown field with boolean', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          ageOrShoeSize: 'age'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false,\n        if: {\n          ageOrShoeSize: 'shoeSize'\n        }\n      }, {\n        name: 'ageOrShoeSize',\n        type: 'select',\n        choices: [{\n          label: 'age',\n          value: 'age'\n        }, {\n          label: 'shoeSize',\n          value: 'shoeSize'\n        }],\n        if: {\n          doWeCare: true\n        }\n      }, {\n        name: 'doWeCare',\n        type: 'boolean'\n      }]\n    });\n    await testSchemaError(schema, {\n      ageOrShoeSize: 'age',\n      doWeCare: true,\n      age: null\n    }, 'age', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should ignore required property when external condition does not match","suites":["Schemas"],"updatePoint":{"line":1626,"column":76,"index":44862},"line":1626,"code":"  it('should ignore required property when external condition does not match', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          'external-condition:externalCondition()': 'no'\n        }\n      }, {\n        name: 'shoeSize',\n        type: 'integer',\n        required: false\n      }]\n    });\n    const output = {};\n    await apos.schema.convert(req, schema, {\n      shoeSize: 20\n    }, output);\n    assert(output.shoeSize === 20);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should enforce required property when external condition matches","suites":["Schemas"],"updatePoint":{"line":1648,"column":70,"index":45451},"line":1648,"code":"  it('should enforce required property when external condition matches', async function () {\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'age',\n        type: 'integer',\n        required: true,\n        if: {\n          'external-condition:externalCondition()': 'yes'\n        }\n      }]\n    });\n    await testSchemaError(schema, {}, 'age', 'required');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should use the field module name by default when the external condition key does not contain it","suites":["Schemas"],"updatePoint":{"line":1661,"column":101,"index":45869},"line":1661,"code":"  it('should use the field module name by default when the external condition key does not contain it', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'externalCondition()';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    const result = await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    assert(result === 'yes');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should pass req and the doc ID to the external condition method","suites":["Schemas"],"updatePoint":{"line":1670,"column":69,"index":46306},"line":1670,"code":"  it('should pass req and the doc ID to the external condition method', async function () {\n    const someReqAttr = 'some-attribute-on-req';\n    const req = apos.task.getReq({\n      someReqAttr\n    });\n    const conditionKey = 'external-condition:externalCondition2()';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    const result = await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    assert(result === `yes - ${someReqAttr} - ${docId}`);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should warn when an argument is passed in the external condition key","suites":["Schemas"],"updatePoint":{"line":1682,"column":74,"index":46870},"line":1682,"code":"  it('should warn when an argument is passed in the external condition key', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'external-condition:externalCondition(letsNotArgue)';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    const result = await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    assert(warnMessages.pop() === 'The method \"external-condition:externalCondition\" defined in the \"someField\" field should be written without argument: \"external-condition:externalCondition()\".');\n    assert(result === 'yes');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should throw when the condition key does not end with parenthesis","suites":["Schemas"],"updatePoint":{"line":1692,"column":71,"index":47539},"line":1692,"code":"  it('should throw when the condition key does not end with parenthesis', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'external-condition:externalCondition';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    try {\n      await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    } catch (error) {\n      assert(error.message === 'The method \"external-condition:externalCondition\" defined in the \"someField\" field should be written with parenthesis: \"external-condition:externalCondition()\".');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should not throw when the condition key does not end with parenthesis with the optionalParenthesis parameter set to true","suites":["Schemas"],"updatePoint":{"line":1706,"column":126,"index":48298},"line":1706,"code":"  it('should not throw when the condition key does not end with parenthesis with the optionalParenthesis parameter set to true', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'external-condition:externalCondition';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    const optionalParenthesis = true;\n    const result = await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId, optionalParenthesis);\n    assert(result === 'yes');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should throw when the module defined in the external condition key is not found","suites":["Schemas"],"updatePoint":{"line":1716,"column":85,"index":48827},"line":1716,"code":"  it('should throw when the module defined in the external condition key is not found', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'unknown-module:externalCondition()';\n    const fieldName = 'someField';\n    const fieldModuleName = 'unknown-module';\n    const docId = 'some-doc-id';\n    try {\n      await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    } catch (error) {\n      assert(error.message === 'The \"unknown-module\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should throw when the method defined in the external condition key is not found","suites":["Schemas"],"updatePoint":{"line":1730,"column":85,"index":49455},"line":1730,"code":"  it('should throw when the method defined in the external condition key is not found', async function () {\n    const req = apos.task.getReq();\n    const conditionKey = 'external-condition:unknownMethod()';\n    const fieldName = 'someField';\n    const fieldModuleName = 'external-condition';\n    const docId = 'some-doc-id';\n    try {\n      await apos.schema.evaluateMethod(req, conditionKey, fieldName, fieldModuleName, docId);\n    } catch (error) {\n      assert(error.message === 'The \"unknownMethod\" method from \"external-condition\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should call the evaluate-external-condition API successfully","suites":["Schemas"],"updatePoint":{"line":1744,"column":66,"index":50100},"line":1744,"code":"  it('should call the evaluate-external-condition API successfully', async function () {\n    apos.schema.fieldsById['some-field-id'] = {\n      name: 'someField',\n      moduleName: 'external-condition'\n    };\n    const res = await apos.http.get('/api/v1/@apostrophecms/schema/evaluate-external-condition?fieldId=some-field-id&docId=some-doc-id&conditionKey=externalCondition()', {});\n    assert(res.result === 'yes');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should warn when an argument is passed in the external condition key via the evaluate-external-condition API","suites":["Schemas"],"updatePoint":{"line":1752,"column":114,"index":50571},"line":1752,"code":"  it('should warn when an argument is passed in the external condition key via the evaluate-external-condition API', async function () {\n    apos.schema.fieldsById['some-field-id'] = {\n      name: 'someField',\n      moduleName: 'external-condition'\n    };\n    const res = await apos.http.get('/api/v1/@apostrophecms/schema/evaluate-external-condition?fieldId=some-field-id&docId=some-doc-id&conditionKey=externalCondition(letsNotArgue)', {});\n    assert(warnMessages.pop() === 'The method \"externalCondition\" defined in the \"someField\" field should be written without argument: \"externalCondition()\".');\n    assert(res.result === 'yes');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should receive a clean error response when the evaluate-external-condition API call fails (module not found)","suites":["Schemas"],"updatePoint":{"line":1761,"column":114,"index":51215},"line":1761,"code":"  it('should receive a clean error response when the evaluate-external-condition API call fails (module not found)', async function () {\n    apos.schema.fieldsById['some-field-id'] = {\n      name: 'someField',\n      moduleName: 'unknown-module'\n    };\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/schema/evaluate-external-condition?fieldId=some-field-id&docId=some-doc-id&conditionKey=externalCondition()', {});\n    } catch (error) {\n      assert(error.status = 400);\n      assert(error.body.message === 'The \"unknown-module\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should receive a clean error response when the evaluate-external-condition API call fails (external method not found)","suites":["Schemas"],"updatePoint":{"line":1775,"column":123,"index":51893},"line":1775,"code":"  it('should receive a clean error response when the evaluate-external-condition API call fails (external method not found)', async function () {\n    apos.schema.fieldsById['some-field-id'] = {\n      name: 'someField',\n      moduleName: 'external-condition'\n    };\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/schema/evaluate-external-condition?fieldId=some-field-id&docId=some-doc-id&conditionKey=unknownMethod()', {});\n    } catch (error) {\n      assert(error.status = 400);\n      assert(error.body.message === 'The \"unknownMethod\" method from \"external-condition\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should call the choices API successfully, using the field module name by default when the external condition key does not contain it","suites":["Schemas"],"updatePoint":{"line":1789,"column":138,"index":52618},"line":1789,"code":"  it('should call the choices API successfully, using the field module name by default when the external condition key does not contain it', async function () {\n    apos.schema.fieldTypes.select = {\n      dynamicChoices: true\n    };\n    apos.schema.fieldsById['some-field-id'] = {\n      type: 'select',\n      name: 'someField',\n      moduleName: 'choices',\n      choices: 'getChoices'\n    };\n    const res = await apos.http.get('/api/v1/@apostrophecms/schema/choices?fieldId=some-field-id&docId=some-doc-id', {});\n    assert.deepEqual(res.choices, [{\n      label: 'One',\n      value: 'one'\n    }, {\n      label: 'Two',\n      value: 'two'\n    }, {\n      label: 'DocId',\n      value: 'some-doc-id'\n    }]);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should call the choices API successfully, using parenthesis","suites":["Schemas"],"updatePoint":{"line":1811,"column":65,"index":53256},"line":1811,"code":"  it('should call the choices API successfully, using parenthesis', async function () {\n    apos.schema.fieldTypes.select = {\n      dynamicChoices: true\n    };\n    apos.schema.fieldsById['some-field-id'] = {\n      type: 'select',\n      name: 'someField',\n      moduleName: 'choices',\n      choices: 'choices:getChoices()'\n    };\n    const res = await apos.http.get('/api/v1/@apostrophecms/schema/choices?fieldId=some-field-id&docId=some-doc-id', {});\n    assert.deepEqual(res.choices, [{\n      label: 'One',\n      value: 'one'\n    }, {\n      label: 'Two',\n      value: 'two'\n    }, {\n      label: 'DocId',\n      value: 'some-doc-id'\n    }]);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should warn when an argument is passed in the external condition key via the choices API","suites":["Schemas"],"updatePoint":{"line":1833,"column":94,"index":53933},"line":1833,"code":"  it('should warn when an argument is passed in the external condition key via the choices API', async function () {\n    apos.schema.fieldTypes.select = {\n      dynamicChoices: true\n    };\n    apos.schema.fieldsById['some-field-id'] = {\n      type: 'select',\n      name: 'someField',\n      moduleName: 'choices',\n      choices: 'choices:getChoices(letsNotArgue)'\n    };\n    const res = await apos.http.get('/api/v1/@apostrophecms/schema/choices?fieldId=some-field-id&docId=some-doc-id', {});\n    assert(warnMessages.pop() === 'The method \"choices:getChoices\" defined in the \"someField\" field should be written without argument: \"choices:getChoices()\".');\n    assert.deepEqual(res.choices, [{\n      label: 'One',\n      value: 'one'\n    }, {\n      label: 'Two',\n      value: 'two'\n    }, {\n      label: 'DocId',\n      value: 'some-doc-id'\n    }]);\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should receive a clean error response when the choices API call fails (module not found)","suites":["Schemas"],"updatePoint":{"line":1856,"column":94,"index":54785},"line":1856,"code":"  it('should receive a clean error response when the choices API call fails (module not found)', async function () {\n    apos.schema.fieldTypes.select = {\n      dynamicChoices: true\n    };\n    apos.schema.fieldsById['some-field-id'] = {\n      type: 'select',\n      name: 'someField',\n      moduleName: 'choices',\n      choices: 'unknown-module:getChoices()'\n    };\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/schema/choices?fieldId=some-field-id&docId=some-doc-id', {});\n    } catch (error) {\n      assert(error.status = 400);\n      assert(error.body.message === 'The \"unknown-module\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should receive a clean error response when the choices API call fails (external method not found)","suites":["Schemas"],"updatePoint":{"line":1875,"column":103,"index":55523},"line":1875,"code":"  it('should receive a clean error response when the choices API call fails (external method not found)', async function () {\n    apos.schema.fieldTypes.select = {\n      dynamicChoices: true\n    };\n    apos.schema.fieldsById['some-field-id'] = {\n      type: 'select',\n      name: 'someField',\n      moduleName: 'choices',\n      choices: 'choices:unknownMethod()'\n    };\n    try {\n      await apos.http.get('/api/v1/@apostrophecms/schema/choices?fieldId=some-field-id&docId=some-doc-id', {});\n    } catch (error) {\n      assert(error.status = 400);\n      assert(error.body.message === 'The \"unknownMethod\" method from \"choices\" module defined in the \"someField\" field does not exist.');\n      return;\n    }\n    throw new Error('should have thrown');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should save date and time with the right format","suites":["Schemas"],"updatePoint":{"line":1894,"column":53,"index":56228},"line":1894,"code":"  it('should save date and time with the right format', async function () {\n    const req = apos.task.getReq();\n    const schema = apos.schema.compose({\n      addFields: [{\n        name: 'emptyValue',\n        type: 'dateAndTime'\n      }, {\n        name: 'goodValue',\n        type: 'dateAndTime'\n      }]\n    });\n    const output = {};\n    await apos.schema.convert(req, schema, {\n      emptyValue: null,\n      goodValue: '2022-05-09T22:36:00.000Z'\n    }, output);\n    assert(output.emptyValue === null);\n    assert(output.goodValue === '2022-05-09T22:36:00.000Z');\n  });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"validate doc type","suites":["Schemas","field editPermission|viewPermission"],"updatePoint":{"line":1976,"column":25,"index":58137},"line":1976,"code":"    it('validate doc type', function () {\n      const logger = apos.util.error;\n      const options = {\n        type: 'doc type',\n        subtype: 'test'\n      };\n      const messages = [];\n      apos.util.error = message => messages.push(message);\n      apos.schema.validate(schema, options);\n      apos.util.error = logger;\n      const actual = messages;\n      const expected = ['doc type test, string field \"array.edit\":\\n\\neditPermission or viewPermission must be defined on root fields only, provided on \"array.edit\"', 'doc type test, string field \"array.view\":\\n\\neditPermission or viewPermission must be defined on root fields only, provided on \"array.view\"', 'doc type test, string field \"object.edit\":\\n\\neditPermission or viewPermission must be defined on root fields only, provided on \"object.edit\"', 'doc type test, string field \"object.view\":\\n\\neditPermission or viewPermission must be defined on root fields only, provided on \"object.view\"'];\n      assert.deepEqual(actual, expected);\n    });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"validate widget type","suites":["Schemas","field editPermission|viewPermission"],"updatePoint":{"line":1990,"column":28,"index":59148},"line":1990,"code":"    it('validate widget type', function () {\n      const logger = apos.util.error;\n      const options = {\n        type: 'widget type',\n        subtype: 'test'\n      };\n      const messages = [];\n      apos.util.error = message => messages.push(message);\n      apos.schema.validate(schema, options);\n      apos.util.error = logger;\n      const actual = messages;\n      const expected = ['widget type test, string field \"legacy\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"edit\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"view\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"array.edit\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"array.view\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"object.edit\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided', 'widget type test, string field \"object.view\":\\n\\neditPermission or viewPermission must be defined on doc-type schemas only, \"widget type\" provided'];\n      assert.deepEqual(actual, expected);\n    });","file":"schemas.js","skipped":false,"dir":"test"},{"name":"should be a property of the apos object","suites":["Search"],"updatePoint":{"line":13,"column":45,"index":300},"line":13,"code":"  it('should be a property of the apos object', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        events: {\n          extend: '@apostrophecms/piece-type',\n          options: {\n            name: 'event',\n            label: 'Event'\n          }\n        }\n      }\n    });\n    assert(apos.search);\n  });","file":"search.js","skipped":false,"dir":"test"},{"name":"should add highSearchText, highSearchWords, lowSearchText, searchSummary to all docs on insert","suites":["Search"],"updatePoint":{"line":28,"column":100,"index":697},"line":28,"code":"  it('should add highSearchText, highSearchWords, lowSearchText, searchSummary to all docs on insert', async function () {\n    const req = apos.task.getReq();\n    await apos.doc.insert(req, {\n      title: 'Testing Search Event',\n      type: 'event',\n      slug: 'search-test-event'\n    });\n    const doc = await apos.doc.find(req, {\n      slug: 'search-test-event'\n    }).toObject();\n    assert(doc.highSearchText);\n    assert(doc.highSearchWords);\n    assert(doc.lowSearchText);\n    assert(doc.searchSummary !== undefined);\n    assert(doc.highSearchText.match(/testing/));\n    assert(_.includes(doc.highSearchWords, 'testing'));\n  });","file":"search.js","skipped":false,"dir":"test"},{"name":"should exist","suites":["Soft Redirects"],"updatePoint":{"line":9,"column":18,"index":235},"line":9,"code":"  it('should exist', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              parkedId: 'child',\n              title: 'Child',\n              slug: '/child',\n              type: 'default-page'\n            }]\n          }\n        },\n        'default-page': {}\n      }\n    });\n    assert(apos.modules['@apostrophecms/soft-redirect']);\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the /child page (which also populates historicUrls)","suites":["Soft Redirects"],"updatePoint":{"line":28,"column":81,"index":752},"line":28,"code":"  it('should be able to serve the /child page (which also populates historicUrls)', async function () {\n    const body = await apos.http.get('/child');\n    // Did we get our page back?\n    assert(body.match(/Default Page Template/));\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to change the URL via db","suites":["Soft Redirects"],"updatePoint":{"line":33,"column":45,"index":956},"line":33,"code":"  it('should be able to change the URL via db', async function () {\n    return apos.doc.db.updateOne({\n      slug: '/child',\n      aposLocale: 'en:published'\n    }, {\n      $set: {\n        slug: '/child-moved'\n      }\n    });\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the page at its new URL","suites":["Soft Redirects"],"updatePoint":{"line":43,"column":53,"index":1196},"line":43,"code":"  it('should be able to serve the page at its new URL', async function () {\n    const body = await apos.http.get('/child-moved');\n    // Did we get our page back?\n    assert(body.match(/Default Page Template/));\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the page at its old URL too, via redirect","suites":["Soft Redirects"],"updatePoint":{"line":48,"column":71,"index":1432},"line":48,"code":"  it('should be able to serve the page at its old URL too, via redirect', async function () {\n    const response = await apos.http.get('/child', {\n      followRedirect: false,\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    // Is our status code good?\n    assert.strictEqual(response.status, 302);\n    // Are we going to be redirected to our page?\n    assert.strictEqual(response.headers.location, `${apos.http.getBase()}/child-moved`);\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should exist","suites":["Soft Redirects - with `statusCode` option"],"updatePoint":{"line":65,"column":18,"index":1998},"line":65,"code":"  it('should exist', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        '@apostrophecms/page': {\n          options: {\n            park: [{\n              parkedId: 'child',\n              title: 'Child',\n              slug: '/child',\n              type: 'default-page'\n            }]\n          }\n        },\n        '@apostrophecms/soft-redirect': {\n          options: {\n            statusCode: 301\n          }\n        },\n        'default-page': {}\n      }\n    });\n    assert(apos.modules['@apostrophecms/soft-redirect']);\n    assert.strictEqual(apos.modules['@apostrophecms/soft-redirect'].options.statusCode, 301);\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the /child page (which also populates historicUrls)","suites":["Soft Redirects - with `statusCode` option"],"updatePoint":{"line":90,"column":81,"index":2723},"line":90,"code":"  it('should be able to serve the /child page (which also populates historicUrls)', async function () {\n    const body = await apos.http.get('/child');\n    // Did we get our page back?\n    assert(body.match(/Default Page Template/));\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to change the URL via db","suites":["Soft Redirects - with `statusCode` option"],"updatePoint":{"line":95,"column":45,"index":2927},"line":95,"code":"  it('should be able to change the URL via db', async function () {\n    return apos.doc.db.updateOne({\n      slug: '/child',\n      aposLocale: 'en:published'\n    }, {\n      $set: {\n        slug: '/child-moved'\n      }\n    });\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the page at its new URL","suites":["Soft Redirects - with `statusCode` option"],"updatePoint":{"line":105,"column":53,"index":3167},"line":105,"code":"  it('should be able to serve the page at its new URL', async function () {\n    const body = await apos.http.get('/child-moved');\n    // Did we get our page back?\n    assert(body.match(/Default Page Template/));\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should be able to serve the page at its old URL too, via redirect","suites":["Soft Redirects - with `statusCode` option"],"updatePoint":{"line":110,"column":71,"index":3403},"line":110,"code":"  it('should be able to serve the page at its old URL too, via redirect', async function () {\n    const response = await apos.http.get('/child', {\n      fullResponse: true,\n      redirect: 'manual'\n    });\n    // Is our status code good?\n    assert.strictEqual(response.status, 301);\n    // Are we going to be redirected to our page?\n    assert.strictEqual(response.headers.location, `${apos.http.getBase()}/child-moved`);\n  });","file":"soft-redirects.js","skipped":false,"dir":"test"},{"name":"should allow a project relying on a package.json in its parent folder","suites":["Project with package.json in its parent folder works"],"updatePoint":{"line":10,"column":75,"index":295},"line":10,"code":"  it('should allow a project relying on a package.json in its parent folder', async function () {\n    let apos;\n    try {\n      apos = await t.create(require('./subdir-project/app.js'));\n      // Sniff test: a normal apos object\n      assert(apos.user);\n    } finally {\n      if (apos) {\n        await t.destroy(apos);\n      }\n    }\n    assert(apos);\n  });","file":"subdir-project.js","skipped":false,"dir":"test"},{"name":"should have a templates property","suites":["Templates"],"updatePoint":{"line":26,"column":38,"index":876},"line":26,"code":"  it('should have a templates property', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        'express-test': {},\n        'template-test': {},\n        'template-subclass-test': {},\n        'template-options-test': {},\n        'inject-test': {},\n        'with-layout-page': {\n          extend: '@apostrophecms/page-type'\n        },\n        'fragment-page': {\n          components(self) {\n            return {\n              async test(req, input) {\n                // Be very async\n                await Promise.delay(100);\n                input.afterDelay = true;\n                return input;\n              }\n            };\n          }\n        },\n        'fragment-all': {\n          components(self) {\n            return {\n              async test(req, input) {\n                // Be very async\n                await Promise.delay(100);\n                input.afterDelay = true;\n                return input;\n              }\n            };\n          }\n        }\n      }\n    });\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should be able to render a template relative to a module","suites":["Templates"],"updatePoint":{"line":65,"column":62,"index":1923},"line":65,"code":"  it('should be able to render a template relative to a module', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].render(req, 'test', {\n      age: 50\n    });\n    assert(result === '<h1>50</h1>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should respect templateData at module level","suites":["Templates"],"updatePoint":{"line":72,"column":49,"index":2180},"line":72,"code":"  it('should respect templateData at module level', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].render(req, 'test');\n    assert(result === '<h1>30</h1>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should respect template overrides","suites":["Templates"],"updatePoint":{"line":77,"column":39,"index":2404},"line":77,"code":"  it('should respect template overrides', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-subclass-test'].render(req, 'override-test');\n    assert(result === '<h1>I am overridden</h1>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should inherit in the absence of overrides","suites":["Templates"],"updatePoint":{"line":82,"column":48,"index":2668},"line":82,"code":"  it('should inherit in the absence of overrides', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-subclass-test'].render(req, 'inherit-test');\n    assert(result === '<h1>I am inherited</h1>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should be able to see the options of the module via module.options","suites":["Templates"],"updatePoint":{"line":87,"column":72,"index":2954},"line":87,"code":"  it('should be able to see the options of the module via module.options', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-options-test'].render(req, 'options-test');\n    assert(result.match(/nifty/));\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should be able to call helpers on the modules object","suites":["Templates"],"updatePoint":{"line":92,"column":58,"index":3208},"line":92,"code":"  it('should be able to call helpers on the modules object', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-options-test'].render(req, 'options-test');\n    assert(result.match(/4/));\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render pages successfully with outerLayout, with core data-apos attribute","suites":["Templates"],"updatePoint":{"line":97,"column":86,"index":3486},"line":97,"code":"  it('should render pages successfully with outerLayout, with core data-apos attribute', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].renderPage(req, 'page');\n    const $ = cheerio.load(result);\n    const $body = $('body');\n    assert($body.length);\n    const aposData = JSON.parse($body.attr('data-apos'));\n    assert(aposData);\n    assert(aposData.shortName);\n    assert(aposData.csrfCookieName);\n    assert(!aposData.modules['@apostrophecms/admin-bar']);\n    assert(result.indexOf('<title>I am the title</title>') !== -1);\n    assert(result.indexOf('<h2>I am the main content</h2>') !== -1);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render pages successfully with outerLayout for admin user, with expanded data-apos attribute","suites":["Templates"],"updatePoint":{"line":111,"column":105,"index":4176},"line":111,"code":"  it('should render pages successfully with outerLayout for admin user, with expanded data-apos attribute', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['template-test'].renderPage(req, 'page');\n    const $ = cheerio.load(result);\n    const $body = $('body');\n    assert($body.length);\n    const aposData = JSON.parse($body.attr('data-apos'));\n    assert(aposData);\n    assert(aposData.shortName);\n    assert(aposData.modules['@apostrophecms/admin-bar'].items.length);\n    assert(result.indexOf('<title>I am the title</title>') !== -1);\n    assert(result.indexOf('<h2>I am the main content</h2>') !== -1);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"cross-module-included files should be able to include/extend other files relative to their own module","suites":["Templates"],"updatePoint":{"line":124,"column":107,"index":4839},"line":124,"code":"  it('cross-module-included files should be able to include/extend other files relative to their own module', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].renderPage(req, 'pageWithLayout');\n    assert(result.indexOf('<title>I am the title</title>') !== -1);\n    assert(result.indexOf('<h2>I am the inner content</h2>') !== -1);\n    assert(result.indexOf('<h3>I am in the layout</h3>') !== -1);\n    assert(result.indexOf('<p>I am included</p>') !== -1);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render pages successfully with prepend and append to locations","suites":["Templates"],"updatePoint":{"line":132,"column":75,"index":5336},"line":132,"code":"  it('should render pages successfully with prepend and append to locations', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['with-layout-page'].renderPage(req, 'page');\n    const titleIndex = result.indexOf('<title>');\n    const beforeTestIndex = result.indexOf('<meta name=\"prepend-head-test\" />');\n    const afterTestIndex = result.indexOf('<meta name=\"append-head-test\" />');\n    const bodyIndex = result.indexOf('<body');\n    const appendBody = result.indexOf('<h4>append-body-test</h4>');\n    assert(titleIndex !== -1);\n    assert(beforeTestIndex !== -1);\n    assert(afterTestIndex !== -1);\n    assert(bodyIndex !== -1);\n    assert(appendBody !== -1);\n    assert(beforeTestIndex < titleIndex);\n    assert(afterTestIndex > titleIndex);\n    assert(afterTestIndex < bodyIndex);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should not escape <br /> generated by the nlbr filter, but should escape tags in its input","suites":["Templates"],"updatePoint":{"line":149,"column":96,"index":6191},"line":149,"code":"  it('should not escape <br /> generated by the nlbr filter, but should escape tags in its input', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].render(req, 'testWithNlbrFilter');\n    assert.strictEqual(result, '<p>first line<br />\\nsecond line<br />\\n&lt;a href=&#34;javascript:alert(\\'oh no\\')&#34;&gt;CSRF attempt&lt;/a&gt;</p>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should not escape <br /> generated by the nlp filter, but should escape tags in its input","suites":["Templates"],"updatePoint":{"line":154,"column":95,"index":6601},"line":154,"code":"  it('should not escape <br /> generated by the nlp filter, but should escape tags in its input', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].render(req, 'testWithNlpFilter');\n    assert.strictEqual(result, '<p>first line</p>\\n<p>second line</p>\\n<p>&lt;a href=&#34;javascript:alert(\\'oh no\\')&#34;&gt;CSRF attempt&lt;/a&gt;</p>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should not escape <br /> generated by the nlbr filter or markup in the test input","suites":["Templates"],"updatePoint":{"line":159,"column":87,"index":7004},"line":159,"code":"  it('should not escape <br /> generated by the nlbr filter or markup in the test input', async function () {\n    const req = apos.task.getAnonReq();\n    const result = await apos.modules['template-test'].render(req, 'testWithNlbrFilterSafe');\n    assert.strictEqual(result, '<p>first line<br />\\nsecond line<br />\\n<a href=\"http://niceurl.com\">This is okay</a></p>\\n');\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render fragments containing async components correctly","suites":["Templates"],"updatePoint":{"line":164,"column":67,"index":7361},"line":164,"code":"  it('should render fragments containing async components correctly', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-page'].renderPage(req, 'page');\n    const aboveFragment = result.indexOf('Above Fragment');\n    const beforeComponent = result.indexOf('Before Component');\n    const componentText = result.indexOf('Component Text');\n    const afterDelay = result.indexOf('After Delay');\n    const afterComponent = result.indexOf('After Component');\n    const belowFragment = result.indexOf('Below Fragment');\n    assert(aboveFragment !== -1);\n    assert(beforeComponent !== -1);\n    assert(componentText !== -1);\n    assert(afterDelay !== -1);\n    assert(afterComponent !== -1);\n    assert(belowFragment !== -1);\n    assert(aboveFragment < beforeComponent);\n    assert(beforeComponent < componentText);\n    assert(componentText < afterDelay);\n    assert(afterDelay < afterComponent);\n    assert(afterComponent < belowFragment);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render fragment without passing any keyword arguments","suites":["Templates"],"updatePoint":{"line":185,"column":66,"index":8351},"line":185,"code":"  it('should render fragment without passing any keyword arguments', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'test1');\n    assert.deepStrictEqual(data, ['pos1', 'pos2', 'kw1_default', 'kw2_default', 'kw3_default']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should support keyword arguments and render macros and fragments from other fragments","suites":["Templates"],"updatePoint":{"line":191,"column":91,"index":8730},"line":191,"code":"  it('should support keyword arguments and render macros and fragments from other fragments', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'test2');\n    assert.deepStrictEqual(data, ['Above Fragment', 'pos1', 'pos2', 'pos3', 'kw1_default', 'kw2', 'kw3_default', 'Below Fragment']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should render rendercall blocks","suites":["Templates"],"updatePoint":{"line":197,"column":37,"index":9091},"line":197,"code":"  it('should render rendercall blocks', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'test3');\n    assert.deepStrictEqual(data, ['Above Call Fragment', 'pos1', 'pos2', 'pos3', 'Start Call Body', 'Text is called', 'After Delay', 'End Call Body', 'kw1_default', 'kw2', 'kw3_default', 'Below Call Fragment']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should skip positional arguments when there is keyword arguments (1)","suites":["Templates"],"updatePoint":{"line":203,"column":74,"index":9568},"line":203,"code":"  it('should skip positional arguments when there is keyword arguments (1)', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'issue_3056_1');\n    assert.deepStrictEqual(data, ['val_1', 'val_', 'val_9', 'val_4']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should skip positional arguments when there is keyword arguments (2)","suites":["Templates"],"updatePoint":{"line":209,"column":74,"index":9911},"line":209,"code":"  it('should skip positional arguments when there is keyword arguments (2)', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'issue_3056_2');\n    assert.deepStrictEqual(data, ['val_1', 'val_', 'val_9', 'val_4']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should filter out unknown keyword arguments","suites":["Templates"],"updatePoint":{"line":215,"column":49,"index":10229},"line":215,"code":"  it('should filter out unknown keyword arguments', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'page');\n    const data = parseOutput(result, 'issue_3102');\n    assert.deepStrictEqual(data, ['val_', 'val_1', 'val_2', 'val_']);\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should support apos helpers and localization in fragments","suites":["Templates"],"updatePoint":{"line":221,"column":63,"index":10558},"line":221,"code":"  it('should support apos helpers and localization in fragments', async function () {\n    const req = apos.task.getReq();\n    const result = await apos.modules['fragment-all'].renderPage(req, 'aux-test');\n    assert(result.includes('gee-whiz'));\n    assert(result.includes('Modify / Delete'));\n  });","file":"templates.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Urls"],"updatePoint":{"line":11,"column":37,"index":288},"line":11,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.url);\n  });","file":"urls.js","skipped":false,"dir":"test"},{"name":"returns a URL unmodified","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":22,"column":34,"index":593},"line":22,"code":"      it('returns a URL unmodified', function () {\n        start = new Date().getTime();\n        assert(apos.url.build('/events') === '/events');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"returns the URL \"#\" unmodified","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":26,"column":40,"index":755},"line":26,"code":"      it('returns the URL \"#\" unmodified', function () {\n        try {\n          assert(apos.url.build('#') === '#');\n        } catch (e) {\n          console.error(e.stack);\n        }\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"adds a single parameter to a queryless URL","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":33,"column":52,"index":961},"line":33,"code":"      it('adds a single parameter to a queryless URL', function () {\n        assert(apos.url.build('/events', {\n          tag: 'blue'\n        }) === '/events?tag=blue');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"appends a parameter to a URL with a query","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":38,"column":51,"index":1140},"line":38,"code":"      it('appends a parameter to a URL with a query', function () {\n        // Neither of these is wrong\n        const options = ['/events?tag=blue&page=5', '/events?page=5&tag=blue'];\n        assert(_.includes(options, apos.url.build('/events?page=5', {\n          tag: 'blue'\n        })));\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"replaces parameters in the URL","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":45,"column":40,"index":1430},"line":45,"code":"      it('replaces parameters in the URL', function () {\n        assert(apos.url.build('/events?tag=blue', {\n          tag: 'red'\n        }) === '/events?tag=red');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"removes parameters","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":50,"column":28,"index":1593},"line":50,"code":"      it('removes parameters', function () {\n        assert(apos.url.build('/events?tag=blue', {\n          tag: null\n        }) === '/events');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"correctly allows the last data object to win","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":55,"column":54,"index":1773},"line":55,"code":"      it('correctly allows the last data object to win', function () {\n        assert(apos.url.build('/events', {\n          tag: 'red'\n        }, {\n          tag: 'blue'\n        }) === '/events?tag=blue');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"places path properties in the path","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":62,"column":44,"index":1979},"line":62,"code":"      it('places path properties in the path', function () {\n        assert(apos.url.build('/events', ['year', 'month'], {\n          year: '2013',\n          month: '05',\n          tag: 'red'\n        }) === '/events/2013/05?tag=red');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"switches to placing path properties in the query if it encounters a non-slugify-compliant property","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":69,"column":108,"index":2287},"line":69,"code":"      it('switches to placing path properties in the query if it encounters a non-slugify-compliant property', function () {\n        assert(apos.url.build('/events', ['year', 'month'], {\n          year: '2013!@#@',\n          month: '05',\n          tag: 'red'\n        }) === '/events?year=2013%21%40%23%40&month=05&tag=red');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"does the right thing for a case that crashed once","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":76,"column":59,"index":2573},"line":76,"code":"      it('does the right thing for a case that crashed once', function () {\n        assert(apos.url.build('/events', ['year', 'month'], {}, {}) === '/events');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"correctly allows the last data object to win for a path property","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":79,"column":74,"index":2758},"line":79,"code":"      it('correctly allows the last data object to win for a path property', function () {\n        assert(apos.url.build('/events', ['year', 'month'], {\n          year: '2013',\n          month: '01',\n          tag: 'dance'\n        }, {\n          year: 2012,\n          month: '12'\n        }) === '/events/2012/12?tag=dance');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"DR use case #1","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":89,"column":24,"index":3043},"line":89,"code":"      it('DR use case #1', function () {\n        assert(apos.url.build('/events', ['year', 'month'], {\n          year: '2013',\n          month: '05',\n          tag: 'dance'\n        }, {\n          tag: 'tour'\n        }) === '/events/2013/05?tag=tour');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"DR use case #2","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":98,"column":24,"index":3305},"line":98,"code":"      it('DR use case #2', function () {\n        const result = apos.url.build('/events', ['year', 'month'], {\n          year: '2013',\n          month: '05',\n          tag: 'dance'\n        }, {\n          page: '2'\n        });\n        assert(result === '/events/2013/05?tag=dance&page=2');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"DR use case #3","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":108,"column":24,"index":3604},"line":108,"code":"      it('DR use case #3', function () {\n        const result = apos.url.build('/events', ['year', 'month'], {\n          year: '2013',\n          month: '05',\n          tag: 'dance'\n        }, {});\n        assert(result === '/events/2013/05?tag=dance');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"IH use case #1: later objects can prevent path properties from being added","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":116,"column":84,"index":3927},"line":116,"code":"      it('IH use case #1: later objects can prevent path properties from being added', function () {\n        const result = apos.url.build('/calendar', ['year', 'month'], {\n          year: '2014',\n          month: '01',\n          tag: undefined\n        }, {\n          year: null,\n          month: null\n        });\n        assert(result === '/calendar');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Preserves hashes","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":127,"column":26,"index":4233},"line":127,"code":"      it('Preserves hashes', function () {\n        const result = apos.url.build('/calendar#skipdown', ['year', 'month'], {\n          year: '2014',\n          month: '01',\n          tag: 'blue'\n        });\n        assert(result === '/calendar/2014/01?tag=blue#skipdown');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Adds an array when $addToSet is used","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":135,"column":46,"index":4534},"line":135,"code":"      it('Adds an array when $addToSet is used', function () {\n        const result = apos.url.build('/events', {\n          colors: {\n            $addToSet: 'blue'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=blue');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Adds to existing query string array when $addToSet is used","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":143,"column":68,"index":4811},"line":143,"code":"      it('Adds to existing query string array when $addToSet is used', function () {\n        const result = apos.url.build('/events?colors[]=purple&colors[]=red', {\n          colors: {\n            $addToSet: 'blue'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=purple&colors%5B1%5D=red&colors%5B2%5D=blue');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Adds to existing URI encoded query string array when $addToSet is used","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":151,"column":80,"index":5168},"line":151,"code":"      it('Adds to existing URI encoded query string array when $addToSet is used', function () {\n        const result = apos.url.build('/events?colors%5B0%5D=purple&colors%5B1%5D=red&colors%5B2%5D=blue', {\n          colors: {\n            $addToSet: 'green'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=purple&colors%5B1%5D=red&colors%5B2%5D=blue&colors%5B3%5D=green');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Does not create duplicates when $addToSet is used","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":159,"column":59,"index":5554},"line":159,"code":"      it('Does not create duplicates when $addToSet is used', function () {\n        const result = apos.url.build('/events?colors%5B0%5D=purple&colors%5B1%5D=red&colors%5B2%5D=blue', {\n          colors: {\n            $addToSet: 'blue'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=purple&colors%5B1%5D=red&colors%5B2%5D=blue');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Treats numbers and strings the same when preventing duplicates","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":167,"column":72,"index":5932},"line":167,"code":"      it('Treats numbers and strings the same when preventing duplicates', function () {\n        const result = apos.url.build('/events?colors[]=4&colors[]=5', {\n          colors: {\n            $addToSet: 5\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=4&colors%5B1%5D=5');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Removes from existing query string array when $pull is used","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":175,"column":69,"index":6240},"line":175,"code":"      it('Removes from existing query string array when $pull is used', function () {\n        const result = apos.url.build('/events?colors[]=purple&colors[]=red', {\n          colors: {\n            $pull: 'red'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=purple');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Removes array entirely when $pull removes last item","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":183,"column":61,"index":6536},"line":183,"code":"      it('Removes array entirely when $pull removes last item', function () {\n        const result = apos.url.build('/events?colors[]=purple', {\n          colors: {\n            $pull: 'purple'\n          }\n        });\n        assert(result === '/events');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Behaves reasonably when a nonexistent item is removed","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":191,"column":63,"index":6803},"line":191,"code":"      it('Behaves reasonably when a nonexistent item is removed', function () {\n        const result = apos.url.build('/events?colors[]=purple', {\n          colors: {\n            $pull: 'blue'\n          }\n        });\n        assert(result === '/events?colors%5B0%5D=purple');\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"Takes less than 250 msec to run these tests","suites":["Urls","methods","test apos.url.build"],"updatePoint":{"line":199,"column":53,"index":7079},"line":199,"code":"      it('Takes less than 250 msec to run these tests', function () {\n        const end = new Date().getTime();\n        assert(end - start < 250);\n      });","file":"urls.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Users"],"updatePoint":{"line":13,"column":23,"index":278},"line":13,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module\n    });\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to insert a new user with an admin req","suites":["Users"],"updatePoint":{"line":20,"column":59,"index":453},"line":20,"code":"  it('should be able to insert a new user with an admin req', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'Jane Doe';\n    user.username = 'JaneD';\n    user.password = '123password';\n    user.email = 'jane@aol.com';\n    user.role = 'admin';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    await apos.user.insert(apos.task.getAdminReq(), user);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should not be able to insert a new user with any non-admin req or role","suites":["Users"],"updatePoint":{"line":33,"column":76,"index":942},"line":33,"code":"  it('should not be able to insert a new user with any non-admin req or role', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'Jim Fake';\n    user.username = 'JimF';\n    user.password = '123fakeguy';\n    user.email = 'jim@fakeohno.coim';\n    user.role = 'admin';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    const getReqMethods = [apos.task.getAnonReq, apos.task.getGuestReq, apos.task.getContributorReq, apos.task.getEditorReq];\n    let caught = 0;\n    for (const getReqMethod of getReqMethods) {\n      const req = getReqMethod();\n      try {\n        await apos.user.insert(req, user);\n      } catch (e) {\n        assert(e.name === 'forbidden');\n        caught++;\n      }\n    }\n    assert(caught === getReqMethods.length);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to retrieve a user by their username","suites":["Users"],"updatePoint":{"line":69,"column":57,"index":2210},"line":69,"code":"  it('should be able to retrieve a user by their username', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    assert(user && user.username === 'JaneD');\n    janeId = user._id;\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should verify a user password","suites":["Users"],"updatePoint":{"line":76,"column":35,"index":2447},"line":76,"code":"  it('should verify a user password', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    assert(user && user.username === 'JaneD');\n    await apos.user.verifyPassword(user, '123password');\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should not verify an incorrect user password","suites":["Users"],"updatePoint":{"line":83,"column":50,"index":2733},"line":83,"code":"  it('should not verify an incorrect user password', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    try {\n      await apos.user.verifyPassword(user, '321password');\n      // Getting this far is bad, the password is intentionally wrong\n      assert(false);\n    } catch (e) {\n      assert(e);\n    }\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should verify a user password created with former credential package","suites":["Users"],"updatePoint":{"line":95,"column":74,"index":3140},"line":95,"code":"  it('should verify a user password created with former credential package', async function () {\n    const req = apos.task.getReq();\n    const user = apos.user.newInstance();\n    user.title = 'Old User';\n    user.username = 'olduser';\n    user.password = 'passwordThatWentThroughOldCredentialPackageHashing';\n    user.email = 'old@user.com';\n    user.role = 'admin';\n    await apos.user.insert(req, user);\n\n    // A password hash that were generated by the former credential package:\n    const oldPasswordHashSimulated = '{\"hash\":\"/1GntJjtkMY1iPmQY1gn9f3bOZ5tb2qFL+x4qsDerZq2JL8+12TERR4/xqh246wBb+QJwwIRsF/6E+eccshsLxT/\",\"salt\":\"GJHukLNaG6xDgdIpxVOpqV7xQLQM7e5xnhDW7oaUOe7mTicr7Ca76M4uUJalN/cQ68CE9O7yXZ5WJOz4RN/udcX0\",\"keyLength\":66,\"hashMethod\":\"pbkdf2\",\"iterations\":2853053}';\n    await apos.user.safe.update({\n      username: 'olduser'\n    }, {\n      $set: {\n        passwordHash: oldPasswordHashSimulated\n      }\n    });\n    await apos.user.verifyPassword(user, 'passwordThatWentThroughOldCredentialPackageHashing');\n    await apos.user.safe.remove({\n      username: 'olduser'\n    });\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should not be able to insert a new user if their email already exists","suites":["Users"],"updatePoint":{"line":119,"column":75,"index":4237},"line":119,"code":"  it('should not be able to insert a new user if their email already exists', async function () {\n    assert(apos.user.newInstance);\n    const user = apos.user.newInstance();\n    assert(user);\n    user.title = 'Dane Joe';\n    user.username = 'DaneJ';\n    user.password = '321password';\n    user.email = 'jane@aol.com';\n    user.role = 'admin';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    try {\n      await apos.user.insert(apos.task.getReq(), user);\n      assert(false);\n    } catch (e) {\n      assert(true);\n    }\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to move a user to the archive","suites":["Users"],"updatePoint":{"line":137,"column":50,"index":4772},"line":137,"code":"  it('should be able to move a user to the archive', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      _id: janeId\n    }).toObject();\n    user.archived = true;\n    await apos.user.update(apos.task.getReq(), user);\n    const doc = await apos.doc.db.findOne({\n      _id: user._id,\n      archived: true\n    });\n    assert(doc);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to insert a user with a previously used email if the other is in the archive","suites":["Users"],"updatePoint":{"line":149,"column":97,"index":5186},"line":149,"code":"  it('should be able to insert a user with a previously used email if the other is in the archive', async function () {\n    const user = apos.user.newInstance();\n    user.title = 'Dane Joe';\n    user.username = 'DaneJ';\n    user.password = '321password';\n    user.email = 'jane@aol.com';\n    user.role = 'admin';\n    await apos.user.insert(apos.task.getReq(), user);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to rescue the first user from the archive and the username should revert, but the email should not because it is in use by a newer account","suites":["Users"],"updatePoint":{"line":158,"column":159,"index":5621},"line":158,"code":"  it('should be able to rescue the first user from the archive and the username should revert, but the email should not because it is in use by a newer account', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      _id: janeId\n    }).archived(true).toObject();\n    user.archived = false;\n    await apos.user.update(apos.task.getReq(), user);\n    const doc = await apos.doc.db.findOne({\n      _id: user._id,\n      archived: {\n        $ne: true\n      }\n    });\n    assert(doc);\n    assert(doc.username === 'JaneD');\n    assert(doc.email.match(/deduplicate.*jane/));\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"there should be two users in the safe at this point and neither with a null username","suites":["Users"],"updatePoint":{"line":174,"column":90,"index":6155},"line":174,"code":"  it('there should be two users in the safe at this point and neither with a null username', async function () {\n    const docs = await apos.user.safe.find({}).toArray();\n    assert(docs.length === 2);\n    for (const doc of docs) {\n      assert(doc.username);\n    }\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to move a user to the archive (2)","suites":["Users"],"updatePoint":{"line":181,"column":54,"index":6391},"line":181,"code":"  it('should be able to move a user to the archive (2)', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      _id: janeId\n    }).toObject();\n    user.archived = true;\n    await apos.user.update(apos.task.getReq(), user);\n    const doc = await apos.doc.db.findOne({\n      _id: user._id,\n      archived: true\n    });\n    assert(doc);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to insert a user with a previously used username if the other is in the archive","suites":["Users"],"updatePoint":{"line":193,"column":100,"index":6808},"line":193,"code":"  it('should be able to insert a user with a previously used username if the other is in the archive', async function () {\n    const user = apos.user.newInstance();\n    user.title = 'Dane Joe';\n    user.username = 'JaneD';\n    user.password = '321password';\n    user.email = 'somethingelse@aol.com';\n    user.role = 'admin';\n    await apos.user.insert(apos.task.getReq(), user);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to rescue the first user from the archive and the email and username should be deduplicated","suites":["Users"],"updatePoint":{"line":202,"column":112,"index":7205},"line":202,"code":"  it('should be able to rescue the first user from the archive and the email and username should be deduplicated', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      _id: janeId\n    }).archived(true).toObject();\n    user.archived = false;\n    await apos.user.update(apos.task.getReq(), user);\n    const doc = await apos.doc.db.findOne({\n      _id: user._id,\n      archived: {\n        $ne: true\n      }\n    });\n    assert(doc);\n    assert(doc.username.match(/deduplicate.*JaneD/));\n    assert(doc.email.match(/deduplicate.*jane/));\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"there should be three users in the safe at this point and none with a null username","suites":["Users"],"updatePoint":{"line":218,"column":89,"index":7754},"line":218,"code":"  it('there should be three users in the safe at this point and none with a null username', async function () {\n    const docs = await apos.user.safe.find({}).toArray();\n    assert(docs.length === 3);\n    for (const doc of docs) {\n      assert(doc.username);\n    }\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should succeed in updating a user's property","suites":["Users"],"updatePoint":{"line":225,"column":51,"index":7987},"line":225,"code":"  it('should succeed in updating a user\\'s property', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    assert(user);\n    assert(user.username === 'JaneD');\n    user.title = 'Jill Doe';\n    await apos.user.update(apos.task.getReq(), user);\n    const user2 = await apos.user.find(apos.task.getReq(), {\n      _id: user._id\n    }).toObject();\n    assert(user2);\n    assert(user2.title === 'Jill Doe');\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should verify a user password after their info has been updated","suites":["Users"],"updatePoint":{"line":239,"column":69,"index":8487},"line":239,"code":"  it('should verify a user password after their info has been updated', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    assert(user);\n    assert(user.username === 'JaneD');\n    await apos.user.verifyPassword(user, '321password');\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should change an existing user password and verify the new password","suites":["Users"],"updatePoint":{"line":249,"column":73,"index":8875},"line":249,"code":"  it('should change an existing user password and verify the new password', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    assert(user);\n    assert(user.username === 'JaneD');\n    assert(!user.password);\n    user.password = 'password123';\n    await apos.user.update(apos.task.getReq(), user);\n    const user2 = await apos.user.find(apos.task.getReq(), {\n      username: 'JaneD'\n    }).toObject();\n    await apos.user.verifyPassword(user2, 'password123');\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should be able to insert a user with no password (but see next test...)","suites":["Users"],"updatePoint":{"line":263,"column":77,"index":9420},"line":263,"code":"  it('should be able to insert a user with no password (but see next test...)', async function () {\n    const user = apos.user.newInstance();\n    user.title = 'Oops No Password';\n    user.username = 'oopsnopassword';\n    user.email = 'oopsnopassword@example.com';\n    user.role = 'admin';\n    assert(user.type === '@apostrophecms/user');\n    assert(apos.user.insert);\n    await apos.user.insert(apos.task.getAdminReq(), user);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should not be able to verify a blank password because a random password was set for us","suites":["Users"],"updatePoint":{"line":273,"column":92,"index":9868},"line":273,"code":"  it('should not be able to verify a blank password because a random password was set for us', async function () {\n    const user = await apos.user.find(apos.task.getReq(), {\n      username: 'oopsnopassword'\n    }).toObject();\n    assert(user && user.username === 'oopsnopassword');\n    let good = false;\n    try {\n      // We want this to fail\n      await apos.user.verifyPassword(user, '');\n    } catch (e) {\n      good = true;\n    }\n    assert(good);\n  });","file":"users.js","skipped":false,"dir":"test"},{"name":"should exist on the apos object","suites":["Utils"],"updatePoint":{"line":10,"column":37,"index":270},"line":10,"code":"  it('should exist on the apos object', async function () {\n    apos = await t.create({\n      root: module\n    });\n    assert(apos.util);\n  });","file":"utils.js","skipped":false,"dir":"test"},{"name":"generateId: should return a string of an number","suites":["Utils","methods"],"updatePoint":{"line":20,"column":55,"index":547},"line":20,"code":"    it('generateId: should return a string of an number', function (done) {\n      const id = apos.util.generateId();\n      assert(typeof id === 'string');\n      assert(typeof parseInt(id) === 'number');\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"globalReplace: should replace multiple instances of a string","suites":["Utils","methods"],"updatePoint":{"line":26,"column":68,"index":792},"line":26,"code":"    it('globalReplace: should replace multiple instances of a string', function (done) {\n      const s = apos.util.globalReplace('apostrophe is for cool kids. therefore apostrophe is cool.', 'apostrophe', 'comma');\n      assert(s.indexOf('apostrophe') < 0);\n      assert(s.split('comma').length === 3);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"truncatePlaintext: should tuncate a message without cutting off a word","suites":["Utils","methods"],"updatePoint":{"line":32,"column":78,"index":1134},"line":32,"code":"    it('truncatePlaintext: should tuncate a message without cutting off a word', function (done) {\n      const s = apos.util.truncatePlaintext('I want to be cut off here. This is an extra sentance.', 25);\n      assert(s.indexOf('here') > 0);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"escapeHtml: should replace html tags with html string entites","suites":["Utils","methods"],"updatePoint":{"line":37,"column":69,"index":1396},"line":37,"code":"    it('escapeHtml: should replace html tags with html string entites', function (done) {\n      const s = apos.util.escapeHtml('<div>hello</div>');\n      assert(s.indexOf('<') < 0 && s.indexOf('&lt;') >= 0);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"htmlToPlaintext: should strip all html notation","suites":["Utils","methods"],"updatePoint":{"line":42,"column":55,"index":1619},"line":42,"code":"    it('htmlToPlaintext: should strip all html notation', function (done) {\n      const s = apos.util.htmlToPlaintext('<div>hello</div>');\n      assert(s.indexOf('<') < 0 && s.indexOf('hello') >= 0);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"capitalizeFirst: should capitalize the first letter","suites":["Utils","methods"],"updatePoint":{"line":47,"column":59,"index":1852},"line":47,"code":"    it('capitalizeFirst: should capitalize the first letter', function (done) {\n      const s = apos.util.capitalizeFirst('hello');\n      assert(s.indexOf('hello') < 0 && s.indexOf('H' === 0));\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"cssName: should covert camelCase or underscore name formats to hyphenated css-style","suites":["Utils","methods"],"updatePoint":{"line":52,"column":91,"index":2107},"line":52,"code":"    it('cssName: should covert camelCase or underscore name formats to hyphenated css-style', function (done) {\n      const s = apos.util.cssName('camelCase and under_score');\n      assert(s.indexOf('C') < 0 && s.indexOf('_') < 0);\n      assert(s.indexOf('camel-case') >= 0);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"cssName: should preserve double dash","suites":["Utils","methods"],"updatePoint":{"line":58,"column":44,"index":2365},"line":58,"code":"    it('cssName: should preserve double dash', function () {\n      const s = apos.util.cssName('this-is--doubled');\n      assert(s === 'this-is--doubled');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"cssName: should not preserve triple dash","suites":["Utils","methods"],"updatePoint":{"line":62,"column":48,"index":2533},"line":62,"code":"    it('cssName: should not preserve triple dash', function () {\n      const s = apos.util.cssName('this-is---tripled');\n      assert(s === 'this-is--tripled');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"camelName: should convert non digits or ASII characters to a capitalized version of the next character","suites":["Utils","methods"],"updatePoint":{"line":66,"column":110,"index":2764},"line":66,"code":"    it('camelName: should convert non digits or ASII characters to a capitalized version of the next character', function (done) {\n      const s = apos.util.camelName('hello apostrophe');\n      assert(s.indexOf(' ') < 0 && s.indexOf('A') === 5);\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"addSlashIfNeeded: should add a slash \"/\" to the end of a path if necessary","suites":["Utils","methods"],"updatePoint":{"line":71,"column":82,"index":3011},"line":71,"code":"    it('addSlashIfNeeded: should add a slash \"/\" to the end of a path if necessary', function (done) {\n      const s = apos.util.addSlashIfNeeded('/my/path');\n      assert(s === '/my/path/');\n      return done();\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"clonePermanent: should discard properties beginning with _ other than _id","suites":["Utils","methods"],"updatePoint":{"line":76,"column":81,"index":3231},"line":76,"code":"    it('clonePermanent: should discard properties beginning with _ other than _id', function () {\n      assert(_.isEqual(apos.util.clonePermanent({\n        tree: {\n          branch: {\n            leaf: true,\n            _leaf: true\n          },\n          branches: ['one', 'two', 'three']\n        },\n        _tree: true,\n        _blee: {\n          bloo: true\n        }\n      }), {\n        tree: {\n          branch: {\n            leaf: true\n          },\n          branches: ['one', 'two', 'three']\n        }\n      }));\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"clonePermanent with keepScalars: should discard properties beginning with _ other than _id unless they are scalars (non-objects)","suites":["Utils","methods"],"updatePoint":{"line":98,"column":136,"index":3812},"line":98,"code":"    it('clonePermanent with keepScalars: should discard properties beginning with _ other than _id unless they are scalars (non-objects)', function () {\n      assert(_.isEqual(apos.util.clonePermanent({\n        tree: {\n          branch: {\n            leaf: true,\n            _leaf: true\n          },\n          branches: ['one', 'two', 'three']\n        },\n        _tree: true,\n        _blee: {\n          bloo: true\n        }\n      }, true), {\n        tree: {\n          branch: {\n            leaf: true,\n            _leaf: true\n          },\n          branches: ['one', 'two', 'three']\n        },\n        _tree: true\n      }));\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"clonePermanent should not behave bizarrely with a test case from the punkave site","suites":["Utils","methods"],"updatePoint":{"line":122,"column":89,"index":4398},"line":122,"code":"    it('clonePermanent should not behave bizarrely with a test case from the punkave site', function () {\n      const input = {\n        attachment: {\n          _id: 'a205filea1media97',\n          title: 'http-window-punkave-com-wp-content-uploads-2009-01-n56601994_30790014_5081-225x300-jpg',\n          width: 225,\n          height: 300,\n          length: 22014,\n          md5: 22014,\n          extension: 'jpg',\n          group: 'images',\n          name: 'http-window-punkave-com-wp-content-uploads-2009-01-n56601994_30790014_5081-225x300-jpg',\n          landscape: false,\n          portrait: true,\n          a15Export: true,\n          tags: ['p\\'window', '2009'],\n          searchText: 'http window punkave com wp content uploads 2009 01 n56601994 30790014 5081 225x300 jpg http window punkave com wp content uploads 2009 01 n56601994 30790014 5081 225x300 jpg jpg',\n          type: 'attachment'\n        }\n      };\n      const clone = apos.util.clonePermanent(input);\n      assert(clone.attachment._id === 'a205filea1media97');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"gives sensible results for insensitiveSort","suites":["Utils","methods"],"updatePoint":{"line":145,"column":50,"index":5397},"line":145,"code":"    it('gives sensible results for insensitiveSort', function () {\n      const input = ['Fred', 'dog', 5, 10, 'jane'];\n      apos.util.insensitiveSort(input);\n      assert(input.length === 5);\n      assert(input[0] === 5);\n      assert(input[1] === 10);\n      assert(input[2] === 'dog');\n      assert(input[3] === 'Fred');\n      assert(input[4] === 'jane');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"does not crash when apos.util.profile is called with two arguments","suites":["Utils","methods"],"updatePoint":{"line":155,"column":74,"index":5787},"line":155,"code":"    it('does not crash when apos.util.profile is called with two arguments', function () {\n      apos.util.profile(apos.task.getReq(), 'this.is.a.path')();\n      assert(true);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"does not crash when apos.util.profile is called with three arguments","suites":["Utils","methods"],"updatePoint":{"line":159,"column":76,"index":5973},"line":159,"code":"    it('does not crash when apos.util.profile is called with three arguments', function () {\n      apos.util.profile(apos.task.getReq(), 'this.is.a.path', 100);\n      assert(true);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"does not crash when apos.util.profile is called with one argument (no req arg)","suites":["Utils","methods"],"updatePoint":{"line":163,"column":86,"index":6172},"line":163,"code":"    it('does not crash when apos.util.profile is called with one argument (no req arg)', function () {\n      apos.util.profile('this.is.a.path')();\n      assert(true);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"does not crash when apos.util.profile is called with two arguments (no req arg)","suites":["Utils","methods"],"updatePoint":{"line":167,"column":87,"index":6349},"line":167,"code":"    it('does not crash when apos.util.profile is called with two arguments (no req arg)', function () {\n      apos.util.profile('this.is.a.path', 100);\n      assert(true);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a top level property with utils.get","suites":["Utils","methods"],"updatePoint":{"line":171,"column":51,"index":6493},"line":171,"code":"    it('can get a top level property with utils.get', function () {\n      const data = {\n        age: 5\n      };\n      assert(apos.util.get(data, 'age') === 5);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can set a top level property with utils.set","suites":["Utils","methods"],"updatePoint":{"line":177,"column":51,"index":6662},"line":177,"code":"    it('can set a top level property with utils.set', function () {\n      const data = {\n        age: 5\n      };\n      apos.util.set(data, 'age', 7);\n      assert(data.age === 7);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a nested property with utils.get","suites":["Utils","methods"],"updatePoint":{"line":184,"column":48,"index":6847},"line":184,"code":"    it('can get a nested property with utils.get', function () {\n      const data = {\n        shoe: {\n          size: 5\n        }\n      };\n      assert(apos.util.get(data, 'shoe.size') === 5);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can set a nested property with utils.set","suites":["Utils","methods"],"updatePoint":{"line":192,"column":48,"index":7048},"line":192,"code":"    it('can set a nested property with utils.set', function () {\n      const data = {\n        shoe: {\n          size: 5\n        }\n      };\n      apos.util.set(data, 'shoe.size', 7);\n      assert(data.shoe.size === 7);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a nested property with utils.get (2)","suites":["Utils","methods"],"updatePoint":{"line":201,"column":52,"index":7278},"line":201,"code":"    it('can get a nested property with utils.get (2)', function () {\n      const data = {\n        shoe: {\n          size: 5\n        }\n      };\n      assert(apos.util.get(data, 'shoe.size') === 5);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a nested array property with utils.get","suites":["Utils","methods"],"updatePoint":{"line":209,"column":54,"index":7485},"line":209,"code":"    it('can get a nested array property with utils.get', function () {\n      const data = {\n        shoe: {\n          laces: ['intact', 'busted']\n        }\n      };\n      assert(apos.util.get(data, 'shoe.laces.0', 'intact'));\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can set a nested array property with utils.set","suites":["Utils","methods"],"updatePoint":{"line":217,"column":54,"index":7719},"line":217,"code":"    it('can set a nested array property with utils.set', function () {\n      const data = {\n        shoe: {\n          laces: ['intact', 'busted']\n        }\n      };\n      apos.util.set(data, 'shoe.laces.0', 'gnarly');\n      assert(data.shoe.laces[0] === 'gnarly');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a subobject with @ syntax","suites":["Utils","methods"],"updatePoint":{"line":226,"column":41,"index":7979},"line":226,"code":"    it('can get a subobject with @ syntax', function () {\n      const data = {\n        shoes: [{\n          _id: 'stylin'\n        }, {\n          _id: 'busted'\n        }]\n      };\n      assert(apos.util.get(data, '@stylin')._id === 'stylin');\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can update a subobject property with @ syntax","suites":["Utils","methods"],"updatePoint":{"line":236,"column":53,"index":8240},"line":236,"code":"    it('can update a subobject property with @ syntax', function () {\n      const data = {\n        shoes: [{\n          _id: 'stylin',\n          size: 5\n        }, {\n          _id: 'busted',\n          size: 6\n        }]\n      };\n      apos.util.set(data, '@stylin.size', 7);\n      assert(data.shoes[0]._id === 'stylin');\n      assert.strictEqual(data.shoes[0].size, 7);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can get a subobject property with @ syntax","suites":["Utils","methods"],"updatePoint":{"line":250,"column":50,"index":8614},"line":250,"code":"    it('can get a subobject property with @ syntax', function () {\n      const data = {\n        shoes: [{\n          _id: 'stylin',\n          size: 5\n        }, {\n          _id: 'busted',\n          size: 6\n        }]\n      };\n      assert(apos.util.get(data, '@stylin.size') === 5);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"can replace a subobject with @ syntax","suites":["Utils","methods"],"updatePoint":{"line":262,"column":45,"index":8899},"line":262,"code":"    it('can replace a subobject with @ syntax', function () {\n      const data = {\n        shoes: [{\n          _id: 'stylin',\n          size: 5\n        }, {\n          _id: 'busted',\n          size: 6\n        }]\n      };\n      apos.util.set(data, '@stylin', {\n        _id: 'stylin',\n        size: 8\n      });\n      assert(data.shoes[0].size === 8);\n    });","file":"utils.js","skipped":false,"dir":"test"},{"name":"should fail to initialize with a schema containing a field named \"type\"","suites":["Malformed Widgets"],"updatePoint":{"line":8,"column":77,"index":271},"line":8,"code":"  it('should fail to initialize with a schema containing a field named \"type\"', function (done) {\n    let throwsError = true;\n    const mochaProcess = spawn('node', ['./test/widgets-children/widgets-malformed-child.js']);\n    mochaProcess.stdout.on('data', data => {\n      console.log(`Mocha output: ${data}`);\n    });\n    mochaProcess.stderr.on('data', data => {\n      const errorMsg = data.toString();\n      const errorMatch = errorMsg.match(/(?<error>Error:.*\\n)/);\n      if (errorMatch) {\n        throwsError = true;\n        assert.equal(errorMatch.groups.error, 'Error: The malformed module contains a forbidden field property name: \"type\".\\n');\n      } else {\n        throwsError = false;\n      }\n    });\n    mochaProcess.on('close', code => {\n      assert.equal(code, 1, 'Mocha process exited with status code 0');\n      assert.ok(throwsError, 'Error message not found in stderr');\n      done();\n    });\n  });","file":"widgets-malformed.js","skipped":false,"dir":"test"},{"name":"should be able to render page template with well constructed area tag","suites":["Widgets","area tag"],"updatePoint":{"line":104,"column":77,"index":2933},"line":104,"code":"    it('should be able to render page template with well constructed area tag', async function () {\n      const goodPageDoc = await apos.page.find(req, {\n        slug: '/good-page'\n      }).toObject();\n      const args = getRenderArgs(req, goodPageDoc);\n      const result = await apos.modules['args-good-page'].render(req, 'page', args);\n      assert(result.includes('<h2>Good args page</h2>'));\n      assert(result.includes('<p>You can control what happens when the text reaches the edges of its content area using its attributes.</p>'));\n      assert(result.includes('<li>color: 🟣</li>'));\n    });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should error while trying to render page template with poorly constructed area tag","suites":["Widgets","area tag"],"updatePoint":{"line":114,"column":90,"index":3548},"line":114,"code":"    it('should error while trying to render page template with poorly constructed area tag', async function () {\n      const badPageDoc = await apos.page.find(req, {\n        slug: '/bad-page'\n      }).toObject();\n      const args = getRenderArgs(req, badPageDoc);\n      try {\n        await apos.modules['args-bad-page'].render(req, 'page', args);\n        assert(false);\n      } catch (error) {\n        assert(error.toString().includes('Too many arguments were passed'));\n      }\n    });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should render the placeholders when widget's `aposPlaceholder` doc field is `true`","suites":["Widgets","placeholders","custom widget"],"updatePoint":{"line":199,"column":93,"index":6097},"line":199,"code":"      it('should render the placeholders when widget\\'s `aposPlaceholder` doc field is `true`', function () {\n        assert(result.includes('<li>widget1 - aposPlaceholder: true</li>'));\n        assert(result.includes('<li>widget1 - string: String PLACEHOLDER</li>'));\n        assert(result.includes('<li>widget1 - integer: 0</li>'));\n        assert(result.includes('<li>widget1 - float: 0.1</li>'));\n        assert(result.includes('<li>widget1 - date: YYYY-MM-DD</li>'));\n        assert(result.includes('<li>widget1 - time: HH:MM:SS</li>'));\n      });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should not render the placeholders when widget's `aposPlaceholder` doc field is `false`","suites":["Widgets","placeholders","custom widget"],"updatePoint":{"line":207,"column":98,"index":6655},"line":207,"code":"      it('should not render the placeholders when widget\\'s `aposPlaceholder` doc field is `false`', function () {\n        assert(result.includes('<li>widget2 - aposPlaceholder: false</li>'));\n        assert(!result.includes('<li>widget2 - string: String PLACEHOLDER</li>'));\n        assert(!result.includes('<li>widget2 - integer: 0</li>'));\n        assert(!result.includes('<li>widget2 - float: 0.1</li>'));\n        assert(!result.includes('<li>widget2 - date: YYYY-MM-DD</li>'));\n        assert(!result.includes('<li>widget2 - time: HH:MM:SS</li>'));\n      });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should not render the placeholders when widget's `aposPlaceholder` doc field is not defined","suites":["Widgets","placeholders","custom widget"],"updatePoint":{"line":215,"column":102,"index":7223},"line":215,"code":"      it('should not render the placeholders when widget\\'s `aposPlaceholder` doc field is not defined', function () {\n        assert(!result.includes('<li>widget3 - string: String PLACEHOLDER</li>'));\n        assert(!result.includes('<li>widget3 - integer: 0</li>'));\n        assert(!result.includes('<li>widget3 - float: 0.1</li>'));\n        assert(!result.includes('<li>widget3 - date: YYYY-MM-DD</li>'));\n        assert(!result.includes('<li>widget3 - time: HH:MM:SS</li>'));\n        assert(result.includes('<li>widget4 - string: Some string</li>'));\n        assert(result.includes('<li>widget4 - integer: 2</li>'));\n        assert(result.includes('<li>widget4 - float: 2.2</li>'));\n        assert(result.includes('<li>widget4 - date: 2022-09-21</li>'));\n        assert(result.includes('<li>widget4 - time: 15:39:12</li>'));\n      });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should not render the placeholders on preview mode","suites":["Widgets","placeholders","custom widget"],"updatePoint":{"line":227,"column":60,"index":8020},"line":227,"code":"      it('should not render the placeholders on preview mode', async function () {\n        // eslint-disable-next-line no-unused-vars\n        const {\n          aposEdit,\n          ...query\n        } = req.query;\n        const _nonEditingReq = {\n          ...req,\n          query\n        };\n        const args = getRenderArgs(_nonEditingReq, page);\n        const _result = await apos.modules['placeholder-page'].render(_nonEditingReq, 'page', args);\n        assert(!_result.includes('widget1'));\n      });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should render the placeholder only when widget's `aposPlaceholder` doc field is `true`","suites":["Widgets","placeholders"," widget"],"updatePoint":{"line":327,"column":99,"index":12093},"line":327,"code":"        it('should render the placeholder only when widget\\'s `aposPlaceholder` doc field is `true`', function () {\n          const {\n            document\n          } = new JSDOM(result).window;\n          assertAposPlaceholderTrue(document);\n        });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should not render the placeholders on preview mode","suites":["Widgets","placeholders"," widget"],"updatePoint":{"line":333,"column":62,"index":12310},"line":333,"code":"        it('should not render the placeholders on preview mode', async function () {\n          // eslint-disable-next-line no-unused-vars\n          const {\n            aposEdit,\n            ...query\n          } = req.query;\n          const _nonEditingReq = {\n            ...req,\n            query\n          };\n          const args = getRenderArgs(_nonEditingReq, page);\n          const _result = await apos.modules['placeholder-page'].render(_nonEditingReq, 'page', args);\n          const {\n            document\n          } = new JSDOM(_result).window;\n          assertPreviewMode(document);\n        });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should not render the placeholder when widget's module `placeholderUrl` option is falsy","suites":["Widgets","placeholders"," widget","placeholderUrl - falsy"],"updatePoint":{"line":388,"column":102,"index":14349},"line":388,"code":"          it('should not render the placeholder when widget\\'s module `placeholderUrl` option is falsy', function () {\n            const {\n              document\n            } = new JSDOM(_result).window;\n            assertFalsyPlaceholderUrl(document);\n          });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should render the placeholder set to the widget's module `placeholderUrl` override","suites":["Widgets","placeholders"," widget","placeholderUrl - override"],"updatePoint":{"line":432,"column":97,"index":15996},"line":432,"code":"          it('should render the placeholder set to the widget\\'s module `placeholderUrl` override', function () {\n            const {\n              document\n            } = new JSDOM(_result).window;\n            assertPlaceholderUrlOverride(document);\n          });","file":"widgets.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["With Nested Module Subdirs"],"updatePoint":{"line":14,"column":23,"index":285},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      nestedModuleSubdirs: true,\n      modules: {\n        example1: {}\n      }\n    });\n    assert(apos.modules.example1);\n    // With nestedModuleSubdirs switched on, the index.js should be found,\n    // and modules.js should be loaded\n    assert(apos.modules.example1.options.folderLevelOption);\n    assert(apos.modules.example1.initialized);\n  });","file":"with-nested-module-subdirs.js","skipped":false,"dir":"test"},{"name":"should initialize","suites":["Without Nested Module Subdirs"],"updatePoint":{"line":14,"column":23,"index":288},"line":14,"code":"  it('should initialize', async function () {\n    apos = await t.create({\n      root: module,\n      modules: {\n        example1: {}\n      }\n    });\n    assert(apos.modules.example1);\n    // Should fail because we didn't turn on nestedModuleSubdirs,\n    // so the index.js was not found and modules.js was not loaded\n    assert(!apos.modules.example1.options.folderLevelOption);\n    assert(!apos.modules.example1.initialized);\n  });","file":"without-nested-module-subdirs.js","skipped":false,"dir":"test"}]}