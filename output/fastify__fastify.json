{"repo":"fastify/fastify","url":"https://github.com/fastify/fastify","branch":"main","configs":[{"package":"fastify","lang":"js","dir":"test","framework":"jest","pattern":"**/*[._-]{test,spec,unittest,unit}.{ts,js}"}],"tests":[{"name":"default 404","suites":[],"updatePoint":{"line":19,"column":17,"index":315},"line":19,"code":"test('default 404', t => {\n  t.plan(3);\n  const test = t.test;\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: {},\n        json: true\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      });\n    });\n    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported',\n        body: {},\n        json: true\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported method","suites":[],"updatePoint":{"line":31,"column":28,"index":603},"line":31,"code":"    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: {},\n        json: true\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported route","suites":[],"updatePoint":{"line":44,"column":27,"index":1001},"line":44,"code":"    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported',\n        body: {},\n        json: true\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"customized 404","suites":[],"updatePoint":{"line":59,"column":20,"index":1420},"line":59,"code":"test('customized 404', t => {\n  t.plan(5);\n  const test = t.test;\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/with-error', function (req, reply) {\n    reply.send(new errors.NotFound());\n  });\n  fastify.get('/with-error-custom-header', function (req, reply) {\n    const err = new errors.NotFound();\n    err.headers = {\n      'x-foo': 'bar'\n    };\n    reply.send(err);\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    reply.code(404).send('this was not found');\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });\n    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });\n    test('with error object', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/with-error'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.same(JSON.parse(body), {\n          error: 'Not Found',\n          message: 'Not Found',\n          statusCode: 404\n        });\n      });\n    });\n    test('error object with headers property', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/with-error-custom-header'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['x-foo'], 'bar');\n        t.same(JSON.parse(body), {\n          error: 'Not Found',\n          message: 'Not Found',\n          statusCode: 404\n        });\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported method","suites":[],"updatePoint":{"line":84,"column":28,"index":2094},"line":84,"code":"    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported route","suites":[],"updatePoint":{"line":101,"column":27,"index":2567},"line":101,"code":"    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"with error object","suites":[],"updatePoint":{"line":112,"column":27,"index":2915},"line":112,"code":"    test('with error object', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/with-error'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.same(JSON.parse(body), {\n          error: 'Not Found',\n          message: 'Not Found',\n          statusCode: 404\n        });\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"error object with headers property","suites":[],"updatePoint":{"line":127,"column":44,"index":3357},"line":127,"code":"    test('error object with headers property', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/with-error-custom-header'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['x-foo'], 'bar');\n        t.same(JSON.parse(body), {\n          error: 'Not Found',\n          message: 'Not Found',\n          statusCode: 404\n        });\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"custom header in notFound handler","suites":[],"updatePoint":{"line":145,"column":39,"index":3869},"line":145,"code":"test('custom header in notFound handler', t => {\n  t.plan(2);\n  const test = t.test;\n  const fastify = Fastify();\n  fastify.setNotFoundHandler(function (req, reply) {\n    reply.code(404).header('x-foo', 'bar').send('this was not found');\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    test('not found with custom header', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['x-foo'], 'bar');\n        t.equal(body.toString(), 'this was not found');\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"not found with custom header","suites":[],"updatePoint":{"line":155,"column":38,"index":4202},"line":155,"code":"    test('not found with custom header', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(response.headers['x-foo'], 'bar');\n        t.equal(body.toString(), 'this was not found');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"setting a custom 404 handler multiple times is an error","suites":[],"updatePoint":{"line":169,"column":61,"index":4645},"line":169,"code":"test('setting a custom 404 handler multiple times is an error', t => {\n  t.plan(5);\n  t.test('at the root level', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler(() => {});\n\n    try {\n      fastify.setNotFoundHandler(() => {});\n      t.fail('setting multiple 404 handlers at the same prefix encapsulation level should throw');\n    } catch (err) {\n      t.type(err, Error);\n      t.equal(err.message, 'Not found handler already set for Fastify instance with prefix: \\'/\\'');\n    }\n  });\n  t.test('at the plugin level', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.register((instance, options, done) => {\n      instance.setNotFoundHandler(() => {});\n\n      try {\n        instance.setNotFoundHandler(() => {});\n        t.fail('setting multiple 404 handlers at the same prefix encapsulation level should throw');\n      } catch (err) {\n        t.type(err, Error);\n        t.equal(err.message, 'Not found handler already set for Fastify instance with prefix: \\'/prefix\\'');\n      }\n\n      done();\n    }, {\n      prefix: '/prefix'\n    });\n    fastify.listen(0, err => {\n      t.error(err);\n      fastify.close();\n    });\n  });\n  t.test('at multiple levels', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.register((instance, options, done) => {\n      try {\n        instance.setNotFoundHandler(() => {});\n        t.fail('setting multiple 404 handlers at the same prefix encapsulation level should throw');\n      } catch (err) {\n        t.type(err, Error);\n        t.equal(err.message, 'Not found handler already set for Fastify instance with prefix: \\'/\\'');\n      }\n\n      done();\n    });\n    fastify.setNotFoundHandler(() => {});\n    fastify.listen(0, err => {\n      t.error(err);\n      fastify.close();\n    });\n  });\n  t.test('at multiple levels / 2', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.register((instance, options, done) => {\n      instance.setNotFoundHandler(() => {});\n      instance.register((instance2, options, done) => {\n        try {\n          instance2.setNotFoundHandler(() => {});\n          t.fail('setting multiple 404 handlers at the same prefix encapsulation level should throw');\n        } catch (err) {\n          t.type(err, Error);\n          t.equal(err.message, 'Not found handler already set for Fastify instance with prefix: \\'/prefix\\'');\n        }\n\n        done();\n      });\n      done();\n    }, {\n      prefix: '/prefix'\n    });\n    fastify.setNotFoundHandler(() => {});\n    fastify.listen(0, err => {\n      t.error(err);\n      fastify.close();\n    });\n  });\n  t.test('in separate plugins at the same level', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.register((instance, options, done) => {\n      instance.register((instance2A, options, done) => {\n        instance2A.setNotFoundHandler(() => {});\n        done();\n      });\n      instance.register((instance2B, options, done) => {\n        try {\n          instance2B.setNotFoundHandler(() => {});\n          t.fail('setting multiple 404 handlers at the same prefix encapsulation level should throw');\n        } catch (err) {\n          t.type(err, Error);\n          t.equal(err.message, 'Not found handler already set for Fastify instance with prefix: \\'/prefix\\'');\n        }\n\n        done();\n      });\n      done();\n    }, {\n      prefix: '/prefix'\n    });\n    fastify.setNotFoundHandler(() => {});\n    fastify.listen(0, err => {\n      t.error(err);\n      fastify.close();\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"encapsulated 404","suites":[],"updatePoint":{"line":283,"column":22,"index":8090},"line":283,"code":"test('encapsulated 404', t => {\n  t.plan(9);\n  const test = t.test;\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    reply.code(404).send('this was not found');\n  });\n  fastify.register(function (f, opts, done) {\n    f.setNotFoundHandler(function (req, reply) {\n      reply.code(404).send('this was not found 2');\n    });\n    done();\n  }, {\n    prefix: '/test'\n  });\n  fastify.register(function (f, opts, done) {\n    f.setNotFoundHandler(function (req, reply) {\n      reply.code(404).send('this was not found 3');\n    });\n    done();\n  }, {\n    prefix: '/test2'\n  });\n  fastify.register(function (f, opts, done) {\n    f.setNotFoundHandler(function (request, reply) {\n      reply.code(404).send('this was not found 4');\n    });\n    done();\n  }, {\n    prefix: '/test3/'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    test('root unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });\n    test('root insupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });\n    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 2');\n      });\n    });\n    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 2');\n      });\n    });\n    test('unsupported method bis', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test2',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 3');\n      });\n    });\n    test('unsupported route bis', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test2/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 3');\n      });\n    });\n    test('unsupported method 3', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test3/',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 4');\n      });\n    });\n    test('unsupported route 3', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test3/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 4');\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"root unsupported method","suites":[],"updatePoint":{"line":322,"column":33,"index":9097},"line":322,"code":"    test('root unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"root insupported route","suites":[],"updatePoint":{"line":339,"column":32,"index":9575},"line":339,"code":"    test('root insupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported method","suites":[],"updatePoint":{"line":350,"column":28,"index":9924},"line":350,"code":"    test('unsupported method', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 2');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported route","suites":[],"updatePoint":{"line":367,"column":27,"index":10409},"line":367,"code":"    test('unsupported route', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 2');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported method bis","suites":[],"updatePoint":{"line":378,"column":32,"index":10769},"line":378,"code":"    test('unsupported method bis', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test2',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 3');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported route bis","suites":[],"updatePoint":{"line":395,"column":31,"index":11259},"line":395,"code":"    test('unsupported route bis', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test2/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 3');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported method 3","suites":[],"updatePoint":{"line":406,"column":30,"index":11618},"line":406,"code":"    test('unsupported method 3', t => {\n      t.plan(3);\n      sget({\n        method: 'PUT',\n        url: 'http://localhost:' + fastify.server.address().port + '/test3/',\n        body: JSON.stringify({\n          hello: 'world'\n        }),\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 4');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"unsupported route 3","suites":[],"updatePoint":{"line":423,"column":29,"index":12107},"line":423,"code":"    test('unsupported route 3', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/test3/notSupported'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n        t.equal(body.toString(), 'this was not found 4');\n      });\n    });","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"custom 404 hook and handler context","suites":[],"updatePoint":{"line":436,"column":41,"index":12487},"line":436,"code":"test('custom 404 hook and handler context', t => {\n  t.plan(21);\n  const fastify = Fastify();\n  fastify.decorate('foo', 42);\n  fastify.addHook('onRequest', function (req, res, done) {\n    t.equal(this.foo, 42);\n    done();\n  });\n  fastify.addHook('preHandler', function (request, reply, done) {\n    t.equal(this.foo, 42);\n    done();\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.equal(this.foo, 42);\n    done();\n  });\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.equal(this.foo, 42);\n    done();\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    t.equal(this.foo, 42);\n    reply.code(404).send('this was not found');\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.decorate('bar', 84);\n    instance.addHook('onRequest', function (req, res, done) {\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.setNotFoundHandler(function (req, reply) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      reply.code(404).send('encapsulated was not found');\n    });\n    done();\n  }, {\n    prefix: '/encapsulated'\n  });\n  fastify.inject('/not-found', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'this was not found');\n  });\n  fastify.inject('/encapsulated/not-found', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'encapsulated was not found');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"encapsulated custom 404 without - prefix hook and handler context","suites":[],"updatePoint":{"line":498,"column":71,"index":14347},"line":498,"code":"test('encapsulated custom 404 without - prefix hook and handler context', t => {\n  t.plan(13);\n  const fastify = Fastify();\n  fastify.decorate('foo', 42);\n  fastify.register(function (instance, opts, done) {\n    instance.decorate('bar', 84);\n    instance.addHook('onRequest', function (req, res, done) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      done();\n    });\n    instance.setNotFoundHandler(function (request, reply) {\n      t.equal(this.foo, 42);\n      t.equal(this.bar, 84);\n      reply.code(404).send('custom not found');\n    });\n    done();\n  });\n  fastify.inject('/not-found', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'custom not found');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"run hooks on default 404","suites":[],"updatePoint":{"line":537,"column":30,"index":15489},"line":537,"code":"test('run hooks on default 404', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', function (req, res, done) {\n    t.pass('onRequest called');\n    done();\n  });\n  fastify.addHook('preHandler', function (request, reply, done) {\n    t.pass('preHandler called');\n    done();\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.pass('onSend called');\n    done();\n  });\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.pass('onResponse called');\n    done();\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'PUT',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: JSON.stringify({\n        hello: 'world'\n      }),\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"run non-encapsulated plugin hooks on default 404","suites":[],"updatePoint":{"line":579,"column":54,"index":16580},"line":579,"code":"test('run non-encapsulated plugin hooks on default 404', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register(fp(function (instance, options, done) {\n    instance.addHook('onRequest', function (req, res, done) {\n      t.pass('onRequest called');\n      done();\n    });\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.pass('preHandler called');\n      done();\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.pass('onSend called');\n      done();\n    });\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.pass('onResponse called');\n      done();\n    });\n    done();\n  }));\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"run non-encapsulated plugin hooks on custom 404","suites":[],"updatePoint":{"line":617,"column":53,"index":17533},"line":617,"code":"test('run non-encapsulated plugin hooks on custom 404', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  const plugin = fp((instance, opts, done) => {\n    instance.addHook('onRequest', function (req, res, done) {\n      t.pass('onRequest called');\n      done();\n    });\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.pass('preHandler called');\n      done();\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.pass('onSend called');\n      done();\n    });\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.pass('onResponse called');\n      done();\n    });\n    done();\n  });\n  fastify.register(plugin);\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    reply.code(404).send('this was not found');\n  });\n  fastify.register(plugin); // Registering plugin after handler also works\n\n  fastify.inject({\n    url: '/not-found'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'this was not found');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"run hook with encapsulated 404","suites":[],"updatePoint":{"line":658,"column":36,"index":18663},"line":658,"code":"test('run hook with encapsulated 404', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', function (req, res, done) {\n    t.pass('onRequest called');\n    done();\n  });\n  fastify.addHook('preHandler', function (request, reply, done) {\n    t.pass('preHandler called');\n    done();\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.pass('onSend called');\n    done();\n  });\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.pass('onResponse called');\n    done();\n  });\n  fastify.register(function (f, opts, done) {\n    f.setNotFoundHandler(function (req, reply) {\n      reply.code(404).send('this was not found 2');\n    });\n    f.addHook('onRequest', function (req, res, done) {\n      t.pass('onRequest 2 called');\n      done();\n    });\n    f.addHook('preHandler', function (request, reply, done) {\n      t.pass('preHandler 2 called');\n      done();\n    });\n    f.addHook('onSend', function (request, reply, payload, done) {\n      t.pass('onSend 2 called');\n      done();\n    });\n    f.addHook('onResponse', function (request, reply, done) {\n      t.pass('onResponse 2 called');\n      done();\n    });\n    done();\n  }, {\n    prefix: '/test'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'PUT',\n      url: 'http://localhost:' + fastify.server.address().port + '/test',\n      body: JSON.stringify({\n        hello: 'world'\n      }),\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"hooks check 404","suites":[],"updatePoint":{"line":719,"column":21,"index":20314},"line":719,"code":"test('hooks check 404', t => {\n  t.plan(13);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.same(req.query, {\n      foo: 'asd'\n    });\n    t.ok('called', 'onSend');\n    done();\n  });\n  fastify.addHook('onRequest', (req, res, done) => {\n    t.ok('called', 'onRequest');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called', 'onResponse');\n    done();\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'PUT',\n      url: 'http://localhost:' + fastify.server.address().port + '?foo=asd',\n      body: JSON.stringify({\n        hello: 'world'\n      }),\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/notSupported?foo=asd'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"setNotFoundHandler should not suppress duplicated routes checking","suites":[],"updatePoint":{"line":767,"column":71,"index":21573},"line":767,"code":"test('setNotFoundHandler should not suppress duplicated routes checking', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    reply.code(404).send('this was not found');\n  });\n  fastify.listen(0, err => {\n    t.ok(err);\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"log debug for 404","suites":[],"updatePoint":{"line":787,"column":23,"index":21999},"line":787,"code":"test('log debug for 404', t => {\n  t.plan(1);\n\n  const Writable = require('stream').Writable;\n\n  const logStream = new Writable();\n  logStream.logs = [];\n\n  logStream._write = function (chunk, encoding, callback) {\n    this.logs.push(chunk.toString());\n    callback();\n  };\n\n  const fastify = Fastify({\n    logger: {\n      level: 'trace',\n      stream: logStream\n    }\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  t.test('log debug', t => {\n    t.plan(7);\n    fastify.inject({\n      method: 'GET',\n      url: '/not-found'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n      const INFO_LEVEL = 30;\n      t.equal(JSON.parse(logStream.logs[0]).msg, 'incoming request');\n      t.equal(JSON.parse(logStream.logs[1]).msg, 'Route GET:/not-found not found');\n      t.equal(JSON.parse(logStream.logs[1]).level, INFO_LEVEL);\n      t.equal(JSON.parse(logStream.logs[2]).msg, 'request completed');\n      t.equal(logStream.logs.length, 3);\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"Unknown method","suites":[],"updatePoint":{"line":829,"column":20,"index":23085},"line":829,"code":"test('Unknown method', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n\n    const handler = () => {}; // See https://github.com/fastify/light-my-request/pull/20\n\n\n    t.throws(() => fastify.inject({\n      method: 'UNKNWON_METHOD',\n      url: '/'\n    }, handler), Error);\n    sget({\n      method: 'UNKNWON_METHOD',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.strictSame(JSON.parse(body), {\n        error: 'Bad Request',\n        message: 'Client Error',\n        statusCode: 400\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"recognizes errors from the http-errors module","suites":[],"updatePoint":{"line":862,"column":51,"index":23928},"line":862,"code":"test('recognizes errors from the http-errors module', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send(httpErrors.NotFound());\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 404);\n      sget('http://localhost:' + fastify.server.address().port, (err, response, body) => {\n        t.error(err);\n        const obj = JSON.parse(body.toString());\n        t.strictSame(obj, {\n          error: 'Not Found',\n          message: 'Not Found',\n          statusCode: 404\n        });\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"the default 404 handler can be invoked inside a prefixed plugin","suites":[],"updatePoint":{"line":889,"column":69,"index":24681},"line":889,"code":"test('the default 404 handler can be invoked inside a prefixed plugin', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.get('/path', function (request, reply) {\n      reply.send(httpErrors.NotFound());\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject('/v1/path', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.strictSame(JSON.parse(res.payload), {\n      error: 'Not Found',\n      message: 'Not Found',\n      statusCode: 404\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"an inherited custom 404 handler can be invoked inside a prefixed plugin","suites":[],"updatePoint":{"line":910,"column":77,"index":25244},"line":910,"code":"test('an inherited custom 404 handler can be invoked inside a prefixed plugin', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.setNotFoundHandler(function (request, reply) {\n    reply.code(404).send('custom handler');\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/path', function (request, reply) {\n      reply.send(httpErrors.NotFound());\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject('/v1/path', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Found',\n      message: 'Not Found',\n      statusCode: 404\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"encapsulated custom 404 handler without a prefix is the handler for the entire 404 level","suites":[],"updatePoint":{"line":934,"column":94,"index":25925},"line":934,"code":"test('encapsulated custom 404 handler without a prefix is the handler for the entire 404 level', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.setNotFoundHandler(function (request, reply) {\n      reply.code(404).send('custom handler');\n    });\n    done();\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.register(function (instance2, opts, done) {\n      instance2.setNotFoundHandler(function (request, reply) {\n        reply.code(404).send('custom handler 2');\n      });\n      done();\n    });\n    done();\n  }, {\n    prefix: 'prefixed'\n  });\n  fastify.inject('/not-found', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'custom handler');\n  });\n  fastify.inject('/prefixed/not-found', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'custom handler 2');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"cannot set notFoundHandler after binding","suites":[],"updatePoint":{"line":965,"column":46,"index":26824},"line":965,"code":"test('cannot set notFoundHandler after binding', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n\n    try {\n      fastify.setNotFoundHandler(() => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"404 inside onSend","suites":[],"updatePoint":{"line":980,"column":23,"index":27110},"line":980,"code":"test('404 inside onSend', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let called = false;\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    if (!called) {\n      called = true;\n      done(new errors.NotFound());\n    } else {\n      done();\n    }\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"Not found on supported method (should return a 404)","suites":[],"updatePoint":{"line":1009,"column":57,"index":27819},"line":1009,"code":"test('Not found on supported method (should return a 404)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'POST',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 404);\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n      });\n    });\n  });\n}); // Return 404 instead of 405 see https://github.com/fastify/fastify/pull/862 for discussion","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"Not found on unsupported method (should return a 404)","suites":[],"updatePoint":{"line":1037,"column":59,"index":28576},"line":1037,"code":"test('Not found on unsupported method (should return a 404)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.all('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'PROPFIND',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 404);\n      sget({\n        method: 'PROPFIND',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 404);\n      });\n    });\n  });\n}); // https://github.com/fastify/fastify/issues/868","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"onSend hooks run when an encapsulated route invokes the notFound handler","suites":[],"updatePoint":{"line":1065,"column":78,"index":29317},"line":1065,"code":"test('onSend hooks run when an encapsulated route invokes the notFound handler', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register((instance, options, done) => {\n    instance.addHook('onSend', (request, reply, payload, done) => {\n      t.pass('onSend hook called');\n      done();\n    });\n    instance.get('/', (request, reply) => {\n      reply.send(new errors.NotFound());\n    });\n    done();\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n}); // https://github.com/fastify/fastify/issues/713","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"preHandler option for setNotFoundHandler","suites":[],"updatePoint":{"line":1084,"column":46,"index":29852},"line":1084,"code":"test('preHandler option for setNotFoundHandler', t => {\n  t.plan(10);\n  t.test('preHandler option', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        req.body.preHandler = true;\n        done();\n      }\n    }, function (req, reply) {\n      reply.code(404).send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        preHandler: true,\n        hello: 'world'\n      });\n    });\n  }); // https://github.com/fastify/fastify/issues/2229\n\n  t.test('preHandler hook in setNotFoundHandler should be called when callNotFound', {\n    timeout: 40000\n  }, t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        req.body.preHandler = true;\n        done();\n      }\n    }, function (req, reply) {\n      reply.code(404).send(req.body);\n    });\n    fastify.post('/', function (req, reply) {\n      reply.callNotFound();\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        preHandler: true,\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler hook in setNotFoundHandler should accept an array of functions and be called when callNotFound', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: [(req, reply, done) => {\n        req.body.preHandler1 = true;\n        done();\n      }, (req, reply, done) => {\n        req.body.preHandler2 = true;\n        done();\n      }]\n    }, function (req, reply) {\n      reply.code(404).send(req.body);\n    });\n    fastify.post('/', function (req, reply) {\n      reply.callNotFound();\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        preHandler1: true,\n        preHandler2: true,\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler option should be called after preHandler hook', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addHook('preHandler', (req, reply, done) => {\n      req.body.check = 'a';\n      done();\n    });\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        req.body.check += 'b';\n        done();\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        check: 'ab',\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler option should be unique per prefix', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        req.body.hello = 'earth';\n        done();\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.register(function (i, o, n) {\n      i.setNotFoundHandler((req, reply) => {\n        reply.send(req.body);\n      });\n      n();\n    }, {\n      prefix: '/no'\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        hello: 'earth'\n      });\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/no/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler option should handle errors', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        done(new Error('kaboom'));\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.equal(res.statusCode, 500);\n      t.same(payload, {\n        message: 'kaboom',\n        error: 'Internal Server Error',\n        statusCode: 500\n      });\n    });\n  });\n  t.test('preHandler option should handle errors with custom status code', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        reply.code(401);\n        done(new Error('go away'));\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.equal(res.statusCode, 401);\n      t.same(payload, {\n        message: 'go away',\n        error: 'Unauthorized',\n        statusCode: 401\n      });\n    });\n  });\n  t.test('preHandler option could accept an array of functions', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler({\n      preHandler: [(req, reply, done) => {\n        req.body.preHandler = 'a';\n        done();\n      }, (req, reply, done) => {\n        req.body.preHandler += 'b';\n        done();\n      }]\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        preHandler: 'ab',\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler option does not interfere with preHandler', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    fastify.addHook('preHandler', (req, reply, done) => {\n      req.body.check = 'a';\n      done();\n    });\n    fastify.setNotFoundHandler({\n      preHandler: (req, reply, done) => {\n        req.body.check += 'b';\n        done();\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.register(function (i, o, n) {\n      i.setNotFoundHandler((req, reply) => {\n        reply.send(req.body);\n      });\n      n();\n    }, {\n      prefix: '/no'\n    });\n    fastify.inject({\n      method: 'post',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        check: 'ab',\n        hello: 'world'\n      });\n    });\n    fastify.inject({\n      method: 'post',\n      url: '/no/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        check: 'a',\n        hello: 'world'\n      });\n    });\n  });\n  t.test('preHandler option should keep the context', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.decorate('foo', 42);\n    fastify.setNotFoundHandler({\n      preHandler: function (req, reply, done) {\n        t.equal(this.foo, 42);\n        this.foo += 1;\n        req.body.foo = this.foo;\n        done();\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/not-found',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        foo: 43,\n        hello: 'world'\n      });\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"reply.notFound invoked the notFound handler","suites":[],"updatePoint":{"line":1419,"column":49,"index":37891},"line":1419,"code":"test('reply.notFound invoked the notFound handler', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.setNotFoundHandler((req, reply) => {\n    reply.code(404).send(new Error('kaboom'));\n  });\n  fastify.get('/', function (req, reply) {\n    reply.callNotFound();\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Found',\n      message: 'kaboom',\n      statusCode: 404\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"The custom error handler should be invoked after the custom not found handler","suites":[],"updatePoint":{"line":1441,"column":83,"index":38454},"line":1441,"code":"test('The custom error handler should be invoked after the custom not found handler', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  const order = [1, 2];\n  fastify.setErrorHandler((err, req, reply) => {\n    t.equal(order.shift(), 2);\n    t.type(err, Error);\n    reply.send(err);\n  });\n  fastify.setNotFoundHandler((req, reply) => {\n    t.equal(order.shift(), 1);\n    reply.code(404).send(new Error('kaboom'));\n  });\n  fastify.get('/', function (req, reply) {\n    reply.callNotFound();\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Found',\n      message: 'kaboom',\n      statusCode: 404\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"If the custom not found handler does not use an Error, the custom error handler should not be called","suites":[],"updatePoint":{"line":1470,"column":106,"index":39226},"line":1470,"code":"test('If the custom not found handler does not use an Error, the custom error handler should not be called', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.setErrorHandler((_err, req, reply) => {\n    t.fail('Should not be called');\n  });\n  fastify.setNotFoundHandler((req, reply) => {\n    reply.code(404).send('kaboom');\n  });\n  fastify.get('/', function (req, reply) {\n    reply.callNotFound();\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, 'kaboom');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"preValidation option","suites":[],"updatePoint":{"line":1491,"column":26,"index":39730},"line":1491,"code":"test('preValidation option', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.decorate('foo', true);\n  fastify.setNotFoundHandler({\n    preValidation: function (req, reply, done) {\n      t.ok(this.foo);\n      done();\n    }\n  }, function (req, reply) {\n    reply.code(404).send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/not-found',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"Should fail to invoke callNotFound inside a 404 handler","suites":[],"updatePoint":{"line":1545,"column":61,"index":40922},"line":1545,"code":"test('Should fail to invoke callNotFound inside a 404 handler', t => {\n  t.plan(5);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'warn'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.setNotFoundHandler((req, reply) => {\n    reply.callNotFound();\n  });\n  fastify.get('/', function (req, reply) {\n    reply.callNotFound();\n  });\n  logStream.once('data', line => {\n    t.equal(line.msg, 'Trying to send a NotFound error inside a 404 handler. Sending basic 404 response.');\n    t.equal(line.level, 40);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.equal(res.payload, '404 Not Found');\n  });\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"400 in case of bad url (pre find-my-way v2.2.0 was a 404)","suites":[],"updatePoint":{"line":1580,"column":63,"index":41727},"line":1580,"code":"test('400 in case of bad url (pre find-my-way v2.2.0 was a 404)', t => {\n  t.test('Dynamic route', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.get('/hello/:id', () => t.fail('we should not be here'));\n    fastify.inject({\n      url: '/hello/%world',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(response.payload), {\n        error: 'Bad Request',\n        message: \"'%world' is not a valid url component\",\n        statusCode: 400\n      });\n    });\n  });\n  t.test('Wildcard', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.get('*', () => t.fail('we should not be here'));\n    fastify.inject({\n      url: '/hello/%world',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(response.payload), {\n        error: 'Bad Request',\n        message: \"'/hello/%world' is not a valid url component\",\n        statusCode: 400\n      });\n    });\n  });\n  t.end();\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"setNotFoundHandler should be chaining fastify instance","suites":[],"updatePoint":{"line":1617,"column":60,"index":42781},"line":1617,"code":"test('setNotFoundHandler should be chaining fastify instance', t => {\n  t.test('Register route after setNotFoundHandler', t => {\n    t.plan(6);\n    const fastify = Fastify();\n    fastify.setNotFoundHandler(function (_req, reply) {\n      reply.code(404).send('this was not found');\n    }).get('/valid-route', function (_req, reply) {\n      reply.send('valid route');\n    });\n    fastify.inject({\n      url: '/invalid-route',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n      t.equal(response.payload, 'this was not found');\n    });\n    fastify.inject({\n      url: '/valid-route',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.payload, 'valid route');\n    });\n  });\n  t.end();\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"Send 404 when frameworkError calls reply.callNotFound","suites":[],"updatePoint":{"line":1645,"column":59,"index":43610},"line":1645,"code":"test('Send 404 when frameworkError calls reply.callNotFound', t => {\n  t.test('Dynamic route', t => {\n    t.plan(4);\n    const fastify = Fastify({\n      logger: true,\n      frameworkErrors: (error, req, reply) => {\n        t.equal(error.message, \"'%world' is not a valid url component\");\n        return reply.callNotFound();\n      }\n    });\n    fastify.get('/hello/:id', () => t.fail('we should not be here'));\n    fastify.inject({\n      url: '/hello/%world',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n      t.equal(response.payload, '404 Not Found');\n    });\n  });\n  t.end();\n});","file":"404s.test.js","skipped":false,"dir":"test"},{"name":"default 500","suites":[],"updatePoint":{"line":11,"column":17,"index":161},"line":11,"code":"test('default 500', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send(new Error('kaboom'));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"500s.test.js","skipped":false,"dir":"test"},{"name":"custom 500","suites":[],"updatePoint":{"line":31,"column":16,"index":657},"line":31,"code":"test('custom 500', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send(new Error('kaboom'));\n  });\n  fastify.setErrorHandler(function (err, request, reply) {\n    t.type(request, 'object');\n    t.type(request, fastify[symbols.kRequest]);\n    reply.code(500).type('text/plain').send('an error happened: ' + err.message);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-type'], 'text/plain');\n    t.same(res.payload.toString(), 'an error happened: kaboom');\n  });\n});","file":"500s.test.js","skipped":false,"dir":"test"},{"name":"encapsulated 500","suites":[],"updatePoint":{"line":52,"column":22,"index":1298},"line":52,"code":"test('encapsulated 500', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send(new Error('kaboom'));\n  });\n  fastify.register(function (f, opts, done) {\n    f.get('/', function (req, reply) {\n      reply.send(new Error('kaboom'));\n    });\n    f.setErrorHandler(function (err, request, reply) {\n      t.type(request, 'object');\n      t.type(request, f[symbols.kRequest]);\n      reply.code(500).type('text/plain').send('an error happened: ' + err.message);\n    });\n    done();\n  }, {\n    prefix: 'test'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-type'], 'text/plain');\n    t.same(res.payload.toString(), 'an error happened: kaboom');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"500s.test.js","skipped":false,"dir":"test"},{"name":"custom 500 with hooks","suites":[],"updatePoint":{"line":94,"column":27,"index":2461},"line":94,"code":"test('custom 500 with hooks', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send(new Error('kaboom'));\n  });\n  fastify.setErrorHandler(function (err, request, reply) {\n    reply.code(500).type('text/plain').send('an error happened: ' + err.message);\n  });\n  fastify.addHook('onSend', (req, res, payload, done) => {\n    t.ok('called', 'onSend');\n    done();\n  });\n  fastify.addHook('onRequest', (req, res, done) => {\n    t.ok('called', 'onRequest');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called', 'onResponse');\n    done();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-type'], 'text/plain');\n    t.same(res.payload.toString(), 'an error happened: kaboom');\n  });\n});","file":"500s.test.js","skipped":false,"dir":"test"},{"name":"cannot set errorHandler after binding","suites":[],"updatePoint":{"line":125,"column":43,"index":3367},"line":125,"code":"test('cannot set errorHandler after binding', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n\n    try {\n      fastify.setErrorHandler(() => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });\n});","file":"500s.test.js","skipped":false,"dir":"test"},{"name":"async await","suites":[],"updatePoint":{"line":33,"column":17,"index":537},"line":33,"code":"test('async await', t => {\n  t.plan(11);\n  const fastify = Fastify();\n\n  try {\n    fastify.get('/', opts, async function awaitMyFunc(req, reply) {\n      await sleep(200);\n      return {\n        hello: 'world'\n      };\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.get('/no-await', opts, async function (req, reply) {\n      return {\n        hello: 'world'\n      };\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no-await'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"ignore the result of the promise if reply.send is called beforehand (undefined)","suites":[],"updatePoint":{"line":87,"column":85,"index":1822},"line":87,"code":"test('ignore the result of the promise if reply.send is called beforehand (undefined)', t => {\n  t.plan(4);\n  const server = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  server.get('/', async function awaitMyFunc(req, reply) {\n    reply.send(payload);\n  });\n  t.teardown(server.close.bind(server));\n  server.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + server.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.same(payload, JSON.parse(body));\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"ignore the result of the promise if reply.send is called beforehand (object)","suites":[],"updatePoint":{"line":109,"column":82,"index":2420},"line":109,"code":"test('ignore the result of the promise if reply.send is called beforehand (object)', t => {\n  t.plan(4);\n  const server = Fastify();\n  const payload = {\n    hello: 'world2'\n  };\n  server.get('/', async function awaitMyFunc(req, reply) {\n    reply.send(payload);\n    return {\n      hello: 'world'\n    };\n  });\n  t.teardown(server.close.bind(server));\n  server.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + server.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.same(payload, JSON.parse(body));\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"server logs an error if reply.send is called and a value is returned via async/await","suites":[],"updatePoint":{"line":134,"column":90,"index":3068},"line":134,"code":"test('server logs an error if reply.send is called and a value is returned via async/await', t => {\n  const lines = ['incoming request', 'request completed', 'Reply already sent'];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.equal(line.msg, lines.shift());\n  });\n  const logger = pino(splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', async (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n    return {\n      hello: 'world2'\n    };\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"ignore the result of the promise if reply.send is called beforehand (undefined)","suites":[],"updatePoint":{"line":164,"column":85,"index":3806},"line":164,"code":"test('ignore the result of the promise if reply.send is called beforehand (undefined)', t => {\n  t.plan(4);\n  const server = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  server.get('/', async function awaitMyFunc(req, reply) {\n    reply.send(payload);\n  });\n  t.teardown(server.close.bind(server));\n  server.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + server.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.same(payload, JSON.parse(body));\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"ignore the result of the promise if reply.send is called beforehand (object)","suites":[],"updatePoint":{"line":186,"column":82,"index":4404},"line":186,"code":"test('ignore the result of the promise if reply.send is called beforehand (object)', t => {\n  t.plan(4);\n  const server = Fastify();\n  const payload = {\n    hello: 'world2'\n  };\n  server.get('/', async function awaitMyFunc(req, reply) {\n    reply.send(payload);\n    return {\n      hello: 'world'\n    };\n  });\n  t.teardown(server.close.bind(server));\n  server.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + server.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.same(payload, JSON.parse(body));\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"await reply if we will be calling reply.send in the future","suites":[],"updatePoint":{"line":211,"column":64,"index":5026},"line":211,"code":"test('await reply if we will be calling reply.send in the future', t => {\n  const lines = ['incoming request', 'request completed'];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.equal(line.msg, lines.shift());\n  });\n  const server = Fastify({\n    logger: {\n      stream: splitStream\n    }\n  });\n  const payload = {\n    hello: 'world'\n  };\n  server.get('/', async function awaitMyFunc(req, reply) {\n    setImmediate(function () {\n      reply.send(payload);\n    });\n    await reply;\n  });\n  server.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"await reply if we will be calling reply.send in the future (error case)","suites":[],"updatePoint":{"line":243,"column":77,"index":5786},"line":243,"code":"test('await reply if we will be calling reply.send in the future (error case)', t => {\n  const lines = ['incoming request', 'kaboom', 'request completed'];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.equal(line.msg, lines.shift());\n  });\n  const server = Fastify({\n    logger: {\n      stream: splitStream\n    }\n  });\n  server.get('/', async function awaitMyFunc(req, reply) {\n    setImmediate(function () {\n      reply.send(new Error('kaboom'));\n    });\n    await reply;\n  });\n  server.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"support reply decorators with await","suites":[],"updatePoint":{"line":269,"column":41,"index":6426},"line":269,"code":"test('support reply decorators with await', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.decorateReply('wow', function () {\n    setImmediate(() => {\n      this.send({\n        hello: 'world'\n      });\n    });\n  });\n  fastify.get('/', async (req, reply) => {\n    await sleep(1);\n    reply.wow();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"support 204","suites":[],"updatePoint":{"line":294,"column":17,"index":6912},"line":294,"code":"test('support 204', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    reply.code(204);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 204);\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"inject async await","suites":[],"updatePoint":{"line":308,"column":24,"index":7192},"line":308,"code":"test('inject async await', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n\n  try {\n    const res = await fastify.inject({\n      method: 'GET',\n      url: '/'\n    });\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res.payload));\n  } catch (err) {\n    t.fail(err);\n  }\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"inject async await - when the server equal up","suites":[],"updatePoint":{"line":329,"column":51,"index":7592},"line":329,"code":"test('inject async await - when the server equal up', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n\n  try {\n    const res = await fastify.inject({\n      method: 'GET',\n      url: '/'\n    });\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res.payload));\n  } catch (err) {\n    t.fail(err);\n  }\n\n  await sleep(200);\n\n  try {\n    const res2 = await fastify.inject({\n      method: 'GET',\n      url: '/'\n    });\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res2.payload));\n  } catch (err) {\n    t.fail(err);\n  }\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"async await plugin","suites":[],"updatePoint":{"line":364,"column":24,"index":8186},"line":364,"code":"test('async await plugin', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.register(async (fastify, opts) => {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    await sleep(200);\n  });\n\n  try {\n    const res = await fastify.inject({\n      method: 'GET',\n      url: '/'\n    });\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res.payload));\n  } catch (err) {\n    t.fail(err);\n  }\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"does not call reply.send() twice if 204 response equal already sent","suites":[],"updatePoint":{"line":388,"column":73,"index":8692},"line":388,"code":"test('does not call reply.send() twice if 204 response equal already sent', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    reply.code(204).send();\n\n    reply.send = () => {\n      throw new Error('reply.send() was called twice');\n    };\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 204);\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"error is logged because promise was fulfilled with undefined","suites":[],"updatePoint":{"line":406,"column":66,"index":9110},"line":406,"code":"test('error is logged because promise was fulfilled with undefined', t => {\n  t.plan(3);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'error'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/', async (req, reply) => {\n    reply.code(200);\n  });\n  stream.once('data', line => {\n    t.equal(line.msg, 'Promise may not be fulfilled with \\'undefined\\' when statusCode is not 204');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/',\n      timeout: 500\n    }, (err, res, body) => {\n      t.equal(err.message, 'Request timed out');\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"error is not logged because promise was fulfilled with undefined but statusCode 204 was set","suites":[],"updatePoint":{"line":441,"column":97,"index":9971},"line":441,"code":"test('error is not logged because promise was fulfilled with undefined but statusCode 204 was set', t => {\n  t.plan(3);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'error'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/', async (req, reply) => {\n    reply.code(204);\n  });\n  stream.once('data', line => {\n    t.fail('should not log an error');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.equal(res.statusCode, 204);\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"error is not logged because promise was fulfilled with undefined but response was sent before promise resolution","suites":[],"updatePoint":{"line":476,"column":118,"index":10778},"line":476,"code":"test('error is not logged because promise was fulfilled with undefined but response was sent before promise resolution', t => {\n  t.plan(4);\n  let fastify = null;\n  const stream = split(JSON.parse);\n  const payload = {\n    hello: 'world'\n  };\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'error'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/', async (req, reply) => {\n    reply.send(payload);\n  });\n  stream.once('data', line => {\n    t.fail('should not log an error');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/'\n    }, (err, res, body) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n      t.same(payload, JSON.parse(body));\n    });\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"Thrown Error instance sets HTTP status code","suites":[],"updatePoint":{"line":515,"column":49,"index":11605},"line":515,"code":"test('Thrown Error instance sets HTTP status code', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  err.statusCode = 418;\n  fastify.get('/', async (req, reply) => {\n    throw err;\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same({\n      error: statusCodes['418'],\n      message: err.message,\n      statusCode: 418\n    }, JSON.parse(res.payload));\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"customErrorHandler support","suites":[],"updatePoint":{"line":536,"column":32,"index":12089},"line":536,"code":"test('customErrorHandler support', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    const error = new Error('ouch');\n    error.statusCode = 400;\n    throw error;\n  });\n  fastify.setErrorHandler(async err => {\n    t.equal(err.message, 'ouch');\n    const error = new Error('kaboom');\n    error.statusCode = 401;\n    throw error;\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 401);\n    t.same({\n      error: statusCodes['401'],\n      message: 'kaboom',\n      statusCode: 401\n    }, JSON.parse(res.payload));\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"customErrorHandler support without throwing","suites":[],"updatePoint":{"line":563,"column":49,"index":12746},"line":563,"code":"test('customErrorHandler support without throwing', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    const error = new Error('ouch');\n    error.statusCode = 400;\n    throw error;\n  });\n  fastify.setErrorHandler(async (err, req, reply) => {\n    t.equal(err.message, 'ouch');\n    reply.code(401).send('kaboom');\n    reply.send = t.fail.bind(t, 'should not be called');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 401);\n    t.same('kaboom', res.payload);\n  });\n}); // See https://github.com/fastify/fastify/issues/2653","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"customErrorHandler only called if reply not already sent","suites":[],"updatePoint":{"line":586,"column":62,"index":13403},"line":586,"code":"test('customErrorHandler only called if reply not already sent', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    await reply.send('success');\n    const error = new Error('ouch');\n    error.statusCode = 400;\n    throw error;\n  });\n  fastify.setErrorHandler(t.fail.bind(t, 'should not be called'));\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same('success', res.payload);\n  });\n}); // See https://github.com/fastify/fastify/issues/3209","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"setNotFoundHandler should accept return value","suites":[],"updatePoint":{"line":606,"column":51,"index":13962},"line":606,"code":"test('setNotFoundHandler should accept return value', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', async () => ({\n    hello: 'world'\n  }));\n  fastify.setNotFoundHandler((req, reply) => {\n    reply.code(404);\n    return {\n      error: statusCodes['404'],\n      message: 'lost',\n      statusCode: 404\n    };\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/elsewhere'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n    t.same({\n      error: statusCodes['404'],\n      message: 'lost',\n      statusCode: 404\n    }, JSON.parse(res.payload));\n  });\n}); // See https://github.com/fastify/fastify/issues/3209","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"customErrorHandler should accept return value","suites":[],"updatePoint":{"line":634,"column":51,"index":14619},"line":634,"code":"test('customErrorHandler should accept return value', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', async (req, reply) => {\n    const error = new Error('ouch');\n    error.statusCode = 400;\n    throw error;\n  });\n  fastify.setErrorHandler((err, req, reply) => {\n    t.equal(err.message, 'ouch');\n    reply.code(401);\n    return {\n      error: statusCodes['401'],\n      message: 'kaboom',\n      statusCode: 401\n    };\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 401);\n    t.same({\n      error: statusCodes['401'],\n      message: 'kaboom',\n      statusCode: 401\n    }, JSON.parse(res.payload));\n  });\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"await self","suites":[],"updatePoint":{"line":664,"column":16,"index":15288},"line":664,"code":"test('await self', async t => {\n  const app = Fastify();\n  t.equal(await app, app);\n});","file":"async-await.test.js","skipped":false,"dir":"test"},{"name":"bodyLimit","suites":[],"updatePoint":{"line":10,"column":15,"index":155},"line":10,"code":"test('bodyLimit', t => {\n  t.plan(5);\n\n  try {\n    Fastify({\n      bodyLimit: 1.3\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  try {\n    Fastify({\n      bodyLimit: []\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  const fastify = Fastify({\n    bodyLimit: 1\n  });\n  fastify.post('/', (request, reply) => {\n    reply.send({\n      error: 'handler should not be called'\n    });\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: [],\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 413);\n    });\n  });\n});","file":"bodyLimit.test.js","skipped":false,"dir":"test"},{"name":"Bundled package should work","suites":[],"updatePoint":{"line":11,"column":33,"index":206},"line":11,"code":"test('Bundled package should work', t => {\n  t.plan(4);\n  fastifySuccess.ready(err => {\n    t.error(err);\n    fastifySuccess.inject({\n      method: 'GET',\n      url: '/'\n    }, (error, res) => {\n      t.error(error);\n      t.equal(res.statusCode, 200);\n      t.same(res.json(), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"bundler/esbuild/bundler-test.js","skipped":false,"dir":"test"},{"name":"Bundled package should not work with bad plugin version","suites":[],"updatePoint":{"line":27,"column":61,"index":565},"line":27,"code":"test('Bundled package should not work with bad plugin version', t => {\n  t.plan(1);\n  fastifyFailPlugin.ready(err => {\n    t.match(err.message, /expected '9.x' fastify version/i);\n  });\n});","file":"bundler/esbuild/bundler-test.js","skipped":false,"dir":"test"},{"name":"Bundled package should work","suites":[],"updatePoint":{"line":11,"column":33,"index":206},"line":11,"code":"test('Bundled package should work', t => {\n  t.plan(4);\n  fastifySuccess.ready(err => {\n    t.error(err);\n    fastifySuccess.inject({\n      method: 'GET',\n      url: '/'\n    }, (error, res) => {\n      t.error(error);\n      t.equal(res.statusCode, 200);\n      t.same(res.json(), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"bundler/webpack/bundler-test.js","skipped":false,"dir":"test"},{"name":"Bundled package should not work with bad plugin version","suites":[],"updatePoint":{"line":27,"column":61,"index":565},"line":27,"code":"test('Bundled package should not work with bad plugin version', t => {\n  t.plan(1);\n  fastifyFailPlugin.ready(err => {\n    t.match(err.message, /expected '9.x' fastify version/i);\n  });\n});","file":"bundler/webpack/bundler-test.js","skipped":false,"dir":"test"},{"name":"case insensitive","suites":[],"updatePoint":{"line":11,"column":22,"index":163},"line":11,"code":"test('case insensitive', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    caseSensitive: false\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/foo', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/FOO'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"case-insensitive.test.js","skipped":false,"dir":"test"},{"name":"case insensitive inject","suites":[],"updatePoint":{"line":36,"column":29,"index":739},"line":36,"code":"test('case insensitive inject', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    caseSensitive: false\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/foo', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/FOO'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(response.payload), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"case-insensitive.test.js","skipped":false,"dir":"test"},{"name":"case insensitive (parametric)","suites":[],"updatePoint":{"line":61,"column":35,"index":1337},"line":61,"code":"test('case insensitive (parametric)', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    caseSensitive: false\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/foo/:param', (req, reply) => {\n    t.equal(req.params.param, 'bAr');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/FoO/bAr'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"case-insensitive.test.js","skipped":false,"dir":"test"},{"name":"case insensitive (wildcard)","suites":[],"updatePoint":{"line":87,"column":33,"index":1966},"line":87,"code":"test('case insensitive (wildcard)', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    caseSensitive: false\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/foo/*', (req, reply) => {\n    t.equal(req.params['*'], 'bAr/baZ');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/FoO/bAr/baZ'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"case-insensitive.test.js","skipped":false,"dir":"test"},{"name":"chainable - get","suites":[],"updatePoint":{"line":25,"column":21,"index":337},"line":25,"code":"test('chainable - get', t => {\n  t.plan(1);\n  t.type(fastify.get('/', opts, noop), fastify);\n});","file":"chainable.test.js","skipped":false,"dir":"test"},{"name":"chainable - post","suites":[],"updatePoint":{"line":29,"column":22,"index":435},"line":29,"code":"test('chainable - post', t => {\n  t.plan(1);\n  t.type(fastify.post('/', opts, noop), fastify);\n});","file":"chainable.test.js","skipped":false,"dir":"test"},{"name":"chainable - route","suites":[],"updatePoint":{"line":33,"column":23,"index":535},"line":33,"code":"test('chainable - route', t => {\n  t.plan(1);\n  t.type(fastify.route({\n    method: 'GET',\n    url: '/other',\n    schema: opts.schema,\n    handler: noop\n  }), fastify);\n});","file":"chainable.test.js","skipped":false,"dir":"test"},{"name":"Should return 503 while closing - pipelining","suites":[],"updatePoint":{"line":13,"column":50,"index":188},"line":13,"code":"test('Should return 503 while closing - pipelining', t => {\n  const fastify = Fastify({\n    return503OnClosing: true\n  });\n  fastify.get('/', (req, reply) => {\n    fastify.close();\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, async err => {\n    t.error(err);\n    const instance = new Client('http://localhost:' + fastify.server.address().port, {\n      pipelining: 1\n    });\n    const codes = [200, 503];\n\n    for (const code of codes) {\n      instance.request({\n        path: '/',\n        method: 'GET'\n      }).then(data => {\n        t.equal(data.statusCode, code);\n      }).catch(e => {\n        t.fail(e);\n      });\n    }\n\n    instance.close(() => {\n      t.end('Done');\n    });\n  });\n});","file":"close-pipelining.test.js","skipped":false,"dir":"test"},{"name":"Should not return 503 while closing - pipelining - return503OnClosing","suites":[],"updatePoint":{"line":46,"column":75,"index":931},"line":46,"code":"test('Should not return 503 while closing - pipelining - return503OnClosing', t => {\n  const fastify = Fastify({\n    return503OnClosing: false\n  });\n  fastify.get('/', (req, reply) => {\n    fastify.close();\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    const instance = new Client('http://localhost:' + fastify.server.address().port, {\n      pipelining: 1\n    });\n    const codes = [200, 200];\n\n    for (const code of codes) {\n      instance.request({\n        path: '/',\n        method: 'GET'\n      }).then(data => {\n        t.equal(data.statusCode, code);\n      }).catch(e => {\n        t.fail(e);\n      });\n    }\n\n    instance.close(() => {\n      t.end('Done');\n    });\n  });\n});","file":"close-pipelining.test.js","skipped":false,"dir":"test"},{"name":"close callback","suites":[],"updatePoint":{"line":15,"column":20,"index":187},"line":15,"code":"test('close callback', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onClose', onClose);\n\n  function onClose(instance, done) {\n    t.type(fastify, instance);\n    done();\n  }\n\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close(err => {\n      t.error(err);\n      t.ok('close callback');\n    });\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"inside register","suites":[],"updatePoint":{"line":33,"column":21,"index":527},"line":33,"code":"test('inside register', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register(function (f, opts, done) {\n    f.addHook('onClose', onClose);\n\n    function onClose(instance, done) {\n      t.ok(instance.prototype === fastify.prototype);\n      t.equal(instance, f);\n      done();\n    }\n\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close(err => {\n      t.error(err);\n      t.ok('close callback');\n    });\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"close order","suites":[],"updatePoint":{"line":55,"column":17,"index":980},"line":55,"code":"test('close order', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  const order = [1, 2, 3];\n  fastify.register(function (f, opts, done) {\n    f.addHook('onClose', (instance, done) => {\n      t.equal(order.shift(), 1);\n      done();\n    });\n    done();\n  });\n  fastify.addHook('onClose', (instance, done) => {\n    t.equal(order.shift(), 2);\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close(err => {\n      t.error(err);\n      t.equal(order.shift(), 3);\n    });\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"close order - async","suites":[],"updatePoint":{"line":78,"column":25,"index":1495},"line":78,"code":"test('close order - async', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const order = [1, 2, 3];\n  fastify.register(function (f, opts, done) {\n    f.addHook('onClose', async instance => {\n      t.equal(order.shift(), 1);\n    });\n    done();\n  });\n  fastify.addHook('onClose', () => {\n    t.equal(order.shift(), 2);\n  });\n  await fastify.listen(0);\n  await fastify.close();\n  t.equal(order.shift(), 3);\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"should not throw an error if the server is not listening","suites":[],"updatePoint":{"line":95,"column":62,"index":1951},"line":95,"code":"test('should not throw an error if the server is not listening', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addHook('onClose', onClose);\n\n  function onClose(instance, done) {\n    t.type(fastify, instance);\n    done();\n  }\n\n  fastify.close(err => {\n    t.error(err);\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"onClose should keep the context","suites":[],"updatePoint":{"line":109,"column":37,"index":2218},"line":109,"code":"test('onClose should keep the context', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(plugin);\n\n  function plugin(instance, opts, done) {\n    instance.decorate('test', true);\n    instance.addHook('onClose', onClose);\n    t.ok(instance.prototype === fastify.prototype);\n\n    function onClose(i, done) {\n      t.ok(i.test);\n      t.equal(i, instance);\n      done();\n    }\n\n    done();\n  }\n\n  fastify.close(err => {\n    t.error(err);\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"Should return error while closing (promise) - injection","suites":[],"updatePoint":{"line":132,"column":61,"index":2705},"line":132,"code":"test('Should return error while closing (promise) - injection', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onClose', (instance, done) => {\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    fastify.close();\n    process.nextTick(() => {\n      fastify.inject({\n        method: 'GET',\n        url: '/'\n      }).catch(err => {\n        t.ok(err);\n        t.equal(err.message, 'Server is closed');\n      });\n    }, 100);\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"Should return error while closing (callback) - injection","suites":[],"updatePoint":{"line":161,"column":62,"index":3340},"line":161,"code":"test('Should return error while closing (callback) - injection', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onClose', (instance, done) => {\n    setTimeout(done, 150);\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    fastify.close();\n    setTimeout(() => {\n      fastify.inject({\n        method: 'GET',\n        url: '/'\n      }, (err, res) => {\n        t.ok(err);\n        t.equal(err.message, 'Server is closed');\n      });\n    }, 100);\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"Cannot be reopened the closed server without listen callback","suites":[],"updatePoint":{"line":251,"column":66,"index":5695},"line":251,"code":"test('Cannot be reopened the closed server without listen callback', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  await fastify.listen(0);\n  await fastify.close();\n\n  try {\n    await fastify.listen(0);\n  } catch (err) {\n    t.ok(err);\n    t.equal(err.code, 'FST_ERR_REOPENED_CLOSE_SERVER');\n  }\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"Cannot be reopened the closed server has listen callback","suites":[],"updatePoint":{"line":264,"column":62,"index":6002},"line":264,"code":"test('Cannot be reopened the closed server has listen callback', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  await fastify.listen(0);\n  await fastify.close();\n  await new Promise((resolve, reject) => {\n    fastify.listen(0, err => {\n      reject(err);\n    });\n  }).catch(err => {\n    t.equal(err.code, 'FST_ERR_REOPENED_CLOSE_SERVER');\n    t.ok(err);\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"shutsdown while keep-alive connections are active (non-async)","suites":[],"updatePoint":{"line":278,"column":67,"index":6381},"line":278,"code":"test('shutsdown while keep-alive connections are active (non-async)', t => {\n  t.plan(5);\n  const timeoutTime = 2 * 60 * 1000;\n  const fastify = Fastify({\n    forceCloseConnections: true\n  });\n  fastify.server.setTimeout(timeoutTime);\n  fastify.server.keepAliveTimeout = timeoutTime;\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    const client = new Client('http://localhost:' + fastify.server.address().port, {\n      keepAliveTimeout: 1 * 60 * 1000\n    });\n    client.request({\n      path: '/',\n      method: 'GET'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(client.closed, false);\n      fastify.close(err => {\n        t.error(err); // Due to the nature of the way we reap these keep-alive connections,\n        // there hasn't been enough time before the server fully closed in order\n        // for the client to have seen the socket get destroyed. The mere fact\n        // that we have reached this callback is enough indication that the\n        // feature being tested works as designed.\n\n        t.equal(client.closed, false);\n      });\n    });\n  });\n});","file":"close.test.js","skipped":false,"dir":"test"},{"name":"connectionTimeout","suites":[],"updatePoint":{"line":10,"column":23,"index":150},"line":10,"code":"test('connectionTimeout', t => {\n  t.plan(6);\n\n  try {\n    Fastify({\n      connectionTimeout: 1.3\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  try {\n    Fastify({\n      connectionTimeout: []\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  const httpServer = Fastify({\n    connectionTimeout: 1\n  }).server;\n  t.equal(httpServer.timeout, 1);\n  const httpsServer = Fastify({\n    connectionTimeout: 2,\n    https: {}\n  }).server;\n  t.equal(httpsServer.timeout, 2);\n  const http2Server = Fastify({\n    connectionTimeout: 3,\n    http2: true\n  }).server;\n  t.equal(http2Server.timeout, 3);\n\n  const serverFactory = (handler, _) => {\n    const server = http.createServer((req, res) => {\n      handler(req, res);\n    });\n    server.setTimeout(5);\n    return server;\n  };\n\n  const customServer = Fastify({\n    connectionTimeout: 4,\n    serverFactory\n  }).server;\n  t.equal(customServer.timeout, 5);\n});","file":"connectionTimeout.test.js","skipped":false,"dir":"test"},{"name":"Should register a host constrained route","suites":[],"updatePoint":{"line":9,"column":46,"index":151},"line":9,"code":"test('Should register a host constrained route', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'example.com'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should register the same route with host constraints","suites":[],"updatePoint":{"line":55,"column":58,"index":1014},"line":55,"code":"test('Should register the same route with host constraints', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.send('fastify.io');\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'example.com'\n    },\n    handler: (req, reply) => {\n      reply.send('example.com');\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'fastify.io');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'example.com'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'example.com');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'fancy.ca'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should allow registering custom constrained routes","suites":[],"updatePoint":{"line":111,"column":56,"index":2093},"line":111,"code":"test('Should allow registering custom constrained routes', t => {\n  t.plan(8);\n  const constraint = {\n    name: 'secret',\n    storage: function () {\n      let secrets = {};\n      return {\n        get: secret => {\n          return secrets[secret] || null;\n        },\n        set: (secret, store) => {\n          secrets[secret] = store;\n        },\n        del: secret => {\n          delete secrets[secret];\n        },\n        empty: () => {\n          secrets = {};\n        }\n      };\n    },\n    deriveConstraint: (req, ctx) => {\n      return req.headers['x-secret'];\n    },\n\n    validate() {\n      return true;\n    }\n\n  };\n  const fastify = Fastify({\n    constraints: {\n      secret: constraint\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      secret: 'alpha'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from alpha'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      secret: 'beta'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from beta'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'X-Secret': 'alpha'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from alpha'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'X-Secret': 'beta'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from beta'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'X-Secret': 'gamma'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should allow registering an unconstrained route after a constrained route","suites":[],"updatePoint":{"line":207,"column":79,"index":3897},"line":207,"code":"test('Should allow registering an unconstrained route after a constrained route', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from fastify.io'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from any other domain'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from fastify.io'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      host: 'example.com'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from any other domain'\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should allow registering constrained routes in a prefixed plugin","suites":[],"updatePoint":{"line":258,"column":70,"index":4907},"line":258,"code":"test('Should allow registering constrained routes in a prefixed plugin', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register(async (scope, opts) => {\n    scope.route({\n      method: 'GET',\n      constraints: {\n        host: 'fastify.io'\n      },\n      path: '/route',\n      handler: (req, reply) => {\n        reply.send({\n          ok: true\n        });\n      }\n    });\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/route',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      ok: true\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should allow registering a constrained GET route after a constrained HEAD route","suites":[],"updatePoint":{"line":291,"column":85,"index":5596},"line":291,"code":"test('Should allow registering a constrained GET route after a constrained HEAD route', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'HEAD',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.header('content-type', 'text/plain');\n      reply.send('custom HEAD response');\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from any other domain'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'custom HEAD response');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Should allow registering a constrained GET route after an unconstrained HEAD route","suites":[],"updatePoint":{"line":329,"column":88,"index":6418},"line":329,"code":"test('Should allow registering a constrained GET route after an unconstrained HEAD route', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'HEAD',\n    url: '/',\n    handler: (req, reply) => {\n      reply.header('content-type', 'text/plain');\n      reply.send('custom HEAD response');\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      host: 'fastify.io'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from any other domain'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/',\n    headers: {\n      host: 'fastify.io'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'custom HEAD response');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"Will not try to re-createprefixed HEAD route if it already exists and exposeHeadRoutes is true for constrained routes","suites":[],"updatePoint":{"line":364,"column":123,"index":7224},"line":364,"code":"test('Will not try to re-createprefixed HEAD route if it already exists and exposeHeadRoutes is true for constrained routes', async t => {\n  t.plan(1);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.register((scope, opts, next) => {\n    scope.route({\n      method: 'HEAD',\n      path: '/route',\n      constraints: {\n        host: 'fastify.io'\n      },\n      handler: (req, reply) => {\n        reply.header('content-type', 'text/plain');\n        reply.send('custom HEAD response');\n      }\n    });\n    scope.route({\n      method: 'GET',\n      path: '/route',\n      constraints: {\n        host: 'fastify.io'\n      },\n      handler: (req, reply) => {\n        reply.send({\n          ok: true\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  await fastify.ready();\n  t.ok(true);\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"allows separate constrained and unconstrained HEAD routes","suites":[],"updatePoint":{"line":400,"column":63,"index":7994},"line":400,"code":"test('allows separate constrained and unconstrained HEAD routes', async t => {\n  t.plan(1);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.register((scope, opts, next) => {\n    scope.route({\n      method: 'HEAD',\n      path: '/route',\n      handler: (req, reply) => {\n        reply.header('content-type', 'text/plain');\n        reply.send('unconstrained HEAD response');\n      }\n    });\n    scope.route({\n      method: 'HEAD',\n      path: '/route',\n      constraints: {\n        host: 'fastify.io'\n      },\n      handler: (req, reply) => {\n        reply.header('content-type', 'text/plain');\n        reply.send('constrained HEAD response');\n      }\n    });\n    scope.route({\n      method: 'GET',\n      path: '/route',\n      constraints: {\n        host: 'fastify.io'\n      },\n      handler: (req, reply) => {\n        reply.send({\n          ok: true\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  await fastify.ready();\n  t.ok(true);\n});","file":"constrained-routes.test.js","skipped":false,"dir":"test"},{"name":"default 413 with bodyLimit option","suites":[],"updatePoint":{"line":9,"column":39,"index":136},"line":9,"code":"test('default 413 with bodyLimit option', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    bodyLimit: 10\n  });\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 413);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Payload Too Large',\n      code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n      message: 'Request body is too large',\n      statusCode: 413\n    });\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"default 400 with wrong content-length","suites":[],"updatePoint":{"line":37,"column":43,"index":834},"line":37,"code":"test('default 400 with wrong content-length', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    headers: {\n      'content-length': 20\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      code: 'FST_ERR_CTP_INVALID_CONTENT_LENGTH',\n      message: 'Request body size did not match Content-Length',\n      statusCode: 400\n    });\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"custom 413 with bodyLimit option","suites":[],"updatePoint":{"line":66,"column":38,"index":1576},"line":66,"code":"test('custom 413 with bodyLimit option', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    bodyLimit: 10\n  });\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.setErrorHandler(function (err, request, reply) {\n    reply.code(err.statusCode).type('application/json; charset=utf-8').send(err);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 413);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Payload Too Large',\n      code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n      message: 'Request body is too large',\n      statusCode: 413\n    });\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"custom 400 with wrong content-length","suites":[],"updatePoint":{"line":97,"column":42,"index":2420},"line":97,"code":"test('custom 400 with wrong content-length', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.setErrorHandler(function (err, request, reply) {\n    reply.code(err.statusCode).type('application/json; charset=utf-8').send(err);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    headers: {\n      'content-length': 20\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      code: 'FST_ERR_CTP_INVALID_CONTENT_LENGTH',\n      message: 'Request body size did not match Content-Length',\n      statusCode: 400\n    });\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"#2214 - wrong content-length","suites":[],"updatePoint":{"line":129,"column":34,"index":3305},"line":129,"code":"test('#2214 - wrong content-length', t => {\n  const fastify = Fastify();\n  fastify.get('/', async () => {\n    const error = new Error('MY_ERROR_MESSAGE');\n    error.headers = {\n      'content-length': 2\n    };\n    throw error;\n  });\n  fastify.inject({\n    method: 'GET',\n    path: '/'\n  }).then(response => {\n    t.equal(response.headers['content-length'], '' + response.rawPayload.length);\n    t.end();\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"#2543 - wrong content-length with errorHandler","suites":[],"updatePoint":{"line":146,"column":52,"index":3737},"line":146,"code":"test('#2543 - wrong content-length with errorHandler', t => {\n  const fastify = Fastify();\n  fastify.setErrorHandler((_error, _request, reply) => {\n    reply.code(500).send({\n      message: 'longer than 2 bytes'\n    });\n  });\n  fastify.get('/', async () => {\n    const error = new Error('MY_ERROR_MESSAGE');\n    error.headers = {\n      'content-length': 2\n    };\n    throw error;\n  });\n  fastify.inject({\n    method: 'GET',\n    path: '/'\n  }).then(res => {\n    t.equal(res.statusCode, 500);\n    t.equal(res.headers['content-length'], '' + res.rawPayload.length);\n    t.same(JSON.parse(res.payload), {\n      message: 'longer than 2 bytes'\n    });\n    t.end();\n  });\n});","file":"content-length.test.js","skipped":false,"dir":"test"},{"name":"hasContentTypeParser","suites":[],"updatePoint":{"line":22,"column":26,"index":409},"line":22,"code":"test('hasContentTypeParser', t => {\n  test('should know about internal parsers', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    fastify.ready(err => {\n      t.error(err);\n      t.ok(fastify.hasContentTypeParser('application/json'));\n      t.ok(fastify.hasContentTypeParser('text/plain'));\n      t.notOk(fastify.hasContentTypeParser('application/jsoff'));\n    });\n  });\n  test('should work with string and RegExp', t => {\n    t.plan(7);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, first);\n    fastify.addContentTypeParser('image/gif', first);\n    t.ok(fastify.hasContentTypeParser('application/json'));\n    t.ok(fastify.hasContentTypeParser(/^image\\/.*/));\n    t.ok(fastify.hasContentTypeParser(/^application\\/.+\\+xml/));\n    t.ok(fastify.hasContentTypeParser('image/gif'));\n    t.notOk(fastify.hasContentTypeParser(/^image\\/.+\\+xml/));\n    t.notOk(fastify.hasContentTypeParser('image/png'));\n    t.notOk(fastify.hasContentTypeParser('*'));\n  });\n  t.end();\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should know about internal parsers","suites":[],"updatePoint":{"line":23,"column":42,"index":461},"line":23,"code":"  test('should know about internal parsers', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    fastify.ready(err => {\n      t.error(err);\n      t.ok(fastify.hasContentTypeParser('application/json'));\n      t.ok(fastify.hasContentTypeParser('text/plain'));\n      t.notOk(fastify.hasContentTypeParser('application/jsoff'));\n    });\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should work with string and RegExp","suites":[],"updatePoint":{"line":33,"column":42,"index":804},"line":33,"code":"  test('should work with string and RegExp', t => {\n    t.plan(7);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, first);\n    fastify.addContentTypeParser('image/gif', first);\n    t.ok(fastify.hasContentTypeParser('application/json'));\n    t.ok(fastify.hasContentTypeParser(/^image\\/.*/));\n    t.ok(fastify.hasContentTypeParser(/^application\\/.+\\+xml/));\n    t.ok(fastify.hasContentTypeParser('image/gif'));\n    t.notOk(fastify.hasContentTypeParser(/^image\\/.+\\+xml/));\n    t.notOk(fastify.hasContentTypeParser('image/png'));\n    t.notOk(fastify.hasContentTypeParser('*'));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"getParser","suites":[],"updatePoint":{"line":49,"column":15,"index":1469},"line":49,"code":"test('getParser', t => {\n  test('should return matching parser', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, second);\n    fastify.addContentTypeParser('text/html', third);\n    t.equal(fastify[keys.kContentTypeParser].getParser('application/t+xml').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/png').fn, first);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text/html').fn, third);\n  });\n  test('should prefer content type parser with string value', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser('image/gif', second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/gif').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/png').fn, first);\n  });\n  test('should return parser that catches all if no other is set', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.addContentTypeParser('*', first);\n    fastify.addContentTypeParser(/^text\\/.*/, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/gif').fn, first);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text/html').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text').fn, first);\n  });\n  test('should return undefined if no matching parser exist', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^weirdType\\/.+/, first);\n    fastify.addContentTypeParser('application/javascript', first);\n    t.notOk(fastify[keys.kContentTypeParser].getParser('application/xml'));\n    t.notOk(fastify[keys.kContentTypeParser].getParser('weirdType/'));\n  });\n  t.end();\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should return matching parser","suites":[],"updatePoint":{"line":50,"column":37,"index":1516},"line":50,"code":"  test('should return matching parser', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, second);\n    fastify.addContentTypeParser('text/html', third);\n    t.equal(fastify[keys.kContentTypeParser].getParser('application/t+xml').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/png').fn, first);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text/html').fn, third);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should prefer content type parser with string value","suites":[],"updatePoint":{"line":60,"column":59,"index":2062},"line":60,"code":"  test('should prefer content type parser with string value', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser('image/gif', second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/gif').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/png').fn, first);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should return parser that catches all if no other is set","suites":[],"updatePoint":{"line":68,"column":64,"index":2459},"line":68,"code":"  test('should return parser that catches all if no other is set', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.addContentTypeParser('*', first);\n    fastify.addContentTypeParser(/^text\\/.*/, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('image/gif').fn, first);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text/html').fn, second);\n    t.equal(fastify[keys.kContentTypeParser].getParser('text').fn, first);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should return undefined if no matching parser exist","suites":[],"updatePoint":{"line":77,"column":59,"index":2917},"line":77,"code":"  test('should return undefined if no matching parser exist', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^weirdType\\/.+/, first);\n    fastify.addContentTypeParser('application/javascript', first);\n    t.notOk(fastify[keys.kContentTypeParser].getParser('application/xml'));\n    t.notOk(fastify[keys.kContentTypeParser].getParser('weirdType/'));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"existingParser","suites":[],"updatePoint":{"line":87,"column":20,"index":3287},"line":87,"code":"test('existingParser', t => {\n  test('returns always false for \"*\"', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, first);\n    fastify.addContentTypeParser('text/html', first);\n    t.notOk(fastify[keys.kContentTypeParser].existingParser('*'));\n    fastify.addContentTypeParser('*', first);\n    t.notOk(fastify[keys.kContentTypeParser].existingParser('*'));\n  });\n  test('let you override the default parser once', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser('application/json', first);\n    fastify.addContentTypeParser('text/plain', first);\n    t.throws(() => fastify.addContentTypeParser('application/json', first), FST_ERR_CTP_ALREADY_PRESENT, \"Content type parser 'application/json' already present\");\n    t.throws(() => fastify.addContentTypeParser('text/plain', first), FST_ERR_CTP_ALREADY_PRESENT, \"Content type parser 'text/plain' already present\");\n  });\n  const fastify = Fastify();\n  const contentTypeParser = fastify[keys.kContentTypeParser];\n  fastify.addContentTypeParser(/^image\\/.*/, first);\n  fastify.addContentTypeParser(/^application\\/.+\\+xml/, first);\n  fastify.addContentTypeParser('text/html', first);\n  t.ok(contentTypeParser.existingParser(/^image\\/.*/));\n  t.ok(contentTypeParser.existingParser('text/html'));\n  t.ok(contentTypeParser.existingParser(/^application\\/.+\\+xml/));\n  t.notOk(contentTypeParser.existingParser('application/json'));\n  t.notOk(contentTypeParser.existingParser('text/plain'));\n  t.notOk(contentTypeParser.existingParser('image/png'));\n  t.notOk(contentTypeParser.existingParser(/^application\\/.+\\+json/));\n  t.end();\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"returns always false for \"*\"","suites":[],"updatePoint":{"line":88,"column":36,"index":3333},"line":88,"code":"  test('returns always false for \"*\"', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^image\\/.*/, first);\n    fastify.addContentTypeParser(/^application\\/.+\\+xml/, first);\n    fastify.addContentTypeParser('text/html', first);\n    t.notOk(fastify[keys.kContentTypeParser].existingParser('*'));\n    fastify.addContentTypeParser('*', first);\n    t.notOk(fastify[keys.kContentTypeParser].existingParser('*'));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"let you override the default parser once","suites":[],"updatePoint":{"line":98,"column":48,"index":3798},"line":98,"code":"  test('let you override the default parser once', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser('application/json', first);\n    fastify.addContentTypeParser('text/plain', first);\n    t.throws(() => fastify.addContentTypeParser('application/json', first), FST_ERR_CTP_ALREADY_PRESENT, \"Content type parser 'application/json' already present\");\n    t.throws(() => fastify.addContentTypeParser('text/plain', first), FST_ERR_CTP_ALREADY_PRESENT, \"Content type parser 'text/plain' already present\");\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"add","suites":[],"updatePoint":{"line":120,"column":9,"index":5007},"line":120,"code":"test('add', t => {\n  test('should only accept string and RegExp', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    t.error(contentTypeParser.add('test', {}, first));\n    t.error(contentTypeParser.add(/test/, {}, first));\n    t.throws(() => contentTypeParser.add({}, {}, first), FST_ERR_CTP_INVALID_TYPE, 'The content type should be a string or a RegExp');\n    t.throws(() => contentTypeParser.add(1, {}, first), FST_ERR_CTP_INVALID_TYPE, 'The content type should be a string or a RegExp');\n  });\n  test('should set \"*\" as parser that catches all', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.add('*', {}, first);\n    t.equal(contentTypeParser.customParsers[''].fn, first);\n  });\n  t.end();\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should only accept string and RegExp","suites":[],"updatePoint":{"line":121,"column":44,"index":5061},"line":121,"code":"  test('should only accept string and RegExp', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    t.error(contentTypeParser.add('test', {}, first));\n    t.error(contentTypeParser.add(/test/, {}, first));\n    t.throws(() => contentTypeParser.add({}, {}, first), FST_ERR_CTP_INVALID_TYPE, 'The content type should be a string or a RegExp');\n    t.throws(() => contentTypeParser.add(1, {}, first), FST_ERR_CTP_INVALID_TYPE, 'The content type should be a string or a RegExp');\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should set \"*\" as parser that catches all","suites":[],"updatePoint":{"line":130,"column":49,"index":5615},"line":130,"code":"  test('should set \"*\" as parser that catches all', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.add('*', {}, first);\n    t.equal(contentTypeParser.customParsers[''].fn, first);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"remove","suites":[],"updatePoint":{"line":139,"column":12,"index":5871},"line":139,"code":"test('remove', t => {\n  test('should remove default parser', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove('application/json');\n    t.notOk(contentTypeParser.customParsers['application/json']);\n    t.notOk(contentTypeParser.parserList.find(parser => parser === 'application/json'));\n  });\n  test('should remove RegExp parser', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^text\\/*/, first);\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove(/^text\\/*/);\n    t.notOk(contentTypeParser.customParsers[/^text\\/*/]);\n    t.notOk(contentTypeParser.parserRegExpList.find(parser => parser.toString() === /^text\\/*/.toString()));\n  });\n  test('should throw an error if content type is neither string nor RegExp', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.throws(() => fastify[keys.kContentTypeParser].remove(12), FST_ERR_CTP_INVALID_TYPE);\n  });\n  test('should not throw error if content type does not exist', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.doesNotThrow(() => fastify[keys.kContentTypeParser].remove('image/png'));\n  });\n  test('should not remove any content type parser if content type does not exist', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove('image/png');\n    t.same(Object.keys(contentTypeParser.customParsers).length, 2);\n  });\n  t.end();\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should remove default parser","suites":[],"updatePoint":{"line":140,"column":36,"index":5917},"line":140,"code":"  test('should remove default parser', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove('application/json');\n    t.notOk(contentTypeParser.customParsers['application/json']);\n    t.notOk(contentTypeParser.parserList.find(parser => parser === 'application/json'));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should remove RegExp parser","suites":[],"updatePoint":{"line":148,"column":35,"index":6283},"line":148,"code":"  test('should remove RegExp parser', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addContentTypeParser(/^text\\/*/, first);\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove(/^text\\/*/);\n    t.notOk(contentTypeParser.customParsers[/^text\\/*/]);\n    t.notOk(contentTypeParser.parserRegExpList.find(parser => parser.toString() === /^text\\/*/.toString()));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should throw an error if content type is neither string nor RegExp","suites":[],"updatePoint":{"line":157,"column":74,"index":6745},"line":157,"code":"  test('should throw an error if content type is neither string nor RegExp', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.throws(() => fastify[keys.kContentTypeParser].remove(12), FST_ERR_CTP_INVALID_TYPE);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should not throw error if content type does not exist","suites":[],"updatePoint":{"line":162,"column":61,"index":6959},"line":162,"code":"  test('should not throw error if content type does not exist', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.doesNotThrow(() => fastify[keys.kContentTypeParser].remove('image/png'));\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"should not remove any content type parser if content type does not exist","suites":[],"updatePoint":{"line":167,"column":80,"index":7181},"line":167,"code":"  test('should not remove any content type parser if content type does not exist', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    const contentTypeParser = fastify[keys.kContentTypeParser];\n    contentTypeParser.remove('image/png');\n    t.same(Object.keys(contentTypeParser.customParsers).length, 2);\n  });","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"remove all should remove all existing parsers and reset cache","suites":[],"updatePoint":{"line":176,"column":67,"index":7500},"line":176,"code":"test('remove all should remove all existing parsers and reset cache', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('application/xml', first);\n  fastify.addContentTypeParser(/^image\\/.*/, first);\n  const contentTypeParser = fastify[keys.kContentTypeParser];\n  contentTypeParser.getParser('application/xml'); // fill cache with one entry\n\n  contentTypeParser.removeAll();\n  t.same(contentTypeParser.cache.size, 0);\n  t.same(contentTypeParser.parserList.length, 0);\n  t.same(contentTypeParser.parserRegExpList.length, 0);\n  t.same(Object.keys(contentTypeParser.customParsers).length, 0);\n});","file":"content-parser.test.js","skipped":false,"dir":"test"},{"name":"config","suites":[],"updatePoint":{"line":21,"column":12,"index":266},"line":21,"code":"test('config', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.get('/get', {\n    schema: schema.schema,\n    config: Object.assign({}, schema.config)\n  }, handler);\n  fastify.route({\n    method: 'GET',\n    url: '/route',\n    schema: schema.schema,\n    handler,\n    config: Object.assign({}, schema.config)\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/no-config',\n    schema: schema.schema,\n    handler\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/get'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), Object.assign({\n      url: '/get',\n      method: 'GET'\n    }, schema.config));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/route'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), Object.assign({\n      url: '/route',\n      method: 'GET'\n    }, schema.config));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/no-config'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), {\n      url: '/no-config',\n      method: 'GET'\n    });\n  });\n});","file":"context-config.test.js","skipped":false,"dir":"test"},{"name":"config with exposeHeadRoutes","suites":[],"updatePoint":{"line":75,"column":34,"index":1494},"line":75,"code":"test('config with exposeHeadRoutes', t => {\n  t.plan(9);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.get('/get', {\n    schema: schema.schema,\n    config: Object.assign({}, schema.config)\n  }, handler);\n  fastify.route({\n    method: 'GET',\n    url: '/route',\n    schema: schema.schema,\n    handler,\n    config: Object.assign({}, schema.config)\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/no-config',\n    schema: schema.schema,\n    handler\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/get'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), Object.assign({\n      url: '/get',\n      method: 'GET'\n    }, schema.config));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/route'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), Object.assign({\n      url: '/route',\n      method: 'GET'\n    }, schema.config));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/no-config'\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), {\n      url: '/no-config',\n      method: 'GET'\n    });\n  });\n});","file":"context-config.test.js","skipped":false,"dir":"test"},{"name":"Should support a custom http server","suites":[],"updatePoint":{"line":13,"column":41,"index":213},"line":13,"code":"test('Should support a custom http server', t => {\n  t.plan(6);\n\n  const serverFactory = (handler, opts) => {\n    t.ok(opts.serverFactory);\n    const server = http.createServer((req, res) => {\n      req.custom = true;\n      handler(req, res);\n    });\n    return server;\n  };\n\n  const fastify = Fastify({\n    serverFactory\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/', (req, reply) => {\n    t.ok(req.raw.custom);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"custom-http-server.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add a custom async parser","suites":[],"updatePoint":{"line":12,"column":56,"index":244},"line":12,"code":"test('contentTypeParser should add a custom async parser', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.options('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', async function (req, payload) {\n    const res = await new Promise((resolve, reject) => resolve(payload));\n    return res;\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    t.test('in POST', t => {\n      t.plan(3);\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n    t.test('in OPTIONS', t => {\n      t.plan(3);\n      sget({\n        method: 'OPTIONS',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n  });\n});","file":"custom-parser-async.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add a custom async parser - deprecated syntax","suites":[],"updatePoint":{"line":64,"column":76,"index":1727},"line":64,"code":"test('contentTypeParser should add a custom async parser - deprecated syntax', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP003');\n  }\n\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.options('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', async function (req) {\n    const res = await new Promise((resolve, reject) => resolve(req));\n    return res;\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    t.test('in POST', t => {\n      t.plan(3);\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n    t.test('in OPTIONS', t => {\n      t.plan(3);\n      sget({\n        method: 'OPTIONS',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n        process.removeListener('warning', onWarning);\n      });\n    });\n  });\n});","file":"custom-parser-async.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser method should exist","suites":[],"updatePoint":{"line":49,"column":43,"index":854},"line":49,"code":"test('contentTypeParser method should exist', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.ok(fastify.addContentTypeParser);\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add a custom parser","suites":[],"updatePoint":{"line":54,"column":50,"index":998},"line":54,"code":"test('contentTypeParser should add a custom parser', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.options('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    t.test('in POST', t => {\n      t.plan(3);\n      sget({\n        method: 'POST',\n        url: getUrl(fastify),\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n    t.test('in OPTIONS', t => {\n      t.plan(3);\n      sget({\n        method: 'OPTIONS',\n        url: getUrl(fastify),\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add a custom parser - deprecated syntax","suites":[],"updatePoint":{"line":107,"column":70,"index":2391},"line":107,"code":"test('contentTypeParser should add a custom parser - deprecated syntax', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP003');\n  }\n\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.options('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', function (req, done) {\n    jsonParser(req, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    t.test('in POST', t => {\n      t.plan(3);\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n    t.test('in OPTIONS', t => {\n      t.plan(3);\n      sget({\n        method: 'OPTIONS',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/jsoff'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n      process.removeListener('warning', onWarning);\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should handle multiple custom parsers","suites":[],"updatePoint":{"line":168,"column":61,"index":4049},"line":168,"code":"test('contentTypeParser should handle multiple custom parsers', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.post('/hello', (req, reply) => {\n    reply.send(req.body);\n  });\n\n  function customParser(req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  }\n\n  fastify.addContentTypeParser('application/jsoff', customParser);\n  fastify.addContentTypeParser('application/ffosj', customParser);\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/hello',\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/ffosj'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should handle an array of custom contentTypes","suites":[],"updatePoint":{"line":219,"column":69,"index":5441},"line":219,"code":"test('contentTypeParser should handle an array of custom contentTypes', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.post('/hello', (req, reply) => {\n    reply.send(req.body);\n  });\n\n  function customParser(req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  }\n\n  fastify.addContentTypeParser(['application/jsoff', 'application/ffosj'], customParser);\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/hello',\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/ffosj'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should handle errors","suites":[],"updatePoint":{"line":269,"column":44,"index":6764},"line":269,"code":"test('contentTypeParser should handle errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', function (req, payload, done) {\n    done(new Error('kaboom!'), {});\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should support encapsulation","suites":[],"updatePoint":{"line":294,"column":52,"index":7446},"line":294,"code":"test('contentTypeParser should support encapsulation', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addContentTypeParser('application/jsoff', () => {});\n    t.ok(instance.hasContentTypeParser('application/jsoff'));\n    instance.register((instance, opts, done) => {\n      instance.addContentTypeParser('application/ffosj', () => {});\n      t.ok(instance.hasContentTypeParser('application/jsoff'));\n      t.ok(instance.hasContentTypeParser('application/ffosj'));\n      done();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.notOk(fastify.hasContentTypeParser('application/jsoff'));\n    t.notOk(fastify.hasContentTypeParser('application/ffosj'));\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should support encapsulation, second try","suites":[],"updatePoint":{"line":314,"column":64,"index":8204},"line":314,"code":"test('contentTypeParser should support encapsulation, second try', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.post('/', (req, reply) => {\n      reply.send(req.body);\n    });\n    instance.addContentTypeParser('application/jsoff', function (req, payload, done) {\n      jsonParser(payload, function (err, body) {\n        done(err, body);\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser shouldn't support request with undefined \"Content-Type\"","suites":[],"updatePoint":{"line":347,"column":80,"index":9120},"line":347,"code":"test('contentTypeParser shouldn\\'t support request with undefined \"Content-Type\"', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/jsoff', function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'unknown content type!',\n      headers: {// 'Content-Type': undefined\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 415);\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"the content type should be a string or RegExp","suites":[],"updatePoint":{"line":373,"column":51,"index":9831},"line":373,"code":"test('the content type should be a string or RegExp', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.addContentTypeParser(null, () => {});\n    t.fail();\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_INVALID_TYPE');\n    t.equal(err.message, 'The content type should be a string or a RegExp');\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"the content type cannot be an empty string","suites":[],"updatePoint":{"line":385,"column":48,"index":10158},"line":385,"code":"test('the content type cannot be an empty string', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.addContentTypeParser('', () => {});\n    t.fail();\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_EMPTY_TYPE');\n    t.equal(err.message, 'The content type cannot be an empty string');\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"the content type handler should be a function","suites":[],"updatePoint":{"line":397,"column":51,"index":10479},"line":397,"code":"test('the content type handler should be a function', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.addContentTypeParser('aaa', null);\n    t.fail();\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_INVALID_HANDLER');\n    t.equal(err.message, 'The content type handler should be a function');\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"catch all content type parser","suites":[],"updatePoint":{"line":409,"column":35,"index":10791},"line":409,"code":"test('catch all content type parser', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'hello');\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: 'hello',\n        headers: {\n          'Content-Type': 'very-weird-content-type'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), 'hello');\n        fastify.close();\n      });\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"catch all content type parser should not interfere with other conte type parsers","suites":[],"updatePoint":{"line":453,"column":86,"index":11989},"line":453,"code":"test('catch all content type parser should not interfere with other conte type parsers', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data);\n    });\n  });\n  fastify.addContentTypeParser('application/jsoff', function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: 'hello',\n        headers: {\n          'Content-Type': 'very-weird-content-type'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), 'hello');\n        fastify.close();\n      });\n    });\n  });\n}); // Issue 492 https://github.com/fastify/fastify/issues/492","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"'*' catch undefined Content-Type requests","suites":[],"updatePoint":{"line":505,"column":49,"index":13431},"line":505,"code":"test('\\'*\\' catch undefined Content-Type requests', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data);\n    });\n  });\n  fastify.post('/', (req, res) => {\n    // Needed to avoid json stringify\n    res.type('text/plain').send(req.body);\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    const fileStream = fs.createReadStream(__filename);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/',\n      body: fileStream\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body + '', fs.readFileSync(__filename).toString());\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"cannot add custom parser after binding","suites":[],"updatePoint":{"line":536,"column":44,"index":14327},"line":536,"code":"test('cannot add custom parser after binding', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (req, res) => {\n    res.type('text/plain').send(req.body);\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n\n    try {\n      fastify.addContentTypeParser('*', () => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Can override the default json parser","suites":[],"updatePoint":{"line":554,"column":42,"index":14732},"line":554,"code":"test('Can override the default json parser', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/json', function (req, payload, done) {\n    t.ok('called');\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '{\"hello\":\"world\"}');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Can override the default plain text parser","suites":[],"updatePoint":{"line":583,"column":48,"index":15523},"line":583,"code":"test('Can override the default plain text parser', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('text/plain', function (req, payload, done) {\n    t.ok('called');\n    plainTextParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello world',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'hello world');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Can override the default json parser in a plugin","suites":[],"updatePoint":{"line":612,"column":54,"index":16301},"line":612,"code":"test('Can override the default json parser in a plugin', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addContentTypeParser('application/json', function (req, payload, done) {\n      t.ok('called');\n      jsonParser(payload, function (err, body) {\n        done(err, body);\n      });\n    });\n    instance.post('/', (req, reply) => {\n      reply.send(req.body);\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '{\"hello\":\"world\"}');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Can't override the json parser multiple times","suites":[],"updatePoint":{"line":644,"column":52,"index":17181},"line":644,"code":"test('Can\\'t override the json parser multiple times', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('application/json', function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n\n  try {\n    fastify.addContentTypeParser('application/json', function (req, payload, done) {\n      t.ok('called');\n      jsonParser(payload, function (err, body) {\n        done(err, body);\n      });\n    });\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_ALREADY_PRESENT');\n    t.equal(err.message, 'Content type parser \\'application/json\\' already present.');\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Can't override the plain text parser multiple times","suites":[],"updatePoint":{"line":665,"column":58,"index":17833},"line":665,"code":"test('Can\\'t override the plain text parser multiple times', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('text/plain', function (req, payload, done) {\n    plainTextParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n\n  try {\n    fastify.addContentTypeParser('text/plain', function (req, payload, done) {\n      t.ok('called');\n      plainTextParser(payload, function (err, body) {\n        done(err, body);\n      });\n    });\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_ALREADY_PRESENT');\n    t.equal(err.message, 'Content type parser \\'text/plain\\' already present.');\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should get the body as string","suites":[],"updatePoint":{"line":686,"column":35,"index":18454},"line":686,"code":"test('Should get the body as string', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/json', {\n    parseAs: 'string'\n  }, function (req, body, done) {\n    t.ok('called');\n    t.ok(typeof body === 'string');\n\n    try {\n      const json = JSON.parse(body);\n      done(null, json);\n    } catch (err) {\n      err.statusCode = 400;\n      done(err, undefined);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '{\"hello\":\"world\"}');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should return defined body with no custom parser defined and content type = 'text/plain'","suites":[],"updatePoint":{"line":723,"column":96,"index":19431},"line":723,"code":"test('Should return defined body with no custom parser defined and content type = \\'text/plain\\'', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello world',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'hello world');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should have typeof body object with no custom parser defined, no body defined and content type = 'text/plain'","suites":[],"updatePoint":{"line":746,"column":117,"index":20086},"line":746,"code":"test('Should have typeof body object with no custom parser defined, no body defined and content type = \\'text/plain\\'', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(typeof body, 'object');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should have typeof body object with no custom parser defined, null body and content type = 'text/plain'","suites":[],"updatePoint":{"line":768,"column":111,"index":20699},"line":768,"code":"test('Should have typeof body object with no custom parser defined, null body and content type = \\'text/plain\\'', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: null,\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(typeof body, 'object');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should have typeof body object with no custom parser defined, undefined body and content type = 'text/plain'","suites":[],"updatePoint":{"line":791,"column":116,"index":21335},"line":791,"code":"test('Should have typeof body object with no custom parser defined, undefined body and content type = \\'text/plain\\'', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: undefined,\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(typeof body, 'object');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should get the body as string","suites":[],"updatePoint":{"line":814,"column":35,"index":21895},"line":814,"code":"test('Should get the body as string', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('text/plain', {\n    parseAs: 'string'\n  }, function (req, body, done) {\n    t.ok('called');\n    t.ok(typeof body === 'string');\n\n    try {\n      const plainText = body;\n      done(null, plainText);\n    } catch (err) {\n      err.statusCode = 400;\n      done(err, undefined);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello world',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'hello world');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should get the body as buffer","suites":[],"updatePoint":{"line":851,"column":35,"index":22785},"line":851,"code":"test('Should get the body as buffer', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/json', {\n    parseAs: 'buffer'\n  }, function (req, body, done) {\n    t.ok('called');\n    t.ok(body instanceof Buffer);\n\n    try {\n      const json = JSON.parse(body);\n      done(null, json);\n    } catch (err) {\n      err.statusCode = 400;\n      done(err, undefined);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '{\"hello\":\"world\"}');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should get the body as buffer","suites":[],"updatePoint":{"line":888,"column":35,"index":23699},"line":888,"code":"test('Should get the body as buffer', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('text/plain', {\n    parseAs: 'buffer'\n  }, function (req, body, done) {\n    t.ok('called');\n    t.ok(body instanceof Buffer);\n\n    try {\n      const plainText = body;\n      done(null, plainText);\n    } catch (err) {\n      err.statusCode = 400;\n      done(err, undefined);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello world',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'hello world');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should parse empty bodies as a string","suites":[],"updatePoint":{"line":925,"column":43,"index":24595},"line":925,"code":"test('Should parse empty bodies as a string', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('text/plain', {\n    parseAs: 'string'\n  }, (req, body, done) => {\n    t.equal(body, '');\n    done(null, body);\n  });\n  fastify.route({\n    method: ['POST', 'DELETE'],\n    url: '/',\n\n    handler(request, reply) {\n      reply.send(request.body);\n    }\n\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '');\n    });\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '',\n      headers: {\n        'Content-Type': 'text/plain',\n        'Content-Length': '0'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '');\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should parse empty bodies as a buffer","suites":[],"updatePoint":{"line":973,"column":43,"index":25724},"line":973,"code":"test('Should parse empty bodies as a buffer', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('text/plain', {\n    parseAs: 'buffer'\n  }, function (req, body, done) {\n    t.ok(body instanceof Buffer);\n    t.equal(body.length, 0);\n    done(null, body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.length, 0);\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"The charset should not interfere with the content type handling","suites":[],"updatePoint":{"line":1003,"column":69,"index":26498},"line":1003,"code":"test('The charset should not interfere with the content type handling', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('application/json', function (req, payload, done) {\n    t.ok('called');\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json charset=utf-8'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), '{\"hello\":\"world\"}');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Wrong parseAs parameter","suites":[],"updatePoint":{"line":1032,"column":29,"index":27284},"line":1032,"code":"test('Wrong parseAs parameter', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.addContentTypeParser('application/json', {\n      parseAs: 'fireworks'\n    }, () => {});\n    t.fail('should throw');\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_CTP_INVALID_PARSE_TYPE');\n    t.equal(err.message, \"The body parser can only parse your data as 'string' or 'buffer', you asked 'fireworks' which is not supported.\");\n  }\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Should allow defining the bodyLimit per parser","suites":[],"updatePoint":{"line":1046,"column":52,"index":27749},"line":1046,"code":"test('Should allow defining the bodyLimit per parser', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.teardown(() => fastify.close());\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('x/foo', {\n    parseAs: 'string',\n    bodyLimit: 5\n  }, function (req, body, done) {\n    t.fail('should not be invoked');\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '1234567890',\n      headers: {\n        'Content-Type': 'x/foo'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.strictSame(JSON.parse(body.toString()), {\n        statusCode: 413,\n        code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n        error: 'Payload Too Large',\n        message: 'Request body is too large'\n      });\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"route bodyLimit should take precedence over a custom parser bodyLimit","suites":[],"updatePoint":{"line":1081,"column":75,"index":28686},"line":1081,"code":"test('route bodyLimit should take precedence over a custom parser bodyLimit', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.teardown(() => fastify.close());\n  fastify.post('/', {\n    bodyLimit: 5\n  }, (request, reply) => {\n    reply.send(request.body);\n  });\n  fastify.addContentTypeParser('x/foo', {\n    parseAs: 'string',\n    bodyLimit: 100\n  }, function (req, body, done) {\n    t.fail('should not be invoked');\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '1234567890',\n      headers: {\n        'Content-Type': 'x/foo'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.strictSame(JSON.parse(body.toString()), {\n        statusCode: 413,\n        code: 'FST_ERR_CTP_BODY_TOO_LARGE',\n        error: 'Payload Too Large',\n        message: 'Request body is too large'\n      });\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"should be able to use default parser for extra content type","suites":[],"updatePoint":{"line":1118,"column":65,"index":29647},"line":1118,"code":"test('should be able to use default parser for extra content type', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  t.teardown(() => fastify.close());\n  fastify.post('/', (request, reply) => {\n    reply.send(request.body);\n  });\n  fastify.addContentTypeParser('text/json', {\n    parseAs: 'string'\n  }, fastify.getDefaultJsonParser('ignore', 'ignore'));\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'text/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.strictSame(JSON.parse(body.toString()), {\n        hello: 'world'\n      });\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add a custom parser with RegExp value","suites":[],"updatePoint":{"line":1147,"column":68,"index":30463},"line":1147,"code":"test('contentTypeParser should add a custom parser with RegExp value', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.options('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser(/.*\\+json$/, function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    t.test('in POST', t => {\n      t.plan(3);\n      sget({\n        method: 'POST',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'application/vnd.test+json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n    t.test('in OPTIONS', t => {\n      t.plan(3);\n      sget({\n        method: 'OPTIONS',\n        url: 'http://localhost:' + fastify.server.address().port,\n        body: '{\"hello\":\"world\"}',\n        headers: {\n          'Content-Type': 'weird-content-type+json'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), JSON.stringify({\n          hello: 'world'\n        }));\n      });\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"contentTypeParser should add multiple custom parsers with RegExp values","suites":[],"updatePoint":{"line":1200,"column":77,"index":31941},"line":1200,"code":"test('contentTypeParser should add multiple custom parsers with RegExp values', async t => {\n  t.plan(6);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser(/.*\\+json$/, function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.addContentTypeParser(/.*\\+xml$/, function (req, payload, done) {\n    done(null, 'xml');\n  });\n  fastify.addContentTypeParser(/.*\\+myExtension$/, function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data + 'myExtension');\n    });\n  });\n  await fastify.ready();\n  {\n    const response = await fastify.inject({\n      method: 'POST',\n      path: '/',\n      payload: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/vnd.hello+json'\n      }\n    });\n    t.equal(response.statusCode, 200);\n    t.same(response.payload.toString(), '{\"hello\":\"world\"}');\n  }\n  {\n    const response = await fastify.inject({\n      method: 'POST',\n      path: '/',\n      payload: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/test+xml'\n      }\n    });\n    t.equal(response.statusCode, 200);\n    t.same(response.payload.toString(), 'xml');\n  }\n  await fastify.inject({\n    method: 'POST',\n    path: '/',\n    payload: 'abcdefg',\n    headers: {\n      'Content-Type': 'application/+myExtension'\n    }\n  }).then(response => {\n    t.equal(response.statusCode, 200);\n    t.same(response.payload.toString(), 'abcdefgmyExtension');\n  }).catch(err => {\n    t.error(err);\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"catch all content type parser should not interfere with content type parser","suites":[],"updatePoint":{"line":1263,"column":81,"index":33667},"line":1263,"code":"test('catch all content type parser should not interfere with content type parser', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data);\n    });\n  });\n  fastify.addContentTypeParser(/^application\\/.*/, function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.addContentTypeParser('text/html', function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data + 'html');\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"myKey\":\"myValue\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        myKey: 'myValue'\n      }));\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'body',\n      headers: {\n        'Content-Type': 'very-weird-content-type'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'body');\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'my text',\n      headers: {\n        'Content-Type': 'text/html'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'my texthtml');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"should prefer string content types over RegExp ones","suites":[],"updatePoint":{"line":1335,"column":57,"index":35597},"line":1335,"code":"test('should prefer string content types over RegExp ones', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.addContentTypeParser(/^application\\/.*/, function (req, payload, done) {\n    let data = '';\n    payload.on('data', chunk => {\n      data += chunk;\n    });\n    payload.on('end', () => {\n      done(null, data);\n    });\n  });\n  fastify.addContentTypeParser('application/json', function (req, payload, done) {\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"k1\":\"myValue\", \"k2\": \"myValue\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        k1: 'myValue',\n        k2: 'myValue'\n      }));\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'javascript',\n      headers: {\n        'Content-Type': 'application/javascript'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'javascript');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"removeContentTypeParser should support arrays of content types to remove","suites":[],"updatePoint":{"line":1387,"column":78,"index":37042},"line":1387,"code":"test('removeContentTypeParser should support arrays of content types to remove', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('application/xml', function (req, payload, done) {\n    payload.on('data', () => {});\n    payload.on('end', () => {\n      done(null, 'xml');\n    });\n  });\n  fastify.addContentTypeParser(/^image\\/.*/, function (req, payload, done) {\n    payload.on('data', () => {});\n    payload.on('end', () => {\n      done(null, 'image');\n    });\n  });\n  fastify.removeContentTypeParser([/^image\\/.*/, 'application/json']);\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '<?xml version=\"1.0\">',\n      headers: {\n        'Content-Type': 'application/xml'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'xml');\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '',\n      headers: {\n        'Content-Type': 'image/png'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 415);\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{test: \"test\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 415);\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"removeContentTypeParser should support encapsulation","suites":[],"updatePoint":{"line":1445,"column":58,"index":38656},"line":1445,"code":"test('removeContentTypeParser should support encapsulation', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('application/xml', function (req, payload, done) {\n    payload.on('data', () => {});\n    payload.on('end', () => {\n      done(null, 'xml');\n    });\n  });\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.register(function (instance, options, done) {\n    instance.removeContentTypeParser('application/xml');\n    instance.post('/encapsulated', (req, reply) => {\n      reply.send(req.body);\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/encapsulated',\n      body: '<?xml version=\"1.0\">',\n      headers: {\n        'Content-Type': 'application/xml'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 415);\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '<?xml version=\"1.0\">',\n      headers: {\n        'Content-Type': 'application/xml'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'xml');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"removeAllContentTypeParsers should support encapsulation","suites":[],"updatePoint":{"line":1492,"column":62,"index":39987},"line":1492,"code":"test('removeAllContentTypeParsers should support encapsulation', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.register(function (instance, options, done) {\n    instance.removeAllContentTypeParsers();\n    instance.post('/encapsulated', (req, reply) => {\n      reply.send(req.body);\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/encapsulated',\n      body: '{}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 415);\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"test\":1}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body.toString()).test, 1);\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"cannot remove all content type parsers after binding","suites":[],"updatePoint":{"line":1533,"column":58,"index":41103},"line":1533,"code":"test('cannot remove all content type parsers after binding', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, function (err) {\n    t.error(err);\n    t.throws(() => fastify.removeAllContentTypeParsers());\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"cannot remove content type parsers after binding","suites":[],"updatePoint":{"line":1542,"column":54,"index":41376},"line":1542,"code":"test('cannot remove content type parsers after binding', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, function (err) {\n    t.error(err);\n    t.throws(() => fastify.removeContentTypeParser('application/json'));\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"should be able to override the default json parser after removeAllContentTypeParsers","suites":[],"updatePoint":{"line":1551,"column":90,"index":41699},"line":1551,"code":"test('should be able to override the default json parser after removeAllContentTypeParsers', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.removeAllContentTypeParsers();\n  fastify.addContentTypeParser('application/json', function (req, payload, done) {\n    t.ok('called');\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"should be able to override the default plain text parser after removeAllContentTypeParsers","suites":[],"updatePoint":{"line":1583,"column":96,"index":42607},"line":1583,"code":"test('should be able to override the default plain text parser after removeAllContentTypeParsers', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.removeAllContentTypeParsers();\n  fastify.addContentTypeParser('text/plain', function (req, payload, done) {\n    t.ok('called');\n    plainTextParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: 'hello world',\n      headers: {\n        'Content-Type': 'text/plain'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'hello world');\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"should be able to add a custom content type parser after removeAllContentTypeParsers","suites":[],"updatePoint":{"line":1613,"column":90,"index":43462},"line":1613,"code":"test('should be able to add a custom content type parser after removeAllContentTypeParsers', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.removeAllContentTypeParsers();\n  fastify.addContentTypeParser('application/jsoff', function (req, payload, done) {\n    t.ok('called');\n    jsonParser(payload, function (err, body) {\n      done(err, body);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      body: '{\"hello\":\"world\"}',\n      headers: {\n        'Content-Type': 'application/jsoff'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n      fastify.close();\n    });\n  });\n});","file":"custom-parser.test.js","skipped":false,"dir":"test"},{"name":"Custom querystring parser","suites":[],"updatePoint":{"line":13,"column":31,"index":217},"line":13,"code":"test('Custom querystring parser', t => {\n  t.plan(9);\n  const fastify = Fastify({\n    querystringParser: function (str) {\n      t.equal(str, 'foo=bar&baz=faz');\n      return querystring.parse(str);\n    }\n  });\n  fastify.get('/', (req, reply) => {\n    t.same(req.query, {\n      foo: 'bar',\n      baz: 'faz'\n    });\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: `${address}?foo=bar&baz=faz`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n    fastify.inject({\n      method: 'GET',\n      url: `${address}?foo=bar&baz=faz`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"custom-querystring-parser.test.js","skipped":false,"dir":"test"},{"name":"Custom querystring parser should be called also if there is nothing to parse","suites":[],"updatePoint":{"line":49,"column":82,"index":1101},"line":49,"code":"test('Custom querystring parser should be called also if there is nothing to parse', t => {\n  t.plan(9);\n  const fastify = Fastify({\n    querystringParser: function (str) {\n      t.equal(str, '');\n      return querystring.parse(str);\n    }\n  });\n  fastify.get('/', (req, reply) => {\n    t.same(req.query, {});\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: address\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n    fastify.inject({\n      method: 'GET',\n      url: address\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"custom-querystring-parser.test.js","skipped":false,"dir":"test"},{"name":"Querystring without value","suites":[],"updatePoint":{"line":82,"column":31,"index":1837},"line":82,"code":"test('Querystring without value', t => {\n  t.plan(9);\n  const fastify = Fastify({\n    querystringParser: function (str) {\n      t.equal(str, 'foo');\n      return querystring.parse(str);\n    }\n  });\n  fastify.get('/', (req, reply) => {\n    t.same(req.query, {\n      foo: ''\n    });\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: `${address}?foo`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n    fastify.inject({\n      method: 'GET',\n      url: `${address}?foo`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"custom-querystring-parser.test.js","skipped":false,"dir":"test"},{"name":"Custom querystring parser should be a function","suites":[],"updatePoint":{"line":117,"column":52,"index":2634},"line":117,"code":"test('Custom querystring parser should be a function', t => {\n  t.plan(1);\n\n  try {\n    Fastify({\n      querystringParser: 10\n    });\n    t.fail('Should throw');\n  } catch (err) {\n    t.equal(err.message, \"querystringParser option should be a function, instead got 'number'\");\n  }\n});","file":"custom-querystring-parser.test.js","skipped":false,"dir":"test"},{"name":"server methods should exist","suites":[],"updatePoint":{"line":18,"column":33,"index":341},"line":18,"code":"test('server methods should exist', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.ok(fastify.decorate);\n  t.ok(fastify.hasDecorator);\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"should check if the given decoration already exist when null","suites":[],"updatePoint":{"line":24,"column":66,"index":519},"line":24,"code":"test('should check if the given decoration already exist when null', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('null', null);\n  fastify.ready(() => {\n    t.ok(fastify.hasDecorator('null'));\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"server methods should be encapsulated via .register","suites":[],"updatePoint":{"line":32,"column":57,"index":736},"line":32,"code":"test('server methods should be encapsulated via .register', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('test', () => {});\n    t.ok(instance.test);\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"hasServerMethod should check if the given method already exist","suites":[],"updatePoint":{"line":44,"column":68,"index":1048},"line":44,"code":"test('hasServerMethod should check if the given method already exist', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('test', () => {});\n    t.ok(instance.hasDecorator('test'));\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.hasDecorator('test'));\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate should throw if a declared dependency is not present","suites":[],"updatePoint":{"line":56,"column":67,"index":1391},"line":56,"code":"test('decorate should throw if a declared dependency is not present', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    try {\n      instance.decorate('test', () => {}, ['dependency']);\n      t.fail();\n    } catch (e) {\n      t.same(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY');\n      t.same(e.message, 'The decorator is missing dependency \\'dependency\\'.');\n    }\n\n    done();\n  });\n  fastify.ready(() => t.pass());\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate should throw if declared dependency is not array","suites":[],"updatePoint":{"line":72,"column":63,"index":1854},"line":72,"code":"test('decorate should throw if declared dependency is not array', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    try {\n      instance.decorate('test', () => {}, {});\n      t.fail();\n    } catch (e) {\n      t.same(e.code, 'FST_ERR_DEC_DEPENDENCY_INVALID_TYPE');\n      t.same(e.message, 'The dependencies of decorator \\'test\\' must be of type Array.');\n    }\n\n    done();\n  });\n  fastify.ready(() => t.pass());\n}); // issue #777","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"should pass error for missing request decorator","suites":[],"updatePoint":{"line":89,"column":53,"index":2325},"line":89,"code":"test('should pass error for missing request decorator', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  const plugin = fp(function (instance, opts, done) {\n    done();\n  }, {\n    decorators: {\n      request: ['foo']\n    }\n  });\n  fastify.register(plugin).ready(err => {\n    t.type(err, Error);\n    t.match(err, /The decorator 'foo'/);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateReply inside register","suites":[],"updatePoint":{"line":104,"column":35,"index":2655},"line":104,"code":"test('decorateReply inside register', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorateReply('test', 'test');\n    instance.get('/yes', (req, reply) => {\n      t.ok(reply.test, 'test exists');\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(reply.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateReply as plugin (inside .after)","suites":[],"updatePoint":{"line":150,"column":45,"index":3888},"line":150,"code":"test('decorateReply as plugin (inside .after)', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      instance.decorateReply('test', 'test');\n      n();\n    })).after(() => {\n      instance.get('/yes', (req, reply) => {\n        t.ok(reply.test);\n        reply.send({\n          hello: 'world'\n        });\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(reply.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateReply as plugin (outside .after)","suites":[],"updatePoint":{"line":200,"column":46,"index":5202},"line":200,"code":"test('decorateReply as plugin (outside .after)', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      instance.decorateReply('test', 'test');\n      n();\n    }));\n    instance.get('/yes', (req, reply) => {\n      t.ok(reply.test);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(reply.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest inside register","suites":[],"updatePoint":{"line":249,"column":37,"index":6474},"line":249,"code":"test('decorateRequest inside register', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorateRequest('test', 'test');\n    instance.get('/yes', (req, reply) => {\n      t.ok(req.test, 'test exists');\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(req.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest as plugin (inside .after)","suites":[],"updatePoint":{"line":295,"column":47,"index":7707},"line":295,"code":"test('decorateRequest as plugin (inside .after)', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      instance.decorateRequest('test', 'test');\n      n();\n    })).after(() => {\n      instance.get('/yes', (req, reply) => {\n        t.ok(req.test);\n        reply.send({\n          hello: 'world'\n        });\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(req.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest as plugin (outside .after)","suites":[],"updatePoint":{"line":345,"column":48,"index":9021},"line":345,"code":"test('decorateRequest as plugin (outside .after)', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      instance.decorateRequest('test', 'test');\n      n();\n    }));\n    instance.get('/yes', (req, reply) => {\n      t.ok(req.test);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.get('/no', (req, reply) => {\n    t.notOk(req.test);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/no'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorators should be instance separated","suites":[],"updatePoint":{"line":394,"column":45,"index":10299},"line":394,"code":"test('decorators should be instance separated', t => {\n  t.plan(1);\n  const fastify1 = Fastify();\n  const fastify2 = Fastify();\n  fastify1.decorate('test', 'foo');\n  fastify2.decorate('test', 'foo');\n  fastify1.decorateRequest('test', 'foo');\n  fastify2.decorateRequest('test', 'foo');\n  fastify1.decorateReply('test', 'foo');\n  fastify2.decorateReply('test', 'foo');\n  t.pass();\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"hasRequestDecorator","suites":[],"updatePoint":{"line":406,"column":25,"index":10663},"line":406,"code":"test('hasRequestDecorator', t => {\n  const requestDecoratorName = 'my-decorator-name';\n  t.test('is a function', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.ok(fastify.hasRequestDecorator);\n  });\n  t.test('should check if the given request decoration already exist', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    t.notOk(fastify.hasRequestDecorator(requestDecoratorName));\n    fastify.decorateRequest(requestDecoratorName, 42);\n    t.ok(fastify.hasRequestDecorator(requestDecoratorName));\n  });\n  t.test('should check if the given request decoration already exist when null', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    t.notOk(fastify.hasRequestDecorator(requestDecoratorName));\n    fastify.decorateRequest(requestDecoratorName, null);\n    t.ok(fastify.hasRequestDecorator(requestDecoratorName));\n  });\n  t.test('should be plugin encapsulable', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    t.notOk(fastify.hasRequestDecorator(requestDecoratorName));\n    fastify.register(function (fastify2, opts, done) {\n      fastify2.decorateRequest(requestDecoratorName, 42);\n      t.ok(fastify2.hasRequestDecorator(requestDecoratorName));\n      done();\n    });\n    t.notOk(fastify.hasRequestDecorator(requestDecoratorName));\n    fastify.ready(function () {\n      t.notOk(fastify.hasRequestDecorator(requestDecoratorName));\n    });\n  });\n  t.test('should be inherited', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.decorateRequest(requestDecoratorName, 42);\n    fastify.register(function (fastify2, opts, done) {\n      t.ok(fastify2.hasRequestDecorator(requestDecoratorName));\n      done();\n    });\n    fastify.ready(function () {\n      t.ok(fastify.hasRequestDecorator(requestDecoratorName));\n    });\n  });\n  t.end();\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"hasReplyDecorator","suites":[],"updatePoint":{"line":455,"column":23,"index":12443},"line":455,"code":"test('hasReplyDecorator', t => {\n  const replyDecoratorName = 'my-decorator-name';\n  t.test('is a function', t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.ok(fastify.hasReplyDecorator);\n  });\n  t.test('should check if the given reply decoration already exist', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    t.notOk(fastify.hasReplyDecorator(replyDecoratorName));\n    fastify.decorateReply(replyDecoratorName, 42);\n    t.ok(fastify.hasReplyDecorator(replyDecoratorName));\n  });\n  t.test('should check if the given reply decoration already exist when null', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    t.notOk(fastify.hasReplyDecorator(replyDecoratorName));\n    fastify.decorateReply(replyDecoratorName, null);\n    t.ok(fastify.hasReplyDecorator(replyDecoratorName));\n  });\n  t.test('should be plugin encapsulable', t => {\n    t.plan(4);\n    const fastify = Fastify();\n    t.notOk(fastify.hasReplyDecorator(replyDecoratorName));\n    fastify.register(function (fastify2, opts, done) {\n      fastify2.decorateReply(replyDecoratorName, 42);\n      t.ok(fastify2.hasReplyDecorator(replyDecoratorName));\n      done();\n    });\n    t.notOk(fastify.hasReplyDecorator(replyDecoratorName));\n    fastify.ready(function () {\n      t.notOk(fastify.hasReplyDecorator(replyDecoratorName));\n    });\n  });\n  t.test('should be inherited', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.decorateReply(replyDecoratorName, 42);\n    fastify.register(function (fastify2, opts, done) {\n      t.ok(fastify2.hasReplyDecorator(replyDecoratorName));\n      done();\n    });\n    fastify.ready(function () {\n      t.ok(fastify.hasReplyDecorator(replyDecoratorName));\n    });\n  });\n  t.end();\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"should register properties via getter/setter objects","suites":[],"updatePoint":{"line":504,"column":58,"index":14194},"line":504,"code":"test('should register properties via getter/setter objects', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('test', {\n      getter() {\n        return 'a getter';\n      }\n\n    });\n    t.ok(instance.test);\n    t.ok(instance.test, 'a getter');\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest should work with getter/setter","suites":[],"updatePoint":{"line":522,"column":52,"index":14579},"line":522,"code":"test('decorateRequest should work with getter/setter', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorateRequest('test', {\n      getter() {\n        return 'a getter';\n      }\n\n    });\n    instance.get('/req-decorated-get-set', (req, res) => {\n      res.send({\n        test: req.test\n      });\n    });\n    done();\n  });\n  fastify.get('/not-decorated', (req, res) => {\n    t.notOk(req.test);\n    res.send();\n  });\n  fastify.ready(() => {\n    fastify.inject({\n      url: '/req-decorated-get-set'\n    }, (err, res) => {\n      t.error(err);\n      t.same(JSON.parse(res.payload), {\n        test: 'a getter'\n      });\n    });\n    fastify.inject({\n      url: '/not-decorated'\n    }, (err, res) => {\n      t.error(err);\n      t.pass();\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateReply should work with getter/setter","suites":[],"updatePoint":{"line":560,"column":50,"index":15389},"line":560,"code":"test('decorateReply should work with getter/setter', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorateReply('test', {\n      getter() {\n        return 'a getter';\n      }\n\n    });\n    instance.get('/res-decorated-get-set', (req, res) => {\n      res.send({\n        test: res.test\n      });\n    });\n    done();\n  });\n  fastify.get('/not-decorated', (req, res) => {\n    t.notOk(res.test);\n    res.send();\n  });\n  fastify.ready(() => {\n    fastify.inject({\n      url: '/res-decorated-get-set'\n    }, (err, res) => {\n      t.error(err);\n      t.same(JSON.parse(res.payload), {\n        test: 'a getter'\n      });\n    });\n    fastify.inject({\n      url: '/not-decorated'\n    }, (err, res) => {\n      t.error(err);\n      t.pass();\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"should register empty values","suites":[],"updatePoint":{"line":598,"column":34,"index":16181},"line":598,"code":"test('should register empty values', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('test', null);\n    t.ok(instance.hasOwnProperty('test'));\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"nested plugins can override things","suites":[],"updatePoint":{"line":610,"column":40,"index":16479},"line":610,"code":"test('nested plugins can override things', t => {\n  t.plan(6);\n  const fastify = Fastify();\n\n  const rootFunc = () => {};\n\n  fastify.decorate('test', rootFunc);\n  fastify.decorateRequest('test', rootFunc);\n  fastify.decorateReply('test', rootFunc);\n  fastify.register((instance, opts, done) => {\n    const func = () => {};\n\n    instance.decorate('test', func);\n    instance.decorateRequest('test', func);\n    instance.decorateReply('test', func);\n    t.equal(instance.test, func);\n    t.equal(instance[symbols.kRequest].prototype.test, func);\n    t.equal(instance[symbols.kReply].prototype.test, func);\n    done();\n  });\n  fastify.ready(() => {\n    t.equal(fastify.test, rootFunc);\n    t.equal(fastify[symbols.kRequest].prototype.test, rootFunc);\n    t.equal(fastify[symbols.kReply].prototype.test, rootFunc);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"a decorator should addSchema to all the encapsulated tree","suites":[],"updatePoint":{"line":636,"column":63,"index":17322},"line":636,"code":"test('a decorator should addSchema to all the encapsulated tree', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const decorator = function (instance, opts, done) {\n    instance.decorate('decoratorAddSchema', function (whereAddTheSchema) {\n      instance.addSchema({\n        $id: 'schema',\n        type: 'string'\n      });\n    });\n    done();\n  };\n\n  fastify.register(fp(decorator));\n  fastify.register(function (instance, opts, done) {\n    instance.register((subInstance, opts, done) => {\n      subInstance.decoratorAddSchema();\n      done();\n    });\n    done();\n  });\n  fastify.ready(t.error);\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"after can access to a decorated instance and previous plugin decoration","suites":[],"updatePoint":{"line":660,"column":77,"index":17941},"line":660,"code":"test('after can access to a decorated instance and previous plugin decoration', t => {\n  t.plan(11);\n  const TEST_VALUE = {};\n  const OTHER_TEST_VALUE = {};\n  const NEW_TEST_VALUE = {};\n  const fastify = Fastify();\n  fastify.register(fp(function (instance, options, done) {\n    instance.decorate('test', TEST_VALUE);\n    done();\n  })).after(function (err, instance, done) {\n    t.error(err);\n    t.equal(instance.test, TEST_VALUE);\n    instance.decorate('test2', OTHER_TEST_VALUE);\n    done();\n  });\n  fastify.register(fp(function (instance, options, done) {\n    t.equal(instance.test, TEST_VALUE);\n    t.equal(instance.test2, OTHER_TEST_VALUE);\n    instance.decorate('test3', NEW_TEST_VALUE);\n    done();\n  })).after(function (err, instance, done) {\n    t.error(err);\n    t.equal(instance.test, TEST_VALUE);\n    t.equal(instance.test2, OTHER_TEST_VALUE);\n    t.equal(instance.test3, NEW_TEST_VALUE);\n    done();\n  });\n  fastify.get('/', function (req, res) {\n    t.equal(this.test, TEST_VALUE);\n    t.equal(this.test2, OTHER_TEST_VALUE);\n    res.send({});\n  });\n  fastify.inject('/').then(response => {\n    t.equal(response.statusCode, 200);\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate* should throw if called after ready","suites":[],"updatePoint":{"line":696,"column":50,"index":19067},"line":696,"code":"test('decorate* should throw if called after ready', async t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.get('/', (request, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  await fastify.listen(0);\n\n  try {\n    fastify.decorate('test', true);\n    t.fail('should not decorate');\n  } catch (err) {\n    t.same(err.code, 'FST_ERR_DEC_AFTER_START');\n    t.same(err.message, \"The decorator 'test' has been added after start!\");\n  }\n\n  try {\n    fastify.decorateRequest('test', true);\n    t.fail('should not decorate');\n  } catch (e) {\n    t.same(e.code, 'FST_ERR_DEC_AFTER_START');\n    t.same(e.message, \"The decorator 'test' has been added after start!\");\n  }\n\n  try {\n    fastify.decorateReply('test', true);\n    t.fail('should not decorate');\n  } catch (e) {\n    t.same(e.code, 'FST_ERR_DEC_AFTER_START');\n    t.same(e.message, \"The decorator 'test' has been added after start!\");\n  }\n\n  await fastify.close();\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate* should emit warning if an array is passed","suites":[],"updatePoint":{"line":732,"column":57,"index":20016},"line":732,"code":"test('decorate* should emit warning if an array is passed', t => {\n  t.plan(2);\n\n  function onWarning(code, name) {\n    t.equal(name, 'test_array');\n    t.equal(code, 'FSTDEP006');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const decorate = proxyquire('../lib/decorate', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/decorate.js': decorate\n  })();\n  fastify.decorateRequest('test_array', []);\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate* should emit warning if object type is passed","suites":[],"updatePoint":{"line":751,"column":60,"index":20461},"line":751,"code":"test('decorate* should emit warning if object type is passed', t => {\n  t.plan(2);\n\n  function onWarning(code, name) {\n    t.equal(name, 'test_object');\n    t.equal(code, 'FSTDEP006');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const decorate = proxyquire('../lib/decorate', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/decorate.js': decorate\n  })();\n  fastify.decorateRequest('test_object', {\n    foo: 'bar'\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate* should not emit warning if object with getter/setter is passed","suites":[],"updatePoint":{"line":772,"column":78,"index":20944},"line":772,"code":"test('decorate* should not emit warning if object with getter/setter is passed', t => {\n  function onWarning(warning) {\n    t.fail('Should not call a warn');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const decorate = proxyquire('../lib/decorate', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/decorate.js': decorate\n  })();\n  fastify.decorateRequest('test_getter_setter', {\n    setter(val) {\n      this._ = val;\n    },\n\n    getter() {\n      return 'a getter';\n    }\n\n  });\n  t.end('Done');\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate* should not emit warning if string,bool,numbers are passed","suites":[],"updatePoint":{"line":798,"column":73,"index":21479},"line":798,"code":"test('decorate* should not emit warning if string,bool,numbers are passed', t => {\n  function onWarning(warning) {\n    t.fail('Should not call a warn');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const decorate = proxyquire('../lib/decorate', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/decorate.js': decorate\n  })();\n  fastify.decorateRequest('test_str', 'foo');\n  fastify.decorateRequest('test_bool', true);\n  fastify.decorateRequest('test_number', 42);\n  fastify.decorateRequest('test_null', null);\n  fastify.decorateRequest('test_undefined', undefined);\n  fastify.decorateReply('test_str', 'foo');\n  fastify.decorateReply('test_bool', true);\n  fastify.decorateReply('test_number', 42);\n  fastify.decorateReply('test_null', null);\n  fastify.decorateReply('test_undefined', undefined);\n  t.end('Done');\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"Request/reply decorators should be able to access the server instance","suites":[],"updatePoint":{"line":824,"column":75,"index":22337},"line":824,"code":"test('Request/reply decorators should be able to access the server instance', async t => {\n  t.plan(6);\n\n  const server = require('..')({\n    logger: false\n  });\n\n  server.decorateRequest('assert', rootAssert);\n  server.decorateReply('assert', rootAssert);\n  server.get('/root-assert', async (req, rep) => {\n    req.assert();\n    rep.assert();\n    return 'done';\n  });\n  server.register(async instance => {\n    instance.decorateRequest('assert', nestedAssert);\n    instance.decorateReply('assert', nestedAssert);\n    instance.decorate('foo', 'bar');\n    instance.get('/nested-assert', async (req, rep) => {\n      req.assert();\n      rep.assert();\n      return 'done';\n    });\n  });\n  await server.inject({\n    method: 'GET',\n    url: '/root-assert'\n  });\n  await server.inject({\n    method: 'GET',\n    url: '/nested-assert'\n  }); // ----\n\n  function rootAssert() {\n    t.equal(this.server, server);\n  }\n\n  function nestedAssert() {\n    t.not(this.server, server);\n    t.equal(this.server.foo, 'bar');\n  }\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"plugin required decorators","suites":[],"updatePoint":{"line":866,"column":32,"index":23303},"line":866,"code":"test('plugin required decorators', async t => {\n  const plugin1 = fp(async instance => {\n    instance.decorateRequest('someThing', null);\n    instance.addHook('onRequest', async (request, reply) => {\n      request.someThing = 'hello';\n    });\n  }, {\n    name: 'custom-plugin-one',\n    fastify: '3.x'\n  });\n  const plugin2 = fp(async () => {// nothing\n  }, {\n    name: 'custom-plugin-two',\n    fastify: '3.x',\n    dependencies: ['custom-plugin-one'],\n    decorators: {\n      request: ['someThing']\n    }\n  });\n  const app = Fastify();\n  app.register(plugin1);\n  app.register(plugin2);\n  await app.ready();\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest/decorateReply empty string","suites":[],"updatePoint":{"line":890,"column":48,"index":23928},"line":890,"code":"test('decorateRequest/decorateReply empty string', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.decorateRequest('test', '');\n  fastify.decorateReply('test2', '');\n  fastify.get('/yes', (req, reply) => {\n    t.equal(req.test, '');\n    t.equal(reply.test2, '');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest/decorateReply is undefined","suites":[],"updatePoint":{"line":919,"column":48,"index":24724},"line":919,"code":"test('decorateRequest/decorateReply is undefined', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.decorateRequest('test', undefined);\n  fastify.decorateReply('test2', undefined);\n  fastify.get('/yes', (req, reply) => {\n    t.equal(req.test, undefined);\n    t.equal(reply.test2, undefined);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest/decorateReply is not set to a value","suites":[],"updatePoint":{"line":948,"column":57,"index":25557},"line":948,"code":"test('decorateRequest/decorateReply is not set to a value', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.decorateRequest('test');\n  fastify.decorateReply('test2');\n  fastify.get('/yes', (req, reply) => {\n    t.equal(req.test, undefined);\n    t.equal(reply.test2, undefined);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/yes'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest with dependencies","suites":[],"updatePoint":{"line":977,"column":39,"index":26350},"line":977,"code":"test('decorateRequest with dependencies', t => {\n  t.plan(2);\n  const app = Fastify();\n  const decorator1 = 'bar';\n  const decorator2 = 'foo';\n  app.decorate('decorator1', decorator1);\n  app.decorateRequest('decorator1', decorator1);\n\n  if (app.hasDecorator('decorator1') && app.hasRequestDecorator('decorator1')) {\n    t.doesNotThrow(() => app.decorateRequest('decorator2', decorator2, ['decorator1']));\n    t.ok(app.hasRequestDecorator('decorator2'));\n  }\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"decorateRequest with dependencies (functions)","suites":[],"updatePoint":{"line":990,"column":51,"index":26824},"line":990,"code":"test('decorateRequest with dependencies (functions)', t => {\n  t.plan(2);\n  const app = Fastify();\n\n  const decorator1 = () => 'bar';\n\n  const decorator2 = () => 'foo';\n\n  app.decorate('decorator1', decorator1);\n  app.decorateRequest('decorator1', decorator1);\n\n  if (app.hasDecorator('decorator1') && app.hasRequestDecorator('decorator1')) {\n    t.doesNotThrow(() => app.decorateRequest('decorator2', decorator2, ['decorator1']));\n    t.ok(app.hasRequestDecorator('decorator2'));\n  }\n});","file":"decorator.test.js","skipped":false,"dir":"test"},{"name":"should fail if defaultRoute is not a function","suites":[],"updatePoint":{"line":9,"column":51,"index":148},"line":9,"code":"test('should fail if defaultRoute is not a function', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const defaultRoute = {};\n  fastify.get('/', () => {});\n\n  try {\n    fastify.setDefaultRoute(defaultRoute);\n  } catch (error) {\n    t.equal(error.code, 'FST_ERR_DEFAULT_ROUTE_INVALID_TYPE');\n  }\n});","file":"default-route.test.js","skipped":false,"dir":"test"},{"name":"correctly sets, returns, and calls defaultRoute","suites":[],"updatePoint":{"line":21,"column":53,"index":453},"line":21,"code":"test('correctly sets, returns, and calls defaultRoute', t => {\n  t.plan(3);\n  const fastify = Fastify();\n\n  const defaultRoute = (req, res) => {\n    res.end('hello from defaultRoute');\n  };\n\n  fastify.setDefaultRoute(defaultRoute);\n  const returnedDefaultRoute = fastify.getDefaultRoute();\n  t.equal(returnedDefaultRoute, defaultRoute);\n  fastify.get('/', () => {});\n  fastify.inject({\n    method: 'GET',\n    url: '/random'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.body, 'hello from defaultRoute');\n  });\n});","file":"default-route.test.js","skipped":false,"dir":"test"},{"name":"shorthand - delete","suites":[],"updatePoint":{"line":86,"column":24,"index":1235},"line":86,"code":"test('shorthand - delete', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/', schema, function (req, reply) {\n      reply.code(200).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - delete params","suites":[],"updatePoint":{"line":100,"column":31,"index":1476},"line":100,"code":"test('shorthand - delete params', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/params/:foo/:test', paramsSchema, function (req, reply) {\n      reply.code(200).send(req.params);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - delete, querystring schema","suites":[],"updatePoint":{"line":112,"column":44,"index":1731},"line":112,"code":"test('shorthand - delete, querystring schema', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/query', querySchema, function (req, reply) {\n      reply.send(req.query);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get, headers schema","suites":[],"updatePoint":{"line":124,"column":37,"index":1955},"line":124,"code":"test('shorthand - get, headers schema', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/headers', headersSchema, function (req, reply) {\n      reply.code(200).send(req.headers);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"missing schema - delete","suites":[],"updatePoint":{"line":136,"column":29,"index":2187},"line":136,"code":"test('missing schema - delete', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/missing', function (req, reply) {\n      reply.code(200).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"body - delete","suites":[],"updatePoint":{"line":150,"column":19,"index":2415},"line":150,"code":"test('body - delete', t => {\n  t.plan(1);\n\n  try {\n    fastify.delete('/body', bodySchema, function (req, reply) {\n      reply.send(req.body);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete","suites":[],"updatePoint":{"line":165,"column":34,"index":2702},"line":165,"code":"  test('shorthand - request delete', t => {\n    t.plan(4);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete params schema","suites":[],"updatePoint":{"line":179,"column":48,"index":3117},"line":179,"code":"  test('shorthand - request delete params schema', t => {\n    t.plan(4);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/123'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        foo: 'world',\n        test: 123\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete params schema error","suites":[],"updatePoint":{"line":194,"column":54,"index":3577},"line":194,"code":"  test('shorthand - request delete params schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/string'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: 'params.test should be integer',\n        statusCode: 400\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete headers schema","suites":[],"updatePoint":{"line":209,"column":49,"index":4030},"line":209,"code":"  test('shorthand - request delete headers schema', t => {\n    t.plan(4);\n    sget({\n      method: 'DELETE',\n      headers: {\n        'x-test': 1\n      },\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.equal(JSON.parse(body)['x-test'], 1);\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete headers schema error","suites":[],"updatePoint":{"line":224,"column":55,"index":4491},"line":224,"code":"  test('shorthand - request delete headers schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'DELETE',\n      headers: {\n        'x-test': 'abc'\n      },\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: \"headers['x-test'] should be number\",\n        statusCode: 400\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete querystring schema","suites":[],"updatePoint":{"line":242,"column":53,"index":4991},"line":242,"code":"  test('shorthand - request delete querystring schema', t => {\n    t.plan(4);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=123'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 123\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete querystring schema error","suites":[],"updatePoint":{"line":256,"column":59,"index":5434},"line":256,"code":"  test('shorthand - request delete querystring schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=world'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: 'querystring.hello should be integer',\n        statusCode: 400\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request delete missing schema","suites":[],"updatePoint":{"line":271,"column":49,"index":5891},"line":271,"code":"  test('shorthand - request delete missing schema', t => {\n    t.plan(4);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/missing'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - delete with body","suites":[],"updatePoint":{"line":285,"column":36,"index":6307},"line":285,"code":"  test('shorthand - delete with body', t => {\n    t.plan(3);\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port + '/body',\n      body: {\n        hello: 'world'\n      },\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body, {\n        hello: 'world'\n      });\n    });\n  });","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"shorthand - delete with application/json Content-Type header and without body","suites":[],"updatePoint":{"line":304,"column":83,"index":6804},"line":304,"code":"test('shorthand - delete with application/json Content-Type header and without body', t => {\n  t.plan(4);\n\n  const fastify = require('..')();\n\n  fastify.delete('/', {}, (req, reply) => {\n    t.equal(req.body, null);\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'DELETE',\n    url: '/',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: null\n  }, (err, response) => {\n    t.error(err);\n    t.equal(response.statusCode, 200);\n    t.same(JSON.parse(response.payload), null);\n  });\n});","file":"delete.test.js","skipped":false,"dir":"test"},{"name":"diagnostics_channel when present and subscribers","suites":[],"updatePoint":{"line":9,"column":54,"index":162},"line":9,"code":"test('diagnostics_channel when present and subscribers', t => {\n  t.plan(3);\n  let fastifyInHook;\n  const dc = {\n    channel(name) {\n      t.equal(name, 'fastify.initialization');\n      return {\n        hasSubscribers: true,\n\n        publish(event) {\n          t.ok(event.fastify);\n          fastifyInHook = event.fastify;\n        }\n\n      };\n    },\n\n    '@noCallThru': true\n  };\n  const fastify = proxyquire('../fastify', {\n    diagnostics_channel: dc\n  })();\n  t.equal(fastifyInHook, fastify);\n});","file":"diagnostics-channel.test.js","skipped":false,"dir":"test"},{"name":"diagnostics_channel when present and no subscribers","suites":[],"updatePoint":{"line":33,"column":57,"index":665},"line":33,"code":"test('diagnostics_channel when present and no subscribers', t => {\n  t.plan(1);\n  const dc = {\n    channel(name) {\n      t.equal(name, 'fastify.initialization');\n      return {\n        hasSubscribers: false,\n\n        publish() {\n          t.fail('publish should not be called');\n        }\n\n      };\n    },\n\n    '@noCallThru': true\n  };\n  proxyquire('../fastify', {\n    diagnostics_channel: dc\n  })();\n});","file":"diagnostics-channel.test.js","skipped":false,"dir":"test"},{"name":"diagnostics_channel when not present","suites":[],"updatePoint":{"line":54,"column":42,"index":1055},"line":54,"code":"test('diagnostics_channel when not present', t => {\n  t.plan(1);\n  t.doesNotThrow(() => {\n    proxyquire('../fastify', {\n      diagnostics_channel: null\n    })();\n  });\n});","file":"diagnostics-channel.test.js","skipped":false,"dir":"test"},{"name":"Should emit a warning when accessing request.req instead of request.raw","suites":[],"updatePoint":{"line":14,"column":77,"index":279},"line":14,"code":"test('Should emit a warning when accessing request.req instead of request.raw', t => {\n  t.plan(4);\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP001');\n    t.equal(warning.message, 'You are accessing the Node.js core request object via \"request.req\", Use \"request.raw\" instead.');\n  }\n\n  const fastify = Fastify();\n  fastify.get('/', (request, reply) => {\n    reply.send(request.req.method + request.req.method);\n  });\n  fastify.inject({\n    method: 'GET',\n    path: '/'\n  }, (err, res) => {\n    t.error(err);\n    process.removeListener('warning', onWarning);\n  });\n});","file":"emit-warning.test.js","skipped":false,"dir":"test"},{"name":"Should emit a warning when accessing reply.res instead of reply.raw","suites":[],"updatePoint":{"line":36,"column":73,"index":951},"line":36,"code":"test('Should emit a warning when accessing reply.res instead of reply.raw', t => {\n  t.plan(4);\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP002');\n    t.equal(warning.message, 'You are accessing the Node.js core response object via \"reply.res\", Use \"reply.raw\" instead.');\n  }\n\n  const fastify = Fastify();\n  fastify.get('/', (request, reply) => {\n    reply.send(reply.res.statusCode + reply.res.statusCode);\n  });\n  fastify.inject({\n    method: 'GET',\n    path: '/'\n  }, (err, res) => {\n    t.error(err);\n    process.removeListener('warning', onWarning);\n  });\n});","file":"emit-warning.test.js","skipped":false,"dir":"test"},{"name":"Should emit a warning when using two arguments Content Type Parser instead of three arguments","suites":[],"updatePoint":{"line":58,"column":99,"index":1650},"line":58,"code":"test('Should emit a warning when using two arguments Content Type Parser instead of three arguments', t => {\n  t.plan(7);\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP003');\n    t.equal(warning.message, 'You are using the legacy Content Type Parser function signature. Use the one suggested in the documentation instead.');\n  }\n\n  const fastify = Fastify();\n  fastify.addContentTypeParser('x/foo', function (req, done) {\n    done(null, 'OK');\n  });\n  fastify.post('/', (request, reply) => {\n    reply.send(request.body);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'x/foo'\n      },\n      body: '{\"hello\":\"world\"}'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'OK');\n      process.removeListener('warning', onWarning);\n      fastify.close();\n    });\n  });\n});","file":"emit-warning.test.js","skipped":false,"dir":"test"},{"name":"Should emit a warning when using payload less preParsing hook","suites":[],"updatePoint":{"line":93,"column":67,"index":2711},"line":93,"code":"test('Should emit a warning when using payload less preParsing hook', t => {\n  t.plan(7);\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP004');\n    t.equal(warning.message, 'You are using the legacy preParsing hook signature. Use the one suggested in the documentation instead.');\n  }\n\n  const fastify = Fastify();\n  fastify.addHook('preParsing', function (request, reply, done) {\n    done();\n  });\n  fastify.get('/', (request, reply) => {\n    reply.send('OK');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'OK');\n      process.removeListener('warning', onWarning);\n      fastify.close();\n    });\n  });\n});","file":"emit-warning.test.js","skipped":false,"dir":"test"},{"name":"Should emit a warning when accessing request.connection instead of request.socket on Node process greater than 13.0.0","suites":[],"updatePoint":{"line":124,"column":123,"index":3707},"line":124,"code":"test('Should emit a warning when accessing request.connection instead of request.socket on Node process greater than 13.0.0', t => {\n  t.plan(4);\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    if (semver.gte(process.versions.node, '13.0.0')) {\n      t.equal(warning.name, 'FastifyDeprecation');\n      t.equal(warning.code, 'FSTDEP005');\n      t.equal(warning.message, 'You are accessing the deprecated \"request.connection\" property. Use \"request.socket\" instead.');\n    } else {\n      t.equal(warning.name, 'FastifyDeprecationLightMyRequest');\n      t.equal(warning.code, 'FST_LIGHTMYREQUEST_DEP01');\n      t.equal(warning.message, 'You are accessing \"request.connection\", use \"request.socket\" instead.');\n    } // removed listener before light-my-request emit second warning\n\n\n    process.removeListener('warning', onWarning);\n  }\n\n  const fastify = Fastify();\n  fastify.get('/', (request, reply) => {\n    reply.send(request.connection);\n  });\n  fastify.inject({\n    method: 'GET',\n    path: '/'\n  }, (err, res) => {\n    t.error(err);\n    process.removeListener('warning', onWarning);\n  });\n});","file":"emit-warning.test.js","skipped":false,"dir":"test"},{"name":"root fastify instance is an object","suites":[],"updatePoint":{"line":14,"column":40,"index":205},"line":14,"code":"test('root fastify instance is an object', t => {\n  t.plan(1);\n  t.type(Fastify(), 'object');\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"fastify instance should contains ajv options","suites":[],"updatePoint":{"line":18,"column":50,"index":313},"line":18,"code":"test('fastify instance should contains ajv options', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        nullable: false\n      }\n    }\n  });\n  t.same(fastify[kOptions].ajv, {\n    customOptions: {\n      nullable: false\n    },\n    plugins: []\n  });\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"fastify instance should contains ajv options.plugins nested arrays","suites":[],"updatePoint":{"line":34,"column":72,"index":624},"line":34,"code":"test('fastify instance should contains ajv options.plugins nested arrays', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        nullable: false\n      },\n      plugins: [[]]\n    }\n  });\n  t.same(fastify[kOptions].ajv, {\n    customOptions: {\n      nullable: false\n    },\n    plugins: [[]]\n  });\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"fastify instance get invalid ajv options","suites":[],"updatePoint":{"line":51,"column":46,"index":932},"line":51,"code":"test('fastify instance get invalid ajv options', t => {\n  t.plan(1);\n  t.throws(() => Fastify({\n    ajv: {\n      customOptions: 8\n    }\n  }));\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"fastify instance get invalid ajv options.plugins","suites":[],"updatePoint":{"line":59,"column":54,"index":1087},"line":59,"code":"test('fastify instance get invalid ajv options.plugins', t => {\n  t.plan(1);\n  t.throws(() => Fastify({\n    ajv: {\n      customOptions: {},\n      plugins: 8\n    }\n  }));\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"fastify instance should contain default errorHandler","suites":[],"updatePoint":{"line":68,"column":58,"index":1265},"line":68,"code":"test('fastify instance should contain default errorHandler', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.ok(fastify[kErrorHandler] instanceof Function);\n  t.same(fastify.errorHandler, fastify[kErrorHandler]);\n  t.same(Object.getOwnPropertyDescriptor(fastify, 'errorHandler').set, undefined);\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"errorHandler in plugin should be separate from the external one","suites":[],"updatePoint":{"line":75,"column":69,"index":1581},"line":75,"code":"test('errorHandler in plugin should be separate from the external one', async t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    const inPluginErrHandler = (_, __, reply) => {\n      reply.send({\n        plugin: 'error-object'\n      });\n    };\n\n    instance.setErrorHandler(inPluginErrHandler);\n    t.notSame(instance.errorHandler, fastify.errorHandler);\n    t.equal(instance.errorHandler.name, 'bound inPluginErrHandler');\n    done();\n  });\n  await fastify.ready();\n  t.ok(fastify[kErrorHandler] instanceof Function);\n  t.same(fastify.errorHandler, fastify[kErrorHandler]);\n});","file":"fastify-instance.test.js","skipped":false,"dir":"test"},{"name":"use fluent-json-schema object","suites":[],"updatePoint":{"line":11,"column":35,"index":174},"line":11,"code":"test('use fluent-json-schema object', t => {\n  t.plan(15);\n  const fastify = Fastify();\n  fastify.post('/:id', {\n    handler: (req, reply) => {\n      reply.send({\n        name: 'a',\n        surname: 'b',\n        dateOfBirth: '01-01-2020'\n      });\n    },\n    schema: {\n      params: S.object().prop('id', S.integer().minimum(42)),\n      headers: S.object().prop('x-custom', S.string().format('email')),\n      query: S.object().prop('surname', S.string().required()),\n      body: S.object().prop('name', S.string().required()),\n      response: {\n        200: S.object().prop('name', S.string()).prop('surname', S.string())\n      }\n    }\n  }); // check params\n\n  fastify.inject({\n    method: 'POST',\n    url: '/1',\n    headers: {\n      'x-custom': 'me@me.me'\n    },\n    query: {\n      surname: 'bar'\n    },\n    payload: {\n      name: 'foo'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'params.id should be >= 42'\n    });\n  }); // check header\n\n  fastify.inject({\n    method: 'POST',\n    url: '/42',\n    headers: {\n      'x-custom': 'invalid'\n    },\n    query: {\n      surname: 'bar'\n    },\n    payload: {\n      name: 'foo'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'headers[\\'x-custom\\'] should match format \"email\"'\n    });\n  }); // check query\n\n  fastify.inject({\n    method: 'POST',\n    url: '/42',\n    headers: {\n      'x-custom': 'me@me.me'\n    },\n    query: {},\n    payload: {\n      name: 'foo'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'querystring should have required property \\'surname\\''\n    });\n  }); // check body\n\n  fastify.inject({\n    method: 'POST',\n    url: '/42',\n    headers: {\n      'x-custom': 'me@me.me'\n    },\n    query: {\n      surname: 'bar'\n    },\n    payload: {\n      name: [1, 2, 3]\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'body.name should be string'\n    });\n  }); // check response\n\n  fastify.inject({\n    method: 'POST',\n    url: '/42',\n    headers: {\n      'x-custom': 'me@me.me'\n    },\n    query: {\n      surname: 'bar'\n    },\n    payload: {\n      name: 'foo'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      name: 'a',\n      surname: 'b'\n    });\n  });\n});","file":"fluent-schema.test.js","skipped":false,"dir":"test"},{"name":"use complex fluent-json-schema object","suites":[],"updatePoint":{"line":140,"column":43,"index":2843},"line":140,"code":"test('use complex fluent-json-schema object', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const addressSchema = S.object().id('#address').prop('line1').required().prop('line2').prop('country').required().prop('city').required().prop('zipcode').required();\n  const commonSchemas = S.object().id('https://fastify/demo').definition('addressSchema', addressSchema);\n  fastify.addSchema(commonSchemas);\n  const bodyJsonSchema = S.object().prop('residence', S.ref('https://fastify/demo#address')).required().prop('office', S.ref('https://fastify/demo#/definitions/addressSchema')).required();\n  fastify.post('/the/url', {\n    schema: {\n      body: bodyJsonSchema\n    }\n  }, () => {});\n  fastify.ready(err => t.error(err));\n});","file":"fluent-schema.test.js","skipped":false,"dir":"test"},{"name":"use fluent schema and plain JSON schema","suites":[],"updatePoint":{"line":154,"column":45,"index":3573},"line":154,"code":"test('use fluent schema and plain JSON schema', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const addressSchema = S.object().id('#address').prop('line1').required().prop('line2').prop('country').required().prop('city').required().prop('zipcode').required();\n  const commonSchemas = S.object().id('https://fastify/demo').definition('addressSchema', addressSchema);\n  const sharedAddressSchema = {\n    $id: 'sharedAddress',\n    type: 'object',\n    required: ['line1', 'country', 'city', 'zipcode'],\n    properties: {\n      line1: {\n        type: 'string'\n      },\n      line2: {\n        type: 'string'\n      },\n      country: {\n        type: 'string'\n      },\n      city: {\n        type: 'string'\n      },\n      zipcode: {\n        type: 'string'\n      }\n    }\n  };\n  fastify.addSchema(commonSchemas);\n  fastify.addSchema(sharedAddressSchema);\n  const bodyJsonSchema = S.object().prop('residence', S.ref('https://fastify/demo#address')).required().prop('office', S.ref('https://fastify/demo#/definitions/addressSchema')).required();\n  fastify.post('/the/url', {\n    schema: {\n      body: bodyJsonSchema\n    }\n  }, () => {});\n  fastify.ready(err => t.error(err));\n});","file":"fluent-schema.test.js","skipped":false,"dir":"test"},{"name":"Should call valueOf internally","suites":[],"updatePoint":{"line":191,"column":36,"index":4735},"line":191,"code":"test('Should call valueOf internally', t => {\n  t.plan(1);\n  const fastify = new Fastify();\n  const addressSchema = S.object().id('#address').prop('line1').required().prop('line2').prop('country').required().prop('city').required().prop('zipcode').required();\n  const commonSchemas = S.object().id('https://fastify/demo').definition('addressSchema', addressSchema);\n  fastify.addSchema(commonSchemas);\n  fastify.route({\n    method: 'POST',\n    url: '/query',\n    handler: () => {},\n    schema: {\n      query: S.object().prop('hello', S.string()).required(),\n      body: S.object().prop('hello', S.string()).required(),\n      params: S.object().prop('hello', S.string()).required(),\n      headers: S.object().prop('hello', S.string()).required(),\n      response: {\n        200: S.object().prop('hello', S.string()).required(),\n        201: S.object().prop('hello', S.string()).required()\n      }\n    }\n  });\n  fastify.route({\n    method: 'POST',\n    url: '/querystring',\n    handler: () => {},\n    schema: {\n      querystring: S.object().prop('hello', S.string()).required(),\n      body: S.object().prop('hello', S.string()).required(),\n      params: S.object().prop('hello', S.string()).required(),\n      headers: S.object().prop('hello', S.string()).required(),\n      response: {\n        200: S.object().prop('hello', S.string()).required(),\n        201: S.object().prop('hello', S.string()).required()\n      }\n    }\n  });\n  fastify.ready(t.error);\n});","file":"fluent-schema.test.js","skipped":false,"dir":"test"},{"name":"Should accept a custom genReqId function","suites":[],"updatePoint":{"line":9,"column":46,"index":130},"line":9,"code":"test('Should accept a custom genReqId function', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    genReqId: function (req) {\n      return 'a';\n    }\n  });\n  fastify.get('/', (req, reply) => {\n    t.ok(req.id);\n    reply.send({\n      id: req.id\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.equal(payload.id, 'a');\n      fastify.close();\n    });\n  });\n});","file":"genReqId.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get","suites":[],"updatePoint":{"line":90,"column":21,"index":1275},"line":90,"code":"test('shorthand - get', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/', schema, function (req, reply) {\n      reply.code(200).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get (return null)","suites":[],"updatePoint":{"line":104,"column":35,"index":1517},"line":104,"code":"test('shorthand - get (return null)', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/null', nullSchema, function (req, reply) {\n      reply.code(200).send(null);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get params","suites":[],"updatePoint":{"line":116,"column":28,"index":1732},"line":116,"code":"test('shorthand - get params', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/params/:foo/:test', paramsSchema, function (req, reply) {\n      reply.code(200).send(req.params);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get, querystring schema","suites":[],"updatePoint":{"line":128,"column":41,"index":1981},"line":128,"code":"test('shorthand - get, querystring schema', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/query', querySchema, function (req, reply) {\n      reply.code(200).send(req.query);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - get, headers schema","suites":[],"updatePoint":{"line":140,"column":37,"index":2212},"line":140,"code":"test('shorthand - get, headers schema', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/headers', headersSchema, function (req, reply) {\n      reply.code(200).send(req.headers);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"missing schema - get","suites":[],"updatePoint":{"line":152,"column":26,"index":2438},"line":152,"code":"test('missing schema - get', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/missing', function (req, reply) {\n      reply.code(200).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"custom serializer - get","suites":[],"updatePoint":{"line":166,"column":29,"index":2673},"line":166,"code":"test('custom serializer - get', t => {\n  t.plan(1);\n\n  function customSerializer(data) {\n    return JSON.stringify(data);\n  }\n\n  try {\n    fastify.get('/custom-serializer', numberSchema, function (req, reply) {\n      reply.code(200).serializer(customSerializer).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"empty response","suites":[],"updatePoint":{"line":184,"column":20,"index":3026},"line":184,"code":"test('empty response', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/empty', function (req, reply) {\n      reply.code(200).send();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"send a falsy boolean","suites":[],"updatePoint":{"line":196,"column":26,"index":3224},"line":196,"code":"test('send a falsy boolean', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/boolean', function (req, reply) {\n      reply.code(200).send(false);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get","suites":[],"updatePoint":{"line":211,"column":31,"index":3503},"line":211,"code":"  test('shorthand - request get', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get params schema","suites":[],"updatePoint":{"line":225,"column":45,"index":3912},"line":225,"code":"  test('shorthand - request get params schema', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/123'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        foo: 'world',\n        test: 123\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get params schema error","suites":[],"updatePoint":{"line":240,"column":51,"index":4366},"line":240,"code":"  test('shorthand - request get params schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/string'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: 'params.test should be integer',\n        statusCode: 400\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get headers schema","suites":[],"updatePoint":{"line":255,"column":46,"index":4813},"line":255,"code":"  test('shorthand - request get headers schema', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      headers: {\n        'x-test': '1',\n        'Y-Test': '3'\n      },\n      json: true,\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body['x-test'], 1);\n      t.equal(body['y-test'], 3);\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get headers schema error","suites":[],"updatePoint":{"line":272,"column":52,"index":5264},"line":272,"code":"  test('shorthand - request get headers schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      headers: {\n        'x-test': 'abc'\n      },\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: \"headers['x-test'] should be number\",\n        statusCode: 400\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get querystring schema","suites":[],"updatePoint":{"line":290,"column":50,"index":5758},"line":290,"code":"  test('shorthand - request get querystring schema', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=123'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 123\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get querystring schema error","suites":[],"updatePoint":{"line":304,"column":56,"index":6195},"line":304,"code":"  test('shorthand - request get querystring schema error', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=world'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.same(JSON.parse(body), {\n        error: 'Bad Request',\n        message: 'querystring.hello should be integer',\n        statusCode: 400\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request get missing schema","suites":[],"updatePoint":{"line":319,"column":46,"index":6646},"line":319,"code":"  test('shorthand - request get missing schema', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/missing'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - custom serializer","suites":[],"updatePoint":{"line":333,"column":37,"index":7060},"line":333,"code":"  test('shorthand - custom serializer', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/custom-serializer'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - empty response","suites":[],"updatePoint":{"line":347,"column":34,"index":7481},"line":347,"code":"  test('shorthand - empty response', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/empty'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '0');\n      t.same(body.toString(), '');\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - send a falsy boolean","suites":[],"updatePoint":{"line":359,"column":40,"index":7852},"line":359,"code":"  test('shorthand - send a falsy boolean', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/boolean'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'false');\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"shorthand - send null value","suites":[],"updatePoint":{"line":370,"column":35,"index":8169},"line":370,"code":"  test('shorthand - send null value', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/null'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), 'null');\n    });\n  });","file":"get.test.js","skipped":false,"dir":"test"},{"name":"handlers receive correct `this` context","suites":[],"updatePoint":{"line":22,"column":45,"index":371},"line":22,"code":"test('handlers receive correct `this` context', t => {\n  t.plan(4); // simulate plugin that uses fastify-plugin\n\n  const plugin = function (instance, opts, done) {\n    instance.decorate('foo', 'foo');\n    done();\n  };\n\n  plugin[Symbol.for('skip-override')] = true;\n  const instance = fastify();\n  instance.register(plugin);\n  instance.get('/', function (req, reply) {\n    t.ok(this.foo);\n    t.equal(this.foo, 'foo');\n    reply.send();\n  });\n  instance.listen(0, err => {\n    instance.server.unref();\n    if (err) t.threw(err);\n    t.ok(instance.foo);\n    t.equal(instance.foo, 'foo');\n    http.get(getUrl(instance), () => {}).on('error', t.threw);\n  });\n});","file":"handler-context.test.js","skipped":false,"dir":"test"},{"name":"handlers have access to the internal context","suites":[],"updatePoint":{"line":46,"column":50,"index":1035},"line":46,"code":"test('handlers have access to the internal context', t => {\n  t.plan(5);\n  const instance = fastify();\n  instance.get('/', {\n    config: {\n      foo: 'bar'\n    }\n  }, function (req, reply) {\n    t.ok(reply.context);\n    t.ok(reply.context.config);\n    t.type(reply.context.config, Object);\n    t.ok(reply.context.config.foo);\n    t.equal(reply.context.config.foo, 'bar');\n    reply.send();\n  });\n  instance.listen(0, err => {\n    instance.server.unref();\n    if (err) t.threw(err);\n    http.get(getUrl(instance), () => {}).on('error', t.threw);\n  });\n});","file":"handler-context.test.js","skipped":false,"dir":"test"},{"name":"shorthand - head","suites":[],"updatePoint":{"line":47,"column":22,"index":651},"line":47,"code":"test('shorthand - head', t => {\n  t.plan(1);\n\n  try {\n    fastify.head('/', schema, function (req, reply) {\n      reply.code(200).send(null);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - head params","suites":[],"updatePoint":{"line":59,"column":29,"index":860},"line":59,"code":"test('shorthand - head params', t => {\n  t.plan(1);\n\n  try {\n    fastify.head('/params/:foo/:test', paramsSchema, function (req, reply) {\n      reply.send(null);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - head, querystring schema","suites":[],"updatePoint":{"line":71,"column":42,"index":1095},"line":71,"code":"test('shorthand - head, querystring schema', t => {\n  t.plan(1);\n\n  try {\n    fastify.head('/query', querySchema, function (req, reply) {\n      reply.code(200).send(null);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"head.test.js","skipped":false,"dir":"test"},{"name":"missing schema - head","suites":[],"updatePoint":{"line":83,"column":27,"index":1312},"line":83,"code":"test('missing schema - head', t => {\n  t.plan(1);\n\n  try {\n    fastify.head('/missing', function (req, reply) {\n      reply.code(200).send(null);\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head","suites":[],"updatePoint":{"line":98,"column":32,"index":1592},"line":98,"code":"  test('shorthand - request head', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head params schema","suites":[],"updatePoint":{"line":108,"column":46,"index":1862},"line":108,"code":"  test('shorthand - request head params schema', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/123'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head params schema error","suites":[],"updatePoint":{"line":118,"column":52,"index":2160},"line":118,"code":"  test('shorthand - request head params schema error', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port + '/params/world/string'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head querystring schema","suites":[],"updatePoint":{"line":128,"column":51,"index":2460},"line":128,"code":"  test('shorthand - request head querystring schema', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=123'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head querystring schema error","suites":[],"updatePoint":{"line":138,"column":57,"index":2762},"line":138,"code":"  test('shorthand - request head querystring schema error', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port + '/query?hello=world'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"shorthand - request head missing schema","suites":[],"updatePoint":{"line":148,"column":47,"index":3056},"line":148,"code":"  test('shorthand - request head missing schema', t => {\n    t.plan(2);\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port + '/missing'\n    }, (err, response) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });","file":"head.test.js","skipped":false,"dir":"test"},{"name":"async hooks","suites":[],"updatePoint":{"line":20,"column":17,"index":345},"line":20,"code":"test('async hooks', t => {\n  t.plan(21);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async function (request, reply) {\n    await sleep(1);\n    request.test = 'the request is coming';\n    reply.test = 'the reply has come';\n\n    if (request.raw.method === 'DELETE') {\n      throw new Error('some error');\n    }\n  });\n  fastify.addHook('preHandler', async function (request, reply) {\n    await sleep(1);\n    t.equal(request.test, 'the request is coming');\n    t.equal(reply.test, 'the reply has come');\n\n    if (request.raw.method === 'HEAD') {\n      throw new Error('some error');\n    }\n  });\n  fastify.addHook('onSend', async function (request, reply, payload) {\n    await sleep(1);\n    t.ok('onSend called');\n  });\n  fastify.addHook('onResponse', async function (request, reply) {\n    await sleep(1);\n    t.ok('onResponse called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.equal(request.test, 'the request is coming');\n    t.equal(reply.test, 'the reply has come');\n    reply.code(200).send({\n      hello: 'world'\n    });\n  });\n  fastify.head('/', function (req, reply) {\n    reply.code(200).send({\n      hello: 'world'\n    });\n  });\n  fastify.delete('/', function (req, reply) {\n    reply.code(200).send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"modify payload","suites":[],"updatePoint":{"line":96,"column":20,"index":2442},"line":96,"code":"test('modify payload', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  const modifiedPayload = {\n    hello: 'modified'\n  };\n  const anotherPayload = '\"winter is coming\"';\n  fastify.addHook('onSend', async function (request, reply, thePayload) {\n    t.ok('onSend called');\n    t.same(JSON.parse(thePayload), payload);\n    return thePayload.replace('world', 'modified');\n  });\n  fastify.addHook('onSend', async function (request, reply, thePayload) {\n    t.ok('onSend called');\n    t.same(JSON.parse(thePayload), modifiedPayload);\n    return anotherPayload;\n  });\n  fastify.addHook('onSend', async function (request, reply, thePayload) {\n    t.ok('onSend called');\n    t.equal(thePayload, anotherPayload);\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, anotherPayload);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '18');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"onRequest hooks should be able to block a request","suites":[],"updatePoint":{"line":133,"column":55,"index":3529},"line":133,"code":"test('onRequest hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.addHook('onRequest', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.ok('called');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should be able to modify the payload","suites":[],"updatePoint":{"line":163,"column":59,"index":4363},"line":163,"code":"test('preParsing hooks should be able to modify the payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', async (req, reply, payload) => {\n    const stream = new Readable();\n    stream.receivedEncodedLength = parseInt(req.headers['content-length'], 10);\n    stream.push(JSON.stringify({\n      hello: 'another world'\n    }));\n    stream.push(null);\n    return stream;\n  });\n  fastify.post('/', function (request, reply) {\n    reply.send(request.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'another world'\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks can completely ignore the payload - deprecated syntax","suites":[],"updatePoint":{"line":192,"column":76,"index":5127},"line":192,"code":"test('preParsing hooks can completely ignore the payload - deprecated syntax', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  process.on('warning', onWarning);\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP004');\n  }\n\n  fastify.addHook('preParsing', async (req, reply) => {});\n  fastify.post('/', function (request, reply) {\n    reply.send(request.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    process.removeListener('warning', onWarning);\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should handle errors","suites":[],"updatePoint":{"line":221,"column":43,"index":5823},"line":221,"code":"test('preParsing hooks should handle errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', async (req, reply, payload) => {\n    const e = new Error('kaboom');\n    e.statusCode = 501;\n    throw e;\n  });\n  fastify.post('/', function (request, reply) {\n    reply.send(request.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 501);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Implemented',\n      message: 'kaboom',\n      statusCode: 501\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preHandler hooks should be able to block a request","suites":[],"updatePoint":{"line":248,"column":56,"index":6461},"line":248,"code":"test('preHandler hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preHandler', async (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.addHook('preHandler', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.equal(payload, 'hello');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should be able to block a request","suites":[],"updatePoint":{"line":275,"column":59,"index":7205},"line":275,"code":"test('preValidation hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', async (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.addHook('preValidation', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.equal(payload, 'hello');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should be able to change request body before validation","suites":[],"updatePoint":{"line":302,"column":81,"index":7977},"line":302,"code":"test('preValidation hooks should be able to change request body before validation', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', async (req, _reply) => {\n    const buff = Buffer.from(req.body.message, 'base64');\n    req.body = JSON.parse(buff.toString('utf-8'));\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          foo: {\n            type: 'string'\n          },\n          bar: {\n            type: 'number'\n          }\n        },\n        required: ['foo', 'bar']\n      }\n    }\n  }, (req, reply) => {\n    t.pass();\n    reply.status(200).send('hello');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'POST',\n    payload: {\n      message: Buffer.from(JSON.stringify({\n        foo: 'example',\n        bar: 1\n      })).toString('base64')\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hooks should be able to modify the payload","suites":[],"updatePoint":{"line":343,"column":65,"index":8920},"line":343,"code":"test('preSerialization hooks should be able to modify the payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', async (req, reply, payload) => {\n    return {\n      hello: 'another world'\n    };\n  });\n  fastify.get('/', function (request, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'another world'\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hooks should handle errors","suites":[],"updatePoint":{"line":367,"column":49,"index":9455},"line":367,"code":"test('preSerialization hooks should handle errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', async (req, reply, payload) => {\n    throw new Error('kaboom');\n  });\n  fastify.get('/', function (request, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should handle throwing null","suites":[],"updatePoint":{"line":391,"column":53,"index":10032},"line":391,"code":"test('preValidation hooks should handle throwing null', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.setErrorHandler(async (error, request, reply) => {\n    t.ok(error instanceof Error);\n    reply.send(error);\n  });\n  fastify.addHook('preValidation', async () => {\n    // eslint-disable-next-line no-throw-literal\n    throw null;\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('the handler must not be called');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.same(res.json(), {\n      error: 'Internal Server Error',\n      code: 'FST_ERR_SEND_UNDEFINED_ERR',\n      message: 'Undefined error has occurred',\n      statusCode: 500\n    });\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should handle throwing a string","suites":[],"updatePoint":{"line":419,"column":57,"index":10800},"line":419,"code":"test('preValidation hooks should handle throwing a string', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', async () => {\n    // eslint-disable-next-line no-throw-literal\n    throw 'this is an error';\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('the handler must not be called');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(res.payload, 'this is an error');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"onRequest hooks should be able to block a request (last hook)","suites":[],"updatePoint":{"line":438,"column":67,"index":11332},"line":438,"code":"test('onRequest hooks should be able to block a request (last hook)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.addHook('preHandler', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.ok('called');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preHandler hooks should be able to block a request (last hook)","suites":[],"updatePoint":{"line":465,"column":68,"index":12073},"line":465,"code":"test('preHandler hooks should be able to block a request (last hook)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preHandler', async (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.equal(payload, 'hello');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"onRequest respond with a stream","suites":[],"updatePoint":{"line":489,"column":37,"index":12692},"line":489,"code":"test('onRequest respond with a stream', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async (req, reply) => {\n    return new Promise((resolve, reject) => {\n      const stream = fs.createReadStream(process.cwd() + '/test/stream.test.js', 'utf8'); // stream.pipe(res)\n      // res.once('finish', resolve)\n\n      reply.send(stream);\n      reply.raw.once('finish', () => resolve());\n    });\n  });\n  fastify.addHook('onRequest', async (req, res) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.ok('called');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preHandler respond with a stream","suites":[],"updatePoint":{"line":524,"column":38,"index":13720},"line":524,"code":"test('preHandler respond with a stream', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async (req, res) => {\n    t.ok('called');\n  }); // we are calling `reply.send` inside the `preHandler` hook with a stream,\n  // this triggers the `onSend` hook event if `preHandler` has not yet finished\n\n  const order = [1, 2];\n  fastify.addHook('preHandler', async (req, reply) => {\n    return new Promise((resolve, reject) => {\n      const stream = fs.createReadStream(process.cwd() + '/test/stream.test.js', 'utf8');\n      reply.send(stream);\n      reply.raw.once('finish', () => {\n        t.equal(order.shift(), 2);\n        resolve();\n      });\n    });\n  });\n  fastify.addHook('preHandler', async (req, reply) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', async (req, reply, payload) => {\n    t.equal(order.shift(), 1);\n    t.equal(typeof payload.pipe, 'function');\n  });\n  fastify.addHook('onResponse', async (request, reply) => {\n    t.ok('called');\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"Should log a warning if is an async function with `done`","suites":[],"updatePoint":{"line":564,"column":62,"index":14985},"line":564,"code":"test('Should log a warning if is an async function with `done`', t => {\n  t.test('3 arguments', t => {\n    t.plan(1);\n    const fastify = Fastify();\n\n    try {\n      fastify.addHook('onRequest', async (req, reply, done) => {});\n    } catch (e) {\n      t.ok(e.message === 'Async function has too many arguments. Async hooks should not use the \\'done\\' argument.');\n    }\n  });\n  t.test('4 arguments', t => {\n    t.plan(3);\n    const fastify = Fastify();\n\n    try {\n      fastify.addHook('onSend', async (req, reply, payload, done) => {});\n    } catch (e) {\n      t.ok(e.message === 'Async function has too many arguments. Async hooks should not use the \\'done\\' argument.');\n    }\n\n    try {\n      fastify.addHook('preSerialization', async (req, reply, payload, done) => {});\n    } catch (e) {\n      t.ok(e.message === 'Async function has too many arguments. Async hooks should not use the \\'done\\' argument.');\n    }\n\n    try {\n      fastify.addHook('onError', async (req, reply, payload, done) => {});\n    } catch (e) {\n      t.ok(e.message === 'Async function has too many arguments. Async hooks should not use the \\'done\\' argument.');\n    }\n  });\n  t.end();\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"early termination, onRequest async","suites":[],"updatePoint":{"line":599,"column":40,"index":16129},"line":599,"code":"test('early termination, onRequest async', async t => {\n  t.plan(2);\n  const app = Fastify();\n  app.addHook('onRequest', async (req, reply) => {\n    setImmediate(() => reply.send('hello world'));\n    return reply;\n  });\n  app.get('/', (req, reply) => {\n    t.fail('should not happen');\n  });\n  const res = await app.inject('/');\n  t.equal(res.statusCode, 200);\n  t.equal(res.body.toString(), 'hello world');\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"The this should be the same of the encapsulation level","suites":[],"updatePoint":{"line":613,"column":60,"index":16561},"line":613,"code":"test('The this should be the same of the encapsulation level', async t => {\n  const fastify = Fastify();\n  fastify.addHook('onRequest', async function (req, reply) {\n    if (req.raw.url === '/nested') {\n      t.equal(this.foo, 'bar');\n    } else {\n      t.equal(this.foo, undefined);\n    }\n  });\n  fastify.register(plugin);\n  fastify.get('/', (req, reply) => reply.send('ok'));\n\n  async function plugin(fastify, opts) {\n    fastify.decorate('foo', 'bar');\n    fastify.get('/nested', (req, reply) => reply.send('ok'));\n  }\n\n  await fastify.inject({\n    method: 'GET',\n    path: '/'\n  });\n  await fastify.inject({\n    method: 'GET',\n    path: '/nested'\n  });\n  await fastify.inject({\n    method: 'GET',\n    path: '/'\n  });\n  await fastify.inject({\n    method: 'GET',\n    path: '/nested'\n  });\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"preSerializationEnd should handle errors if the serialize method throws","suites":[],"updatePoint":{"line":647,"column":77,"index":17373},"line":647,"code":"test('preSerializationEnd should handle errors if the serialize method throws', t => {\n  t.test('works with sync preSerialization', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addHook('preSerialization', (request, reply, payload, done) => {\n      done(null, payload);\n    });\n    fastify.post('/', {\n      handler(req, reply) {\n        reply.send({\n          notOk: true\n        });\n      },\n\n      schema: {\n        response: {\n          200: {\n            required: ['ok'],\n            properties: {\n              ok: {\n                type: 'boolean'\n              }\n            }\n          }\n        }\n      }\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.not(res.statusCode, 200);\n    });\n  });\n  t.test('works with async preSerialization', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.addHook('preSerialization', async (request, reply, payload) => {\n      return payload;\n    });\n    fastify.post('/', {\n      handler(req, reply) {\n        reply.send({\n          notOk: true\n        });\n      },\n\n      schema: {\n        response: {\n          200: {\n            required: ['ok'],\n            properties: {\n              ok: {\n                type: 'boolean'\n              }\n            }\n          }\n        }\n      }\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.not(res.statusCode, 200);\n    });\n  });\n  t.end();\n});","file":"hooks-async.test.js","skipped":false,"dir":"test"},{"name":"hooks","suites":[],"updatePoint":{"line":27,"column":11,"index":456},"line":27,"code":"test('hooks', t => {\n  t.plan(43);\n  const fastify = Fastify();\n\n  try {\n    fastify.addHook('preHandler', function (request, reply, done) {\n      t.equal(request.test, 'the request is coming');\n      t.equal(reply.test, 'the reply has come');\n\n      if (request.raw.method === 'HEAD') {\n        done(new Error('some error'));\n      } else {\n        done();\n      }\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.addHook('preParsing', function (request, reply, payload, done) {\n      request.preParsing = true;\n      t.equal(request.test, 'the request is coming');\n      t.equal(reply.test, 'the reply has come');\n      done();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.addHook('preParsing', function (request, reply, done) {\n      request.preParsing = true;\n      t.equal(request.test, 'the request is coming');\n      t.equal(reply.test, 'the reply has come');\n      done();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.addHook('preValidation', function (request, reply, done) {\n      t.equal(request.preParsing, true);\n      t.equal(request.test, 'the request is coming');\n      t.equal(reply.test, 'the reply has come');\n      done();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.addHook('preSerialization', function (request, reply, payload, done) {\n      t.ok('preSerialization called');\n      done();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  try {\n    fastify.addHook('onRequest', function (request, reply, done) {\n      request.test = 'the request is coming';\n      reply.test = 'the reply has come';\n\n      if (request.raw.method === 'DELETE') {\n        done(new Error('some error'));\n      } else {\n        done();\n      }\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.ok('onResponse called');\n    done();\n  });\n  fastify.addHook('onSend', function (req, reply, thePayload, done) {\n    t.ok('onSend called');\n    done();\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: function (req, reply) {\n      t.equal(req.test, 'the request is coming');\n      t.equal(reply.test, 'the reply has come');\n      reply.code(200).send(payload);\n    },\n    onResponse: function (req, reply, done) {\n      t.ok('onResponse inside hook');\n    },\n    response: {\n      200: {\n        type: 'object'\n      }\n    }\n  });\n  fastify.head('/', function (req, reply) {\n    reply.code(200).send(payload);\n  });\n  fastify.delete('/', function (req, reply) {\n    reply.code(200).send(payload);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'HEAD',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hook should support encapsulation / 1","suites":[],"updatePoint":{"line":170,"column":53,"index":3948},"line":170,"code":"test('onRequest hook should support encapsulation / 1', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRequest', (req, reply, done) => {\n      t.equal(req.raw.url, '/plugin');\n      done();\n    });\n    instance.get('/plugin', (request, reply) => {\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/root', (request, reply) => {\n    reply.send();\n  });\n  fastify.inject('/root', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject('/plugin', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hook should support encapsulation / 2","suites":[],"updatePoint":{"line":195,"column":53,"index":4590},"line":195,"code":"test('onRequest hook should support encapsulation / 2', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let pluginInstance;\n  fastify.addHook('onRequest', () => {});\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRequest', () => {});\n    pluginInstance = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(fastify[symbols.kHooks].onRequest.length, 1);\n    t.equal(pluginInstance[symbols.kHooks].onRequest.length, 2);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hook should support encapsulation / 3","suites":[],"updatePoint":{"line":211,"column":53,"index":5076},"line":211,"code":"test('onRequest hook should support encapsulation / 3', t => {\n  t.plan(20);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('onRequest', function (req, reply, done) {\n    t.ok(this.hello);\n    t.ok(this.hello2);\n    req.first = true;\n    done();\n  });\n  fastify.decorate('hello2', 'world');\n  fastify.get('/first', (req, reply) => {\n    t.ok(req.first);\n    t.notOk(req.second);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello3', 'world');\n    instance.addHook('onRequest', function (req, reply, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      t.ok(this.hello3);\n      req.second = true;\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      t.ok(req.first);\n      t.ok(req.second);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preHandler hook should support encapsulation / 5","suites":[],"updatePoint":{"line":274,"column":54,"index":6765},"line":274,"code":"test('preHandler hook should support encapsulation / 5', t => {\n  t.plan(17);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('preHandler', function (req, res, done) {\n    t.ok(this.hello);\n    req.first = true;\n    done();\n  });\n  fastify.get('/first', (req, reply) => {\n    t.ok(req.first);\n    t.notOk(req.second);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello2', 'world');\n    instance.addHook('preHandler', function (req, res, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      req.second = true;\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      t.ok(req.first);\n      t.ok(req.second);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called / 1","suites":[],"updatePoint":{"line":334,"column":39,"index":8350},"line":334,"code":"test('onRoute hook should be called / 1', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', () => {\n      t.pass();\n    });\n    instance.get('/', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called / 2","suites":[],"updatePoint":{"line":350,"column":39,"index":8703},"line":350,"code":"test('onRoute hook should be called / 2', t => {\n  t.plan(5);\n  let firstHandler = 0;\n  let secondHandler = 0;\n  const fastify = Fastify();\n  fastify.addHook('onRoute', route => {\n    t.pass();\n    firstHandler++;\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', route => {\n      t.pass();\n      secondHandler++;\n    });\n    instance.get('/', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  }).after(() => {\n    t.equal(firstHandler, 1);\n    t.equal(secondHandler, 1);\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called / 3","suites":[],"updatePoint":{"line":376,"column":39,"index":9291},"line":376,"code":"test('onRoute hook should be called / 3', t => {\n  t.plan(5);\n  const fastify = Fastify();\n\n  function handler(req, reply) {\n    reply.send();\n  }\n\n  fastify.addHook('onRoute', route => {\n    t.pass();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', route => {\n      t.pass();\n    });\n    instance.get('/a', handler);\n    done();\n  }).after((err, done) => {\n    t.error(err);\n    setTimeout(() => {\n      fastify.get('/b', handler);\n      done();\n    }, 10);\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called (encapsulation support) / 4","suites":[],"updatePoint":{"line":404,"column":63,"index":9870},"line":404,"code":"test('onRoute hook should be called (encapsulation support) / 4', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onRoute', () => {\n    t.pass();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', () => {\n      t.pass();\n    });\n    instance.get('/nested', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called (encapsulation support) / 5","suites":[],"updatePoint":{"line":426,"column":63,"index":10377},"line":426,"code":"test('onRoute hook should be called (encapsulation support) / 5', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/first', function (req, reply) {\n    reply.send();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', () => {\n      t.pass();\n    });\n    instance.get('/nested', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/second', function (req, reply) {\n    reply.send();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called (encapsulation support) / 6","suites":[],"updatePoint":{"line":448,"column":63,"index":10905},"line":448,"code":"test('onRoute hook should be called (encapsulation support) / 6', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/first', function (req, reply) {\n    reply.send();\n  });\n  fastify.addHook('onRoute', () => {\n    t.fail('This should not be called');\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute should keep the context","suites":[],"updatePoint":{"line":461,"column":37,"index":11203},"line":461,"code":"test('onRoute should keep the context', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('test', true);\n    instance.addHook('onRoute', onRoute);\n    t.ok(instance.prototype === fastify.prototype);\n\n    function onRoute(route) {\n      t.ok(this.test);\n      t.equal(this, instance);\n    }\n\n    instance.get('/', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.close(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should pass correct route","suites":[],"updatePoint":{"line":483,"column":44,"index":11720},"line":483,"code":"test('onRoute hook should pass correct route', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.addHook('onRoute', route => {\n    t.equal(route.method, 'GET');\n    t.equal(route.url, '/');\n    t.equal(route.path, '/');\n    t.equal(route.routePath, '/');\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', route => {\n      t.equal(route.method, 'GET');\n      t.equal(route.url, '/');\n      t.equal(route.path, '/');\n      t.equal(route.routePath, '/');\n    });\n    instance.get('/', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should pass correct route with custom prefix","suites":[],"updatePoint":{"line":508,"column":63,"index":12394},"line":508,"code":"test('onRoute hook should pass correct route with custom prefix', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.addHook('onRoute', function (route) {\n    t.equal(route.method, 'GET');\n    t.equal(route.url, '/v1/foo');\n    t.equal(route.path, '/v1/foo');\n    t.equal(route.routePath, '/foo');\n    t.equal(route.prefix, '/v1');\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', function (route) {\n      t.equal(route.method, 'GET');\n      t.equal(route.url, '/v1/foo');\n      t.equal(route.path, '/v1/foo');\n      t.equal(route.routePath, '/foo');\n      t.equal(route.prefix, '/v1');\n    });\n    instance.get('/foo', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should pass correct route with custom options","suites":[],"updatePoint":{"line":537,"column":64,"index":13214},"line":537,"code":"test('onRoute hook should pass correct route with custom options', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', function (route) {\n      t.equal(route.method, 'GET');\n      t.equal(route.url, '/foo');\n      t.equal(route.logLevel, 'info');\n      t.equal(route.bodyLimit, 100);\n      t.type(route.logSerializers.test, 'function');\n    });\n    instance.get('/foo', {\n      logLevel: 'info',\n      bodyLimit: 100,\n      logSerializers: {\n        test: value => value\n      }\n    }, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should receive any route option","suites":[],"updatePoint":{"line":563,"column":50,"index":13885},"line":563,"code":"test('onRoute hook should receive any route option', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', function (route) {\n      t.equal(route.method, 'GET');\n      t.equal(route.url, '/foo');\n      t.equal(route.routePath, '/foo');\n      t.equal(route.auth, 'basic');\n    });\n    instance.get('/foo', {\n      auth: 'basic'\n    }, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should preserve system route configuration","suites":[],"updatePoint":{"line":584,"column":61,"index":14427},"line":584,"code":"test('onRoute hook should preserve system route configuration', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', function (route) {\n      t.equal(route.method, 'GET');\n      t.equal(route.url, '/foo');\n      t.equal(route.routePath, '/foo');\n      t.equal(route.handler.length, 2);\n    });\n    instance.get('/foo', {\n      url: '/bar',\n      method: 'POST'\n    }, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should preserve handler function in options of shorthand route system configuration","suites":[],"updatePoint":{"line":606,"column":102,"index":15034},"line":606,"code":"test('onRoute hook should preserve handler function in options of shorthand route system configuration', t => {\n  t.plan(2);\n\n  const handler = (req, reply) => {};\n\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', function (route) {\n      t.equal(route.handler, handler);\n    });\n    instance.get('/foo', {\n      handler\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n}); // issue ref https://github.com/fastify/fastify-compress/issues/140","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should be called once when prefixTrailingSlash","suites":[],"updatePoint":{"line":626,"column":65,"index":15525},"line":626,"code":"test('onRoute hook should be called once when prefixTrailingSlash', t => {\n  t.plan(3);\n  let onRouteCalled = 0;\n  let routePatched = 0;\n  const fastify = Fastify({\n    ignoreTrailingSlash: false\n  }); // a plugin that patches route options, similar to fastify-compress\n\n  fastify.register(fp(function myPlugin(instance, opts, next) {\n    function patchTheRoute() {\n      routePatched++;\n    }\n\n    instance.addHook('onRoute', function (routeOptions) {\n      onRouteCalled++;\n      patchTheRoute(routeOptions);\n    });\n    next();\n  }));\n  fastify.register(function routes(instance, opts, next) {\n    instance.route({\n      method: 'GET',\n      url: '/',\n      prefixTrailingSlash: 'both',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(onRouteCalled, 1); // onRoute hook was called once\n\n    t.equal(routePatched, 1); // and plugin acted once and avoided redundaunt route patching\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook should able to change the route url","suites":[],"updatePoint":{"line":667,"column":54,"index":16568},"line":667,"code":"test('onRoute hook should able to change the route url', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', route => {\n      t.equal(route.url, '/f');\n      route.url = encodeURI(route.url);\n    });\n    instance.get('/f', (request, reply) => {\n      reply.send('here /f');\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + encodeURI('/f')\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(body.toString(), 'here /f');\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook that throws should be caught ","suites":[],"updatePoint":{"line":693,"column":48,"index":17292},"line":693,"code":"test('onRoute hook that throws should be caught ', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', () => {\n      throw new Error('snap');\n    });\n    instance.get('/', opts, function (req, reply) {\n      reply.send();\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.ok(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRoute hook with many prefix","suites":[],"updatePoint":{"line":709,"column":35,"index":17653},"line":709,"code":"test('onRoute hook with many prefix', t => {\n  t.plan(3);\n  const fastify = Fastify();\n\n  const handler = (req, reply) => {\n    reply.send({});\n  };\n\n  const onRouteChecks = [{\n    routePath: '/anotherPath',\n    prefix: '/two',\n    url: '/one/two/anotherPath'\n  }, {\n    routePath: '/aPath',\n    prefix: '/one',\n    url: '/one/aPath'\n  }];\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onRoute', route => {\n      t.match(route, onRouteChecks.pop());\n    });\n    instance.route({\n      method: 'GET',\n      url: '/aPath',\n      handler\n    });\n    instance.register((instance, opts, done) => {\n      instance.route({\n        method: 'GET',\n        path: '/anotherPath',\n        handler\n      });\n      done();\n    }, {\n      prefix: '/two'\n    });\n    done();\n  }, {\n    prefix: '/one'\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onResponse hook should log request error","suites":[],"updatePoint":{"line":753,"column":46,"index":18531},"line":753,"code":"test('onResponse hook should log request error', t => {\n  t.plan(4);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'error'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  logStream.once('data', line => {\n    t.equal(line.msg, 'request errored');\n    t.equal(line.level, 50);\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    done(new Error('kaboom'));\n  });\n  fastify.get('/root', (request, reply) => {\n    reply.send();\n  });\n  fastify.inject('/root', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onResponse hook should support encapsulation / 1","suites":[],"updatePoint":{"line":784,"column":54,"index":19201},"line":784,"code":"test('onResponse hook should support encapsulation / 1', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onResponse', (request, reply, done) => {\n      t.equal(reply.plugin, true);\n      done();\n    });\n    instance.get('/plugin', (request, reply) => {\n      reply.plugin = true;\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/root', (request, reply) => {\n    reply.send();\n  });\n  fastify.inject('/root', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject('/plugin', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onResponse hook should support encapsulation / 2","suites":[],"updatePoint":{"line":810,"column":54,"index":19872},"line":810,"code":"test('onResponse hook should support encapsulation / 2', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let pluginInstance;\n  fastify.addHook('onResponse', () => {});\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onResponse', () => {});\n    pluginInstance = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(fastify[symbols.kHooks].onResponse.length, 1);\n    t.equal(pluginInstance[symbols.kHooks].onResponse.length, 2);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onResponse hook should support encapsulation / 3","suites":[],"updatePoint":{"line":826,"column":54,"index":20363},"line":826,"code":"test('onResponse hook should support encapsulation / 3', t => {\n  t.plan(16);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.ok(this.hello);\n    t.ok('onResponse called');\n    done();\n  });\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello2', 'world');\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      t.ok('onResponse called');\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook should support encapsulation / 1","suites":[],"updatePoint":{"line":882,"column":50,"index":21895},"line":882,"code":"test('onSend hook should support encapsulation / 1', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let pluginInstance;\n  fastify.addHook('onSend', () => {});\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onSend', () => {});\n    pluginInstance = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(fastify[symbols.kHooks].onSend.length, 1);\n    t.equal(pluginInstance[symbols.kHooks].onSend.length, 2);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook should support encapsulation / 2","suites":[],"updatePoint":{"line":898,"column":50,"index":22366},"line":898,"code":"test('onSend hook should support encapsulation / 2', t => {\n  t.plan(16);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('onSend', function (request, reply, thePayload, done) {\n    t.ok(this.hello);\n    t.ok('onSend called');\n    done();\n  });\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello2', 'world');\n    instance.addHook('onSend', function (request, reply, thePayload, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      t.ok('onSend called');\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook is called after payload is serialized and headers are set","suites":[],"updatePoint":{"line":954,"column":75,"index":23931},"line":954,"code":"test('onSend hook is called after payload is serialized and headers are set', t => {\n  t.plan(30);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    const thePayload = {\n      hello: 'world'\n    };\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.same(JSON.parse(payload), thePayload);\n      t.equal(reply[symbols.kReplyHeaders]['content-type'], 'application/json; charset=utf-8');\n      done();\n    });\n    instance.get('/json', (request, reply) => {\n      reply.send(thePayload);\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(payload, 'some text');\n      t.equal(reply[symbols.kReplyHeaders]['content-type'], 'text/plain; charset=utf-8');\n      done();\n    });\n    instance.get('/text', (request, reply) => {\n      reply.send('some text');\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    const thePayload = Buffer.from('buffer payload');\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(payload, thePayload);\n      t.equal(reply[symbols.kReplyHeaders]['content-type'], 'application/octet-stream');\n      done();\n    });\n    instance.get('/buffer', (request, reply) => {\n      reply.send(thePayload);\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    let chunk = 'stream payload';\n    const thePayload = new stream.Readable({\n      read() {\n        this.push(chunk);\n        chunk = null;\n      }\n\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(payload, thePayload);\n      t.equal(reply[symbols.kReplyHeaders]['content-type'], 'application/octet-stream');\n      done();\n    });\n    instance.get('/stream', (request, reply) => {\n      reply.send(thePayload);\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    const serializedPayload = 'serialized';\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(payload, serializedPayload);\n      t.equal(reply[symbols.kReplyHeaders]['content-type'], 'text/custom');\n      done();\n    });\n    instance.get('/custom-serializer', (request, reply) => {\n      reply.serializer(() => serializedPayload).type('text/custom').send('needs to be serialized');\n    });\n    done();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/json'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.headers['content-length'], '17');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/text'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.payload, 'some text');\n    t.equal(res.headers['content-length'], '9');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/buffer'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.payload, 'buffer payload');\n    t.equal(res.headers['content-length'], '14');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/stream'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.payload, 'stream payload');\n    t.equal(res.headers['transfer-encoding'], 'chunked');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/custom-serializer'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.payload, 'serialized');\n    t.equal(res.headers['content-type'], 'text/custom');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"modify payload","suites":[],"updatePoint":{"line":1073,"column":20,"index":27461},"line":1073,"code":"test('modify payload', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  const modifiedPayload = {\n    hello: 'modified'\n  };\n  const anotherPayload = '\"winter is coming\"';\n  fastify.addHook('onSend', function (request, reply, thePayload, done) {\n    t.ok('onSend called');\n    t.same(JSON.parse(thePayload), payload);\n    thePayload = thePayload.replace('world', 'modified');\n    done(null, thePayload);\n  });\n  fastify.addHook('onSend', function (request, reply, thePayload, done) {\n    t.ok('onSend called');\n    t.same(JSON.parse(thePayload), modifiedPayload);\n    done(null, anotherPayload);\n  });\n  fastify.addHook('onSend', function (request, reply, thePayload, done) {\n    t.ok('onSend called');\n    t.equal(thePayload, anotherPayload);\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, anotherPayload);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '18');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"clear payload","suites":[],"updatePoint":{"line":1112,"column":19,"index":28563},"line":1112,"code":"test('clear payload', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.ok('onSend called');\n    reply.code(304);\n    done(null, null);\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 304);\n    t.equal(res.payload, '');\n    t.equal(res.headers['content-length'], undefined);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook throws","suites":[],"updatePoint":{"line":1136,"column":24,"index":29171},"line":1136,"code":"test('onSend hook throws', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    if (request.raw.method === 'DELETE') {\n      done(new Error('some error'));\n      return;\n    }\n\n    if (request.raw.method === 'PUT') {\n      throw new Error('some error');\n    }\n\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.delete('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.put('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'DELETE',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n    sget({\n      method: 'PUT',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook should receive valid request and reply objects if onRequest hook fails","suites":[],"updatePoint":{"line":1196,"column":88,"index":30672},"line":1196,"code":"test('onSend hook should receive valid request and reply objects if onRequest hook fails', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.decorateRequest('testDecorator', 'testDecoratorVal');\n  fastify.decorateReply('testDecorator', 'testDecoratorVal');\n  fastify.addHook('onRequest', function (req, reply, done) {\n    done(new Error('onRequest hook failed'));\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.equal(request.testDecorator, 'testDecoratorVal');\n    t.equal(reply.testDecorator, 'testDecoratorVal');\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hook should receive valid request and reply objects if a custom content type parser fails","suites":[],"updatePoint":{"line":1220,"column":102,"index":31466},"line":1220,"code":"test('onSend hook should receive valid request and reply objects if a custom content type parser fails', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.decorateRequest('testDecorator', 'testDecoratorVal');\n  fastify.decorateReply('testDecorator', 'testDecoratorVal');\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    done(new Error('content type parser failed'));\n  });\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.equal(request.testDecorator, 'testDecoratorVal');\n    t.equal(reply.testDecorator, 'testDecoratorVal');\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: 'body'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"Content-Length header should be updated if onSend hook modifies the payload","suites":[],"updatePoint":{"line":1245,"column":81,"index":32273},"line":1245,"code":"test('Content-Length header should be updated if onSend hook modifies the payload', t => {\n  t.plan(2);\n  const instance = Fastify();\n  instance.get('/', async (_, rep) => {\n    rep.header('content-length', 3);\n    return 'foo';\n  });\n  instance.addHook('onSend', async () => 'bar12233000');\n  instance.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payloadLength = Buffer.byteLength(res.body);\n    const contentLength = Number(res.headers['content-length']);\n    t.equal(payloadLength, contentLength);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"cannot add hook after binding","suites":[],"updatePoint":{"line":1263,"column":35,"index":32783},"line":1263,"code":"test('cannot add hook after binding', t => {\n  t.plan(2);\n  const instance = Fastify();\n  instance.get('/', function (request, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  instance.listen(0, err => {\n    t.error(err);\n    t.teardown(instance.server.close.bind(instance.server));\n\n    try {\n      instance.addHook('onRequest', () => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hooks should be able to block a request","suites":[],"updatePoint":{"line":1283,"column":55,"index":33224},"line":1283,"code":"test('onRequest hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('onRequest', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should be able to block a request","suites":[],"updatePoint":{"line":1316,"column":59,"index":34094},"line":1316,"code":"test('preValidation hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', (req, reply, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('preValidation', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation hooks should be able to change request body before validation","suites":[],"updatePoint":{"line":1349,"column":81,"index":34994},"line":1349,"code":"test('preValidation hooks should be able to change request body before validation', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', (req, _reply, done) => {\n    const buff = Buffer.from(req.body.message, 'base64');\n    req.body = JSON.parse(buff.toString('utf-8'));\n    done();\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          foo: {\n            type: 'string'\n          },\n          bar: {\n            type: 'number'\n          }\n        },\n        required: ['foo', 'bar']\n      }\n    }\n  }, (req, reply) => {\n    t.pass();\n    reply.status(200).send('hello');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'POST',\n    payload: {\n      message: Buffer.from(JSON.stringify({\n        foo: 'example',\n        bar: 1\n      })).toString('base64')\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should be able to block a request","suites":[],"updatePoint":{"line":1391,"column":56,"index":35940},"line":1391,"code":"test('preParsing hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', (req, reply, payload, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('preParsing', (req, reply, payload, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preHandler hooks should be able to block a request","suites":[],"updatePoint":{"line":1424,"column":56,"index":36827},"line":1424,"code":"test('preHandler hooks should be able to block a request', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preHandler', (req, reply, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.equal(payload, 'hello');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hooks should be able to block a request (last hook)","suites":[],"updatePoint":{"line":1454,"column":67,"index":37615},"line":1454,"code":"test('onRequest hooks should be able to block a request (last hook)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preHandler hooks should be able to block a request (last hook)","suites":[],"updatePoint":{"line":1484,"column":68,"index":38392},"line":1484,"code":"test('preHandler hooks should be able to block a request (last hook)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preHandler', (req, reply, done) => {\n    reply.send('hello');\n    done();\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.equal(payload, 'hello');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should handle errors","suites":[],"updatePoint":{"line":1511,"column":43,"index":39053},"line":1511,"code":"test('preParsing hooks should handle errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', (req, reply, payload, done) => {\n    const e = new Error('kaboom');\n    e.statusCode = 501;\n    throw e;\n  });\n  fastify.post('/', function (request, reply) {\n    reply.send(request.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 501);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Implemented',\n      message: 'kaboom',\n      statusCode: 501\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest respond with a stream","suites":[],"updatePoint":{"line":1538,"column":37,"index":39672},"line":1538,"code":"test('onRequest respond with a stream', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    const stream = fs.createReadStream(process.cwd() + '/test/stream.test.js', 'utf8'); // stream.pipe(res)\n    // res.once('finish', done)\n\n    reply.send(stream);\n  });\n  fastify.addHook('onRequest', (req, res, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preHandler respond with a stream","suites":[],"updatePoint":{"line":1572,"column":38,"index":40612},"line":1572,"code":"test('preHandler respond with a stream', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    t.ok('called');\n    done();\n  }); // we are calling `reply.send` inside the `preHandler` hook with a stream,\n  // this triggers the `onSend` hook event if `preHandler` has not yet finished\n\n  const order = [1, 2];\n  fastify.addHook('preHandler', (req, reply, done) => {\n    const stream = fs.createReadStream(process.cwd() + '/test/stream.test.js', 'utf8');\n    reply.send(stream);\n    reply.raw.once('finish', () => {\n      t.equal(order.shift(), 2);\n      done();\n    });\n  });\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.fail('this should not be called');\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.equal(order.shift(), 1);\n    t.equal(typeof payload.pipe, 'function');\n    done();\n  });\n  fastify.addHook('onResponse', (request, reply, done) => {\n    t.ok('called');\n    done();\n  });\n  fastify.get('/', function (request, reply) {\n    t.fail('we should not be here');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"Register an hook after a plugin inside a plugin","suites":[],"updatePoint":{"line":1613,"column":53,"index":41837},"line":1613,"code":"test('Register an hook after a plugin inside a plugin', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.get('/', function (request, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }));\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    done();\n  }));\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"Register an hook after a plugin inside a plugin (with preHandler option)","suites":[],"updatePoint":{"line":1650,"column":78,"index":42755},"line":1650,"code":"test('Register an hook after a plugin inside a plugin (with preHandler option)', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.get('/', {\n      preHandler: (req, reply, done) => {\n        t.ok('called');\n        done();\n      }\n    }, function (request, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }));\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.addHook('preHandler', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    done();\n  }));\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"Register hooks inside a plugin after an encapsulated plugin","suites":[],"updatePoint":{"line":1692,"column":65,"index":43759},"line":1692,"code":"test('Register hooks inside a plugin after an encapsulated plugin', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.get('/', function (request, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('onRequest', function (req, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.ok('called');\n      done();\n    });\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.ok('called');\n      done();\n    });\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.ok('called');\n      done();\n    });\n    done();\n  }));\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":1730,"column":71,"index":44757},"line":1730,"code":"test('onRequest hooks should run in the order in which they are defined', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.addHook('onRequest', function (req, reply, done) {\n      t.equal(req.previous, undefined);\n      req.previous = 1;\n      done();\n    });\n    instance.get('/', function (request, reply) {\n      t.equal(request.previous, 5);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onRequest', function (req, reply, done) {\n        t.equal(req.previous, 1);\n        req.previous = 2;\n        done();\n      });\n      done();\n    }));\n    done();\n  });\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('onRequest', function (req, reply, done) {\n      t.equal(req.previous, 2);\n      req.previous = 3;\n      done();\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onRequest', function (req, reply, done) {\n        t.equal(req.previous, 3);\n        req.previous = 4;\n        done();\n      });\n      done();\n    }));\n    instance.addHook('onRequest', function (req, reply, done) {\n      t.equal(req.previous, 4);\n      req.previous = 5;\n      done();\n    });\n    done();\n  }));\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preHandler hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":1784,"column":72,"index":46214},"line":1784,"code":"test('preHandler hooks should run in the order in which they are defined', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.equal(request.previous, undefined);\n      request.previous = 1;\n      done();\n    });\n    instance.get('/', function (request, reply) {\n      t.equal(request.previous, 5);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('preHandler', function (request, reply, done) {\n        t.equal(request.previous, 1);\n        request.previous = 2;\n        done();\n      });\n      done();\n    }));\n    done();\n  });\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.equal(request.previous, 2);\n      request.previous = 3;\n      done();\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('preHandler', function (request, reply, done) {\n        t.equal(request.previous, 3);\n        request.previous = 4;\n        done();\n      });\n      done();\n    }));\n    instance.addHook('preHandler', function (request, reply, done) {\n      t.equal(request.previous, 4);\n      request.previous = 5;\n      done();\n    });\n    done();\n  }));\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onSend hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":1838,"column":68,"index":47732},"line":1838,"code":"test('onSend hooks should run in the order in which they are defined', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(request.previous, undefined);\n      request.previous = 1;\n      done();\n    });\n    instance.get('/', function (request, reply) {\n      reply.send({});\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onSend', function (request, reply, payload, done) {\n        t.equal(request.previous, 1);\n        request.previous = 2;\n        done();\n      });\n      done();\n    }));\n    done();\n  });\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(request.previous, 2);\n      request.previous = 3;\n      done();\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onSend', function (request, reply, payload, done) {\n        t.equal(request.previous, 3);\n        request.previous = 4;\n        done();\n      });\n      done();\n    }));\n    instance.addHook('onSend', function (request, reply, payload, done) {\n      t.equal(request.previous, 4);\n      done(null, '5');\n    });\n    done();\n  }));\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), 5);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onResponse hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":1886,"column":72,"index":49167},"line":1886,"code":"test('onResponse hooks should run in the order in which they are defined', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.equal(reply.previous, undefined);\n      reply.previous = 1;\n      done();\n    });\n    instance.get('/', function (request, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onResponse', function (request, reply, done) {\n        t.equal(reply.previous, 1);\n        reply.previous = 2;\n        done();\n      });\n      done();\n    }));\n    done();\n  });\n  fastify.register(fp(function (instance, opts, done) {\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.equal(reply.previous, 2);\n      reply.previous = 3;\n      done();\n    });\n    instance.register(fp(function (i, opts, done) {\n      i.addHook('onResponse', function (request, reply, done) {\n        t.equal(reply.previous, 3);\n        reply.previous = 4;\n        done();\n      });\n      done();\n    }));\n    instance.addHook('onResponse', function (request, reply, done) {\n      t.equal(reply.previous, 4);\n      done();\n    });\n    done();\n  }));\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest, preHandler, and onResponse hooks that resolve to a value do not cause an error","suites":[],"updatePoint":{"line":1938,"column":95,"index":50630},"line":1938,"code":"test('onRequest, preHandler, and onResponse hooks that resolve to a value do not cause an error', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', () => Promise.resolve(1)).addHook('onRequest', () => Promise.resolve(true)).addHook('preValidation', () => Promise.resolve(null)).addHook('preValidation', () => Promise.resolve('a')).addHook('preHandler', () => Promise.resolve(null)).addHook('preHandler', () => Promise.resolve('a')).addHook('onResponse', () => Promise.resolve({})).addHook('onResponse', () => Promise.resolve([]));\n  fastify.get('/', (request, reply) => {\n    reply.send('hello');\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"If a response header has been set inside an hook it shoulod not be overwritten by the final response handler","suites":[],"updatePoint":{"line":1951,"column":114,"index":51417},"line":1951,"code":"test('If a response header has been set inside an hook it shoulod not be overwritten by the final response handler', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    reply.header('X-Custom-Header', 'hello');\n    done();\n  });\n  fastify.get('/', (request, reply) => {\n    reply.send('hello');\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['x-custom-header'], 'hello');\n    t.equal(res.headers['content-type'], 'text/plain; charset=utf-8');\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"If the content type has been set inside an hook it should not be changed","suites":[],"updatePoint":{"line":1969,"column":78,"index":51998},"line":1969,"code":"test('If the content type has been set inside an hook it should not be changed', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', (req, reply, done) => {\n    reply.header('content-type', 'text/html');\n    done();\n  });\n  fastify.get('/', (request, reply) => {\n    t.ok(reply[symbols.kReplyHeaders]['content-type']);\n    reply.send('hello');\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'text/html');\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'hello');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"request in onRequest, preParsing, preValidation and onResponse","suites":[],"updatePoint":{"line":1987,"column":68,"index":52556},"line":1987,"code":"test('request in onRequest, preParsing, preValidation and onResponse', t => {\n  t.plan(18);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', function (request, reply, done) {\n    t.same(request.body, null);\n    t.same(request.query, {\n      key: 'value'\n    });\n    t.same(request.params, {\n      greeting: 'hello'\n    });\n    t.same(request.headers, {\n      'content-length': '17',\n      'content-type': 'application/json',\n      host: 'localhost:80',\n      'user-agent': 'lightMyRequest',\n      'x-custom': 'hello'\n    });\n    done();\n  });\n  fastify.addHook('preParsing', function (request, reply, payload, done) {\n    t.same(request.body, null);\n    t.same(request.query, {\n      key: 'value'\n    });\n    t.same(request.params, {\n      greeting: 'hello'\n    });\n    t.same(request.headers, {\n      'content-length': '17',\n      'content-type': 'application/json',\n      host: 'localhost:80',\n      'user-agent': 'lightMyRequest',\n      'x-custom': 'hello'\n    });\n    done();\n  });\n  fastify.addHook('preValidation', function (request, reply, done) {\n    t.same(request.body, {\n      hello: 'world'\n    });\n    t.same(request.query, {\n      key: 'value'\n    });\n    t.same(request.params, {\n      greeting: 'hello'\n    });\n    t.same(request.headers, {\n      'content-length': '17',\n      'content-type': 'application/json',\n      host: 'localhost:80',\n      'user-agent': 'lightMyRequest',\n      'x-custom': 'hello'\n    });\n    done();\n  });\n  fastify.addHook('onResponse', function (request, reply, done) {\n    t.same(request.body, {\n      hello: 'world'\n    });\n    t.same(request.query, {\n      key: 'value'\n    });\n    t.same(request.params, {\n      greeting: 'hello'\n    });\n    t.same(request.headers, {\n      'content-length': '17',\n      'content-type': 'application/json',\n      host: 'localhost:80',\n      'user-agent': 'lightMyRequest',\n      'x-custom': 'hello'\n    });\n    done();\n  });\n  fastify.post('/:greeting', function (req, reply) {\n    reply.send('ok');\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/hello?key=value',\n    headers: {\n      'x-custom': 'hello'\n    },\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation hook should support encapsulation / 1","suites":[],"updatePoint":{"line":2079,"column":57,"index":54783},"line":2079,"code":"test('preValidation hook should support encapsulation / 1', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preValidation', (req, reply, done) => {\n      t.equal(req.raw.url, '/plugin');\n      done();\n    });\n    instance.get('/plugin', (request, reply) => {\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/root', (request, reply) => {\n    reply.send();\n  });\n  fastify.inject('/root', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject('/plugin', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation hook should support encapsulation / 2","suites":[],"updatePoint":{"line":2104,"column":57,"index":55433},"line":2104,"code":"test('preValidation hook should support encapsulation / 2', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let pluginInstance;\n  fastify.addHook('preValidation', () => {});\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preValidation', () => {});\n    pluginInstance = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(fastify[symbols.kHooks].preValidation.length, 1);\n    t.equal(pluginInstance[symbols.kHooks].preValidation.length, 2);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation hook should support encapsulation / 3","suites":[],"updatePoint":{"line":2120,"column":57,"index":55939},"line":2120,"code":"test('preValidation hook should support encapsulation / 3', t => {\n  t.plan(20);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('preValidation', function (req, reply, done) {\n    t.ok(this.hello);\n    t.ok(this.hello2);\n    req.first = true;\n    done();\n  });\n  fastify.decorate('hello2', 'world');\n  fastify.get('/first', (req, reply) => {\n    t.ok(req.first);\n    t.notOk(req.second);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello3', 'world');\n    instance.addHook('preValidation', function (req, reply, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      t.ok(this.hello3);\n      req.second = true;\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      t.ok(req.first);\n      t.ok(req.second);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onError hook","suites":[],"updatePoint":{"line":2183,"column":18,"index":57600},"line":2183,"code":"test('onError hook', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('kaboom');\n  fastify.addHook('onError', (request, reply, error, done) => {\n    t.match(error, err);\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send(err);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"reply.send should throw if called inside the onError hook","suites":[],"updatePoint":{"line":2206,"column":63,"index":58152},"line":2206,"code":"test('reply.send should throw if called inside the onError hook', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('kaboom');\n  fastify.addHook('onError', (request, reply, error, done) => {\n    try {\n      reply.send();\n      t.fail('Should throw');\n    } catch (err) {\n      t.equal(err.code, 'FST_ERR_SEND_INSIDE_ONERR');\n    }\n\n    done();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send(err);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onError hook with setErrorHandler","suites":[],"updatePoint":{"line":2235,"column":39,"index":58796},"line":2235,"code":"test('onError hook with setErrorHandler', t => {\n  t.test('Send error', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    const err = new Error('ouch');\n    fastify.setErrorHandler((_, req, reply) => {\n      reply.send(err);\n    });\n    fastify.addHook('onError', (request, reply, error, done) => {\n      t.match(error, err);\n      done();\n    });\n    fastify.get('/', (req, reply) => {\n      reply.send(new Error('kaboom'));\n    });\n    fastify.inject({\n      method: 'GET',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.same(JSON.parse(res.payload), {\n        error: 'Internal Server Error',\n        message: 'ouch',\n        statusCode: 500\n      });\n    });\n  });\n  t.test('Hide error', t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.setErrorHandler((_, req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    fastify.addHook('onError', (request, reply, error, done) => {\n      t.fail('Should not be called');\n    });\n    fastify.get('/', (req, reply) => {\n      reply.send(new Error('kaboom'));\n    });\n    fastify.inject({\n      method: 'GET',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.same(JSON.parse(res.payload), {\n        hello: 'world'\n      });\n    });\n  });\n  t.end();\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hook should run before parsing and be able to modify the payload","suites":[],"updatePoint":{"line":2288,"column":81,"index":60117},"line":2288,"code":"test('preParsing hook should run before parsing and be able to modify the payload', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', function (req, reply, payload, done) {\n    const modified = new stream.Readable();\n    modified.receivedEncodedLength = parseInt(req.headers['content-length'], 10);\n    modified.push(JSON.stringify({\n      hello: 'another world'\n    }));\n    modified.push(null);\n    done(null, modified);\n  });\n  fastify.route({\n    method: 'POST',\n    url: '/first',\n    handler: function (req, reply) {\n      reply.send(req.body);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/first',\n      body: {\n        hello: 'world'\n      },\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + JSON.stringify(body).length);\n      t.same(body, {\n        hello: 'another world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks can completely ignore the payload - deprecated syntax","suites":[],"updatePoint":{"line":2327,"column":76,"index":61212},"line":2327,"code":"test('preParsing hooks can completely ignore the payload - deprecated syntax', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  process.on('warning', onWarning);\n  warning.emitted.delete('FSTDEP004');\n\n  function onWarning(warning) {\n    t.equal(warning.name, 'FastifyDeprecation');\n    t.equal(warning.code, 'FSTDEP004');\n  }\n\n  fastify.addHook('preParsing', (req, reply, done) => {\n    done();\n  });\n  fastify.post('/', function (request, reply) {\n    reply.send(request.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":2358,"column":72,"index":61941},"line":2358,"code":"test('preParsing hooks should run in the order in which they are defined', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', function (req, reply, payload, done) {\n    const modified = new stream.Readable();\n    modified.receivedEncodedLength = parseInt(req.headers['content-length'], 10);\n    modified.push('{\"hello\":');\n    done(null, modified);\n  });\n  fastify.addHook('preParsing', function (req, reply, payload, done) {\n    payload.push('\"another world\"}');\n    payload.push(null);\n    done(null, payload);\n  });\n  fastify.route({\n    method: 'POST',\n    url: '/first',\n    handler: function (req, reply) {\n      reply.send(req.body);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/first',\n      body: {\n        hello: 'world'\n      },\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + JSON.stringify(body).length);\n      t.same(body, {\n        hello: 'another world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hooks should support encapsulation","suites":[],"updatePoint":{"line":2399,"column":51,"index":63109},"line":2399,"code":"test('preParsing hooks should support encapsulation', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', function (req, reply, payload, done) {\n    const modified = new stream.Readable();\n    modified.receivedEncodedLength = parseInt(req.headers['content-length'], 10);\n    modified.push('{\"hello\":\"another world\"}');\n    modified.push(null);\n    done(null, modified);\n  });\n  fastify.post('/first', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preParsing', function (req, reply, payload, done) {\n      const modified = new stream.Readable();\n      modified.receivedEncodedLength = payload.receivedEncodedLength || parseInt(req.headers['content-length'], 10);\n      modified.push('{\"hello\":\"encapsulated world\"}');\n      modified.push(null);\n      done(null, modified);\n    });\n    instance.post('/second', (req, reply) => {\n      reply.send(req.body);\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/first',\n      body: {\n        hello: 'world'\n      },\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + JSON.stringify(body).length);\n      t.same(body, {\n        hello: 'another world'\n      });\n    });\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port + '/second',\n      body: {\n        hello: 'world'\n      },\n      json: true\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + JSON.stringify(body).length);\n      t.same(body, {\n        hello: 'encapsulated world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hook should support encapsulation / 1","suites":[],"updatePoint":{"line":2460,"column":54,"index":65028},"line":2460,"code":"test('preParsing hook should support encapsulation / 1', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preParsing', (req, reply, payload, done) => {\n      t.equal(req.raw.url, '/plugin');\n      done();\n    });\n    instance.get('/plugin', (request, reply) => {\n      reply.send();\n    });\n    done();\n  });\n  fastify.get('/root', (request, reply) => {\n    reply.send();\n  });\n  fastify.inject('/root', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject('/plugin', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hook should support encapsulation / 2","suites":[],"updatePoint":{"line":2485,"column":54,"index":65681},"line":2485,"code":"test('preParsing hook should support encapsulation / 2', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  let pluginInstance;\n  fastify.addHook('preParsing', function a() {});\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preParsing', function b() {});\n    pluginInstance = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(fastify[symbols.kHooks].preParsing.length, 1);\n    t.equal(pluginInstance[symbols.kHooks].preParsing.length, 2);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing hook should support encapsulation / 3","suites":[],"updatePoint":{"line":2501,"column":54,"index":66186},"line":2501,"code":"test('preParsing hook should support encapsulation / 3', t => {\n  t.plan(20);\n  const fastify = Fastify();\n  fastify.decorate('hello', 'world');\n  fastify.addHook('preParsing', function (req, reply, payload, done) {\n    t.ok(this.hello);\n    t.ok(this.hello2);\n    req.first = true;\n    done();\n  });\n  fastify.decorate('hello2', 'world');\n  fastify.get('/first', (req, reply) => {\n    t.ok(req.first);\n    t.notOk(req.second);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.decorate('hello3', 'world');\n    instance.addHook('preParsing', function (req, reply, payload, done) {\n      t.ok(this.hello);\n      t.ok(this.hello2);\n      t.ok(this.hello3);\n      req.second = true;\n      done();\n    });\n    instance.get('/second', (req, reply) => {\n      t.ok(req.first);\n      t.ok(req.second);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hook should run before serialization and be able to modify the payload","suites":[],"updatePoint":{"line":2564,"column":93,"index":67934},"line":2564,"code":"test('preSerialization hook should run before serialization and be able to modify the payload', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    payload.hello += '1';\n    payload.world = 'ok';\n    done(null, payload);\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/first',\n    handler: function (req, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    },\n    schema: {\n      response: {\n        200: {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'string'\n            },\n            world: {\n              type: 'string'\n            }\n          },\n          required: ['world'],\n          additionalProperties: false\n        }\n      }\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world1',\n        world: 'ok'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hook should be able to throw errors which are validated against schema response","suites":[],"updatePoint":{"line":2615,"column":102,"index":69189},"line":2615,"code":"test('preSerialization hook should be able to throw errors which are validated against schema response', t => {\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    done(new Error('preSerialization aborted'));\n  });\n  fastify.setErrorHandler((err, request, reply) => {\n    t.equal(err.message, 'preSerialization aborted');\n    err.world = 'error';\n    reply.send(err);\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/first',\n    handler: function (req, reply) {\n      reply.send({\n        world: 'hello'\n      });\n    },\n    schema: {\n      response: {\n        500: {\n          type: 'object',\n          properties: {\n            world: {\n              type: 'string'\n            }\n          },\n          required: ['world'],\n          additionalProperties: false\n        }\n      }\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        world: 'error'\n      });\n      t.end();\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hook which returned error should still run onError hooks","suites":[],"updatePoint":{"line":2665,"column":79,"index":70467},"line":2665,"code":"test('preSerialization hook which returned error should still run onError hooks', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    done(new Error('preSerialization aborted'));\n  });\n  fastify.addHook('onError', function (req, reply, payload, done) {\n    t.pass();\n    done();\n  });\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hooks should run in the order in which they are defined","suites":[],"updatePoint":{"line":2692,"column":78,"index":71217},"line":2692,"code":"test('preSerialization hooks should run in the order in which they are defined', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    payload.hello += '2';\n    done(null, payload);\n  });\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    payload.hello += '1';\n    done(null, payload);\n  });\n  fastify.get('/first', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world21'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization hooks should support encapsulation","suites":[],"updatePoint":{"line":2722,"column":57,"index":72098},"line":2722,"code":"test('preSerialization hooks should support encapsulation', t => {\n  t.plan(9);\n  const fastify = Fastify();\n  fastify.addHook('preSerialization', function (req, reply, payload, done) {\n    payload.hello += '1';\n    done(null, payload);\n  });\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addHook('preSerialization', function (req, reply, payload, done) {\n      payload.hello += '2';\n      done(null, payload);\n    });\n    instance.get('/second', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world1'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world12'\n      });\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRegister hook should be called / 1","suites":[],"updatePoint":{"line":2773,"column":42,"index":73511},"line":2773,"code":"test('onRegister hook should be called / 1', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('onRegister', (instance, opts) => {\n    // duck typing for the win!\n    t.ok(instance.addHook);\n    t.same(opts, pluginOpts);\n  });\n  const pluginOpts = {\n    prefix: 'hello',\n    custom: 'world'\n  };\n  fastify.register((instance, opts, done) => {\n    done();\n  }, pluginOpts);\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRegister hook should be called / 2","suites":[],"updatePoint":{"line":2792,"column":42,"index":73954},"line":2792,"code":"test('onRegister hook should be called / 2', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addHook('onRegister', instance => {\n    // duck typing for the win!\n    t.ok(instance.addHook);\n  });\n  fastify.register((instance, opts, done) => {\n    instance.register((instance, opts, done) => {\n      done();\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRegister hook should be called / 3","suites":[],"updatePoint":{"line":2812,"column":42,"index":74415},"line":2812,"code":"test('onRegister hook should be called / 3', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.decorate('data', []);\n  fastify.addHook('onRegister', instance => {\n    instance.data = instance.data.slice();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.data.push(1);\n    instance.register((instance, opts, done) => {\n      instance.data.push(2);\n      t.same(instance.data, [1, 2]);\n      done();\n    });\n    t.same(instance.data, [1]);\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    t.same(instance.data, []);\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onRegister hook should be called (encapsulation)","suites":[],"updatePoint":{"line":2837,"column":54,"index":75059},"line":2837,"code":"test('onRegister hook should be called (encapsulation)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n\n  plugin[Symbol.for('skip-override')] = true;\n  fastify.addHook('onRegister', (instance, opts) => {\n    t.fail('This should not be called');\n  });\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"early termination, onRequest","suites":[],"updatePoint":{"line":2854,"column":34,"index":75433},"line":2854,"code":"test('early termination, onRequest', t => {\n  t.plan(3);\n  const app = Fastify();\n  app.addHook('onRequest', (req, reply) => {\n    setImmediate(() => reply.send('hello world'));\n    return reply;\n  });\n  app.get('/', (req, reply) => {\n    t.fail('should not happen');\n  });\n  app.inject('/', function (err, res) {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.body.toString(), 'hello world');\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"reply.send should throw if undefined error is thrown","suites":[],"updatePoint":{"line":2870,"column":58,"index":75882},"line":2870,"code":"test('reply.send should throw if undefined error is thrown', t => {\n  /* eslint prefer-promise-reject-errors: [\"error\", {\"allowEmptyReject\": true}] */\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', function (req, reply, done) {\n    return Promise.reject();\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send('hello');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      code: 'FST_ERR_SEND_UNDEFINED_ERR',\n      message: 'Undefined error has occurred',\n      statusCode: 500\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onTimeout should be triggered","suites":[],"updatePoint":{"line":2894,"column":35,"index":76545},"line":2894,"code":"test('onTimeout should be triggered', t => {\n  t.plan(6);\n  const fastify = Fastify({\n    connectionTimeout: 500\n  });\n  fastify.addHook('onTimeout', function (req, res, done) {\n    t.ok('called', 'onTimeout');\n    done();\n  });\n  fastify.get('/', async (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/timeout', async (req, reply) => {});\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: address\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n    sget({\n      method: 'GET',\n      url: `${address}/timeout`\n    }, (err, response, body) => {\n      t.type(err, Error);\n      t.equal(err.message, 'socket hang up');\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"onTimeout should be triggered and socket _meta is set","suites":[],"updatePoint":{"line":2928,"column":59,"index":77385},"line":2928,"code":"test('onTimeout should be triggered and socket _meta is set', t => {\n  t.plan(6);\n  const fastify = Fastify({\n    connectionTimeout: 500\n  });\n  fastify.addHook('onTimeout', function (req, res, done) {\n    t.ok('called', 'onTimeout');\n    done();\n  });\n  fastify.get('/', async (req, reply) => {\n    req.raw.socket._meta = {};\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/timeout', async (req, reply) => {});\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: address\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n    sget({\n      method: 'GET',\n      url: `${address}/timeout`\n    }, (err, response, body) => {\n      t.type(err, Error);\n      t.equal(err.message, 'socket hang up');\n    });\n  });\n});","file":"hooks.test.js","skipped":false,"dir":"test"},{"name":"A route supports host constraints under http2 protocol and secure connection","suites":[],"updatePoint":{"line":23,"column":82,"index":375},"line":23,"code":"test('A route supports host constraints under http2 protocol and secure connection', t => {\n  t.plan(5);\n  let fastify;\n\n  try {\n    fastify = Fastify({\n      http2: true,\n      https: {\n        key: global.context.key,\n        cert: global.context.cert\n      }\n    });\n    t.pass('Key/cert successfully loaded');\n  } catch (e) {\n    t.fail('Key/cert loading failed', e);\n  }\n\n  const constrain = 'fastify.io';\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: function (_, reply) {\n      reply.code(200).send(alpha);\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/beta',\n    constraints: {\n      host: constrain\n    },\n    handler: function (_, reply) {\n      reply.code(200).send(beta);\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    t.test('https get request - no constrain', async t => {\n      t.plan(3);\n      const url = `https://localhost:${fastify.server.address().port}`;\n      const res = await h2url.concat({\n        url\n      });\n      t.equal(res.headers[':status'], 200);\n      t.equal(res.headers['content-length'], '' + JSON.stringify(alpha).length);\n      t.same(JSON.parse(res.body), alpha);\n    });\n    t.test('https get request - constrain', async t => {\n      t.plan(3);\n      const url = `https://localhost:${fastify.server.address().port}/beta`;\n      const res = await h2url.concat({\n        url,\n        headers: {\n          ':authority': constrain\n        }\n      });\n      t.equal(res.headers[':status'], 200);\n      t.equal(res.headers['content-length'], '' + JSON.stringify(beta).length);\n      t.same(JSON.parse(res.body), beta);\n    });\n    t.test('https get request - constrain - not found', async t => {\n      t.plan(1);\n      const url = `https://localhost:${fastify.server.address().port}/beta`;\n      const res = await h2url.concat({\n        url\n      });\n      t.equal(res.headers[':status'], 404);\n    });\n  });\n});","file":"http2/constraint.test.js","skipped":false,"dir":"test"},{"name":"http HEAD request","suites":[],"updatePoint":{"line":31,"column":25,"index":492},"line":31,"code":"  test('http HEAD request', async t => {\n    t.plan(1);\n    const url = `http://localhost:${fastify.server.address().port}`;\n    const res = await h2url.concat({\n      url,\n      method: 'HEAD'\n    });\n    t.equal(res.headers[':status'], 200);\n  });","file":"http2/head.test.js","skipped":false,"dir":"test"},{"name":"should throw when http2 module cannot be found","suites":[],"updatePoint":{"line":15,"column":52,"index":296},"line":15,"code":"test('should throw when http2 module cannot be found', t => {\n  t.plan(2);\n\n  try {\n    Fastify({\n      http2: true\n    });\n    t.fail('fastify did not throw expected error');\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_HTTP2_INVALID_VERSION');\n    t.equal(err.message, 'HTTP2 is available only from node >= 8.8.1');\n  }\n});","file":"http2/missing-http2-module.test.js","skipped":false,"dir":"test"},{"name":"http get request","suites":[],"updatePoint":{"line":34,"column":24,"index":582},"line":34,"code":"  test('http get request', async t => {\n    t.plan(3);\n    const url = `http://localhost:${fastify.server.address().port}`;\n    const res = await h2url.concat({\n      url\n    });\n    t.equal(res.headers[':status'], 200);\n    t.equal(res.headers['content-length'], '' + JSON.stringify(msg).length);\n    t.same(JSON.parse(res.body), msg);\n  });","file":"http2/plain.test.js","skipped":false,"dir":"test"},{"name":"http hostname","suites":[],"updatePoint":{"line":44,"column":21,"index":922},"line":44,"code":"  test('http hostname', async t => {\n    t.plan(1);\n    const hostname = `localhost:${fastify.server.address().port}`;\n    const url = `http://${hostname}/hostname`;\n    const res = await h2url.concat({\n      url\n    });\n    t.equal(res.body, hostname);\n  });","file":"http2/plain.test.js","skipped":false,"dir":"test"},{"name":"secure with fallback","suites":[],"updatePoint":{"line":22,"column":26,"index":331},"line":22,"code":"test('secure with fallback', t => {\n  t.plan(7);\n  let fastify;\n\n  try {\n    fastify = Fastify({\n      http2: true,\n      https: {\n        allowHTTP1: true,\n        key: global.context.key,\n        cert: global.context.cert\n      }\n    });\n    t.pass('Key/cert successfully loaded');\n  } catch (e) {\n    t.fail('Key/cert loading failed', e);\n  }\n\n  fastify.get('/', function (req, reply) {\n    reply.code(200).send(msg);\n  });\n  fastify.post('/', function (req, reply) {\n    reply.code(200).send(req.body);\n  });\n  fastify.get('/error', async function (req, reply) {\n    throw new Error('kaboom');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    t.test('https get error', async t => {\n      t.plan(1);\n      const url = `https://localhost:${fastify.server.address().port}/error`;\n      const res = await h2url.concat({\n        url\n      });\n      t.equal(res.headers[':status'], 500);\n    });\n    t.test('https post', async t => {\n      t.plan(2);\n      const url = `https://localhost:${fastify.server.address().port}`;\n      const res = await h2url.concat({\n        url,\n        method: 'POST',\n        body: JSON.stringify({\n          hello: 'http2'\n        }),\n        headers: {\n          'content-type': 'application/json'\n        }\n      });\n      t.equal(res.headers[':status'], 200);\n      t.same(JSON.parse(res.body), {\n        hello: 'http2'\n      });\n    });\n    t.test('https get request', async t => {\n      t.plan(3);\n      const url = `https://localhost:${fastify.server.address().port}`;\n      const res = await h2url.concat({\n        url\n      });\n      t.equal(res.headers[':status'], 200);\n      t.equal(res.headers['content-length'], '' + JSON.stringify(msg).length);\n      t.same(JSON.parse(res.body), msg);\n    });\n    t.test('http1 get request', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'https://localhost:' + fastify.server.address().port,\n        rejectUnauthorized: false\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-length'], '' + body.length);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });\n    t.test('http1 get error', t => {\n      t.plan(2);\n      sget({\n        method: 'GET',\n        url: 'https://localhost:' + fastify.server.address().port + '/error',\n        rejectUnauthorized: false\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 500);\n      });\n    });\n  });\n});","file":"http2/secure-with-fallback.test.js","skipped":false,"dir":"test"},{"name":"secure","suites":[],"updatePoint":{"line":20,"column":12,"index":273},"line":20,"code":"test('secure', t => {\n  t.plan(4);\n  let fastify;\n\n  try {\n    fastify = Fastify({\n      http2: true,\n      https: {\n        key: global.context.key,\n        cert: global.context.cert\n      }\n    });\n    t.pass('Key/cert successfully loaded');\n  } catch (e) {\n    t.fail('Key/cert loading failed', e);\n  }\n\n  fastify.get('/', function (req, reply) {\n    reply.code(200).send(msg);\n  });\n  fastify.get('/proto', function (req, reply) {\n    reply.code(200).send({\n      proto: req.protocol\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    t.test('https get request', async t => {\n      t.plan(3);\n      const url = `https://localhost:${fastify.server.address().port}`;\n      const res = await h2url.concat({\n        url\n      });\n      t.equal(res.headers[':status'], 200);\n      t.equal(res.headers['content-length'], '' + JSON.stringify(msg).length);\n      t.same(JSON.parse(res.body), msg);\n    });\n    t.test('https get request without trust proxy - protocol', async t => {\n      t.plan(2);\n      const url = `https://localhost:${fastify.server.address().port}/proto`;\n      t.same(JSON.parse((await h2url.concat({\n        url\n      })).body), {\n        proto: 'https'\n      });\n      t.same(JSON.parse((await h2url.concat({\n        url,\n        headers: {\n          'X-Forwarded-Proto': 'lorem'\n        }\n      })).body), {\n        proto: 'https'\n      });\n    });\n  });\n});","file":"http2/secure.test.js","skipped":false,"dir":"test"},{"name":"http UNKNOWN_METHOD request","suites":[],"updatePoint":{"line":31,"column":35,"index":502},"line":31,"code":"  test('http UNKNOWN_METHOD request', async t => {\n    t.plan(2);\n    const url = `http://localhost:${fastify.server.address().port}`;\n    const res = await h2url.concat({\n      url,\n      method: 'UNKNOWN_METHOD'\n    });\n    t.equal(res.headers[':status'], 404);\n    t.same(JSON.parse(res.body), {\n      statusCode: 404,\n      error: 'Not Found',\n      message: 'Not Found'\n    });\n  });","file":"http2/unknown-http-method.test.js","skipped":false,"dir":"test"},{"name":"Should support a custom https server","suites":[],"updatePoint":{"line":18,"column":42,"index":312},"line":18,"code":"test('Should support a custom https server', t => {\n  t.plan(6);\n\n  const serverFactory = (handler, opts) => {\n    t.ok(opts.serverFactory);\n    const options = {\n      key: global.context.key,\n      cert: global.context.cert\n    };\n    const server = https.createServer(options, (req, res) => {\n      req.custom = true;\n      handler(req, res);\n    });\n    return server;\n  };\n\n  const fastify = Fastify({\n    serverFactory\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/', (req, reply) => {\n    t.ok(req.raw.custom);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'https://localhost:' + fastify.server.address().port,\n      rejectUnauthorized: false\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"https/custom-https-server.test.js","skipped":false,"dir":"test"},{"name":"https","suites":[],"updatePoint":{"line":16,"column":11,"index":248},"line":16,"code":"test('https', t => {\n  t.plan(4);\n  let fastify;\n\n  try {\n    fastify = Fastify({\n      https: {\n        key: global.context.key,\n        cert: global.context.cert\n      }\n    });\n    t.pass('Key/cert successfully loaded');\n  } catch (e) {\n    t.fail('Key/cert loading failed', e);\n  }\n\n  fastify.get('/', function (req, reply) {\n    reply.code(200).send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/proto', function (req, reply) {\n    reply.code(200).send({\n      proto: req.protocol\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    t.test('https get request', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'https://localhost:' + fastify.server.address().port,\n        rejectUnauthorized: false\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-length'], '' + body.length);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });\n    t.test('https get request without trust proxy - protocol', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'https://localhost:' + fastify.server.address().port + '/proto',\n        rejectUnauthorized: false\n      }, (err, response, body) => {\n        t.error(err);\n        t.same(JSON.parse(body), {\n          proto: 'https'\n        });\n      });\n      sget({\n        method: 'GET',\n        url: 'https://localhost:' + fastify.server.address().port + '/proto',\n        rejectUnauthorized: false,\n        headers: {\n          'x-forwarded-proto': 'lorem'\n        }\n      }, (err, response, body) => {\n        t.error(err);\n        t.same(JSON.parse(body), {\n          proto: 'https'\n        });\n      });\n    });\n  });\n});","file":"https/https.test.js","skipped":false,"dir":"test"},{"name":"should import as default","suites":[],"updatePoint":{"line":6,"column":30,"index":94},"line":6,"code":"test('should import as default', t => {\n  t.plan(2);\n\n  const fastify = require('..');\n\n  t.ok(fastify);\n  t.equal(typeof fastify, 'function');\n});","file":"imports.test.js","skipped":false,"dir":"test"},{"name":"should import as esm","suites":[],"updatePoint":{"line":14,"column":26,"index":238},"line":14,"code":"test('should import as esm', t => {\n  t.plan(2);\n\n  const {\n    fastify\n  } = require('..');\n\n  t.ok(fastify);\n  t.equal(typeof fastify, 'function');\n});","file":"imports.test.js","skipped":false,"dir":"test"},{"name":"inject should exist","suites":[],"updatePoint":{"line":15,"column":25,"index":228},"line":15,"code":"test('inject should exist', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.ok(fastify.inject);\n  t.equal(typeof fastify.inject, 'function');\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should wait for the ready event","suites":[],"updatePoint":{"line":21,"column":37,"index":391},"line":21,"code":"test('should wait for the ready event', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.register((instance, opts, done) => {\n    instance.get('/', (req, reply) => {\n      reply.send(payload);\n    });\n    setTimeout(done, 500);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(payload, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request","suites":[],"updatePoint":{"line":43,"column":24,"index":896},"line":43,"code":"test('inject get request', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(payload, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - code check","suites":[],"updatePoint":{"line":62,"column":37,"index":1327},"line":62,"code":"test('inject get request - code check', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.code(201).send(payload);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(payload, JSON.parse(res.payload));\n    t.equal(res.statusCode, 201);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - headers check","suites":[],"updatePoint":{"line":81,"column":40,"index":1771},"line":81,"code":"test('inject get request - headers check', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.header('content-type', 'text/plain').send('');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal('', res.payload);\n    t.equal(res.headers['content-type'], 'text/plain');\n    t.equal(res.headers['content-length'], '0');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - querystring","suites":[],"updatePoint":{"line":97,"column":38,"index":2196},"line":97,"code":"test('inject get request - querystring', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send(req.query);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/?hello=world'\n  }, (err, res) => {\n    t.error(err);\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - params","suites":[],"updatePoint":{"line":115,"column":33,"index":2614},"line":115,"code":"test('inject get request - params', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/:hello', (req, reply) => {\n    reply.send(req.params);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/world'\n  }, (err, res) => {\n    t.error(err);\n    t.same({\n      hello: 'world'\n    }, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - wildcard","suites":[],"updatePoint":{"line":133,"column":35,"index":3034},"line":133,"code":"test('inject get request - wildcard', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/test/*', (req, reply) => {\n    reply.send(req.params);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test/wildcard'\n  }, (err, res) => {\n    t.error(err);\n    t.same({\n      '*': 'wildcard'\n    }, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '16');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - headers","suites":[],"updatePoint":{"line":151,"column":34,"index":3462},"line":151,"code":"test('inject get request - headers', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send(req.headers);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal('world', JSON.parse(res.payload).hello);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '69');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject post request","suites":[],"updatePoint":{"line":170,"column":25,"index":3891},"line":170,"code":"test('inject post request', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload\n  }, (err, res) => {\n    t.error(err);\n    t.same(payload, JSON.parse(res.payload));\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject post request - send stream","suites":[],"updatePoint":{"line":190,"column":39,"index":4340},"line":190,"code":"test('inject post request - send stream', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    headers: {\n      'content-type': 'application/json'\n    },\n    payload: getStream()\n  }, (err, res) => {\n    t.error(err);\n    t.same('{\"hello\":\"world\"}', res.payload);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-length'], '17');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject get request - reply stream","suites":[],"updatePoint":{"line":210,"column":39,"index":4821},"line":210,"code":"test('inject get request - reply stream', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send(getStream());\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same('{\"hello\":\"world\"}', res.payload);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject promisify - waiting for ready event","suites":[],"updatePoint":{"line":225,"column":48,"index":5173},"line":225,"code":"test('inject promisify - waiting for ready event', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  const injectParams = {\n    method: 'GET',\n    url: '/'\n  };\n  fastify.inject(injectParams).then(res => {\n    t.equal(res.statusCode, 200);\n  }).catch(t.fail);\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject promisify - after the ready event","suites":[],"updatePoint":{"line":242,"column":46,"index":5548},"line":242,"code":"test('inject promisify - after the ready event', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.ready(err => {\n    t.error(err);\n    const injectParams = {\n      method: 'GET',\n      url: '/'\n    };\n    fastify.inject(injectParams).then(res => {\n      t.equal(res.statusCode, 200);\n    }).catch(t.fail);\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject promisify - when the server is up","suites":[],"updatePoint":{"line":262,"column":46,"index":5986},"line":262,"code":"test('inject promisify - when the server is up', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  fastify.ready(err => {\n    t.error(err); // setTimeout because the ready event don't set \"started\" flag\n    // in this iteration of the 'event loop'\n\n    setTimeout(() => {\n      const injectParams = {\n        method: 'GET',\n        url: '/'\n      };\n      fastify.inject(injectParams).then(res => {\n        t.equal(res.statusCode, 200);\n      }).catch(t.fail);\n    }, 10);\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should reject in error case","suites":[],"updatePoint":{"line":286,"column":33,"index":6569},"line":286,"code":"test('should reject in error case', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const error = new Error('DOOM!');\n  fastify.register((instance, opts, done) => {\n    setTimeout(done, 500, error);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }).catch(e => {\n    t.equal(e, error);\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"inject a multipart request using form-body","suites":[],"updatePoint":{"line":300,"column":48,"index":6894},"line":300,"code":"test('inject a multipart request using form-body', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addContentTypeParser('*', function (req, payload, done) {\n    let body = '';\n    payload.on('data', d => {\n      body += d;\n    });\n    payload.on('end', () => {\n      done(null, body);\n    });\n  });\n  fastify.post('/', (req, reply) => {\n    reply.send(req.body);\n  });\n  const form = new FormData();\n  form.append('my_field', 'my value');\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: form\n  }).then(response => {\n    t.equal(response.statusCode, 200);\n    t.ok(/Content-Disposition: form-data; name=\"my_field\"/.test(response.payload));\n  });\n}); // https://github.com/hapijs/shot/blob/master/test/index.js#L836","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should error the promise if ready errors","suites":[],"updatePoint":{"line":343,"column":46,"index":7932},"line":343,"code":"test('should error the promise if ready errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register((instance, opts) => {\n    return Promise.reject(new Error('kaboom'));\n  }).after(function () {\n    t.pass('after is called');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }).then(() => {\n    t.fail('this should not be called');\n  }).catch(err => {\n    t.ok(err);\n    t.equal(err.message, 'kaboom');\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should throw error if callback specified and if ready errors","suites":[],"updatePoint":{"line":361,"column":66,"index":8392},"line":361,"code":"test('should throw error if callback specified and if ready errors', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  const error = new Error('kaboom');\n  fastify.register((instance, opts) => {\n    return Promise.reject(error);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, err => {\n    t.ok(err);\n    t.equal(err, error);\n  });\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should support builder-style injection with ready app","suites":[],"updatePoint":{"line":376,"column":59,"index":8736},"line":376,"code":"test('should support builder-style injection with ready app', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  await fastify.ready();\n  const res = await fastify.inject().get('/').end();\n  t.same(payload, JSON.parse(res.payload));\n  t.equal(res.statusCode, 200);\n  t.equal(res.headers['content-length'], '17');\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should support builder-style injection with non-ready app","suites":[],"updatePoint":{"line":391,"column":63,"index":9175},"line":391,"code":"test('should support builder-style injection with non-ready app', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const payload = {\n    hello: 'world'\n  };\n  fastify.get('/', (req, reply) => {\n    reply.send(payload);\n  });\n  const res = await fastify.inject().get('/').end();\n  t.same(payload, JSON.parse(res.payload));\n  t.equal(res.statusCode, 200);\n  t.equal(res.headers['content-length'], '17');\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"should handle errors in builder-style injection correctly","suites":[],"updatePoint":{"line":405,"column":63,"index":9589},"line":405,"code":"test('should handle errors in builder-style injection correctly', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    done(new Error('Kaboom'));\n  });\n\n  try {\n    await fastify.inject().get('/');\n  } catch (err) {\n    t.ok(err);\n    t.equal(err.message, 'Kaboom');\n  }\n});","file":"inject.test.js","skipped":false,"dir":"test"},{"name":"fastify.all should add all the methods to the same url","suites":[],"updatePoint":{"line":10,"column":60,"index":247},"line":10,"code":"test('fastify.all should add all the methods to the same url', t => {\n  t.plan(supportedMethods.length * 2);\n  const fastify = Fastify();\n  fastify.all('/', (req, reply) => {\n    reply.send({\n      method: req.raw.method\n    });\n  });\n  supportedMethods.forEach(injectRequest);\n\n  function injectRequest(method) {\n    const options = {\n      url: '/',\n      method\n    };\n\n    if (method === 'POST' || method === 'PUT' || method === 'PATCH') {\n      options.payload = {\n        hello: 'world'\n      };\n    }\n\n    fastify.inject(options, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        method\n      });\n    });\n  }\n});","file":"internals/all.test.js","skipped":false,"dir":"test"},{"name":"rawBody function","suites":[],"updatePoint":{"line":21,"column":22,"index":323},"line":21,"code":"test('rawBody function', t => {\n  t.plan(2);\n\n  const internals = require('../../lib/contentTypeParser')[kTestInternals];\n\n  const body = Buffer.from(' ');\n  const parser = {\n    asString: true,\n    asBuffer: false,\n\n    fn(req, bodyInString, done) {\n      t.equal(bodyInString, body.toString());\n      t.equal(typeof done, 'function');\n      return {\n        then(cb) {\n          cb();\n        }\n\n      };\n    }\n\n  };\n  const res = {};\n\n  res.end = () => {};\n\n  res.writeHead = () => {};\n\n  res.log = {\n    error: () => {},\n    info: () => {}\n  };\n  const context = {\n    Reply,\n    Request,\n    preHandler: [],\n    onSend: [],\n    _parserOptions: {\n      limit: 1024\n    }\n  };\n  const rs = new Readable();\n\n  rs._read = function () {};\n\n  rs.headers = {\n    'content-length': body.length\n  };\n  const request = new Request('id', 'params', rs, 'query', 'log', context);\n  const reply = new Reply(res, request);\n\n  const done = () => {};\n\n  internals.rawBody(request, reply, reply.context._parserOptions, parser, done);\n  rs.emit('data', body.toString());\n  rs.emit('end');\n});","file":"internals/contentTypeParser.test.js","skipped":false,"dir":"test"},{"name":"Should support Webpack and faux modules","suites":[],"updatePoint":{"line":78,"column":45,"index":1429},"line":78,"code":"test('Should support Webpack and faux modules', t => {\n  t.plan(2);\n  const internals = proxyquire('../../lib/contentTypeParser', {\n    'tiny-lru': {\n      default: () => {}\n    }\n  })[kTestInternals];\n  const body = Buffer.from(' ');\n  const parser = {\n    asString: true,\n    asBuffer: false,\n\n    fn(req, bodyInString, done) {\n      t.equal(bodyInString, body.toString());\n      t.equal(typeof done, 'function');\n      return {\n        then(cb) {\n          cb();\n        }\n\n      };\n    }\n\n  };\n  const res = {};\n\n  res.end = () => {};\n\n  res.writeHead = () => {};\n\n  res.log = {\n    error: () => {},\n    info: () => {}\n  };\n  const context = {\n    Reply,\n    Request,\n    preHandler: [],\n    onSend: [],\n    _parserOptions: {\n      limit: 1024\n    }\n  };\n  const rs = new Readable();\n\n  rs._read = function () {};\n\n  rs.headers = {\n    'content-length': body.length\n  };\n  const request = new Request('id', 'params', rs, 'query', 'log', context);\n  const reply = new Reply(res, request);\n\n  const done = () => {};\n\n  internals.rawBody(request, reply, reply.context._parserOptions, parser, done);\n  rs.emit('data', body.toString());\n  rs.emit('end');\n});","file":"internals/contentTypeParser.test.js","skipped":false,"dir":"test"},{"name":"decorate should add the given method to its instance","suites":[],"updatePoint":{"line":14,"column":58,"index":263},"line":14,"code":"test('decorate should add the given method to its instance', t => {\n  t.plan(1);\n\n  function build() {\n    server.add = decorator.add;\n    server[kState] = {\n      listening: false,\n      closing: false,\n      started: false\n    };\n    return server;\n\n    function server() {}\n  }\n\n  const server = build();\n  server.add('test', () => {});\n  t.ok(server.test);\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate is chainable","suites":[],"updatePoint":{"line":33,"column":27,"index":597},"line":33,"code":"test('decorate is chainable', t => {\n  t.plan(3);\n\n  function build() {\n    server.add = decorator.add;\n    server[kState] = {\n      listening: false,\n      closing: false,\n      started: false\n    };\n    return server;\n\n    function server() {}\n  }\n\n  const server = build();\n  server.add('test1', () => {}).add('test2', () => {}).add('test3', () => {});\n  t.ok(server.test1);\n  t.ok(server.test2);\n  t.ok(server.test3);\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"checkExistence should check if a property is part of the given instance","suites":[],"updatePoint":{"line":54,"column":77,"index":1073},"line":54,"code":"test('checkExistence should check if a property is part of the given instance', t => {\n  t.plan(1);\n  const instance = {\n    test: () => {}\n  };\n  t.ok(decorator.exist(instance, 'test'));\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"checkExistence should find the instance if not given","suites":[],"updatePoint":{"line":61,"column":58,"index":1246},"line":61,"code":"test('checkExistence should find the instance if not given', t => {\n  t.plan(1);\n\n  function build() {\n    server.add = decorator.add;\n    server.check = decorator.exist;\n    server[kState] = {\n      listening: false,\n      closing: false,\n      started: false\n    };\n    return server;\n\n    function server() {}\n  }\n\n  const server = build();\n  server.add('test', () => {});\n  t.ok(server.check('test'));\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"checkExistence should check the prototype as well","suites":[],"updatePoint":{"line":81,"column":55,"index":1653},"line":81,"code":"test('checkExistence should check the prototype as well', t => {\n  t.plan(1);\n\n  function Instance() {}\n\n  Instance.prototype.test = () => {};\n\n  const instance = new Instance();\n  t.ok(decorator.exist(instance, 'test'));\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"checkDependencies should throw if a dependency is not present","suites":[],"updatePoint":{"line":91,"column":67,"index":1891},"line":91,"code":"test('checkDependencies should throw if a dependency is not present', t => {\n  t.plan(2);\n  const instance = {};\n\n  try {\n    decorator.dependencies(instance, 'foo', ['test']);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY');\n    t.equal(e.message, 'The decorator is missing dependency \\'test\\'.');\n  }\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate should internally call checkDependencies","suites":[],"updatePoint":{"line":103,"column":55,"index":2222},"line":103,"code":"test('decorate should internally call checkDependencies', t => {\n  t.plan(2);\n\n  function build() {\n    server.add = decorator.add;\n    server[kState] = {\n      listening: false,\n      closing: false,\n      started: false\n    };\n    return server;\n\n    function server() {}\n  }\n\n  const server = build();\n\n  try {\n    server.add('method', () => {}, ['test']);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY');\n    t.equal(e.message, 'The decorator is missing dependency \\'test\\'.');\n  }\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"decorate should recognize getter/setter objects","suites":[],"updatePoint":{"line":128,"column":53,"index":2746},"line":128,"code":"test('decorate should recognize getter/setter objects', t => {\n  t.plan(6);\n  const one = {\n    [kState]: {\n      listening: false,\n      closing: false,\n      started: false\n    }\n  };\n  decorator.add.call(one, 'foo', {\n    getter: () => this._a,\n    setter: val => {\n      t.pass();\n      this._a = val;\n    }\n  });\n  t.equal(one.hasOwnProperty('foo'), true);\n  t.equal(one.foo, undefined);\n  one.foo = 'a';\n  t.equal(one.foo, 'a'); // getter only\n\n  const two = {\n    [kState]: {\n      listening: false,\n      closing: false,\n      started: false\n    }\n  };\n  decorator.add.call(two, 'foo', {\n    getter: () => 'a getter'\n  });\n  t.equal(two.hasOwnProperty('foo'), true);\n  t.equal(two.foo, 'a getter');\n});","file":"internals/decorator.test.js","skipped":false,"dir":"test"},{"name":"handleRequest function - sent reply","suites":[],"updatePoint":{"line":45,"column":41,"index":828},"line":45,"code":"test('handleRequest function - sent reply', t => {\n  t.plan(1);\n  const request = {};\n  const reply = {\n    sent: true\n  };\n  const res = handleRequest(null, request, reply);\n  t.equal(res, undefined);\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"handleRequest function - invoke with error","suites":[],"updatePoint":{"line":54,"column":48,"index":1041},"line":54,"code":"test('handleRequest function - invoke with error', t => {\n  t.plan(1);\n  const request = {};\n  const reply = {};\n\n  reply.send = err => t.equal(err.message, 'Kaboom');\n\n  handleRequest(new Error('Kaboom'), request, reply);\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"handler function - invalid schema","suites":[],"updatePoint":{"line":63,"column":39,"index":1259},"line":63,"code":"test('handler function - invalid schema', t => {\n  t.plan(2);\n  const res = {};\n\n  res.end = () => {\n    t.equal(res.statusCode, 400);\n    t.pass();\n  };\n\n  res.writeHead = () => {};\n\n  res.log = {\n    error: () => {},\n    info: () => {}\n  };\n  const context = {\n    config: {\n      method: 'GET',\n      url: '/an-url'\n    },\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'number'\n          }\n        }\n      }\n    },\n    handler: () => {},\n    Reply,\n    Request,\n    preValidation: [],\n    preHandler: [],\n    onSend: [],\n    onError: [],\n    attachValidation: false,\n    schemaErrorFormatter: () => new Error()\n  };\n  buildSchema(context, schemaValidator);\n  const request = {\n    body: {\n      hello: 'world'\n    },\n    context\n  };\n  internals.handler(request, new Reply(res, request));\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"handler function - reply","suites":[],"updatePoint":{"line":112,"column":30,"index":2111},"line":112,"code":"test('handler function - reply', t => {\n  t.plan(3);\n  const res = {};\n\n  res.end = () => {\n    t.equal(res.statusCode, 204);\n    t.pass();\n  };\n\n  res.writeHead = () => {};\n\n  const context = {\n    handler: (req, reply) => {\n      t.equal(typeof reply, 'object');\n      reply.code(204);\n      reply.send(undefined);\n    },\n    Reply,\n    Request,\n    preValidation: [],\n    preHandler: [],\n    onSend: [],\n    onError: []\n  };\n  buildSchema(context, schemaValidator);\n  internals.handler({}, new Reply(res, {\n    context\n  }));\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"handler function - preValidationCallback with finished response","suites":[],"updatePoint":{"line":141,"column":69,"index":2683},"line":141,"code":"test('handler function - preValidationCallback with finished response', t => {\n  t.plan(0);\n  const res = {}; // Be sure to check only `writableEnded` where is available\n\n  if (semver.gte(process.versions.node, '12.9.0')) {\n    res.writableEnded = true;\n  } else {\n    res.writable = false;\n    res.finished = true;\n  }\n\n  res.end = () => {\n    t.fail();\n  };\n\n  res.writeHead = () => {};\n\n  const context = {\n    handler: (req, reply) => {\n      t.fail();\n      reply.send(undefined);\n    },\n    Reply,\n    Request,\n    preValidation: null,\n    preHandler: [],\n    onSend: [],\n    onError: []\n  };\n  buildSchema(context, schemaValidator);\n  internals.handler({}, new Reply(res, {\n    context\n  }));\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"handler function - preValidationCallback with finished response (< v12.9.0)","suites":[],"updatePoint":{"line":175,"column":81,"index":3399},"line":175,"code":"test('handler function - preValidationCallback with finished response (< v12.9.0)', t => {\n  t.plan(0);\n  const res = {}; // Be sure to check only `writableEnded` where is available\n\n  res.writable = false;\n  res.finished = true;\n\n  res.end = () => {\n    t.fail();\n  };\n\n  res.writeHead = () => {};\n\n  const context = {\n    handler: (req, reply) => {\n      t.fail();\n      reply.send(undefined);\n    },\n    Reply,\n    Request,\n    preValidation: null,\n    preHandler: [],\n    onSend: [],\n    onError: []\n  };\n  buildSchema(context, schemaValidator);\n  internals.handler({}, new Reply(res, {\n    context\n  }));\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"request should be defined in onSend Hook on post request with content type application/json","suites":[],"updatePoint":{"line":205,"column":97,"index":4029},"line":205,"code":"test('request should be defined in onSend Hook on post request with content type application/json', t => {\n  t.plan(8);\n\n  const fastify = require('../..')();\n\n  fastify.addHook('onSend', (request, reply, payload, done) => {\n    t.ok(request);\n    t.ok(request.raw);\n    t.ok(request.id);\n    t.ok(request.params);\n    t.ok(request.query);\n    done();\n  });\n  fastify.post('/', (request, reply) => {\n    reply.send(200);\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'content-type': 'application/json'\n      }\n    }, (err, response, body) => {\n      t.error(err); // a 400 error is expected because of no body\n\n      t.equal(response.statusCode, 400);\n    });\n  });\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"request should be defined in onSend Hook on post request with content type application/x-www-form-urlencoded","suites":[],"updatePoint":{"line":237,"column":114,"index":4873},"line":237,"code":"test('request should be defined in onSend Hook on post request with content type application/x-www-form-urlencoded', t => {\n  t.plan(7);\n\n  const fastify = require('../..')();\n\n  fastify.addHook('onSend', (request, reply, payload, done) => {\n    t.ok(request);\n    t.ok(request.raw);\n    t.ok(request.params);\n    t.ok(request.query);\n    done();\n  });\n  fastify.post('/', (request, reply) => {\n    reply.send(200);\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'content-type': 'application/x-www-form-urlencoded'\n      }\n    }, (err, response, body) => {\n      t.error(err); // a 415 error is expected because of missing content type parser\n\n      t.equal(response.statusCode, 415);\n    });\n  });\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"request should be defined in onSend Hook on options request with content type application/x-www-form-urlencoded","suites":[],"updatePoint":{"line":268,"column":117,"index":5735},"line":268,"code":"test('request should be defined in onSend Hook on options request with content type application/x-www-form-urlencoded', t => {\n  t.plan(7);\n\n  const fastify = require('../..')();\n\n  fastify.addHook('onSend', (request, reply, payload, done) => {\n    t.ok(request);\n    t.ok(request.raw);\n    t.ok(request.params);\n    t.ok(request.query);\n    done();\n  });\n  fastify.options('/', (request, reply) => {\n    reply.send(200);\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    t.error(err);\n    sget({\n      method: 'OPTIONS',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'content-type': 'application/x-www-form-urlencoded'\n      }\n    }, (err, response, body) => {\n      t.error(err); // Body parsing skipped, so no body sent\n\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"request should respond with an error if an unserialized payload is sent inside an async handler","suites":[],"updatePoint":{"line":299,"column":101,"index":6562},"line":299,"code":"test('request should respond with an error if an unserialized payload is sent inside an async handler', t => {\n  t.plan(3);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', (request, reply) => {\n    reply.type('text/html');\n    return Promise.resolve(request.headers);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.strictSame(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      code: 'FST_ERR_REP_INVALID_PAYLOAD_TYPE',\n      message: 'Attempted to send payload of invalid type \\'object\\'. Expected a string or Buffer.',\n      statusCode: 500\n    });\n  });\n});","file":"internals/handleRequest.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - Basic","suites":[],"updatePoint":{"line":12,"column":24,"index":163},"line":12,"code":"test('hookRunner - Basic', t => {\n  t.plan(9);\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function fn2(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function fn3(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function done(err, a, b) {\n    t.error(err);\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - In case of error should skip to done","suites":[],"updatePoint":{"line":44,"column":55,"index":730},"line":44,"code":"test('hookRunner - In case of error should skip to done', t => {\n  t.plan(7);\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function fn2(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done(new Error('kaboom'));\n  }\n\n  function fn3() {\n    t.fail('We should not be here');\n  }\n\n  function done(err, a, b) {\n    t.equal(err.message, 'kaboom');\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - Should handle throw","suites":[],"updatePoint":{"line":74,"column":38,"index":1290},"line":74,"code":"test('hookRunner - Should handle throw', t => {\n  t.plan(7);\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function fn2(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    throw new Error('kaboom');\n  }\n\n  function fn3() {\n    t.fail('We should not be here');\n  }\n\n  function done(err, a, b) {\n    t.equal(err.message, 'kaboom');\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - Should handle promises","suites":[],"updatePoint":{"line":104,"column":41,"index":1853},"line":104,"code":"test('hookRunner - Should handle promises', t => {\n  t.plan(9);\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    return Promise.resolve();\n  }\n\n  function fn2(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    return Promise.resolve();\n  }\n\n  function fn3(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    return Promise.resolve();\n  }\n\n  function done(err, a, b) {\n    t.error(err);\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - In case of error should skip to done (with promises)","suites":[],"updatePoint":{"line":136,"column":71,"index":2472},"line":136,"code":"test('hookRunner - In case of error should skip to done (with promises)', t => {\n  t.plan(7);\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    return Promise.resolve();\n  }\n\n  function fn2(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    return Promise.reject(new Error('kaboom'));\n  }\n\n  function fn3() {\n    t.fail('We should not be here');\n  }\n\n  function done(err, a, b) {\n    t.equal(err.message, 'kaboom');\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - Be able to exit before its natural end","suites":[],"updatePoint":{"line":166,"column":57,"index":3074},"line":166,"code":"test('hookRunner - Be able to exit before its natural end', t => {\n  t.plan(4);\n  let shouldStop = false;\n  hookRunner([fn1, fn2, fn3], iterator, 'a', 'b', done);\n\n  function iterator(fn, a, b, done) {\n    if (shouldStop) {\n      return undefined;\n    }\n\n    return fn(a, b, done);\n  }\n\n  function fn1(a, b, done) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    done();\n  }\n\n  function fn2(a, b) {\n    t.equal(a, 'a');\n    t.equal(b, 'b');\n    shouldStop = true;\n    return Promise.resolve();\n  }\n\n  function fn3() {\n    t.fail('this should not be called');\n  }\n\n  function done() {\n    t.fail('this should not be called');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hookRunner - Promises that resolve to a value do not change the state","suites":[],"updatePoint":{"line":200,"column":75,"index":3724},"line":200,"code":"test('hookRunner - Promises that resolve to a value do not change the state', t => {\n  t.plan(5);\n  const originalState = {\n    a: 'a',\n    b: 'b'\n  };\n  hookRunner([fn1, fn2, fn3], iterator, originalState, 'b', done);\n\n  function iterator(fn, state, b, done) {\n    return fn(state, b, done);\n  }\n\n  function fn1(state, b, done) {\n    t.equal(state, originalState);\n    return Promise.resolve(null);\n  }\n\n  function fn2(state, b, done) {\n    t.equal(state, originalState);\n    return Promise.resolve('string');\n  }\n\n  function fn3(state, b, done) {\n    t.equal(state, originalState);\n    return Promise.resolve({\n      object: true\n    });\n  }\n\n  function done(err, state, b) {\n    t.error(err);\n    t.equal(state, originalState);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - Basic","suites":[],"updatePoint":{"line":234,"column":30,"index":4418},"line":234,"code":"test('onSendHookRunner - Basic', t => {\n  t.plan(13);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const originalPayload = 'payload';\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, originalPayload, done);\n\n  function fn1(request, reply, payload, done) {\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.equal(payload, originalPayload);\n    done();\n  }\n\n  function fn2(request, reply, payload, done) {\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.equal(payload, originalPayload);\n    done();\n  }\n\n  function fn3(request, reply, payload, done) {\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.equal(payload, originalPayload);\n    done();\n  }\n\n  function done(err, request, reply, payload) {\n    t.error(err);\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.equal(payload, originalPayload);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - Can change the payload","suites":[],"updatePoint":{"line":273,"column":47,"index":5440},"line":273,"code":"test('onSendHookRunner - Can change the payload', t => {\n  t.plan(7);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const v1 = {\n    hello: 'world'\n  };\n  const v2 = {\n    ciao: 'mondo'\n  };\n  const v3 = {\n    winter: 'is coming'\n  };\n  const v4 = {\n    winter: 'has come'\n  };\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, v1, done);\n\n  function fn1(request, reply, payload, done) {\n    t.same(payload, v1);\n    done(null, v2);\n  }\n\n  function fn2(request, reply, payload, done) {\n    t.same(payload, v2);\n    done(null, v3);\n  }\n\n  function fn3(request, reply, payload, done) {\n    t.same(payload, v3);\n    done(null, v4);\n  }\n\n  function done(err, request, reply, payload) {\n    t.error(err);\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.same(payload, v4);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - In case of error should skip to done","suites":[],"updatePoint":{"line":317,"column":61,"index":6341},"line":317,"code":"test('onSendHookRunner - In case of error should skip to done', t => {\n  t.plan(6);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const v1 = {\n    hello: 'world'\n  };\n  const v2 = {\n    ciao: 'mondo'\n  };\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, v1, done);\n\n  function fn1(request, reply, payload, done) {\n    t.same(payload, v1);\n    done(null, v2);\n  }\n\n  function fn2(request, reply, payload, done) {\n    t.same(payload, v2);\n    done(new Error('kaboom'));\n  }\n\n  function fn3() {\n    t.fail('We should not be here');\n  }\n\n  function done(err, request, reply, payload) {\n    t.equal(err.message, 'kaboom');\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.same(payload, v2);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - Should handle promises","suites":[],"updatePoint":{"line":354,"column":47,"index":7133},"line":354,"code":"test('onSendHookRunner - Should handle promises', t => {\n  t.plan(7);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const v1 = {\n    hello: 'world'\n  };\n  const v2 = {\n    ciao: 'mondo'\n  };\n  const v3 = {\n    winter: 'is coming'\n  };\n  const v4 = {\n    winter: 'has come'\n  };\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, v1, done);\n\n  function fn1(request, reply, payload) {\n    t.same(payload, v1);\n    return Promise.resolve(v2);\n  }\n\n  function fn2(request, reply, payload) {\n    t.same(payload, v2);\n    return Promise.resolve(v3);\n  }\n\n  function fn3(request, reply, payload) {\n    t.same(payload, v3);\n    return Promise.resolve(v4);\n  }\n\n  function done(err, request, reply, payload) {\n    t.error(err);\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.same(payload, v4);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - In case of error should skip to done (with promises)","suites":[],"updatePoint":{"line":398,"column":77,"index":8068},"line":398,"code":"test('onSendHookRunner - In case of error should skip to done (with promises)', t => {\n  t.plan(6);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const v1 = {\n    hello: 'world'\n  };\n  const v2 = {\n    ciao: 'mondo'\n  };\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, v1, done);\n\n  function fn1(request, reply, payload) {\n    t.same(payload, v1);\n    return Promise.resolve(v2);\n  }\n\n  function fn2(request, reply, payload) {\n    t.same(payload, v2);\n    return Promise.reject(new Error('kaboom'));\n  }\n\n  function fn3() {\n    t.fail('We should not be here');\n  }\n\n  function done(err, request, reply, payload) {\n    t.equal(err.message, 'kaboom');\n    t.same(request, originalRequest);\n    t.same(reply, originalReply);\n    t.same(payload, v2);\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"onSendHookRunner - Be able to exit before its natural end","suites":[],"updatePoint":{"line":435,"column":63,"index":8893},"line":435,"code":"test('onSendHookRunner - Be able to exit before its natural end', t => {\n  t.plan(2);\n  const originalRequest = {\n    body: null\n  };\n  const originalReply = {\n    request: originalRequest\n  };\n  const v1 = {\n    hello: 'world'\n  };\n  const v2 = {\n    ciao: 'mondo'\n  };\n  onSendHookRunner([fn1, fn2, fn3], originalRequest, originalReply, v1, done);\n\n  function fn1(request, reply, payload, done) {\n    t.same(payload, v1);\n    done(null, v2);\n  }\n\n  function fn2(request, reply, payload) {\n    t.same(payload, v2);\n  }\n\n  function fn3() {\n    t.fail('this should not be called');\n  }\n\n  function done() {\n    t.fail('this should not be called');\n  }\n});","file":"internals/hookRunner.test.js","skipped":false,"dir":"test"},{"name":"hooks should have 4 array with the registered hooks","suites":[],"updatePoint":{"line":13,"column":57,"index":195},"line":13,"code":"test('hooks should have 4 array with the registered hooks', t => {\n  const hooks = new Hooks();\n  t.equal(typeof hooks, 'object');\n  t.ok(Array.isArray(hooks.onRequest));\n  t.ok(Array.isArray(hooks.onSend));\n  t.ok(Array.isArray(hooks.preParsing));\n  t.ok(Array.isArray(hooks.preValidation));\n  t.ok(Array.isArray(hooks.preHandler));\n  t.ok(Array.isArray(hooks.onResponse));\n  t.ok(Array.isArray(hooks.onError));\n  t.end();\n});","file":"internals/hooks.test.js","skipped":false,"dir":"test"},{"name":"hooks.add should add a hook to the given hook","suites":[],"updatePoint":{"line":25,"column":51,"index":617},"line":25,"code":"test('hooks.add should add a hook to the given hook', t => {\n  const hooks = new Hooks();\n  hooks.add('onRequest', noop);\n  t.equal(hooks.onRequest.length, 1);\n  t.equal(typeof hooks.onRequest[0], 'function');\n  hooks.add('preParsing', noop);\n  t.equal(hooks.preParsing.length, 1);\n  t.equal(typeof hooks.preParsing[0], 'function');\n  hooks.add('preValidation', noop);\n  t.equal(hooks.preValidation.length, 1);\n  t.equal(typeof hooks.preValidation[0], 'function');\n  hooks.add('preHandler', noop);\n  t.equal(hooks.preHandler.length, 1);\n  t.equal(typeof hooks.preHandler[0], 'function');\n  hooks.add('onResponse', noop);\n  t.equal(hooks.onResponse.length, 1);\n  t.equal(typeof hooks.onResponse[0], 'function');\n  hooks.add('onSend', noop);\n  t.equal(hooks.onSend.length, 1);\n  t.equal(typeof hooks.onSend[0], 'function');\n  hooks.add('onError', noop);\n  t.equal(hooks.onError.length, 1);\n  t.equal(typeof hooks.onError[0], 'function');\n  t.end();\n});","file":"internals/hooks.test.js","skipped":false,"dir":"test"},{"name":"hooks should throw on unexisting handler","suites":[],"updatePoint":{"line":50,"column":46,"index":1563},"line":50,"code":"test('hooks should throw on unexisting handler', t => {\n  t.plan(1);\n  const hooks = new Hooks();\n\n  try {\n    hooks.add('onUnexistingHook', noop);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"internals/hooks.test.js","skipped":false,"dir":"test"},{"name":"should throw on wrong parameters","suites":[],"updatePoint":{"line":61,"column":38,"index":1755},"line":61,"code":"test('should throw on wrong parameters', t => {\n  const hooks = new Hooks();\n  t.plan(4);\n\n  try {\n    hooks.add(null, noop);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_HOOK_INVALID_TYPE');\n    t.equal(e.message, 'The hook name must be a string');\n  }\n\n  try {\n    hooks.add('', null);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_HOOK_INVALID_HANDLER');\n    t.equal(e.message, 'The hook callback must be a function');\n  }\n});","file":"internals/hooks.test.js","skipped":false,"dir":"test"},{"name":"Fastify.initialConfig is an object","suites":[],"updatePoint":{"line":31,"column":40,"index":520},"line":31,"code":"test('Fastify.initialConfig is an object', t => {\n  t.plan(1);\n  t.type(Fastify().initialConfig, 'object');\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"without options passed to Fastify, initialConfig should expose default values","suites":[],"updatePoint":{"line":35,"column":83,"index":675},"line":35,"code":"test('without options passed to Fastify, initialConfig should expose default values', t => {\n  t.plan(1);\n  const fastifyDefaultOptions = {\n    connectionTimeout: 0,\n    keepAliveTimeout: 5000,\n    maxRequestsPerSocket: 0,\n    requestTimeout: 0,\n    bodyLimit: 1024 * 1024,\n    caseSensitive: true,\n    disableRequestLogging: false,\n    jsonShorthand: true,\n    ignoreTrailingSlash: false,\n    maxParamLength: 100,\n    onProtoPoisoning: 'error',\n    onConstructorPoisoning: 'error',\n    pluginTimeout: 10000,\n    requestIdHeader: 'request-id',\n    requestIdLogLabel: 'reqId',\n    http2SessionTimeout: 5000\n  };\n  t.same(Fastify().initialConfig, fastifyDefaultOptions);\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Fastify.initialConfig should expose all options","suites":[],"updatePoint":{"line":57,"column":53,"index":1318},"line":57,"code":"test('Fastify.initialConfig should expose all options', t => {\n  t.plan(18);\n\n  const serverFactory = (handler, opts) => {\n    const server = http.createServer((req, res) => {\n      handler(req, res);\n    });\n    return server;\n  };\n\n  const versionStrategy = {\n    name: 'version',\n    storage: function () {\n      let versions = {};\n      return {\n        get: version => {\n          return versions[version] || null;\n        },\n        set: (version, store) => {\n          versions[version] = store;\n        },\n        del: version => {\n          delete versions[version];\n        },\n        empty: () => {\n          versions = {};\n        }\n      };\n    },\n    deriveConstraint: (req, ctx) => {\n      return req.headers.accept;\n    },\n\n    validate() {\n      return true;\n    }\n\n  };\n  let reqId = 0;\n  const options = {\n    http2: true,\n    https: {\n      key: global.context.key,\n      cert: global.context.cert\n    },\n    ignoreTrailingSlash: true,\n    maxParamLength: 200,\n    connectionTimeout: 0,\n    keepAliveTimeout: 5000,\n    bodyLimit: 1049600,\n    onProtoPoisoning: 'remove',\n    serverFactory,\n    caseSensitive: true,\n    requestIdHeader: 'request-id-alt',\n    pluginTimeout: 20000,\n    querystringParser: str => str,\n    genReqId: function (req) {\n      return reqId++;\n    },\n    logger: pino({\n      level: 'info'\n    }),\n    constraints: {\n      version: versionStrategy\n    },\n    trustProxy: function myTrustFn(address, hop) {\n      return address === '1.2.3.4' || hop === 1;\n    }\n  };\n  const fastify = Fastify(options);\n  t.equal(fastify.initialConfig.http2, true);\n  t.equal(fastify.initialConfig.https, true);\n  t.equal(fastify.initialConfig.ignoreTrailingSlash, true);\n  t.equal(fastify.initialConfig.maxParamLength, 200);\n  t.equal(fastify.initialConfig.connectionTimeout, 0);\n  t.equal(fastify.initialConfig.keepAliveTimeout, 5000);\n  t.equal(fastify.initialConfig.bodyLimit, 1049600);\n  t.equal(fastify.initialConfig.onProtoPoisoning, 'remove');\n  t.equal(fastify.initialConfig.caseSensitive, true);\n  t.equal(fastify.initialConfig.requestIdHeader, 'request-id-alt');\n  t.equal(fastify.initialConfig.pluginTimeout, 20000);\n  t.ok(fastify.initialConfig.constraints.version); // obfuscated options:\n\n  t.equal(fastify.initialConfig.serverFactory, undefined);\n  t.equal(fastify.initialConfig.trustProxy, undefined);\n  t.equal(fastify.initialConfig.genReqId, undefined);\n  t.equal(fastify.initialConfig.querystringParser, undefined);\n  t.equal(fastify.initialConfig.logger, undefined);\n  t.equal(fastify.initialConfig.trustProxy, undefined);\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Should throw if you try to modify Fastify.initialConfig","suites":[],"updatePoint":{"line":147,"column":61,"index":3900},"line":147,"code":"test('Should throw if you try to modify Fastify.initialConfig', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: true\n  });\n\n  try {\n    fastify.initialConfig.ignoreTrailingSlash = false;\n    t.fail();\n  } catch (error) {\n    t.type(error, TypeError);\n    t.equal(error.message, \"Cannot assign to read only property 'ignoreTrailingSlash' of object '#<Object>'\");\n    t.ok(error.stack);\n    t.pass();\n  }\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"We must avoid shallow freezing and ensure that the whole object is freezed","suites":[],"updatePoint":{"line":163,"column":80,"index":4351},"line":163,"code":"test('We must avoid shallow freezing and ensure that the whole object is freezed', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    https: {\n      allowHTTP1: true,\n      key: global.context.key,\n      cert: global.context.cert\n    }\n  });\n\n  try {\n    fastify.initialConfig.https.allowHTTP1 = false;\n    t.fail();\n  } catch (error) {\n    t.type(error, TypeError);\n    t.equal(error.message, \"Cannot assign to read only property 'allowHTTP1' of object '#<Object>'\");\n    t.ok(error.stack);\n    t.pass();\n  }\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Return an error if options do not match the validation schema","suites":[],"updatePoint":{"line":183,"column":67,"index":4853},"line":183,"code":"test('Return an error if options do not match the validation schema', t => {\n  t.plan(6);\n\n  try {\n    Fastify({\n      ignoreTrailingSlash: 'string instead of boolean'\n    });\n    t.fail();\n  } catch (error) {\n    t.type(error, Error);\n    t.equal(error.name, 'FastifyError');\n    t.equal(error.message, 'Invalid initialization options: \\'[\"should be boolean\"]\\'');\n    t.equal(error.code, 'FST_ERR_INIT_OPTS_INVALID');\n    t.ok(error.stack);\n    t.pass();\n  }\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Original options must not be frozen","suites":[],"updatePoint":{"line":200,"column":41,"index":5292},"line":200,"code":"test('Original options must not be frozen', t => {\n  t.plan(4);\n  const originalOptions = {\n    https: {\n      allowHTTP1: true,\n      key: global.context.key,\n      cert: global.context.cert\n    }\n  };\n  const fastify = Fastify(originalOptions);\n  t.equal(Object.isFrozen(originalOptions), false);\n  t.equal(Object.isFrozen(originalOptions.https), false);\n  t.equal(Object.isFrozen(fastify.initialConfig), true);\n  t.equal(Object.isFrozen(fastify.initialConfig.https), true);\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Original options must not be altered (test deep cloning)","suites":[],"updatePoint":{"line":215,"column":62,"index":5794},"line":215,"code":"test('Original options must not be altered (test deep cloning)', t => {\n  t.plan(3);\n  const originalOptions = {\n    https: {\n      allowHTTP1: true,\n      key: global.context.key,\n      cert: global.context.cert\n    }\n  };\n  const originalOptionsClone = deepClone(originalOptions);\n  const fastify = Fastify(originalOptions); // initialConfig has been triggered\n\n  t.equal(Object.isFrozen(fastify.initialConfig), true); // originalOptions must not have been altered\n\n  t.same(originalOptions.https.key, originalOptionsClone.https.key);\n  t.same(originalOptions.https.cert, originalOptionsClone.https.cert);\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Should not have issues when passing stream options to Pino.js","suites":[],"updatePoint":{"line":232,"column":67,"index":6411},"line":232,"code":"test('Should not have issues when passing stream options to Pino.js', t => {\n  t.plan(15);\n  const stream = split(JSON.parse);\n  const originalOptions = {\n    ignoreTrailingSlash: true,\n    logger: {\n      level: 'trace',\n      stream\n    }\n  };\n  let fastify;\n\n  try {\n    fastify = Fastify(originalOptions);\n    t.type(fastify, 'object');\n    t.same(fastify.initialConfig, {\n      connectionTimeout: 0,\n      keepAliveTimeout: 5000,\n      maxRequestsPerSocket: 0,\n      requestTimeout: 0,\n      bodyLimit: 1024 * 1024,\n      caseSensitive: true,\n      disableRequestLogging: false,\n      jsonShorthand: true,\n      ignoreTrailingSlash: true,\n      maxParamLength: 100,\n      onProtoPoisoning: 'error',\n      onConstructorPoisoning: 'error',\n      pluginTimeout: 10000,\n      requestIdHeader: 'request-id',\n      requestIdLogLabel: 'reqId',\n      http2SessionTimeout: 5000\n    });\n  } catch (error) {\n    t.fail();\n  }\n\n  fastify.get('/', function (req, reply) {\n    t.ok(req.log);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  stream.once('data', listenAtLogLine => {\n    t.ok(listenAtLogLine, 'listen at log message is ok');\n    stream.once('data', line => {\n      const id = line.reqId;\n      t.ok(line.reqId, 'reqId is defined');\n      t.ok(line.req, 'req is defined');\n      t.equal(line.msg, 'incoming request', 'message is set');\n      t.equal(line.req.method, 'GET', 'method is get');\n      stream.once('data', line => {\n        t.equal(line.reqId, id);\n        t.ok(line.reqId, 'reqId is defined');\n        t.ok(line.res, 'res is defined');\n        t.equal(line.msg, 'request completed', 'message is set');\n        t.equal(line.res.statusCode, 200, 'statusCode is 200');\n        t.ok(line.responseTime, 'responseTime is defined');\n      });\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port);\n  });\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"deepFreezeObject() should not throw on TypedArray","suites":[],"updatePoint":{"line":299,"column":55,"index":8324},"line":299,"code":"test('deepFreezeObject() should not throw on TypedArray', t => {\n  t.plan(5);\n  const object = {\n    buffer: Buffer.from(global.context.key),\n    dataView: new DataView(new ArrayBuffer(16)),\n    float: 1.1,\n    integer: 1,\n    object: {\n      nested: {\n        string: 'string'\n      }\n    },\n    stream: split(JSON.parse),\n    string: 'string'\n  };\n\n  try {\n    const frozenObject = deepFreezeObject(object); // Buffers should not be frozen, as they are Uint8Array inherited instances\n\n    t.equal(Object.isFrozen(frozenObject.buffer), false);\n    t.equal(Object.isFrozen(frozenObject), true);\n    t.equal(Object.isFrozen(frozenObject.object), true);\n    t.equal(Object.isFrozen(frozenObject.object.nested), true);\n    t.pass();\n  } catch (error) {\n    t.fail();\n  }\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"Fastify.initialConfig should accept the deprecated versioning option","suites":[],"updatePoint":{"line":327,"column":74,"index":9115},"line":327,"code":"test('Fastify.initialConfig should accept the deprecated versioning option', t => {\n  t.plan(1);\n\n  function onWarning(warning) {\n    t.equal(warning.code, 'FSTDEP009');\n  }\n\n  process.on('warning', onWarning);\n  const versioning = {\n    storage: function () {\n      let versions = {};\n      return {\n        get: version => {\n          return versions[version] || null;\n        },\n        set: (version, store) => {\n          versions[version] = store;\n        },\n        del: version => {\n          delete versions[version];\n        },\n        empty: () => {\n          versions = {};\n        }\n      };\n    },\n    deriveVersion: (req, ctx) => {\n      return req.headers.accept;\n    }\n  };\n  Fastify({\n    versioning\n  });\n  setImmediate(function () {\n    process.removeListener('warning', onWarning);\n    t.end();\n  });\n});","file":"internals/initialConfig.test.js","skipped":false,"dir":"test"},{"name":"time resolution","suites":[],"updatePoint":{"line":11,"column":21,"index":171},"line":11,"code":"test('time resolution', t => {\n  t.plan(2);\n  t.equal(typeof loggerUtils.now, 'function');\n  t.equal(typeof loggerUtils.now(), 'number');\n});","file":"internals/logger.test.js","skipped":false,"dir":"test"},{"name":"The logger should add a unique id for every request","suites":[],"updatePoint":{"line":16,"column":57,"index":349},"line":16,"code":"test('The logger should add a unique id for every request', t => {\n  const ids = [];\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    t.ok(req.id);\n    reply.send({\n      id: req.id\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    const queue = new Queue();\n\n    for (let i = 0; i < 10; i++) {\n      queue.add(checkId);\n    }\n\n    queue.add(() => {\n      fastify.close();\n      t.end();\n    });\n  });\n\n  function checkId(done) {\n    fastify.inject({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.ok(ids.indexOf(payload.id) === -1, 'the id should not be duplicated');\n      ids.push(payload.id);\n      done();\n    });\n  }\n});","file":"internals/logger.test.js","skipped":false,"dir":"test"},{"name":"The logger should reuse request id header for req.id","suites":[],"updatePoint":{"line":52,"column":58,"index":1148},"line":52,"code":"test('The logger should reuse request id header for req.id', t => {\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    t.ok(req.id);\n    reply.send({\n      id: req.id\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Request-Id': 'request-id-1'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.ok(payload.id === 'request-id-1', 'the request id from the header should be returned');\n      fastify.close();\n      t.end();\n    });\n  });\n});","file":"internals/logger.test.js","skipped":false,"dir":"test"},{"name":"The logger should error if both stream and file destination are given","suites":[],"updatePoint":{"line":100,"column":75,"index":2189},"line":100,"code":"test('The logger should error if both stream and file destination are given', t => {\n  t.plan(2);\n\n  const stream = require('stream').Writable;\n\n  try {\n    Fastify({\n      logger: {\n        level: 'info',\n        stream,\n        file: '/test'\n      }\n    });\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_LOG_INVALID_DESTINATION');\n    t.equal(err.message, 'Cannot specify both logger.stream and logger.file options');\n  }\n});","file":"internals/logger.test.js","skipped":false,"dir":"test"},{"name":"The serializer prevent fails if the request socket is undefined","suites":[],"updatePoint":{"line":118,"column":69,"index":2614},"line":118,"code":"test('The serializer prevent fails if the request socket is undefined', t => {\n  t.plan(1);\n  const serialized = loggerUtils.serializers.req({\n    method: 'GET',\n    url: '/',\n    socket: undefined,\n    headers: {}\n  });\n  t.same(serialized, {\n    method: 'GET',\n    url: '/',\n    version: undefined,\n    hostname: undefined,\n    remoteAddress: undefined,\n    remotePort: undefined\n  });\n});","file":"internals/logger.test.js","skipped":false,"dir":"test"},{"name":"shouldSkipOverride should check the 'skip-override' symbol","suites":[],"updatePoint":{"line":13,"column":64,"index":322},"line":13,"code":"test(\"shouldSkipOverride should check the 'skip-override' symbol\", t => {\n  t.plan(2);\n  yes[Symbol.for('skip-override')] = true;\n  t.ok(pluginUtils.shouldSkipOverride(yes));\n  t.notOk(pluginUtils.shouldSkipOverride(no));\n\n  function yes() {}\n\n  function no() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"getPluginName should return plugin name if the file is cached","suites":[],"updatePoint":{"line":23,"column":67,"index":592},"line":23,"code":"test('getPluginName should return plugin name if the file is cached', t => {\n  t.plan(1);\n  const expectedPluginName = 'example';\n\n  const fn = () => console.log('is just an example');\n\n  require.cache[expectedPluginName] = {\n    exports: fn\n  };\n  const pluginName = pluginUtilsPublic.getPluginName(fn);\n  t.equal(pluginName, expectedPluginName);\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"getMeta should return the object stored with the 'plugin-meta' symbol","suites":[],"updatePoint":{"line":35,"column":75,"index":952},"line":35,"code":"test(\"getMeta should return the object stored with the 'plugin-meta' symbol\", t => {\n  t.plan(1);\n  const meta = {\n    hello: 'world'\n  };\n  fn[Symbol.for('plugin-meta')] = meta;\n  t.same(meta, pluginUtils.getMeta(fn));\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"checkDecorators should check if the given decorator is present in the instance","suites":[],"updatePoint":{"line":45,"column":84,"index":1205},"line":45,"code":"test('checkDecorators should check if the given decorator is present in the instance', t => {\n  t.plan(1);\n  fn[Symbol.for('plugin-meta')] = {\n    decorators: {\n      fastify: ['plugin'],\n      reply: ['plugin'],\n      request: ['plugin']\n    }\n  };\n\n  function context() {}\n\n  context.plugin = true;\n  context[symbols.kReply] = {\n    prototype: {\n      plugin: true\n    },\n    props: []\n  };\n  context[symbols.kRequest] = {\n    prototype: {\n      plugin: true\n    },\n    props: []\n  };\n\n  try {\n    pluginUtils.checkDecorators.call(context, fn);\n    t.pass('Everything ok');\n  } catch (err) {\n    t.fail(err);\n  }\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"checkDecorators should check if the given decorator is present in the instance (errored)","suites":[],"updatePoint":{"line":80,"column":94,"index":1854},"line":80,"code":"test('checkDecorators should check if the given decorator is present in the instance (errored)', t => {\n  t.plan(1);\n  fn[Symbol.for('plugin-meta')] = {\n    decorators: {\n      fastify: ['plugin'],\n      reply: ['plugin'],\n      request: ['plugin']\n    }\n  };\n\n  function context() {}\n\n  context.plugin = true;\n  context[symbols.kReply] = {\n    prototype: {\n      plugin: true\n    },\n    props: []\n  };\n  context[symbols.kRequest] = {\n    prototype: {},\n    props: []\n  };\n\n  try {\n    pluginUtils.checkDecorators.call(context, fn);\n    t.fail('should throw');\n  } catch (err) {\n    t.equal(err.message, \"The decorator 'plugin' is not present in Request\");\n  }\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"checkDecorators should accept optional decorators","suites":[],"updatePoint":{"line":113,"column":55,"index":2500},"line":113,"code":"test('checkDecorators should accept optional decorators', t => {\n  t.plan(1);\n  fn[Symbol.for('plugin-meta')] = {\n    decorators: {}\n  };\n\n  function context() {}\n\n  context.plugin = true;\n  context[symbols.kReply] = {\n    prototype: {\n      plugin: true\n    }\n  };\n  context[symbols.kRequest] = {\n    prototype: {\n      plugin: true\n    }\n  };\n\n  try {\n    pluginUtils.checkDecorators.call(context, fn);\n    t.pass('Everything ok');\n  } catch (err) {\n    t.fail(err);\n  }\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"checkDependencies should check if the given dependency is present in the instance","suites":[],"updatePoint":{"line":142,"column":87,"index":3029},"line":142,"code":"test('checkDependencies should check if the given dependency is present in the instance', t => {\n  t.plan(1);\n  fn[Symbol.for('plugin-meta')] = {\n    dependencies: ['plugin']\n  };\n\n  function context() {}\n\n  context[pluginUtilsPublic.registeredPlugins] = ['plugin'];\n\n  try {\n    pluginUtils.checkDependencies.call(context, fn);\n    t.pass('Everything ok');\n  } catch (err) {\n    t.fail(err);\n  }\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"checkDependencies should check if the given dependency is present in the instance (errored)","suites":[],"updatePoint":{"line":161,"column":97,"index":3460},"line":161,"code":"test('checkDependencies should check if the given dependency is present in the instance (errored)', t => {\n  t.plan(1);\n  fn[Symbol.for('plugin-meta')] = {\n    name: 'test-plugin',\n    dependencies: ['plugin']\n  };\n\n  function context() {}\n\n  context[pluginUtilsPublic.registeredPlugins] = [];\n\n  try {\n    pluginUtils.checkDependencies.call(context, fn);\n    t.fail('should throw');\n  } catch (err) {\n    t.equal(err.message, \"The dependency 'plugin' of plugin 'test-plugin' is not registered\");\n  }\n\n  function fn() {}\n});","file":"internals/plugin.test.js","skipped":false,"dir":"test"},{"name":"Once called, Reply should return an object with methods","suites":[],"updatePoint":{"line":29,"column":61,"index":543},"line":29,"code":"test('Once called, Reply should return an object with methods', t => {\n  t.plan(13);\n  const response = {\n    res: 'res'\n  };\n  const context = {};\n  const request = {\n    context\n  };\n  const reply = new Reply(response, request);\n  t.equal(typeof reply, 'object');\n  t.equal(typeof reply[kReplyIsError], 'boolean');\n  t.equal(typeof reply[kReplyErrorHandlerCalled], 'boolean');\n  t.equal(typeof reply.send, 'function');\n  t.equal(typeof reply.code, 'function');\n  t.equal(typeof reply.status, 'function');\n  t.equal(typeof reply.header, 'function');\n  t.equal(typeof reply.serialize, 'function');\n  t.equal(typeof reply.getResponseTime, 'function');\n  t.equal(typeof reply[kReplyHeaders], 'object');\n  t.same(reply.raw, response);\n  t.equal(reply.context, context);\n  t.equal(reply.request, request);\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.send will logStream error and destroy the stream","suites":[],"updatePoint":{"line":53,"column":60,"index":1348},"line":53,"code":"test('reply.send will logStream error and destroy the stream', {\n  only: true\n}, t => {\n  t.plan(1);\n  let destroyCalled;\n  const payload = new EventEmitter();\n  const response = {\n    setHeader: () => {},\n    hasHeader: () => false,\n    getHeader: () => undefined,\n    writeHead: () => {},\n    end: () => {},\n    headersSent: true,\n    destroy: () => destroyCalled = true,\n    on: () => {}\n  };\n  const log = {\n    warn: () => {}\n  };\n  Object.assign(payload, {\n    pipe: () => {},\n    destroy: () => {}\n  });\n  const reply = new Reply(response, {\n    context: {\n      onSend: null\n    }\n  }, log);\n  reply.send(payload);\n  payload.emit('error', new Error('stream error'));\n  t.equal(destroyCalled, true, 'Error not logged and not streamed');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.send throw with circular JSON","suites":[],"updatePoint":{"line":85,"column":41,"index":2077},"line":85,"code":"test('reply.send throw with circular JSON', t => {\n  t.plan(1);\n  const response = {\n    setHeader: () => {},\n    hasHeader: () => false,\n    getHeader: () => undefined,\n    writeHead: () => {},\n    end: () => {}\n  };\n  const reply = new Reply(response, {\n    context: {\n      onSend: []\n    }\n  });\n  t.throws(() => {\n    const obj = {};\n    obj.obj = obj;\n    reply.send(JSON.stringify(obj));\n  }, 'Converting circular structure to JSON');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.send returns itself","suites":[],"updatePoint":{"line":105,"column":31,"index":2513},"line":105,"code":"test('reply.send returns itself', t => {\n  t.plan(1);\n  const response = {\n    setHeader: () => {},\n    hasHeader: () => false,\n    getHeader: () => undefined,\n    writeHead: () => {},\n    end: () => {}\n  };\n  const reply = new Reply(response, {\n    context: {\n      onSend: []\n    }\n  });\n  t.equal(reply.send('hello'), reply);\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serializer should set a custom serializer","suites":[],"updatePoint":{"line":121,"column":53,"index":2868},"line":121,"code":"test('reply.serializer should set a custom serializer', t => {\n  t.plan(2);\n  const reply = new Reply(null, null, null);\n  t.equal(reply[kReplySerializer], null);\n  reply.serializer('serializer');\n  t.equal(reply[kReplySerializer], 'serializer');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serializer should support running preSerialization hooks","suites":[],"updatePoint":{"line":128,"column":68,"index":3134},"line":128,"code":"test('reply.serializer should support running preSerialization hooks', t => {\n  t.plan(3);\n\n  const fastify = require('../..')();\n\n  fastify.addHook('preSerialization', async (request, reply, payload) => {\n    t.ok('called', 'preSerialization');\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.type('application/json').serializer(JSON.stringify).send({\n        foo: 'bar'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"foo\":\"bar\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serialize should serialize payload","suites":[],"updatePoint":{"line":153,"column":46,"index":3701},"line":153,"code":"test('reply.serialize should serialize payload', t => {\n  t.plan(1);\n  const response = {\n    statusCode: 200\n  };\n  const context = {};\n  const reply = new Reply(response, {\n    context\n  });\n  t.equal(reply.serialize({\n    foo: 'bar'\n  }), '{\"foo\":\"bar\"}');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serialize should serialize payload with a custom serializer","suites":[],"updatePoint":{"line":166,"column":71,"index":3990},"line":166,"code":"test('reply.serialize should serialize payload with a custom serializer', t => {\n  t.plan(2);\n  let customSerializerCalled = false;\n  const response = {\n    statusCode: 200\n  };\n  const context = {};\n  const reply = new Reply(response, {\n    context\n  });\n  reply.serializer(x => (customSerializerCalled = true) && JSON.stringify(x));\n  t.equal(reply.serialize({\n    foo: 'bar'\n  }), '{\"foo\":\"bar\"}');\n  t.equal(customSerializerCalled, true, 'custom serializer not called');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serialize should serialize payload with a context default serializer","suites":[],"updatePoint":{"line":182,"column":80,"index":4478},"line":182,"code":"test('reply.serialize should serialize payload with a context default serializer', t => {\n  t.plan(2);\n  let customSerializerCalled = false;\n  const response = {\n    statusCode: 200\n  };\n  const context = {\n    [kReplySerializerDefault]: x => (customSerializerCalled = true) && JSON.stringify(x)\n  };\n  const reply = new Reply(response, {\n    context\n  });\n  t.equal(reply.serialize({\n    foo: 'bar'\n  }), '{\"foo\":\"bar\"}');\n  t.equal(customSerializerCalled, true, 'custom serializer not called');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.serialize should serialize payload with Fastify instance","suites":[],"updatePoint":{"line":199,"column":68,"index":4967},"line":199,"code":"test('reply.serialize should serialize payload with Fastify instance', t => {\n  t.plan(2);\n\n  const fastify = require('../..')();\n\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    schema: {\n      response: {\n        200: {\n          type: 'object',\n          properties: {\n            foo: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    },\n    handler: (req, reply) => {\n      reply.send(reply.serialize({\n        foo: 'bar'\n      }));\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"foo\":\"bar\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"within an instance","suites":[],"updatePoint":{"line":233,"column":24,"index":5552},"line":233,"code":"test('within an instance', t => {\n  const fastify = require('../..')();\n\n  const test = t.test;\n  fastify.get('/', function (req, reply) {\n    reply.code(200);\n    reply.header('Content-Type', 'text/plain');\n    reply.send('hello world!');\n  });\n  fastify.get('/auto-type', function (req, reply) {\n    reply.code(200);\n    reply.type('text/plain');\n    reply.send('hello world!');\n  });\n  fastify.get('/auto-status-code', function (req, reply) {\n    reply.send('hello world!');\n  });\n  fastify.get('/redirect', function (req, reply) {\n    reply.redirect('/');\n  });\n  fastify.get('/redirect-code', function (req, reply) {\n    reply.redirect(301, '/');\n  });\n  fastify.get('/redirect-code-before-call', function (req, reply) {\n    reply.code(307).redirect('/');\n  });\n  fastify.get('/redirect-code-before-call-overwrite', function (req, reply) {\n    reply.code(307).redirect(302, '/');\n  });\n  fastify.get('/custom-serializer', function (req, reply) {\n    reply.code(200);\n    reply.type('text/plain');\n    reply.serializer(function (body) {\n      return require('querystring').stringify(body);\n    });\n    reply.send({\n      hello: 'world!'\n    });\n  });\n  fastify.register(function (instance, options, done) {\n    fastify.addHook('onSend', function (req, reply, payload, done) {\n      reply.header('x-onsend', 'yes');\n      done();\n    });\n    fastify.get('/redirect-onsend', function (req, reply) {\n      reply.redirect('/');\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    test('custom serializer should be used', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/custom-serializer'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello=world!');\n      });\n    });\n    test('status code and content-type should be correct', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('auto status code shoud be 200', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/auto-status-code'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('auto type shoud be text/plain', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/auto-type'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('redirect to `/` - 1', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect', function (response) {\n        t.equal(response.statusCode, 302);\n      });\n    });\n    test('redirect to `/` - 2', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code', function (response) {\n        t.equal(response.statusCode, 301);\n      });\n    });\n    test('redirect to `/` - 3', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('redirect to `/` - 4', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('redirect to `/` - 5', t => {\n      t.plan(3);\n      const url = 'http://localhost:' + fastify.server.address().port + '/redirect-onsend';\n      http.get(url, response => {\n        t.equal(response.headers['x-onsend'], 'yes');\n        t.equal(response.headers['content-length'], '0');\n        t.equal(response.headers.location, '/');\n      });\n    });\n    test('redirect to `/` - 6', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code-before-call'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('redirect to `/` - 7', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code-before-call-overwrite'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });\n    test('redirect to `/` - 8', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code-before-call', function (response) {\n        t.equal(response.statusCode, 307);\n      });\n    });\n    test('redirect to `/` - 9', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code-before-call-overwrite', function (response) {\n        t.equal(response.statusCode, 302);\n      });\n    });\n    t.end();\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"custom serializer should be used","suites":[],"updatePoint":{"line":285,"column":42,"index":7099},"line":285,"code":"    test('custom serializer should be used', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/custom-serializer'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello=world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"status code and content-type should be correct","suites":[],"updatePoint":{"line":296,"column":56,"index":7496},"line":296,"code":"    test('status code and content-type should be correct', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"auto status code shoud be 200","suites":[],"updatePoint":{"line":308,"column":39,"index":7896},"line":308,"code":"    test('auto status code shoud be 200', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/auto-status-code'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"auto type shoud be text/plain","suites":[],"updatePoint":{"line":319,"column":39,"index":8253},"line":319,"code":"    test('auto type shoud be text/plain', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/auto-type'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 1","suites":[],"updatePoint":{"line":330,"column":29,"index":8615},"line":330,"code":"    test('redirect to `/` - 1', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect', function (response) {\n        t.equal(response.statusCode, 302);\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 2","suites":[],"updatePoint":{"line":336,"column":29,"index":8836},"line":336,"code":"    test('redirect to `/` - 2', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code', function (response) {\n        t.equal(response.statusCode, 301);\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 3","suites":[],"updatePoint":{"line":342,"column":29,"index":9062},"line":342,"code":"    test('redirect to `/` - 3', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 4","suites":[],"updatePoint":{"line":354,"column":29,"index":9466},"line":354,"code":"    test('redirect to `/` - 4', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 5","suites":[],"updatePoint":{"line":366,"column":29,"index":9875},"line":366,"code":"    test('redirect to `/` - 5', t => {\n      t.plan(3);\n      const url = 'http://localhost:' + fastify.server.address().port + '/redirect-onsend';\n      http.get(url, response => {\n        t.equal(response.headers['x-onsend'], 'yes');\n        t.equal(response.headers['content-length'], '0');\n        t.equal(response.headers.location, '/');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 6","suites":[],"updatePoint":{"line":375,"column":29,"index":10236},"line":375,"code":"    test('redirect to `/` - 6', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code-before-call'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 7","suites":[],"updatePoint":{"line":387,"column":29,"index":10657},"line":387,"code":"    test('redirect to `/` - 7', t => {\n      t.plan(4);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/redirect-code-before-call-overwrite'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.equal(response.headers['content-type'], 'text/plain');\n        t.same(body.toString(), 'hello world!');\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 8","suites":[],"updatePoint":{"line":399,"column":29,"index":11088},"line":399,"code":"    test('redirect to `/` - 8', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code-before-call', function (response) {\n        t.equal(response.statusCode, 307);\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"redirect to `/` - 9","suites":[],"updatePoint":{"line":405,"column":29,"index":11326},"line":405,"code":"    test('redirect to `/` - 9', t => {\n      t.plan(1);\n      http.get('http://localhost:' + fastify.server.address().port + '/redirect-code-before-call-overwrite', function (response) {\n        t.equal(response.statusCode, 302);\n      });\n    });","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"buffer without content type should send a application/octet-stream and raw buffer","suites":[],"updatePoint":{"line":414,"column":87,"index":11655},"line":414,"code":"test('buffer without content type should send a application/octet-stream and raw buffer', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.send(Buffer.alloc(1024));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/octet-stream');\n      t.same(body, Buffer.alloc(1024));\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"buffer with content type should not send application/octet-stream","suites":[],"updatePoint":{"line":435,"column":71,"index":12233},"line":435,"code":"test('buffer with content type should not send application/octet-stream', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.header('Content-Type', 'text/plain');\n    reply.send(Buffer.alloc(1024));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'text/plain');\n      t.same(body, Buffer.alloc(1024));\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"stream with content type should not send application/octet-stream","suites":[],"updatePoint":{"line":457,"column":71,"index":12845},"line":457,"code":"test('stream with content type should not send application/octet-stream', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  const fs = require('fs');\n\n  const path = require('path');\n\n  const streamPath = path.join(__dirname, '..', '..', 'package.json');\n  const stream = fs.createReadStream(streamPath);\n  const buf = fs.readFileSync(streamPath);\n  fastify.get('/', function (req, reply) {\n    reply.header('Content-Type', 'text/plain').send(stream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'text/plain');\n      t.same(body, buf);\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"stream using reply.raw.writeHead should return customize headers","suites":[],"updatePoint":{"line":485,"column":70,"index":13644},"line":485,"code":"test('stream using reply.raw.writeHead should return customize headers', t => {\n  t.plan(6);\n\n  const fastify = require('../..')();\n\n  const fs = require('fs');\n\n  const path = require('path');\n\n  const streamPath = path.join(__dirname, '..', '..', 'package.json');\n  const stream = fs.createReadStream(streamPath);\n  const buf = fs.readFileSync(streamPath);\n  fastify.get('/', function (req, reply) {\n    reply.log.warn = function mockWarn(message) {\n      t.equal(message, 'response will send, but you shouldn\\'t use res.writeHead in stream mode');\n    };\n\n    reply.raw.writeHead(200, {\n      location: '/'\n    });\n    reply.send(stream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers.location, '/');\n      t.equal(response.headers['Content-Type'], undefined);\n      t.same(body, buf);\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"plain string without content type should send a text/plain","suites":[],"updatePoint":{"line":521,"column":64,"index":14660},"line":521,"code":"test('plain string without content type should send a text/plain', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.send('hello world!');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'text/plain; charset=utf-8');\n      t.same(body.toString(), 'hello world!');\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"plain string with content type should be sent unmodified","suites":[],"updatePoint":{"line":542,"column":62,"index":15233},"line":542,"code":"test('plain string with content type should be sent unmodified', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.type('text/css').send('hello world!');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'text/css');\n      t.same(body.toString(), 'hello world!');\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"plain string with content type and custom serializer should be serialized","suites":[],"updatePoint":{"line":563,"column":79,"index":15823},"line":563,"code":"test('plain string with content type and custom serializer should be serialized', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.serializer(() => 'serialized').type('text/css').send('hello world!');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'text/css');\n      t.same(body.toString(), 'serialized');\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"plain string with content type application/json should NOT be serialized as json","suites":[],"updatePoint":{"line":584,"column":86,"index":16449},"line":584,"code":"test('plain string with content type application/json should NOT be serialized as json', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.type('application/json').send('{\"key\": \"hello world!\"}');\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      t.same(body.toString(), '{\"key\": \"hello world!\"}');\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"plain string with custom json content type should NOT be serialized as json","suites":[],"updatePoint":{"line":605,"column":81,"index":17094},"line":605,"code":"test('plain string with custom json content type should NOT be serialized as json', t => {\n  t.plan(19);\n\n  const fastify = require('../..')();\n\n  const customSamples = {\n    collectionjson: {\n      mimeType: 'application/vnd.collection+json',\n      sample: '{\"collection\":{\"version\":\"1.0\",\"href\":\"http://api.example.com/people/\"}}'\n    },\n    hal: {\n      mimeType: 'application/hal+json',\n      sample: '{\"_links\":{\"self\":{\"href\":\"https://api.example.com/people/1\"}},\"name\":\"John Doe\"}'\n    },\n    jsonapi: {\n      mimeType: 'application/vnd.api+json',\n      sample: '{\"data\":{\"type\":\"people\",\"id\":\"1\"}}'\n    },\n    jsonld: {\n      mimeType: 'application/ld+json',\n      sample: '{\"@context\":\"https://json-ld.org/contexts/person.jsonld\",\"name\":\"John Doe\"}'\n    },\n    ndjson: {\n      mimeType: 'application/x-ndjson',\n      sample: '{\"a\":\"apple\",\"b\":{\"bb\":\"bubble\"}}\\n{\"c\":\"croissant\",\"bd\":{\"dd\":\"dribble\"}}'\n    },\n    siren: {\n      mimeType: 'application/vnd.siren+json',\n      sample: '{\"class\":\"person\",\"properties\":{\"name\":\"John Doe\"}}'\n    }\n  };\n  Object.keys(customSamples).forEach(path => {\n    fastify.get(`/${path}`, function (req, reply) {\n      reply.type(customSamples[path].mimeType).send(customSamples[path].sample);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    Object.keys(customSamples).forEach(path => {\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/' + path\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], customSamples[path].mimeType + '; charset=utf-8');\n        t.same(body.toString(), customSamples[path].sample);\n      });\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"non-string with content type application/json SHOULD be serialized as json","suites":[],"updatePoint":{"line":656,"column":80,"index":18829},"line":656,"code":"test('non-string with content type application/json SHOULD be serialized as json', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.type('application/json').send({\n      key: 'hello world!'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      t.same(body.toString(), JSON.stringify({\n        key: 'hello world!'\n      }));\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"non-string with custom json content type SHOULD be serialized as json","suites":[],"updatePoint":{"line":681,"column":75,"index":19504},"line":681,"code":"test('non-string with custom json content type SHOULD be serialized as json', t => {\n  t.plan(16);\n\n  const fastify = require('../..')();\n\n  const customSamples = {\n    collectionjson: {\n      mimeType: 'application/vnd.collection+json',\n      sample: JSON.parse('{\"collection\":{\"version\":\"1.0\",\"href\":\"http://api.example.com/people/\"}}')\n    },\n    hal: {\n      mimeType: 'application/hal+json',\n      sample: JSON.parse('{\"_links\":{\"self\":{\"href\":\"https://api.example.com/people/1\"}},\"name\":\"John Doe\"}')\n    },\n    jsonapi: {\n      mimeType: 'application/vnd.api+json',\n      sample: JSON.parse('{\"data\":{\"type\":\"people\",\"id\":\"1\"}}')\n    },\n    jsonld: {\n      mimeType: 'application/ld+json',\n      sample: JSON.parse('{\"@context\":\"https://json-ld.org/contexts/person.jsonld\",\"name\":\"John Doe\"}')\n    },\n    siren: {\n      mimeType: 'application/vnd.siren+json',\n      sample: JSON.parse('{\"class\":\"person\",\"properties\":{\"name\":\"John Doe\"}}')\n    }\n  };\n  Object.keys(customSamples).forEach(path => {\n    fastify.get(`/${path}`, function (req, reply) {\n      reply.type(customSamples[path].mimeType).send(customSamples[path].sample);\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    Object.keys(customSamples).forEach(path => {\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/' + path\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.headers['content-type'], customSamples[path].mimeType + '; charset=utf-8');\n        t.same(body.toString(), JSON.stringify(customSamples[path].sample));\n      });\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"error object with a content type that is not application/json should work","suites":[],"updatePoint":{"line":728,"column":79,"index":21162},"line":728,"code":"test('error object with a content type that is not application/json should work', t => {\n  t.plan(6);\n\n  const fastify = require('../..')();\n\n  fastify.get('/text', function (req, reply) {\n    reply.type('text/plain');\n    reply.send(new Error('some application error'));\n  });\n  fastify.get('/html', function (req, reply) {\n    reply.type('text/html');\n    reply.send(new Error('some application error'));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/text'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(JSON.parse(res.payload).message, 'some application error');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/html'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.equal(JSON.parse(res.payload).message, 'some application error');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"undefined payload should be sent as-is","suites":[],"updatePoint":{"line":758,"column":44,"index":21956},"line":758,"code":"test('undefined payload should be sent as-is', t => {\n  t.plan(6);\n\n  const fastify = require('../..')();\n\n  fastify.addHook('onSend', function (request, reply, payload, done) {\n    t.equal(payload, undefined);\n    done();\n  });\n  fastify.get('/', function (req, reply) {\n    reply.code(204).send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: `http://localhost:${fastify.server.address().port}`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], undefined);\n      t.equal(response.headers['content-length'], undefined);\n      t.equal(body.length, 0);\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"for HEAD method, no body should be sent but content-length should be","suites":[],"updatePoint":{"line":784,"column":74,"index":22687},"line":784,"code":"test('for HEAD method, no body should be sent but content-length should be', t => {\n  t.plan(11);\n\n  const fastify = require('../..')();\n\n  const contentType = 'application/json; charset=utf-8';\n  const bodySize = JSON.stringify({\n    foo: 'bar'\n  }).length;\n  fastify.head('/', {\n    onSend: function (request, reply, payload, done) {\n      t.equal(payload, undefined);\n      done();\n    }\n  }, function (req, reply) {\n    reply.header('content-length', bodySize);\n    reply.header('content-type', contentType);\n    reply.code(200).send();\n  });\n  fastify.head('/with/null', {\n    onSend: function (request, reply, payload, done) {\n      t.equal(payload, 'null');\n      done();\n    }\n  }, function (req, reply) {\n    reply.header('content-length', bodySize);\n    reply.header('content-type', contentType);\n    reply.code(200).send(null);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'HEAD',\n      url: `http://localhost:${fastify.server.address().port}`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], contentType);\n      t.equal(response.headers['content-length'], bodySize.toString());\n      t.equal(body.length, 0);\n    });\n    sget({\n      method: 'HEAD',\n      url: `http://localhost:${fastify.server.address().port}/with/null`\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.headers['content-type'], contentType);\n      t.equal(response.headers['content-length'], bodySize.toString());\n      t.equal(body.length, 0);\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.send(new NotFound()) should not invoke the 404 handler","suites":[],"updatePoint":{"line":836,"column":66,"index":24265},"line":836,"code":"test('reply.send(new NotFound()) should not invoke the 404 handler', t => {\n  t.plan(9);\n\n  const fastify = require('../..')();\n\n  fastify.setNotFoundHandler((req, reply) => {\n    t.fail('Should not be called');\n  });\n  fastify.get('/not-found', function (req, reply) {\n    reply.send(new NotFound());\n  });\n  fastify.register(function (instance, options, done) {\n    instance.get('/not-found', function (req, reply) {\n      reply.send(new NotFound());\n    });\n    done();\n  }, {\n    prefix: '/prefixed'\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/not-found'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n      t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      t.same(JSON.parse(body.toString()), {\n        statusCode: 404,\n        error: 'Not Found',\n        message: 'Not Found'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/prefixed/not-found'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n      t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      t.same(JSON.parse(body), {\n        error: 'Not Found',\n        message: 'Not Found',\n        statusCode: 404\n      });\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply can set multiple instances of same header","suites":[],"updatePoint":{"line":886,"column":53,"index":25711},"line":886,"code":"test('reply can set multiple instances of same header', t => {\n  t.plan(4);\n\n  const fastify = require('../../')();\n\n  fastify.get('/headers', function (req, reply) {\n    reply.header('set-cookie', 'one').header('set-cookie', 'two').send({});\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.ok(response.headers['set-cookie']);\n      t.strictSame(response.headers['set-cookie'], ['one', 'two']);\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.hasHeader returns correct values","suites":[],"updatePoint":{"line":907,"column":44,"index":26318},"line":907,"code":"test('reply.hasHeader returns correct values', t => {\n  t.plan(3);\n\n  const fastify = require('../../')();\n\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    t.equal(reply.hasHeader('x-foo'), true);\n    t.equal(reply.hasHeader('x-bar'), false);\n    reply.send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, () => {});\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getHeader returns correct values","suites":[],"updatePoint":{"line":927,"column":44,"index":26836},"line":927,"code":"test('reply.getHeader returns correct values', t => {\n  t.plan(4);\n\n  const fastify = require('../../')();\n\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    t.equal(reply.getHeader('x-foo'), 'foo');\n    reply.header('x-foo', 'bar');\n    t.strictSame(reply.getHeader('x-foo'), 'bar');\n    reply.header('set-cookie', 'one');\n    reply.header('set-cookie', 'two');\n    t.strictSame(reply.getHeader('set-cookie'), ['one', 'two']);\n    reply.send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, () => {});\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getHeader returns raw header if there is not in the reply headers","suites":[],"updatePoint":{"line":951,"column":77,"index":27570},"line":951,"code":"test('reply.getHeader returns raw header if there is not in the reply headers', t => {\n  t.plan(1);\n  const response = {\n    setHeader: () => {},\n    hasHeader: () => true,\n    getHeader: () => 'bar',\n    writeHead: () => {},\n    end: () => {}\n  };\n  const reply = new Reply(response, {\n    onSend: []\n  }, null);\n  t.equal(reply.getHeader('foo'), 'bar');\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getHeaders returns correct values","suites":[],"updatePoint":{"line":965,"column":45,"index":27898},"line":965,"code":"test('reply.getHeaders returns correct values', t => {\n  t.plan(3);\n\n  const fastify = require('../../')();\n\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    t.strictSame(reply.getHeaders(), {\n      'x-foo': 'foo'\n    });\n    reply.header('x-bar', 'bar');\n    reply.raw.setHeader('x-foo', 'foo2');\n    reply.raw.setHeader('x-baz', 'baz');\n    t.strictSame(reply.getHeaders(), {\n      'x-foo': 'foo',\n      'x-bar': 'bar',\n      'x-baz': 'baz'\n    });\n    reply.send();\n  });\n  fastify.inject('/headers', err => {\n    t.error(err);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.removeHeader can remove the value","suites":[],"updatePoint":{"line":989,"column":45,"index":28478},"line":989,"code":"test('reply.removeHeader can remove the value', t => {\n  t.plan(5);\n\n  const fastify = require('../../')();\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    t.equal(reply.getHeader('x-foo'), 'foo');\n    t.equal(reply.removeHeader('x-foo'), reply);\n    t.strictSame(reply.getHeader('x-foo'), undefined);\n    reply.send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, () => {\n      t.pass();\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.header can reset the value","suites":[],"updatePoint":{"line":1013,"column":38,"index":29113},"line":1013,"code":"test('reply.header can reset the value', t => {\n  t.plan(3);\n\n  const fastify = require('../../')();\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    reply.header('x-foo', undefined);\n    t.strictSame(reply.getHeader('x-foo'), '');\n    reply.send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, () => {\n      t.pass();\n    });\n  });\n}); // https://github.com/fastify/fastify/issues/3030","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.hasHeader computes raw and fastify headers","suites":[],"updatePoint":{"line":1037,"column":54,"index":29751},"line":1037,"code":"test('reply.hasHeader computes raw and fastify headers', t => {\n  t.plan(4);\n\n  const fastify = require('../../')();\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.get('/headers', function (req, reply) {\n    reply.header('x-foo', 'foo');\n    reply.raw.setHeader('x-bar', 'bar');\n    t.ok(reply.hasHeader('x-foo'));\n    t.ok(reply.hasHeader('x-bar'));\n    reply.send();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, () => {\n      t.pass();\n    });\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"Reply should handle JSON content type with a charset","suites":[],"updatePoint":{"line":1061,"column":58,"index":30369},"line":1061,"code":"test('Reply should handle JSON content type with a charset', t => {\n  t.plan(16);\n\n  const fastify = require('../../')();\n\n  fastify.get('/default', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/utf8', function (req, reply) {\n    reply.header('content-type', 'application/json; charset=utf-8').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/utf16', function (req, reply) {\n    reply.header('content-type', 'application/json; charset=utf-16').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/utf32', function (req, reply) {\n    reply.header('content-type', 'application/json; charset=utf-32').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/type-utf8', function (req, reply) {\n    reply.type('application/json; charset=utf-8').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/type-utf16', function (req, reply) {\n    reply.type('application/json; charset=utf-16').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/type-utf32', function (req, reply) {\n    reply.type('application/json; charset=utf-32').send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/no-space-type-utf32', function (req, reply) {\n    reply.type('application/json;charset=utf-32').send({\n      hello: 'world'\n    });\n  });\n  fastify.inject('/default', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n  });\n  fastify.inject('/utf8', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n  });\n  fastify.inject('/utf16', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-16');\n  });\n  fastify.inject('/utf32', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-32');\n  });\n  fastify.inject('/type-utf8', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n  });\n  fastify.inject('/type-utf16', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-16');\n  });\n  fastify.inject('/type-utf32', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-32');\n  });\n  fastify.inject('/no-space-type-utf32', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json;charset=utf-32');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"Content type and charset set previously","suites":[],"updatePoint":{"line":1139,"column":45,"index":32835},"line":1139,"code":"test('Content type and charset set previously', t => {\n  t.plan(2);\n\n  const fastify = require('../../')();\n\n  fastify.addHook('onRequest', function (req, reply, done) {\n    reply.header('content-type', 'application/json; charset=utf-16');\n    done();\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-16');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":".status() is an alias for .code()","suites":[],"updatePoint":{"line":1158,"column":39,"index":33326},"line":1158,"code":"test('.status() is an alias for .code()', t => {\n  t.plan(2);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.status(418).send();\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 418);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":".statusCode is getter and setter","suites":[],"updatePoint":{"line":1171,"column":38,"index":33606},"line":1171,"code":"test('.statusCode is getter and setter', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    t.ok(reply.statusCode, 200, 'default status value');\n    reply.statusCode = 418;\n    t.ok(reply.statusCode, 418);\n    reply.send();\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 418);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.header setting multiple cookies as multiple Set-Cookie headers","suites":[],"updatePoint":{"line":1187,"column":74,"index":34028},"line":1187,"code":"test('reply.header setting multiple cookies as multiple Set-Cookie headers', t => {\n  t.plan(7);\n\n  const fastify = require('../../')();\n\n  fastify.get('/headers', function (req, reply) {\n    reply.header('set-cookie', 'one').header('set-cookie', 'two').header('set-cookie', 'three').header('set-cookie', ['four', 'five', 'six']).send({});\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/headers'\n    }, (err, response, body) => {\n      t.error(err);\n      t.ok(response.headers['set-cookie']);\n      t.strictSame(response.headers['set-cookie'], ['one', 'two', 'three', 'four', 'five', 'six']);\n    });\n  });\n  fastify.inject('/headers', (error, response) => {\n    t.error(error);\n    t.ok(response.headers['set-cookie']);\n    t.strictSame(response.headers['set-cookie'], ['one', 'two', 'three', 'four', 'five', 'six']);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"should throw error when passing falsy value to reply.sent","suites":[],"updatePoint":{"line":1213,"column":63,"index":34980},"line":1213,"code":"test('should throw error when passing falsy value to reply.sent', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    try {\n      reply.sent = false;\n    } catch (err) {\n      t.equal(err.code, 'FST_ERR_REP_SENT_VALUE');\n      t.equal(err.message, 'The only possible value for reply.sent is true.');\n      reply.send();\n    }\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.pass();\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"should throw error when attempting to set reply.sent more than once","suites":[],"updatePoint":{"line":1232,"column":73,"index":35457},"line":1232,"code":"test('should throw error when attempting to set reply.sent more than once', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.get('/', function (req, reply) {\n    reply.sent = true;\n\n    try {\n      reply.sent = true;\n    } catch (err) {\n      t.equal(err.code, 'FST_ERR_REP_ALREADY_SENT');\n      t.equal(err.message, 'Reply was already sent.');\n    }\n\n    reply.raw.end();\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.pass();\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getResponseTime() should return 0 before the timer is initialised on the reply by setting up response listeners","suites":[],"updatePoint":{"line":1254,"column":123,"index":35987},"line":1254,"code":"test('reply.getResponseTime() should return 0 before the timer is initialised on the reply by setting up response listeners', t => {\n  t.plan(1);\n  const response = {\n    statusCode: 200\n  };\n  const reply = new Reply(response, null);\n  t.equal(reply.getResponseTime(), 0);\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getResponseTime() should return a number greater than 0 after the timer is initialised on the reply by setting up response listeners","suites":[],"updatePoint":{"line":1262,"column":144,"index":36286},"line":1262,"code":"test('reply.getResponseTime() should return a number greater than 0 after the timer is initialised on the reply by setting up response listeners', t => {\n  t.plan(1);\n\n  const fastify = require('../..')();\n\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send('hello world');\n    }\n  });\n  fastify.addHook('onResponse', (req, reply) => {\n    t.ok(reply.getResponseTime() > 0);\n    t.end();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getResponseTime() should return the time since a request started while inflight","suites":[],"updatePoint":{"line":1283,"column":91,"index":36736},"line":1283,"code":"test('reply.getResponseTime() should return the time since a request started while inflight', t => {\n  t.plan(1);\n\n  const fastify = require('../..')();\n\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send('hello world');\n    }\n  });\n  fastify.addHook('preValidation', (req, reply, done) => {\n    t.not(reply.getResponseTime(), reply.getResponseTime());\n    done();\n  });\n  fastify.addHook('onResponse', (req, reply) => {\n    t.end();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.getResponseTime() should return the same value after a request is finished","suites":[],"updatePoint":{"line":1307,"column":86,"index":37280},"line":1307,"code":"test('reply.getResponseTime() should return the same value after a request is finished', t => {\n  t.plan(1);\n\n  const fastify = require('../..')();\n\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send('hello world');\n    }\n  });\n  fastify.addHook('onResponse', (req, reply) => {\n    t.equal(reply.getResponseTime(), reply.getResponseTime());\n    t.end();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply should use the custom serializer","suites":[],"updatePoint":{"line":1328,"column":44,"index":37707},"line":1328,"code":"test('reply should use the custom serializer', t => {\n  t.plan(4);\n\n  const fastify = require('../..')();\n\n  fastify.setReplySerializer((payload, statusCode) => {\n    t.same(payload, {\n      foo: 'bar'\n    });\n    t.equal(statusCode, 200);\n    payload.foo = 'bar bar';\n    return JSON.stringify(payload);\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        foo: 'bar'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"foo\":\"bar bar\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply should use the right serializer in encapsulated context","suites":[],"updatePoint":{"line":1358,"column":67,"index":38330},"line":1358,"code":"test('reply should use the right serializer in encapsulated context', t => {\n  t.plan(9);\n\n  const fastify = require('../..')();\n\n  fastify.setReplySerializer(payload => {\n    t.same(payload, {\n      foo: 'bar'\n    });\n    payload.foo = 'bar bar';\n    return JSON.stringify(payload);\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        foo: 'bar'\n      });\n    }\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.route({\n      method: 'GET',\n      url: '/sub',\n      handler: (req, reply) => {\n        reply.send({\n          john: 'doo'\n        });\n      }\n    });\n    instance.setReplySerializer(payload => {\n      t.same(payload, {\n        john: 'doo'\n      });\n      payload.john = 'too too';\n      return JSON.stringify(payload);\n    });\n    done();\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.route({\n      method: 'GET',\n      url: '/sub',\n      handler: (req, reply) => {\n        reply.send({\n          sweet: 'potato'\n        });\n      }\n    });\n    instance.setReplySerializer(payload => {\n      t.same(payload, {\n        sweet: 'potato'\n      });\n      payload.sweet = 'potato potato';\n      return JSON.stringify(payload);\n    });\n    done();\n  }, {\n    prefix: 'sub'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"foo\":\"bar bar\"}');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/sub'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"john\":\"too too\"}');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/sub/sub'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"sweet\":\"potato potato\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply should use the right serializer in deep encapsulated context","suites":[],"updatePoint":{"line":1441,"column":72,"index":40085},"line":1441,"code":"test('reply should use the right serializer in deep encapsulated context', t => {\n  t.plan(8);\n\n  const fastify = require('../..')();\n\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        foo: 'bar'\n      });\n    }\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.route({\n      method: 'GET',\n      url: '/sub',\n      handler: (req, reply) => {\n        reply.send({\n          john: 'doo'\n        });\n      }\n    });\n    instance.setReplySerializer(payload => {\n      t.same(payload, {\n        john: 'doo'\n      });\n      payload.john = 'too too';\n      return JSON.stringify(payload);\n    });\n    instance.register(function (subInstance, opts, done) {\n      subInstance.route({\n        method: 'GET',\n        url: '/deep',\n        handler: (req, reply) => {\n          reply.send({\n            john: 'deep'\n          });\n        }\n      });\n      subInstance.setReplySerializer(payload => {\n        t.same(payload, {\n          john: 'deep'\n        });\n        payload.john = 'deep deep';\n        return JSON.stringify(payload);\n      });\n      done();\n    });\n    done();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"foo\":\"bar\"}');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/sub'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"john\":\"too too\"}');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/deep'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"john\":\"deep deep\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply should use the route serializer","suites":[],"updatePoint":{"line":1515,"column":43,"index":41652},"line":1515,"code":"test('reply should use the route serializer', t => {\n  t.plan(3);\n\n  const fastify = require('../..')();\n\n  fastify.setReplySerializer(() => {\n    t.fail('this serializer should not be executed');\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.serializer(payload => {\n        t.same(payload, {\n          john: 'doo'\n        });\n        payload.john = 'too too';\n        return JSON.stringify(payload);\n      }).send({\n        john: 'doo'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"john\":\"too too\"}');\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"cannot set the replySerializer when the server is running","suites":[],"updatePoint":{"line":1546,"column":63,"index":42333},"line":1546,"code":"test('cannot set the replySerializer when the server is running', t => {\n  t.plan(2);\n\n  const fastify = require('../..')();\n\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(err => {\n    t.error(err);\n\n    try {\n      fastify.setReplySerializer(() => {});\n      t.fail('this serializer should not be setup');\n    } catch (e) {\n      t.equal(e.message, 'Cannot call \"setReplySerializer\" when fastify instance is already started!');\n    }\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply should not call the custom serializer for errors and not found","suites":[],"updatePoint":{"line":1563,"column":74,"index":42803},"line":1563,"code":"test('reply should not call the custom serializer for errors and not found', t => {\n  t.plan(9);\n\n  const fastify = require('../..')();\n\n  fastify.setReplySerializer((payload, statusCode) => {\n    t.same(payload, {\n      foo: 'bar'\n    });\n    t.equal(statusCode, 200);\n    return JSON.stringify(payload);\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      foo: 'bar'\n    });\n  });\n  fastify.get('/err', (req, reply) => {\n    reply.send(new Error('an error'));\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, '{\"foo\":\"bar\"}');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/err'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/not-existing'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"reply.then","suites":[],"updatePoint":{"line":1606,"column":16,"index":43679},"line":1606,"code":"test('reply.then', t => {\n  t.plan(4);\n\n  function request() {}\n\n  t.test('without an error', t => {\n    t.plan(1);\n    const response = new Writable();\n    const reply = new Reply(response, request);\n    reply.then(function () {\n      t.pass('fulfilled called');\n    });\n    response.destroy();\n  });\n  t.test('with an error', t => {\n    t.plan(1);\n    const response = new Writable();\n    const reply = new Reply(response, request);\n\n    const _err = new Error('kaboom');\n\n    reply.then(function () {\n      t.fail('fulfilled called');\n    }, function (err) {\n      t.equal(err, _err);\n    });\n    response.destroy(_err);\n  });\n  t.test('with error but without reject callback', t => {\n    t.plan(1);\n    const response = new Writable();\n    const reply = new Reply(response, request);\n\n    const _err = new Error('kaboom');\n\n    reply.then(function () {\n      t.fail('fulfilled called');\n    });\n    t.pass();\n    response.destroy(_err);\n  });\n  t.test('with error, without reject callback, with logger', t => {\n    t.plan(1);\n    const response = new Writable();\n    const reply = new Reply(response, request); // spy logger\n\n    reply.log = {\n      warn: message => {\n        t.equal(message, 'unhandled rejection on reply.then');\n      }\n    };\n\n    const _err = new Error('kaboom');\n\n    reply.then(function () {\n      t.fail('fulfilled called');\n    });\n    response.destroy(_err);\n  });\n});","file":"internals/reply.test.js","skipped":false,"dir":"test"},{"name":"Regular request","suites":[],"updatePoint":{"line":9,"column":21,"index":120},"line":9,"code":"test('Regular request', t => {\n  t.plan(15);\n  const headers = {\n    host: 'hostname'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const request = new Request('id', 'params', req, 'query', 'log');\n  t.type(request, Request);\n  t.equal(request.id, 'id');\n  t.equal(request.params, 'params');\n  t.same(request.raw, req);\n  t.equal(request.query, 'query');\n  t.equal(request.headers, headers);\n  t.equal(request.log, 'log');\n  t.equal(request.ip, 'ip');\n  t.equal(request.ips, undefined);\n  t.equal(request.hostname, 'hostname');\n  t.equal(request.body, null);\n  t.equal(request.method, 'GET');\n  t.equal(request.url, '/');\n  t.equal(request.protocol, 'http');\n  t.same(request.socket, req.socket);\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Regular request - hostname from authority","suites":[],"updatePoint":{"line":39,"column":47,"index":921},"line":39,"code":"test('Regular request - hostname from authority', t => {\n  t.plan(2);\n  const headers = {\n    ':authority': 'authority'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const request = new Request('id', 'params', req, 'query', 'log');\n  t.type(request, Request);\n  t.equal(request.hostname, 'authority');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Regular request - host header has precedence over authority","suites":[],"updatePoint":{"line":56,"column":65,"index":1319},"line":56,"code":"test('Regular request - host header has precedence over authority', t => {\n  t.plan(2);\n  const headers = {\n    host: 'hostname',\n    ':authority': 'authority'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const request = new Request('id', 'params', req, 'query', 'log');\n  t.type(request, Request);\n  t.equal(request.hostname, 'hostname');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy","suites":[],"updatePoint":{"line":74,"column":30,"index":1703},"line":74,"code":"test('Request with trust proxy', t => {\n  t.plan(15);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    'x-forwarded-host': 'example.com'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.id, 'id');\n  t.equal(request.params, 'params');\n  t.same(request.raw, req);\n  t.equal(request.query, 'query');\n  t.equal(request.headers, headers);\n  t.equal(request.log, 'log');\n  t.equal(request.ip, '2.2.2.2');\n  t.same(request.ips, ['ip', '1.1.1.1', '2.2.2.2']);\n  t.equal(request.hostname, 'example.com');\n  t.equal(request.body, null);\n  t.equal(request.method, 'GET');\n  t.equal(request.url, '/');\n  t.equal(request.protocol, 'http');\n  t.same(request.socket, req.socket);\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy, encrypted","suites":[],"updatePoint":{"line":106,"column":41,"index":2645},"line":106,"code":"test('Request with trust proxy, encrypted', t => {\n  t.plan(2);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    'x-forwarded-host': 'example.com'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip',\n      encrypted: true\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.protocol, 'https');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy - no x-forwarded-host header","suites":[],"updatePoint":{"line":126,"column":59,"index":3168},"line":126,"code":"test('Request with trust proxy - no x-forwarded-host header', t => {\n  t.plan(2);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    host: 'hostname'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.hostname, 'hostname');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy - no x-forwarded-host header and fallback to authority","suites":[],"updatePoint":{"line":145,"column":85,"index":3680},"line":145,"code":"test('Request with trust proxy - no x-forwarded-host header and fallback to authority', t => {\n  t.plan(2);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    ':authority': 'authority'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.hostname, 'authority');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy - x-forwarded-host header has precedence over host","suites":[],"updatePoint":{"line":164,"column":81,"index":4198},"line":164,"code":"test('Request with trust proxy - x-forwarded-host header has precedence over host', t => {\n  t.plan(2);\n  const headers = {\n    'x-forwarded-for': ' 2.2.2.2, 1.1.1.1',\n    'x-forwarded-host': 'example.com',\n    host: 'hostname'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.hostname, 'example.com');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy - handles multiple entries in x-forwarded-host/proto","suites":[],"updatePoint":{"line":184,"column":83,"index":4751},"line":184,"code":"test('Request with trust proxy - handles multiple entries in x-forwarded-host/proto', t => {\n  t.plan(3);\n  const headers = {\n    'x-forwarded-host': 'example2.com, example.com',\n    'x-forwarded-proto': 'http, https'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.type(request, TpRequest);\n  t.equal(request.hostname, 'example.com');\n  t.equal(request.protocol, 'https');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy - plain","suites":[],"updatePoint":{"line":204,"column":38,"index":5285},"line":204,"code":"test('Request with trust proxy - plain', t => {\n  t.plan(1);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    'x-forwarded-host': 'example.com'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: {\n      remoteAddress: 'ip'\n    },\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.same(request.protocol, 'http');\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with undefined socket","suites":[],"updatePoint":{"line":222,"column":35,"index":5729},"line":222,"code":"test('Request with undefined socket', t => {\n  t.plan(15);\n  const headers = {\n    host: 'hostname'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: undefined,\n    headers\n  };\n  const request = new Request('id', 'params', req, 'query', 'log');\n  t.type(request, Request);\n  t.equal(request.id, 'id');\n  t.equal(request.params, 'params');\n  t.same(request.raw, req);\n  t.equal(request.query, 'query');\n  t.equal(request.headers, headers);\n  t.equal(request.log, 'log');\n  t.equal(request.ip, undefined);\n  t.equal(request.ips, undefined);\n  t.equal(request.hostname, 'hostname');\n  t.equal(request.body, null);\n  t.equal(request.method, 'GET');\n  t.equal(request.url, '/');\n  t.equal(request.protocol, undefined);\n  t.same(request.socket, req.socket);\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Request with trust proxy and undefined socket","suites":[],"updatePoint":{"line":250,"column":51,"index":6518},"line":250,"code":"test('Request with trust proxy and undefined socket', t => {\n  t.plan(1);\n  const headers = {\n    'x-forwarded-for': '2.2.2.2, 1.1.1.1',\n    'x-forwarded-host': 'example.com'\n  };\n  const req = {\n    method: 'GET',\n    url: '/',\n    socket: undefined,\n    headers\n  };\n  const TpRequest = Request.buildRequest(Request, true);\n  const request = new TpRequest('id', 'params', req, 'query', 'log');\n  t.same(request.protocol, undefined);\n});","file":"internals/request.test.js","skipped":false,"dir":"test"},{"name":"Symbols","suites":[],"updatePoint":{"line":25,"column":13,"index":386},"line":25,"code":"test('Symbols', t => {\n  t.plan(5);\n  t.equal(typeof symbols.responseSchema, 'symbol');\n  t.equal(typeof symbols.bodySchema, 'symbol');\n  t.equal(typeof symbols.querystringSchema, 'symbol');\n  t.equal(typeof symbols.paramsSchema, 'symbol');\n  t.equal(typeof symbols.headersSchema, 'symbol');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":" schema - missing schema","suites":[],"updatePoint":{"line":34,"column":39,"index":792},"line":34,"code":"  test(`${func} schema - missing schema`, t => {\n    t.plan(2);\n    const context = {};\n    validation[func](context);\n    t.equal(typeof context[symbols.bodySchema], 'undefined');\n    t.equal(typeof context[symbols.responseSchema], 'undefined');\n  });","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":" schema - missing output schema","suites":[],"updatePoint":{"line":41,"column":46,"index":1052},"line":41,"code":"  test(`${func} schema - missing output schema`, t => {\n    t.plan(1);\n    const context = {\n      schema: {}\n    };\n    validation[func](context, null);\n    t.equal(typeof context[symbols.responseSchema], 'undefined');\n  });","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - output schema","suites":[],"updatePoint":{"line":50,"column":34,"index":1270},"line":50,"code":"test('build schema - output schema', t => {\n  t.plan(2);\n  const opts = {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'string'\n            }\n          }\n        },\n        201: {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'number'\n            }\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForSerialization(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.equal(typeof opts[symbols.responseSchema]['2xx'], 'function');\n  t.equal(typeof opts[symbols.responseSchema]['201'], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - payload schema","suites":[],"updatePoint":{"line":83,"column":35,"index":1968},"line":83,"code":"test('build schema - payload schema', t => {\n  t.plan(1);\n  const opts = {\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.equal(typeof opts[symbols.bodySchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - avoid repeated normalize schema","suites":[],"updatePoint":{"line":105,"column":52,"index":2407},"line":105,"code":"test('build schema - avoid repeated normalize schema', t => {\n  t.plan(3);\n  const serverConfig = {\n    jsonShorthand: true\n  };\n  const opts = {\n    schema: {\n      query: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  opts.schema = normalizeSchema(opts.schema, serverConfig);\n  t.not(kSchemaVisited, undefined);\n  t.equal(opts.schema[kSchemaVisited], true);\n  t.equal(opts.schema, normalizeSchema(opts.schema, serverConfig));\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - query schema","suites":[],"updatePoint":{"line":127,"column":33,"index":2910},"line":127,"code":"test('build schema - query schema', t => {\n  t.plan(2);\n  const serverConfig = {\n    jsonShorthand: true\n  };\n  const opts = {\n    schema: {\n      query: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  opts.schema = normalizeSchema(opts.schema, serverConfig);\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.type(opts[symbols.querystringSchema].schema.type, 'string');\n  t.equal(typeof opts[symbols.querystringSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - query schema abbreviated","suites":[],"updatePoint":{"line":154,"column":45,"index":3529},"line":154,"code":"test('build schema - query schema abbreviated', t => {\n  t.plan(2);\n  const serverConfig = {\n    jsonShorthand: true\n  };\n  const opts = {\n    schema: {\n      query: {\n        hello: {\n          type: 'string'\n        }\n      }\n    }\n  };\n  opts.schema = normalizeSchema(opts.schema, serverConfig);\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.type(opts[symbols.querystringSchema].schema.type, 'string');\n  t.equal(typeof opts[symbols.querystringSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - querystring schema","suites":[],"updatePoint":{"line":178,"column":39,"index":4080},"line":178,"code":"test('build schema - querystring schema', t => {\n  t.plan(2);\n  const opts = {\n    schema: {\n      querystring: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.type(opts[symbols.querystringSchema].schema.type, 'string');\n  t.equal(typeof opts[symbols.querystringSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - querystring schema abbreviated","suites":[],"updatePoint":{"line":201,"column":51,"index":4597},"line":201,"code":"test('build schema - querystring schema abbreviated', t => {\n  t.plan(2);\n  const serverConfig = {\n    jsonShorthand: true\n  };\n  const opts = {\n    schema: {\n      querystring: {\n        hello: {\n          type: 'string'\n        }\n      }\n    }\n  };\n  opts.schema = normalizeSchema(opts.schema, serverConfig);\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.type(opts[symbols.querystringSchema].schema.type, 'string');\n  t.equal(typeof opts[symbols.querystringSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - must throw if querystring and query schema exist","suites":[],"updatePoint":{"line":225,"column":69,"index":5184},"line":225,"code":"test('build schema - must throw if querystring and query schema exist', t => {\n  t.plan(2);\n\n  try {\n    const serverConfig = {\n      jsonShorthand: true\n    };\n    const opts = {\n      schema: {\n        query: {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'string'\n            }\n          }\n        },\n        querystring: {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    };\n    opts.schema = normalizeSchema(opts.schema, serverConfig);\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_SCH_DUPLICATE');\n    t.equal(err.message, 'Schema with \\'querystring\\' already present!');\n  }\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - params schema","suites":[],"updatePoint":{"line":258,"column":34,"index":5883},"line":258,"code":"test('build schema - params schema', t => {\n  t.plan(1);\n  const opts = {\n    schema: {\n      params: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.equal(typeof opts[symbols.paramsSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - headers schema","suites":[],"updatePoint":{"line":280,"column":35,"index":6309},"line":280,"code":"test('build schema - headers schema', t => {\n  t.plan(1);\n  const opts = {\n    schema: {\n      headers: {\n        type: 'object',\n        properties: {\n          'content-type': {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => ajv.compile(schema));\n  t.equal(typeof opts[symbols.headersSchema], 'function');\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - headers are lowercase","suites":[],"updatePoint":{"line":302,"column":42,"index":6753},"line":302,"code":"test('build schema - headers are lowercase', t => {\n  t.plan(1);\n  const opts = {\n    schema: {\n      headers: {\n        type: 'object',\n        properties: {\n          'Content-Type': {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    t.ok(schema.properties['content-type'], 'lowercase content-type exists');\n    return () => {};\n  });\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - headers are not lowercased in case of custom object","suites":[],"updatePoint":{"line":326,"column":72,"index":7253},"line":326,"code":"test('build schema - headers are not lowercased in case of custom object', t => {\n  t.plan(1);\n\n  class Headers {}\n\n  const opts = {\n    schema: {\n      headers: new Headers()\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    t.type(schema, Headers);\n    return () => {};\n  });\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"build schema - uppercased headers are not included","suites":[],"updatePoint":{"line":346,"column":56,"index":7590},"line":346,"code":"test('build schema - uppercased headers are not included', t => {\n  t.plan(1);\n  const opts = {\n    schema: {\n      headers: {\n        type: 'object',\n        properties: {\n          'Content-Type': {\n            type: 'string'\n          }\n        }\n      }\n    }\n  };\n  validation.compileSchemasForValidation(opts, ({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    t.notOk('Content-Type' in schema.properties, 'uppercase does not exist');\n    return () => {};\n  });\n});","file":"internals/validation.test.js","skipped":false,"dir":"test"},{"name":"should be the same as package.json","suites":[],"updatePoint":{"line":13,"column":40,"index":200},"line":13,"code":"test('should be the same as package.json', t => {\n  t.plan(1);\n  const json = JSON.parse(fs.readFileSync(path.join(__dirname, '..', '..', 'package.json')).toString('utf8'));\n  t.equal(fastify.version, json.version);\n});","file":"internals/version.test.js","skipped":false,"dir":"test"},{"name":"keepAliveTimeout","suites":[],"updatePoint":{"line":10,"column":22,"index":149},"line":10,"code":"test('keepAliveTimeout', t => {\n  t.plan(6);\n\n  try {\n    Fastify({\n      keepAliveTimeout: 1.3\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  try {\n    Fastify({\n      keepAliveTimeout: []\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  const httpServer = Fastify({\n    keepAliveTimeout: 1\n  }).server;\n  t.equal(httpServer.keepAliveTimeout, 1);\n  const httpsServer = Fastify({\n    keepAliveTimeout: 2,\n    https: {}\n  }).server;\n  t.equal(httpsServer.keepAliveTimeout, 2);\n  const http2Server = Fastify({\n    keepAliveTimeout: 3,\n    http2: true\n  }).server;\n  t.not(http2Server.keepAliveTimeout, 3);\n\n  const serverFactory = (handler, _) => {\n    const server = http.createServer((req, res) => {\n      handler(req, res);\n    });\n    server.keepAliveTimeout = 5;\n    return server;\n  };\n\n  const customServer = Fastify({\n    keepAliveTimeout: 4,\n    serverFactory\n  }).server;\n  t.equal(customServer.keepAliveTimeout, 5);\n});","file":"keepAliveTimeout.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a callback","suites":[],"updatePoint":{"line":30,"column":31,"index":516},"line":30,"code":"test('listen accepts a callback', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(err => {\n    t.equal(fastify.server.address().address, localhost);\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port and a callback","suites":[],"updatePoint":{"line":39,"column":42,"index":765},"line":39,"code":"test('listen accepts a port and a callback', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.equal(fastify.server.address().address, localhost);\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port and a callback with (err, address)","suites":[],"updatePoint":{"line":48,"column":62,"index":1037},"line":48,"code":"test('listen accepts a port and a callback with (err, address)', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, (err, address) => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port, address, and callback","suites":[],"updatePoint":{"line":57,"column":50,"index":1334},"line":57,"code":"test('listen accepts a port, address, and callback', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, localhost, err => {\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts options and a callback","suites":[],"updatePoint":{"line":65,"column":43,"index":1540},"line":65,"code":"test('listen accepts options and a callback', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen({\n    port: 0,\n    host: 'localhost',\n    backlog: 511,\n    exclusive: false,\n    readableAll: false,\n    writableAll: false,\n    ipv6Only: false\n  }, err => {\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts options, backlog and a callback","suites":[],"updatePoint":{"line":81,"column":52,"index":1892},"line":81,"code":"test('listen accepts options, backlog and a callback', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen({\n    port: 0,\n    host: 'localhost'\n  }, 511, err => {\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port, address and a callback with (err, address)","suites":[],"updatePoint":{"line":92,"column":71,"index":2159},"line":92,"code":"test('listen accepts a port, address and a callback with (err, address)', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, localhost, (err, address) => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port, address, backlog and callback","suites":[],"updatePoint":{"line":101,"column":58,"index":2475},"line":101,"code":"test('listen accepts a port, address, backlog and callback', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, localhost, 511, err => {\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen accepts a port, address, backlog and callback with (err, address)","suites":[],"updatePoint":{"line":109,"column":78,"index":2721},"line":109,"code":"test('listen accepts a port, address, backlog and callback with (err, address)', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, localhost, 511, (err, address) => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n    t.error(err);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen after Promise.resolve()","suites":[],"updatePoint":{"line":118,"column":36,"index":3020},"line":118,"code":"test('listen after Promise.resolve()', t => {\n  t.plan(2);\n  const f = Fastify();\n  t.teardown(f.close.bind(f));\n  Promise.resolve().then(() => {\n    f.listen(0, (err, address) => {\n      f.server.unref();\n      t.equal(address, `http://${localhostForURL}:${f.server.address().port}`);\n      t.error(err);\n    });\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"register after listen using Promise.resolve()","suites":[],"updatePoint":{"line":130,"column":51,"index":3359},"line":130,"code":"test('register after listen using Promise.resolve()', t => {\n  t.plan(1);\n  const f = Fastify();\n\n  const handler = (req, res) => res.send({});\n\n  Promise.resolve().then(() => {\n    f.get('/', handler);\n    f.register((f2, options, done) => {\n      f2.get('/plugin', handler);\n      done();\n    });\n    return f.ready();\n  }).catch(t.error).then(() => t.pass('resolved'));\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"double listen errors","suites":[],"updatePoint":{"line":145,"column":26,"index":3711},"line":145,"code":"test('double listen errors', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.listen(fastify.server.address().port, (err, address) => {\n      t.equal(address, null);\n      t.ok(err);\n    });\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"double listen errors callback with (err, address)","suites":[],"updatePoint":{"line":157,"column":55,"index":4043},"line":157,"code":"test('double listen errors callback with (err, address)', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, (err1, address1) => {\n    t.equal(address1, `http://${localhostForURL}:${fastify.server.address().port}`);\n    t.error(err1);\n    fastify.listen(fastify.server.address().port, (err2, address2) => {\n      t.equal(address2, null);\n      t.ok(err2);\n    });\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen twice on the same port","suites":[],"updatePoint":{"line":170,"column":35,"index":4458},"line":170,"code":"test('listen twice on the same port', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, (err1, address1) => {\n    t.equal(address1, `http://${localhostForURL}:${fastify.server.address().port}`);\n    t.error(err1);\n    const s2 = Fastify();\n    t.teardown(s2.close.bind(s2));\n    s2.listen(fastify.server.address().port, (err2, address2) => {\n      t.equal(address2, null);\n      t.ok(err2);\n    });\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen twice on the same port callback with (err, address)","suites":[],"updatePoint":{"line":185,"column":64,"index":4958},"line":185,"code":"test('listen twice on the same port callback with (err, address)', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, (err1, address1) => {\n    const _port = fastify.server.address().port;\n    t.equal(address1, `http://${localhostForURL}:${_port}`);\n    t.error(err1);\n    const s2 = Fastify();\n    t.teardown(s2.close.bind(s2));\n    s2.listen(_port, (err2, address2) => {\n      t.equal(address2, null);\n      t.ok(err2);\n    });\n  });\n}); // https://nodejs.org/api/net.html#net_ipc_support","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen on socket","suites":[],"updatePoint":{"line":203,"column":24,"index":5504},"line":203,"code":"  test('listen on socket', t => {\n    t.plan(3);\n    const fastify = Fastify();\n    t.teardown(fastify.close.bind(fastify));\n    const sockFile = path.join(os.tmpdir(), `${(Math.random().toString(16) + '0000000').substr(2, 8)}-server.sock`);\n\n    try {\n      fs.unlinkSync(sockFile);\n    } catch (e) {}\n\n    fastify.listen(sockFile, (err, address) => {\n      t.error(err);\n      t.equal(sockFile, fastify.server.address());\n      t.equal(address, sockFile);\n    });\n  });","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen without callback (port zero)","suites":[],"updatePoint":{"line":221,"column":41,"index":5996},"line":221,"code":"test('listen without callback (port zero)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(() => {\n    t.equal(fastify.server.address().address, localhost);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen without callback (port not given)","suites":[],"updatePoint":{"line":229,"column":46,"index":6238},"line":229,"code":"test('listen without callback (port not given)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen().then(() => {\n    t.equal(fastify.server.address().address, localhost);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen null without callback with (address)","suites":[],"updatePoint":{"line":237,"column":49,"index":6482},"line":237,"code":"test('listen null without callback with (address)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(null).then(address => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen without port without callback with (address)","suites":[],"updatePoint":{"line":245,"column":57,"index":6769},"line":245,"code":"test('listen without port without callback with (address)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen().then(address => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen with undefined without callback with (address)","suites":[],"updatePoint":{"line":253,"column":59,"index":7054},"line":253,"code":"test('listen with undefined without callback with (address)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(undefined).then(address => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen without callback with (address)","suites":[],"updatePoint":{"line":261,"column":44,"index":7333},"line":261,"code":"test('listen without callback with (address)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(address => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"double listen without callback rejects","suites":[],"updatePoint":{"line":269,"column":44,"index":7604},"line":269,"code":"test('double listen without callback rejects', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(() => {\n    fastify.listen(0).catch(err => {\n      t.ok(err);\n    });\n  }).catch(err => t.error(err));\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"double listen without callback with (address)","suites":[],"updatePoint":{"line":279,"column":51,"index":7882},"line":279,"code":"test('double listen without callback with (address)', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(address => {\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n    fastify.listen(0).catch(err => {\n      t.ok(err);\n    });\n  }).catch(err => t.error(err));\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen twice on the same port without callback rejects","suites":[],"updatePoint":{"line":290,"column":60,"index":8258},"line":290,"code":"test('listen twice on the same port without callback rejects', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(() => {\n    const s2 = Fastify();\n    t.teardown(s2.close.bind(s2));\n    s2.listen(fastify.server.address().port).catch(err => {\n      t.ok(err);\n    });\n  }).catch(err => t.error(err));\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen twice on the same port without callback rejects with (address)","suites":[],"updatePoint":{"line":302,"column":75,"index":8644},"line":302,"code":"test('listen twice on the same port without callback rejects with (address)', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0).then(address => {\n    const s2 = Fastify();\n    t.teardown(s2.close.bind(s2));\n    t.equal(address, `http://${localhostForURL}:${fastify.server.address().port}`);\n    s2.listen(fastify.server.address().port).catch(err => {\n      t.ok(err);\n    });\n  }).catch(err => t.error(err));\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen on invalid port without callback rejects","suites":[],"updatePoint":{"line":315,"column":53,"index":9097},"line":315,"code":"test('listen on invalid port without callback rejects', t => {\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  return fastify.listen(-1).catch(err => {\n    t.ok(err);\n    return true;\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen logs the port as info","suites":[],"updatePoint":{"line":323,"column":34,"index":9298},"line":323,"code":"test('listen logs the port as info', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  const msgs = [];\n\n  fastify.log.info = function (msg) {\n    msgs.push(msg);\n  };\n\n  fastify.listen(0).then(() => {\n    t.ok(/http:\\/\\//.test(msgs[0]));\n  });\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen when firstArg is string(pipe) and without backlog","suites":[],"updatePoint":{"line":337,"column":62,"index":9619},"line":337,"code":"test('listen when firstArg is string(pipe) and without backlog', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  const address = await fastify.listen('\\\\\\\\.\\\\pipe\\\\testPipe');\n  t.equal(address, '\\\\\\\\.\\\\pipe\\\\testPipe');\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"listen when firstArg is string(pipe) and with backlog","suites":[],"updatePoint":{"line":344,"column":59,"index":9893},"line":344,"code":"test('listen when firstArg is string(pipe) and with backlog', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  const address = await fastify.listen('\\\\\\\\.\\\\pipe\\\\testPipe', 511);\n  t.equal(address, '\\\\\\\\.\\\\pipe\\\\testPipe');\n});","file":"listen.test.js","skipped":false,"dir":"test"},{"name":"defaults to info level","suites":[],"updatePoint":{"line":44,"column":28,"index":720},"line":44,"code":"test('defaults to info level', t => {\n  t.plan(13);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.get('/', function (req, reply) {\n    t.ok(req.log);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  stream.once('data', listenAtLogLine => {\n    t.ok(listenAtLogLine, 'listen at log message is ok');\n    stream.once('data', line => {\n      const id = line.reqId;\n      t.ok(line.reqId, 'reqId is defined');\n      t.ok(line.req, 'req is defined');\n      t.equal(line.msg, 'incoming request', 'message is set');\n      t.equal(line.req.method, 'GET', 'method is get');\n      stream.once('data', line => {\n        t.equal(line.reqId, id);\n        t.ok(line.reqId, 'reqId is defined');\n        t.ok(line.res, 'res is defined');\n        t.equal(line.msg, 'request completed', 'message is set');\n        t.equal(line.res.statusCode, 200, 'statusCode is 200');\n        t.ok(line.responseTime, 'responseTime is defined');\n      });\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port);\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"test log stream","suites":[],"updatePoint":{"line":89,"column":21,"index":1942},"line":89,"code":"test('test log stream', t => {\n  t.plan(12);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.get('/', function (req, reply) {\n    t.ok(req.log);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port);\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        const id = line.reqId;\n        t.ok(line.reqId, 'reqId is defined');\n        t.ok(line.req, 'req is defined');\n        t.equal(line.msg, 'incoming request', 'message is set');\n        t.equal(line.req.method, 'GET', 'method is get');\n        stream.once('data', line => {\n          t.equal(line.reqId, id);\n          t.ok(line.reqId, 'reqId is defined');\n          t.ok(line.res, 'res is defined');\n          t.equal(line.msg, 'request completed', 'message is set');\n          t.equal(line.res.statusCode, 200, 'statusCode is 200');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"test error log stream","suites":[],"updatePoint":{"line":134,"column":27,"index":3167},"line":134,"code":"test('test error log stream', t => {\n  t.plan(11);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  fastify.get('/error', function (req, reply) {\n    t.ok(req.log);\n    reply.send(new Error('kaboom'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/error');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.ok(line.reqId, 'reqId is defined');\n        t.ok(line.req, 'req is defined');\n        t.equal(line.msg, 'incoming request', 'message is set');\n        t.equal(line.req.method, 'GET', 'method is get');\n        stream.once('data', line => {\n          t.ok(line.reqId, 'reqId is defined');\n          t.ok(line.res, 'res is defined');\n          t.equal(line.msg, 'kaboom', 'message is set');\n          t.equal(line.res.statusCode, 500, 'statusCode is 500');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"can use external logger instance","suites":[],"updatePoint":{"line":175,"column":38,"index":4333},"line":175,"code":"test('can use external logger instance', t => {\n  const lines = [/^Server listening at /, /^incoming request$/, /^log success$/, /^request completed$/];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    const regex = lines.shift();\n    t.ok(regex.test(line.msg), '\"' + line.msg + '\" dont match \"' + regex + '\"');\n  });\n\n  const logger = require('pino')(splitStream);\n\n  const localFastify = Fastify({\n    logger\n  });\n  localFastify.get('/foo', function (req, reply) {\n    t.ok(req.log);\n    req.log.info('log success');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  localFastify.listen(0, err => {\n    t.error(err);\n    http.get('http://localhost:' + localFastify.server.address().port + '/foo', res => {\n      res.resume();\n      res.on('end', () => {\n        localFastify.server.close();\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"can use external logger instance with custom serializer","suites":[],"updatePoint":{"line":206,"column":61,"index":5241},"line":206,"code":"test('can use external logger instance with custom serializer', t => {\n  const lines = [['level', 30], ['req', {\n    url: '/foo'\n  }], ['level', 30], ['res', {\n    statusCode: 200\n  }]];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    const check = lines.shift();\n    const key = check[0];\n    const value = check[1];\n    t.same(line[key], value);\n  });\n\n  const logger = require('pino')({\n    level: 'info',\n    serializers: {\n      req: function (req) {\n        return {\n          url: req.url\n        };\n      }\n    }\n  }, splitStream);\n\n  const localFastify = Fastify({\n    logger\n  });\n  localFastify.get('/foo', function (req, reply) {\n    t.ok(req.log);\n    req.log.info('log success');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  localFastify.listen(0, err => {\n    t.error(err);\n    http.get('http://localhost:' + localFastify.server.address().port + '/foo', res => {\n      res.resume();\n      res.on('end', () => {\n        localFastify.server.close();\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"expose the logger","suites":[],"updatePoint":{"line":252,"column":23,"index":6263},"line":252,"code":"test('expose the logger', t => {\n  t.plan(2);\n  let fastify = null;\n  const stream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  t.ok(fastify.log);\n  t.same(typeof fastify.log, 'object');\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"The request id header key can be customized","suites":[],"updatePoint":{"line":271,"column":49,"index":6596},"line":271,"code":"test('The request id header key can be customized', t => {\n  t.plan(9);\n  const REQUEST_ID = '42';\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    },\n    requestIdHeader: 'my-custom-request-id'\n  });\n  t.teardown(() => fastify.close());\n  fastify.get('/', (req, reply) => {\n    t.equal(req.id, REQUEST_ID);\n    req.log.info('some log message');\n    reply.send({\n      id: req.id\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'my-custom-request-id': REQUEST_ID\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.equal(payload.id, REQUEST_ID);\n    stream.once('data', line => {\n      t.equal(line.reqId, REQUEST_ID);\n      t.equal(line.msg, 'incoming request', 'message is set');\n      stream.once('data', line => {\n        t.equal(line.reqId, REQUEST_ID);\n        t.equal(line.msg, 'some log message', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.reqId, REQUEST_ID);\n          t.equal(line.msg, 'request completed', 'message is set');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"The request id header key can be customized along with a custom id generator","suites":[],"updatePoint":{"line":314,"column":82,"index":7792},"line":314,"code":"test('The request id header key can be customized along with a custom id generator', t => {\n  t.plan(12);\n  const REQUEST_ID = '42';\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    },\n    requestIdHeader: 'my-custom-request-id',\n\n    genReqId(req) {\n      return 'foo';\n    }\n\n  });\n  t.teardown(() => fastify.close());\n  fastify.get('/one', (req, reply) => {\n    t.equal(req.id, REQUEST_ID);\n    req.log.info('some log message');\n    reply.send({\n      id: req.id\n    });\n  });\n  fastify.get('/two', (req, reply) => {\n    t.equal(req.id, 'foo');\n    req.log.info('some log message 2');\n    reply.send({\n      id: req.id\n    });\n  });\n  const matches = [{\n    reqId: REQUEST_ID,\n    msg: /incoming request/\n  }, {\n    reqId: REQUEST_ID,\n    msg: /some log message/\n  }, {\n    reqId: REQUEST_ID,\n    msg: /request completed/\n  }, {\n    reqId: 'foo',\n    msg: /incoming request/\n  }, {\n    reqId: 'foo',\n    msg: /some log message 2/\n  }, {\n    reqId: 'foo',\n    msg: /request completed/\n  }];\n  let i = 0;\n  stream.on('data', line => {\n    t.match(line, matches[i]);\n    i += 1;\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/one',\n    headers: {\n      'my-custom-request-id': REQUEST_ID\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.equal(payload.id, REQUEST_ID);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/two'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.equal(payload.id, 'foo');\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"The request id log label can be changed","suites":[],"updatePoint":{"line":389,"column":45,"index":9331},"line":389,"code":"test('The request id log label can be changed', t => {\n  t.plan(6);\n  const REQUEST_ID = '42';\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    },\n    requestIdHeader: 'my-custom-request-id',\n    requestIdLogLabel: 'traceId'\n  });\n  t.teardown(() => fastify.close());\n  fastify.get('/one', (req, reply) => {\n    t.equal(req.id, REQUEST_ID);\n    req.log.info('some log message');\n    reply.send({\n      id: req.id\n    });\n  });\n  const matches = [{\n    traceId: REQUEST_ID,\n    msg: /incoming request/\n  }, {\n    traceId: REQUEST_ID,\n    msg: /some log message/\n  }, {\n    traceId: REQUEST_ID,\n    msg: /request completed/\n  }];\n  let i = 0;\n  stream.on('data', line => {\n    t.match(line, matches[i]);\n    i += 1;\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/one',\n    headers: {\n      'my-custom-request-id': REQUEST_ID\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.equal(payload.id, REQUEST_ID);\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"The logger should accept custom serializer","suites":[],"updatePoint":{"line":436,"column":48,"index":10369},"line":436,"code":"test('The logger should accept custom serializer', t => {\n  t.plan(9);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info',\n      serializers: {\n        req: function (req) {\n          return {\n            url: req.url\n          };\n        }\n      }\n    }\n  });\n  fastify.get('/custom', function (req, reply) {\n    t.ok(req.log);\n    reply.send(new Error('kaboom'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/custom');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.ok(line.req, 'req is defined');\n        t.equal(line.msg, 'incoming request', 'message is set');\n        t.same(line.req, {\n          url: '/custom'\n        }, 'custom req serializer is use');\n        stream.once('data', line => {\n          t.ok(line.res, 'res is defined');\n          t.equal(line.msg, 'kaboom', 'message is set');\n          t.same(line.res, {\n            statusCode: 500\n          }, 'default res serializer is use');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"reply.send logs an error if called twice in a row","suites":[],"updatePoint":{"line":479,"column":55,"index":11590},"line":479,"code":"test('reply.send logs an error if called twice in a row', t => {\n  const lines = ['incoming request', 'request completed', 'Reply already sent', 'Reply already sent'];\n  t.plan(lines.length + 2);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, lines.shift());\n  });\n  const logger = pino(splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n    reply.send({\n      hello: 'world2'\n    });\n    reply.send({\n      hello: 'world3'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"logger can be silented","suites":[],"updatePoint":{"line":512,"column":28,"index":12338},"line":512,"code":"test('logger can be silented', t => {\n  t.plan(17);\n  const fastify = Fastify({\n    logger: false\n  });\n  t.ok(fastify.log);\n  t.same(typeof fastify.log, 'object');\n  t.same(typeof fastify.log.fatal, 'function');\n  t.same(typeof fastify.log.error, 'function');\n  t.same(typeof fastify.log.warn, 'function');\n  t.same(typeof fastify.log.info, 'function');\n  t.same(typeof fastify.log.debug, 'function');\n  t.same(typeof fastify.log.trace, 'function');\n  t.same(typeof fastify.log.child, 'function');\n  const childLog = fastify.log.child();\n  t.same(typeof childLog, 'object');\n  t.same(typeof childLog.fatal, 'function');\n  t.same(typeof childLog.error, 'function');\n  t.same(typeof childLog.warn, 'function');\n  t.same(typeof childLog.info, 'function');\n  t.same(typeof childLog.debug, 'function');\n  t.same(typeof childLog.trace, 'function');\n  t.same(typeof childLog.child, 'function');\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set a custom logLevel for a plugin","suites":[],"updatePoint":{"line":536,"column":47,"index":13250},"line":536,"code":"test('Should set a custom logLevel for a plugin', t => {\n  const lines = ['incoming request', 'Hello', 'request completed'];\n  t.plan(7);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, lines.shift());\n  });\n  const logger = pino({\n    level: 'error'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', (req, reply) => {\n    req.log.info('Hello'); // we should not see this log\n\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/plugin', (req, reply) => {\n      req.log.info('Hello'); // we should see this log\n\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logLevel: 'info'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/plugin'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set a custom logSerializers for a plugin","suites":[],"updatePoint":{"line":589,"column":53,"index":14422},"line":589,"code":"test('Should set a custom logSerializers for a plugin', t => {\n  t.plan(3);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, 'XHello');\n    }\n  });\n  const logger = pino({\n    level: 'error'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/plugin', (req, reply) => {\n      req.log.info({\n        test: 'Hello'\n      }); // we should see this log\n\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logLevel: 'info',\n    logSerializers: {\n      test: value => 'X' + value\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/plugin'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set a custom logLevel for every plugin","suites":[],"updatePoint":{"line":631,"column":51,"index":15296},"line":631,"code":"test('Should set a custom logLevel for every plugin', t => {\n  const lines = ['incoming request', 'request completed', 'info', 'debug'];\n  t.plan(18);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.ok(line.level === 30 || line.level === 20);\n    t.ok(lines.indexOf(line.msg) > -1);\n  });\n  const logger = pino({\n    level: 'error'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', (req, reply) => {\n    req.log.warn('Hello'); // we should not see this log\n\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/info', (req, reply) => {\n      req.log.info('info'); // we should see this log\n\n      req.log.debug('hidden log');\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logLevel: 'info'\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/debug', (req, reply) => {\n      req.log.debug('debug'); // we should see this log\n\n      req.log.trace('hidden log');\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logLevel: 'debug'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/info'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/debug'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set a custom logSerializers for every plugin","suites":[],"updatePoint":{"line":709,"column":57,"index":17058},"line":709,"code":"test('Should set a custom logSerializers for every plugin', async t => {\n  const lines = ['Hello', 'XHello', 'ZHello'];\n  t.plan(6);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, lines.shift());\n    }\n  });\n  const logger = pino({\n    level: 'info'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', (req, reply) => {\n    req.log.warn({\n      test: 'Hello'\n    });\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/test1', (req, reply) => {\n      req.log.info({\n        test: 'Hello'\n      });\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logSerializers: {\n      test: value => 'X' + value\n    }\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/test2', (req, reply) => {\n      req.log.info({\n        test: 'Hello'\n      });\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logSerializers: {\n      test: value => 'Z' + value\n    }\n  });\n  let res = await fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n  t.same(res.json(), {\n    hello: 'world'\n  });\n  res = await fastify.inject({\n    method: 'GET',\n    url: '/test1'\n  });\n  t.same(res.json(), {\n    hello: 'world'\n  });\n  res = await fastify.inject({\n    method: 'GET',\n    url: '/test2'\n  });\n  t.same(res.json(), {\n    hello: 'world'\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should override serializers from route","suites":[],"updatePoint":{"line":784,"column":44,"index":18532},"line":784,"code":"test('Should override serializers from route', t => {\n  t.plan(3);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, 'ZHello');\n    }\n  });\n  const logger = pino({\n    level: 'info'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/', {\n      logSerializers: {\n        test: value => 'Z' + value // should override\n\n      }\n    }, (req, reply) => {\n      req.log.info({\n        test: 'Hello'\n      });\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logSerializers: {\n      test: value => 'X' + value\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should override serializers from plugin","suites":[],"updatePoint":{"line":829,"column":45,"index":19434},"line":829,"code":"test('Should override serializers from plugin', t => {\n  t.plan(3);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, 'ZHello');\n    }\n  });\n  const logger = pino({\n    level: 'info'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.register(context1, {\n      logSerializers: {\n        test: value => 'Z' + value // should override\n\n      }\n    });\n    done();\n  }, {\n    logSerializers: {\n      test: value => 'X' + value\n    }\n  });\n\n  function context1(instance, opts, done) {\n    instance.get('/', (req, reply) => {\n      req.log.info({\n        test: 'Hello'\n      });\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }\n\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should use serializers from plugin and route","suites":[],"updatePoint":{"line":880,"column":50,"index":20436},"line":880,"code":"test('Should use serializers from plugin and route', t => {\n  t.plan(4);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, 'XHello');\n    }\n\n    if (line.test2) {\n      t.same(line.test2, 'ZHello');\n    }\n  });\n  const logger = pino({\n    level: 'info'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(context1, {\n    logSerializers: {\n      test: value => 'X' + value\n    }\n  });\n\n  function context1(instance, opts, done) {\n    instance.get('/', {\n      logSerializers: {\n        test2: value => 'Z' + value\n      }\n    }, (req, reply) => {\n      req.log.info({\n        test: 'Hello',\n        test2: 'Hello'\n      }); // { test: 'XHello', test2: 'ZHello' }\n\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }\n\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should use serializers from instance fastify and route","suites":[],"updatePoint":{"line":933,"column":60,"index":21484},"line":933,"code":"test('Should use serializers from instance fastify and route', t => {\n  t.plan(4);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test) {\n      t.same(line.test, 'XHello');\n    }\n\n    if (line.test2) {\n      t.same(line.test2, 'ZHello');\n    }\n  });\n  const logger = pino({\n    level: 'info',\n    serializers: {\n      test: value => 'X' + value,\n      test2: value => 'This should be override - ' + value\n    }\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/', {\n    logSerializers: {\n      test2: value => 'Z' + value\n    }\n  }, (req, reply) => {\n    req.log.info({\n      test: 'Hello',\n      test2: 'Hello'\n    }); // { test: 'XHello', test2: 'ZHello' }\n\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should use serializers inherit from contexts","suites":[],"updatePoint":{"line":980,"column":50,"index":22454},"line":980,"code":"test('Should use serializers inherit from contexts', t => {\n  t.plan(5);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    if (line.test && line.test2 && line.test3) {\n      t.same(line.test, 'XHello');\n      t.same(line.test2, 'YHello');\n      t.same(line.test3, 'ZHello');\n    }\n  });\n  const logger = pino({\n    level: 'info',\n    serializers: {\n      test: value => 'X' + value\n    }\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(context1, {\n    logSerializers: {\n      test2: value => 'Y' + value\n    }\n  });\n\n  function context1(instance, opts, done) {\n    instance.get('/', {\n      logSerializers: {\n        test3: value => 'Z' + value\n      }\n    }, (req, reply) => {\n      req.log.info({\n        test: 'Hello',\n        test2: 'Hello',\n        test3: 'Hello'\n      }); // { test: 'XHello', test2: 'YHello', test3: 'ZHello' }\n\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }\n\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should increase the log level for a specific plugin","suites":[],"updatePoint":{"line":1035,"column":57,"index":23635},"line":1035,"code":"test('Should increase the log level for a specific plugin', t => {\n  t.plan(4);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, 'Hello');\n    t.ok(line.level === 50);\n  });\n  const logger = pino({\n    level: 'info'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/', (req, reply) => {\n      req.log.error('Hello'); // we should see this log\n\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    logLevel: 'error'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set the log level for the customized 404 handler","suites":[],"updatePoint":{"line":1071,"column":61,"index":24420},"line":1071,"code":"test('Should set the log level for the customized 404 handler', t => {\n  t.plan(4);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, 'Hello');\n    t.ok(line.level === 50);\n  });\n  const logger = pino({\n    level: 'warn'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.setNotFoundHandler(function (req, reply) {\n      req.log.error('Hello');\n      reply.code(404).send();\n    });\n    done();\n  }, {\n    logLevel: 'error'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set the log level for the customized 500 handler","suites":[],"updatePoint":{"line":1101,"column":61,"index":25110},"line":1101,"code":"test('Should set the log level for the customized 500 handler', t => {\n  t.plan(4);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, 'Hello');\n    t.ok(line.level === 60);\n  });\n  const logger = pino({\n    level: 'warn'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.get('/', (req, reply) => {\n      req.log.error('kaboom');\n      reply.send(new Error('kaboom'));\n    });\n    instance.setErrorHandler(function (e, request, reply) {\n      reply.log.fatal('Hello');\n      reply.code(500).send();\n    });\n    done();\n  }, {\n    logLevel: 'fatal'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Should set a custom log level for a specific route","suites":[],"updatePoint":{"line":1135,"column":56,"index":25919},"line":1135,"code":"test('Should set a custom log level for a specific route', t => {\n  const lines = ['incoming request', 'Hello', 'request completed'];\n  t.plan(7);\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, lines.shift());\n  });\n  const logger = pino({\n    level: 'error'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.get('/log', {\n    logLevel: 'info'\n  }, (req, reply) => {\n    req.log.info('Hello');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.get('/no-log', (req, reply) => {\n    req.log.info('Hello');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/log'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/no-log'\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"The default 404 handler logs the incoming request","suites":[],"updatePoint":{"line":1183,"column":55,"index":26957},"line":1183,"code":"test('The default 404 handler logs the incoming request', t => {\n  t.plan(5);\n  const expectedMessages = ['incoming request', 'Route GET:/not-found not found', 'request completed'];\n  const splitStream = split(JSON.parse);\n  splitStream.on('data', line => {\n    t.same(line.msg, expectedMessages.shift());\n  });\n  const logger = pino({\n    level: 'trace'\n  }, splitStream);\n  const fastify = Fastify({\n    logger\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/not-found'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should serialize request and response","suites":[],"updatePoint":{"line":1204,"column":43,"index":27507},"line":1204,"code":"test('should serialize request and response', t => {\n  t.plan(3);\n  const lines = [];\n  const dest = new stream.Writable({\n    write: function (chunk, enc, cb) {\n      lines.push(JSON.parse(chunk));\n      cb();\n    }\n  });\n  const fastify = Fastify({\n    logger: {\n      level: 'info',\n      stream: dest\n    }\n  });\n  fastify.get('/500', (req, reply) => {\n    reply.code(500).send(Error('500 error'));\n  });\n  fastify.inject({\n    url: '/500',\n    method: 'GET'\n  }, (e, res) => {\n    const l = lines.find(line => line.res && line.res.statusCode === 500);\n    t.ok(l.req);\n    t.same(l.req.method, 'GET');\n    t.same(l.req.url, '/500');\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Wrap IPv6 address in listening log message","suites":[],"updatePoint":{"line":1237,"column":52,"index":28470},"line":1237,"code":"    test('Wrap IPv6 address in listening log message', t => {\n      t.plan(2);\n      const stream = split(JSON.parse);\n      const fastify = Fastify({\n        logger: {\n          stream,\n          level: 'info'\n        }\n      });\n      fastify.listen(0, ipv6, err => {\n        t.error(err);\n        stream.once('data', line => {\n          const expected = 'Server listening at http://[' + ipv6 + ']:' + fastify.server.address().port;\n          t.same(line.msg, expected);\n          fastify.close();\n        });\n      });\n    });","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"Do not wrap IPv4 address","suites":[],"updatePoint":{"line":1257,"column":30,"index":28984},"line":1257,"code":"test('Do not wrap IPv4 address', t => {\n  t.plan(2);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.listen(0, '127.0.0.1', err => {\n    t.error(err);\n    stream.once('data', line => {\n      const expected = 'Server listening at http://127.0.0.1:' + fastify.server.address().port;\n      t.same(line.msg, expected);\n      fastify.close();\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"file option","suites":[],"updatePoint":{"line":1275,"column":17,"index":29413},"line":1275,"code":"test('file option', t => {\n  t.plan(13);\n  let fastify = null;\n  const dest = file();\n  fastify = Fastify({\n    logger: {\n      file: dest\n    }\n  });\n  fastify.get('/', function (req, reply) {\n    t.ok(req.log);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port, () => {\n      const stream = fs.createReadStream(dest).pipe(split(JSON.parse));\n      stream.once('data', listenAtLogLine => {\n        t.ok(listenAtLogLine, 'listen at log message is ok');\n        stream.once('data', line => {\n          const id = line.reqId;\n          t.ok(line.reqId, 'reqId is defined');\n          t.ok(line.req, 'req is defined');\n          t.equal(line.msg, 'incoming request', 'message is set');\n          t.equal(line.req.method, 'GET', 'method is get');\n          stream.once('data', line => {\n            t.equal(line.reqId, id);\n            t.ok(line.reqId, 'reqId is defined');\n            t.ok(line.res, 'res is defined');\n            t.equal(line.msg, 'request completed', 'message is set');\n            t.equal(line.res.statusCode, 200, 'statusCode is 200');\n            t.ok(line.responseTime, 'responseTime is defined');\n            stream.resume();\n          });\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should log the error if no error handler is defined","suites":[],"updatePoint":{"line":1317,"column":57,"index":30796},"line":1317,"code":"test('should log the error if no error handler is defined', t => {\n  t.plan(8);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/error', function (req, reply) {\n    t.ok(req.log);\n    reply.send(new Error('a generic error'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/error');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.equal(line.msg, 'incoming request', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.level, 50, 'level is correct');\n          t.equal(line.msg, 'a generic error', 'message is set');\n          stream.once('data', line => {\n            t.equal(line.msg, 'request completed', 'message is set');\n            t.same(line.res, {\n              statusCode: 500\n            }, 'status code is set');\n          });\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should log as info if error status code >= 400 and < 500 if no error handler is defined","suites":[],"updatePoint":{"line":1352,"column":93,"index":31936},"line":1352,"code":"test('should log as info if error status code >= 400 and < 500 if no error handler is defined', t => {\n  t.plan(8);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/400', function (req, reply) {\n    t.ok(req.log);\n    reply.send(Object.assign(new Error('a 400 error'), {\n      statusCode: 400\n    }));\n  });\n  fastify.get('/503', function (req, reply) {\n    t.ok(req.log);\n    reply.send(Object.assign(new Error('a 503 error'), {\n      statusCode: 503\n    }));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/400');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.equal(line.msg, 'incoming request', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.level, 30, 'level is correct');\n          t.equal(line.msg, 'a 400 error', 'message is set');\n          stream.once('data', line => {\n            t.equal(line.msg, 'request completed', 'message is set');\n            t.same(line.res, {\n              statusCode: 400\n            }, 'status code is set');\n          });\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should log as error if error status code >= 500 if no error handler is defined","suites":[],"updatePoint":{"line":1395,"column":84,"index":33260},"line":1395,"code":"test('should log as error if error status code >= 500 if no error handler is defined', t => {\n  t.plan(8);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/503', function (req, reply) {\n    t.ok(req.log);\n    reply.send(Object.assign(new Error('a 503 error'), {\n      statusCode: 503\n    }));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/503');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.equal(line.msg, 'incoming request', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.level, 50, 'level is correct');\n          t.equal(line.msg, 'a 503 error', 'message is set');\n          stream.once('data', line => {\n            t.equal(line.msg, 'request completed', 'message is set');\n            t.same(line.res, {\n              statusCode: 503\n            }, 'status code is set');\n          });\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should not log the error if error handler is defined","suites":[],"updatePoint":{"line":1432,"column":58,"index":34399},"line":1432,"code":"test('should not log the error if error handler is defined', t => {\n  t.plan(7);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/error', function (req, reply) {\n    t.ok(req.log);\n    reply.send(new Error('something happened'));\n  });\n  fastify.setErrorHandler((err, req, reply) => {\n    reply.send(err);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/error');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.equal(line.msg, 'incoming request', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.level, 30, 'level is correct');\n          t.equal(line.msg, 'request completed', 'message is set');\n          t.same(line.res, {\n            statusCode: 500\n          }, 'status code is set');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should not rely on raw request to log errors","suites":[],"updatePoint":{"line":1467,"column":50,"index":35447},"line":1467,"code":"test('should not rely on raw request to log errors', t => {\n  t.plan(7);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/error', function (req, reply) {\n    t.ok(req.log);\n    reply.status(415).send(new Error('something happened'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get('http://localhost:' + fastify.server.address().port + '/error');\n    stream.once('data', listenAtLogLine => {\n      t.ok(listenAtLogLine, 'listen at log message is ok');\n      stream.once('data', line => {\n        t.equal(line.msg, 'incoming request', 'message is set');\n        stream.once('data', line => {\n          t.equal(line.level, 30, 'level is correct');\n          t.equal(line.msg, 'something happened', 'message is set');\n          t.same(line.res, {\n            statusCode: 415\n          }, 'status code is set');\n        });\n      });\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should redact the authorization header if so specified","suites":[],"updatePoint":{"line":1499,"column":60,"index":36442},"line":1499,"code":"test('should redact the authorization header if so specified', t => {\n  t.plan(7);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      redact: ['req.headers.authorization'],\n      level: 'info',\n      serializers: {\n        req(req) {\n          return {\n            method: req.method,\n            url: req.url,\n            headers: req.headers,\n            hostname: req.hostname,\n            remoteAddress: req.ip,\n            remotePort: req.socket.remotePort\n          };\n        }\n\n      }\n    }\n  });\n  fastify.get('/', function (req, reply) {\n    t.same(req.headers.authorization, 'Bearer abcde');\n    reply.send({\n      hello: 'world'\n    });\n  });\n  stream.once('data', listenAtLogLine => {\n    t.ok(listenAtLogLine, 'listen at log message is ok');\n    stream.once('data', line => {\n      t.equal(line.req.headers.authorization, '[Redacted]', 'authorization is redacted');\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        authorization: 'Bearer abcde'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(body.toString(), JSON.stringify({\n        hello: 'world'\n      }));\n    });\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should not log incoming request and outgoing response when disabled","suites":[],"updatePoint":{"line":1552,"column":73,"index":37825},"line":1552,"code":"test('should not log incoming request and outgoing response when disabled', t => {\n  t.plan(3);\n  const lines = [];\n  const dest = new stream.Writable({\n    write: function (chunk, enc, cb) {\n      lines.push(JSON.parse(chunk));\n      cb();\n    }\n  });\n  const fastify = Fastify({\n    disableRequestLogging: true,\n    logger: {\n      level: 'info',\n      stream: dest\n    }\n  });\n  fastify.get('/500', (req, reply) => {\n    reply.code(500).send(Error('500 error'));\n  });\n  fastify.inject({\n    url: '/500',\n    method: 'GET'\n  }, (e, res) => {\n    t.same(lines.length, 1);\n    t.ok(lines[0].msg);\n    t.same(lines[0].msg, '500 error');\n  });\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should pass when using unWritable props in the logger option","suites":[],"updatePoint":{"line":1580,"column":66,"index":38465},"line":1580,"code":"test('should pass when using unWritable props in the logger option', t => {\n  t.plan(1);\n  Fastify({\n    logger: Object.defineProperty({}, 'level', {\n      value: 'info'\n    })\n  });\n  t.pass();\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should be able to use a custom logger","suites":[],"updatePoint":{"line":1589,"column":43,"index":38641},"line":1589,"code":"test('should be able to use a custom logger', t => {\n  t.plan(1);\n  const logger = {\n    fatal: () => {},\n    error: () => {},\n    warn: () => {},\n    info: () => {},\n    debug: () => {},\n    trace: () => {},\n    child: () => {}\n  };\n  Fastify({\n    logger\n  });\n  t.pass();\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should create a default logger if provided one is invalid","suites":[],"updatePoint":{"line":1605,"column":63,"index":38940},"line":1605,"code":"test('should create a default logger if provided one is invalid', t => {\n  t.plan(1);\n  const logger = new Date();\n  Fastify({\n    logger\n  });\n  t.pass();\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"should not throw error when serializing custom req","suites":[],"updatePoint":{"line":1613,"column":56,"index":39093},"line":1613,"code":"test('should not throw error when serializing custom req', t => {\n  t.plan(1);\n  const lines = [];\n  const dest = new stream.Writable({\n    write: function (chunk, enc, cb) {\n      lines.push(JSON.parse(chunk));\n      cb();\n    }\n  });\n  const fastify = Fastify({\n    logger: {\n      level: 'info',\n      stream: dest\n    }\n  });\n  fastify.log.info({\n    req: {}\n  });\n  t.same(lines[0].req, {});\n});","file":"logger.test.js","skipped":false,"dir":"test"},{"name":"maxRequestsPerSocket on node version >= 16.10.0","suites":[],"updatePoint":{"line":14,"column":53,"index":267},"line":14,"code":"test('maxRequestsPerSocket on node version >= 16.10.0', {\n  skip\n}, t => {\n  t.plan(8);\n  const fastify = Fastify({\n    maxRequestsPerSocket: 2\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, function (err) {\n    t.error(err);\n    const port = fastify.server.address().port;\n    const client = net.createConnection({\n      port\n    }, () => {\n      client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n      client.once('data', data => {\n        t.match(data.toString(), /Connection:\\s*keep-alive/i);\n        t.match(data.toString(), /Keep-Alive:\\s*timeout=5/i);\n        t.match(data.toString(), /200 OK/i);\n        client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n        client.once('data', data => {\n          t.match(data.toString(), /Connection:\\s*close/i);\n          t.match(data.toString(), /200 OK/i);\n          client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n          client.once('data', data => {\n            t.match(data.toString(), /Connection:\\s*close/i);\n            t.match(data.toString(), /503 Service Unavailable/i);\n          });\n        });\n      });\n    });\n  });\n});","file":"maxRequestsPerSocket.test.js","skipped":false,"dir":"test"},{"name":"maxRequestsPerSocket zero should behave same as null","suites":[],"updatePoint":{"line":52,"column":58,"index":1442},"line":52,"code":"test('maxRequestsPerSocket zero should behave same as null', {\n  skip\n}, t => {\n  t.plan(10);\n  const fastify = Fastify({\n    maxRequestsPerSocket: 0\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.listen(0, function (err) {\n    t.error(err);\n    const port = fastify.server.address().port;\n    const client = net.createConnection({\n      port\n    }, () => {\n      client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n      client.once('data', data => {\n        t.match(data.toString(), /Connection:\\s*keep-alive/i);\n        t.match(data.toString(), /Keep-Alive:\\s*timeout=5/i);\n        t.match(data.toString(), /200 OK/i);\n        client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n        client.once('data', data => {\n          t.match(data.toString(), /Connection:\\s*keep-alive/i);\n          t.match(data.toString(), /Keep-Alive:\\s*timeout=5/i);\n          t.match(data.toString(), /200 OK/i);\n          client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n          client.once('data', data => {\n            t.match(data.toString(), /Connection:\\s*keep-alive/i);\n            t.match(data.toString(), /Keep-Alive:\\s*timeout=5/i);\n            t.match(data.toString(), /200 OK/i);\n          });\n        });\n      });\n    });\n  });\n});","file":"maxRequestsPerSocket.test.js","skipped":false,"dir":"test"},{"name":"maxRequestsPerSocket should be set","suites":[],"updatePoint":{"line":92,"column":40,"index":2723},"line":92,"code":"test('maxRequestsPerSocket should be set', async t => {\n  t.plan(1);\n  const initialConfig = Fastify({\n    maxRequestsPerSocket: 5\n  }).initialConfig;\n  t.same(initialConfig.maxRequestsPerSocket, 5);\n});","file":"maxRequestsPerSocket.test.js","skipped":false,"dir":"test"},{"name":"maxRequestsPerSocket should 0","suites":[],"updatePoint":{"line":99,"column":35,"index":2922},"line":99,"code":"test('maxRequestsPerSocket should 0', async t => {\n  t.plan(1);\n  const initialConfig = Fastify().initialConfig;\n  t.same(initialConfig.maxRequestsPerSocket, 0);\n});","file":"maxRequestsPerSocket.test.js","skipped":false,"dir":"test"},{"name":"requestTimeout passed to server","suites":[],"updatePoint":{"line":104,"column":37,"index":3090},"line":104,"code":"test('requestTimeout passed to server', t => {\n  t.plan(2);\n  const httpServer = Fastify({\n    maxRequestsPerSocket: 5\n  }).server;\n  t.equal(httpServer.maxRequestsPerSocket, 5);\n  const httpsServer = Fastify({\n    maxRequestsPerSocket: 5,\n    https: true\n  }).server;\n  t.equal(httpsServer.maxRequestsPerSocket, 5);\n});","file":"maxRequestsPerSocket.test.js","skipped":false,"dir":"test"},{"name":"Should throw if the basic use API has not been overridden","suites":[],"updatePoint":{"line":14,"column":63,"index":246},"line":14,"code":"test('Should throw if the basic use API has not been overridden', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.use();\n    t.fail('Should throw');\n  } catch (err) {\n    t.ok(err instanceof FST_ERR_MISSING_MIDDLEWARE);\n  }\n});","file":"middleware.test.js","skipped":false,"dir":"test"},{"name":"Should be able to override the default use API","suites":[],"updatePoint":{"line":25,"column":52,"index":485},"line":25,"code":"test('Should be able to override the default use API', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('use', () => true);\n  t.equal(fastify.use(), true);\n});","file":"middleware.test.js","skipped":false,"dir":"test"},{"name":"Cannot decorate use twice","suites":[],"updatePoint":{"line":31,"column":31,"index":643},"line":31,"code":"test('Cannot decorate use twice', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('use', () => true);\n\n  try {\n    fastify.decorate('use', () => true);\n  } catch (err) {\n    t.ok(err instanceof FST_ERR_DEC_ALREADY_PRESENT);\n  }\n});","file":"middleware.test.js","skipped":false,"dir":"test"},{"name":"Encapsulation works","suites":[],"updatePoint":{"line":42,"column":25,"index":889},"line":42,"code":"test('Encapsulation works', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.decorate('use', () => true);\n    t.equal(instance.use(), true);\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    try {\n      instance.use();\n      t.fail('Should throw');\n    } catch (err) {\n      t.ok(err instanceof FST_ERR_MISSING_MIDDLEWARE);\n    }\n\n    done();\n  });\n  fastify.ready();\n});","file":"middleware.test.js","skipped":false,"dir":"test"},{"name":"nullable string","suites":[],"updatePoint":{"line":11,"column":21,"index":162},"line":11,"code":"test('nullable string', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'POST',\n    url: '/',\n    handler: (req, reply) => {\n      t.same(req.body.hello, null);\n      reply.code(200).send(req.body);\n    },\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string',\n            format: 'email',\n            nullable: true\n          }\n        }\n      },\n      response: {\n        200: {\n          type: 'object',\n          properties: {\n            hello: {\n              type: 'string',\n              format: 'email',\n              nullable: true\n            }\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    body: {\n      hello: null\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload.hello, null);\n  });\n});","file":"nullable-validation.test.js","skipped":false,"dir":"test"},{"name":"object or null body","suites":[],"updatePoint":{"line":57,"column":25,"index":1036},"line":57,"code":"test('object or null body', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'POST',\n    url: '/',\n    handler: (req, reply) => {\n      t.equal(req.body, null);\n      reply.code(200).send({\n        requestBody: req.body\n      });\n    },\n    schema: {\n      body: {\n        type: ['object', 'null'],\n        properties: {\n          hello: {\n            type: 'string',\n            format: 'email'\n          }\n        }\n      },\n      response: {\n        200: {\n          type: 'object',\n          nullable: true,\n          properties: {\n            requestBody: {\n              type: 'string',\n              format: 'email',\n              nullable: true\n            }\n          }\n        }\n      }\n    }\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        requestBody: null\n      });\n    });\n  });\n});","file":"nullable-validation.test.js","skipped":false,"dir":"test"},{"name":"nullable body","suites":[],"updatePoint":{"line":109,"column":19,"index":2122},"line":109,"code":"test('nullable body', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'POST',\n    url: '/',\n    handler: (req, reply) => {\n      t.equal(req.body, null);\n      reply.code(200).send({\n        requestBody: req.body\n      });\n    },\n    schema: {\n      body: {\n        type: 'object',\n        nullable: true,\n        properties: {\n          hello: {\n            type: 'string',\n            format: 'email'\n          }\n        }\n      },\n      response: {\n        200: {\n          type: 'object',\n          nullable: true,\n          properties: {\n            requestBody: {\n              type: 'string',\n              format: 'email',\n              nullable: true\n            }\n          }\n        }\n      }\n    }\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        requestBody: null\n      });\n    });\n  });\n});","file":"nullable-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - output string","suites":[],"updatePoint":{"line":33,"column":31,"index":503},"line":33,"code":"test('shorthand - output string', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/string', opts, function (req, reply) {\n      reply.code(200).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - output number","suites":[],"updatePoint":{"line":47,"column":31,"index":745},"line":47,"code":"test('shorthand - output number', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/number', opts, function (req, reply) {\n      reply.code(201).send({\n        hello: 55\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"wrong object for schema - output","suites":[],"updatePoint":{"line":61,"column":38,"index":989},"line":61,"code":"test('wrong object for schema - output', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/wrong-object-for-schema', opts, function (req, reply) {\n      // will send { }\n      reply.code(201).send({\n        hello: 'world'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"empty response","suites":[],"updatePoint":{"line":76,"column":20,"index":1260},"line":76,"code":"test('empty response', t => {\n  t.plan(1);\n\n  try {\n    // no checks\n    fastify.get('/empty', opts, function (req, reply) {\n      reply.code(204).send();\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"unlisted response code","suites":[],"updatePoint":{"line":89,"column":28,"index":1483},"line":89,"code":"test('unlisted response code', t => {\n  t.plan(1);\n\n  try {\n    fastify.get('/400', opts, function (req, reply) {\n      reply.code(400).send({\n        hello: 'DOOM'\n      });\n    });\n    t.pass();\n  } catch (e) {\n    t.fail();\n  }\n});","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - string get ok","suites":[],"updatePoint":{"line":106,"column":33,"index":1792},"line":106,"code":"  test('shorthand - string get ok', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/string'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - number get ok","suites":[],"updatePoint":{"line":120,"column":33,"index":2201},"line":120,"code":"  test('shorthand - number get ok', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/number'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 201);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 55\n      });\n    });\n  });","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - wrong-object-for-schema","suites":[],"updatePoint":{"line":134,"column":43,"index":2615},"line":134,"code":"  test('shorthand - wrong-object-for-schema', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/wrong-object-for-schema'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 201);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {});\n    });\n  });","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - empty","suites":[],"updatePoint":{"line":146,"column":25,"index":3003},"line":146,"code":"  test('shorthand - empty', t => {\n    t.plan(2);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/empty'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 204);\n    });\n  });","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"shorthand - 400","suites":[],"updatePoint":{"line":156,"column":23,"index":3266},"line":156,"code":"  test('shorthand - 400', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/400'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'DOOM'\n      });\n    });\n  });","file":"output-validation.test.js","skipped":false,"dir":"test"},{"name":"require a plugin","suites":[],"updatePoint":{"line":16,"column":22,"index":292},"line":16,"code":"test('require a plugin', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.register(require('./plugin.helper'));\n  fastify.ready(() => {\n    t.ok(fastify.test);\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - ignore prefix","suites":[],"updatePoint":{"line":24,"column":37,"index":487},"line":24,"code":"test('plugin metadata - ignore prefix', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  fastify.register(plugin, {\n    prefix: 'foo'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, function (err, res) {\n    t.error(err);\n    t.equal(res.payload, 'hello');\n  });\n\n  function plugin(instance, opts, done) {\n    instance.get('/', function (request, reply) {\n      reply.send('hello');\n    });\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - naming plugins","suites":[],"updatePoint":{"line":46,"column":38,"index":961},"line":46,"code":"test('plugin metadata - naming plugins', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(require('./plugin.name.display'));\n  fastify.register(function (fastify, opts, done) {\n    // one line\n    t.equal(fastify.pluginName, 'function (fastify, opts, done) { -- // one line');\n    done();\n  });\n  fastify.register(function fooBar(fastify, opts, done) {\n    t.equal(fastify.pluginName, 'fooBar');\n    done();\n  });\n  await fastify.ready();\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"fastify.register with fastify-plugin should not encapsulate his code","suites":[],"updatePoint":{"line":61,"column":74,"index":1465},"line":61,"code":"test('fastify.register with fastify-plugin should not encapsulate his code', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      i.decorate('test', () => {});\n      t.ok(i.test);\n      n();\n    }));\n    t.notOk(instance.test); // the decoration is added at the end\n\n    instance.after(() => {\n      t.ok(instance.test);\n    });\n    instance.get('/', (req, reply) => {\n      t.ok(instance.test);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"fastify.register with fastify-plugin should provide access to external fastify instance if opts argument is a function","suites":[],"updatePoint":{"line":102,"column":124,"index":2554},"line":102,"code":"test('fastify.register with fastify-plugin should provide access to external fastify instance if opts argument is a function', t => {\n  t.plan(22);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      i.decorate('global', () => {});\n      t.ok(i.global);\n      n();\n    }));\n    instance.register((i, o, n) => n(), p => {\n      t.notOk(p === instance || p === fastify);\n      t.ok(instance.isPrototypeOf(p));\n      t.ok(fastify.isPrototypeOf(p));\n      t.ok(p.global);\n    });\n    instance.register((i, o, n) => {\n      i.decorate('local', () => {});\n      n();\n    });\n    instance.register((i, o, n) => n(), p => t.notOk(p.local));\n    instance.register((i, o, n) => {\n      t.ok(i.local);\n      n();\n    }, p => p.decorate('local', () => {}));\n    instance.register((i, o, n) => n(), p => t.notOk(p.local));\n    instance.register(fp((i, o, n) => {\n      t.ok(i.global_2);\n      n();\n    }), p => p.decorate('global_2', () => 'hello'));\n    instance.register((i, o, n) => {\n      i.decorate('global_2', () => 'world');\n      n();\n    }, p => p.get('/', (req, reply) => {\n      t.ok(p.global_2);\n      reply.send({\n        hello: p.global_2()\n      });\n    }));\n    t.notOk(instance.global);\n    t.notOk(instance.global_2);\n    t.notOk(instance.local); // the decoration is added at the end\n\n    instance.after(() => {\n      t.ok(instance.global);\n      t.equal(instance.global_2(), 'hello');\n      t.notOk(instance.local);\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.global);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"fastify.register with fastify-plugin registers root level plugins","suites":[],"updatePoint":{"line":170,"column":71,"index":4498},"line":170,"code":"test('fastify.register with fastify-plugin registers root level plugins', t => {\n  t.plan(15);\n  const fastify = Fastify();\n\n  function rootPlugin(instance, opts, done) {\n    instance.decorate('test', 'first');\n    t.ok(instance.test);\n    done();\n  }\n\n  function innerPlugin(instance, opts, done) {\n    instance.decorate('test2', 'second');\n    done();\n  }\n\n  fastify.register(fp(rootPlugin));\n  fastify.register((instance, opts, done) => {\n    t.ok(instance.test);\n    instance.register(fp(innerPlugin));\n    instance.get('/test2', (req, reply) => {\n      t.ok(instance.test2);\n      reply.send({\n        test2: instance.test2\n      });\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.ok(fastify.test);\n    t.notOk(fastify.test2);\n  });\n  fastify.get('/', (req, reply) => {\n    t.ok(fastify.test);\n    reply.send({\n      test: fastify.test\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        test: 'first'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/test2'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        test2: 'second'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"check dependencies - should not throw","suites":[],"updatePoint":{"line":234,"column":43,"index":6096},"line":234,"code":"test('check dependencies - should not throw', t => {\n  t.plan(12);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      i.decorate('test', () => {});\n      t.ok(i.test);\n      n();\n    }));\n    instance.register(fp((i, o, n) => {\n      try {\n        i.decorate('otherTest', () => {}, ['test']);\n        t.ok(i.test);\n        t.ok(i.otherTest);\n        n();\n      } catch (e) {\n        t.fail();\n      }\n    }));\n    instance.get('/', (req, reply) => {\n      t.ok(instance.test);\n      t.ok(instance.otherTest);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n    t.notOk(fastify.otherTest);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"check dependencies - should throw","suites":[],"updatePoint":{"line":282,"column":39,"index":7257},"line":282,"code":"test('check dependencies - should throw', t => {\n  t.plan(12);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      try {\n        i.decorate('otherTest', () => {}, ['test']);\n        t.fail();\n      } catch (e) {\n        t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY');\n        t.equal(e.message, 'The decorator is missing dependency \\'test\\'.');\n      }\n\n      n();\n    }));\n    instance.register(fp((i, o, n) => {\n      i.decorate('test', () => {});\n      t.ok(i.test);\n      t.notOk(i.otherTest);\n      n();\n    }));\n    instance.get('/', (req, reply) => {\n      t.ok(instance.test);\n      t.notOk(instance.otherTest);\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"set the plugin name based on the plugin displayName symbol","suites":[],"updatePoint":{"line":331,"column":64,"index":8528},"line":331,"code":"test('set the plugin name based on the plugin displayName symbol', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register(fp((fastify, opts, done) => {\n    t.equal(fastify.pluginName, 'plugin-A');\n    fastify.register(fp((fastify, opts, done) => {\n      t.equal(fastify.pluginName, 'plugin-A -> plugin-AB');\n      done();\n    }, {\n      name: 'plugin-AB'\n    }));\n    fastify.register(fp((fastify, opts, done) => {\n      t.equal(fastify.pluginName, 'plugin-A -> plugin-AB -> plugin-AC');\n      done();\n    }, {\n      name: 'plugin-AC'\n    }));\n    done();\n  }, {\n    name: 'plugin-A'\n  }));\n  fastify.register(fp((fastify, opts, done) => {\n    t.equal(fastify.pluginName, 'plugin-A -> plugin-AB -> plugin-AC -> plugin-B');\n    done();\n  }, {\n    name: 'plugin-B'\n  }));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin name will change when using no encapsulation","suites":[],"updatePoint":{"line":363,"column":57,"index":9382},"line":363,"code":"test('plugin name will change when using no encapsulation', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register(fp((fastify, opts, done) => {\n    // store it in a different variable will hold the correct name\n    const pluginName = fastify.pluginName;\n    fastify.register(fp((fastify, opts, done) => {\n      t.equal(fastify.pluginName, 'plugin-A -> plugin-AB');\n      done();\n    }, {\n      name: 'plugin-AB'\n    }));\n    fastify.register(fp((fastify, opts, done) => {\n      t.equal(fastify.pluginName, 'plugin-A -> plugin-AB -> plugin-AC');\n      done();\n    }, {\n      name: 'plugin-AC'\n    }));\n    setImmediate(() => {\n      // normally we would expect the name plugin-A\n      // but we operate on the same instance in each plugin\n      t.equal(fastify.pluginName, 'plugin-A -> plugin-AB -> plugin-AC');\n      t.equal(pluginName, 'plugin-A');\n    });\n    done();\n  }, {\n    name: 'plugin-A'\n  }));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin name is undefined when accessing in no plugin context","suites":[],"updatePoint":{"line":396,"column":66,"index":10388},"line":396,"code":"test('plugin name is undefined when accessing in no plugin context', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.equal(fastify.pluginName, undefined);\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"set the plugin name based on the plugin function name","suites":[],"updatePoint":{"line":405,"column":59,"index":10619},"line":405,"code":"test('set the plugin name based on the plugin function name', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register(function myPluginA(fastify, opts, done) {\n    t.equal(fastify.pluginName, 'myPluginA');\n    fastify.register(function myPluginAB(fastify, opts, done) {\n      t.equal(fastify.pluginName, 'myPluginAB');\n      done();\n    });\n    setImmediate(() => {\n      // exact name due to encapsulation\n      t.equal(fastify.pluginName, 'myPluginA');\n    });\n    done();\n  });\n  fastify.register(function myPluginB(fastify, opts, done) {\n    t.equal(fastify.pluginName, 'myPluginB');\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"approximate a plugin name when no meta data is available","suites":[],"updatePoint":{"line":429,"column":62,"index":11318},"line":429,"code":"test('approximate a plugin name when no meta data is available', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.register((fastify, opts, done) => {\n    // A\n    t.equal(fastify.pluginName.startsWith('(fastify, opts, done)'), true);\n    t.equal(fastify.pluginName.includes('// A'), true);\n    fastify.register((fastify, opts, done) => {\n      // B\n      t.equal(fastify.pluginName.startsWith('(fastify, opts, done)'), true);\n      t.equal(fastify.pluginName.includes('// B'), true);\n      done();\n    });\n    setImmediate(() => {\n      t.equal(fastify.pluginName.startsWith('(fastify, opts, done)'), true);\n      t.equal(fastify.pluginName.includes('// A'), true);\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"approximate a plugin name also when fastify-plugin has no meta data","suites":[],"updatePoint":{"line":453,"column":73,"index":12109},"line":453,"code":"test('approximate a plugin name also when fastify-plugin has no meta data', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(fp((fastify, opts, done) => {\n    t.match(fastify.pluginName, /plugin\\.test/);\n    fastify.register(fp(function B(fastify, opts, done) {\n      // function has name\n      t.match(fastify.pluginName, /plugin\\.test-auto-\\d+ -> B/);\n      done();\n    }));\n    setImmediate(() => {\n      t.match(fastify.pluginName, /plugin\\.test-auto-\\d+ -> B/);\n    });\n    done();\n  }));\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.close();\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin encapsulation","suites":[],"updatePoint":{"line":473,"column":26,"index":12653},"line":473,"code":"test('plugin encapsulation', t => {\n  t.plan(10);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      i.decorate('test', 'first');\n      n();\n    }));\n    instance.get('/first', (req, reply) => {\n      reply.send({\n        plugin: instance.test\n      });\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.register(fp((i, o, n) => {\n      i.decorate('test', 'second');\n      n();\n    }));\n    instance.get('/second', (req, reply) => {\n      reply.send({\n        plugin: instance.test\n      });\n    });\n    done();\n  });\n  fastify.ready(() => {\n    t.notOk(fastify.test);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/first'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        plugin: 'first'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/second'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        plugin: 'second'\n      });\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"if a plugin raises an error and there is not a callback to handle it, the server must not start","suites":[],"updatePoint":{"line":530,"column":101,"index":14187},"line":530,"code":"test('if a plugin raises an error and there is not a callback to handle it, the server must not start', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    done(new Error('err'));\n  });\n  fastify.listen(0, err => {\n    t.ok(err instanceof Error);\n    t.equal(err.message, 'err');\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"add hooks after route declaration","suites":[],"updatePoint":{"line":541,"column":39,"index":14463},"line":541,"code":"test('add hooks after route declaration', t => {\n  t.plan(3);\n  const fastify = Fastify();\n\n  function plugin(instance, opts, done) {\n    instance.decorateRequest('check', null);\n    instance.addHook('onRequest', (req, reply, done) => {\n      req.check = {};\n      done();\n    });\n    setImmediate(done);\n  }\n\n  fastify.register(fp(plugin));\n  fastify.register((instance, options, done) => {\n    instance.addHook('preHandler', function b(req, res, done) {\n      req.check.hook2 = true;\n      done();\n    });\n    instance.get('/', (req, reply) => {\n      reply.send(req.check);\n    });\n    instance.addHook('preHandler', function c(req, res, done) {\n      req.check.hook3 = true;\n      done();\n    });\n    done();\n  });\n  fastify.addHook('preHandler', function a(req, res, done) {\n    req.check.hook1 = true;\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(JSON.parse(body), {\n        hook1: true,\n        hook2: true,\n        hook3: true\n      });\n      fastify.close();\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"nested plugins","suites":[],"updatePoint":{"line":589,"column":20,"index":15612},"line":589,"code":"test('nested plugins', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.register(function (fastify, opts, done) {\n    fastify.register((fastify, opts, done) => {\n      fastify.get('/', function (req, reply) {\n        reply.send('I am child 1');\n      });\n      done();\n    }, {\n      prefix: '/child1'\n    });\n    fastify.register((fastify, opts, done) => {\n      fastify.get('/', function (req, reply) {\n        reply.send('I am child 2');\n      });\n      done();\n    }, {\n      prefix: '/child2'\n    });\n    done();\n  }, {\n    prefix: '/parent'\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/parent/child1'\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(body.toString(), 'I am child 1');\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/parent/child2'\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(body.toString(), 'I am child 2');\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"nested plugins awaited","suites":[],"updatePoint":{"line":632,"column":28,"index":16729},"line":632,"code":"test('nested plugins awaited', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.register(async function wrap(fastify, opts) {\n    await fastify.register(async function child1(fastify, opts) {\n      fastify.get('/', function (req, reply) {\n        reply.send('I am child 1');\n      });\n    }, {\n      prefix: '/child1'\n    });\n    await fastify.register(async function child2(fastify, opts) {\n      fastify.get('/', function (req, reply) {\n        reply.send('I am child 2');\n      });\n    }, {\n      prefix: '/child2'\n    });\n  }, {\n    prefix: '/parent'\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/parent/child1'\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(body.toString(), 'I am child 1');\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/parent/child2'\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(body.toString(), 'I am child 2');\n    });\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - decorators","suites":[],"updatePoint":{"line":672,"column":34,"index":17852},"line":672,"code":"test('plugin metadata - decorators', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('plugin1', true);\n  fastify.decorateReply('plugin1', true);\n  fastify.decorateRequest('plugin1', true);\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    decorators: {\n      fastify: ['plugin1'],\n      reply: ['plugin1'],\n      request: ['plugin1']\n    }\n  };\n  fastify.register(plugin);\n  fastify.ready(() => {\n    t.ok(fastify.plugin);\n  });\n\n  function plugin(instance, opts, done) {\n    instance.decorate('plugin', true);\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - decorators - should throw","suites":[],"updatePoint":{"line":696,"column":49,"index":18458},"line":696,"code":"test('plugin metadata - decorators - should throw', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('plugin1', true);\n  fastify.decorateReply('plugin1', true);\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    decorators: {\n      fastify: ['plugin1'],\n      reply: ['plugin1'],\n      request: ['plugin1']\n    }\n  };\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.equal(err.message, \"The decorator 'plugin1' is not present in Request\");\n  });\n\n  function plugin(instance, opts, done) {\n    instance.decorate('plugin', true);\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - decorators - should throw with plugin name","suites":[],"updatePoint":{"line":719,"column":66,"index":19091},"line":719,"code":"test('plugin metadata - decorators - should throw with plugin name', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorate('plugin1', true);\n  fastify.decorateReply('plugin1', true);\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'the-plugin',\n    decorators: {\n      fastify: ['plugin1'],\n      reply: ['plugin1'],\n      request: ['plugin1']\n    }\n  };\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.equal(err.message, \"The decorator 'plugin1' required by 'the-plugin' is not present in Request\");\n  });\n\n  function plugin(instance, opts, done) {\n    instance.decorate('plugin', true);\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - dependencies","suites":[],"updatePoint":{"line":743,"column":36,"index":19743},"line":743,"code":"test('plugin metadata - dependencies', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  dependency[Symbol.for('skip-override')] = true;\n  dependency[Symbol.for('plugin-meta')] = {\n    name: 'plugin'\n  };\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    dependencies: ['plugin']\n  };\n  fastify.register(dependency);\n  fastify.register(plugin);\n  fastify.ready(() => {\n    t.pass('everything right');\n  });\n\n  function dependency(instance, opts, done) {\n    done();\n  }\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - dependencies (nested)","suites":[],"updatePoint":{"line":768,"column":45,"index":20326},"line":768,"code":"test('plugin metadata - dependencies (nested)', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  dependency[Symbol.for('skip-override')] = true;\n  dependency[Symbol.for('plugin-meta')] = {\n    name: 'plugin'\n  };\n  nested[Symbol.for('skip-override')] = true;\n  nested[Symbol.for('plugin-meta')] = {\n    dependencies: ['plugin']\n  };\n  fastify.register(dependency);\n  fastify.register(plugin);\n  fastify.ready(() => {\n    t.pass('everything right');\n  });\n\n  function dependency(instance, opts, done) {\n    done();\n  }\n\n  function plugin(instance, opts, done) {\n    instance.register(nested);\n    done();\n  }\n\n  function nested(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"pluginTimeout","suites":[],"updatePoint":{"line":798,"column":19,"index":20973},"line":798,"code":"test('pluginTimeout', t => {\n  t.plan(2);\n  const fastify = Fastify({\n    pluginTimeout: 10\n  });\n  fastify.register(function (app, opts, done) {// to no call done on purpose\n  });\n  fastify.ready(err => {\n    t.ok(err);\n    t.equal(err.code, 'ERR_AVVIO_PLUGIN_TIMEOUT');\n  });\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"pluginTimeout default","suites":[],"updatePoint":{"line":810,"column":27,"index":21263},"line":810,"code":"test('pluginTimeout default', t => {\n  t.plan(2);\n  const clock = fakeTimer.install();\n  const fastify = Fastify();\n  fastify.register(function (app, opts, done) {\n    // default time elapsed without calling done\n    clock.tick(10000);\n  });\n  fastify.ready(err => {\n    t.ok(err);\n    t.equal(err.code, 'ERR_AVVIO_PLUGIN_TIMEOUT');\n  });\n  t.teardown(clock.uninstall);\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - version","suites":[],"updatePoint":{"line":824,"column":31,"index":21641},"line":824,"code":"test('plugin metadata - version', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'plugin',\n    fastify: '2.0.0'\n  };\n  fastify.register(plugin);\n  fastify.ready(() => {\n    t.pass('everything right');\n  });\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - version range","suites":[],"updatePoint":{"line":841,"column":37,"index":22015},"line":841,"code":"test('plugin metadata - version range', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'plugin',\n    fastify: '>=2.0.0'\n  };\n  fastify.register(plugin);\n  fastify.ready(() => {\n    t.pass('everything right');\n  });\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - version not matching requirement","suites":[],"updatePoint":{"line":858,"column":56,"index":22410},"line":858,"code":"test('plugin metadata - version not matching requirement', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'plugin',\n    fastify: '99.0.0'\n  };\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.ok(err);\n    t.equal(err.code, 'FST_ERR_PLUGIN_VERSION_MISMATCH');\n  });\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - version not matching requirement 2","suites":[],"updatePoint":{"line":876,"column":58,"index":22848},"line":876,"code":"test('plugin metadata - version not matching requirement 2', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'plugin',\n    fastify: '<=3.0.0'\n  };\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.ok(err);\n    t.equal(err.code, 'FST_ERR_PLUGIN_VERSION_MISMATCH');\n  });\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"plugin metadata - version not matching requirement 3","suites":[],"updatePoint":{"line":894,"column":58,"index":23287},"line":894,"code":"test('plugin metadata - version not matching requirement 3', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  plugin[Symbol.for('skip-override')] = true;\n  plugin[Symbol.for('plugin-meta')] = {\n    name: 'plugin',\n    fastify: '>=99.0.0'\n  };\n  fastify.register(plugin);\n  fastify.ready(err => {\n    t.ok(err);\n    t.equal(err.code, 'FST_ERR_PLUGIN_VERSION_MISMATCH');\n  });\n\n  function plugin(instance, opts, done) {\n    done();\n  }\n});","file":"plugin.test.js","skipped":false,"dir":"test"},{"name":"pretty print - static routes","suites":[],"updatePoint":{"line":9,"column":34,"index":131},"line":9,"code":"test('pretty print - static routes', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/test', () => {});\n  fastify.get('/test/hello', () => {});\n  fastify.get('/hello/world', () => {});\n  fastify.ready(() => {\n    const tree = fastify.printRoutes();\n    const expected = ` /\n     test (GET)\n        /hello (GET)\n     hello/world (GET)\n`;\n    t.equal(typeof tree, 'string');\n    t.equal(tree, expected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - parametric routes","suites":[],"updatePoint":{"line":26,"column":38,"index":576},"line":26,"code":"test('pretty print - parametric routes', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/test', () => {});\n  fastify.get('/test/:hello', () => {});\n  fastify.get('/hello/:world', () => {});\n  fastify.ready(() => {\n    const tree = fastify.printRoutes();\n    const expected = ` /\n     test (GET)\n        /:hello (GET)\n     hello/:world (GET)\n`;\n    t.equal(typeof tree, 'string');\n    t.equal(tree, expected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - mixed parametric routes","suites":[],"updatePoint":{"line":43,"column":44,"index":1031},"line":43,"code":"test('pretty print - mixed parametric routes', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/test', () => {});\n  fastify.get('/test/:hello', () => {});\n  fastify.post('/test/:hello', () => {});\n  fastify.get('/test/:hello/world', () => {});\n  fastify.ready(() => {\n    const tree = fastify.printRoutes();\n    const expected = ` /test (GET)\n     /\n         :hello (GET)\n            :hello (POST)\n             /world (GET)\n`;\n    t.equal(typeof tree, 'string');\n    t.equal(tree, expected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - wildcard routes","suites":[],"updatePoint":{"line":62,"column":36,"index":1553},"line":62,"code":"test('pretty print - wildcard routes', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/test', () => {});\n  fastify.get('/test/*', () => {});\n  fastify.get('/hello/*', () => {});\n  fastify.ready(() => {\n    const tree = fastify.printRoutes();\n    const expected = ` /\n     test (GET)\n        /* (GET)\n     hello/* (GET)\n`;\n    t.equal(typeof tree, 'string');\n    t.equal(tree, expected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - empty plugins","suites":[],"updatePoint":{"line":79,"column":34,"index":1978},"line":79,"code":"test('pretty print - empty plugins', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.ready(() => {\n    const tree = fastify.printPlugins();\n    t.equal(typeof tree, 'string');\n    t.match(tree, 'bound root');\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - nested plugins","suites":[],"updatePoint":{"line":88,"column":35,"index":2209},"line":88,"code":"test('pretty print - nested plugins', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(async function foo(instance) {\n    instance.register(async function bar() {});\n    instance.register(async function baz() {});\n  });\n  fastify.ready(() => {\n    const tree = fastify.printPlugins();\n    t.equal(typeof tree, 'string');\n    t.match(tree, 'foo');\n    t.match(tree, 'bar');\n    t.match(tree, 'baz');\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - commonPrefix","suites":[],"updatePoint":{"line":103,"column":33,"index":2635},"line":103,"code":"test('pretty print - commonPrefix', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/hello', () => {});\n  fastify.put('/hello', () => {});\n  fastify.get('/helicopter', () => {});\n  fastify.ready(() => {\n    const radixTree = fastify.printRoutes();\n    const flatTree = fastify.printRoutes({\n      commonPrefix: false\n    });\n    const radixExpected = ` /\n     hel\n        lo (GET)\n        icopter (GET)\n     hello (PUT)\n`;\n    const flatExpected = ` / (-)\n     helicopter (GET)\n     hello (GET, PUT)\n`;\n    t.equal(typeof radixTree, 'string');\n    t.equal(typeof flatTree, 'string');\n    t.equal(radixTree, radixExpected);\n    t.equal(flatTree, flatExpected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"pretty print - includeMeta, includeHooks","suites":[],"updatePoint":{"line":130,"column":46,"index":3360},"line":130,"code":"test('pretty print - includeMeta, includeHooks', t => {\n  t.plan(6);\n  const fastify = Fastify();\n\n  const onTimeout = () => {};\n\n  fastify.get('/hello', () => {});\n  fastify.put('/hello', () => {});\n  fastify.get('/helicopter', () => {});\n  fastify.addHook('onRequest', () => {});\n  fastify.addHook('onTimeout', onTimeout);\n  fastify.ready(() => {\n    const radixTree = fastify.printRoutes({\n      includeHooks: true,\n      includeMeta: ['errorHandler']\n    });\n    const flatTree = fastify.printRoutes({\n      commonPrefix: false,\n      includeHooks: true,\n      includeMeta: ['errorHandler']\n    });\n    const hooksOnly = fastify.printRoutes({\n      commonPrefix: false,\n      includeHooks: true\n    });\n    const radixExpected = ` /\n     hel\n        lo (GET)\n           (onTimeout) [\"onTimeout()\"]\n           (onRequest) [\"anonymous()\"]\n           (errorHandler) \"defaultErrorHandler()\"\n        icopter (GET)\n            (onTimeout) [\"onTimeout()\"]\n            (onRequest) [\"anonymous()\"]\n            (errorHandler) \"defaultErrorHandler()\"\n     hello (PUT)\n         (onTimeout) [\"onTimeout()\"]\n         (onRequest) [\"anonymous()\"]\n         (errorHandler) \"defaultErrorHandler()\"\n`;\n    const flatExpected = ` / (-)\n     helicopter (GET)\n        (onTimeout) [\"onTimeout()\"]\n        (onRequest) [\"anonymous()\"]\n        (errorHandler) \"defaultErrorHandler()\"\n     hello (GET, PUT)\n         (onTimeout) [\"onTimeout()\"]\n         (onRequest) [\"anonymous()\"]\n         (errorHandler) \"defaultErrorHandler()\"\n`;\n    const hooksOnlyExpected = ` / (-)\n     helicopter (GET)\n        (onTimeout) [\"onTimeout()\"]\n        (onRequest) [\"anonymous()\"]\n     hello (GET, PUT)\n         (onTimeout) [\"onTimeout()\"]\n         (onRequest) [\"anonymous()\"]\n`;\n    t.equal(typeof radixTree, 'string');\n    t.equal(typeof flatTree, 'string');\n    t.equal(typeof hooksOnlyExpected, 'string');\n    t.equal(radixTree, radixExpected);\n    t.equal(flatTree, flatExpected);\n    t.equal(hooksOnly, hooksOnlyExpected);\n  });\n});","file":"pretty-print.test.js","skipped":false,"dir":"test"},{"name":"shorthand - sget return promise es6 get","suites":[],"updatePoint":{"line":72,"column":47,"index":1437},"line":72,"code":"  test('shorthand - sget return promise es6 get', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/return'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"shorthand - sget promise es6 get return error","suites":[],"updatePoint":{"line":86,"column":53,"index":1866},"line":86,"code":"  test('shorthand - sget promise es6 get return error', t => {\n    t.plan(2);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/return-error'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"sget promise double send","suites":[],"updatePoint":{"line":96,"column":32,"index":2145},"line":96,"code":"  test('sget promise double send', t => {\n    t.plan(3);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/double'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: '42'\n      });\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"thenable","suites":[],"updatePoint":{"line":109,"column":16,"index":2465},"line":109,"code":"  test('thenable', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/thenable'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"thenable (error)","suites":[],"updatePoint":{"line":123,"column":24,"index":2867},"line":123,"code":"  test('thenable (error)', t => {\n    t.plan(2);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/thenable-error'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"return-reply","suites":[],"updatePoint":{"line":133,"column":20,"index":3136},"line":133,"code":"  test('return-reply', t => {\n    t.plan(4);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/return-reply'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  });","file":"promises.test.js","skipped":false,"dir":"test"},{"name":"proto-poisoning error","suites":[],"updatePoint":{"line":10,"column":27,"index":167},"line":10,"code":"test('proto-poisoning error', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    t.fail('handler should not be called');\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"__proto__\": { \"a\": 42 } }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"proto-poisoning remove","suites":[],"updatePoint":{"line":32,"column":28,"index":759},"line":32,"code":"test('proto-poisoning remove', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    onProtoPoisoning: 'remove'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    t.equal(undefined, Object.assign({}, request.body).a);\n    reply.send({\n      ok: true\n    });\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"__proto__\": { \"a\": 42 }, \"b\": 42 }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"proto-poisoning ignore","suites":[],"updatePoint":{"line":59,"column":28,"index":1451},"line":59,"code":"test('proto-poisoning ignore', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    onProtoPoisoning: 'ignore'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    t.equal(42, Object.assign({}, request.body).a);\n    reply.send({\n      ok: true\n    });\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"__proto__\": { \"a\": 42 }, \"b\": 42 }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"constructor-poisoning error (default in v3)","suites":[],"updatePoint":{"line":86,"column":49,"index":2157},"line":86,"code":"test('constructor-poisoning error (default in v3)', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    reply.send('ok');\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"constructor\": { \"prototype\": { \"foo\": \"bar\" } } }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"constructor-poisoning error","suites":[],"updatePoint":{"line":108,"column":33,"index":2756},"line":108,"code":"test('constructor-poisoning error', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    onConstructorPoisoning: 'error'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    t.fail('handler should not be called');\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"constructor\": { \"prototype\": { \"foo\": \"bar\" } } }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 400);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"constructor-poisoning remove","suites":[],"updatePoint":{"line":132,"column":34,"index":3419},"line":132,"code":"test('constructor-poisoning remove', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    onConstructorPoisoning: 'remove'\n  });\n  t.teardown(fastify.close.bind(fastify));\n  fastify.post('/', (request, reply) => {\n    t.equal(undefined, Object.assign({}, request.body).foo);\n    reply.send({\n      ok: true\n    });\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'POST',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: '{ \"constructor\": { \"prototype\": { \"foo\": \"bar\" } } }'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"proto-poisoning.test.js","skipped":false,"dir":"test"},{"name":"register","suites":[],"updatePoint":{"line":12,"column":14,"index":193},"line":12,"code":"test('register', t => {\n  t.plan(17);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    t.not(instance, fastify);\n    t.ok(fastify.isPrototypeOf(instance));\n    t.equal(typeof opts, 'object');\n    t.equal(typeof done, 'function');\n    instance.get('/first', function (req, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.register(function (instance, opts, done) {\n    t.not(instance, fastify);\n    t.ok(fastify.isPrototypeOf(instance));\n    t.equal(typeof opts, 'object');\n    t.equal(typeof done, 'function');\n    instance.get('/second', function (req, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    makeRequest('first');\n    makeRequest('second');\n  });\n\n  function makeRequest(path) {\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/' + path\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.equal(response.headers['content-length'], '' + body.length);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n  }\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"internal route declaration should pass the error generated by the register to the done handler / 1","suites":[],"updatePoint":{"line":60,"column":104,"index":1529},"line":60,"code":"test('internal route declaration should pass the error generated by the register to the done handler / 1', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    done(new Error('kaboom'));\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.listen(0, err => {\n    fastify.close();\n    t.equal(err.message, 'kaboom');\n  });\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"internal route declaration should pass the error generated by the register to the done handler / 2","suites":[],"updatePoint":{"line":76,"column":104,"index":1954},"line":76,"code":"test('internal route declaration should pass the error generated by the register to the done handler / 2', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    done(new Error('kaboom'));\n  });\n  fastify.get('/', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.after(err => {\n    t.equal(err.message, 'kaboom');\n  });\n  fastify.listen(0, err => {\n    fastify.close();\n    t.error(err);\n  });\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"awaitable register and after","suites":[],"updatePoint":{"line":95,"column":34,"index":2358},"line":95,"code":"test('awaitable register and after', async t => {\n  const fastify = Fastify();\n  let first = false;\n  let second = false;\n  let third = false;\n  await fastify.register(async (instance, opts, done) => {\n    first = true;\n  });\n  t.equal(first, true);\n  fastify.register(async (instance, opts, done) => {\n    second = true;\n  });\n  await fastify.after();\n  t.equal(second, true);\n  fastify.register(async (instance, opts, done) => {\n    third = true;\n  });\n  await fastify.ready();\n  t.equal(third, true);\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"awaitable register error handling","suites":[],"updatePoint":{"line":122,"column":39,"index":2986},"line":122,"code":"test('awaitable register error handling', async t => {\n  const fastify = Fastify();\n  const e = new Error('kaboom');\n  await thenableRejects(t, fastify.register(async (instance, opts) => {\n    throw e;\n  }), e);\n  fastify.register(async (instance, opts) => {\n    t.fail('should not be executed');\n  });\n  await t.rejects(fastify.after(), e);\n  fastify.register(async (instance, opts, done) => {\n    t.fail('should not be executed');\n  });\n  await thenableRejects(t, fastify.ready(), e);\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"awaitable after error handling","suites":[],"updatePoint":{"line":137,"column":36,"index":3474},"line":137,"code":"test('awaitable after error handling', async t => {\n  const fastify = Fastify();\n  const e = new Error('kaboom');\n  fastify.register(async (instance, opts) => {\n    throw e;\n  });\n  fastify.register(async (instance, opts) => {\n    t.fail('should not be executed');\n  });\n  await t.rejects(fastify.after(), e);\n  fastify.register(async (instance, opts, done) => {\n    t.fail('should not be executed');\n  });\n  await t.rejects(fastify.ready());\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"chainable register","suites":[],"updatePoint":{"line":152,"column":24,"index":3909},"line":152,"code":"test('chainable register', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register(async () => {\n    t.pass('first loaded');\n  }).register(async () => {\n    t.pass('second loaded');\n  }).register(async () => {\n    t.pass('third loaded');\n  });\n  await fastify.ready();\n});","file":"register.test.js","skipped":false,"dir":"test"},{"name":"preHandler hook error handling with external code","suites":[],"updatePoint":{"line":48,"column":55,"index":1086},"line":48,"code":"test('preHandler hook error handling with external code', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  fastify.addHook('preHandler', (req, reply, done) => {\n    reply.code(400);\n    done(err);\n  });\n  fastify.get('/', () => {});\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 400);\n    t.same({\n      error: statusCodes['400'],\n      message: err.message,\n      statusCode: 400\n    }, JSON.parse(res.payload));\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"onRequest hook error handling with external done","suites":[],"updatePoint":{"line":70,"column":54,"index":1632},"line":70,"code":"test('onRequest hook error handling with external done', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  fastify.addHook('onRequest', (req, reply, done) => {\n    reply.code(400);\n    done(err);\n  });\n  fastify.get('/', () => {});\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 400);\n    t.same({\n      error: statusCodes['400'],\n      message: err.message,\n      statusCode: 400\n    }, JSON.parse(res.payload));\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Should reply 400 on client error","suites":[],"updatePoint":{"line":92,"column":38,"index":2161},"line":92,"code":"test('Should reply 400 on client error', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.listen(0, err => {\n    t.error(err);\n    const client = net.connect(fastify.server.address().port);\n    client.end('oooops!');\n    let chunks = '';\n    client.on('data', chunk => {\n      chunks += chunk;\n    });\n    client.once('end', () => {\n      const body = JSON.stringify({\n        error: 'Bad Request',\n        message: 'Client Error',\n        statusCode: 400\n      });\n      t.equal(`HTTP/1.1 400 Bad Request\\r\\nContent-Length: ${body.length}\\r\\nContent-Type: application/json\\r\\n\\r\\n${body}`, chunks);\n      fastify.close();\n    });\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Should set the response from client error handler","suites":[],"updatePoint":{"line":114,"column":55,"index":2829},"line":114,"code":"test('Should set the response from client error handler', t => {\n  t.plan(5);\n  const responseBody = JSON.stringify({\n    error: 'Ended Request',\n    message: 'Serious Client Error',\n    statusCode: 400\n  });\n  const response = `HTTP/1.1 400 Bad Request\\r\\nContent-Length: ${responseBody.length}\\r\\nContent-Type: application/json; charset=utf-8\\r\\n\\r\\n${responseBody}`;\n\n  function clientErrorHandler(err, socket) {\n    t.type(err, Error);\n    this.log.warn({\n      err\n    }, 'Handled client error');\n    socket.end(response);\n  }\n\n  const logStream = split(JSON.parse);\n  const fastify = Fastify({\n    clientErrorHandler,\n    logger: {\n      stream: logStream,\n      level: 'warn'\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    const client = net.connect(fastify.server.address().port);\n    client.end('oooops!');\n    let chunks = '';\n    client.on('data', chunk => {\n      chunks += chunk;\n    });\n    client.once('end', () => {\n      t.equal(response, chunks);\n      fastify.close();\n    });\n  });\n  logStream.once('data', line => {\n    t.equal('Handled client error', line.msg);\n    t.equal(40, line.level, 'Log level is not warn');\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Error instance sets HTTP status code","suites":[],"updatePoint":{"line":157,"column":42,"index":3980},"line":157,"code":"test('Error instance sets HTTP status code', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  err.statusCode = 418;\n  fastify.get('/', () => {\n    return Promise.reject(err);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same({\n      error: statusCodes['418'],\n      message: err.message,\n      statusCode: 418\n    }, JSON.parse(res.payload));\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Error status code below 400 defaults to 500","suites":[],"updatePoint":{"line":178,"column":49,"index":4482},"line":178,"code":"test('Error status code below 400 defaults to 500', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  err.statusCode = 399;\n  fastify.get('/', () => {\n    return Promise.reject(err);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 500);\n    t.same({\n      error: statusCodes['500'],\n      message: err.message,\n      statusCode: 500\n    }, JSON.parse(res.payload));\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Error.status property support","suites":[],"updatePoint":{"line":199,"column":35,"index":4970},"line":199,"code":"test('Error.status property support', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('winter is coming');\n  err.status = 418;\n  fastify.get('/', () => {\n    return Promise.reject(err);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same({\n      error: statusCodes['418'],\n      message: err.message,\n      statusCode: 418\n    }, JSON.parse(res.payload));\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"Support rejection with values that are not Error instances","suites":[],"updatePoint":{"line":220,"column":64,"index":5483},"line":220,"code":"test('Support rejection with values that are not Error instances', t => {\n  const objs = [0, '', [], {}, null, undefined, 123, 'abc', new RegExp(), new Date(), new Uint8Array()];\n  t.plan(objs.length);\n\n  for (const nonErr of objs) {\n    t.test('Type: ' + typeof nonErr, t => {\n      t.plan(4);\n      const fastify = Fastify();\n      fastify.get('/', () => {\n        return Promise.reject(nonErr);\n      });\n      fastify.setErrorHandler((err, request, reply) => {\n        if (typeof err === 'object') {\n          t.same(err, nonErr);\n        } else {\n          t.equal(err, nonErr);\n        }\n\n        reply.send('error');\n      });\n      fastify.inject({\n        method: 'GET',\n        url: '/'\n      }, (error, res) => {\n        t.error(error);\n        t.equal(res.statusCode, 500);\n        t.equal(res.payload, 'error');\n      });\n    });\n  }\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"invalid schema - ajv","suites":[],"updatePoint":{"line":251,"column":26,"index":6296},"line":251,"code":"test('invalid schema - ajv', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      querystring: {\n        type: 'object',\n        properties: {\n          id: {\n            type: 'number'\n          }\n        }\n      }\n    }\n  }, (req, reply) => {\n    t.fail('we should not be here');\n  });\n  fastify.setErrorHandler((err, request, reply) => {\n    t.ok(Array.isArray(err.validation));\n    reply.send('error');\n  });\n  fastify.inject({\n    url: '/?id=abc',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.payload, 'error');\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should set the status code and the headers from the error object (from route handler)","suites":[],"updatePoint":{"line":281,"column":91,"index":6987},"line":281,"code":"test('should set the status code and the headers from the error object (from route handler)', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    const error = new Error('kaboom');\n    error.headers = {\n      hello: 'world'\n    };\n    error.statusCode = 400;\n    reply.send(error);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers.hello, 'world');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      message: 'kaboom',\n      statusCode: 400\n    });\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should set the status code and the headers from the error object (from custom error handler)","suites":[],"updatePoint":{"line":306,"column":98,"index":7616},"line":306,"code":"test('should set the status code and the headers from the error object (from custom error handler)', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    const error = new Error('ouch');\n    error.statusCode = 401;\n    reply.send(error);\n  });\n  fastify.setErrorHandler((err, request, reply) => {\n    t.equal(err.message, 'ouch');\n    t.equal(reply.raw.statusCode, 401);\n    const error = new Error('kaboom');\n    error.headers = {\n      hello: 'world'\n    };\n    error.statusCode = 400;\n    reply.send(error);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers.hello, 'world');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      message: 'kaboom',\n      statusCode: 400\n    });\n  });\n}); // Issue 595 https://github.com/fastify/fastify/issues/595","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"'*' should throw an error due to serializer can not handle the payload type","suites":[],"updatePoint":{"line":339,"column":83,"index":8511},"line":339,"code":"test('\\'*\\' should throw an error due to serializer can not handle the payload type', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.type('text/html');\n\n    try {\n      reply.send({});\n    } catch (err) {\n      t.type(err, TypeError);\n      t.equal(err.code, 'FST_ERR_REP_INVALID_PAYLOAD_TYPE');\n      t.equal(err.message, \"Attempted to send payload of invalid type 'object'. Expected a string or Buffer.\");\n    }\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (e, res) => {\n    t.fail('should not be called');\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should throw an error if the custom serializer does not serialize the payload to a valid type","suites":[],"updatePoint":{"line":360,"column":99,"index":9112},"line":360,"code":"test('should throw an error if the custom serializer does not serialize the payload to a valid type', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    try {\n      reply.type('text/html').serializer(payload => payload).send({});\n    } catch (err) {\n      t.type(err, TypeError);\n      t.equal(err.code, 'FST_ERR_REP_INVALID_PAYLOAD_TYPE');\n      t.equal(err.message, \"Attempted to send payload of invalid type 'object'. Expected a string or Buffer.\");\n    }\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (e, res) => {\n    t.fail('should not be called');\n  });\n}); // Issue 2078 https://github.com/fastify/fastify/issues/2078","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should throw error if error code is ","suites":[],"updatePoint":{"line":384,"column":58,"index":9993},"line":384,"code":"  test(`should throw error if error code is ${invalidCode}`, t => {\n    t.plan(2);\n    const fastify = Fastify();\n    fastify.get('/', (request, reply) => {\n      try {\n        return reply.code(invalidCode).send('You should not read this');\n      } catch (err) {\n        t.equal(err.code, 'FST_ERR_BAD_STATUS_CODE');\n        t.equal(err.message, 'Called reply with an invalid status code: ' + invalidCode);\n      }\n    });\n    fastify.inject({\n      url: '/',\n      method: 'GET'\n    }, (e, res) => {\n      t.fail('should not be called');\n    });\n  });","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"status code should be set to 500 and return an error json payload if route handler throws any non Error object expression","suites":[],"updatePoint":{"line":403,"column":127,"index":10620},"line":403,"code":"test('status code should be set to 500 and return an error json payload if route handler throws any non Error object expression', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', () => {\n    /* eslint-disable-next-line */\n    throw {\n      foo: 'bar'\n    };\n  }); // ----\n\n  const reply = await fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n  t.equal(reply.statusCode, 500);\n  t.equal(JSON.parse(reply.body).foo, 'bar');\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should preserve the status code set by the user if an expression is thrown in a sync route","suites":[],"updatePoint":{"line":420,"column":96,"index":11048},"line":420,"code":"test('should preserve the status code set by the user if an expression is thrown in a sync route', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', (_, rep) => {\n    rep.status(501);\n    /* eslint-disable-next-line */\n\n    throw {\n      foo: 'bar'\n    };\n  }); // ----\n\n  const reply = await fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n  t.equal(reply.statusCode, 501);\n  t.equal(JSON.parse(reply.body).foo, 'bar');\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"should trigger error handlers if a sync route throws any non-error object","suites":[],"updatePoint":{"line":439,"column":79,"index":11487},"line":439,"code":"test('should trigger error handlers if a sync route throws any non-error object', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', () => {\n    /* eslint-disable-next-line */\n    throw {\n      foo: 'bar'\n    };\n  });\n  fastify.setErrorHandler(async error => {\n    t.ok(error);\n    return error;\n  }); // ----\n\n  const reply = await fastify.inject({\n    method: 'GET',\n    url: '/'\n  });\n  t.equal(reply.statusCode, 500);\n  t.equal(JSON.parse(reply.body).foo, 'bar');\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"setting content-type on reply object should not hang the server case 1","suites":[],"updatePoint":{"line":460,"column":76,"index":11979},"line":460,"code":"test('setting content-type on reply object should not hang the server case 1', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.code(200).headers({\n      'content-type': 'text/plain; charset=utf-32'\n    }).send(JSON.stringify({\n      bar: 'foo',\n      baz: 'foobar'\n    }));\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"setting content-type on reply object should not hang the server case 2","suites":[],"updatePoint":{"line":479,"column":76,"index":12441},"line":479,"code":"test('setting content-type on reply object should not hang the server case 2', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.code(200).headers({\n      'content-type': 'text/plain; charset=utf-8'\n    }).send({\n      bar: 'foo',\n      baz: 'foobar'\n    });\n  });\n\n  try {\n    await fastify.listen(0);\n    const res = await fastify.inject({\n      url: '/',\n      method: 'GET'\n    });\n    t.same({\n      error: 'Internal Server Error',\n      message: 'Attempted to send payload of invalid type \\'object\\'. Expected a string or Buffer.',\n      statusCode: 500,\n      code: 'FST_ERR_REP_INVALID_PAYLOAD_TYPE'\n    }, res.json());\n  } catch (error) {\n    t.error(error);\n  } finally {\n    await fastify.close();\n  }\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"setting content-type on reply object should not hang the server case 3","suites":[],"updatePoint":{"line":509,"column":76,"index":13210},"line":509,"code":"test('setting content-type on reply object should not hang the server case 3', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.code(200).headers({\n      'content-type': 'application/json'\n    }).send({\n      bar: 'foo',\n      baz: 'foobar'\n    });\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"pipe stream inside error handler should not cause error","suites":[],"updatePoint":{"line":528,"column":61,"index":13631},"line":528,"code":"test('pipe stream inside error handler should not cause error', t => {\n  t.plan(3);\n  const location = path.join(__dirname, '..', 'package.json');\n  const json = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'package.json')).toString('utf8'));\n  const fastify = Fastify();\n  fastify.setErrorHandler((_error, _request, reply) => {\n    const stream = fs.createReadStream(location);\n    reply.code(400).type('application/json; charset=utf-8').send(stream);\n  });\n  fastify.get('/', (request, reply) => {\n    throw new Error('This is an error.');\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(JSON.parse(res.payload), json);\n  });\n});","file":"reply-error.test.js","skipped":false,"dir":"test"},{"name":"default 400 on request error","suites":[],"updatePoint":{"line":17,"column":34,"index":224},"line":17,"code":"test('default 400 on request error', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    simulate: {\n      error: true\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      message: 'Simulated',\n      statusCode: 400\n    });\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"default 400 on request error with custom error handler","suites":[],"updatePoint":{"line":45,"column":60,"index":893},"line":45,"code":"test('default 400 on request error with custom error handler', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.setErrorHandler(function (err, request, reply) {\n    t.type(request, 'object');\n    t.type(request, fastify[kRequest]);\n    reply.code(err.statusCode).type('application/json; charset=utf-8').send(err);\n  });\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    simulate: {\n      error: true\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      message: 'Simulated',\n      statusCode: 400\n    });\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"default clientError handler ignores ECONNRESET","suites":[],"updatePoint":{"line":78,"column":52,"index":1772},"line":78,"code":"test('default clientError handler ignores ECONNRESET', t => {\n  t.plan(3);\n  let logs = '';\n  let response = '';\n  const fastify = Fastify({\n    bodyLimit: 1,\n    keepAliveTimeout: 100,\n    logger: {\n      level: 'trace',\n      stream: {\n        write() {\n          logs += JSON.stringify(arguments);\n        }\n\n      }\n    }\n  });\n  fastify.get('/', (request, reply) => {\n    reply.send('OK');\n    process.nextTick(() => {\n      const error = new Error();\n      error.code = 'ECONNRESET';\n      fastify.server.emit('clientError', error, request.raw.socket);\n    });\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    fastify.server.unref();\n    const client = connect(fastify.server.address().port);\n    client.on('data', chunk => {\n      response += chunk.toString('utf-8');\n    });\n    client.on('end', () => {\n      t.match(response, /^HTTP\\/1.1 200 OK/);\n      t.notMatch(logs, /ECONNRESET/);\n    });\n    client.resume();\n    client.write('GET / HTTP/1.1\\r\\n');\n    client.write('Connection: close\\r\\n');\n    client.write('\\r\\n\\r\\n');\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"default clientError handler ignores sockets in destroyed state","suites":[],"updatePoint":{"line":120,"column":68,"index":2852},"line":120,"code":"test('default clientError handler ignores sockets in destroyed state', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    bodyLimit: 1,\n    keepAliveTimeout: 100,\n    logger: {\n      level: 'trace'\n    }\n  });\n  fastify.server.on('clientError', () => {\n    // this handler is called after default handler, so we can make sure end was not called\n    t.pass();\n  });\n  fastify.server.emit('clientError', new Error(), {\n    destroyed: true,\n\n    end() {\n      t.fail('end should not be called');\n    },\n\n    destroy() {\n      t.fail('destroy should not be called');\n    }\n\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"default clientError handler destroys sockets in writable state","suites":[],"updatePoint":{"line":146,"column":68,"index":3433},"line":146,"code":"test('default clientError handler destroys sockets in writable state', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    bodyLimit: 1,\n    keepAliveTimeout: 100\n  });\n  fastify.server.emit('clientError', new Error(), {\n    destroyed: false,\n    writable: true,\n    encrypted: true,\n\n    end() {\n      t.fail('end should not be called');\n    },\n\n    destroy() {\n      t.pass('destroy should be called');\n    }\n\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"default clientError handler destroys http sockets in non-writable state","suites":[],"updatePoint":{"line":167,"column":77,"index":3864},"line":167,"code":"test('default clientError handler destroys http sockets in non-writable state', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    bodyLimit: 1,\n    keepAliveTimeout: 100\n  });\n  fastify.server.emit('clientError', new Error(), {\n    destroyed: false,\n    writable: false,\n\n    end() {\n      t.fail('end should not be called');\n    },\n\n    destroy() {\n      t.pass('destroy should be called');\n    }\n\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"error handler binding","suites":[],"updatePoint":{"line":187,"column":27,"index":4225},"line":187,"code":"test('error handler binding', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.setErrorHandler(function (err, request, reply) {\n    t.equal(this, fastify);\n    reply.code(err.statusCode).type('application/json; charset=utf-8').send(err);\n  });\n  fastify.post('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    simulate: {\n      error: true\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(JSON.parse(res.payload), {\n      error: 'Bad Request',\n      message: 'Simulated',\n      statusCode: 400\n    });\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"encapsulated error handler binding","suites":[],"updatePoint":{"line":219,"column":40,"index":5049},"line":219,"code":"test('encapsulated error handler binding', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.register(function (app, opts, done) {\n    app.decorate('hello', 'world');\n    t.equal(app.hello, 'world');\n    app.post('/', function (req, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    app.setErrorHandler(function (err, request, reply) {\n      t.equal(this.hello, 'world');\n      reply.code(err.statusCode).type('application/json; charset=utf-8').send(err);\n    });\n    done();\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    simulate: {\n      error: true\n    },\n    body: {\n      text: '12345678901234567890123456789012345678901234567890'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(res.json(), {\n      error: 'Bad Request',\n      message: 'Simulated',\n      statusCode: 400\n    });\n    t.equal(fastify.hello, undefined);\n  });\n});","file":"request-error.test.js","skipped":false,"dir":"test"},{"name":"requestTimeout passed to server","suites":[],"updatePoint":{"line":11,"column":37,"index":160},"line":11,"code":"test('requestTimeout passed to server', t => {\n  t.plan(5);\n\n  try {\n    Fastify({\n      requestTimeout: 500.1\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  try {\n    Fastify({\n      requestTimeout: []\n    });\n    t.fail('option must be an integer');\n  } catch (err) {\n    t.ok(err);\n  }\n\n  const httpServer = Fastify({\n    requestTimeout: 1000\n  }).server;\n  t.equal(httpServer.requestTimeout, 1000);\n  const httpsServer = Fastify({\n    requestTimeout: 1000,\n    https: true\n  }).server;\n  t.equal(httpsServer.requestTimeout, 1000);\n\n  const serverFactory = (handler, _) => {\n    const server = http.createServer((req, res) => {\n      handler(req, res);\n    });\n    server.requestTimeout = 5000;\n    return server;\n  };\n\n  const customServer = Fastify({\n    requestTimeout: 4000,\n    serverFactory\n  }).server;\n  t.equal(customServer.requestTimeout, 5000);\n});","file":"requestTimeout.test.js","skipped":false,"dir":"test"},{"name":"requestTimeout should be set","suites":[],"updatePoint":{"line":56,"column":34,"index":1062},"line":56,"code":"test('requestTimeout should be set', async t => {\n  t.plan(1);\n  const initialConfig = Fastify({\n    requestTimeout: 5000\n  }).initialConfig;\n  t.same(initialConfig.requestTimeout, 5000);\n});","file":"requestTimeout.test.js","skipped":false,"dir":"test"},{"name":"requestTimeout should 0","suites":[],"updatePoint":{"line":63,"column":29,"index":1249},"line":63,"code":"test('requestTimeout should 0', async t => {\n  t.plan(1);\n  const initialConfig = Fastify().initialConfig;\n  t.same(initialConfig.requestTimeout, 0);\n});","file":"requestTimeout.test.js","skipped":false,"dir":"test"},{"name":"","suites":[],"updatePoint":{"line":24,"column":15,"index":402},"line":24,"code":"  test(`${hook}`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.post('/', {\n      [hook]: (req, reply, doneOrPayload, done) => {\n        t.pass('hook called');\n        endRouteHook(doneOrPayload, done);\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        hello: 'world'\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should be called after  hook","suites":[],"updatePoint":{"line":49,"column":58,"index":1004},"line":49,"code":"  test(`${hook} option should be called after ${hook} hook`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    const checker = Object.defineProperty({\n      calledTimes: 0\n    }, 'check', {\n      get: function () {\n        return ++this.calledTimes;\n      }\n    });\n    fastify.addHook(hook, (req, reply, doneOrPayload, done) => {\n      t.equal(checker.check, 1);\n      endRouteHook(doneOrPayload, done);\n    });\n    fastify.post('/', {\n      [hook]: (req, reply, doneOrPayload, done) => {\n        t.equal(checker.check, 2);\n        endRouteHook(doneOrPayload, done);\n      }\n    }, (req, reply) => {\n      reply.send({});\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option could accept an array of functions","suites":[],"updatePoint":{"line":81,"column":57,"index":1805},"line":81,"code":"  test(`${hook} option could accept an array of functions`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    const checker = Object.defineProperty({\n      calledTimes: 0\n    }, 'check', {\n      get: function () {\n        return ++this.calledTimes;\n      }\n    });\n    fastify.post('/', {\n      [hook]: [(req, reply, doneOrPayload, done) => {\n        t.equal(checker.check, 1);\n        endRouteHook(doneOrPayload, done);\n      }, (req, reply, doneOrPayload, done) => {\n        t.equal(checker.check, 2);\n        endRouteHook(doneOrPayload, done);\n      }]\n    }, (req, reply) => {\n      reply.send({});\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option does not interfere with  hook","suites":[],"updatePoint":{"line":112,"column":59,"index":2589},"line":112,"code":"  test(`${hook} option does not interfere with ${hook} hook`, t => {\n    t.plan(7);\n    const fastify = Fastify();\n    const checker = Object.defineProperty({\n      calledTimes: 0\n    }, 'check', {\n      get: function () {\n        return ++this.calledTimes;\n      }\n    });\n    fastify.addHook(hook, (req, reply, doneOrPayload, done) => {\n      t.equal(checker.check, 1);\n      endRouteHook(doneOrPayload, done);\n    });\n    fastify.post('/', {\n      [hook]: (req, reply, doneOrPayload, done) => {\n        t.equal(checker.check, 2);\n        endRouteHook(doneOrPayload, done);\n      }\n    }, handler);\n    fastify.post('/no', handler);\n\n    function handler(req, reply) {\n      reply.send({});\n    }\n\n    fastify.inject({\n      method: 'post',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(checker.calledTimes, 2);\n      checker.calledTimes = 0;\n      fastify.inject({\n        method: 'post',\n        url: '/no'\n      }, (err, res) => {\n        t.error(err);\n        t.equal(checker.calledTimes, 1);\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should be unique per route","suites":[],"updatePoint":{"line":157,"column":49,"index":3670},"line":157,"code":"  test(`${hook} option should be unique per route`, t => {\n    t.plan(4);\n    const fastify = Fastify();\n    fastify.post('/', {\n      [hook]: (req, reply, done) => {\n        req.hello = 'earth';\n        done();\n      }\n    }, (req, reply) => {\n      reply.send({\n        hello: req.hello\n      });\n    });\n    fastify.post('/no', (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        hello: 'earth'\n      });\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/no',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        hello: 'world'\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should handle errors","suites":[],"updatePoint":{"line":200,"column":43,"index":4581},"line":200,"code":"  test(`${hook} option should handle errors`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.post('/', {\n      [hook]: (req, reply, done) => {\n        done(new Error('kaboom'));\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.equal(res.statusCode, 500);\n      t.same(payload, {\n        message: 'kaboom',\n        error: 'Internal Server Error',\n        statusCode: 500\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should handle throwing objects","suites":[],"updatePoint":{"line":227,"column":53,"index":5228},"line":227,"code":"  test(`${hook} option should handle throwing objects`, t => {\n    t.plan(4);\n    const fastify = Fastify();\n    const myError = {\n      myError: 'kaboom'\n    };\n    fastify.setErrorHandler(async (error, request, reply) => {\n      t.same(error, myError, 'the error object throws by the user');\n      reply.send({\n        this: 'is',\n        my: 'error'\n      });\n    });\n    fastify.get('/', {\n      [hook]: async () => {\n        // eslint-disable-next-line no-throw-literal\n        throw myError;\n      }\n    }, (req, reply) => {\n      t.fail('the handler must not be called');\n    });\n    fastify.inject({\n      url: '/',\n      method: 'GET'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 500);\n      t.same(res.json(), {\n        this: 'is',\n        my: 'error'\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should handle throwing objects by default","suites":[],"updatePoint":{"line":260,"column":64,"index":6053},"line":260,"code":"  test(`${hook} option should handle throwing objects by default`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.get('/', {\n      [hook]: async () => {\n        // eslint-disable-next-line no-throw-literal\n        throw {\n          myError: 'kaboom',\n          message: 'i am an error'\n        };\n      }\n    }, (req, reply) => {\n      t.fail('the handler must not be called');\n    });\n    fastify.inject({\n      url: '/',\n      method: 'GET'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 500);\n      t.same(res.json(), {\n        myError: 'kaboom',\n        message: 'i am an error'\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should handle errors with custom status code","suites":[],"updatePoint":{"line":286,"column":67,"index":6707},"line":286,"code":"  test(`${hook} option should handle errors with custom status code`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.post('/', {\n      [hook]: (req, reply, done) => {\n        reply.code(401);\n        done(new Error('go away'));\n      }\n    }, (req, reply) => {\n      reply.send(req.body);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.equal(res.statusCode, 401);\n      t.same(payload, {\n        message: 'go away',\n        error: 'Unauthorized',\n        statusCode: 401\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should keep the context","suites":[],"updatePoint":{"line":314,"column":46,"index":7365},"line":314,"code":"  test(`${hook} option should keep the context`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.decorate('foo', 42);\n    fastify.post('/', {\n      [hook]: function (req, reply, done) {\n        t.equal(this.foo, 42);\n        this.foo += 1;\n        done();\n      }\n    }, function (req, reply) {\n      reply.send({\n        foo: this.foo\n      });\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        foo: 43\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":" option should keep the context (array)","suites":[],"updatePoint":{"line":343,"column":54,"index":8005},"line":343,"code":"  test(`${hook} option should keep the context (array)`, t => {\n    t.plan(3);\n    const fastify = Fastify();\n    fastify.decorate('foo', 42);\n    fastify.post('/', {\n      [hook]: [function (req, reply, done) {\n        t.equal(this.foo, 42);\n        this.foo += 1;\n        done();\n      }]\n    }, function (req, reply) {\n      reply.send({\n        foo: this.foo\n      });\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        hello: 'world'\n      }\n    }, (err, res) => {\n      t.error(err);\n      const payload = JSON.parse(res.payload);\n      t.same(payload, {\n        foo: 43\n      });\n    });\n  });","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"preValidation option should be called before preHandler hook","suites":[],"updatePoint":{"line":385,"column":66,"index":9048},"line":385,"code":"test('preValidation option should be called before preHandler hook', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preHandler', (req, reply, done) => {\n    t.ok(req.called);\n    done();\n  });\n  fastify.post('/', {\n    preValidation: (req, reply, done) => {\n      req.called = true;\n      done();\n    }\n  }, (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"preSerialization option should be able to modify the payload","suites":[],"updatePoint":{"line":414,"column":66,"index":9667},"line":414,"code":"test('preSerialization option should be able to modify the payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/only', {\n    preSerialization: (req, reply, payload, done) => {\n      done(null, {\n        hello: 'another world'\n      });\n    }\n  }, (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/only'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'another world'\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing option should be called before preValidation hook","suites":[],"updatePoint":{"line":439,"column":66,"index":10219},"line":439,"code":"test('preParsing option should be called before preValidation hook', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preValidation', (req, reply, done) => {\n    t.ok(req.called);\n    done();\n  });\n  fastify.post('/', {\n    preParsing: (req, reply, done) => {\n      req.called = true;\n      done();\n    }\n  }, (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"preParsing option should be able to modify the payload","suites":[],"updatePoint":{"line":468,"column":60,"index":10832},"line":468,"code":"test('preParsing option should be able to modify the payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/only', {\n    preParsing: (req, reply, payload, done) => {\n      const stream = new Readable();\n      stream.receivedEncodedLength = parseInt(req.headers['content-length'], 10);\n      stream.push(JSON.stringify({\n        hello: 'another world'\n      }));\n      stream.push(null);\n      done(null, stream);\n    }\n  }, (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/only',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'another world'\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"onRequest option should be called before preParsing","suites":[],"updatePoint":{"line":498,"column":57,"index":11581},"line":498,"code":"test('onRequest option should be called before preParsing', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.addHook('preParsing', (req, reply, done) => {\n    t.ok(req.called);\n    done();\n  });\n  fastify.post('/', {\n    onRequest: (req, reply, done) => {\n      req.called = true;\n      done();\n    }\n  }, (req, reply) => {\n    reply.send(req.body);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    const payload = JSON.parse(res.payload);\n    t.same(payload, {\n      hello: 'world'\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"onTimeout on route","suites":[],"updatePoint":{"line":527,"column":24,"index":12154},"line":527,"code":"test('onTimeout on route', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    connectionTimeout: 500\n  });\n  fastify.get('/timeout', {\n    async handler(request, reply) {},\n\n    onTimeout(request, reply, done) {\n      t.pass('onTimeout called');\n      done();\n    }\n\n  });\n  fastify.listen(0, (err, address) => {\n    t.error(err);\n    t.teardown(() => fastify.close());\n    sget({\n      method: 'GET',\n      url: `${address}/timeout`\n    }, (err, response, body) => {\n      t.type(err, Error);\n      t.equal(err.message, 'socket hang up');\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"onError on route","suites":[],"updatePoint":{"line":553,"column":22,"index":12711},"line":553,"code":"test('onError on route', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const err = new Error('kaboom');\n  fastify.get('/', {\n    onError(request, reply, error, done) {\n      t.match(error, err);\n      done();\n    }\n\n  }, (req, reply) => {\n    reply.send(err);\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      error: 'Internal Server Error',\n      message: 'kaboom',\n      statusCode: 500\n    });\n  });\n});","file":"route-hooks.test.js","skipped":false,"dir":"test"},{"name":"Prefix options should add a prefix for all the routes inside a register / 1","suites":[],"updatePoint":{"line":9,"column":81,"index":178},"line":9,"code":"test('Prefix options should add a prefix for all the routes inside a register / 1', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      route: '/first'\n    });\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/first', (req, reply) => {\n      reply.send({\n        route: '/v1/first'\n      });\n    });\n    fastify.register(function (fastify, opts, done) {\n      fastify.get('/first', (req, reply) => {\n        reply.send({\n          route: '/v1/v2/first'\n        });\n      });\n      done();\n    }, {\n      prefix: '/v2'\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/first'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/first'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/first'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/first'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/v2/first'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/v2/first'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix options should add a prefix for all the routes inside a register / 2","suites":[],"updatePoint":{"line":65,"column":81,"index":1364},"line":65,"code":"test('Prefix options should add a prefix for all the routes inside a register / 2', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/first', (req, reply) => {\n      reply.send({\n        route: '/v1/first'\n      });\n    });\n    fastify.get('/second', (req, reply) => {\n      reply.send({\n        route: '/v1/second'\n      });\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/first'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/first'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/second'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/second'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix options should add a prefix for all the chained routes inside a register / 3","suites":[],"updatePoint":{"line":102,"column":89,"index":2174},"line":102,"code":"test('Prefix options should add a prefix for all the chained routes inside a register / 3', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/first', (req, reply) => {\n      reply.send({\n        route: '/v1/first'\n      });\n    }).get('/second', (req, reply) => {\n      reply.send({\n        route: '/v1/second'\n      });\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/first'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/first'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/second'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/second'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix should support parameters as well","suites":[],"updatePoint":{"line":138,"column":46,"index":2928},"line":138,"code":"test('Prefix should support parameters as well', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/hello', (req, reply) => {\n      reply.send({\n        id: req.params.id\n      });\n    });\n    done();\n  }, {\n    prefix: '/v1/:id'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/param/hello'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      id: 'param'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix should support /","suites":[],"updatePoint":{"line":161,"column":29,"index":3393},"line":161,"code":"test('Prefix should support /', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix without /","suites":[],"updatePoint":{"line":184,"column":22,"index":3830},"line":184,"code":"test('Prefix without /', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    prefix: 'v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix with trailing /","suites":[],"updatePoint":{"line":207,"column":28,"index":4272},"line":207,"code":"test('Prefix with trailing /', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/route1', (req, reply) => {\n      reply.send({\n        hello: 'world1'\n      });\n    });\n    fastify.get('route2', (req, reply) => {\n      reply.send({\n        hello: 'world2'\n      });\n    });\n    fastify.register(function (fastify, opts, done) {\n      fastify.get('/route3', (req, reply) => {\n        reply.send({\n          hello: 'world3'\n        });\n      });\n      done();\n    }, {\n      prefix: '/inner/'\n    });\n    done();\n  }, {\n    prefix: '/v1/'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/route1'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world1'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/route2'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world2'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/inner/route3'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world3'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Prefix works multiple levels deep","suites":[],"updatePoint":{"line":263,"column":39,"index":5424},"line":263,"code":"test('Prefix works multiple levels deep', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.register(function (fastify, opts, done) {\n      fastify.register(function (fastify, opts, done) {\n        fastify.register(function (fastify, opts, done) {\n          fastify.get('/', (req, reply) => {\n            reply.send({\n              hello: 'world'\n            });\n          });\n          done();\n        }, {\n          prefix: '/v3'\n        });\n        done();\n      }); // No prefix on this level\n\n      done();\n    }, {\n      prefix: 'v2'\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/v2/v3'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Different register - encapsulation check","suites":[],"updatePoint":{"line":300,"column":46,"index":6260},"line":300,"code":"test('Different register - encapsulation check', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/first', (req, reply) => {\n    reply.send({\n      route: '/first'\n    });\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.register(function (f, opts, done) {\n      f.get('/', (req, reply) => {\n        reply.send({\n          route: '/v1/v2'\n        });\n      });\n      done();\n    }, {\n      prefix: '/v2'\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.register(function (instance, opts, done) {\n    instance.register(function (f, opts, done) {\n      f.get('/', (req, reply) => {\n        reply.send({\n          route: '/v3/v4'\n        });\n      });\n      done();\n    }, {\n      prefix: '/v4'\n    });\n    done();\n  }, {\n    prefix: '/v3'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/v2'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v1/v2'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v3/v4'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      route: '/v3/v4'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"Can retrieve prefix within encapsulated instances","suites":[],"updatePoint":{"line":357,"column":55,"index":7404},"line":357,"code":"test('Can retrieve prefix within encapsulated instances', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(function (instance, opts, done) {\n    instance.get('/one', function (req, reply) {\n      reply.send(instance.prefix);\n    });\n    instance.register(function (instance, opts, done) {\n      instance.get('/two', function (req, reply) {\n        reply.send(instance.prefix);\n      });\n      done();\n    }, {\n      prefix: '/v2'\n    });\n    done();\n  }, {\n    prefix: '/v1'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/one'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '/v1');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/v1/v2/two'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '/v1/v2');\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"matches both /prefix and /prefix/ with a / route","suites":[],"updatePoint":{"line":391,"column":54,"index":8183},"line":391,"code":"test('matches both /prefix and /prefix/ with a / route', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"prefix \"/prefix/\" does not match \"/prefix\" with a / route","suites":[],"updatePoint":{"line":423,"column":63,"index":8839},"line":423,"code":"test('prefix \"/prefix/\" does not match \"/prefix\" with a / route', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    prefix: '/prefix/'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"matches both /prefix and /prefix/ with a / route - ignoreTrailingSlash: true","suites":[],"updatePoint":{"line":453,"column":82,"index":9482},"line":453,"code":"test('matches both /prefix and /prefix/ with a / route - ignoreTrailingSlash: true', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: true\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.get('/', (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    });\n    done();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"matches both /prefix and /prefix/  with a / route - prefixTrailingSlash: \"both\", ignoreTrailingSlash: false","suites":[],"updatePoint":{"line":487,"column":113,"index":10223},"line":487,"code":"test('matches both /prefix and /prefix/  with a / route - prefixTrailingSlash: \"both\", ignoreTrailingSlash: false', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: false\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.route({\n      method: 'GET',\n      url: '/',\n      prefixTrailingSlash: 'both',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    done();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"returns 404 status code with /prefix/ and / route - prefixTrailingSlash: \"both\" (default), ignoreTrailingSlash: true","suites":[],"updatePoint":{"line":526,"column":122,"index":11074},"line":526,"code":"test('returns 404 status code with /prefix/ and / route - prefixTrailingSlash: \"both\" (default), ignoreTrailingSlash: true', t => {\n  t.plan(2);\n  const fastify = Fastify({\n    ignoreTrailingSlash: true\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.route({\n      method: 'GET',\n      url: '/',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    done();\n  }, {\n    prefix: '/prefix/'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix//'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      error: 'Not Found',\n      message: 'Route GET:/prefix// not found',\n      statusCode: 404\n    });\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"matches only /prefix  with a / route - prefixTrailingSlash: \"no-slash\", ignoreTrailingSlash: false","suites":[],"updatePoint":{"line":557,"column":104,"index":11779},"line":557,"code":"test('matches only /prefix  with a / route - prefixTrailingSlash: \"no-slash\", ignoreTrailingSlash: false', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: false\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.route({\n      method: 'GET',\n      url: '/',\n      prefixTrailingSlash: 'no-slash',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    done();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(JSON.parse(res.payload).statusCode, 404);\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"matches only /prefix/  with a / route - prefixTrailingSlash: \"slash\", ignoreTrailingSlash: false","suites":[],"updatePoint":{"line":594,"column":102,"index":12601},"line":594,"code":"test('matches only /prefix/  with a / route - prefixTrailingSlash: \"slash\", ignoreTrailingSlash: false', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: false\n  });\n  fastify.register(function (fastify, opts, done) {\n    fastify.route({\n      method: 'GET',\n      url: '/',\n      prefixTrailingSlash: 'slash',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    done();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/prefix'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(JSON.parse(res.payload).statusCode, 404);\n  });\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"calls onRoute only once when prefixing","suites":[],"updatePoint":{"line":631,"column":44,"index":13362},"line":631,"code":"test('calls onRoute only once when prefixing', async t => {\n  t.plan(1);\n  const fastify = Fastify({\n    ignoreTrailingSlash: false\n  });\n  let onRouteCalled = 0;\n  fastify.register(function (fastify, opts, next) {\n    fastify.addHook('onRoute', () => {\n      onRouteCalled++;\n    });\n    fastify.route({\n      method: 'GET',\n      url: '/',\n      prefixTrailingSlash: 'both',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  await fastify.ready();\n  t.same(onRouteCalled, 1);\n});","file":"route-prefix.test.js","skipped":false,"dir":"test"},{"name":"route","suites":[],"updatePoint":{"line":23,"column":11,"index":360},"line":23,"code":"test('route', t => {\n  t.plan(9);\n  const test = t.test;\n  const fastify = Fastify();\n  test('route - get', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: 'GET',\n        url: '/',\n        schema: {\n          response: {\n            '2xx': {\n              type: 'object',\n              properties: {\n                hello: {\n                  type: 'string'\n                }\n              }\n            }\n          }\n        },\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });\n  test('missing schema - route', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: 'GET',\n        url: '/missing',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });\n  test('invalid handler attribute - route', t => {\n    t.plan(1);\n\n    try {\n      fastify.get('/', {\n        handler: 'not a function'\n      }, () => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });\n  test('Multiple methods', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: ['GET', 'DELETE'],\n        url: '/multiple',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });\n  test('Add multiple methods', t => {\n    t.plan(1);\n\n    try {\n      fastify.get('/add-multiple', function (req, reply) {\n        reply.send({\n          hello: 'Bob!'\n        });\n      });\n      fastify.route({\n        method: ['PUT', 'DELETE'],\n        url: '/add-multiple',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });\n  fastify.listen(0, function (err) {\n    if (err) t.error(err);\n    fastify.server.unref();\n    test('cannot add another route after binding', t => {\n      t.plan(1);\n\n      try {\n        fastify.route({\n          method: 'GET',\n          url: '/another-get-route',\n          handler: function (req, reply) {\n            reply.send({\n              hello: 'world'\n            });\n          }\n        });\n        t.fail();\n      } catch (e) {\n        t.pass();\n      }\n    });\n    test('route - get', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });\n    test('route - missing schema', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/missing'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });\n    test('route - multiple methods', t => {\n      t.plan(6);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/multiple'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n      sget({\n        method: 'DELETE',\n        url: 'http://localhost:' + fastify.server.address().port + '/multiple'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route - get","suites":[],"updatePoint":{"line":27,"column":19,"index":454},"line":27,"code":"  test('route - get', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: 'GET',\n        url: '/',\n        schema: {\n          response: {\n            '2xx': {\n              type: 'object',\n              properties: {\n                hello: {\n                  type: 'string'\n                }\n              }\n            }\n          }\n        },\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"missing schema - route","suites":[],"updatePoint":{"line":57,"column":30,"index":1018},"line":57,"code":"  test('missing schema - route', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: 'GET',\n        url: '/missing',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"invalid handler attribute - route","suites":[],"updatePoint":{"line":75,"column":41,"index":1352},"line":75,"code":"  test('invalid handler attribute - route', t => {\n    t.plan(1);\n\n    try {\n      fastify.get('/', {\n        handler: 'not a function'\n      }, () => {});\n      t.fail();\n    } catch (e) {\n      t.pass();\n    }\n  });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Multiple methods","suites":[],"updatePoint":{"line":87,"column":24,"index":1553},"line":87,"code":"  test('Multiple methods', t => {\n    t.plan(1);\n\n    try {\n      fastify.route({\n        method: ['GET', 'DELETE'],\n        url: '/multiple',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Add multiple methods","suites":[],"updatePoint":{"line":105,"column":28,"index":1887},"line":105,"code":"  test('Add multiple methods', t => {\n    t.plan(1);\n\n    try {\n      fastify.get('/add-multiple', function (req, reply) {\n        reply.send({\n          hello: 'Bob!'\n        });\n      });\n      fastify.route({\n        method: ['PUT', 'DELETE'],\n        url: '/add-multiple',\n        handler: function (req, reply) {\n          reply.send({\n            hello: 'world'\n          });\n        }\n      });\n      t.pass();\n    } catch (e) {\n      t.fail();\n    }\n  });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"cannot add another route after binding","suites":[],"updatePoint":{"line":131,"column":48,"index":2463},"line":131,"code":"    test('cannot add another route after binding', t => {\n      t.plan(1);\n\n      try {\n        fastify.route({\n          method: 'GET',\n          url: '/another-get-route',\n          handler: function (req, reply) {\n            reply.send({\n              hello: 'world'\n            });\n          }\n        });\n        t.fail();\n      } catch (e) {\n        t.pass();\n      }\n    });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route - get","suites":[],"updatePoint":{"line":149,"column":21,"index":2819},"line":149,"code":"    test('route - get', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route - missing schema","suites":[],"updatePoint":{"line":162,"column":32,"index":3170},"line":162,"code":"    test('route - missing schema', t => {\n      t.plan(3);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/missing'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route - multiple methods","suites":[],"updatePoint":{"line":175,"column":34,"index":3536},"line":175,"code":"    test('route - multiple methods', t => {\n      t.plan(6);\n      sget({\n        method: 'GET',\n        url: 'http://localhost:' + fastify.server.address().port + '/multiple'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n      sget({\n        method: 'DELETE',\n        url: 'http://localhost:' + fastify.server.address().port + '/multiple'\n      }, (err, response, body) => {\n        t.error(err);\n        t.equal(response.statusCode, 200);\n        t.same(JSON.parse(body), {\n          hello: 'world'\n        });\n      });\n    });","file":"route.test.js","skipped":false,"dir":"test"},{"name":"invalid schema - route","suites":[],"updatePoint":{"line":200,"column":28,"index":4208},"line":200,"code":"test('invalid schema - route', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    handler: () => {},\n    method: 'GET',\n    url: '/invalid',\n    schema: {\n      querystring: {\n        id: 'string'\n      }\n    }\n  });\n  fastify.after(err => {\n    t.notOk(err, 'the error is throw on preReady');\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD');\n    t.match(err.message, /Failed building the validation schema for GET: \\/invalid/);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"same route definition object on multiple prefixes","suites":[],"updatePoint":{"line":221,"column":55,"index":4731},"line":221,"code":"test('same route definition object on multiple prefixes', async t => {\n  t.plan(2);\n  const routeObject = {\n    handler: () => {},\n    method: 'GET',\n    url: '/simple'\n  };\n  const fastify = Fastify();\n  fastify.register(async function (f) {\n    f.addHook('onRoute', routeOptions => {\n      t.equal(routeOptions.url, '/v1/simple');\n    });\n    f.route(routeObject);\n  }, {\n    prefix: '/v1'\n  });\n  fastify.register(async function (f) {\n    f.addHook('onRoute', routeOptions => {\n      t.equal(routeOptions.url, '/v2/simple');\n    });\n    f.route(routeObject);\n  }, {\n    prefix: '/v2'\n  });\n  await fastify.ready();\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"path can be specified in place of uri","suites":[],"updatePoint":{"line":247,"column":43,"index":5341},"line":247,"code":"test('path can be specified in place of uri', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    path: '/path',\n    handler: function (req, reply) {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  const reqOpts = {\n    method: 'GET',\n    url: '/path'\n  };\n  fastify.inject(reqOpts, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"invalid bodyLimit option - route","suites":[],"updatePoint":{"line":271,"column":38,"index":5820},"line":271,"code":"test('invalid bodyLimit option - route', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.route({\n      bodyLimit: false,\n      method: 'PUT',\n      handler: () => null\n    });\n    t.fail('bodyLimit must be an integer');\n  } catch (err) {\n    t.equal(err.message, \"'bodyLimit' option must be an integer > 0. Got 'false'\");\n  }\n\n  try {\n    fastify.post('/url', {\n      bodyLimit: 10000.1\n    }, () => null);\n    t.fail('bodyLimit must be an integer');\n  } catch (err) {\n    t.equal(err.message, \"'bodyLimit' option must be an integer > 0. Got '10000.1'\");\n  }\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"handler function in options of shorthand route should works correctly","suites":[],"updatePoint":{"line":295,"column":75,"index":6442},"line":295,"code":"test('handler function in options of shorthand route should works correctly', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/foo', {\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/foo'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"does not mutate joi schemas","suites":[],"updatePoint":{"line":316,"column":33,"index":6850},"line":316,"code":"test('does not mutate joi schemas', t => {\n  t.plan(4);\n  const fastify = Fastify();\n\n  function validatorCompiler({\n    schema,\n    method,\n    url,\n    httpPart\n  }) {\n    // Needed to extract the params part,\n    // without the JSON-schema encapsulation\n    // that is automatically added by the short\n    // form of params.\n    schema = joi.object(schema.properties);\n    return validateHttpData;\n\n    function validateHttpData(data) {\n      return schema.validate(data);\n    }\n  }\n\n  fastify.setValidatorCompiler(validatorCompiler);\n  fastify.route({\n    path: '/foo/:an_id',\n    method: 'GET',\n    schema: {\n      params: {\n        an_id: joi.number()\n      }\n    },\n\n    handler(req, res) {\n      t.same(req.params, {\n        an_id: 42\n      });\n      res.send({\n        hello: 'world'\n      });\n    }\n\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/foo/42'\n  }, (err, result) => {\n    t.error(err);\n    t.equal(result.statusCode, 200);\n    t.same(JSON.parse(result.payload), {\n      hello: 'world'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"multiple routes with one schema","suites":[],"updatePoint":{"line":369,"column":37,"index":7886},"line":369,"code":"test('multiple routes with one schema', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  const schema = {\n    query: {\n      id: {\n        type: 'number'\n      }\n    }\n  };\n  fastify.route({\n    schema,\n    method: 'GET',\n    path: '/first/:id',\n\n    handler(req, res) {\n      res.send({\n        hello: 'world'\n      });\n    }\n\n  });\n  fastify.route({\n    schema,\n    method: 'GET',\n    path: '/second/:id',\n\n    handler(req, res) {\n      res.send({\n        hello: 'world'\n      });\n    }\n\n  });\n  fastify.ready(error => {\n    t.error(error);\n    t.same(schema, schema);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route error handler overrides default error handler","suites":[],"updatePoint":{"line":408,"column":57,"index":8489},"line":408,"code":"test('route error handler overrides default error handler', t => {\n  t.plan(4);\n  const fastify = Fastify();\n\n  const customRouteErrorHandler = (error, request, reply) => {\n    t.equal(error.message, 'Wrong Pot Error');\n    reply.code(418).send({\n      message: 'Make a brew',\n      statusCode: 418,\n      error: 'Wrong Pot Error'\n    });\n  };\n\n  fastify.route({\n    method: 'GET',\n    path: '/coffee',\n    handler: (req, res) => {\n      res.send(new Error('Wrong Pot Error'));\n    },\n    errorHandler: customRouteErrorHandler\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same(JSON.parse(res.payload), {\n      message: 'Make a brew',\n      statusCode: 418,\n      error: 'Wrong Pot Error'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route error handler does not affect other routes","suites":[],"updatePoint":{"line":442,"column":54,"index":9293},"line":442,"code":"test('route error handler does not affect other routes', t => {\n  t.plan(3);\n  const fastify = Fastify();\n\n  const customRouteErrorHandler = (error, request, reply) => {\n    t.equal(error.message, 'Wrong Pot Error');\n    reply.code(418).send({\n      message: 'Make a brew',\n      statusCode: 418,\n      error: 'Wrong Pot Error'\n    });\n  };\n\n  fastify.route({\n    method: 'GET',\n    path: '/coffee',\n    handler: (req, res) => {\n      res.send(new Error('Wrong Pot Error'));\n    },\n    errorHandler: customRouteErrorHandler\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/tea',\n    handler: (req, res) => {\n      res.send(new Error('No tea today'));\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/tea'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 500);\n    t.same(JSON.parse(res.payload), {\n      message: 'No tea today',\n      statusCode: 500,\n      error: 'Internal Server Error'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"async error handler for a route","suites":[],"updatePoint":{"line":483,"column":37,"index":10223},"line":483,"code":"test('async error handler for a route', t => {\n  t.plan(4);\n  const fastify = Fastify();\n\n  const customRouteErrorHandler = async (error, request, reply) => {\n    t.equal(error.message, 'Delayed Pot Error');\n    reply.code(418);\n    return {\n      message: 'Make a brew sometime later',\n      statusCode: 418,\n      error: 'Delayed Pot Error'\n    };\n  };\n\n  fastify.route({\n    method: 'GET',\n    path: '/late-coffee',\n    handler: (req, res) => {\n      res.send(new Error('Delayed Pot Error'));\n    },\n    errorHandler: customRouteErrorHandler\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/late-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same(JSON.parse(res.payload), {\n      message: 'Make a brew sometime later',\n      statusCode: 418,\n      error: 'Delayed Pot Error'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route error handler overrides global custom error handler","suites":[],"updatePoint":{"line":518,"column":63,"index":11096},"line":518,"code":"test('route error handler overrides global custom error handler', t => {\n  t.plan(4);\n  const fastify = Fastify();\n\n  const customGlobalErrorHandler = (error, request, reply) => {\n    t.error(error);\n    reply.code(429).send({\n      message: 'Too much coffee'\n    });\n  };\n\n  const customRouteErrorHandler = (error, request, reply) => {\n    t.equal(error.message, 'Wrong Pot Error');\n    reply.code(418).send({\n      message: 'Make a brew',\n      statusCode: 418,\n      error: 'Wrong Pot Error'\n    });\n  };\n\n  fastify.setErrorHandler(customGlobalErrorHandler);\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    handler: (req, res) => {\n      res.send(new Error('Wrong Pot Error'));\n    },\n    errorHandler: customRouteErrorHandler\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 418);\n    t.same(JSON.parse(res.payload), {\n      message: 'Make a brew',\n      statusCode: 418,\n      error: 'Wrong Pot Error'\n    });\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"throws when route with empty url","suites":[],"updatePoint":{"line":560,"column":38,"index":12105},"line":560,"code":"test('throws when route with empty url', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    await fastify.route({\n      method: 'GET',\n      url: '',\n      handler: (req, res) => {\n        res.send('hi!');\n      }\n    }).ready();\n  } catch (err) {\n    t.equal(err.message, 'The first character of a path should be `/` or `*`');\n  }\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"throws when route with empty url in shorthand declaration","suites":[],"updatePoint":{"line":576,"column":63,"index":12483},"line":576,"code":"test('throws when route with empty url in shorthand declaration', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    await fastify.get('', async function handler() {\n      return {};\n    }).ready();\n  } catch (err) {\n    t.equal(err.message, 'The path could not be empty');\n  }\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"throws when route-level error handler is not a function","suites":[],"updatePoint":{"line":588,"column":61,"index":12780},"line":588,"code":"test('throws when route-level error handler is not a function', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.route({\n      method: 'GET',\n      url: '/tea',\n      handler: (req, res) => {\n        res.send('hi!');\n      },\n      errorHandler: 'teapot'\n    });\n  } catch (err) {\n    t.equal(err.message, 'Error Handler for GET:/tea route, if defined, must be a function');\n  }\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Creates a HEAD route for each GET one","suites":[],"updatePoint":{"line":605,"column":43,"index":13166},"line":605,"code":"test('Creates a HEAD route for each GET one', t => {\n  t.plan(8);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    handler: (req, reply) => {\n      reply.send({\n        here: 'is coffee'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/some-light',\n    handler: (req, reply) => {\n      reply.send('Get some light!');\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/some-light'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'text/plain; charset=utf-8');\n    t.equal(res.body, '');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Creates a HEAD route for a GET one with prefixTrailingSlash","suites":[],"updatePoint":{"line":645,"column":65,"index":14114},"line":645,"code":"test('Creates a HEAD route for a GET one with prefixTrailingSlash', async t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const arr = [];\n  fastify.register((instance, opts, next) => {\n    instance.addHook('onRoute', routeOptions => {\n      arr.push(`${routeOptions.method} ${routeOptions.url}`);\n    });\n    instance.route({\n      method: 'GET',\n      path: '/',\n      exposeHeadRoute: true,\n      prefixTrailingSlash: 'both',\n      handler: (req, reply) => {\n        reply.send({\n          here: 'is coffee'\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/v1'\n  });\n  await fastify.ready();\n  t.ok(true);\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Will not create a HEAD route that is not GET","suites":[],"updatePoint":{"line":671,"column":50,"index":14726},"line":671,"code":"test('Will not create a HEAD route that is not GET', t => {\n  t.plan(11);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    handler: (req, reply) => {\n      reply.send({\n        here: 'is coffee'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/some-light',\n    handler: (req, reply) => {\n      reply.send();\n    }\n  });\n  fastify.route({\n    method: 'POST',\n    path: '/something',\n    handler: (req, reply) => {\n      reply.send({\n        look: 'It is something!'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.same(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/some-light'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], undefined);\n    t.equal(res.headers['content-length'], '0');\n    t.equal(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/something'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD route should handle properly each response type","suites":[],"updatePoint":{"line":728,"column":58,"index":15993},"line":728,"code":"test('HEAD route should handle properly each response type', t => {\n  t.plan(25);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  const resString = 'Found me!';\n  const resJSON = {\n    here: 'is Johnny'\n  };\n  const resBuffer = Buffer.from('I am a buffer!');\n  const resStream = stream.Readable.from('I am a stream!');\n  fastify.route({\n    method: 'GET',\n    path: '/json',\n    handler: (req, reply) => {\n      reply.send(resJSON);\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/string',\n    handler: (req, reply) => {\n      reply.send(resString);\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/buffer',\n    handler: (req, reply) => {\n      reply.send(resBuffer);\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/buffer-with-content-type',\n    handler: (req, reply) => {\n      reply.headers({\n        'content-type': 'image/jpeg'\n      });\n      reply.send(resBuffer);\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/stream',\n    handler: (req, reply) => {\n      return resStream;\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/json'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.equal(res.headers['content-length'], `${Buffer.byteLength(JSON.stringify(resJSON))}`);\n    t.same(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/string'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'text/plain; charset=utf-8');\n    t.equal(res.headers['content-length'], `${Buffer.byteLength(resString)}`);\n    t.equal(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/buffer'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/buffer-with-content-type'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'image/jpeg');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/stream'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], undefined);\n    t.equal(res.body, '');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD route should respect custom onSend handlers","suites":[],"updatePoint":{"line":828,"column":54,"index":18623},"line":828,"code":"test('HEAD route should respect custom onSend handlers', t => {\n  t.plan(6);\n  let counter = 0;\n  const resBuffer = Buffer.from('I am a coffee!');\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n\n  const customOnSend = (res, reply, payload, done) => {\n    counter = counter + 1;\n    done(null, payload);\n  };\n\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    handler: (req, reply) => {\n      reply.send(resBuffer);\n    },\n    onSend: [customOnSend, customOnSend]\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n    t.equal(counter, 2);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"route onSend can be function or array of functions","suites":[],"updatePoint":{"line":861,"column":56,"index":19468},"line":861,"code":"test('route onSend can be function or array of functions', t => {\n  t.plan(12);\n  const counters = {\n    single: 0,\n    multiple: 0\n  };\n  const resBuffer = Buffer.from('I am a coffee!');\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/coffee',\n    handler: () => resBuffer,\n    onSend: (res, reply, payload, done) => {\n      counters.single += 1;\n      done(null, payload);\n    }\n  });\n\n  const customOnSend = (res, reply, payload, done) => {\n    counters.multiple += 1;\n    done(null, payload);\n  };\n\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    handler: () => resBuffer,\n    onSend: [customOnSend, customOnSend]\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n    t.equal(counters.single, 1);\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n    t.equal(counters.multiple, 2);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"no warning for exposeHeadRoute","suites":[],"updatePoint":{"line":915,"column":36,"index":20848},"line":915,"code":"test('no warning for exposeHeadRoute', async t => {\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    exposeHeadRoute: true,\n\n    async handler() {\n      return 'hello world';\n    }\n\n  });\n\n  const listener = w => {\n    t.fail('no warning');\n  };\n\n  process.on('warning', listener);\n  await fastify.listen(0);\n  process.removeListener('warning', listener);\n  await fastify.close();\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD route should handle stream.on('error')","suites":[],"updatePoint":{"line":937,"column":49,"index":21293},"line":937,"code":"test(\"HEAD route should handle stream.on('error')\", t => {\n  t.plan(6);\n  const resStream = stream.Readable.from('Hello with error!');\n  const logStream = split(JSON.parse);\n  const expectedError = new Error('Hello!');\n  const fastify = Fastify({\n    logger: {\n      stream: logStream,\n      level: 'error'\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/more-coffee',\n    exposeHeadRoute: true,\n    handler: (req, reply) => {\n      process.nextTick(() => resStream.emit('error', expectedError));\n      return resStream;\n    }\n  });\n  logStream.once('data', line => {\n    const {\n      message,\n      stack\n    } = expectedError;\n    t.same(line.err, {\n      type: 'Error',\n      message,\n      stack\n    });\n    t.equal(line.msg, 'Error on Stream found for HEAD route');\n    t.equal(line.level, 50);\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/more-coffee'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD route should not be exposed by default","suites":[],"updatePoint":{"line":979,"column":49,"index":22333},"line":979,"code":"test('HEAD route should not be exposed by default', t => {\n  t.plan(7);\n  const resStream = stream.Readable.from('Hello with error!');\n  const resJson = {\n    hello: 'world'\n  };\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    path: '/without-flag',\n    handler: (req, reply) => {\n      return resStream;\n    }\n  });\n  fastify.route({\n    exposeHeadRoute: true,\n    method: 'GET',\n    path: '/with-flag',\n    handler: (req, reply) => {\n      return resJson;\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/without-flag'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 404);\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/with-flag'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/json; charset=utf-8');\n    t.equal(res.headers['content-length'], `${Buffer.byteLength(JSON.stringify(resJson))}`);\n    t.equal(res.body, '');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD route should be exposed if route exposeHeadRoute is set","suites":[],"updatePoint":{"line":1019,"column":66,"index":23334},"line":1019,"code":"test('HEAD route should be exposed if route exposeHeadRoute is set', t => {\n  t.plan(7);\n  const resBuffer = Buffer.from('I am a coffee!');\n  const resJson = {\n    hello: 'world'\n  };\n  const fastify = Fastify({\n    exposeHeadRoutes: false\n  });\n  fastify.route({\n    exposeHeadRoute: true,\n    method: 'GET',\n    path: '/one',\n    handler: (req, reply) => {\n      return resBuffer;\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/two',\n    handler: (req, reply) => {\n      return resJson;\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/one'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/octet-stream');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.body, '');\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/two'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Set a custom HEAD route before GET one without disabling exposeHeadRoutes (global)","suites":[],"updatePoint":{"line":1061,"column":88,"index":24319},"line":1061,"code":"test('Set a custom HEAD route before GET one without disabling exposeHeadRoutes (global)', t => {\n  t.plan(6);\n  const resBuffer = Buffer.from('I am a coffee!');\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.route({\n    method: 'HEAD',\n    path: '/one',\n    handler: (req, reply) => {\n      reply.header('content-type', 'application/pdf');\n      reply.header('content-length', `${resBuffer.byteLength}`);\n      reply.header('x-custom-header', 'some-custom-header');\n      reply.send();\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    path: '/one',\n    handler: (req, reply) => {\n      return resBuffer;\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/one'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/pdf');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.headers['x-custom-header'], 'some-custom-header');\n    t.equal(res.body, '');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Set a custom HEAD route before GET one without disabling exposeHeadRoutes (route)","suites":[],"updatePoint":{"line":1096,"column":87,"index":25331},"line":1096,"code":"test('Set a custom HEAD route before GET one without disabling exposeHeadRoutes (route)', t => {\n  t.plan(7);\n\n  function onWarning(code) {\n    t.equal(code, 'FSTDEP007');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const route = proxyquire('../lib/route', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/route.js': route\n  })();\n  const resBuffer = Buffer.from('I am a coffee!');\n  fastify.route({\n    method: 'HEAD',\n    path: '/one',\n    handler: (req, reply) => {\n      reply.header('content-type', 'application/pdf');\n      reply.header('content-length', `${resBuffer.byteLength}`);\n      reply.header('x-custom-header', 'some-custom-header');\n      reply.send();\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    exposeHeadRoute: true,\n    path: '/one',\n    handler: (req, reply) => {\n      return resBuffer;\n    }\n  });\n  fastify.inject({\n    method: 'HEAD',\n    url: '/one'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers['content-type'], 'application/pdf');\n    t.equal(res.headers['content-length'], `${resBuffer.byteLength}`);\n    t.equal(res.headers['x-custom-header'], 'some-custom-header');\n    t.equal(res.body, '');\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD routes properly auto created for GET routes when prefixTrailingSlash: 'no-slash'","suites":[],"updatePoint":{"line":1143,"column":93,"index":26577},"line":1143,"code":"test('HEAD routes properly auto created for GET routes when prefixTrailingSlash: \\'no-slash\\'', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register(function routes(f, opts, next) {\n    f.route({\n      method: 'GET',\n      url: '/',\n      exposeHeadRoute: true,\n      prefixTrailingSlash: 'no-slash',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  fastify.inject({\n    url: '/prefix/prefix',\n    method: 'HEAD'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"HEAD routes properly auto created for GET routes when prefixTrailingSlash: 'both'","suites":[],"updatePoint":{"line":1170,"column":89,"index":27191},"line":1170,"code":"test('HEAD routes properly auto created for GET routes when prefixTrailingSlash: \\'both\\'', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.register(function routes(f, opts, next) {\n    f.route({\n      method: 'GET',\n      url: '/',\n      exposeHeadRoute: true,\n      prefixTrailingSlash: 'both',\n      handler: (req, reply) => {\n        reply.send({\n          hello: 'world'\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  const doublePrefixReply = await fastify.inject({\n    url: '/prefix/prefix',\n    method: 'HEAD'\n  });\n  const trailingSlashReply = await fastify.inject({\n    url: '/prefix/',\n    method: 'HEAD'\n  });\n  const noneTrailingReply = await fastify.inject({\n    url: '/prefix',\n    method: 'HEAD'\n  });\n  t.equal(doublePrefixReply.statusCode, 404);\n  t.equal(trailingSlashReply.statusCode, 200);\n  t.equal(noneTrailingReply.statusCode, 200);\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Request and Reply share the route config","suites":[],"updatePoint":{"line":1205,"column":46,"index":28056},"line":1205,"code":"test('Request and Reply share the route config', async t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const config = {\n    this: 'is a string',\n    thisIs: function aFunction() {}\n  };\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    config,\n    handler: (req, reply) => {\n      t.same(req.context, reply.context);\n      t.same(req.context.config, reply.context.config);\n      t.match(req.context.config, config, 'there are url and method additional properties');\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  await fastify.inject('/');\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Will not try to re-createprefixed HEAD route if it already exists and exposeHeadRoutes is true","suites":[],"updatePoint":{"line":1227,"column":100,"index":28681},"line":1227,"code":"test('Will not try to re-createprefixed HEAD route if it already exists and exposeHeadRoutes is true', async t => {\n  t.plan(1);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.register((scope, opts, next) => {\n    scope.route({\n      method: 'HEAD',\n      path: '/route',\n      handler: (req, reply) => {\n        reply.header('content-type', 'text/plain');\n        reply.send('custom HEAD response');\n      }\n    });\n    scope.route({\n      method: 'GET',\n      path: '/route',\n      handler: (req, reply) => {\n        reply.send({\n          ok: true\n        });\n      }\n    });\n    next();\n  }, {\n    prefix: '/prefix'\n  });\n  await fastify.ready();\n  t.ok(true);\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Correct error message is produced if \"path\" option is used","suites":[],"updatePoint":{"line":1257,"column":64,"index":29338},"line":1257,"code":"test('Correct error message is produced if \"path\" option is used', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  t.throws(() => {\n    fastify.route({\n      method: 'GET',\n      path: '/test'\n    });\n  }, new Error('Missing handler function for GET:/test route.'));\n  t.throws(() => {\n    fastify.route({\n      method: 'POST',\n      url: '/test',\n      handler: function () {},\n      errorHandler: ''\n    });\n  }, new Error('Error Handler for POST:/test route, if defined, must be a function'));\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"invalid url attribute - non string URL","suites":[],"updatePoint":{"line":1275,"column":44,"index":29822},"line":1275,"code":"test('invalid url attribute - non string URL', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.get(/^\\/(donations|skills|blogs)/, () => {});\n  } catch (error) {\n    t.equal(error.code, FST_ERR_INVALID_URL().code);\n  }\n});","file":"route.test.js","skipped":false,"dir":"test"},{"name":"Should honor ignoreTrailingSlash option","suites":[],"updatePoint":{"line":26,"column":45,"index":434},"line":26,"code":"test('Should honor ignoreTrailingSlash option', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    ignoreTrailingSlash: true\n  });\n  fastify.get('/test', (req, res) => {\n    res.send('test');\n  });\n  fastify.listen(0, err => {\n    fastify.server.unref();\n    if (err) t.threw(err);\n    const baseUrl = getUrl(fastify);\n    sget.concat(baseUrl + '/test', (err, res, data) => {\n      if (err) t.threw(err);\n      t.equal(res.statusCode, 200);\n      t.equal(data.toString(), 'test');\n    });\n    sget.concat(baseUrl + '/test/', (err, res, data) => {\n      if (err) t.threw(err);\n      t.equal(res.statusCode, 200);\n      t.equal(data.toString(), 'test');\n    });\n  });\n});","file":"router-options.test.js","skipped":false,"dir":"test"},{"name":"Should honor maxParamLength option","suites":[],"updatePoint":{"line":50,"column":40,"index":1100},"line":50,"code":"test('Should honor maxParamLength option', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    maxParamLength: 10\n  });\n  fastify.get('/test/:id', (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test/123456789'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test/123456789abcd'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"router-options.test.js","skipped":false,"dir":"test"},{"name":"Should expose router options via getters on request and reply","suites":[],"updatePoint":{"line":75,"column":67,"index":1648},"line":75,"code":"test('Should expose router options via getters on request and reply', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  fastify.get('/test/:id', (req, reply) => {\n    t.equal(reply.context.config.url, '/test/:id');\n    t.equal(reply.context.config.method, 'GET');\n    t.equal(req.routerPath, '/test/:id');\n    t.equal(req.routerMethod, 'GET');\n    t.equal(req.is404, false);\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test/123456789'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"router-options.test.js","skipped":false,"dir":"test"},{"name":"Should set is404 flag for unmatched paths","suites":[],"updatePoint":{"line":96,"column":47,"index":2208},"line":96,"code":"test('Should set is404 flag for unmatched paths', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.setNotFoundHandler((req, reply) => {\n    t.equal(req.is404, true);\n    reply.code(404).send({\n      error: 'Not Found',\n      message: 'Four oh for',\n      statusCode: 404\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/nonexist/123456789'\n  }, (error, res) => {\n    t.error(error);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"router-options.test.js","skipped":false,"dir":"test"},{"name":"Should honor frameworkErrors option","suites":[],"updatePoint":{"line":115,"column":41,"index":2653},"line":115,"code":"test('Should honor frameworkErrors option', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    frameworkErrors: function (err, req, res) {\n      if (err instanceof FST_ERR_BAD_URL) {\n        t.ok(true);\n      } else {\n        t.fail();\n      }\n\n      res.send(`${err.message} - ${err.code}`);\n    }\n  });\n  fastify.get('/test/:id', (req, res) => {\n    res.send('{ hello: \\'world\\' }');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/test/%world'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.body, '\\'%world\\' is not a valid url component - FST_ERR_BAD_URL');\n  });\n});","file":"router-options.test.js","skipped":false,"dir":"test"},{"name":"Example - URI $id","suites":[],"updatePoint":{"line":11,"column":23,"index":146},"line":11,"code":"test('Example - URI $id', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://example.com/',\n    type: 'object',\n    properties: {\n      hello: {\n        type: 'string'\n      }\n    }\n  });\n  fastify.post('/', {\n    handler() {},\n\n    schema: {\n      body: {\n        type: 'array',\n        items: {\n          $ref: 'http://example.com#/properties/hello'\n        }\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - string $id","suites":[],"updatePoint":{"line":37,"column":26,"index":610},"line":37,"code":"test('Example - string $id', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'commonSchema',\n    type: 'object',\n    properties: {\n      hello: {\n        type: 'string'\n      }\n    }\n  });\n  fastify.post('/', {\n    handler() {},\n\n    schema: {\n      body: {\n        $ref: 'commonSchema#'\n      },\n      headers: {\n        $ref: 'commonSchema#'\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - get schema","suites":[],"updatePoint":{"line":63,"column":26,"index":1048},"line":63,"code":"test('Example - get schema', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'schemaId',\n    type: 'object',\n    properties: {\n      hello: {\n        type: 'string'\n      }\n    }\n  });\n  const mySchemas = fastify.getSchemas();\n  const mySchema = fastify.getSchema('schemaId');\n  t.same(mySchemas.schemaId, mySchema);\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - get schema encapsulated","suites":[],"updatePoint":{"line":79,"column":39,"index":1414},"line":79,"code":"test('Example - get schema encapsulated', async t => {\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'one',\n    my: 'hello'\n  }); // will return only `one` schema\n\n  fastify.get('/', (request, reply) => {\n    reply.send(fastify.getSchemas());\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addSchema({\n      $id: 'two',\n      my: 'ciao'\n    }); // will return `one` and `two` schemas\n\n    instance.get('/sub', (request, reply) => {\n      reply.send(instance.getSchemas());\n    });\n    instance.register((subinstance, opts, done) => {\n      subinstance.addSchema({\n        $id: 'three',\n        my: 'hola'\n      }); // will return `one`, `two` and `three`\n\n      subinstance.get('/deep', (request, reply) => {\n        reply.send(subinstance.getSchemas());\n      });\n      done();\n    });\n    done();\n  });\n  const r1 = await fastify.inject('/');\n  const r2 = await fastify.inject('/sub');\n  const r3 = await fastify.inject('/deep');\n  t.same(Object.keys(r1.json()), ['one']);\n  t.same(Object.keys(r2.json()), ['one', 'two']);\n  t.same(Object.keys(r3.json()), ['one', 'two', 'three']);\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - validation","suites":[],"updatePoint":{"line":118,"column":26,"index":2522},"line":118,"code":"test('Example - validation', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  const bodyJsonSchema = {\n    type: 'object',\n    required: ['requiredKey'],\n    properties: {\n      someKey: {\n        type: 'string'\n      },\n      someOtherKey: {\n        type: 'number'\n      },\n      requiredKey: {\n        type: 'array',\n        maxItems: 3,\n        items: {\n          type: 'integer'\n        }\n      },\n      nullableKey: {\n        type: ['number', 'null']\n      },\n      // or { type: 'number', nullable: true }\n      multipleTypesKey: {\n        type: ['boolean', 'number']\n      },\n      multipleRestrictedTypesKey: {\n        oneOf: [{\n          type: 'string',\n          maxLength: 5\n        }, {\n          type: 'number',\n          minimum: 10\n        }]\n      },\n      enumKey: {\n        type: 'string',\n        enum: ['John', 'Foo']\n      },\n      notTypeKey: {\n        not: {\n          type: 'array'\n        }\n      }\n    }\n  };\n  const queryStringJsonSchema = {\n    name: {\n      type: 'string'\n    },\n    excitement: {\n      type: 'integer'\n    }\n  };\n  const paramsJsonSchema = {\n    par1: {\n      type: 'string'\n    },\n    par2: {\n      type: 'number'\n    }\n  };\n  const headersJsonSchema = {\n    type: 'object',\n    properties: {\n      'x-foo': {\n        type: 'string'\n      }\n    },\n    required: ['x-foo']\n  };\n  const schema = {\n    body: bodyJsonSchema,\n    querystring: queryStringJsonSchema,\n    params: paramsJsonSchema,\n    headers: headersJsonSchema\n  };\n  fastify.post('/the/url', {\n    schema\n  }, handler);\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - ajv config","suites":[],"updatePoint":{"line":204,"column":26,"index":4127},"line":204,"code":"test('Example - ajv config', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    ajv: {\n      plugins: [require('ajv-merge-patch')]\n    }\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    },\n\n    schema: {\n      body: {\n        $patch: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: [{\n            op: 'add',\n            path: '/properties/q',\n            value: {\n              type: 'number'\n            }\n          }]\n        }\n      }\n    }\n  });\n  fastify.post('/foo', {\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    },\n\n    schema: {\n      body: {\n        $merge: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: {\n            required: ['q']\n          }\n        }\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example Joi","suites":[],"updatePoint":{"line":267,"column":17,"index":5203},"line":267,"code":"test('Example Joi', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  const Joi = require('@hapi/joi');\n\n  fastify.post('/the/url', {\n    schema: {\n      body: Joi.object().keys({\n        hello: Joi.string().required()\n      }).required()\n    },\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return data => schema.validate(data);\n    }\n  }, handler);\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example yup","suites":[],"updatePoint":{"line":292,"column":17,"index":5679},"line":292,"code":"test('Example yup', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  const yup = require('yup'); // Validation options to match ajv's baseline options used in Fastify\n\n\n  const yupOptions = {\n    strict: false,\n    abortEarly: false,\n    // return all errors\n    stripUnknown: true,\n    // remove additional properties\n    recursive: true\n  };\n  fastify.post('/the/url', {\n    schema: {\n      body: yup.object({\n        age: yup.number().integer().required(),\n        sub: yup.object().shape({\n          name: yup.string().required()\n        }).required()\n      })\n    },\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return function (data) {\n        // with option strict = false, yup `validateSync` function returns the coerced value if validation was successful, or throws if validation failed\n        try {\n          const result = schema.validateSync(data, yupOptions);\n          return {\n            value: result\n          };\n        } catch (e) {\n          return {\n            error: e\n          };\n        }\n      };\n    }\n  }, handler);\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - serialization","suites":[],"updatePoint":{"line":341,"column":29,"index":6865},"line":341,"code":"test('Example - serialization', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  const schema = {\n    response: {\n      200: {\n        type: 'object',\n        properties: {\n          value: {\n            type: 'string'\n          },\n          otherValue: {\n            type: 'boolean'\n          }\n        }\n      }\n    }\n  };\n  fastify.post('/the/url', {\n    schema\n  }, handler);\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - serialization 2","suites":[],"updatePoint":{"line":367,"column":31,"index":7321},"line":367,"code":"test('Example - serialization 2', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  const schema = {\n    response: {\n      '2xx': {\n        type: 'object',\n        properties: {\n          value: {\n            type: 'string'\n          },\n          otherValue: {\n            type: 'boolean'\n          }\n        }\n      },\n      201: {\n        // the contract sintax\n        value: {\n          type: 'string'\n        }\n      }\n    }\n  };\n  fastify.post('/the/url', {\n    schema\n  }, handler);\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - serializator","suites":[],"updatePoint":{"line":399,"column":28,"index":7881},"line":399,"code":"test('Example - serializator', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.setSerializerCompiler(({\n    schema,\n    method,\n    url,\n    httpStatus\n  }) => {\n    return data => JSON.stringify(data);\n  });\n  fastify.get('/user', {\n    handler(req, reply) {\n      reply.send({\n        id: 1,\n        name: 'Foo',\n        image: 'BIG IMAGE'\n      });\n    },\n\n    schema: {\n      response: {\n        '2xx': {\n          id: {\n            type: 'number'\n          },\n          name: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Example - schemas examples","suites":[],"updatePoint":{"line":434,"column":32,"index":8490},"line":434,"code":"test('Example - schemas examples', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  const handler = () => {};\n\n  fastify.addSchema({\n    $id: 'http://foo/common.json',\n    type: 'object',\n    definitions: {\n      foo: {\n        $id: '#address',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'http://foo/shared.json',\n    type: 'object',\n    definitions: {\n      foo: {\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  const refToId = {\n    type: 'object',\n    definitions: {\n      foo: {\n        $id: '#address',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    },\n    properties: {\n      home: {\n        $ref: '#address'\n      },\n      work: {\n        $ref: '#address'\n      }\n    }\n  };\n  const refToDefinitions = {\n    type: 'object',\n    definitions: {\n      foo: {\n        $id: '#address',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    },\n    properties: {\n      home: {\n        $ref: '#/definitions/foo'\n      },\n      work: {\n        $ref: '#/definitions/foo'\n      }\n    }\n  };\n  const refToSharedSchemaId = {\n    type: 'object',\n    properties: {\n      home: {\n        $ref: 'http://foo/common.json#address'\n      },\n      work: {\n        $ref: 'http://foo/common.json#address'\n      }\n    }\n  };\n  const refToSharedSchemaDefinitions = {\n    type: 'object',\n    properties: {\n      home: {\n        $ref: 'http://foo/shared.json#/definitions/foo'\n      },\n      work: {\n        $ref: 'http://foo/shared.json#/definitions/foo'\n      }\n    }\n  };\n  fastify.get('/', {\n    handler,\n    schema: {\n      body: refToId,\n      headers: refToDefinitions,\n      params: refToSharedSchemaId,\n      query: refToSharedSchemaDefinitions\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"should return custom error messages with ajv-errors","suites":[],"updatePoint":{"line":546,"column":57,"index":10563},"line":546,"code":"test('should return custom error messages with ajv-errors', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        allErrors: true,\n        jsonPointers: true\n      },\n      plugins: [require('ajv-errors')]\n    }\n  });\n  const schema = {\n    body: {\n      type: 'object',\n      properties: {\n        name: {\n          type: 'string'\n        },\n        work: {\n          type: 'string'\n        },\n        age: {\n          type: 'number',\n          errorMessage: {\n            type: 'bad age - should be num'\n          }\n        }\n      },\n      required: ['name', 'work'],\n      errorMessage: {\n        required: {\n          name: 'name please',\n          work: 'work please',\n          age: 'age please'\n        }\n      }\n    }\n  };\n  fastify.post('/', {\n    schema\n  }, function (req, reply) {\n    reply.code(200).send(req.body.name);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'salman',\n      age: 'bad'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'body/age bad age - should be num, body name please, body work please'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"should return localized error messages with ajv-i18n","suites":[],"updatePoint":{"line":606,"column":58,"index":11821},"line":606,"code":"test('should return localized error messages with ajv-i18n', t => {\n  t.plan(3);\n  const schema = {\n    body: {\n      type: 'object',\n      properties: {\n        name: {\n          type: 'string'\n        },\n        work: {\n          type: 'string'\n        }\n      },\n      required: ['name', 'work']\n    }\n  };\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        allErrors: true\n      }\n    }\n  });\n  fastify.setErrorHandler(function (error, request, reply) {\n    if (error.validation) {\n      localize.ru(error.validation);\n      reply.status(400).send(error.validation);\n      return;\n    }\n\n    reply.send(error);\n  });\n  fastify.post('/', {\n    schema\n  }, function (req, reply) {\n    reply.code(200).send(req.body.name);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'salman'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), [{\n      dataPath: '',\n      keyword: 'required',\n      message: '    work',\n      params: {\n        missingProperty: 'work'\n      },\n      schemaPath: '#/required'\n    }]);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-examples.test.js","skipped":false,"dir":"test"},{"name":"Should expose  function","suites":[],"updatePoint":{"line":26,"column":35,"index":485},"line":26,"code":"  test(`Should expose ${f} function`, t => {\n    t.plan(1);\n    const fastify = Fastify();\n    t.equal(typeof fastify[f], 'function');\n  });","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"cannot call  after binding","suites":[],"updatePoint":{"line":33,"column":38,"index":698},"line":33,"code":"  test(`cannot call ${f} after binding`, t => {\n    t.plan(2);\n    const fastify = Fastify();\n    t.teardown(fastify.close.bind(fastify));\n    fastify.listen(0, err => {\n      t.error(err);\n\n      try {\n        fastify[f](() => {});\n        t.fail();\n      } catch (e) {\n        t.pass();\n      }\n    });\n  });","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"The schemas should be added to an internal storage","suites":[],"updatePoint":{"line":49,"column":56,"index":1031},"line":49,"code":"test('The schemas should be added to an internal storage', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const schema = {\n    $id: 'id',\n    my: 'schema'\n  };\n  fastify.addSchema(schema);\n  t.same(fastify[kSchemaController].schemaBucket.store, {\n    id: schema\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"The schemas should be accessible via getSchemas","suites":[],"updatePoint":{"line":61,"column":53,"index":1304},"line":61,"code":"test('The schemas should be accessible via getSchemas', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const schemas = {\n    id: {\n      $id: 'id',\n      my: 'schema'\n    },\n    abc: {\n      $id: 'abc',\n      my: 'schema'\n    },\n    bcd: {\n      $id: 'bcd',\n      my: 'schema',\n      properties: {\n        a: 'a',\n        b: 1\n      }\n    }\n  };\n  Object.values(schemas).forEach(schema => {\n    fastify.addSchema(schema);\n  });\n  t.same(fastify.getSchemas(), schemas);\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"The schema should be accessible by id via getSchema","suites":[],"updatePoint":{"line":87,"column":57,"index":1785},"line":87,"code":"test('The schema should be accessible by id via getSchema', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  const schemas = [{\n    $id: 'id',\n    my: 'schema'\n  }, {\n    $id: 'abc',\n    my: 'schema'\n  }, {\n    $id: 'bcd',\n    my: 'schema',\n    properties: {\n      a: 'a',\n      b: 1\n    }\n  }];\n  schemas.forEach(schema => {\n    fastify.addSchema(schema);\n  });\n  t.same(fastify.getSchema('abc'), schemas[1]);\n  t.same(fastify.getSchema('id'), schemas[0]);\n  t.same(fastify.getSchema('foo'), undefined);\n  fastify.register((instance, opts, done) => {\n    const pluginSchema = {\n      $id: 'cde',\n      my: 'schema'\n    };\n    instance.addSchema(pluginSchema);\n    t.same(instance.getSchema('cde'), pluginSchema);\n    done();\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get validatorCompiler after setValidatorCompiler","suites":[],"updatePoint":{"line":121,"column":54,"index":2558},"line":121,"code":"test('Get validatorCompiler after setValidatorCompiler', t => {\n  t.plan(2);\n\n  const myCompiler = () => {};\n\n  const fastify = Fastify();\n  fastify.setValidatorCompiler(myCompiler);\n  const sc = fastify.validatorCompiler;\n  t.ok(Object.is(myCompiler, sc));\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get serializerCompiler after setSerializerCompiler","suites":[],"updatePoint":{"line":132,"column":56,"index":2860},"line":132,"code":"test('Get serializerCompiler after setSerializerCompiler', t => {\n  t.plan(2);\n\n  const myCompiler = () => {};\n\n  const fastify = Fastify();\n  fastify.setSerializerCompiler(myCompiler);\n  const sc = fastify.serializerCompiler;\n  t.ok(Object.is(myCompiler, sc));\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get compilers is empty when settle on routes","suites":[],"updatePoint":{"line":143,"column":50,"index":3158},"line":143,"code":"test('Get compilers is empty when settle on routes', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      },\n      response: {\n        '2xx': {\n          foo: {\n            type: 'array',\n            items: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    },\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {},\n    serializerCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {}\n  }, function (req, reply) {\n    reply.send('ok');\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(fastify.validatorCompiler, undefined);\n    t.equal(fastify.serializerCompiler, undefined);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should throw if the $id property is missing","suites":[],"updatePoint":{"line":192,"column":49,"index":4078},"line":192,"code":"test('Should throw if the $id property is missing', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.addSchema({\n      type: 'string'\n    });\n    t.fail();\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_SCH_MISSING_ID');\n  }\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Cannot add multiple times the same id","suites":[],"updatePoint":{"line":205,"column":43,"index":4324},"line":205,"code":"test('Cannot add multiple times the same id', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'id'\n  });\n\n  try {\n    fastify.addSchema({\n      $id: 'id'\n    });\n  } catch (err) {\n    t.equal(err.code, 'FST_ERR_SCH_ALREADY_PRESENT');\n    t.equal(err.message, 'Schema with id \\'id\\' already declared!');\n  }\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Cannot add schema for query and querystring","suites":[],"updatePoint":{"line":221,"column":49,"index":4673},"line":221,"code":"test('Cannot add schema for query and querystring', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', {\n    handler: () => {},\n    schema: {\n      query: {\n        foo: {\n          type: 'string'\n        }\n      },\n      querystring: {\n        foo: {\n          type: 'string'\n        }\n      }\n    }\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_DUPLICATE');\n    t.equal(err.message, 'Schema with \\'querystring\\' already present!');\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should throw of the schema does not exists in input","suites":[],"updatePoint":{"line":244,"column":57,"index":5162},"line":244,"code":"test('Should throw of the schema does not exists in input', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/:id', {\n    handler: echoParams,\n    schema: {\n      params: {\n        name: {\n          $ref: '#notExist'\n        }\n      }\n    }\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD');\n    t.equal(err.message, \"Failed building the validation schema for GET: /:id, due to error can't resolve reference #notExist from id #\");\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should throw of the schema does not exists in output","suites":[],"updatePoint":{"line":262,"column":58,"index":5654},"line":262,"code":"test('Should throw of the schema does not exists in output', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/:id', {\n    handler: echoParams,\n    schema: {\n      response: {\n        '2xx': {\n          name: {\n            $ref: '#notExist'\n          }\n        }\n      }\n    }\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_SERIALIZATION_BUILD');\n    t.match(err.message, /^Failed building the serialization schema for GET: \\/:id, due to error Cannot read propert.*/); // error from fast-json-strinfigy\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should not change the input schemas","suites":[],"updatePoint":{"line":282,"column":41,"index":6184},"line":282,"code":"test('Should not change the input schemas', t => {\n  t.plan(4);\n  const theSchema = {\n    $id: 'helloSchema',\n    type: 'object',\n    definitions: {\n      hello: {\n        type: 'string'\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.post('/', {\n    handler: echoBody,\n    schema: {\n      body: {\n        type: 'object',\n        additionalProperties: false,\n        properties: {\n          name: {\n            $ref: 'helloSchema#/definitions/hello'\n          }\n        }\n      },\n      response: {\n        '2xx': {\n          name: {\n            $ref: 'helloSchema#/definitions/hello'\n          }\n        }\n      }\n    }\n  });\n  fastify.addSchema(theSchema);\n  fastify.inject({\n    url: '/',\n    method: 'POST',\n    payload: {\n      name: 'Foo',\n      surname: 'Bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      name: 'Foo'\n    });\n    t.ok(theSchema.$id, 'the $id is not removed');\n    t.same(fastify.getSchema('helloSchema'), theSchema);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"First level $ref","suites":[],"updatePoint":{"line":332,"column":22,"index":7156},"line":332,"code":"test('First level $ref', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.get('/:id', {\n    handler: (req, reply) => {\n      reply.send({\n        id: req.params.id * 2,\n        ignore: 'it'\n      });\n    },\n    schema: {\n      params: {\n        $ref: 'test#'\n      },\n      response: {\n        200: {\n          $ref: 'test#'\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/123'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      id: 246\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Customize validator compiler in instance and route","suites":[],"updatePoint":{"line":372,"column":56,"index":7837},"line":372,"code":"test('Customize validator compiler in instance and route', t => {\n  t.plan(28);\n  const fastify = Fastify();\n  fastify.setValidatorCompiler(({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    t.equal(method, 'POST'); // run 4 times\n\n    t.equal(url, '/:id'); // run 4 times\n\n    switch (httpPart) {\n      case 'body':\n        t.pass('body evaluated');\n        return body => {\n          t.same(body, {\n            foo: ['bar', 'BAR']\n          });\n          return true;\n        };\n\n      case 'params':\n        t.pass('params evaluated');\n        return params => {\n          t.same(params, {\n            id: 1234\n          });\n          return true;\n        };\n\n      case 'querystring':\n        t.pass('querystring evaluated');\n        return query => {\n          t.same(query, {\n            lang: 'en'\n          });\n          return true;\n        };\n\n      case 'headers':\n        t.pass('headers evaluated');\n        return headers => {\n          t.match(headers, {\n            x: 'hello'\n          });\n          return true;\n        };\n\n      case '2xx':\n        t.fail('the validator doesn\\'t process the response');\n        break;\n\n      default:\n        t.fail(`unknown httpPart ${httpPart}`);\n    }\n  });\n  fastify.post('/:id', {\n    handler: echoBody,\n    schema: {\n      query: {\n        lang: {\n          type: 'string',\n          enum: ['it', 'en']\n        }\n      },\n      headers: {\n        x: {\n          type: 'string'\n        }\n      },\n      params: {\n        id: {\n          type: 'number'\n        }\n      },\n      body: {\n        foo: {\n          type: 'array'\n        }\n      },\n      response: {\n        '2xx': {\n          foo: {\n            type: 'array',\n            items: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    }\n  });\n  fastify.get('/wow/:id', {\n    handler: echoParams,\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      t.equal(method, 'GET'); // run 3 times (params, headers, query)\n\n      t.equal(url, '/wow/:id'); // run 4 times\n\n      return () => {\n        return true;\n      }; // ignore the validation\n    },\n    schema: {\n      query: {\n        lang: {\n          type: 'string',\n          enum: ['it', 'en']\n        }\n      },\n      headers: {\n        x: {\n          type: 'string'\n        }\n      },\n      params: {\n        id: {\n          type: 'number'\n        }\n      },\n      response: {\n        '2xx': {\n          foo: {\n            type: 'array',\n            items: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    url: '/1234',\n    method: 'POST',\n    headers: {\n      x: 'hello'\n    },\n    query: {\n      lang: 'en'\n    },\n    payload: {\n      foo: ['bar', 'BAR']\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: ['bar', 'BAR']\n    });\n  });\n  fastify.inject({\n    url: '/wow/should-be-a-num',\n    method: 'GET',\n    headers: {\n      x: 'hello'\n    },\n    query: {\n      lang: 'jp'\n    } // not in the enum\n\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200); // the validation is always true\n\n    t.same(res.json(), {});\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Use the same schema across multiple routes","suites":[],"updatePoint":{"line":547,"column":48,"index":11055},"line":547,"code":"test('Use the same schema across multiple routes', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.get('/first/:id', {\n    schema: {\n      params: {\n        id: {\n          $ref: 'test#/properties/id'\n        }\n      }\n    },\n    handler: (req, reply) => {\n      reply.send(typeof req.params.id);\n    }\n  });\n  fastify.get('/second/:id', {\n    schema: {\n      params: {\n        id: {\n          $ref: 'test#/properties/id'\n        }\n      }\n    },\n    handler: (req, reply) => {\n      reply.send(typeof req.params.id);\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/first/123'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, 'number');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/second/123'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, 'number');\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Encapsulation should intervene","suites":[],"updatePoint":{"line":598,"column":36,"index":12003},"line":598,"code":"test('Encapsulation should intervene', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addSchema({\n      $id: 'encapsulation',\n      type: 'object',\n      properties: {\n        id: {\n          type: 'number'\n        }\n      }\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.get('/:id', {\n      handler: echoParams,\n      schema: {\n        params: {\n          id: {\n            $ref: 'encapsulation#/properties/id'\n          }\n        }\n      }\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD');\n    t.equal(err.message, \"Failed building the validation schema for GET: /:id, due to error can't resolve reference encapsulation#/properties/id from id #\");\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Encapsulation isolation","suites":[],"updatePoint":{"line":631,"column":29,"index":12813},"line":631,"code":"test('Encapsulation isolation', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.addSchema({\n      $id: 'id'\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addSchema({\n      $id: 'id'\n    });\n    done();\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Add schema after register","suites":[],"updatePoint":{"line":648,"column":31,"index":13166},"line":648,"code":"test('Add schema after register', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.get('/:id', {\n      handler: echoParams,\n      schema: {\n        params: {\n          $ref: 'test#'\n        }\n      }\n    }); // add it to the parent instance\n\n    fastify.addSchema({\n      $id: 'test',\n      type: 'object',\n      properties: {\n        id: {\n          type: 'number'\n        }\n      }\n    });\n\n    try {\n      instance.addSchema({\n        $id: 'test'\n      });\n    } catch (err) {\n      t.equal(err.code, 'FST_ERR_SCH_ALREADY_PRESENT');\n      t.equal(err.message, 'Schema with id \\'test\\' already declared!');\n    }\n\n    done();\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/4242'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      id: 4242\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Encapsulation isolation for getSchemas","suites":[],"updatePoint":{"line":693,"column":44,"index":14059},"line":693,"code":"test('Encapsulation isolation for getSchemas', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  let pluginDeepOneSide;\n  let pluginDeepOne;\n  let pluginDeepTwo;\n  const schemas = {\n    z: {\n      $id: 'z',\n      my: 'schema'\n    },\n    a: {\n      $id: 'a',\n      my: 'schema'\n    },\n    b: {\n      $id: 'b',\n      my: 'schema'\n    },\n    c: {\n      $id: 'c',\n      my: 'schema',\n      properties: {\n        a: 'a',\n        b: 1\n      }\n    }\n  };\n  fastify.addSchema(schemas.z);\n  fastify.register((instance, opts, done) => {\n    instance.addSchema(schemas.a);\n    pluginDeepOneSide = instance;\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addSchema(schemas.b);\n    instance.register((subinstance, opts, done) => {\n      subinstance.addSchema(schemas.c);\n      pluginDeepTwo = subinstance;\n      done();\n    });\n    pluginDeepOne = instance;\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.same(fastify.getSchemas(), {\n      z: schemas.z\n    });\n    t.same(pluginDeepOneSide.getSchemas(), {\n      z: schemas.z,\n      a: schemas.a\n    });\n    t.same(pluginDeepOne.getSchemas(), {\n      z: schemas.z,\n      b: schemas.b\n    });\n    t.same(pluginDeepTwo.getSchemas(), {\n      z: schemas.z,\n      b: schemas.b,\n      c: schemas.c\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Use the same schema id in different places","suites":[],"updatePoint":{"line":757,"column":48,"index":15361},"line":757,"code":"test('Use the same schema id in different places', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.get('/:id', {\n    handler: echoParams,\n    schema: {\n      response: {\n        200: {\n          type: 'array',\n          items: {\n            $ref: 'test#/properties/id'\n          }\n        }\n      }\n    }\n  });\n  fastify.post('/:id', {\n    handler: echoBody,\n    schema: {\n      body: {\n        id: {\n          $ref: 'test#/properties/id'\n        }\n      },\n      response: {\n        200: {\n          id: {\n            $ref: 'test#/properties/id'\n          }\n        }\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get schema anyway should not add `properties` if allOf is present","suites":[],"updatePoint":{"line":801,"column":71,"index":16158},"line":801,"code":"test('Get schema anyway should not add `properties` if allOf is present', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'first',\n    type: 'object',\n    properties: {\n      first: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'second',\n    type: 'object',\n    allOf: [{\n      type: 'object',\n      properties: {\n        second: {\n          type: 'number'\n        }\n      }\n    }, fastify.getSchema('first')]\n  });\n  fastify.get('/', {\n    handler: () => {},\n    schema: {\n      querystring: fastify.getSchema('second'),\n      response: {\n        200: fastify.getSchema('second')\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get schema anyway should not add `properties` if oneOf is present","suites":[],"updatePoint":{"line":836,"column":71,"index":16863},"line":836,"code":"test('Get schema anyway should not add `properties` if oneOf is present', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'first',\n    type: 'object',\n    properties: {\n      first: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'second',\n    type: 'object',\n    oneOf: [{\n      type: 'object',\n      properties: {\n        second: {\n          type: 'number'\n        }\n      }\n    }, fastify.getSchema('first')]\n  });\n  fastify.get('/', {\n    handler: () => {},\n    schema: {\n      querystring: fastify.getSchema('second'),\n      response: {\n        200: fastify.getSchema('second')\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Get schema anyway should not add `properties` if anyOf is present","suites":[],"updatePoint":{"line":871,"column":71,"index":17568},"line":871,"code":"test('Get schema anyway should not add `properties` if anyOf is present', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'first',\n    type: 'object',\n    properties: {\n      first: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'second',\n    type: 'object',\n    anyOf: [{\n      type: 'object',\n      properties: {\n        second: {\n          type: 'number'\n        }\n      }\n    }, fastify.getSchema('first')]\n  });\n  fastify.get('/', {\n    handler: () => {},\n    schema: {\n      querystring: fastify.getSchema('second'),\n      response: {\n        200: fastify.getSchema('second')\n      }\n    }\n  });\n  fastify.ready(err => t.error(err));\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Shared schema should be ignored in string enum","suites":[],"updatePoint":{"line":906,"column":52,"index":18254},"line":906,"code":"test('Shared schema should be ignored in string enum', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/:lang', {\n    handler: echoParams,\n    schema: {\n      params: {\n        type: 'object',\n        properties: {\n          lang: {\n            type: 'string',\n            enum: ['Javascript', 'C++', 'C#']\n          }\n        }\n      }\n    }\n  });\n  fastify.inject('/C%23', (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      lang: 'C#'\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Shared schema should NOT be ignored in != string enum","suites":[],"updatePoint":{"line":930,"column":59,"index":18746},"line":930,"code":"test('Shared schema should NOT be ignored in != string enum', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'C',\n    type: 'object',\n    properties: {\n      lang: {\n        type: 'string',\n        enum: ['Javascript', 'C++', 'C#']\n      }\n    }\n  });\n  fastify.post('/:lang', {\n    handler: echoBody,\n    schema: {\n      body: fastify.getSchema('C')\n    }\n  });\n  fastify.inject({\n    url: '/',\n    method: 'POST',\n    payload: {\n      lang: 'C#'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      lang: 'C#'\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Case insensitive header validation","suites":[],"updatePoint":{"line":962,"column":40,"index":19313},"line":962,"code":"test('Case insensitive header validation', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/', {\n    handler: (req, reply) => {\n      reply.code(200).send(req.headers.foobar);\n    },\n    schema: {\n      headers: {\n        type: 'object',\n        required: ['FooBar'],\n        properties: {\n          FooBar: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET',\n    headers: {\n      FooBar: 'Baz'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, 'Baz');\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Not evaluate json-schema $schema keyword","suites":[],"updatePoint":{"line":992,"column":46,"index":19889},"line":992,"code":"test('Not evaluate json-schema $schema keyword', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.post('/', {\n    handler: echoBody,\n    schema: {\n      body: {\n        $schema: 'http://json-schema.org/draft-07/schema#',\n        type: 'object',\n        additionalProperties: false,\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    url: '/',\n    method: 'POST',\n    body: {\n      hello: 'world',\n      foo: 'bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      hello: 'world'\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Validation context in validation result","suites":[],"updatePoint":{"line":1024,"column":45,"index":20503},"line":1024,"code":"test('Validation context in validation result', t => {\n  t.plan(5);\n  const fastify = Fastify(); // custom error handler to expose validation context in response, so we can test it later\n\n  fastify.setErrorHandler((err, request, reply) => {\n    t.equal(err instanceof Error, true);\n    t.ok(err.validation, 'detailed errors');\n    t.equal(err.validationContext, 'body');\n    reply.send();\n  });\n  fastify.get('/', {\n    handler: echoParams,\n    schema: {\n      body: {\n        type: 'object',\n        required: ['hello'],\n        properties: {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    payload: {} // body lacks required field, will fail validation\n\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"The schema build should not modify the input","suites":[],"updatePoint":{"line":1058,"column":50,"index":21343},"line":1058,"code":"test('The schema build should not modify the input', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  const first = {\n    $id: 'first',\n    type: 'object',\n    properties: {\n      first: {\n        type: 'number'\n      }\n    }\n  };\n  fastify.addSchema(first);\n  fastify.addSchema({\n    $id: 'second',\n    type: 'object',\n    allOf: [{\n      type: 'object',\n      properties: {\n        second: {\n          type: 'number'\n        }\n      }\n    }, {\n      $ref: 'first#'\n    }]\n  });\n  fastify.get('/', {\n    schema: {\n      description: 'get',\n      body: {\n        $ref: 'second#'\n      },\n      response: {\n        200: {\n          $ref: 'second#'\n        }\n      }\n    },\n    handler: (request, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.patch('/', {\n    schema: {\n      description: 'patch',\n      body: {\n        $ref: 'first#'\n      },\n      response: {\n        200: {\n          $ref: 'first#'\n        }\n      }\n    },\n    handler: (request, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  t.ok(first.$id);\n  fastify.ready(err => {\n    t.error(err);\n    t.ok(first.$id);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Cross schema reference with encapsulation references","suites":[],"updatePoint":{"line":1127,"column":58,"index":22510},"line":1127,"code":"test('Cross schema reference with encapsulation references', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://foo/item',\n    type: 'object',\n    properties: {\n      foo: {\n        type: 'string'\n      }\n    }\n  });\n  const refItem = {\n    $ref: 'http://foo/item#'\n  };\n  fastify.addSchema({\n    $id: 'itemList',\n    type: 'array',\n    items: refItem\n  });\n  fastify.register((instance, opts, done) => {\n    instance.addSchema({\n      $id: 'encapsulation',\n      type: 'object',\n      properties: {\n        id: {\n          type: 'number'\n        },\n        item: refItem,\n        secondItem: refItem\n      }\n    });\n    const multipleRef = {\n      type: 'object',\n      properties: {\n        a: {\n          $ref: 'itemList#'\n        },\n        b: refItem,\n        c: refItem,\n        d: refItem\n      }\n    };\n    instance.get('/get', {\n      schema: {\n        response: {\n          200: multipleRef\n        }\n      }\n    }, () => {});\n    instance.get('/double-get', {\n      schema: {\n        body: multipleRef,\n        response: {\n          200: multipleRef\n        }\n      }\n    }, () => {});\n    instance.post('/post', {\n      schema: {\n        body: multipleRef,\n        response: {\n          200: multipleRef\n        }\n      }\n    }, () => {});\n    instance.post('/double', {\n      schema: {\n        response: {\n          200: {\n            $ref: 'encapsulation'\n          }\n        }\n      }\n    }, () => {});\n    done();\n  }, {\n    prefix: '/foo'\n  });\n  fastify.post('/post', {\n    schema: {\n      body: refItem,\n      response: {\n        200: refItem\n      }\n    }\n  }, () => {});\n  fastify.get('/get', {\n    schema: {\n      body: refItem,\n      response: {\n        200: refItem\n      }\n    }\n  }, () => {});\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Check how many AJV instances are built #1","suites":[],"updatePoint":{"line":1226,"column":47,"index":24309},"line":1226,"code":"test('Check how many AJV instances are built #1', t => {\n  t.plan(12);\n  const fastify = Fastify();\n  addRandomRoute(fastify); // this trigger the schema validation creation\n\n  t.notOk(fastify.validatorCompiler, 'validator not initialized');\n  const instances = [];\n  fastify.register((instance, opts, done) => {\n    t.notOk(fastify.validatorCompiler, 'validator not initialized');\n    instances.push(instance);\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    t.notOk(fastify.validatorCompiler, 'validator not initialized');\n    addRandomRoute(instance);\n    instances.push(instance);\n    done();\n    instance.register((instance, opts, done) => {\n      t.notOk(fastify.validatorCompiler, 'validator not initialized');\n      addRandomRoute(instance);\n      instances.push(instance);\n      done();\n    });\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.ok(fastify.validatorCompiler, 'validator initialized on preReady');\n    fastify.validatorCompiler.checkPointer = true;\n    instances.forEach(i => {\n      t.ok(i.validatorCompiler, 'validator initialized on preReady');\n      t.equal(i.validatorCompiler.checkPointer, true, 'validator is only one for all the instances');\n    });\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"onReady hook has the compilers ready","suites":[],"updatePoint":{"line":1260,"column":42,"index":25522},"line":1260,"code":"test('onReady hook has the compilers ready', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.get(`/${Math.random()}`, {\n    handler: (req, reply) => reply.send(),\n    schema: {\n      body: {\n        type: 'object'\n      },\n      response: {\n        200: {\n          type: 'object'\n        }\n      }\n    }\n  });\n  fastify.addHook('onReady', function (done) {\n    t.ok(this.validatorCompiler);\n    t.ok(this.serializerCompiler);\n    done();\n  });\n  let hookCallCounter = 0;\n  fastify.register(async (i, o) => {\n    i.addHook('onReady', function (done) {\n      t.ok(this.validatorCompiler);\n      t.ok(this.serializerCompiler);\n      done();\n    });\n    i.register(async (i, o) => {});\n    i.addHook('onReady', function (done) {\n      hookCallCounter++;\n      done();\n    });\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(hookCallCounter, 1, 'it is called once');\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Check how many AJV instances are built #2 - verify validatorPool","suites":[],"updatePoint":{"line":1299,"column":70,"index":26447},"line":1299,"code":"test('Check how many AJV instances are built #2 - verify validatorPool', t => {\n  t.plan(13);\n  const fastify = Fastify();\n  t.notOk(fastify.validatorCompiler, 'validator not initialized');\n  fastify.register(function sibling1(instance, opts, done) {\n    addRandomRoute(instance);\n    t.notOk(instance.validatorCompiler, 'validator not initialized');\n    instance.ready(() => {\n      t.ok(instance.validatorCompiler, 'validator is initialized');\n      instance.validatorCompiler.sharedPool = 1;\n    });\n    instance.after(() => {\n      t.notOk(instance.validatorCompiler, 'validator not initialized');\n    });\n    done();\n  });\n  fastify.register(function sibling2(instance, opts, done) {\n    addRandomRoute(instance);\n    t.notOk(instance.validatorCompiler, 'validator not initialized');\n    instance.ready(() => {\n      t.equal(instance.validatorCompiler.sharedPool, 1, 'this context must share the validator with the same schemas');\n      instance.validatorCompiler.sharedPool = 2;\n    });\n    instance.after(() => {\n      t.notOk(instance.validatorCompiler, 'validator not initialized');\n    });\n    instance.register((instance, opts, done) => {\n      t.notOk(instance.validatorCompiler, 'validator not initialized');\n      instance.ready(() => {\n        t.equal(instance.validatorCompiler.sharedPool, 2, 'this context must share the validator of the parent');\n      });\n      done();\n    });\n    done();\n  });\n  fastify.register(function sibling3(instance, opts, done) {\n    addRandomRoute(instance); // this trigger to dont't reuse the same compiler pool\n\n    instance.addSchema({\n      $id: 'diff',\n      type: 'object'\n    });\n    t.notOk(instance.validatorCompiler, 'validator not initialized');\n    instance.ready(() => {\n      t.ok(instance.validatorCompiler, 'validator is initialized');\n      t.notOk(instance.validatorCompiler.sharedPool, 'this context has its own compiler');\n    });\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Add schema order should not break the startup","suites":[],"updatePoint":{"line":1363,"column":51,"index":28573},"line":1363,"code":"test('Add schema order should not break the startup', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      random: 'options'\n    }\n  }, () => {});\n  fastify.register(fp((f, opts) => {\n    f.addSchema({\n      $id: 'https://example.com/bson/objectId',\n      type: 'string',\n      pattern: '\\\\b[0-9A-Fa-f]{24}\\\\b'\n    });\n    return Promise.resolve(); // avoid async for node 6\n  }));\n  fastify.get('/:id', {\n    schema: {\n      params: {\n        type: 'object',\n        properties: {\n          id: {\n            $ref: 'https://example.com/bson/objectId#'\n          }\n        }\n      }\n    }\n  }, () => {});\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"The schema compiler recreate itself if needed","suites":[],"updatePoint":{"line":1395,"column":51,"index":29268},"line":1395,"code":"test('The schema compiler recreate itself if needed', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.options('/', {\n    schema: {\n      hide: true\n    }\n  }, echoBody);\n  fastify.register(function (fastify, options, done) {\n    fastify.addSchema({\n      $id: 'identifier',\n      type: 'string',\n      format: 'uuid'\n    });\n    fastify.get('/:foobarId', {\n      schema: {\n        params: {\n          foobarId: {\n            $ref: 'identifier#'\n          }\n        }\n      }\n    }, echoBody);\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Schema controller setter","suites":[],"updatePoint":{"line":1424,"column":30,"index":29822},"line":1424,"code":"test('Schema controller setter', t => {\n  t.plan(2);\n  Fastify({\n    schemaController: {}\n  });\n  t.pass('allow empty object');\n\n  try {\n    Fastify({\n      schemaController: {\n        bucket: {}\n      }\n    });\n    t.fail('the bucket option must be a function');\n  } catch (err) {\n    t.equal(err.message, \"schemaController.bucket option should be a function, instead got 'object'\");\n  }\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Schema controller bucket","suites":[],"updatePoint":{"line":1442,"column":30,"index":30215},"line":1442,"code":"test('Schema controller bucket', t => {\n  t.plan(10);\n  let added = 0;\n  let builtBucket = 0;\n  const initStoreQueue = [];\n\n  function factoryBucket(storeInit) {\n    builtBucket++;\n    t.same(initStoreQueue.pop(), storeInit);\n    const store = new Map(storeInit);\n    return {\n      add(schema) {\n        added++;\n        store.set(schema.$id, schema);\n      },\n\n      getSchema(id) {\n        return store.get(id);\n      },\n\n      getSchemas() {\n        // what is returned by this function, will be the `storeInit` parameter\n        initStoreQueue.push(store);\n        return store;\n      }\n\n    };\n  }\n\n  const fastify = Fastify({\n    schemaController: {\n      bucket: factoryBucket\n    }\n  });\n  fastify.register(async instance => {\n    instance.addSchema({\n      $id: 'b',\n      type: 'string'\n    });\n    instance.addHook('onReady', function (done) {\n      t.equal(instance.getSchemas().size, 2);\n      done();\n    });\n    instance.register(async subinstance => {\n      subinstance.addSchema({\n        $id: 'c',\n        type: 'string'\n      });\n      subinstance.addHook('onReady', function (done) {\n        t.equal(subinstance.getSchemas().size, 3);\n        done();\n      });\n    });\n  });\n  fastify.register(async instance => {\n    instance.addHook('onReady', function (done) {\n      t.equal(instance.getSchemas().size, 1);\n      done();\n    });\n  });\n  fastify.addSchema({\n    $id: 'a',\n    type: 'string'\n  });\n  fastify.ready(err => {\n    t.error(err);\n    t.equal(added, 3, 'three schema added');\n    t.equal(builtBucket, 4, 'one bucket built for every register call + 1 for the root instance');\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController per instance","suites":[],"updatePoint":{"line":1512,"column":38,"index":31840},"line":1512,"code":"test('setSchemaController per instance', t => {\n  t.plan(7);\n  const fastify = Fastify({});\n  fastify.register(async instance1 => {\n    instance1.setSchemaController({\n      bucket: function factoryBucket(storeInit) {\n        t.pass('instance1 has created the bucket');\n        return {\n          add(schema) {\n            t.fail('add is not called');\n          },\n\n          getSchema(id) {\n            t.fail('getSchema is not called');\n          },\n\n          getSchemas() {\n            t.fail('getSchemas is not called');\n          }\n\n        };\n      }\n    });\n  });\n  fastify.register(async instance2 => {\n    const bSchema = {\n      $id: 'b',\n      type: 'string'\n    };\n    instance2.setSchemaController({\n      bucket: function factoryBucket(storeInit) {\n        t.pass('instance2 has created the bucket');\n        const map = {};\n        return {\n          add(schema) {\n            t.equal(schema.$id, bSchema.$id, 'add is called');\n            map[schema.$id] = schema;\n          },\n\n          getSchema(id) {\n            t.pass('getSchema is called');\n            return map[id];\n          },\n\n          getSchemas() {\n            t.pass('getSchemas is called');\n          }\n\n        };\n      }\n    });\n    instance2.addSchema(bSchema);\n    instance2.addHook('onReady', function (done) {\n      instance2.getSchemas();\n      t.same(instance2.getSchema('b'), bSchema, 'the schema are loaded');\n      done();\n    });\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController: Inherits correctly parent schemas with a customized validator instance","suites":[],"updatePoint":{"line":1574,"column":97,"index":33385},"line":1574,"code":"test('setSchemaController: Inherits correctly parent schemas with a customized validator instance', async t => {\n  t.plan(5);\n  const customAjv = new Ajv({\n    coerceTypes: false\n  });\n  const server = Fastify();\n  const someSchema = {\n    $id: 'some',\n    type: 'array',\n    items: {\n      type: 'string'\n    }\n  };\n  const errorResponseSchema = {\n    $id: 'error_response',\n    type: 'object',\n    properties: {\n      statusCode: {\n        type: 'integer'\n      },\n      message: {\n        type: 'string'\n      }\n    }\n  };\n  server.addSchema(someSchema);\n  server.addSchema(errorResponseSchema);\n  server.register((instance, _, done) => {\n    instance.setSchemaController({\n      compilersFactory: {\n        buildValidator: function (externalSchemas) {\n          const schemaKeys = Object.keys(externalSchemas);\n          t.equal(schemaKeys.length, 2, 'Contains same number of schemas');\n          t.hasStrict([someSchema, errorResponseSchema], Object.values(externalSchemas), 'Contains expected schemas');\n\n          for (const key of schemaKeys) {\n            if (customAjv.getSchema(key) == null) {\n              customAjv.addSchema(externalSchemas[key], key);\n            }\n          }\n\n          return function validatorCompiler({\n            schema\n          }) {\n            return customAjv.compile(schema);\n          };\n        }\n      }\n    });\n    instance.get('/', {\n      schema: {\n        querystring: {\n          msg: {\n            $ref: 'some#'\n          }\n        },\n        response: {\n          '4xx': {\n            $ref: 'error_response#'\n          }\n        }\n      }\n    }, (req, reply) => {\n      reply.send({\n        noop: 'noop'\n      });\n    });\n    done();\n  });\n  const res = await server.inject({\n    method: 'GET',\n    url: '/',\n    query: {\n      msg: 'string'\n    }\n  });\n  const json = res.json();\n  t.equal(json.message, 'querystring.msg should be array');\n  t.equal(json.statusCode, 400);\n  t.equal(res.statusCode, 400, 'Should not coearce the string into array');\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController: Inherits buildSerializer from parent if not present within the instance","suites":[],"updatePoint":{"line":1655,"column":98,"index":35394},"line":1655,"code":"test('setSchemaController: Inherits buildSerializer from parent if not present within the instance', async t => {\n  t.plan(6);\n  const customAjv = new Ajv({\n    coerceTypes: false\n  });\n  const someSchema = {\n    $id: 'some',\n    type: 'array',\n    items: {\n      type: 'string'\n    }\n  };\n  const errorResponseSchema = {\n    $id: 'error_response',\n    type: 'object',\n    properties: {\n      statusCode: {\n        type: 'integer'\n      },\n      message: {\n        type: 'string'\n      }\n    }\n  };\n  let rootSerializerCalled = 0;\n  let rootValidatorCalled = 0;\n  let childValidatorCalled = 0;\n\n  const rootBuildSerializer = function (externalSchemas) {\n    rootSerializerCalled++;\n    return function serializer() {\n      return data => {\n        return JSON.stringify({\n          statusCode: data.statusCode,\n          message: data.message\n        });\n      };\n    };\n  };\n\n  const rootBuildValidator = function (externalSchemas) {\n    rootValidatorCalled++;\n    return function validatorCompiler({\n      schema\n    }) {\n      return customAjv.compile(schema);\n    };\n  };\n\n  const server = Fastify({\n    schemaController: {\n      compilersFactory: {\n        buildValidator: rootBuildValidator,\n        buildSerializer: rootBuildSerializer\n      }\n    }\n  });\n  server.addSchema(someSchema);\n  server.addSchema(errorResponseSchema);\n  server.register((instance, _, done) => {\n    instance.setSchemaController({\n      compilersFactory: {\n        buildValidator: function (externalSchemas) {\n          childValidatorCalled++;\n          const schemaKeys = Object.keys(externalSchemas);\n\n          for (const key of schemaKeys) {\n            if (customAjv.getSchema(key) == null) {\n              customAjv.addSchema(externalSchemas[key], key);\n            }\n          }\n\n          return function validatorCompiler({\n            schema\n          }) {\n            return customAjv.compile(schema);\n          };\n        }\n      }\n    });\n    instance.get('/', {\n      schema: {\n        querystring: {\n          msg: {\n            $ref: 'some#'\n          }\n        },\n        response: {\n          '4xx': {\n            $ref: 'error_response#'\n          }\n        }\n      }\n    }, (req, reply) => {\n      reply.send({\n        noop: 'noop'\n      });\n    });\n    done();\n  });\n  const res = await server.inject({\n    method: 'GET',\n    url: '/',\n    query: {\n      msg: 'string'\n    }\n  });\n  const json = res.json();\n  t.equal(json.statusCode, 400);\n  t.equal(json.message, 'querystring.msg should be array');\n  t.equal(rootSerializerCalled, 1, 'Should be called from the child');\n  t.equal(rootValidatorCalled, 0, 'Should not be called from the child');\n  t.equal(childValidatorCalled, 1, 'Should be called from the child');\n  t.equal(res.statusCode, 400, 'Should not coerce the string into array');\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController: Inherits buildValidator from parent if not present within the instance","suites":[],"updatePoint":{"line":1770,"column":97,"index":38192},"line":1770,"code":"test('setSchemaController: Inherits buildValidator from parent if not present within the instance', async t => {\n  t.plan(6);\n  const customAjv = new Ajv({\n    coerceTypes: false\n  });\n  const someSchema = {\n    $id: 'some',\n    type: 'array',\n    items: {\n      type: 'string'\n    }\n  };\n  const errorResponseSchema = {\n    $id: 'error_response',\n    type: 'object',\n    properties: {\n      statusCode: {\n        type: 'integer'\n      },\n      message: {\n        type: 'string'\n      }\n    }\n  };\n  let rootSerializerCalled = 0;\n  let rootValidatorCalled = 0;\n  let childSerializerCalled = 0;\n\n  const rootBuildSerializer = function (externalSchemas) {\n    rootSerializerCalled++;\n    return function serializer() {\n      return data => JSON.stringify(data);\n    };\n  };\n\n  const rootBuildValidator = function (externalSchemas) {\n    rootValidatorCalled++;\n    const schemaKeys = Object.keys(externalSchemas);\n\n    for (const key of schemaKeys) {\n      if (customAjv.getSchema(key) == null) {\n        customAjv.addSchema(externalSchemas[key], key);\n      }\n    }\n\n    return function validatorCompiler({\n      schema\n    }) {\n      return customAjv.compile(schema);\n    };\n  };\n\n  const server = Fastify({\n    schemaController: {\n      compilersFactory: {\n        buildValidator: rootBuildValidator,\n        buildSerializer: rootBuildSerializer\n      }\n    }\n  });\n  server.register((instance, _, done) => {\n    instance.register((subInstance, _, subDone) => {\n      subInstance.setSchemaController({\n        compilersFactory: {\n          buildSerializer: function (externalSchemas) {\n            childSerializerCalled++;\n            return function serializerCompiler() {\n              return data => {\n                return JSON.stringify({\n                  statusCode: data.statusCode,\n                  message: data.message\n                });\n              };\n            };\n          }\n        }\n      });\n      subInstance.get('/', {\n        schema: {\n          querystring: {\n            msg: {\n              $ref: 'some#'\n            }\n          },\n          response: {\n            '4xx': {\n              $ref: 'error_response#'\n            }\n          }\n        }\n      }, (req, reply) => {\n        reply.send({\n          noop: 'noop'\n        });\n      });\n      subDone();\n    });\n    done();\n  });\n  server.addSchema(someSchema);\n  server.addSchema(errorResponseSchema);\n  const res = await server.inject({\n    method: 'GET',\n    url: '/',\n    query: {\n      msg: ['string']\n    }\n  });\n  const json = res.json();\n  t.equal(json.statusCode, 400);\n  t.equal(json.message, 'querystring.msg should be array');\n  t.equal(rootSerializerCalled, 0, 'Should be called from the child');\n  t.equal(rootValidatorCalled, 1, 'Should not be called from the child');\n  t.equal(childSerializerCalled, 1, 'Should be called from the child');\n  t.equal(res.statusCode, 400, 'Should not coearce the string into array');\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should throw if not default validator passed","suites":[],"updatePoint":{"line":1886,"column":50,"index":41066},"line":1886,"code":"test('Should throw if not default validator passed', async t => {\n  t.plan(4);\n  const customAjv = new Ajv({\n    coerceTypes: false\n  });\n  const someSchema = {\n    $id: 'some',\n    type: 'array',\n    items: {\n      type: 'string'\n    }\n  };\n  const anotherSchema = {\n    $id: 'another',\n    type: 'integer'\n  };\n  const plugin = fp(function (pluginInstance, _, pluginDone) {\n    pluginInstance.setSchemaController({\n      compilersFactory: {\n        buildValidator: function (externalSchemas) {\n          const schemaKeys = Object.keys(externalSchemas);\n          t.equal(schemaKeys.length, 2);\n          t.same(schemaKeys, ['some', 'another']);\n\n          for (const key of schemaKeys) {\n            if (customAjv.getSchema(key) == null) {\n              customAjv.addSchema(externalSchemas[key], key);\n            }\n          }\n\n          return function validatorCompiler({\n            schema\n          }) {\n            return customAjv.compile(schema);\n          };\n        }\n      }\n    });\n    pluginDone();\n  });\n  const server = Fastify();\n  server.addSchema(someSchema);\n  server.register((instance, opts, done) => {\n    instance.addSchema(anotherSchema);\n    instance.register(plugin, {});\n    instance.post('/', {\n      schema: {\n        query: {\n          msg: {\n            $ref: 'some#'\n          }\n        },\n        headers: {\n          'x-another': {\n            $ref: 'another#'\n          }\n        }\n      }\n    }, (req, reply) => {\n      reply.send({\n        noop: 'noop'\n      });\n    });\n    done();\n  });\n\n  try {\n    const res = await server.inject({\n      method: 'POST',\n      url: '/',\n      query: {\n        msg: ['string']\n      }\n    });\n    t.equal(res.json().message, 'querystring.msg should be array');\n    t.equal(res.statusCode, 400, 'Should not coearce the string into array');\n  } catch (err) {\n    t.error(err);\n  }\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"Should throw if not default validator passed","suites":[],"updatePoint":{"line":1966,"column":50,"index":42924},"line":1966,"code":"test('Should throw if not default validator passed', async t => {\n  t.plan(2);\n  const someSchema = {\n    $id: 'some',\n    type: 'array',\n    items: {\n      type: 'string'\n    }\n  };\n  const anotherSchema = {\n    $id: 'another',\n    type: 'integer'\n  };\n  const server = Fastify();\n  server.addSchema(someSchema);\n  server.register((instance, opts, done) => {\n    instance.addSchema(anotherSchema);\n    instance.post('/', {\n      schema: {\n        query: {\n          msg: {\n            $ref: 'some#'\n          }\n        },\n        headers: {\n          'x-another': {\n            $ref: 'another#'\n          }\n        }\n      }\n    }, (req, reply) => {\n      reply.send({\n        noop: 'noop'\n      });\n    });\n    done();\n  });\n\n  try {\n    const res = await server.inject({\n      method: 'POST',\n      url: '/',\n      query: {\n        msg: ['string']\n      }\n    });\n    t.equal(res.json().message, 'querystring.msg should be array');\n    t.equal(res.statusCode, 400, 'Should not coearce the string into array');\n  } catch (err) {\n    t.error(err);\n  }\n});","file":"schema-feature.test.js","skipped":false,"dir":"test"},{"name":"basic test","suites":[],"updatePoint":{"line":13,"column":16,"index":176},"line":13,"code":"test('basic test', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'object',\n          properties: {\n            name: {\n              type: 'string'\n            },\n            work: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    }\n  }, function (req, reply) {\n    reply.code(200).send({\n      name: 'Foo',\n      work: 'Bar',\n      nick: 'Boo'\n    });\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      name: 'Foo',\n      work: 'Bar'\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"custom serializer options","suites":[],"updatePoint":{"line":48,"column":31,"index":838},"line":48,"code":"test('custom serializer options', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    serializerOpts: {\n      rounding: 'ceil'\n    }\n  });\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'integer'\n        }\n      }\n    }\n  }, function (req, reply) {\n    reply.send(4.2);\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '5', 'it must use the ceil rouding');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Use the same schema id in different places","suites":[],"updatePoint":{"line":72,"column":48,"index":1333},"line":72,"code":"test('Use the same schema id in different places', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.get('/:id', {\n    handler(req, reply) {\n      reply.send([{\n        id: 1\n      }, {\n        id: 2\n      }, {\n        what: 'is this'\n      }]);\n    },\n\n    schema: {\n      response: {\n        200: {\n          type: 'array',\n          items: {\n            $ref: 'test'\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/123'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), [{\n      id: 1\n    }, {\n      id: 2\n    }, {}]);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Use shared schema and $ref with $id in response ($ref to $id)","suites":[],"updatePoint":{"line":118,"column":67,"index":2080},"line":118,"code":"test('Use shared schema and $ref with $id in response ($ref to $id)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://foo/test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  const complexSchema = {\n    $schema: 'http://json-schema.org/draft-07/schema#',\n    $id: 'http://foo/user',\n    type: 'object',\n    definitions: {\n      address: {\n        $id: '#address',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    },\n    properties: {\n      test: {\n        $ref: 'http://foo/test#'\n      },\n      address: {\n        $ref: '#address'\n      }\n    },\n    required: ['address', 'test']\n  };\n  fastify.post('/', {\n    schema: {\n      body: complexSchema,\n      response: {\n        200: complexSchema\n      }\n    },\n    handler: (req, reply) => {\n      req.body.removeThis = 'it should not be serialized';\n      reply.send(req.body);\n    }\n  });\n  const payload = {\n    address: {\n      city: 'New Node'\n    },\n    test: {\n      id: Date.now()\n    }\n  };\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), payload);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      test: {\n        id: Date.now()\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      error: 'Bad Request',\n      message: \"body should have required property 'address'\",\n      statusCode: 400\n    });\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Shared schema should be pass to serializer and validator ($ref to shared schema /definitions)","suites":[],"updatePoint":{"line":201,"column":99,"index":3716},"line":201,"code":"test('Shared schema should be pass to serializer and validator ($ref to shared schema /definitions)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://example.com/asset.json',\n    $schema: 'http://json-schema.org/draft-07/schema#',\n    title: 'Physical Asset',\n    description: 'A generic representation of a physical asset',\n    type: 'object',\n    required: ['id', 'model', 'location'],\n    properties: {\n      id: {\n        type: 'string',\n        format: 'uuid'\n      },\n      model: {\n        type: 'string'\n      },\n      location: {\n        $ref: 'http://example.com/point.json#'\n      }\n    },\n    definitions: {\n      inner: {\n        $id: '#innerId',\n        type: 'string',\n        format: 'email'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'http://example.com/point.json',\n    $schema: 'http://json-schema.org/draft-07/schema#',\n    title: 'Longitude and Latitude Values',\n    description: 'A geographical coordinate.',\n    type: 'object',\n    required: ['latitude', 'longitude'],\n    properties: {\n      email: {\n        $ref: 'http://example.com/asset.json#/definitions/inner'\n      },\n      latitude: {\n        type: 'number',\n        minimum: -90,\n        maximum: 90\n      },\n      longitude: {\n        type: 'number',\n        minimum: -180,\n        maximum: 180\n      },\n      altitude: {\n        type: 'number'\n      }\n    }\n  });\n  const schemaLocations = {\n    $id: 'http://example.com/locations.json',\n    $schema: 'http://json-schema.org/draft-07/schema#',\n    title: 'List of Asset locations',\n    type: 'array',\n    items: {\n      $ref: 'http://example.com/asset.json#'\n    },\n    default: []\n  };\n  fastify.post('/', {\n    schema: {\n      body: schemaLocations,\n      response: {\n        200: schemaLocations\n      }\n    }\n  }, (req, reply) => {\n    reply.send(locations.map(_ => Object.assign({\n      serializer: 'remove me'\n    }, _)));\n  });\n  const locations = [{\n    id: '550e8400-e29b-41d4-a716-446655440000',\n    model: 'mod',\n    location: {\n      latitude: 10,\n      longitude: 10,\n      email: 'foo@bar.it'\n    }\n  }, {\n    id: '550e8400-e29b-41d4-a716-446655440000',\n    model: 'mod',\n    location: {\n      latitude: 10,\n      longitude: 10,\n      email: 'foo@bar.it'\n    }\n  }];\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: locations\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), locations);\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: locations.map(_ => {\n        _.location.email = 'not an email';\n        return _;\n      })\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n      t.same(res.json(), {\n        error: 'Bad Request',\n        message: 'body[0].location.email should match format \"email\"',\n        statusCode: 400\n      });\n    });\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Custom setSerializerCompiler","suites":[],"updatePoint":{"line":321,"column":34,"index":6489},"line":321,"code":"test('Custom setSerializerCompiler', t => {\n  t.plan(7);\n  const fastify = Fastify();\n  const outSchema = {\n    $id: 'test',\n    type: 'object',\n    whatever: 'need to be parsed by the custom serializer'\n  };\n  fastify.setSerializerCompiler(({\n    schema,\n    method,\n    url,\n    httpStatus\n  }) => {\n    t.equal(method, 'GET');\n    t.equal(url, '/foo/:id');\n    t.equal(httpStatus, '200');\n    t.same(schema, outSchema);\n    return data => JSON.stringify(data);\n  });\n  fastify.register((instance, opts, done) => {\n    instance.get('/:id', {\n      handler(req, reply) {\n        reply.send({\n          id: 1\n        });\n      },\n\n      schema: {\n        response: {\n          200: outSchema\n        }\n      }\n    });\n    t.ok(instance.serializerCompiler, 'the serializer is set by the parent');\n    done();\n  }, {\n    prefix: '/foo'\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/foo/123'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, JSON.stringify({\n      id: 1\n    }));\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Custom setSerializerCompiler returns bad serialized output","suites":[],"updatePoint":{"line":370,"column":64,"index":7529},"line":370,"code":"test('Custom setSerializerCompiler returns bad serialized output', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const outSchema = {\n    $id: 'test',\n    type: 'object',\n    whatever: 'need to be parsed by the custom serializer'\n  };\n  fastify.setSerializerCompiler(({\n    schema,\n    method,\n    url,\n    httpStatus\n  }) => {\n    return data => {\n      t.pass('returning an invalid serialization');\n      return {\n        not: 'a string'\n      };\n    };\n  });\n  fastify.get('/:id', {\n    handler(req, reply) {\n      throw new Error('ops');\n    },\n\n    schema: {\n      response: {\n        500: outSchema\n      }\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/123'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 500);\n    t.strictSame(res.json(), {\n      error: 'Internal Server Error',\n      code: 'FST_ERR_REP_INVALID_PAYLOAD_TYPE',\n      message: 'Attempted to send payload of invalid type \\'object\\'. Expected a string or Buffer.',\n      statusCode: 500\n    });\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Custom serializer per route","suites":[],"updatePoint":{"line":416,"column":33,"index":8512},"line":416,"code":"test('Custom serializer per route', async t => {\n  const fastify = Fastify();\n  const outSchema = {\n    $id: 'test',\n    type: 'object',\n    properties: {\n      mean: {\n        type: 'string'\n      }\n    }\n  };\n  fastify.get('/default', {\n    handler(req, reply) {\n      reply.send({\n        mean: 'default'\n      });\n    },\n\n    schema: {\n      response: {\n        200: outSchema\n      }\n    }\n  });\n  let hit = 0;\n  fastify.register((instance, opts, done) => {\n    instance.setSerializerCompiler(({\n      schema,\n      method,\n      url,\n      httpStatus\n    }) => {\n      hit++;\n      return data => JSON.stringify({\n        mean: 'custom'\n      });\n    });\n    instance.get('/custom', {\n      handler(req, reply) {\n        reply.send({});\n      },\n\n      schema: {\n        response: {\n          200: outSchema\n        }\n      }\n    });\n    instance.get('/route', {\n      handler(req, reply) {\n        reply.send({});\n      },\n\n      serializerCompiler: ({\n        schema,\n        method,\n        url,\n        httpPart\n      }) => {\n        hit++;\n        return data => JSON.stringify({\n          mean: 'route'\n        });\n      },\n      schema: {\n        response: {\n          200: outSchema\n        }\n      }\n    });\n    done();\n  });\n  let res = await fastify.inject('/default');\n  t.equal(res.json().mean, 'default');\n  res = await fastify.inject('/custom');\n  t.equal(res.json().mean, 'custom');\n  res = await fastify.inject('/route');\n  t.equal(res.json().mean, 'route');\n  t.equal(hit, 2, 'the custom and route serializer has been called');\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Reply serializer win over serializer ","suites":[],"updatePoint":{"line":496,"column":43,"index":10078},"line":496,"code":"test('Reply serializer win over serializer ', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.setReplySerializer(function (payload, statusCode) {\n    t.same(payload, {\n      name: 'Foo',\n      work: 'Bar',\n      nick: 'Boo'\n    });\n    return 'instance serializator';\n  });\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'object',\n          properties: {\n            name: {\n              type: 'string'\n            },\n            work: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    },\n    serializerCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      t.ok(method, 'the custom compiler has been created');\n      return () => {\n        t.fail('the serializer must not be called when there is a reply serializer');\n        return 'fail';\n      };\n    }\n  }, function (req, reply) {\n    reply.code(200).send({\n      name: 'Foo',\n      work: 'Bar',\n      nick: 'Boo'\n    });\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'instance serializator');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Reply serializer win over serializer ","suites":[],"updatePoint":{"line":548,"column":43,"index":11221},"line":548,"code":"test('Reply serializer win over serializer ', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.setReplySerializer(function (payload, statusCode) {\n    t.same(payload, {\n      name: 'Foo',\n      work: 'Bar',\n      nick: 'Boo'\n    });\n    return 'instance serializator';\n  });\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'object',\n          properties: {\n            name: {\n              type: 'string'\n            },\n            work: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    },\n    serializerCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      t.ok(method, 'the custom compiler has been created');\n      return () => {\n        t.fail('the serializer must not be called when there is a reply serializer');\n        return 'fail';\n      };\n    }\n  }, function (req, reply) {\n    reply.code(200).send({\n      name: 'Foo',\n      work: 'Bar',\n      nick: 'Boo'\n    });\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'instance serializator');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"The schema compiler recreate itself if needed","suites":[],"updatePoint":{"line":600,"column":51,"index":12372},"line":600,"code":"test('The schema compiler recreate itself if needed', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.options('/', {\n    schema: {\n      response: {\n        '2xx': {\n          hello: {\n            type: 'string'\n          }\n        }\n      }\n    }\n  }, echoBody);\n  fastify.register(function (fastify, options, done) {\n    fastify.addSchema({\n      $id: 'identifier',\n      type: 'string',\n      format: 'uuid'\n    });\n    fastify.get('/', {\n      schema: {\n        response: {\n          '2xx': {\n            foobarId: {\n              $ref: 'identifier#'\n            }\n          }\n        }\n      }\n    }, echoBody);\n    done();\n  });\n  fastify.ready(err => {\n    t.error(err);\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"The schema changes the default error handler output","suites":[],"updatePoint":{"line":637,"column":57,"index":13077},"line":637,"code":"test('The schema changes the default error handler output', async t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/:code', {\n    schema: {\n      response: {\n        '2xx': {\n          hello: {\n            type: 'string'\n          }\n        },\n        501: {\n          type: 'object',\n          properties: {\n            message: {\n              type: 'string'\n            }\n          }\n        },\n        '5xx': {\n          type: 'object',\n          properties: {\n            customId: {\n              type: 'number'\n            },\n            error: {\n              type: 'string'\n            },\n            message: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    }\n  }, (request, reply) => {\n    if (request.params.code === '501') {\n      return reply.code(501).send(new Error('501 message'));\n    }\n\n    const error = new Error('500 message');\n    error.customId = 42;\n    reply.send(error);\n  });\n  let res = await fastify.inject('/501');\n  t.equal(res.statusCode, 501);\n  t.same(res.json(), {\n    message: '501 message'\n  });\n  res = await fastify.inject('/500');\n  t.equal(res.statusCode, 500);\n  t.same(res.json(), {\n    error: 'Internal Server Error',\n    message: '500 message',\n    customId: 42\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"do not crash if status code serializer errors","suites":[],"updatePoint":{"line":694,"column":51,"index":14334},"line":694,"code":"test('do not crash if status code serializer errors', async t => {\n  const fastify = Fastify();\n  const requiresFoo = {\n    properties: {\n      foo: {\n        type: 'string'\n      }\n    },\n    required: ['foo']\n  };\n  const someUserErrorType2 = {\n    properties: {\n      code: {\n        type: 'number'\n      }\n    },\n    required: ['code']\n  };\n  fastify.get('/', {\n    schema: {\n      query: requiresFoo,\n      response: {\n        400: someUserErrorType2\n      }\n    }\n  }, (request, reply) => {\n    t.fail('handler, should not be called');\n  });\n  const res = await fastify.inject({\n    path: '/',\n    query: {\n      notfoo: true\n    }\n  });\n  t.equal(res.statusCode, 500);\n  t.same(res.json(), {\n    statusCode: 500,\n    error: 'Internal Server Error',\n    message: '\"code\" is required!'\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"custom schema serializer error, empty message","suites":[],"updatePoint":{"line":735,"column":51,"index":15135},"line":735,"code":"test('custom schema serializer error, empty message', async t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.get('/:code', {\n    schema: {\n      response: {\n        '2xx': {\n          hello: {\n            type: 'string'\n          }\n        },\n        501: {\n          type: 'object',\n          properties: {\n            message: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    }\n  }, (request, reply) => {\n    if (request.params.code === '501') {\n      return reply.code(501).send(new Error(''));\n    }\n  });\n  const res = await fastify.inject('/501');\n  t.equal(res.statusCode, 501);\n  t.same(res.json(), {\n    message: ''\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"error in custom schema serialize compiler, throw FST_ERR_SCH_SERIALIZATION_BUILD error","suites":[],"updatePoint":{"line":767,"column":92,"index":15851},"line":767,"code":"test('error in custom schema serialize compiler, throw FST_ERR_SCH_SERIALIZATION_BUILD error', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': {\n          type: 'object',\n          properties: {\n            some: {\n              type: 'string'\n            }\n          }\n        },\n        500: {\n          type: 'object',\n          properties: {\n            message: {\n              type: 'string'\n            }\n          }\n        }\n      }\n    },\n    serializerCompiler: () => {\n      throw new Error('CUSTOM_ERROR');\n    }\n  }, function (req, reply) {\n    reply.code(200).send({\n      some: 'thing'\n    });\n  });\n  fastify.ready(err => {\n    t.equal(err.message, 'Failed building the serialization schema for GET: /, due to error CUSTOM_ERROR');\n    t.equal(err.statusCode, 500);\n    t.equal(err.code, 'FST_ERR_SCH_SERIALIZATION_BUILD');\n  });\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Errors in searilizer sended to errorHandler","suites":[],"updatePoint":{"line":805,"column":49,"index":16728},"line":805,"code":"test('Errors in searilizer sended to errorHandler', async t => {\n  let savedError;\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      response: {\n        200: {\n          type: 'object',\n          properties: {\n            name: {\n              type: 'string'\n            },\n            power: {\n              type: 'string'\n            }\n          },\n          required: ['name']\n        }\n      }\n    }\n  }, function (req, reply) {\n    reply.code(200).send({\n      no: 'thing'\n    });\n  });\n  fastify.setErrorHandler((error, request, reply) => {\n    savedError = error;\n    reply.code(500).send(error);\n  });\n  const res = await fastify.inject('/');\n  t.equal(res.statusCode, 500); // t.same(savedError, new Error('\"name\" is required!'));\n\n  t.same(res.json(), {\n    statusCode: 500,\n    error: 'Internal Server Error',\n    message: '\"name\" is required!'\n  });\n  t.ok(savedError, 'error presents');\n  t.ok(savedError.serialization, 'Serialization sign presents');\n  t.end();\n});","file":"schema-serialization.test.js","skipped":false,"dir":"test"},{"name":"Ajv8 usage instead of the bundle one","suites":[],"updatePoint":{"line":21,"column":42,"index":389},"line":21,"code":"test('Ajv8 usage instead of the bundle one', t => {\n  t.plan(2);\n  t.test('use new ajv8 option', t => {\n    t.plan(2);\n    const fastify = Fastify({\n      ajv: {\n        customOptions: {\n          strictRequired: true\n        }\n      },\n      schemaController: {\n        compilersFactory: {\n          buildValidator: buildValidatorAJV8()\n        }\n      }\n    });\n    fastify.post('/', {\n      schema: {\n        body: {\n          type: 'object',\n          required: ['missing'],\n          properties: {\n            foo: {\n              type: 'string'\n            }\n          }\n        }\n      },\n\n      handler(req, reply) {\n        reply.send({\n          ok: 1\n        });\n      }\n\n    });\n    fastify.ready(err => {\n      t.ok(err);\n      t.match(err.message, 'strictRequired', 'the new ajv8 option trigger a startup error');\n    });\n  });\n  t.test('use new ajv8 option within a response schema', t => {\n    t.plan(2);\n    const fastify = Fastify({\n      schemaController: {\n        compilersFactory: {\n          buildValidator: buildValidatorAJV8()\n        }\n      }\n    });\n    fastify.post('/', {\n      schema: {\n        body: {\n          type: 'object',\n          required: ['missing'],\n          properties: {\n            foo: {\n              type: 'string'\n            }\n          }\n        },\n        response: {\n          '2xx': {\n            type: 'object',\n            properties: {\n              ok: {\n                type: 'integer'\n              }\n            }\n          }\n        }\n      },\n\n      handler(req, reply) {\n        reply.send({\n          ok: 1\n        });\n      }\n\n    });\n    fastify.ready(err => {\n      t.error(err);\n      t.pass('startup successful');\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Ajv8 usage with plugins","suites":[],"updatePoint":{"line":107,"column":29,"index":2080},"line":107,"code":"test('Ajv8 usage with plugins', t => {\n  t.plan(2);\n  t.test('use new ajv8 option', t => {\n    t.plan(3);\n    const fastify = Fastify({\n      ajv: {\n        customOptions: {\n          validateFormats: true\n        },\n        plugins: [require('ajv-formats')]\n      },\n      schemaController: {\n        compilersFactory: {\n          buildValidator: buildValidatorAJV8()\n        }\n      }\n    });\n    callIt(fastify, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n      t.equal(res.json().message, 'body must match format \"date\"');\n    });\n  });\n  t.test('use new ajv8 option - avoid check', t => {\n    t.plan(2);\n    const fastify = Fastify({\n      ajv: {\n        customOptions: {\n          validateFormats: false\n        }\n      },\n      schemaController: {\n        compilersFactory: {\n          buildValidator: buildValidatorAJV8()\n        }\n      }\n    });\n    callIt(fastify, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n    });\n  });\n\n  function callIt(fastify, cb) {\n    fastify.post('/', {\n      schema: {\n        body: {\n          type: 'object',\n          properties: {\n            foo: {\n              type: 'string',\n              format: 'date'\n            }\n          }\n        }\n      },\n\n      handler(req, reply) {\n        reply.send({\n          ok: 1\n        });\n      }\n\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        foo: '99'\n      }\n    }, cb);\n  }\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Ajv plugins array parameter","suites":[],"updatePoint":{"line":180,"column":33,"index":3554},"line":180,"code":"test('Ajv plugins array parameter', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        jsonPointers: true,\n        allErrors: true\n      },\n      plugins: [[ajvErrors, {\n        singleError: '@@@@'\n      }]]\n    }\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          foo: {\n            type: 'number',\n            minimum: 2,\n            maximum: 10,\n            multipleOf: 2,\n            errorMessage: {\n              type: 'should be number',\n              minimum: 'should be >= 2',\n              maximum: 'should be <= 10',\n              multipleOf: 'should be multipleOf 2'\n            }\n          }\n        }\n      }\n    },\n\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    }\n\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      foo: 99\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.json().message, 'body/foo should be <= 10@@@@should be multipleOf 2');\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Should handle root $merge keywords in header","suites":[],"updatePoint":{"line":233,"column":50,"index":4641},"line":233,"code":"test('Should handle root $merge keywords in header', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    ajv: {\n      plugins: [ajvMergePatch]\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    schema: {\n      headers: {\n        $merge: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: {\n            required: ['q']\n          }\n        }\n      }\n    },\n\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    }\n\n  });\n  fastify.ready(err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n    });\n    fastify.inject({\n      method: 'GET',\n      url: '/',\n      headers: {\n        q: 'foo'\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Should handle root $patch keywords in header","suites":[],"updatePoint":{"line":289,"column":50,"index":5613},"line":289,"code":"test('Should handle root $patch keywords in header', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    ajv: {\n      plugins: [ajvMergePatch]\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    schema: {\n      headers: {\n        $patch: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: [{\n            op: 'add',\n            path: '/properties/q',\n            value: {\n              type: 'number'\n            }\n          }]\n        }\n      }\n    },\n\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    }\n\n  });\n  fastify.ready(err => {\n    t.error(err);\n    fastify.inject({\n      method: 'GET',\n      url: '/',\n      headers: {\n        q: 'foo'\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n    });\n    fastify.inject({\n      method: 'GET',\n      url: '/',\n      headers: {\n        q: 10\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Should handle $merge keywords in body","suites":[],"updatePoint":{"line":352,"column":43,"index":6714},"line":352,"code":"test('Should handle $merge keywords in body', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    ajv: {\n      plugins: [ajvMergePatch]\n    }\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        $merge: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: {\n            required: ['q']\n          }\n        }\n      }\n    },\n\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    }\n\n  });\n  fastify.ready(err => {\n    t.error(err);\n    fastify.inject({\n      method: 'POST',\n      url: '/'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        q: 'foo'\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Should handle $patch keywords in body","suites":[],"updatePoint":{"line":406,"column":43,"index":7649},"line":406,"code":"test('Should handle $patch keywords in body', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    ajv: {\n      plugins: [ajvMergePatch]\n    }\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        $patch: {\n          source: {\n            type: 'object',\n            properties: {\n              q: {\n                type: 'string'\n              }\n            }\n          },\n          with: [{\n            op: 'add',\n            path: '/properties/q',\n            value: {\n              type: 'number'\n            }\n          }]\n        }\n      }\n    },\n\n    handler(req, reply) {\n      reply.send({\n        ok: 1\n      });\n    }\n\n  });\n  fastify.ready(err => {\n    t.error(err);\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        q: 'foo'\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n    });\n    fastify.inject({\n      method: 'POST',\n      url: '/',\n      payload: {\n        q: 10\n      }\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 200);\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"serializer read validator's schemas","suites":[],"updatePoint":{"line":467,"column":41,"index":8718},"line":467,"code":"test(\"serializer read validator's schemas\", t => {\n  t.plan(4);\n  const ajvInstance = new AJV();\n  const baseSchema = {\n    $id: 'http://example.com/schemas/base',\n    definitions: {\n      hello: {\n        type: 'string'\n      }\n    },\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: '#/definitions/hello'\n      }\n    }\n  };\n  const refSchema = {\n    $id: 'http://example.com/schemas/ref',\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: 'http://example.com/schemas/base#/definitions/hello'\n      }\n    }\n  };\n  ajvInstance.addSchema(baseSchema);\n  ajvInstance.addSchema(refSchema);\n  const fastify = Fastify({\n    schemaController: {\n      bucket: function factory(storeInit) {\n        t.notOk(storeInit, 'is always empty because fastify.addSchema is not called');\n        return {\n          getSchemas() {\n            return {\n              [baseSchema.$id]: ajvInstance.getSchema(baseSchema.$id).schema,\n              [refSchema.$id]: ajvInstance.getSchema(refSchema.$id).schema\n            };\n          }\n\n        };\n      }\n    }\n  });\n  fastify.setValidatorCompiler(function ({\n    schema\n  }) {\n    return ajvInstance.compile(schema);\n  });\n  fastify.get('/', {\n    schema: {\n      response: {\n        '2xx': ajvInstance.getSchema('http://example.com/schemas/ref').schema\n      }\n    },\n\n    handler(req, res) {\n      res.send({\n        hello: 'world',\n        evict: 'this'\n      });\n    }\n\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      hello: 'world'\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController in a plugin","suites":[],"updatePoint":{"line":539,"column":37,"index":10311},"line":539,"code":"test('setSchemaController in a plugin', t => {\n  t.plan(5);\n  const baseSchema = {\n    $id: 'urn:schema:base',\n    definitions: {\n      hello: {\n        type: 'string'\n      }\n    },\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: '#/definitions/hello'\n      }\n    }\n  };\n  const refSchema = {\n    $id: 'urn:schema:ref',\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: 'urn:schema:base#/definitions/hello'\n      }\n    }\n  };\n  const ajvInstance = new AJV();\n  ajvInstance.addSchema(baseSchema);\n  ajvInstance.addSchema(refSchema);\n  const fastify = Fastify();\n  fastify.register(schemaPlugin);\n  fastify.get('/', {\n    schema: {\n      query: ajvInstance.getSchema('urn:schema:ref').schema,\n      response: {\n        '2xx': ajvInstance.getSchema('urn:schema:ref').schema\n      }\n    },\n\n    handler(req, res) {\n      res.send({\n        hello: 'world',\n        evict: 'this'\n      });\n    }\n\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      hello: 'world'\n    });\n  });\n\n  async function schemaPlugin(server) {\n    server.setSchemaController({\n      bucket() {\n        t.pass('the bucket is created');\n        return {\n          addSchema(source) {\n            ajvInstance.addSchema(source);\n          },\n\n          getSchema(id) {\n            return ajvInstance.getSchema(id).schema;\n          },\n\n          getSchemas() {\n            return {\n              'urn:schema:base': baseSchema,\n              'urn:schema:ref': refSchema\n            };\n          }\n\n        };\n      }\n\n    });\n    server.setValidatorCompiler(function ({\n      schema\n    }) {\n      t.pass('the querystring schema is compiled');\n      return ajvInstance.compile(schema);\n    });\n  }\n\n  schemaPlugin[Symbol.for('skip-override')] = true;\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"side effect on schema let the server crash","suites":[],"updatePoint":{"line":627,"column":48,"index":12153},"line":627,"code":"test('side effect on schema let the server crash', async t => {\n  const firstSchema = {\n    $id: 'example1',\n    type: 'object',\n    properties: {\n      name: {\n        type: 'string'\n      }\n    }\n  };\n  const reusedSchema = {\n    $id: 'example2',\n    type: 'object',\n    properties: {\n      name: {\n        oneOf: [{\n          $ref: 'example1'\n        }]\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.addSchema(firstSchema);\n  fastify.post('/a', {\n    handler: async () => 'OK',\n    schema: {\n      body: reusedSchema,\n      response: {\n        200: reusedSchema\n      }\n    }\n  });\n  fastify.post('/b', {\n    handler: async () => 'OK',\n    schema: {\n      body: reusedSchema,\n      response: {\n        200: reusedSchema\n      }\n    }\n  });\n  await fastify.ready();\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"only response schema trigger AJV pollution","suites":[],"updatePoint":{"line":670,"column":48,"index":12937},"line":670,"code":"test('only response schema trigger AJV pollution', async t => {\n  const ShowSchema = S.object().id('ShowSchema').prop('name', S.string());\n  const ListSchema = S.array().id('ListSchema').items(S.ref('ShowSchema#'));\n  const fastify = Fastify();\n  fastify.addSchema(ListSchema);\n  fastify.addSchema(ShowSchema);\n  const routeResponseSchemas = {\n    schema: {\n      response: {\n        200: S.ref('ListSchema#')\n      }\n    }\n  };\n  fastify.register(async app => {\n    app.get('/resource/', routeResponseSchemas, () => ({}));\n  }, {\n    prefix: '/prefix1'\n  });\n  fastify.register(async app => {\n    app.get('/resource/', routeResponseSchemas, () => ({}));\n  }, {\n    prefix: '/prefix2'\n  });\n  await fastify.ready();\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"only response schema trigger AJV pollution #2","suites":[],"updatePoint":{"line":695,"column":51,"index":13660},"line":695,"code":"test('only response schema trigger AJV pollution #2', async t => {\n  const ShowSchema = S.object().id('ShowSchema').prop('name', S.string());\n  const ListSchema = S.array().id('ListSchema').items(S.ref('ShowSchema#'));\n  const fastify = Fastify();\n  fastify.addSchema(ListSchema);\n  fastify.addSchema(ShowSchema);\n  const routeResponseSchemas = {\n    schema: {\n      params: S.ref('ListSchema#'),\n      response: {\n        200: S.ref('ListSchema#')\n      }\n    }\n  };\n  fastify.register(async app => {\n    app.get('/resource/', routeResponseSchemas, () => ({}));\n  }, {\n    prefix: '/prefix1'\n  });\n  fastify.register(async app => {\n    app.get('/resource/', routeResponseSchemas, () => ({}));\n  }, {\n    prefix: '/prefix2'\n  });\n  await fastify.ready();\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"setSchemaController in a plugin with head routes","suites":[],"updatePoint":{"line":721,"column":54,"index":14422},"line":721,"code":"test('setSchemaController in a plugin with head routes', t => {\n  t.plan(6);\n  const baseSchema = {\n    $id: 'urn:schema:base',\n    definitions: {\n      hello: {\n        type: 'string'\n      }\n    },\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: '#/definitions/hello'\n      }\n    }\n  };\n  const refSchema = {\n    $id: 'urn:schema:ref',\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: 'urn:schema:base#/definitions/hello'\n      }\n    }\n  };\n  const ajvInstance = new AJV();\n  ajvInstance.addSchema(baseSchema);\n  ajvInstance.addSchema(refSchema);\n  const fastify = Fastify({\n    exposeHeadRoutes: true\n  });\n  fastify.register(schemaPlugin);\n  fastify.get('/', {\n    schema: {\n      query: ajvInstance.getSchema('urn:schema:ref').schema,\n      response: {\n        '2xx': ajvInstance.getSchema('urn:schema:ref').schema\n      }\n    },\n\n    handler(req, res) {\n      res.send({\n        hello: 'world',\n        evict: 'this'\n      });\n    }\n\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      hello: 'world'\n    });\n  });\n\n  async function schemaPlugin(server) {\n    server.setSchemaController({\n      bucket() {\n        t.pass('the bucket is created');\n        return {\n          addSchema(source) {\n            ajvInstance.addSchema(source);\n          },\n\n          getSchema(id) {\n            return ajvInstance.getSchema(id).schema;\n          },\n\n          getSchemas() {\n            return {\n              'urn:schema:base': baseSchema,\n              'urn:schema:ref': refSchema\n            };\n          }\n\n        };\n      }\n\n    });\n    server.setValidatorCompiler(function ({\n      schema\n    }) {\n      if (schema.$id) {\n        const stored = ajvInstance.getSchema(schema.$id);\n\n        if (stored) {\n          t.pass('the schema is reused');\n          return stored;\n        }\n      }\n\n      t.pass('the schema is compiled');\n      return ajvInstance.compile(schema);\n    });\n  }\n\n  schemaPlugin[Symbol.for('skip-override')] = true;\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"multiple refs with the same ids","suites":[],"updatePoint":{"line":820,"column":37,"index":16464},"line":820,"code":"test('multiple refs with the same ids', t => {\n  t.plan(3);\n  const baseSchema = {\n    $id: 'urn:schema:base',\n    definitions: {\n      hello: {\n        type: 'string'\n      }\n    },\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: '#/definitions/hello'\n      }\n    }\n  };\n  const refSchema = {\n    $id: 'urn:schema:ref',\n    type: 'object',\n    properties: {\n      hello: {\n        $ref: 'urn:schema:base#/definitions/hello'\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.addSchema(baseSchema);\n  fastify.addSchema(refSchema);\n  fastify.get('/', {\n    schema: {\n      query: refSchema,\n      response: {\n        '2xx': refSchema\n      }\n    },\n\n    handler(req, res) {\n      res.send({\n        hello: 'world',\n        evict: 'this'\n      });\n    }\n\n  });\n  fastify.head('/', {\n    schema: {\n      query: refSchema,\n      response: {\n        '2xx': refSchema\n      }\n    },\n\n    handler(req, res) {\n      res.send({\n        hello: 'world',\n        evict: 'this'\n      });\n    }\n\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      hello: 'world'\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"JOI validation overwrite request headers","suites":[],"updatePoint":{"line":888,"column":46,"index":17641},"line":888,"code":"test('JOI validation overwrite request headers', t => {\n  t.plan(3);\n\n  const schemaValidator = ({\n    schema\n  }) => data => {\n    const validationResult = schema.validate(data);\n    return validationResult;\n  };\n\n  const fastify = Fastify();\n  fastify.setValidatorCompiler(schemaValidator);\n  fastify.get('/', {\n    schema: {\n      headers: Joi.object({\n        'user-agent': Joi.string().required(),\n        host: Joi.string().required()\n      })\n    }\n  }, (request, reply) => {\n    reply.send(request.headers);\n  });\n  fastify.inject('/', (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      'user-agent': 'lightMyRequest',\n      host: 'localhost:80'\n    });\n  });\n});","file":"schema-special-usage.test.js","skipped":false,"dir":"test"},{"name":"Basic validation test","suites":[],"updatePoint":{"line":83,"column":27,"index":1346},"line":83,"code":"test('Basic validation test', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body: schemaArtist\n    }\n  }, function (req, reply) {\n    reply.code(200).send(req.body.name);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'michelangelo',\n      work: 'sculptor, painter, architect and poet'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'michelangelo');\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: \"body should have required property 'work'\"\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"External AJV instance","suites":[],"updatePoint":{"line":121,"column":27,"index":2169},"line":121,"code":"test('External AJV instance', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  const ajv = new AJV();\n  ajv.addSchema(schemaA);\n  ajv.addSchema(schemaBRefToA); // the user must provide the schemas to fastify also\n\n  fastify.addSchema(schemaA);\n  fastify.addSchema(schemaBRefToA);\n  fastify.setValidatorCompiler(({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    return ajv.compile(schema);\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send({\n        foo: 1\n      });\n    },\n\n    schema: {\n      body: schemaCRefToB,\n      response: {\n        '2xx': ajv.getSchema('urn:schema:response').schema\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      foo: 42\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      foo: 'not a number'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Encapsulation","suites":[],"updatePoint":{"line":173,"column":19,"index":3159},"line":173,"code":"test('Encapsulation', t => {\n  t.plan(19);\n  const fastify = Fastify();\n  const ajv = new AJV();\n  ajv.addSchema(schemaA);\n  ajv.addSchema(schemaBRefToA); // the user must provide the schemas to fastify also\n\n  fastify.addSchema(schemaA);\n  fastify.addSchema(schemaBRefToA);\n  fastify.register((instance, opts, done) => {\n    const validator = ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return ajv.compile(schema);\n    };\n\n    instance.setValidatorCompiler(validator);\n    instance.post('/one', {\n      handler(req, reply) {\n        reply.send({\n          foo: 'one'\n        });\n      },\n\n      schema: {\n        body: ajv.getSchema('urn:schema:response').schema\n      }\n    });\n    instance.register((instance, opts, done) => {\n      instance.post('/two', {\n        handler(req, reply) {\n          t.same(instance.validatorCompiler, validator);\n          reply.send({\n            foo: 'two'\n          });\n        },\n\n        schema: {\n          body: ajv.getSchema('urn:schema:response').schema\n        }\n      });\n\n      const anotherValidator = ({\n        schema,\n        method,\n        url,\n        httpPart\n      }) => {\n        return () => {\n          return true;\n        }; // always valid\n      };\n\n      instance.post('/three', {\n        validatorCompiler: anotherValidator,\n\n        handler(req, reply) {\n          t.same(instance.validatorCompiler, validator, 'the route validator does not change the instance one');\n          reply.send({\n            foo: 'three'\n          });\n        },\n\n        schema: {\n          body: ajv.getSchema('urn:schema:response').schema\n        }\n      });\n      done();\n    });\n    done();\n  });\n  fastify.register((instance, opts, done) => {\n    instance.post('/clean', function (req, reply) {\n      t.equal(instance.validatorCompiler, undefined);\n      reply.send({\n        foo: 'bar'\n      });\n    });\n    done();\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/one',\n    payload: {\n      foo: 1\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: 'one'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/one',\n    payload: {\n      wrongFoo: 'bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/two',\n    payload: {\n      foo: 2\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: 'two'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/two',\n    payload: {\n      wrongFoo: 'bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/three',\n    payload: {\n      wrongFoo: 'but works'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: 'three'\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/clean',\n    payload: {\n      wrongFoo: 'bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: 'bar'\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Triple $ref with a simple $id","suites":[],"updatePoint":{"line":329,"column":35,"index":6343},"line":329,"code":"test('Triple $ref with a simple $id', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  const ajv = new AJV();\n  ajv.addSchema(schemaA);\n  ajv.addSchema(schemaBRefToA);\n  ajv.addSchema(schemaCRefToB); // the user must provide the schemas to fastify also\n\n  fastify.addSchema(schemaA);\n  fastify.addSchema(schemaBRefToA);\n  fastify.addSchema(schemaCRefToB);\n  fastify.setValidatorCompiler(({\n    schema,\n    method,\n    url,\n    httpPart\n  }) => {\n    return ajv.compile(schema);\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send({\n        foo: 105,\n        bar: 'foo'\n      });\n    },\n\n    schema: {\n      body: ajv.getSchema('urn:schema:request').schema,\n      response: {\n        '2xx': ajv.getSchema('urn:schema:response').schema\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      foo: 43\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      foo: 105\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      fool: 'bar'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json().message, \"body should have required property 'foo'\");\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Extending schema","suites":[],"updatePoint":{"line":388,"column":22,"index":7571},"line":388,"code":"test('Extending schema', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'address.id',\n    type: 'object',\n    definitions: {\n      address: {\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          },\n          state: {\n            type: 'string'\n          }\n        },\n        required: ['city', 'state']\n      }\n    }\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send('works');\n    },\n\n    schema: {\n      body: {\n        type: 'object',\n        properties: {\n          billingAddress: {\n            $ref: 'address.id#/definitions/address'\n          },\n          shippingAddress: {\n            allOf: [{\n              $ref: 'address.id#/definitions/address'\n            }, {\n              properties: {\n                type: {\n                  enum: ['residential', 'business']\n                }\n              },\n              required: ['type']\n            }]\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      shippingAddress: {\n        city: 'Forl',\n        state: 'FC'\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      shippingAddress: {\n        city: 'Forl',\n        state: 'FC',\n        type: 'business'\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Should work with nested ids","suites":[],"updatePoint":{"line":465,"column":33,"index":9075},"line":465,"code":"test('Should work with nested ids', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'greetings',\n    type: 'string'\n  });\n  fastify.post('/:id', {\n    handler(req, reply) {\n      reply.send(typeof req.params.id);\n    },\n\n    schema: {\n      params: {\n        $ref: 'test#'\n      },\n      body: {\n        type: 'object',\n        properties: {\n          hello: {\n            $ref: 'greetings#'\n          }\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/123',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'number');\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/abc',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.equal(res.json().message, 'params.id should be number');\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Use the same schema across multiple routes","suites":[],"updatePoint":{"line":523,"column":48,"index":10145},"line":523,"code":"test('Use the same schema across multiple routes', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.get('/first/:id', {\n    handler(req, reply) {\n      reply.send(typeof req.params.id);\n    },\n\n    schema: {\n      params: {\n        $ref: 'test#'\n      }\n    }\n  });\n  fastify.get('/second/:id', {\n    handler(req, reply) {\n      reply.send(typeof req.params.id);\n    },\n\n    schema: {\n      params: {\n        $ref: 'test#'\n      }\n    }\n  });\n  ['/first/123', '/second/123'].forEach(url => {\n    fastify.inject({\n      url,\n      method: 'GET'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.payload, 'number');\n    });\n  });\n  ['/first/abc', '/second/abc'].forEach(url => {\n    fastify.inject({\n      url,\n      method: 'GET'\n    }, (err, res) => {\n      t.error(err);\n      t.equal(res.statusCode, 400);\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"JSON Schema validation keywords","suites":[],"updatePoint":{"line":576,"column":37,"index":11113},"line":576,"code":"test('JSON Schema validation keywords', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      ip: {\n        type: 'string',\n        format: 'ipv4'\n      }\n    }\n  });\n  fastify.get('/:ip', {\n    handler(req, reply) {\n      reply.send(typeof req.params.ip);\n    },\n\n    schema: {\n      params: {\n        $ref: 'test#'\n      }\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/127.0.0.1'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'string');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/localhost'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'params.ip should match format \"ipv4\"'\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Nested id calls","suites":[],"updatePoint":{"line":621,"column":21,"index":11968},"line":621,"code":"test('Nested id calls', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      ip: {\n        type: 'string',\n        format: 'ipv4'\n      }\n    }\n  });\n  fastify.addSchema({\n    $id: 'hello',\n    type: 'object',\n    properties: {\n      host: {\n        $ref: 'test#'\n      }\n    }\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send(typeof req.body.host.ip);\n    },\n\n    schema: {\n      body: {\n        $ref: 'hello#'\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      host: {\n        ip: '127.0.0.1'\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, 'string');\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      host: {\n        ip: 'localhost'\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      error: 'Bad Request',\n      message: 'body.host.ip should match format \"ipv4\"',\n      statusCode: 400\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Use the same schema id in different places","suites":[],"updatePoint":{"line":685,"column":48,"index":13107},"line":685,"code":"test('Use the same schema id in different places', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send({\n        id: req.body.id / 2\n      });\n    },\n\n    schema: {\n      body: {\n        $ref: 'test#'\n      },\n      response: {\n        200: {\n          $ref: 'test#'\n        }\n      }\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      id: 42\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      id: 21\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Use shared schema and $ref with $id ($ref to $id)","suites":[],"updatePoint":{"line":728,"column":55,"index":13787},"line":728,"code":"test('Use shared schema and $ref with $id ($ref to $id)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://foo/test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  const body = {\n    $id: 'http://foo/user',\n    $schema: 'http://json-schema.org/draft-07/schema#',\n    type: 'object',\n    definitions: {\n      address: {\n        $id: '#address',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    },\n    required: ['address'],\n    properties: {\n      test: {\n        $ref: 'http://foo/test#'\n      },\n      // to external\n      address: {\n        $ref: '#address'\n      } // to local\n\n    }\n  };\n  fastify.post('/', {\n    handler(req, reply) {\n      reply.send(req.body.test);\n    },\n\n    schema: {\n      body,\n      response: {\n        200: {\n          $ref: 'http://foo/test#'\n        }\n      }\n    }\n  });\n  const id = Date.now();\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      address: {\n        city: 'New Node'\n      },\n      test: {\n        id\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      id\n    });\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      test: {\n        id\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      error: 'Bad Request',\n      message: \"body should have required property 'address'\",\n      statusCode: 400\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Use items with $ref","suites":[],"updatePoint":{"line":817,"column":25,"index":15332},"line":817,"code":"test('Use items with $ref', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'http://example.com/ref-to-external-validator.json',\n    type: 'object',\n    properties: {\n      hello: {\n        type: 'string'\n      }\n    }\n  });\n  const body = {\n    type: 'array',\n    items: {\n      $ref: 'http://example.com/ref-to-external-validator.json#'\n    },\n    default: []\n  };\n  fastify.post('/', {\n    schema: {\n      body\n    },\n    handler: (_, r) => {\n      r.send('ok');\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: [{\n      hello: 'world'\n    }]\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, 'ok');\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      hello: 'world'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Use $ref to /definitions","suites":[],"updatePoint":{"line":865,"column":30,"index":16199},"line":865,"code":"test('Use $ref to /definitions', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.addSchema({\n    $id: 'test',\n    type: 'object',\n    properties: {\n      id: {\n        type: 'number'\n      }\n    }\n  });\n  const body = {\n    type: 'object',\n    definitions: {\n      address: {\n        $id: '#otherId',\n        type: 'object',\n        properties: {\n          city: {\n            type: 'string'\n          }\n        }\n      }\n    },\n    properties: {\n      test: {\n        $ref: 'test#'\n      },\n      address: {\n        $ref: '#/definitions/address'\n      }\n    },\n    required: ['address', 'test']\n  };\n  fastify.post('/', {\n    schema: {\n      body,\n      response: {\n        200: body\n      }\n    },\n    handler: (req, reply) => {\n      req.body.removeThis = 'it should not be serialized';\n      reply.send(req.body);\n    }\n  });\n  const payload = {\n    address: {\n      city: 'New Node'\n    },\n    test: {\n      id: Date.now()\n    }\n  };\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), payload);\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      address: {\n        city: 'New Node'\n      },\n      test: {\n        id: 'wrong'\n      }\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n    t.same(res.json(), {\n      error: 'Bad Request',\n      message: 'body.test.id should be number',\n      statusCode: 400\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Custom AJV settings - pt1","suites":[],"updatePoint":{"line":950,"column":31,"index":17708},"line":950,"code":"test('Custom AJV settings - pt1', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body: {\n        num: {\n          type: 'integer'\n        }\n      }\n    },\n    handler: (req, reply) => {\n      t.equal(req.body.num, 12);\n      reply.send(req.body);\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      num: '12'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.same(res.json(), {\n      num: 12\n    });\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Custom AJV settings - pt2","suites":[],"updatePoint":{"line":980,"column":31,"index":18231},"line":980,"code":"test('Custom AJV settings - pt2', t => {\n  t.plan(2);\n  const fastify = Fastify({\n    ajv: {\n      customOptions: {\n        coerceTypes: false\n      }\n    }\n  });\n  fastify.post('/', {\n    schema: {\n      body: {\n        num: {\n          type: 'integer'\n        }\n      }\n    },\n    handler: (req, reply) => {\n      t.fail('the handler is not called because the \"12\" is not coerced to number');\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/',\n    payload: {\n      num: '12'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Custom AJV settings on different parameters - pt1","suites":[],"updatePoint":{"line":1012,"column":55,"index":18835},"line":1012,"code":"test('Custom AJV settings on different parameters - pt1', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.setValidatorCompiler(customValidatorCompiler);\n  fastify.post('/api/:id', {\n    schema: {\n      querystring: {\n        id: {\n          type: 'integer'\n        }\n      },\n      body: {\n        type: 'object',\n        properties: {\n          num: {\n            type: 'number'\n          }\n        },\n        required: ['num']\n      }\n    },\n    handler: (req, reply) => {\n      t.fail('the handler is not called because the \"12\" is not coerced to number');\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/api/42',\n    payload: {\n      num: '12'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"Custom AJV settings on different parameters - pt2","suites":[],"updatePoint":{"line":1048,"column":55,"index":19597},"line":1048,"code":"test('Custom AJV settings on different parameters - pt2', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.setValidatorCompiler(customValidatorCompiler);\n  fastify.post('/api/:id', {\n    schema: {\n      params: {\n        type: 'object',\n        properties: {\n          id: {\n            type: 'number'\n          }\n        },\n        required: ['id']\n      },\n      body: {\n        type: 'object',\n        properties: {\n          num: {\n            type: 'number'\n          }\n        },\n        required: ['num']\n      }\n    },\n    handler: (req, reply) => {\n      t.same(typeof req.params.id, 'number');\n      t.same(typeof req.body.num, 'number');\n      t.same(req.params.id, 42);\n      t.same(req.body.num, 12);\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    url: '/api/42',\n    payload: {\n      num: 12\n    }\n  });\n});","file":"schema-validation.test.js","skipped":false,"dir":"test"},{"name":"skip automatic reply.send() with reply.sent = true and a body","suites":[],"updatePoint":{"line":15,"column":67,"index":412},"line":15,"code":"test('skip automatic reply.send() with reply.sent = true and a body', t => {\n  const stream = split(JSON.parse);\n  const app = Fastify({\n    logger: {\n      stream\n    }\n  });\n  stream.on('data', line => {\n    t.not(line.level, 40); // there are no errors\n\n    t.not(line.level, 50); // there are no errors\n  });\n  app.get('/', (req, reply) => {\n    reply.sent = true;\n    reply.raw.end('hello world');\n    return Promise.resolve('this will be skipped');\n  });\n  return app.inject({\n    method: 'GET',\n    url: '/'\n  }).then(res => {\n    t.equal(res.statusCode, 200);\n    t.equal(res.body, 'hello world');\n  });\n});","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"skip automatic reply.send() with reply.sent = true and no body","suites":[],"updatePoint":{"line":40,"column":68,"index":1029},"line":40,"code":"test('skip automatic reply.send() with reply.sent = true and no body', t => {\n  const stream = split(JSON.parse);\n  const app = Fastify({\n    logger: {\n      stream\n    }\n  });\n  stream.on('data', line => {\n    t.not(line.level, 40); // there are no error\n\n    t.not(line.level, 50); // there are no error\n  });\n  app.get('/', (req, reply) => {\n    reply.sent = true;\n    reply.raw.end('hello world');\n    return Promise.resolve();\n  });\n  return app.inject({\n    method: 'GET',\n    url: '/'\n  }).then(res => {\n    t.equal(res.statusCode, 200);\n    t.equal(res.body, 'hello world');\n  });\n});","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"skip automatic reply.send() with reply.sent = true and an error","suites":[],"updatePoint":{"line":65,"column":69,"index":1623},"line":65,"code":"test('skip automatic reply.send() with reply.sent = true and an error', t => {\n  const stream = split(JSON.parse);\n  const app = Fastify({\n    logger: {\n      stream\n    }\n  });\n  let errorSeen = false;\n  stream.on('data', line => {\n    if (line.level === 50) {\n      errorSeen = true;\n      t.equal(line.err.message, 'kaboom');\n      t.equal(line.msg, 'Promise errored, but reply.sent = true was set');\n    }\n  });\n  app.get('/', (req, reply) => {\n    reply.sent = true;\n    reply.raw.end('hello world');\n    return Promise.reject(new Error('kaboom'));\n  });\n  return app.inject({\n    method: 'GET',\n    url: '/'\n  }).then(res => {\n    t.equal(errorSeen, true);\n    t.equal(res.statusCode, 200);\n    t.equal(res.body, 'hello world');\n  });\n});","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"Hijacking inside  skips all the following hooks and handler execution","suites":[],"updatePoint":{"line":99,"column":93,"index":2683},"line":99,"code":"  test(`Hijacking inside ${hookOrHandler} skips all the following hooks and handler execution`, t => {\n    t.plan(4);\n    const test = t.test;\n    test('Sending a response using reply.raw => onResponse hook is called', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      stream.on('data', line => {\n        t.not(line.level, 40); // there are no errors\n\n        t.not(line.level, 50); // there are no errors\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          reply.raw.end(`hello from ${hookOrHandler}`);\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          reply.raw.end(`hello from ${hookOrHandler}`);\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => {\n        if (h === 'onResponse') {\n          app.addHook(h, async (req, reply) => t.pass(`${h} should be called`));\n        } else {\n          app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`));\n        }\n      });\n      return app.inject({\n        method: 'GET',\n        url: '/'\n      }).then(res => {\n        t.equal(res.statusCode, 200);\n        t.equal(res.body, `hello from ${hookOrHandler}`);\n      });\n    });\n    test('Sending a response using req.socket => onResponse not called', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      t.teardown(() => app.close());\n      stream.on('data', line => {\n        t.not(line.level, 40); // there are no errors\n\n        t.not(line.level, 50); // there are no errors\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          req.socket.write('HTTP/1.1 200 OK\\r\\n\\r\\n');\n          req.socket.write(`hello from ${hookOrHandler}`);\n          req.socket.end();\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          req.socket.write('HTTP/1.1 200 OK\\r\\n\\r\\n');\n          req.socket.write(`hello from ${hookOrHandler}`);\n          req.socket.end();\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      app.listen(0, err => {\n        t.error(err);\n        const client = net.createConnection({\n          port: app.server.address().port\n        }, () => {\n          client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n          let chunks = '';\n          client.setEncoding('utf8');\n          client.on('data', data => {\n            chunks += data;\n          });\n          client.on('end', function () {\n            t.match(chunks, new RegExp(`hello from ${hookOrHandler}`, 'i'));\n            t.end();\n          });\n        });\n      });\n    });\n    test('Throwing an error doesnt trigger any hooks', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      t.teardown(() => app.close());\n      let errorSeen = false;\n      stream.on('data', line => {\n        if (hookOrHandler === 'handler') {\n          if (line.level === 40) {\n            errorSeen = true;\n            t.equal(line.err.code, 'FST_ERR_REP_ALREADY_SENT');\n          }\n        } else {\n          t.not(line.level, 40); // there are no errors\n\n          t.not(line.level, 50); // there are no errors\n        }\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          throw new Error('This wil be skipped');\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          throw new Error('This wil be skipped');\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      return Promise.race([app.inject({\n        method: 'GET',\n        url: '/'\n      }), new Promise((resolve, reject) => setTimeout(resolve, 1000))]).then((err, res) => {\n        t.error(err);\n\n        if (hookOrHandler === 'handler') {\n          t.equal(errorSeen, true);\n        }\n      });\n    });\n    test('Calling reply.send() after hijacking logs a warning', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      let errorSeen = false;\n      stream.on('data', line => {\n        if (line.level === 40) {\n          errorSeen = true;\n          t.equal(line.err.code, 'FST_ERR_REP_ALREADY_SENT');\n        }\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          reply.send('hello from reply.send()');\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          reply.send('hello from reply.send()');\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      return Promise.race([app.inject({\n        method: 'GET',\n        url: '/'\n      }), new Promise((resolve, reject) => setTimeout(resolve, 1000))]).then((err, res) => {\n        t.error(err);\n        t.equal(errorSeen, true);\n      });\n    });\n  });","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"Sending a response using reply.raw => onResponse hook is called","suites":[],"updatePoint":{"line":102,"column":73,"index":2806},"line":102,"code":"    test('Sending a response using reply.raw => onResponse hook is called', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      stream.on('data', line => {\n        t.not(line.level, 40); // there are no errors\n\n        t.not(line.level, 50); // there are no errors\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          reply.raw.end(`hello from ${hookOrHandler}`);\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          reply.raw.end(`hello from ${hookOrHandler}`);\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => {\n        if (h === 'onResponse') {\n          app.addHook(h, async (req, reply) => t.pass(`${h} should be called`));\n        } else {\n          app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`));\n        }\n      });\n      return app.inject({\n        method: 'GET',\n        url: '/'\n      }).then(res => {\n        t.equal(res.statusCode, 200);\n        t.equal(res.body, `hello from ${hookOrHandler}`);\n      });\n    });","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"Sending a response using req.socket => onResponse not called","suites":[],"updatePoint":{"line":144,"column":70,"index":4168},"line":144,"code":"    test('Sending a response using req.socket => onResponse not called', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      t.teardown(() => app.close());\n      stream.on('data', line => {\n        t.not(line.level, 40); // there are no errors\n\n        t.not(line.level, 50); // there are no errors\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          req.socket.write('HTTP/1.1 200 OK\\r\\n\\r\\n');\n          req.socket.write(`hello from ${hookOrHandler}`);\n          req.socket.end();\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          req.socket.write('HTTP/1.1 200 OK\\r\\n\\r\\n');\n          req.socket.write(`hello from ${hookOrHandler}`);\n          req.socket.end();\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      app.listen(0, err => {\n        t.error(err);\n        const client = net.createConnection({\n          port: app.server.address().port\n        }, () => {\n          client.write('GET / HTTP/1.1\\r\\n\\r\\n');\n          let chunks = '';\n          client.setEncoding('utf8');\n          client.on('data', data => {\n            chunks += data;\n          });\n          client.on('end', function () {\n            t.match(chunks, new RegExp(`hello from ${hookOrHandler}`, 'i'));\n            t.end();\n          });\n        });\n      });\n    });","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"Throwing an error doesnt trigger any hooks","suites":[],"updatePoint":{"line":195,"column":52,"index":5891},"line":195,"code":"    test('Throwing an error doesnt trigger any hooks', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      t.teardown(() => app.close());\n      let errorSeen = false;\n      stream.on('data', line => {\n        if (hookOrHandler === 'handler') {\n          if (line.level === 40) {\n            errorSeen = true;\n            t.equal(line.err.code, 'FST_ERR_REP_ALREADY_SENT');\n          }\n        } else {\n          t.not(line.level, 40); // there are no errors\n\n          t.not(line.level, 50); // there are no errors\n        }\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          throw new Error('This wil be skipped');\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          throw new Error('This wil be skipped');\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      return Promise.race([app.inject({\n        method: 'GET',\n        url: '/'\n      }), new Promise((resolve, reject) => setTimeout(resolve, 1000))]).then((err, res) => {\n        t.error(err);\n\n        if (hookOrHandler === 'handler') {\n          t.equal(errorSeen, true);\n        }\n      });\n    });","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"Calling reply.send() after hijacking logs a warning","suites":[],"updatePoint":{"line":243,"column":61,"index":7450},"line":243,"code":"    test('Calling reply.send() after hijacking logs a warning', t => {\n      const stream = split(JSON.parse);\n      const app = Fastify({\n        logger: {\n          stream\n        }\n      });\n      let errorSeen = false;\n      stream.on('data', line => {\n        if (line.level === 40) {\n          errorSeen = true;\n          t.equal(line.err.code, 'FST_ERR_REP_ALREADY_SENT');\n        }\n      });\n      previousHooks.forEach(h => app.addHook(h, async (req, reply) => t.pass(`${h} should be called`)));\n\n      if (hookOrHandler === 'handler') {\n        app.get('/', (req, reply) => {\n          reply.hijack();\n          reply.send('hello from reply.send()');\n        });\n      } else {\n        app.addHook(hookOrHandler, async (req, reply) => {\n          reply.hijack();\n          reply.send('hello from reply.send()');\n        });\n        app.get('/', (req, reply) => t.fail('Handler should not be called'));\n      }\n\n      nextHooks.forEach(h => app.addHook(h, async (req, reply) => t.fail(`${h} should not be called`)));\n      return Promise.race([app.inject({\n        method: 'GET',\n        url: '/'\n      }), new Promise((resolve, reject) => setTimeout(resolve, 1000))]).then((err, res) => {\n        t.error(err);\n        t.equal(errorSeen, true);\n      });\n    });","file":"skip-reply-send.test.js","skipped":false,"dir":"test"},{"name":"should respond with a stream","suites":[],"updatePoint":{"line":49,"column":34,"index":836},"line":49,"code":"test('should respond with a stream', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    const stream = fs.createReadStream(__filename, 'utf8');\n    reply.code(200).send(stream);\n  });\n  fastify.get('/error', function (req, reply) {\n    const stream = fs.createReadStream('not-existing-file', 'utf8');\n    reply.code(200).send(stream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget(`http://localhost:${fastify.server.address().port}`, function (err, response, data) {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/octet-stream');\n      t.equal(response.statusCode, 200);\n      fs.readFile(__filename, (err, expected) => {\n        t.error(err);\n        t.equal(expected.toString(), data.toString());\n      });\n    });\n    sget(`http://localhost:${fastify.server.address().port}/error`, function (err, response) {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should trigger the onSend hook","suites":[],"updatePoint":{"line":78,"column":36,"index":1852},"line":78,"code":"test('should trigger the onSend hook', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send(fs.createReadStream(__filename, 'utf8'));\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    t.ok(payload._readableState);\n    reply.header('Content-Type', 'application/javascript');\n    done();\n  });\n  fastify.inject({\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-type'], 'application/javascript');\n    t.equal(res.payload, fs.readFileSync(__filename, 'utf8'));\n    fastify.close();\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should trigger the onSend hook only twice if pumping the stream fails, first with the stream, second with the serialized error","suites":[],"updatePoint":{"line":98,"column":132,"index":2542},"line":98,"code":"test('should trigger the onSend hook only twice if pumping the stream fails, first with the stream, second with the serialized error', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', (req, reply) => {\n    reply.send(fs.createReadStream('not-existing-file', 'utf8'));\n  });\n  let counter = 0;\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    if (counter === 0) {\n      t.ok(payload._readableState);\n    } else if (counter === 1) {\n      const error = JSON.parse(payload);\n      t.equal(error.statusCode, 500);\n    }\n\n    counter++;\n    done();\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget(`http://localhost:${fastify.server.address().port}`, function (err, response) {\n      t.error(err);\n      t.equal(response.statusCode, 500);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"onSend hook stream","suites":[],"updatePoint":{"line":125,"column":24,"index":3262},"line":125,"code":"test('onSend hook stream', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    const gzStream = zlib.createGzip();\n    reply.header('Content-Encoding', 'gzip');\n    pump(fs.createReadStream(resolve(process.cwd() + '/test/stream.test.js'), 'utf8'), gzStream, t.error);\n    done(null, gzStream);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.headers['content-encoding'], 'gzip');\n    const file = fs.readFileSync(resolve(process.cwd() + '/test/stream.test.js'), 'utf8');\n    const payload = zlib.gunzipSync(res.rawPayload);\n    t.equal(payload.toString('utf-8'), file);\n    fastify.close();\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"onSend hook stream should work even if payload is not a proper stream","suites":[],"updatePoint":{"line":151,"column":75,"index":4135},"line":151,"code":"test('onSend hook stream should work even if payload is not a proper stream', t => {\n  t.plan(1);\n  const reply = proxyquire('../lib/reply', {\n    stream: {\n      finished: (...args) => {\n        if (args.length === 2) {\n          args[1](new Error('test-error'));\n        }\n      }\n    }\n  });\n  const Fastify = proxyquire('..', {\n    './lib/reply.js': reply\n  });\n  const spyLogger = {\n    fatal: () => {},\n    error: () => {},\n    warn: message => {\n      t.equal(message, 'stream payload does not end properly');\n      fastify.close();\n    },\n    info: () => {},\n    debug: () => {},\n    trace: () => {},\n    child: () => {\n      return spyLogger;\n    }\n  };\n  const fastify = Fastify({\n    logger: spyLogger\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    const fakeStream = {\n      pipe: () => {}\n    };\n    done(null, fakeStream);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"onSend hook stream should work on payload with \"close\" ending function","suites":[],"updatePoint":{"line":198,"column":76,"index":5159},"line":198,"code":"test('onSend hook stream should work on payload with \"close\" ending function', t => {\n  t.plan(1);\n  const reply = proxyquire('../lib/reply', {\n    stream: {\n      finished: (...args) => {\n        if (args.length === 2) {\n          args[1](new Error('test-error'));\n        }\n      }\n    }\n  });\n  const Fastify = proxyquire('..', {\n    './lib/reply.js': reply\n  });\n  const fastify = Fastify({\n    logger: false\n  });\n  fastify.get('/', function (req, reply) {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.addHook('onSend', (req, reply, payload, done) => {\n    const fakeStream = {\n      pipe: () => {},\n      close: cb => {\n        cb();\n        t.pass();\n      }\n    };\n    done(null, fakeStream);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"Destroying streams prematurely","suites":[],"updatePoint":{"line":235,"column":36,"index":5904},"line":235,"code":"test('Destroying streams prematurely', t => {\n  t.plan(6);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  const stream = require('stream');\n\n  const http = require('http'); // Test that \"premature close\" errors are logged with level warn\n\n\n  logStream.on('data', line => {\n    if (line.res) {\n      t.equal(line.msg, 'stream closed prematurely');\n      t.equal(line.level, 30);\n    }\n  });\n  fastify.get('/', function (request, reply) {\n    t.pass('Received request');\n    let sent = false;\n    const reallyLongStream = new stream.Readable({\n      read: function () {\n        if (!sent) {\n          this.push(Buffer.from('hello\\n'));\n        }\n\n        sent = true;\n      }\n    });\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    http.get(`http://localhost:${port}`, function (response) {\n      t.equal(response.statusCode, 200);\n      response.on('readable', function () {\n        response.destroy();\n      }); // Node bug? Node never emits 'close' here.\n\n      response.on('aborted', function () {\n        t.pass('Response closed');\n      });\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"Destroying streams prematurely should call close method","suites":[],"updatePoint":{"line":292,"column":61,"index":7276},"line":292,"code":"test('Destroying streams prematurely should call close method', t => {\n  t.plan(7);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  const stream = require('stream');\n\n  const http = require('http'); // Test that \"premature close\" errors are logged with level warn\n\n\n  logStream.on('data', line => {\n    if (line.res) {\n      t.equal(line.msg, 'stream closed prematurely');\n      t.equal(line.level, 30);\n    }\n  });\n  fastify.get('/', function (request, reply) {\n    t.pass('Received request');\n    let sent = false;\n    const reallyLongStream = new stream.Readable({\n      read: function () {\n        if (!sent) {\n          this.push(Buffer.from('hello\\n'));\n        }\n\n        sent = true;\n      }\n    });\n    reallyLongStream.destroy = undefined;\n\n    reallyLongStream.close = () => t.ok('called');\n\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    http.get(`http://localhost:${port}`, function (response) {\n      t.equal(response.statusCode, 200);\n      response.on('readable', function () {\n        response.destroy();\n      }); // Node bug? Node never emits 'close' here.\n\n      response.on('aborted', function () {\n        t.pass('Response closed');\n      });\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"Destroying streams prematurely should call close method when destroy is not a function","suites":[],"updatePoint":{"line":353,"column":92,"index":8774},"line":353,"code":"test('Destroying streams prematurely should call close method when destroy is not a function', t => {\n  t.plan(7);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  const stream = require('stream');\n\n  const http = require('http'); // Test that \"premature close\" errors are logged with level warn\n\n\n  logStream.on('data', line => {\n    if (line.res) {\n      t.equal(line.msg, 'stream closed prematurely');\n      t.equal(line.level, 30);\n    }\n  });\n  fastify.get('/', function (request, reply) {\n    t.pass('Received request');\n    let sent = false;\n    const reallyLongStream = new stream.Readable({\n      read: function () {\n        if (!sent) {\n          this.push(Buffer.from('hello\\n'));\n        }\n\n        sent = true;\n      }\n    });\n    reallyLongStream.destroy = true;\n\n    reallyLongStream.close = () => t.ok('called');\n\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    http.get(`http://localhost:${port}`, function (response) {\n      t.equal(response.statusCode, 200);\n      response.on('readable', function () {\n        response.destroy();\n      }); // Node bug? Node never emits 'close' here.\n\n      response.on('aborted', function () {\n        t.pass('Response closed');\n      });\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"Destroying streams prematurely should call abort method","suites":[],"updatePoint":{"line":414,"column":61,"index":10236},"line":414,"code":"test('Destroying streams prematurely should call abort method', t => {\n  t.plan(7);\n  let fastify = null;\n  const logStream = split(JSON.parse);\n\n  try {\n    fastify = Fastify({\n      logger: {\n        stream: logStream,\n        level: 'info'\n      }\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  const stream = require('stream');\n\n  const http = require('http'); // Test that \"premature close\" errors are logged with level warn\n\n\n  logStream.on('data', line => {\n    if (line.res) {\n      t.equal(line.msg, 'stream closed prematurely');\n      t.equal(line.level, 30);\n    }\n  });\n  fastify.get('/', function (request, reply) {\n    t.pass('Received request');\n    let sent = false;\n    const reallyLongStream = new stream.Readable({\n      read: function () {\n        if (!sent) {\n          this.push(Buffer.from('hello\\n'));\n        }\n\n        sent = true;\n      }\n    });\n    reallyLongStream.destroy = undefined;\n    reallyLongStream.close = undefined;\n\n    reallyLongStream.abort = () => t.ok('called');\n\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    http.get(`http://localhost:${port}`, function (response) {\n      t.equal(response.statusCode, 200);\n      response.on('readable', function () {\n        response.destroy();\n      }); // Node bug? Node never emits 'close' here.\n\n      response.on('aborted', function () {\n        t.pass('Response closed');\n      });\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"Destroying streams prematurely, log is disabled","suites":[],"updatePoint":{"line":476,"column":53,"index":11735},"line":476,"code":"test('Destroying streams prematurely, log is disabled', t => {\n  t.plan(4);\n  let fastify = null;\n\n  try {\n    fastify = Fastify({\n      logger: false\n    });\n  } catch (e) {\n    t.fail();\n  }\n\n  const stream = require('stream');\n\n  const http = require('http');\n\n  fastify.get('/', function (request, reply) {\n    reply.log[kDisableRequestLogging] = true;\n    let sent = false;\n    const reallyLongStream = new stream.Readable({\n      read: function () {\n        if (!sent) {\n          this.push(Buffer.from('hello\\n'));\n        }\n\n        sent = true;\n      }\n    });\n    reallyLongStream.destroy = true;\n\n    reallyLongStream.close = () => t.ok('called');\n\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    http.get(`http://localhost:${port}`, function (response) {\n      t.equal(response.statusCode, 200);\n      response.on('readable', function () {\n        response.destroy();\n      }); // Node bug? Node never emits 'close' here.\n\n      response.on('aborted', function () {\n        t.pass('Response closed');\n      });\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should respond with a stream1","suites":[],"updatePoint":{"line":526,"column":35,"index":12877},"line":526,"code":"test('should respond with a stream1', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    const stream = JSONStream.stringify();\n    reply.code(200).type('application/json').send(stream);\n    stream.write({\n      hello: 'world'\n    });\n    stream.end({\n      a: 42\n    });\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget(`http://localhost:${fastify.server.address().port}`, function (err, response, body) {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/json');\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), [{\n        hello: 'world'\n      }, {\n        a: 42\n      }]);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"return a 404 if the stream emits a 404 error","suites":[],"updatePoint":{"line":554,"column":50,"index":13626},"line":554,"code":"test('return a 404 if the stream emits a 404 error', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', function (request, reply) {\n    t.pass('Received request');\n    const reallyLongStream = new Readable({\n      read: function () {\n        setImmediate(() => {\n          this.emit('error', new errors.NotFound());\n        });\n      }\n    });\n    reply.send(reallyLongStream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const port = fastify.server.address().port;\n    sget(`http://localhost:${port}`, function (err, response) {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/json; charset=utf-8');\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should support send module 200 and 404","suites":[],"updatePoint":{"line":579,"column":44,"index":14371},"line":579,"code":"test('should support send module 200 and 404', {\n  only: true\n}, t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.get('/', function (req, reply) {\n    const stream = send(req.raw, __filename);\n    reply.code(200).send(stream);\n  });\n  fastify.get('/error', function (req, reply) {\n    const stream = send(req.raw, 'non-existing-file');\n    reply.code(200).send(stream);\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    const url = getUrl(fastify);\n    sget(url, function (err, response, data) {\n      t.error(err);\n      t.equal(response.headers['content-type'], 'application/octet-stream');\n      t.equal(response.statusCode, 200);\n      fs.readFile(__filename, (err, expected) => {\n        t.error(err);\n        t.equal(expected.toString(), data.toString());\n      });\n    });\n    sget(url + '/error', function (err, response) {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should destroy stream when response is ended","suites":[],"updatePoint":{"line":611,"column":50,"index":15333},"line":611,"code":"test('should destroy stream when response is ended', t => {\n  t.plan(4);\n\n  const stream = require('stream');\n\n  const fastify = Fastify();\n  fastify.get('/error', function (req, reply) {\n    const reallyLongStream = new stream.Readable({\n      read: function () {},\n      destroy: function (err, callback) {\n        t.ok('called');\n        callback(err);\n      }\n    });\n    reply.code(200).send(reallyLongStream);\n    reply.raw.end(Buffer.from('hello\\n'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget(`http://localhost:${fastify.server.address().port}/error`, function (err, response) {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n    });\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"should mark reply as sent before pumping the payload stream into response for async route handler","suites":[],"updatePoint":{"line":637,"column":103,"index":16100},"line":637,"code":"test('should mark reply as sent before pumping the payload stream into response for async route handler', t => {\n  t.plan(3);\n  const handleRequest = proxyquire('../lib/handleRequest', {\n    './wrapThenable': (thenable, reply) => {\n      thenable.then(function (payload) {\n        t.equal(reply[kReplySent], true);\n      });\n    }\n  });\n  const route = proxyquire('../lib/route', {\n    './handleRequest': handleRequest\n  });\n  const Fastify = proxyquire('..', {\n    './lib/route': route\n  });\n  const fastify = Fastify();\n  fastify.get('/', async function (req, reply) {\n    const stream = fs.createReadStream(__filename, 'utf8');\n    reply.code(200).send(stream);\n  });\n  fastify.inject({\n    url: '/',\n    method: 'GET'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, fs.readFileSync(__filename, 'utf8'));\n    fastify.close();\n  });\n});","file":"stream.test.js","skipped":false,"dir":"test"},{"name":"sync route","suites":[],"updatePoint":{"line":9,"column":16,"index":100},"line":9,"code":"test('sync route', async t => {\n  const app = Fastify();\n  t.teardown(app.close.bind(app));\n  app.get('/', () => 'hello world');\n  const res = await app.inject('/');\n  t.equal(res.statusCode, 200);\n  t.equal(res.body, 'hello world');\n});","file":"sync-routes.test.js","skipped":false,"dir":"test"},{"name":"sync route return null","suites":[],"updatePoint":{"line":17,"column":28,"index":350},"line":17,"code":"test('sync route return null', async t => {\n  const app = Fastify();\n  t.teardown(app.close.bind(app));\n  app.get('/', () => null);\n  const res = await app.inject('/');\n  t.equal(res.statusCode, 200);\n  t.equal(res.body, 'null');\n});","file":"sync-routes.test.js","skipped":false,"dir":"test"},{"name":"sync route, error","suites":[],"updatePoint":{"line":25,"column":23,"index":579},"line":25,"code":"test('sync route, error', async t => {\n  const app = Fastify();\n  t.teardown(app.close.bind(app));\n  app.get('/', () => {\n    throw new Error('kaboom');\n  });\n  const res = await app.inject('/');\n  t.equal(res.statusCode, 500);\n});","file":"sync-routes.test.js","skipped":false,"dir":"test"},{"name":"Fastify should throw on wrong options","suites":[],"updatePoint":{"line":9,"column":43,"index":127},"line":9,"code":"test('Fastify should throw on wrong options', t => {\n  t.plan(2);\n\n  try {\n    Fastify('lol');\n    t.fail();\n  } catch (e) {\n    t.equal(e.message, 'Options must be an object');\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Fastify should throw on multiple assignment to the same route","suites":[],"updatePoint":{"line":20,"column":67,"index":351},"line":20,"code":"test('Fastify should throw on multiple assignment to the same route', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.get('/', () => {});\n  fastify.get('/', () => {});\n  fastify.ready(err => {\n    t.equal(err.message, \"Method 'GET' already declared for route '/' with constraints '{}'\");\n  });\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Fastify should throw for an invalid schema, printing the error route - headers","suites":[],"updatePoint":{"line":29,"column":84,"index":677},"line":29,"code":"test('Fastify should throw for an invalid schema, printing the error route - headers', t => {\n  t.plan(2);\n  const badSchema = {\n    type: 'object',\n    properties: {\n      bad: {\n        type: 'bad-type'\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      headers: badSchema\n    }\n  }, () => {});\n  fastify.get('/not-loaded', {\n    schema: {\n      headers: badSchema\n    }\n  }, () => {});\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD');\n    t.match(err.message, /Failed building the validation schema for GET: \\//);\n  });\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Fastify should throw for an invalid schema, printing the error route - body","suites":[],"updatePoint":{"line":55,"column":81,"index":1270},"line":55,"code":"test('Fastify should throw for an invalid schema, printing the error route - body', t => {\n  t.plan(2);\n  const badSchema = {\n    type: 'object',\n    properties: {\n      bad: {\n        type: 'bad-type'\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.register((instance, opts, done) => {\n    instance.post('/form', {\n      schema: {\n        body: badSchema\n      }\n    }, () => {});\n    done();\n  }, {\n    prefix: 'hello'\n  });\n  fastify.ready(err => {\n    t.equal(err.code, 'FST_ERR_SCH_VALIDATION_BUILD');\n    t.match(err.message, /Failed building the validation schema for POST: \\/hello\\/form/);\n  });\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Fastify should throw for an invalid shorthand option type","suites":[],"updatePoint":{"line":81,"column":63,"index":1870},"line":81,"code":"test('Fastify should throw for an invalid shorthand option type', t => {\n  t.plan(3);\n\n  try {\n    Fastify({\n      jsonShorthand: 'hello'\n    });\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_INIT_OPTS_INVALID');\n    t.match(e.message, /should be boolean/);\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on unsupported method","suites":[],"updatePoint":{"line":95,"column":40,"index":2140},"line":95,"code":"test('Should throw on unsupported method', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.route({\n      method: 'TROLL',\n      url: '/',\n      schema: {},\n      handler: function (req, reply) {}\n    });\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on missing handler","suites":[],"updatePoint":{"line":111,"column":37,"index":2415},"line":111,"code":"test('Should throw on missing handler', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.route({\n      method: 'GET',\n      url: '/'\n    });\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if one method is unsupported","suites":[],"updatePoint":{"line":125,"column":47,"index":2639},"line":125,"code":"test('Should throw if one method is unsupported', t => {\n  const fastify = Fastify();\n  t.plan(1);\n\n  try {\n    fastify.route({\n      method: ['GET', 'TROLL'],\n      url: '/',\n      schema: {},\n      handler: function (req, reply) {}\n    });\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on duplicate content type parser","suites":[],"updatePoint":{"line":141,"column":51,"index":2937},"line":141,"code":"test('Should throw on duplicate content type parser', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  function customParser(req, payload, done) {\n    done(null, '');\n  }\n\n  fastify.addContentTypeParser('application/qq', customParser);\n\n  try {\n    fastify.addContentTypeParser('application/qq', customParser);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on duplicate decorator","suites":[],"updatePoint":{"line":158,"column":41,"index":3293},"line":158,"code":"test('Should throw on duplicate decorator', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const fooObj = {};\n  fastify.decorate('foo', fooObj);\n\n  try {\n    fastify.decorate('foo', fooObj);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should not throw on duplicate decorator encapsulation","suites":[],"updatePoint":{"line":171,"column":59,"index":3558},"line":171,"code":"test('Should not throw on duplicate decorator encapsulation', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  const foo2Obj = {};\n  fastify.decorate('foo2', foo2Obj);\n  fastify.register(function (fastify, opts, done) {\n    t.doesNotThrow(() => {\n      fastify.decorate('foo2', foo2Obj);\n    });\n    done();\n  });\n  fastify.ready();\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on duplicate request decorator","suites":[],"updatePoint":{"line":184,"column":49,"index":3887},"line":184,"code":"test('Should throw on duplicate request decorator', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.decorateRequest('foo', null);\n\n  try {\n    fastify.decorateRequest('foo', null);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_DEC_ALREADY_PRESENT');\n    t.equal(e.message, 'The decorator \\'foo\\' has already been added!');\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if request decorator dependencies are not met","suites":[],"updatePoint":{"line":197,"column":64,"index":4257},"line":197,"code":"test('Should throw if request decorator dependencies are not met', t => {\n  t.plan(2);\n  const fastify = Fastify();\n\n  try {\n    fastify.decorateRequest('bar', null, ['world']);\n    t.fail();\n  } catch (e) {\n    t.equal(e.code, 'FST_ERR_DEC_MISSING_DEPENDENCY');\n    t.equal(e.message, 'The decorator is missing dependency \\'world\\'.');\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw on duplicate reply decorator","suites":[],"updatePoint":{"line":209,"column":47,"index":4585},"line":209,"code":"test('Should throw on duplicate reply decorator', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.decorateReply('foo', null);\n\n  try {\n    fastify.decorateReply('foo', null);\n    t.fail();\n  } catch (e) {\n    t.ok(/has already been added/.test(e.message));\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if reply decorator dependencies are not met","suites":[],"updatePoint":{"line":221,"column":62,"index":4876},"line":221,"code":"test('Should throw if reply decorator dependencies are not met', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.decorateReply('bar', null, ['world']);\n    t.fail();\n  } catch (e) {\n    t.ok(/missing dependency/.test(e.message));\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if handler as the third parameter to the shortcut method is missing and the second parameter is not a function and also not an object","suites":[],"updatePoint":{"line":232,"column":152,"index":5226},"line":232,"code":"test('Should throw if handler as the third parameter to the shortcut method is missing and the second parameter is not a function and also not an object', t => {\n  t.plan(5);\n  const fastify = Fastify();\n\n  try {\n    fastify.get('/foo/1', '');\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/2', 1);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/3', []);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/4', undefined);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/5', null);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if handler as the third parameter to the shortcut method is missing and the second parameter is not a function and also not an object","suites":[],"updatePoint":{"line":271,"column":152,"index":5882},"line":271,"code":"test('Should throw if handler as the third parameter to the shortcut method is missing and the second parameter is not a function and also not an object', t => {\n  t.plan(5);\n  const fastify = Fastify();\n\n  try {\n    fastify.get('/foo/1', '');\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/2', 1);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/3', []);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/4', undefined);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/5', null);\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if there is handler function as the third parameter to the shortcut method and options as the second parameter is not an object","suites":[],"updatePoint":{"line":310,"column":146,"index":6532},"line":310,"code":"test('Should throw if there is handler function as the third parameter to the shortcut method and options as the second parameter is not an object', t => {\n  t.plan(5);\n  const fastify = Fastify();\n\n  try {\n    fastify.get('/foo/1', '', (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/2', 1, (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/3', [], (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/4', undefined, (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n\n  try {\n    fastify.get('/foo/5', null, (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"Should throw if found duplicate handler as the third parameter to the shortcut method and in options","suites":[],"updatePoint":{"line":349,"column":106,"index":7232},"line":349,"code":"test('Should throw if found duplicate handler as the third parameter to the shortcut method and in options', t => {\n  t.plan(1);\n  const fastify = Fastify();\n\n  try {\n    fastify.get('/foo/abc', {\n      handler: (req, res) => {}\n    }, (req, res) => {});\n    t.fail();\n  } catch (e) {\n    t.pass();\n  }\n});","file":"throw.test.js","skipped":false,"dir":"test"},{"name":"trust proxy, not add properties to node req","suites":[],"updatePoint":{"line":59,"column":49,"index":1325},"line":59,"code":"test('trust proxy, not add properties to node req', t => {\n  t.plan(8);\n  const app = fastify({\n    trustProxy: true\n  });\n  app.get('/trustproxy', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      hostname: 'example.com'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  app.get('/trustproxychain', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '2.2.2.2',\n      ips: [localhost, '1.1.1.1', '2.2.2.2']\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '1.1.1.1', '/trustproxy');\n    sgetForwardedRequest(app, '2.2.2.2, 1.1.1.1', '/trustproxychain');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"trust proxy chain","suites":[],"updatePoint":{"line":92,"column":23,"index":2138},"line":92,"code":"test('trust proxy chain', t => {\n  t.plan(3);\n  const app = fastify({\n    trustProxy: [localhost, '192.168.1.1']\n  });\n  app.get('/trustproxychain', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '192.168.1.1, 1.1.1.1', '/trustproxychain');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"trust proxy function","suites":[],"updatePoint":{"line":113,"column":26,"index":2649},"line":113,"code":"test('trust proxy function', t => {\n  t.plan(3);\n  const app = fastify({\n    trustProxy: address => address === localhost\n  });\n  app.get('/trustproxyfunc', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '1.1.1.1', '/trustproxyfunc');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"trust proxy number","suites":[],"updatePoint":{"line":134,"column":24,"index":3149},"line":134,"code":"test('trust proxy number', t => {\n  t.plan(4);\n  const app = fastify({\n    trustProxy: 1\n  });\n  app.get('/trustproxynumber', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      ips: [localhost, '1.1.1.1']\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '2.2.2.2, 1.1.1.1', '/trustproxynumber');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"trust proxy IP addresses","suites":[],"updatePoint":{"line":156,"column":30,"index":3672},"line":156,"code":"test('trust proxy IP addresses', t => {\n  t.plan(4);\n  const app = fastify({\n    trustProxy: `${localhost}, 2.2.2.2`\n  });\n  app.get('/trustproxyipaddrs', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      ips: [localhost, '1.1.1.1']\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '3.3.3.3, 2.2.2.2, 1.1.1.1', '/trustproxyipaddrs');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"trust proxy protocol","suites":[],"updatePoint":{"line":178,"column":26,"index":4224},"line":178,"code":"test('trust proxy protocol', t => {\n  t.plan(13);\n  const app = fastify({\n    trustProxy: true\n  });\n  app.get('/trustproxyprotocol', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      protocol: 'lorem'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  app.get('/trustproxynoprotocol', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      protocol: 'http'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  app.get('/trustproxyprotocols', function (req, reply) {\n    testRequestValues(t, req, {\n      ip: '1.1.1.1',\n      protocol: 'dolor'\n    });\n    reply.code(200).send({\n      ip: req.ip,\n      hostname: req.hostname\n    });\n  });\n  t.teardown(app.close.bind(app));\n  app.listen(0, err => {\n    app.server.unref();\n    t.error(err);\n    sgetForwardedRequest(app, '1.1.1.1', '/trustproxyprotocol', 'lorem');\n    sgetForwardedRequest(app, '1.1.1.1', '/trustproxynoprotocol');\n    sgetForwardedRequest(app, '1.1.1.1', '/trustproxyprotocols', 'ipsum, dolor');\n  });\n});","file":"trust-proxy.test.js","skipped":false,"dir":"test"},{"name":"Should rewrite url","suites":[],"updatePoint":{"line":11,"column":24,"index":165},"line":11,"code":"test('Should rewrite url', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    rewriteUrl(req) {\n      t.equal(req.url, '/this-would-404-without-url-rewrite');\n      return '/';\n    }\n\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/this-would-404-without-url-rewrite'\n    }, (err, response, body) => {\n      t.error(err);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n      t.equal(response.statusCode, 200);\n    });\n  });\n  t.teardown(() => fastify.close());\n});","file":"url-rewriting.test.js","skipped":false,"dir":"test"},{"name":"Should not rewrite if the url is the same","suites":[],"updatePoint":{"line":44,"column":47,"index":931},"line":44,"code":"test('Should not rewrite if the url is the same', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    rewriteUrl(req) {\n      t.equal(req.url, '/this-would-404-without-url-rewrite');\n      return req.url;\n    }\n\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/this-would-404-without-url-rewrite'\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n  t.teardown(() => fastify.close());\n});","file":"url-rewriting.test.js","skipped":false,"dir":"test"},{"name":"Should throw an error","suites":[],"updatePoint":{"line":74,"column":27,"index":1615},"line":74,"code":"test('Should throw an error', t => {\n  t.plan(5);\n  const fastify = Fastify({\n    rewriteUrl(req) {\n      t.equal(req.url, '/this-would-404-without-url-rewrite');\n      return undefined;\n    }\n\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.listen(0, function (err) {\n    t.error(err);\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port + '/this-would-404-without-url-rewrite'\n    }, (err, response, body) => {\n      t.equal(err.code, 'ECONNRESET');\n      t.equal(response, undefined);\n      t.equal(body, undefined);\n    });\n  });\n  t.teardown(() => fastify.close());\n});","file":"url-rewriting.test.js","skipped":false,"dir":"test"},{"name":"should work with valid payload","suites":[],"updatePoint":{"line":30,"column":36,"index":431},"line":30,"code":"test('should work with valid payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'michelangelo',\n      work: 'sculptor, painter, architect and poet'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'michelangelo');\n    t.equal(res.statusCode, 200);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should fail immediately with invalid payload","suites":[],"updatePoint":{"line":49,"column":50,"index":860},"line":49,"code":"test('should fail immediately with invalid payload', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: \"body should have required property 'name'\"\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should be able to use setErrorHandler specify custom validation error","suites":[],"updatePoint":{"line":71,"column":75,"index":1364},"line":71,"code":"test('should be able to use setErrorHandler specify custom validation error', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema\n  }, function (req, reply) {\n    t.fail('should not be here');\n    reply.code(200).send(req.body.name);\n  });\n  fastify.setErrorHandler(function (error, request, reply) {\n    if (error.validation) {\n      reply.status(422).send(new Error('validation failed'));\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      statusCode: 422,\n      error: 'Unprocessable Entity',\n      message: 'validation failed'\n    });\n    t.equal(res.statusCode, 422);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"error inside custom error handler should have validationContext","suites":[],"updatePoint":{"line":101,"column":69,"index":2117},"line":101,"code":"test('error inside custom error handler should have validationContext', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return function (data) {\n        return {\n          error: new Error('this failed')\n        };\n      };\n    }\n  }, function (req, reply) {\n    t.fail('should not be here');\n    reply.code(200).send(req.body.name);\n  });\n  fastify.setErrorHandler(function (error, request, reply) {\n    t.equal(error.validationContext, 'body');\n    reply.status(500).send(error);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'michelangelo',\n      work: 'artist'\n    },\n    url: '/'\n  }, () => {});\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"error inside custom error handler should have validationContext if specified by custom error handler","suites":[],"updatePoint":{"line":135,"column":106,"index":2918},"line":135,"code":"test('error inside custom error handler should have validationContext if specified by custom error handler', t => {\n  t.plan(1);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return function (data) {\n        const error = new Error('this failed');\n        error.validationContext = 'customContext';\n        return {\n          error\n        };\n      };\n    }\n  }, function (req, reply) {\n    t.fail('should not be here');\n    reply.code(200).send(req.body.name);\n  });\n  fastify.setErrorHandler(function (error, request, reply) {\n    t.equal(error.validationContext, 'customContext');\n    reply.status(500).send(error);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      name: 'michelangelo',\n      work: 'artist'\n    },\n    url: '/'\n  }, () => {});\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should be able to attach validation to request","suites":[],"updatePoint":{"line":171,"column":52,"index":3747},"line":171,"code":"test('should be able to attach validation to request', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    attachValidation: true\n  }, function (req, reply) {\n    reply.code(400).send(req.validationError.validation);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), [{\n      keyword: 'required',\n      dataPath: '',\n      schemaPath: '#/required',\n      params: {\n        missingProperty: 'name'\n      },\n      message: 'should have required property \\'name\\''\n    }]);\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should respect when attachValidation is explicitly set to false","suites":[],"updatePoint":{"line":200,"column":69,"index":4434},"line":200,"code":"test('should respect when attachValidation is explicitly set to false', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    attachValidation: false\n  }, function (req, reply) {\n    t.fail('should not be here');\n    reply.code(200).send(req.validationError.validation);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: \"body should have required property 'name'\"\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"Attached validation error should take precedence over setErrorHandler","suites":[],"updatePoint":{"line":226,"column":75,"index":5091},"line":226,"code":"test('Attached validation error should take precedence over setErrorHandler', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    attachValidation: true\n  }, function (req, reply) {\n    reply.code(400).send('Attached: ' + req.validationError);\n  });\n  fastify.setErrorHandler(function (error, request, reply) {\n    t.fail('should not be here');\n\n    if (error.validation) {\n      reply.status(422).send(new Error('validation failed'));\n    }\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, \"Attached: Error: body should have required property 'name'\");\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should handle response validation error","suites":[],"updatePoint":{"line":254,"column":45,"index":5816},"line":254,"code":"test('should handle response validation error', t => {\n  t.plan(2);\n  const response = {\n    200: {\n      type: 'object',\n      required: ['name', 'work'],\n      properties: {\n        name: {\n          type: 'string'\n        },\n        work: {\n          type: 'string'\n        }\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      response\n    }\n  }, function (req, reply) {\n    try {\n      reply.code(200).send({\n        work: 'actor'\n      });\n    } catch (error) {\n      reply.code(500).send(error);\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"statusCode\":500,\"error\":\"Internal Server Error\",\"message\":\"\\\\\"name\\\\\" is required!\"}');\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should handle response validation error with promises","suites":[],"updatePoint":{"line":293,"column":59,"index":6615},"line":293,"code":"test('should handle response validation error with promises', t => {\n  t.plan(2);\n  const response = {\n    200: {\n      type: 'object',\n      required: ['name', 'work'],\n      properties: {\n        name: {\n          type: 'string'\n        },\n        work: {\n          type: 'string'\n        }\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.get('/', {\n    schema: {\n      response\n    }\n  }, function (req, reply) {\n    return Promise.resolve({\n      work: 'actor'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"statusCode\":500,\"error\":\"Internal Server Error\",\"message\":\"\\\\\"name\\\\\" is required!\"}');\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should return a defined output message parsing AJV errors","suites":[],"updatePoint":{"line":328,"column":63,"index":7341},"line":328,"code":"test('should return a defined output message parsing AJV errors', t => {\n  t.plan(2);\n  const body = {\n    type: 'object',\n    required: ['name', 'work'],\n    properties: {\n      name: {\n        type: 'string'\n      },\n      work: {\n        type: 'string'\n      }\n    }\n  };\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body\n    }\n  }, function (req, reply) {\n    t.fail();\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"statusCode\":400,\"error\":\"Bad Request\",\"message\":\"body should have required property \\'name\\'\"}');\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should return a defined output message parsing JOI errors","suites":[],"updatePoint":{"line":359,"column":63,"index":7991},"line":359,"code":"test('should return a defined output message parsing JOI errors', t => {\n  t.plan(2);\n  const body = Joi.object().keys({\n    name: Joi.string().required(),\n    work: Joi.string().required()\n  }).required();\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body\n    },\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return data => schema.validate(data);\n    }\n  }, function (req, reply) {\n    t.fail();\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"statusCode\":400,\"error\":\"Bad Request\",\"message\":\"\\\\\"name\\\\\" is required\"}');\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should return a defined output message parsing JOI error details","suites":[],"updatePoint":{"line":390,"column":70,"index":8702},"line":390,"code":"test('should return a defined output message parsing JOI error details', t => {\n  t.plan(2);\n  const body = Joi.object().keys({\n    name: Joi.string().required(),\n    work: Joi.string().required()\n  }).required();\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema: {\n      body\n    },\n    validatorCompiler: ({\n      schema,\n      method,\n      url,\n      httpPart\n    }) => {\n      return data => {\n        const validation = schema.validate(data);\n        return {\n          error: validation.error.details\n        };\n      };\n    }\n  }, function (req, reply) {\n    t.fail();\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {},\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.payload, '{\"statusCode\":400,\"error\":\"Bad Request\",\"message\":\"body \\\\\"name\\\\\" is required\"}');\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"the custom error formatter context must be the server instance","suites":[],"updatePoint":{"line":426,"column":68,"index":9524},"line":426,"code":"test('the custom error formatter context must be the server instance', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.setSchemaErrorFormatter(function (errors, dataVar) {\n    t.same(this, fastify);\n    return new Error('my error');\n  });\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'my error'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"the custom error formatter context must be the server instance in options","suites":[],"updatePoint":{"line":452,"column":79,"index":10129},"line":452,"code":"test('the custom error formatter context must be the server instance in options', t => {\n  t.plan(4);\n  const fastify = Fastify({\n    schemaErrorFormatter: function (errors, dataVar) {\n      t.same(this, fastify);\n      return new Error('my error');\n    }\n  });\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'my error'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should call custom error formatter","suites":[],"updatePoint":{"line":479,"column":40,"index":10696},"line":479,"code":"test('should call custom error formatter', t => {\n  t.plan(6);\n  const fastify = Fastify({\n    schemaErrorFormatter: (errors, dataVar) => {\n      t.equal(errors.length, 1);\n      t.equal(errors[0].message, \"should have required property 'name'\");\n      t.equal(dataVar, 'body');\n      return new Error('my error');\n    }\n  });\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'my error'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should catch error inside formatter and return message","suites":[],"updatePoint":{"line":508,"column":60,"index":11387},"line":508,"code":"test('should catch error inside formatter and return message', t => {\n  t.plan(3);\n  const fastify = Fastify({\n    schemaErrorFormatter: (errors, dataVar) => {\n      throw new Error('abc');\n    }\n  });\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 500,\n      error: 'Internal Server Error',\n      message: 'abc'\n    });\n    t.equal(res.statusCode, 500);\n    t.end();\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"cannot create a fastify instance with wrong type of errorFormatter","suites":[],"updatePoint":{"line":535,"column":72,"index":11963},"line":535,"code":"test('cannot create a fastify instance with wrong type of errorFormatter', t => {\n  t.plan(3);\n\n  try {\n    Fastify({\n      schemaErrorFormatter: async (errors, dataVar) => {\n        return new Error('should not execute');\n      }\n    });\n  } catch (err) {\n    t.equal(err.message, 'schemaErrorFormatter option should not be an async function');\n  }\n\n  try {\n    Fastify({\n      schemaErrorFormatter: 500\n    });\n  } catch (err) {\n    t.equal(err.message, 'schemaErrorFormatter option should be a function, instead got number');\n  }\n\n  try {\n    const fastify = Fastify();\n    fastify.setSchemaErrorFormatter(500);\n  } catch (err) {\n    t.equal(err.message, 'schemaErrorFormatter option should be a function, instead got number');\n  }\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"should register a route based schema error formatter","suites":[],"updatePoint":{"line":563,"column":58,"index":12688},"line":563,"code":"test('should register a route based schema error formatter', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.post('/', {\n    schema,\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('abc');\n    }\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'abc'\n    });\n    t.equal(res.statusCode, 400);\n    t.end();\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"prefer route based error formatter over global one","suites":[],"updatePoint":{"line":589,"column":56,"index":13235},"line":589,"code":"test('prefer route based error formatter over global one', t => {\n  t.plan(9);\n  const fastify = Fastify({\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('abc123');\n    }\n  });\n  fastify.post('/', {\n    schema,\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('123');\n    }\n  }, echoBody);\n  fastify.post('/abc', {\n    schema,\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('abc');\n    }\n  }, echoBody);\n  fastify.post('/test', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: '123'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/abc'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'abc'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/test'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'abc123'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"adding schemaErrorFormatter","suites":[],"updatePoint":{"line":657,"column":33,"index":14614},"line":657,"code":"test('adding schemaErrorFormatter', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.setSchemaErrorFormatter((errors, dataVar) => {\n    return new Error('abc');\n  });\n  fastify.post('/', {\n    schema\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'abc'\n    });\n    t.equal(res.statusCode, 400);\n    t.end();\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"plugin override","suites":[],"updatePoint":{"line":683,"column":21,"index":15131},"line":683,"code":"test('plugin override', t => {\n  t.plan(15);\n  const fastify = Fastify({\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('B');\n    }\n  });\n  fastify.register((instance, opts, done) => {\n    instance.setSchemaErrorFormatter((errors, dataVar) => {\n      return new Error('C');\n    });\n    instance.post('/d', {\n      schema,\n      schemaErrorFormatter: (errors, dataVar) => {\n        return new Error('D');\n      }\n    }, function (req, reply) {\n      reply.code(200).send(req.body.name);\n    });\n    instance.post('/c', {\n      schema\n    }, echoBody);\n    instance.register((subinstance, opts, done) => {\n      subinstance.post('/stillC', {\n        schema\n      }, echoBody);\n      done();\n    });\n    done();\n  });\n  fastify.post('/b', {\n    schema\n  }, echoBody);\n  fastify.post('/', {\n    schema,\n    schemaErrorFormatter: (errors, dataVar) => {\n      return new Error('A');\n    }\n  }, echoBody);\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'A'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/b'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'B'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/c'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'C'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/d'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'D'\n    });\n    t.equal(res.statusCode, 400);\n  });\n  fastify.inject({\n    method: 'POST',\n    payload: {\n      hello: 'michelangelo'\n    },\n    url: '/stillC'\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.json(), {\n      statusCode: 400,\n      error: 'Bad Request',\n      message: 'C'\n    });\n    t.equal(res.statusCode, 400);\n  });\n});","file":"validation-error-handling.test.js","skipped":false,"dir":"test"},{"name":"Should register a versioned route","suites":[],"updatePoint":{"line":19,"column":39,"index":328},"line":19,"code":"test('Should register a versioned route', t => {\n  t.plan(11);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.0'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.1'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should register a versioned route via route constraints","suites":[],"updatePoint":{"line":84,"column":61,"index":1576},"line":84,"code":"test('Should register a versioned route via route constraints', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should register the same route with different versions","suites":[],"updatePoint":{"line":126,"column":60,"index":2387},"line":126,"code":"test('Should register the same route with different versions', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send('1.2.0');\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.3.0'\n    },\n    handler: (req, reply) => {\n      reply.send('1.3.0');\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, '1.3.0');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 200);\n    t.equal(res.payload, '1.2.0');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '2.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"The versioned route should take precedence","suites":[],"updatePoint":{"line":182,"column":48,"index":3449},"line":182,"code":"test('The versioned route should take precedence', t => {\n  t.plan(3);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        winter: 'is coming'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Versioned route but not version header should return a 404","suites":[],"updatePoint":{"line":220,"column":64,"index":4164},"line":220,"code":"test('Versioned route but not version header should return a 404', t => {\n  t.plan(2);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should register a versioned route","suites":[],"updatePoint":{"line":243,"column":39,"index":4584},"line":243,"code":"test('Should register a versioned route', t => {\n  t.plan(6);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Accept-Version': '1.x'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 200);\n      t.same(JSON.parse(body), {\n        hello: 'world'\n      });\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Accept-Version': '2.x'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Shorthand route declaration","suites":[],"updatePoint":{"line":286,"column":33,"index":5527},"line":286,"code":"test('Shorthand route declaration', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.get('/', {\n    constraints: {\n      version: '1.2.0'\n    }\n  }, (req, reply) => {\n    reply.send({\n      hello: 'world'\n    });\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.2.1'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"The not found handler should not erase the Accept-Version header","suites":[],"updatePoint":{"line":322,"column":70,"index":6230},"line":322,"code":"test('The not found handler should not erase the Accept-Version header', t => {\n  t.plan(13);\n  const fastify = Fastify();\n  fastify.addHook('onRequest', function (req, reply, done) {\n    t.same(req.headers['accept-version'], '2.x');\n    done();\n  });\n  fastify.addHook('preValidation', function (req, reply, done) {\n    t.same(req.headers['accept-version'], '2.x');\n    done();\n  });\n  fastify.addHook('preHandler', function (req, reply, done) {\n    t.same(req.headers['accept-version'], '2.x');\n    done();\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.setNotFoundHandler(function (req, reply) {\n    t.same(req.headers['accept-version'], '2.x'); // we check if the symbol is exposed on key or not\n\n    for (const key in req.headers) {\n      t.same(typeof key, 'string');\n    }\n\n    for (const key of Object.keys(req.headers)) {\n      t.same(typeof key, 'string');\n    }\n\n    reply.code(404).send('not found handler');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '2.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(res.payload, 'not found handler');\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Bad accept version (inject)","suites":[],"updatePoint":{"line":374,"column":33,"index":7516},"line":374,"code":"test('Bad accept version (inject)', t => {\n  t.plan(4);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': 'a.b.c'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': 12\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Bas accept version (server)","suites":[],"updatePoint":{"line":410,"column":33,"index":8163},"line":410,"code":"test('Bas accept version (server)', t => {\n  t.plan(5);\n  const fastify = Fastify();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Accept-Version': 'a.b.c'\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n    sget({\n      method: 'GET',\n      url: 'http://localhost:' + fastify.server.address().port,\n      headers: {\n        'Accept-Version': 12\n      }\n    }, (err, response, body) => {\n      t.error(err);\n      t.equal(response.statusCode, 404);\n    });\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"test log stream","suites":[],"updatePoint":{"line":450,"column":21,"index":9027},"line":450,"code":"test('test log stream', t => {\n  t.plan(3);\n  const stream = split(JSON.parse);\n  const fastify = Fastify({\n    logger: {\n      stream,\n      level: 'info'\n    }\n  });\n  fastify.get('/', {\n    constraints: {\n      version: '1.2.0'\n    }\n  }, function (req, reply) {\n    reply.send(new Error('kaboom'));\n  });\n  fastify.listen(0, err => {\n    t.error(err);\n    fastify.server.unref();\n    http.get({\n      hostname: 'localhost',\n      port: fastify.server.address().port,\n      path: '/',\n      method: 'GET',\n      headers: {\n        'Accept-Version': '1.x'\n      }\n    });\n    stream.once('data', listenAtLogLine => {\n      stream.once('data', line => {\n        t.equal(line.req.version, '1.x');\n        stream.once('data', line => {\n          t.equal(line.req.version, '1.x');\n        });\n      });\n    });\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should register a versioned route with custom versioning strategy","suites":[],"updatePoint":{"line":488,"column":71,"index":9896},"line":488,"code":"test('Should register a versioned route with custom versioning strategy', t => {\n  t.plan(8);\n  const customVersioning = {\n    name: 'version',\n    storage: function () {\n      let versions = {};\n      return {\n        get: version => {\n          return versions[version] || null;\n        },\n        set: (version, store) => {\n          versions[version] = store;\n        },\n        del: version => {\n          delete versions[version];\n        },\n        empty: () => {\n          versions = {};\n        }\n      };\n    },\n    deriveConstraint: (req, ctx) => {\n      return req.headers.accept;\n    },\n    mustMatchWhenDerived: true,\n    validate: () => true\n  };\n  const fastify = Fastify({\n    constraints: {\n      version: customVersioning\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: 'application/vnd.example.api+json;version=2'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from route v2'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: 'application/vnd.example.api+json;version=3'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'from route v3'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      Accept: 'application/vnd.example.api+json;version=2'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from route v2'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      Accept: 'application/vnd.example.api+json;version=3'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'from route v3'\n    });\n    t.equal(res.statusCode, 200);\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      Accept: 'application/vnd.example.api+json;version=4'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.equal(res.statusCode, 404);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should get error using an invalid a versioned route, using default validation (deprecated versioning option)","suites":[],"updatePoint":{"line":581,"column":114,"index":11959},"line":581,"code":"test('Should get error using an invalid a versioned route, using default validation (deprecated versioning option)', t => {\n  t.plan(1);\n  const fastify = Fastify({\n    versioning: {\n      storage: function () {\n        let versions = {};\n        return {\n          get: version => {\n            return versions[version] || null;\n          },\n          set: (version, store) => {\n            versions[version] = store;\n          },\n          del: version => {\n            delete versions[version];\n          },\n          empty: () => {\n            versions = {};\n          }\n        };\n      },\n      deriveVersion: (req, ctx) => {\n        return req.headers.accept;\n      }\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: 'application/vnd.example.api+json;version=1'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'cant match route v1'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    // not a string version\n    constraints: {\n      version: 2\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'cant match route v2'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      Accept: 'application/vnd.example.api+json;version=2'\n    }\n  }, (err, res) => {\n    t.equal(err.message, 'Version constraint should be a string.');\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Vary header check (for documentation example)","suites":[],"updatePoint":{"line":642,"column":51,"index":13291},"line":642,"code":"test('Vary header check (for documentation example)', t => {\n  t.plan(8);\n  const fastify = Fastify();\n  fastify.addHook('onSend', async (req, reply) => {\n    if (req.headers['accept-version']) {\n      // or the custom header you are using\n      let value = reply.getHeader('Vary') || '';\n      const header = Array.isArray(value) ? value.join(', ') : String(value);\n\n      if (value = append(header, 'Accept-Version')) {\n        // or the custom header you are using\n        reply.header('Vary', value);\n      }\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    constraints: {\n      version: '1.2.0'\n    },\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers.vary, 'Accept-Version');\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/'\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n    t.equal(res.headers.vary, undefined);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"Should trigger a warning when a versioned route is registered via version option","suites":[],"updatePoint":{"line":704,"column":86,"index":14733},"line":704,"code":"test('Should trigger a warning when a versioned route is registered via version option', t => {\n  t.plan(4);\n\n  function onWarning(code) {\n    t.equal(code, 'FSTDEP008');\n  }\n\n  const warning = {\n    emit: onWarning\n  };\n  const route = proxyquire('../lib/route', {\n    './warnings': warning\n  });\n  const fastify = proxyquire('..', {\n    './lib/route.js': route\n  })();\n  fastify.route({\n    method: 'GET',\n    url: '/',\n    version: '1.2.0',\n    handler: (req, reply) => {\n      reply.send({\n        hello: 'world'\n      });\n    }\n  });\n  fastify.inject({\n    method: 'GET',\n    url: '/',\n    headers: {\n      'Accept-Version': '1.x'\n    }\n  }, (err, res) => {\n    t.error(err);\n    t.same(JSON.parse(res.payload), {\n      hello: 'world'\n    });\n    t.equal(res.statusCode, 200);\n  });\n});","file":"versioned-routes.test.js","skipped":false,"dir":"test"},{"name":"should resolve immediately when reply[kReplySentOverwritten] is true","suites":[],"updatePoint":{"line":13,"column":74,"index":257},"line":13,"code":"test('should resolve immediately when reply[kReplySentOverwritten] is true', t => {\n  const reply = {};\n  reply[kReplySentOverwritten] = true;\n  const thenable = Promise.resolve();\n  wrapThenable(thenable, reply);\n  t.end();\n});","file":"wrapThenable.test.js","skipped":false,"dir":"test"},{"name":"should reject immediately when reply[kReplySentOverwritten] is true","suites":[],"updatePoint":{"line":20,"column":73,"index":485},"line":20,"code":"test('should reject immediately when reply[kReplySentOverwritten] is true', t => {\n  t.plan(1);\n  const reply = {\n    res: {}\n  };\n  reply[kReplySentOverwritten] = true;\n  reply.log = {\n    error: ({\n      err\n    }) => {\n      t.equal(err.message, 'Reply sent already');\n    }\n  };\n  const thenable = Promise.reject(new Error('Reply sent already'));\n  wrapThenable(thenable, reply);\n});","file":"wrapThenable.test.js","skipped":false,"dir":"test"}]}